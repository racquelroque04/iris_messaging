!function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var n={};t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var i in e)t.d(r,i,function(t){return e[t]}.bind(null,i));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=169)}([function(e,t){var n,r=Math.ceil;n=function(){var e=e||function(e){var t=Object.create||function(){function e(){}return function(t){var n;return e.prototype=t,n=new e,e.prototype=null,n}}(),n={},i=n.lib={},a=i.Base={extend:function(e){var n=t(this);return e&&n.mixIn(e),n.hasOwnProperty("init")&&this.init!==n.init||(n.init=function(){n.$super.init.apply(this,arguments)}),n.init.prototype=n,n.$super=this,n},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},o=i.WordArray=a.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null==t?4*e.length:t},toString:function(e){return(e||c).stringify(this)},concat:function(e){var t=this.words,n=e.words,r=this.sigBytes,i=e.sigBytes;if(this.clamp(),r%4)for(var a,o=0;o<i;o++)a=255&n[o>>>2]>>>24-o%4*8,t[r+o>>>2]|=a<<24-(r+o)%4*8;else for(o=0;o<i;o+=4)t[r+o>>>2]=n[o>>>2];return this.sigBytes+=i,this},clamp:function(){var e=this.words,t=this.sigBytes;e[t>>>2]&=4294967295<<32-t%4*8,e.length=r(t/4)},clone:function(){var e=a.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n,r,i=[],a=function(t){t=t;var n=987654321,r=4294967295;return function(){var i=((n=36969*(65535&n)+(n>>16)&r)<<16)+(t=18e3*(65535&t)+(t>>16)&r)&r;return i/=4294967296,(i+=.5)*(.5<e.random()?1:-1)}},s=0;s<t;s+=4)n=987654071*(r=a(4294967296*(n||e.random())))(),i.push(0|4294967296*r());return new o.init(i,t)}}),s=n.enc={},c=s.Hex={stringify:function(e){for(var t,n=e.words,r=e.sigBytes,i=[],a=0;a<r;a++)t=255&n[a>>>2]>>>24-a%4*8,i.push((t>>>4).toString(16)),i.push((15&t).toString(16));return i.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r+=2)n[r>>>3]|=parseInt(e.substr(r,2),16)<<24-r%8*4;return new o.init(n,t/2)}},l=s.Latin1={stringify:function(e){for(var t,n=e.words,r=e.sigBytes,i=[],a=0;a<r;a++)t=255&n[a>>>2]>>>24-a%4*8,i.push(String.fromCharCode(t));return i.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r++)n[r>>>2]|=(255&e.charCodeAt(r))<<24-r%4*8;return new o.init(n,t)}},d=s.Utf8={stringify:function(e){try{return decodeURIComponent(escape(l.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return l.parse(unescape(encodeURIComponent(e)))}},u=i.BufferedBlockAlgorithm=a.extend({reset:function(){this._data=new o.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=d.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,i=n.words,a=n.sigBytes,s=this.blockSize,c=a/(4*s),l=(c=t?r(c):e.max((0|c)-this._minBufferSize,0))*s,d=e.min(4*l,a);if(l){for(var u=0;u<l;u+=s)this._doProcessBlock(i,u);var h=i.splice(0,l);n.sigBytes-=d}return new o.init(h,d)},clone:function(){var e=a.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),h=(i.Hasher=u.extend({cfg:a.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){u.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,n){return new e.init(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return new h.HMAC.init(e,n).finalize(t)}}}),n.algo={});return n}(Math);return e},e.exports=n()},function(e,t,n){e.exports=function(e){return e}(n(0),n(8),n(39),n(40),n(4),n(5),n(9),n(13),n(41),n(14),n(42),n(43),n(44),n(10),n(45),n(3),n(2),n(46),n(47),n(48),n(49),n(50),n(51),n(52),n(53),n(54),n(55),n(56),n(57),n(58),n(59),n(60),n(61))},function(e,t,n){e.exports=function(e){var t,n,r,i,a,o,s,c,l,d,u,h,f,p,m,v,g,C,S,E,b,y;e.lib.Cipher||(n=(t=e).lib,r=n.Base,i=n.WordArray,a=n.BufferedBlockAlgorithm,(o=t.enc).Utf8,s=o.Base64,c=t.algo,l=c.EvpKDF,d=n.Cipher=a.extend({cfg:r.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,n){this.cfg=this.cfg.extend(n),this._xformMode=e,this._key=t,this.reset()},reset:function(){a.reset.call(this),this._doReset()},process:function(e){return this._append(e),this._process()},finalize:function(e){e&&this._append(e);var t=this._doFinalize();return t},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(){function e(e){return"string"==typeof e?y:S}return function(t){return{encrypt:function(n,r,i){return e(r).encrypt(t,n,r,i)},decrypt:function(n,r,i){return e(r).decrypt(t,n,r,i)}}}}()}),n.StreamCipher=d.extend({_doFinalize:function(){var e=this._process(!0);return e},blockSize:1}),u=t.mode={},h=n.BlockCipherMode=r.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t}}),f=u.CBC=function(){function e(e,t,n){var r=this._iv;if(r){var i=r;this._iv=void 0}else var i=this._prevBlock;for(var a=0;a<n;a++)e[t+a]^=i[a]}var t=h.extend();return t.Encryptor=t.extend({processBlock:function(t,n){var r=this._cipher,i=r.blockSize;e.call(this,t,n,i),r.encryptBlock(t,n),this._prevBlock=t.slice(n,n+i)}}),t.Decryptor=t.extend({processBlock:function(t,n){var r=this._cipher,i=r.blockSize,a=t.slice(n,n+i);r.decryptBlock(t,n),e.call(this,t,n,i),this._prevBlock=a}}),t}(),p=t.pad={},m=p.Pkcs7={pad:function(e,t){for(var n=4*t,r=n-e.sigBytes%n,a=[],o=0;o<r;o+=4)a.push(r<<24|r<<16|r<<8|r);var s=i.create(a,r);e.concat(s)},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t}},n.BlockCipher=d.extend({cfg:d.cfg.extend({mode:f,padding:m}),reset:function(){d.reset.call(this);var e=this.cfg,t=e.iv,n=e.mode;if(this._xformMode==this._ENC_XFORM_MODE)var r=n.createEncryptor;else{var r=n.createDecryptor;this._minBufferSize=1}this._mode&&this._mode.__creator==r?this._mode.init(this,t&&t.words):(this._mode=r.call(n,this,t&&t.words),this._mode.__creator=r)},_doProcessBlock:function(e,t){this._mode.processBlock(e,t)},_doFinalize:function(){var e=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){e.pad(this._data,this.blockSize);var t=this._process(!0)}else{var t=this._process(!0);e.unpad(t)}return t},blockSize:4}),v=n.CipherParams=r.extend({init:function(e){this.mixIn(e)},toString:function(e){return(e||this.formatter).stringify(this)}}),g=t.format={},C=g.OpenSSL={stringify:function(e){var t=e.ciphertext,n=e.salt;if(n)var r=i.create([1398893684,1701076831]).concat(n).concat(t);else var r=t;return r.toString(s)},parse:function(e){var t=s.parse(e),n=t.words;if(1398893684==n[0]&&1701076831==n[1]){var r=i.create(n.slice(2,4));n.splice(0,4),t.sigBytes-=16}return v.create({ciphertext:t,salt:r})}},S=n.SerializableCipher=r.extend({cfg:r.extend({format:C}),encrypt:function(e,t,n,r){r=this.cfg.extend(r);var i=e.createEncryptor(n,r),a=i.finalize(t),o=i.cfg;return v.create({ciphertext:a,key:n,iv:o.iv,algorithm:e,mode:o.mode,padding:o.padding,blockSize:e.blockSize,formatter:r.format})},decrypt:function(e,t,n,r){r=this.cfg.extend(r),t=this._parse(t,r.format);var i=e.createDecryptor(n,r).finalize(t.ciphertext);return i},_parse:function(e,t){return"string"==typeof e?t.parse(e,this):e}}),E=t.kdf={},b=E.OpenSSL={execute:function(e,t,n,r){r||(r=i.random(8));var a=l.create({keySize:t+n}).compute(e,r),o=i.create(a.words.slice(t),4*n);return a.sigBytes=4*t,v.create({key:a,iv:o,salt:r})}},y=n.PasswordBasedCipher=S.extend({cfg:S.cfg.extend({kdf:b}),encrypt:function(e,t,n,r){var i=(r=this.cfg.extend(r)).kdf.execute(n,e.keySize,e.ivSize);r.iv=i.iv;var a=S.encrypt.call(this,e,t,i.key,r);return a.mixIn(i),a},decrypt:function(e,t,n,r){r=this.cfg.extend(r),t=this._parse(t,r.format);var i=r.kdf.execute(n,e.keySize,e.ivSize,t.salt);r.iv=i.iv;var a=S.decrypt.call(this,e,t,i.key,r);return a}}))}(n(0),n(3))},function(e,t,n){e.exports=function(e){return n=(t=e).lib,r=n.Base,i=n.WordArray,a=t.algo,o=a.MD5,s=a.EvpKDF=r.extend({cfg:r.extend({keySize:4,hasher:o,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e)},compute:function(e,t){for(var n=this.cfg,r=n.hasher.create(),a=i.create(),o=a.words,s=n.keySize,c=n.iterations;o.length<s;){l&&r.update(l);var l=r.update(e).finalize(t);r.reset();for(var d=1;d<c;d++)l=r.finalize(l),r.reset();a.concat(l)}return a.sigBytes=4*s,a}}),t.EvpKDF=function(e,t,n){return s.create(n).compute(e,t)},e.EvpKDF;var t,n,r,i,a,o,s}(n(0),n(9),n(10))},function(e,t,n){e.exports=function(e){return function(){function t(e,t,n){for(var r=[],a=0,o=0;o<t;o++)if(o%4){var s=n[e.charCodeAt(o-1)]<<o%4*2,c=n[e.charCodeAt(o)]>>>6-o%4*2;r[a>>>2]|=(s|c)<<24-a%4*8,a++}return i.create(r,a)}var n=e,r=n.lib,i=r.WordArray,a=n.enc;a.Base64={stringify:function(e){var t=e.words,n=e.sigBytes,r=this._map;e.clamp();for(var i=[],a=0;a<n;a+=3)for(var o=255&t[a>>>2]>>>24-a%4*8,s=255&t[a+1>>>2]>>>24-(a+1)%4*8,c=255&t[a+2>>>2]>>>24-(a+2)%4*8,l=0;4>l&&a+.75*l<n;l++)i.push(r.charAt(63&(o<<16|s<<8|c)>>>6*(3-l)));var d=r.charAt(64);if(d)for(;i.length%4;)i.push(d);return i.join("")},parse:function(e){var n=e.length,r=this._map,i=this._reverseMap;if(!i){i=this._reverseMap=[];for(var a=0;a<r.length;a++)i[r.charCodeAt(a)]=a}var o=r.charAt(64);if(o){var s=e.indexOf(o);-1!==s&&(n=s)}return t(e,n,i)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),e.enc.Base64}(n(0))},function(e,t,n){e.exports=function(e){return function(t){function n(e,t,n,r,i,a,o){var s=e+(t&n|~t&r)+i+o;return(s<<a|s>>>32-a)+t}function r(e,t,n,r,i,a,o){var s=e+(t&r|n&~r)+i+o;return(s<<a|s>>>32-a)+t}function i(e,t,n,r,i,a,o){var s=e+(t^n^r)+i+o;return(s<<a|s>>>32-a)+t}function a(e,t,n,r,i,a,o){var s=e+(n^(t|~r))+i+o;return(s<<a|s>>>32-a)+t}var o=e,s=o.lib,c=s.WordArray,l=s.Hasher,d=o.algo,u=[];!function(){for(var e=0;64>e;e++)u[e]=0|4294967296*t.abs(t.sin(e+1))}();var h=d.MD5=l.extend({_doReset:function(){this._hash=new c.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,t){for(var o=0;16>o;o++){var s=t+o,c=e[s];e[s]=16711935&(c<<8|c>>>24)|4278255360&(c<<24|c>>>8)}var l=this._hash.words,d=e[t+0],h=e[t+1],f=e[t+2],p=e[t+3],m=e[t+4],v=e[t+5],g=e[t+6],C=e[t+7],S=e[t+8],E=e[t+9],b=e[t+10],y=e[t+11],R=e[t+12],T=e[t+13],I=e[t+14],A=e[t+15],N=l[0],O=l[1],D=l[2],P=l[3];N=n(N,O,D,P,d,7,u[0]),P=n(P,N,O,D,h,12,u[1]),D=n(D,P,N,O,f,17,u[2]),O=n(O,D,P,N,p,22,u[3]),N=n(N,O,D,P,m,7,u[4]),P=n(P,N,O,D,v,12,u[5]),D=n(D,P,N,O,g,17,u[6]),O=n(O,D,P,N,C,22,u[7]),N=n(N,O,D,P,S,7,u[8]),P=n(P,N,O,D,E,12,u[9]),D=n(D,P,N,O,b,17,u[10]),O=n(O,D,P,N,y,22,u[11]),N=n(N,O,D,P,R,7,u[12]),P=n(P,N,O,D,T,12,u[13]),D=n(D,P,N,O,I,17,u[14]),O=n(O,D,P,N,A,22,u[15]),N=r(N,O,D,P,h,5,u[16]),P=r(P,N,O,D,g,9,u[17]),D=r(D,P,N,O,y,14,u[18]),O=r(O,D,P,N,d,20,u[19]),N=r(N,O,D,P,v,5,u[20]),P=r(P,N,O,D,b,9,u[21]),D=r(D,P,N,O,A,14,u[22]),O=r(O,D,P,N,m,20,u[23]),N=r(N,O,D,P,E,5,u[24]),P=r(P,N,O,D,I,9,u[25]),D=r(D,P,N,O,p,14,u[26]),O=r(O,D,P,N,S,20,u[27]),N=r(N,O,D,P,T,5,u[28]),P=r(P,N,O,D,f,9,u[29]),D=r(D,P,N,O,C,14,u[30]),O=r(O,D,P,N,R,20,u[31]),N=i(N,O,D,P,v,4,u[32]),P=i(P,N,O,D,S,11,u[33]),D=i(D,P,N,O,y,16,u[34]),O=i(O,D,P,N,I,23,u[35]),N=i(N,O,D,P,h,4,u[36]),P=i(P,N,O,D,m,11,u[37]),D=i(D,P,N,O,C,16,u[38]),O=i(O,D,P,N,b,23,u[39]),N=i(N,O,D,P,T,4,u[40]),P=i(P,N,O,D,d,11,u[41]),D=i(D,P,N,O,p,16,u[42]),O=i(O,D,P,N,g,23,u[43]),N=i(N,O,D,P,E,4,u[44]),P=i(P,N,O,D,R,11,u[45]),D=i(D,P,N,O,A,16,u[46]),O=i(O,D,P,N,f,23,u[47]),N=a(N,O,D,P,d,6,u[48]),P=a(P,N,O,D,C,10,u[49]),D=a(D,P,N,O,I,15,u[50]),O=a(O,D,P,N,v,21,u[51]),N=a(N,O,D,P,R,6,u[52]),P=a(P,N,O,D,p,10,u[53]),D=a(D,P,N,O,b,15,u[54]),O=a(O,D,P,N,h,21,u[55]),N=a(N,O,D,P,S,6,u[56]),P=a(P,N,O,D,A,10,u[57]),D=a(D,P,N,O,g,15,u[58]),O=a(O,D,P,N,T,21,u[59]),N=a(N,O,D,P,m,6,u[60]),P=a(P,N,O,D,y,10,u[61]),D=a(D,P,N,O,f,15,u[62]),O=a(O,D,P,N,E,21,u[63]),l[0]=0|l[0]+N,l[1]=0|l[1]+O,l[2]=0|l[2]+D,l[3]=0|l[3]+P},_doFinalize:function(){var e=this._data,n=e.words,r=8*this._nDataBytes,i=8*e.sigBytes;n[i>>>5]|=128<<24-i%32;var a=t.floor(r/4294967296),o=r;n[15+(i+64>>>9<<4)]=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8),n[14+(i+64>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),e.sigBytes=4*(n.length+1),this._process();for(var s,c=this._hash,l=c.words,d=0;4>d;d++)s=l[d],l[d]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8);return c},clone:function(){var e=l.clone.call(this);return e._hash=this._hash.clone(),e}});o.MD5=l._createHelper(h),o.HmacMD5=l._createHmacHelper(h)}(Math),e.MD5}(n(0))},function(e,t,n){"use strict";function r(e){return e.reduce(function(e,n){return"b"!==n.type?e:"SimpleBlock"!==n.name?e:t.ebmlBlock(n.data).frames.some(function(e){return"9d012a"===e.slice(3,6).toString("hex")})?e.concat(n):e},[])}function i(e){var n=a("VP8 ",e);return a("RIFF",h([new t.Buffer("WEBP","ascii"),n]))}function a(e,n){var r=new t.Buffer(4);return r.writeUInt32LE(n.byteLength,0),h([new t.Buffer(e.substr(0,4),"ascii"),r,n,new t.Buffer(0==n.byteLength%2?0:1)])}function o(e,t){for(var n,r=-1,i=0;i<t.length;i++)if((n=t[i]).name===e){if("m"!==n.type)return void t.splice(i,1);if(n.isEnd){if(-1==r)throw new Error("Detected "+e+" closing element before finding the start");return void t.splice(r,i-r+1)}r=i}}function s(e,t){for(var n,r=[],i=-1,a=0;a<t.length;a++)if((n=t[a]).name===e){if("m"!==n.type){r.push(t[a]);break}if(n.isEnd){if(-1==i)throw new Error("Detected "+e+" closing element before finding the start");r=t.slice(i,a+1);break}i=a}return r}function c(e){var t=new C.default;return e.reduce(function(e,n){return e.concat(t.encode([n]))},[]).reduce(function(e,t){return e+t.byteLength},0)}function l(e,t,n){var r=n.duration,i=n.clusterPtrs,a=n.cues,o=e.slice(0);if("number"==typeof r){var s=!1;o.forEach(function(e){"f"===e.type&&"Duration"===e.name&&(s=!0,e.data=m(r,8))}),s||u(o,"Info",[{name:"Duration",type:"f",data:m(r,8)}])}Array.isArray(a)&&u(o,"Cues",function(e,t){var n=[];return e.forEach(function(e){var r=e.CueTrack,i=e.CueClusterPosition,a=e.CueTime;n.push({name:"CuePoint",type:"m",isEnd:!1}),n.push({name:"CueTime",type:"u",data:f(a)}),n.push({name:"CueTrackPositions",type:"m",isEnd:!1}),n.push({name:"CueTrack",type:"u",data:f(r)}),n.push({name:"CueClusterPosition",type:"u",data:f(i+t)}),n.push({name:"CueTrackPositions",type:"m",isEnd:!0}),n.push({name:"CuePoint",type:"m",isEnd:!0})}),n}(a,t));var c=[];return Array.isArray(i)&&(console.warn("append cluster pointers to seekhead is deprecated. please use cues"),c=d(i,t)),u(o,"SeekHead",c,!0),o}function d(e,n){var r=[];return e.forEach(function(e){r.push({name:"Seek",type:"m",isEnd:!1}),r.push({name:"SeekID",type:"b",data:new t.Buffer([31,67,182,117])}),r.push({name:"SeekPosition",type:"u",data:f(e+n)}),r.push({name:"Seek",type:"m",isEnd:!0})}),r}function u(e,t,n,r){void 0===r&&(r=!1);for(var i,a=-1,o=0;o<e.length;o++)if("m"===(i=e[o]).type&&i.name===t&&!1===i.isEnd){a=o;break}0<=a?Array.prototype.splice.apply(e,[a+1,0].concat(n)):r?[].concat([{name:t,type:"m",isEnd:!1}],n,[{name:t,type:"m",isEnd:!0}]).reverse().forEach(function(t){e.unshift(t)}):(e.push({name:t,type:"m",isEnd:!1}),n.forEach(function(t){e.push(t)}),e.push({name:t,type:"m",isEnd:!0}))}function h(e){for(var n=0,r=0;n<e.length;++n)r+=e[n].length;var i=t.Buffer.allocUnsafe(r),a=0;for(n=0;n<e.length;++n){var o=e[n];o.copy(i,a),a+=o.length}return i}function f(e){for(var n=1;e>=v(2,8*n);n++);if(7<=n)return console.warn("7bit or more bigger uint not supported."),new g.Uint64BE(e).toBuffer();var r=new t.Buffer(n);return r.writeUIntBE(e,0,n),r}function p(e){for(var n=1;e>=v(2,8*n);n++);if(7<=n)return console.warn("7bit or more bigger uint not supported."),new g.Int64BE(e).toBuffer();var r=new t.Buffer(n);return r.writeIntBE(e,0,n),r}function m(e,n){var r;if(void 0===n&&(n=8),8===n)return(r=new t.Buffer(8)).writeDoubleBE(e,0),r;if(4===n)return(r=new t.Buffer(4)).writeFloatBE(e,0),r;throw new Error("float type bits must 4bytes or 8bytes")}var v=Math.pow;Object.defineProperty(t,"__esModule",{value:!0});var g=n(15),C=n(16),S=n(11),E=n(135),b=n(136);t.Buffer=S.Buffer,t.readVint=E.readVint,t.writeVint=E.writeVint,t.ebmlBlock=b,t.readBlock=function(e){return t.ebmlBlock(new t.Buffer(e))},t.encodeTag=function(e,n,r){return void 0===r&&(r=!1),h([e,r?new t.Buffer("01ffffffffffffff","hex"):t.writeVint(n.length),n])},t.WebPFrameFilter=function(e){return r(e).reduce(function(e,n){return t.ebmlBlock(n.data).frames.reduce(function(e,t){var n=i(t),r=new Blob([n],{type:"image/webp"});return e.concat(r)},e)},[])},t.WebPBlockFilter=r,t.VP8BitStreamToRiffWebPBuffer=i,t.createRIFFChunk=a,t.makeMetadataSeekable=function(e,n,r){var i=s("EBML",e),a=c(i)+12,l=e[e.length-1].dataEnd-a,d=s("Info",e);o("Duration",d),d.splice(1,0,{name:"Duration",type:"f",data:m(n,8)});for(var u=c(d),h=s("Tracks",e),p=c(h),v=47,g=[],S=5+15*r.length,E=[],b=-1,y=function(e){var n=v,i=n+u,o=i+p,s=o+S-l;if((g=[]).push({name:"SeekHead",type:"m",isEnd:!1}),g.push({name:"Seek",type:"m",isEnd:!1}),g.push({name:"SeekID",type:"b",data:new t.Buffer([21,73,169,102])}),g.push({name:"SeekPosition",type:"u",data:f(n)}),g.push({name:"Seek",type:"m",isEnd:!0}),g.push({name:"Seek",type:"m",isEnd:!1}),g.push({name:"SeekID",type:"b",data:new t.Buffer([22,84,174,107])}),g.push({name:"SeekPosition",type:"u",data:f(i)}),g.push({name:"Seek",type:"m",isEnd:!0}),g.push({name:"Seek",type:"m",isEnd:!1}),g.push({name:"SeekID",type:"b",data:new t.Buffer([28,83,187,107])}),g.push({name:"SeekPosition",type:"u",data:f(o)}),g.push({name:"Seek",type:"m",isEnd:!0}),g.push({name:"SeekHead",type:"m",isEnd:!0}),v=c(g),(E=[]).push({name:"Cues",type:"m",isEnd:!1}),r.forEach(function(e){var t=e.CueTrack,n=e.CueClusterPosition,r=e.CueTime;E.push({name:"CuePoint",type:"m",isEnd:!1}),E.push({name:"CueTime",type:"u",data:f(r)}),E.push({name:"CueTrackPositions",type:"m",isEnd:!1}),E.push({name:"CueTrack",type:"u",data:f(t)}),n-=a,n+=s,E.push({name:"CueClusterPosition",type:"u",data:f(n)}),E.push({name:"CueTrackPositions",type:"m",isEnd:!0}),E.push({name:"CuePoint",type:"m",isEnd:!0})}),E.push({name:"Cues",type:"m",isEnd:!0}),S=c(E),b==s)return"break";if(b=s,9===e)throw new Error("Failed to converge to a stable metadata size")},R=0;R<10&&"break"!==y(R);R++);var T=[].concat.apply([],[i,{name:"Segment",type:"m",isEnd:!1,unknownSize:!0},g,d,h,E]);return(new C.default).encode(T)},t.removeElement=o,t.extractElement=s,t.putRefinedMetaData=function(e,n){Array.isArray(n.cueInfos)&&!Array.isArray(n.cues)&&(console.warn("putRefinedMetaData: info.cueInfos property is deprecated. please use info.cues"),n.cues=n.cueInfos);for(var r,i=[],a=[],o=0;o<e.length;o++)if("m"===(r=e[o]).type&&"Segment"===r.name){if(i=e.slice(0,o),a=e.slice(o),r.unknownSize){a.shift();break}throw new Error("this metadata is not streaming webm file")}if(!(0<a[a.length-1].dataEnd))throw new Error("metadata dataEnd has wrong number");var s,c=a[a.length-1].dataEnd,d=i[i.length-1].dataEnd,u=(new C.default).encode(i).byteLength,h=c-a[0].tagStart,f=(a[0].tagStart,a[0].tagStart,new t.Buffer([24,83,128,103])),p=new t.Buffer("01ffffffffffffff","hex"),m=f.byteLength+p.byteLength,v=h;for(s=1;20>s;s++){var g=l(a,u-d+(d+m+v-c),n),S=(new C.default).encode(g).byteLength;if(S===v)return(new C.default).encode([].concat(i,[{type:"m",name:"Segment",isEnd:!1,unknownSize:!0}],g));v=S}throw new Error("unable to refine metadata, stable size could not be found in "+s+" iterations!")},t.concat=h,t.encodeValueToBuffer=function(e){var n=new t.Buffer(0);if("m"===e.type)return e;switch(e.type){case"u":n=f(e.value);break;case"i":n=p(e.value);break;case"f":n=m(e.value);break;case"s":n=new t.Buffer(e.value,"ascii");break;case"8":n=new t.Buffer(e.value,"utf8");break;case"b":n=e.value;break;case"d":n=new g.Int64BE(e.value.getTime().toString()).toBuffer()}return Object.assign({},e,{data:n})},t.createUIntBuffer=f,t.createIntBuffer=p,t.createFloatBuffer=m,t.convertEBMLDateToJSDate=function(e){return e instanceof Date?e:new Date(new Date("2001-01-01T00:00:00.000Z").getTime()+ +e/1e3/1e3)}},function(e){"use strict";var t={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})},t.splitSections=function(e){return e.split("\nm=").map(function(e,t){return(0<t?"m="+e:e).trim()+"\r\n"})},t.getDescription=function(e){var n=t.splitSections(e);return n&&n[0]},t.getMediaSections=function(e){var n=t.splitSections(e);return n.shift(),n},t.matchPrefix=function(e,n){return t.splitLines(e).filter(function(e){return 0===e.indexOf(n)})},t.parseCandidate=function(e){for(var t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "),n={foundation:t[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},r=8;r<t.length;r+=2)switch(t[r]){case"raddr":n.relatedAddress=t[r+1];break;case"rport":n.relatedPort=parseInt(t[r+1],10);break;case"tcptype":n.tcpType=t[r+1];break;case"ufrag":n.ufrag=t[r+1],n.usernameFragment=t[r+1];break;default:n[t[r]]=t[r+1]}return n},t.writeCandidate=function(e){var t=[e.foundation,e.component,e.protocol.toUpperCase(),e.priority,e.address||e.ip,e.port],n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){var t=e.substr(9).split(" "),n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.channels=3===t.length?parseInt(t[2],10):1,n.numChannels=n.channels,n},t.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var n=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1===n?"":"/"+n)+"\r\n"},t.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:0<t[0].indexOf("/")?t[0].split("/")[1]:"sendrecv",uri:t[1]}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},t.parseFmtp=function(e){for(var t,n={},r=e.substr(e.indexOf(" ")+1).split(";"),i=0;i<r.length;i++)n[(t=r[i].trim().split("="))[0].trim()]=t[1];return n},t.writeFmtp=function(e){var t="",n=e.payloadType;if(void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var r=[];Object.keys(e.parameters).forEach(function(t){e.parameters[t]?r.push(t+"="+e.parameters[t]):r.push(t)}),t+="a=fmtp:"+n+" "+r.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){var t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},t.parseSsrcMedia=function(e){var t=e.indexOf(" "),n={ssrc:parseInt(e.substr(7,t-7),10)},r=e.indexOf(":",t);return-1<r?(n.attribute=e.substr(t+1,r-t-1),n.value=e.substr(r+1)):n.attribute=e.substr(t+1),n},t.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map(function(e){return parseInt(e,10)})}},t.getMid=function(e){var n=t.matchPrefix(e,"a=mid:")[0];if(n)return n.substr(6)},t.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},t.getDtlsParameters=function(e,n){return{role:"auto",fingerprints:t.matchPrefix(e+n,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){var n="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),n},t.getIceParameters=function(e,n){var r=t.splitLines(e);return{usernameFragment:(r=r.concat(t.splitLines(n))).filter(function(e){return 0===e.indexOf("a=ice-ufrag:")})[0].substr(12),password:r.filter(function(e){return 0===e.indexOf("a=ice-pwd:")})[0].substr(10)}},t.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},t.parseRtpParameters=function(e){for(var n={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=t.splitLines(e)[0].split(" "),i=3;i<r.length;i++){var a=r[i],o=t.matchPrefix(e,"a=rtpmap:"+a+" ")[0];if(o){var s=t.parseRtpMap(o),c=t.matchPrefix(e,"a=fmtp:"+a+" ");switch(s.parameters=c.length?t.parseFmtp(c[0]):{},s.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+a+" ").map(t.parseRtcpFb),n.codecs.push(s),s.name.toUpperCase()){case"RED":case"ULPFEC":n.fecMechanisms.push(s.name.toUpperCase())}}}return t.matchPrefix(e,"a=extmap:").forEach(function(e){n.headerExtensions.push(t.parseExtmap(e))}),n},t.writeRtpDescription=function(e,n){var r="";r+="m="+e+" ",r+=0<n.codecs.length?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=n.codecs.map(function(e){return void 0===e.preferredPayloadType?e.payloadType:e.preferredPayloadType}).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",n.codecs.forEach(function(e){r+=t.writeRtpMap(e),r+=t.writeFmtp(e),r+=t.writeRtcpFb(e)});var i=0;return n.codecs.forEach(function(e){e.maxptime>i&&(i=e.maxptime)}),0<i&&(r+="a=maxptime:"+i+"\r\n"),r+="a=rtcp-mux\r\n",n.headerExtensions&&n.headerExtensions.forEach(function(e){r+=t.writeExtmap(e)}),r},t.parseRtpEncodingParameters=function(e){var n,r=[],i=t.parseRtpParameters(e),a=-1!==i.fecMechanisms.indexOf("RED"),o=-1!==i.fecMechanisms.indexOf("ULPFEC"),s=t.matchPrefix(e,"a=ssrc:").map(function(e){return t.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),c=0<s.length&&s[0].ssrc,l=t.matchPrefix(e,"a=ssrc-group:FID").map(function(e){return e.substr(17).split(" ").map(function(e){return parseInt(e,10)})});0<l.length&&1<l[0].length&&l[0][0]===c&&(n=l[0][1]),i.codecs.forEach(function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var t={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&n&&(t.rtx={ssrc:n}),r.push(t),a&&((t=JSON.parse(JSON.stringify(t))).fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},r.push(t))}}),0===r.length&&c&&r.push({ssrc:c});var d=t.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substr(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substr(5),10)*.95-16e3:void 0,r.forEach(function(e){e.maxBitrate=d})),r},t.parseRtcpParameters=function(e){var n={},r=t.matchPrefix(e,"a=ssrc:").map(function(e){return t.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];r&&(n.cname=r.value,n.ssrc=r.ssrc);var i=t.matchPrefix(e,"a=rtcp-rsize");n.reducedSize=0<i.length,n.compound=0===i.length;var a=t.matchPrefix(e,"a=rtcp-mux");return n.mux=0<a.length,n},t.parseMsid=function(e){var n,r=t.matchPrefix(e,"a=msid:");if(1===r.length)return{stream:(n=r[0].substr(7).split(" "))[0],track:n[1]};var i=t.matchPrefix(e,"a=ssrc:").map(function(e){return t.parseSsrcMedia(e)}).filter(function(e){return"msid"===e.attribute});return 0<i.length?{stream:(n=i[0].value.split(" "))[0],track:n[1]}:void 0},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,n,r){var i=void 0===n?2:n;return"v=0\r\no="+(r||"thisisadapterortc")+" "+(e||t.generateSessionId())+" "+i+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.writeMediaSection=function(e,n,r,i){var a=t.writeRtpDescription(e.kind,n);if(a+=t.writeIceParameters(e.iceGatherer.getLocalParameters()),a+=t.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":"active"),a+="a=mid:"+e.mid+"\r\n",a+=e.direction?"a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?"a=sendrecv\r\n":e.rtpSender?"a=sendonly\r\n":e.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",e.rtpSender){var o="msid:"+i.id+" "+e.rtpSender.track.id+"\r\n";a+="a="+o,a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o,e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+o,a+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+t.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+t.localCName+"\r\n"),a},t.getDirection=function(e,n){for(var r=t.splitLines(e),i=0;i<r.length;i++)switch(r[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[i].substr(2)}return n?t.getDirection(n):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substr(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){var n=t.splitLines(e)[0].substr(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}},t.parseOLine=function(e){var n=t.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var n=t.splitLines(e),r=0;r<n.length;r++)if(2>n[r].length||"="!==n[r].charAt(1))return!1;return!0},e.exports=t},function(e,t,n){e.exports=function(e){return n=(t=e).lib,r=n.Base,i=n.WordArray,(a=t.x64={}).Word=r.extend({init:function(e,t){this.high=e,this.low=t}}),a.WordArray=r.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null==t?8*e.length:t},toX32:function(){for(var e,t=this.words,n=t.length,r=[],a=0;a<n;a++)e=t[a],r.push(e.high),r.push(e.low);return i.create(r,this.sigBytes)},clone:function(){for(var e=r.clone.call(this),t=e.words=this.words.slice(0),n=t.length,i=0;i<n;i++)t[i]=t[i].clone();return e}}),e;var t,n,r,i,a}(n(0))},function(e,t,n){e.exports=function(e){return n=(t=e).lib,r=n.WordArray,i=n.Hasher,a=t.algo,o=[],s=a.SHA1=i.extend({_doReset:function(){this._hash=new r.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var n=this._hash.words,r=n[0],i=n[1],a=n[2],s=n[3],c=n[4],l=0;80>l;l++){if(16>l)o[l]=0|e[t+l];else{var d=o[l-3]^o[l-8]^o[l-14]^o[l-16];o[l]=d<<1|d>>>31}var u=(r<<5|r>>>27)+c+o[l];u+=20>l?1518500249+(i&a|~i&s):40>l?1859775393+(i^a^s):60>l?(i&a|i&s|a&s)-1894007588:(i^a^s)-899497514,c=s,s=a,a=i<<30|i>>>2,i=r,r=u}n[0]=0|n[0]+r,n[1]=0|n[1]+i,n[2]=0|n[2]+a,n[3]=0|n[3]+s,n[4]=0|n[4]+c},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,r=8*e.sigBytes;return t[r>>>5]|=128<<24-r%32,t[14+(r+64>>>9<<4)]=Math.floor(n/4294967296),t[15+(r+64>>>9<<4)]=n,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=i.clone.call(this);return e._hash=this._hash.clone(),e}}),t.SHA1=i._createHelper(s),t.HmacSHA1=i._createHmacHelper(s),e.SHA1;var t,n,r,i,a,o,s}(n(0))},function(e,t,n){e.exports=function(e){var t,n,r,i,a;n=(t=e).lib,r=n.Base,i=t.enc,a=i.Utf8,t.algo.HMAC=r.extend({init:function(e,t){e=this._hasher=new e.init,"string"==typeof t&&(t=a.parse(t));var n=e.blockSize,r=4*n;t.sigBytes>r&&(t=e.finalize(t)),t.clamp();for(var i=this._oKey=t.clone(),o=this._iKey=t.clone(),s=i.words,c=o.words,l=0;l<n;l++)s[l]^=1549556828,c[l]^=909522486;i.sigBytes=o.sigBytes=r,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,n=t.finalize(e);t.reset();var r=t.finalize(this._oKey.clone().concat(n));return r}})}(n(0))},function(e,t,n){"use strict";var r=Math.pow,i=Math.floor,a=Math.min,o=String.fromCharCode;(function(e){function s(){return l.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function c(e,t){if(s()<t)throw new RangeError("Invalid typed array length");return l.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=l.prototype:(null===e&&(e=new l(t)),e.length=t),e}function l(e,t,n){if(!(l.TYPED_ARRAY_SUPPORT||this instanceof l))return new l(e,t,n);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return h(this,e)}return d(this,e,t,n)}function d(e,t,n,r){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,n,r){if(t.byteLength,0>n||t.byteLength<n)throw new RangeError("'offset' is out of bounds");if(t.byteLength<n+(r||0))throw new RangeError("'length' is out of bounds");return t=void 0===n&&void 0===r?new Uint8Array(t):void 0===r?new Uint8Array(t,n):new Uint8Array(t,n,r),l.TYPED_ARRAY_SUPPORT?(e=t).__proto__=l.prototype:e=f(e,t),e}(e,t,n,r):"string"==typeof t?function(e,t,n){if(("string"!=typeof n||""===n)&&(n="utf8"),!l.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var r=0|m(t,n),i=(e=c(e,r)).write(t,n);return i!==r&&(e=e.slice(0,i)),e}(e,t,n):function(e,t){if(l.isBuffer(t)){var n=0|p(t.length);return 0===(e=c(e,n)).length?e:(t.copy(e,0,0,n),e)}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||function(e){return e!=e}
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>
 * @license  MIT
 */(t.length)?c(e,0):f(e,t);if("Buffer"===t.type&&W(t.data))return f(e,t.data)}throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function u(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(0>e)throw new RangeError('"size" argument must not be negative')}function h(e,t){if(u(t),e=c(e,0>t?0:0|p(t)),!l.TYPED_ARRAY_SUPPORT)for(var n=0;n<t;++n)e[n]=0;return e}function f(e,t){var n=0>t.length?0:0|p(t.length);e=c(e,n);for(var r=0;r<n;r+=1)e[r]=255&t[r];return e}function p(e){if(e>=s())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s().toString(16)+" bytes");return 0|e}function m(e,t){if(l.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var n=e.length;if(0===n)return 0;for(var r=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return x(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return H(e).length;default:if(r)return x(e).length;t=(""+t).toLowerCase(),r=!0}}function v(e,t,n){var r=e[t];e[t]=e[n],e[n]=r}function g(e,t,n,r,i){if(0===e.length)return-1;if("string"==typeof n?(r=n,n=0):2147483647<n?n=2147483647:-2147483648>n&&(n=-2147483648),n=+n,isNaN(n)&&(n=i?0:e.length-1),0>n&&(n=e.length+n),n>=e.length){if(i)return-1;n=e.length-1}else if(0>n){if(!i)return-1;n=0}if("string"==typeof t&&(t=l.from(t,r)),l.isBuffer(t))return 0===t.length?-1:C(e,t,n,r,i);if("number"==typeof t)return t&=255,l.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):C(e,[t],n,r,i);throw new TypeError("val must be string, number or Buffer")}function C(e,t,n,r,i){function a(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}var o,s=1,c=e.length,l=t.length;if(void 0!==r&&("ucs2"===(r=(r+"").toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(2>e.length||2>t.length)return-1;s=2,c/=2,l/=2,n/=2}if(i){var d=-1;for(o=n;o<c;o++)if(a(e,o)!==a(t,-1==d?0:o-d))-1!=d&&(o-=o-d),d=-1;else if(-1==d&&(d=o),o-d+1===l)return d*s}else for(n+l>c&&(n=c-l),o=n;0<=o;o--){for(var u=!0,h=0;h<l;h++)if(a(e,o+h)!==a(t,h)){u=!1;break}if(u)return o}return-1}function S(e,t,n,r){n=+n||0;var i=e.length-n;r?(r=+r)>i&&(r=i):r=i;var a=t.length;if(0!=a%2)throw new TypeError("Invalid hex string");r>a/2&&(r=a/2);for(var o,s=0;s<r;++s){if(o=parseInt(t.substr(2*s,2),16),isNaN(o))return s;e[n+s]=o}return s}function E(e,t,n,r){return j(x(t,e.length-n),e,n,r)}function b(e,t,n,r){return j(function(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,r)}function y(e,t,n,r){return b(e,t,n,r)}function R(e,t,n,r){return j(H(t),e,n,r)}function T(e,t,n,r){return j(function(e,t){for(var n,r,i,a=[],o=0;o<e.length&&!(0>(t-=2));++o)n=e.charCodeAt(o),r=n>>8,i=n%256,a.push(i),a.push(r);return a}(t,e.length-n),e,n,r)}function I(e,t,n){return 0===t&&n===e.length?V.fromByteArray(e):V.fromByteArray(e.slice(t,n))}function A(e,t,n){n=a(e.length,n);for(var r=[],i=t;i<n;){var o,s,c,l,d=e[i],u=null,h=239<d?4:223<d?3:191<d?2:1;if(i+h<=n)1==h?128>d&&(u=d):2==h?128==(192&(o=e[i+1]))&&(127<(l=(31&d)<<6|63&o)&&(u=l)):3==h?(o=e[i+1],s=e[i+2],128==(192&o)&&128==(192&s)&&(2047<(l=(15&d)<<12|(63&o)<<6|63&s)&&(55296>l||57343<l)&&(u=l))):4==h&&(o=e[i+1],s=e[i+2],c=e[i+3],128==(192&o)&&128==(192&s)&&128==(192&c)&&(65535<(l=(15&d)<<18|(63&o)<<12|(63&s)<<6|63&c)&&1114112>l&&(u=l)));null===u?(u=65533,h=1):65535<u&&(u-=65536,r.push(55296|1023&u>>>10),u=56320|1023&u),r.push(u),i+=h}return N(r)}function N(e){var t=e.length;if(t<=q)return o.apply(String,e);for(var n="",r=0;r<t;)n+=o.apply(String,e.slice(r,r+=q));return n}function O(e,t,n){var r="";n=a(e.length,n);for(var i=t;i<n;++i)r+=o(127&e[i]);return r}function D(e,t,n){var r="";n=a(e.length,n);for(var i=t;i<n;++i)r+=o(e[i]);return r}function P(e,t,n){var r=e.length;(!t||0>t)&&(t=0),(!n||0>n||n>r)&&(n=r);for(var i="",a=t;a<n;++a)i+=$(e[a]);return i}function w(e,t,n){for(var r=e.slice(t,n),i="",a=0;a<r.length;a+=2)i+=o(r[a]+256*r[a+1]);return i}function _(e,t,n){if(0!=e%1||0>e)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function M(e,t,n,r,i,a){if(!l.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<a)throw new RangeError('"value" argument is out of bounds');if(n+r>e.length)throw new RangeError("Index out of range")}function k(e,t,n,r){0>t&&(t=65535+t+1);for(var i=0,o=a(e.length-n,2);i<o;++i)e[n+i]=(t&255<<8*(r?i:1-i))>>>8*(r?i:1-i)}function U(e,t,n,r){0>t&&(t=4294967295+t+1);for(var i=0,o=a(e.length-n,4);i<o;++i)e[n+i]=255&t>>>8*(r?i:3-i)}function L(e,t,n,r){if(n+r>e.length)throw new RangeError("Index out of range");if(0>n)throw new RangeError("Index out of range")}function F(e,t,n,r,i){return i||L(e,0,n,4),G.write(e,t,n,r,23,4),n+4}function B(e,t,n,r,i){return i||L(e,0,n,8),G.write(e,t,n,r,52,8),n+8}function $(e){return 16>e?"0"+e.toString(16):e.toString(16)}function x(e,t){t=t||1/0;for(var n,r=e.length,i=null,a=[],o=0;o<r;++o){if(55295<(n=e.charCodeAt(o))&&57344>n){if(!i){if(56319<n){-1<(t-=3)&&a.push(239,191,189);continue}if(o+1===r){-1<(t-=3)&&a.push(239,191,189);continue}i=n;continue}if(56320>n){-1<(t-=3)&&a.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&-1<(t-=3)&&a.push(239,191,189);if(i=null,128>n){if(0>(t-=1))break;a.push(n)}else if(2048>n){if(0>(t-=2))break;a.push(192|n>>6,128|63&n)}else if(65536>n){if(0>(t-=3))break;a.push(224|n>>12,128|63&n>>6,128|63&n)}else{if(!(1114112>n))throw new Error("Invalid code point");if(0>(t-=4))break;a.push(240|n>>18,128|63&n>>12,128|63&n>>6,128|63&n)}}return a}function H(e){return V.toByteArray(function(e){if(2>(e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(J,"")).length)return"";for(;0!=e.length%4;)e+="=";return e}(e))}function j(e,t,n,r){for(var i=0;i<r&&!(i+n>=t.length||i>=e.length);++i)t[i+n]=e[i];return i}var V=n(132),G=n(133),W=n(134);t.Buffer=l,t.SlowBuffer=function(e){return+e!=e&&(e=0),l.alloc(+e)},t.INSPECT_MAX_BYTES=50,l.TYPED_ARRAY_SUPPORT=void 0===e.TYPED_ARRAY_SUPPORT?function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}():e.TYPED_ARRAY_SUPPORT,t.kMaxLength=s(),l.poolSize=8192,l._augment=function(e){return e.__proto__=l.prototype,e},l.from=function(e,t,n){return d(null,e,t,n)},l.TYPED_ARRAY_SUPPORT&&(l.prototype.__proto__=Uint8Array.prototype,l.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&l[Symbol.species]===l&&Object.defineProperty(l,Symbol.species,{value:null,configurable:!0})),l.alloc=function(e,t,n){return function(e,t,n,r){return u(t),0>=t?c(e,t):void 0===n?c(e,t):"string"==typeof r?c(e,t).fill(n,r):c(e,t).fill(n)}(null,e,t,n)},l.allocUnsafe=function(e){return h(null,e)},l.allocUnsafeSlow=function(e){return h(null,e)},l.isBuffer=function(e){return!(null==e||!e._isBuffer)},l.compare=function(e,t){if(!l.isBuffer(e)||!l.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var n=e.length,r=t.length,i=0,o=a(n,r);i<o;++i)if(e[i]!==t[i]){n=e[i],r=t[i];break}return n<r?-1:r<n?1:0},l.isEncoding=function(e){switch((e+"").toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},l.concat=function(e,t){if(!W(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return l.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var r=l.allocUnsafe(t),i=0;for(n=0;n<e.length;++n){var a=e[n];if(!l.isBuffer(a))throw new TypeError('"list" argument must be an Array of Buffers');a.copy(r,i),i+=a.length}return r},l.byteLength=m,l.prototype._isBuffer=!0,l.prototype.swap16=function(){var e=this.length;if(0!=e%2)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)v(this,t,t+1);return this},l.prototype.swap32=function(){var e=this.length;if(0!=e%4)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)v(this,t,t+3),v(this,t+1,t+2);return this},l.prototype.swap64=function(){var e=this.length;if(0!=e%8)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)v(this,t,t+7),v(this,t+1,t+6),v(this,t+2,t+5),v(this,t+3,t+4);return this},l.prototype.toString=function(){var e=0|this.length;return 0==e?"":0===arguments.length?A(this,0,e):function(e,t,n){var r=!1;if((void 0===t||0>t)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),0>=n)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return P(this,t,n);case"utf8":case"utf-8":return A(this,t,n);case"ascii":return O(this,t,n);case"latin1":case"binary":return D(this,t,n);case"base64":return I(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return w(this,t,n);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}.apply(this,arguments)},l.prototype.equals=function(e){if(!l.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===l.compare(this,e)},l.prototype.inspect=function(){var e="",n=t.INSPECT_MAX_BYTES;return 0<this.length&&(e=this.toString("hex",0,n).match(/.{2}/g).join(" "),this.length>n&&(e+=" ... ")),"<Buffer "+e+">"},l.prototype.compare=function(e,t,n,r,i){if(!l.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===r&&(r=0),void 0===i&&(i=this.length),0>t||n>e.length||0>r||i>this.length)throw new RangeError("out of range index");if(r>=i&&t>=n)return 0;if(r>=i)return-1;if(t>=n)return 1;if(this===e)return 0;for(var o=(i>>>=0)-(r>>>=0),s=(n>>>=0)-(t>>>=0),c=a(o,s),d=this.slice(r,i),u=e.slice(t,n),h=0;h<c;++h)if(d[h]!==u[h]){o=d[h],s=u[h];break}return o<s?-1:s<o?1:0},l.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},l.prototype.indexOf=function(e,t,n){return g(this,e,t,n,!0)},l.prototype.lastIndexOf=function(e,t,n){return g(this,e,t,n,!1)},l.prototype.write=function(e,t,n,r){if(void 0===t)r="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)r=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(n)?(n|=0,void 0===r&&(r="utf8")):(r=n,n=void 0)}var i=this.length-t;if((void 0===n||n>i)&&(n=i),0<e.length&&(0>n||0>t)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var a=!1;;)switch(r){case"hex":return S(this,e,t,n);case"utf8":case"utf-8":return E(this,e,t,n);case"ascii":return b(this,e,t,n);case"latin1":case"binary":return y(this,e,t,n);case"base64":return R(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return T(this,e,t,n);default:if(a)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),a=!0}},l.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var q=4096;l.prototype.slice=function(e,t){var n,r=this.length;if(0>(e=~~e)?0>(e+=r)&&(e=0):e>r&&(e=r),0>(t=void 0===t?r:~~t)?0>(t+=r)&&(t=0):t>r&&(t=r),t<e&&(t=e),l.TYPED_ARRAY_SUPPORT)(n=this.subarray(e,t)).__proto__=l.prototype;else{var i=t-e;n=new l(i,void 0);for(var a=0;a<i;++a)n[a]=this[a+e]}return n},l.prototype.readUIntLE=function(e,t,n){e|=0,t|=0,n||_(e,t,this.length);for(var r=this[e],i=1,a=0;++a<t&&(i*=256);)r+=this[e+a]*i;return r},l.prototype.readUIntBE=function(e,t,n){e|=0,t|=0,n||_(e,t,this.length);for(var r=this[e+--t],i=1;0<t&&(i*=256);)r+=this[e+--t]*i;return r},l.prototype.readUInt8=function(e,t){return t||_(e,1,this.length),this[e]},l.prototype.readUInt16LE=function(e,t){return t||_(e,2,this.length),this[e]|this[e+1]<<8},l.prototype.readUInt16BE=function(e,t){return t||_(e,2,this.length),this[e]<<8|this[e+1]},l.prototype.readUInt32LE=function(e,t){return t||_(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},l.prototype.readUInt32BE=function(e,t){return t||_(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},l.prototype.readIntLE=function(e,t,n){e|=0,t|=0,n||_(e,t,this.length);for(var i=this[e],a=1,o=0;++o<t&&(a*=256);)i+=this[e+o]*a;return i>=(a*=128)&&(i-=r(2,8*t)),i},l.prototype.readIntBE=function(e,t,n){e|=0,t|=0,n||_(e,t,this.length);for(var i=t,a=1,o=this[e+--i];0<i&&(a*=256);)o+=this[e+--i]*a;return o>=(a*=128)&&(o-=r(2,8*t)),o},l.prototype.readInt8=function(e,t){return t||_(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},l.prototype.readInt16LE=function(e,t){t||_(e,2,this.length);var n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},l.prototype.readInt16BE=function(e,t){t||_(e,2,this.length);var n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},l.prototype.readInt32LE=function(e,t){return t||_(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},l.prototype.readInt32BE=function(e,t){return t||_(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},l.prototype.readFloatLE=function(e,t){return t||_(e,4,this.length),G.read(this,e,!0,23,4)},l.prototype.readFloatBE=function(e,t){return t||_(e,4,this.length),G.read(this,e,!1,23,4)},l.prototype.readDoubleLE=function(e,t){return t||_(e,8,this.length),G.read(this,e,!0,52,8)},l.prototype.readDoubleBE=function(e,t){return t||_(e,8,this.length),G.read(this,e,!1,52,8)},l.prototype.writeUIntLE=function(e,t,n,i){(e=+e,t|=0,n|=0,i)||M(this,e,t,n,r(2,8*n)-1,0);var a=1,o=0;for(this[t]=255&e;++o<n&&(a*=256);)this[t+o]=255&e/a;return t+n},l.prototype.writeUIntBE=function(e,t,n,i){(e=+e,t|=0,n|=0,i)||M(this,e,t,n,r(2,8*n)-1,0);var a=n-1,o=1;for(this[t+a]=255&e;0<=--a&&(o*=256);)this[t+a]=255&e/o;return t+n},l.prototype.writeUInt8=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,1,255,0),l.TYPED_ARRAY_SUPPORT||(e=i(e)),this[t]=255&e,t+1},l.prototype.writeUInt16LE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,2,65535,0),l.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):k(this,e,t,!0),t+2},l.prototype.writeUInt16BE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,2,65535,0),l.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):k(this,e,t,!1),t+2},l.prototype.writeUInt32LE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,4,4294967295,0),l.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):U(this,e,t,!0),t+4},l.prototype.writeUInt32BE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,4,4294967295,0),l.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):U(this,e,t,!1),t+4},l.prototype.writeIntLE=function(e,t,n,i){if(e=+e,t|=0,!i){var a=r(2,8*n-1);M(this,e,t,n,a-1,-a)}var o=0,s=1,c=0;for(this[t]=255&e;++o<n&&(s*=256);)0>e&&0==c&&0!==this[t+o-1]&&(c=1),this[t+o]=255&(e/s>>0)-c;return t+n},l.prototype.writeIntBE=function(e,t,n,i){if(e=+e,t|=0,!i){var a=r(2,8*n-1);M(this,e,t,n,a-1,-a)}var o=n-1,s=1,c=0;for(this[t+o]=255&e;0<=--o&&(s*=256);)0>e&&0==c&&0!==this[t+o+1]&&(c=1),this[t+o]=255&(e/s>>0)-c;return t+n},l.prototype.writeInt8=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,1,127,-128),l.TYPED_ARRAY_SUPPORT||(e=i(e)),0>e&&(e=255+e+1),this[t]=255&e,t+1},l.prototype.writeInt16LE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,2,32767,-32768),l.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):k(this,e,t,!0),t+2},l.prototype.writeInt16BE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,2,32767,-32768),l.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):k(this,e,t,!1),t+2},l.prototype.writeInt32LE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,4,2147483647,-2147483648),l.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):U(this,e,t,!0),t+4},l.prototype.writeInt32BE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,4,2147483647,-2147483648),0>e&&(e=4294967295+e+1),l.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):U(this,e,t,!1),t+4},l.prototype.writeFloatLE=function(e,t,n){return F(this,e,t,!0,n)},l.prototype.writeFloatBE=function(e,t,n){return F(this,e,t,!1,n)},l.prototype.writeDoubleLE=function(e,t,n){return B(this,e,t,!0,n)},l.prototype.writeDoubleBE=function(e,t,n){return B(this,e,t,!1,n)},l.prototype.copy=function(e,t,n,r){if(n||(n=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),0<r&&r<n&&(r=n),r===n)return 0;if(0===e.length||0===this.length)return 0;if(0>t)throw new RangeError("targetStart out of bounds");if(0>n||n>=this.length)throw new RangeError("sourceStart out of bounds");if(0>r)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-n&&(r=e.length-t+n);var i,a=r-n;if(this===e&&n<t&&t<r)for(i=a-1;0<=i;--i)e[i+t]=this[i+n];else if(1e3>a||!l.TYPED_ARRAY_SUPPORT)for(i=0;i<a;++i)e[i+t]=this[i+n];else Uint8Array.prototype.set.call(e,this.subarray(n,n+a),t);return a},l.prototype.fill=function(e,t,n,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,n=this.length):"string"==typeof n&&(r=n,n=this.length),1===e.length){var i=e.charCodeAt(0);256>i&&(e=i)}if(void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!l.isEncoding(r))throw new TypeError("Unknown encoding: "+r)}else"number"==typeof e&&(e&=255);if(0>t||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;var a;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(a=t;a<n;++a)this[a]=e;else{var o=l.isBuffer(e)?e:x(new l(e,r).toString()),s=o.length;for(a=0;a<n-t;++a)this[a+t]=o[a%s]}return this};var J=/[^+\/0-9A-Za-z-_]/g}).call(this,n(131))},function(){window.version="1.54.2"},function(e,t,n){var r=Math.pow;!function(t,r){e.exports=r(n(0))}(0,function(e){return function(t){var n=e,i=n.lib,a=i.WordArray,o=i.Hasher,s=n.algo,c=[],l=[];!function(){function e(e){for(var n=t.sqrt(e),r=2;r<=n;r++)if(!(e%r))return!1;return!0}function n(e){return 0|4294967296*(e-(0|e))}for(var i=2,a=0;64>a;)e(i)&&(8>a&&(c[a]=n(r(i,.5))),l[a]=n(r(i,1/3)),a++),i++}();var d=[],u=s.SHA256=o.extend({_doReset:function(){this._hash=new a.init(c.slice(0))},_doProcessBlock:function(e,t){for(var n=this._hash.words,r=n[0],i=n[1],a=n[2],o=n[3],s=n[4],c=n[5],u=n[6],h=n[7],f=0;64>f;f++){if(16>f)d[f]=0|e[t+f];else{var p=d[f-15],m=d[f-2];d[f]=((p<<25|p>>>7)^(p<<14|p>>>18)^p>>>3)+d[f-7]+((m<<15|m>>>17)^(m<<13|m>>>19)^m>>>10)+d[f-16]}var v=r&i^r&a^i&a,g=(r<<30|r>>>2)^(r<<19|r>>>13)^(r<<10|r>>>22),C=h+((s<<26|s>>>6)^(s<<21|s>>>11)^(s<<7|s>>>25))+(s&c^~s&u)+l[f]+d[f];h=u,u=c,c=s,s=0|o+C,o=a,a=i,i=r,r=0|C+(g+v)}n[0]=0|n[0]+r,n[1]=0|n[1]+i,n[2]=0|n[2]+a,n[3]=0|n[3]+o,n[4]=0|n[4]+s,n[5]=0|n[5]+c,n[6]=0|n[6]+u,n[7]=0|n[7]+h},_doFinalize:function(){var e=this._data,n=e.words,r=8*this._nDataBytes,i=8*e.sigBytes;return n[i>>>5]|=128<<24-i%32,n[14+(i+64>>>9<<4)]=t.floor(r/4294967296),n[15+(i+64>>>9<<4)]=r,e.sigBytes=4*n.length,this._process(),this._hash},clone:function(){var e=o.clone.call(this);return e._hash=this._hash.clone(),e}});n.SHA256=o._createHelper(u),n.HmacSHA256=o._createHmacHelper(u)}(Math),e.SHA256})},function(e,t,n){e.exports=function(e){return function(){function t(){return o.create.apply(o,arguments)}var n=e,r=n.lib,i=r.Hasher,a=n.x64,o=a.Word,s=a.WordArray,c=n.algo,l=[t(1116352408,3609767458),t(1899447441,602891725),t(3049323471,3964484399),t(3921009573,2173295548),t(961987163,4081628472),t(1508970993,3053834265),t(2453635748,2937671579),t(2870763221,3664609560),t(3624381080,2734883394),t(310598401,1164996542),t(607225278,1323610764),t(1426881987,3590304994),t(1925078388,4068182383),t(2162078206,991336113),t(2614888103,633803317),t(3248222580,3479774868),t(3835390401,2666613458),t(4022224774,944711139),t(264347078,2341262773),t(604807628,2007800933),t(770255983,1495990901),t(1249150122,1856431235),t(1555081692,3175218132),t(1996064986,2198950837),t(2554220882,3999719339),t(2821834349,766784016),t(2952996808,2566594879),t(3210313671,3203337956),t(3336571891,1034457026),t(3584528711,2466948901),t(113926993,3758326383),t(338241895,168717936),t(666307205,1188179964),t(773529912,1546045734),t(1294757372,1522805485),t(1396182291,2643833823),t(1695183700,2343527390),t(1986661051,1014477480),t(2177026350,1206759142),t(2456956037,344077627),t(2730485921,1290863460),t(2820302411,3158454273),t(3259730800,3505952657),t(3345764771,106217008),t(3516065817,3606008344),t(3600352804,1432725776),t(4094571909,1467031594),t(275423344,851169720),t(430227734,3100823752),t(506948616,1363258195),t(659060556,3750685593),t(883997877,3785050280),t(958139571,3318307427),t(1322822218,3812723403),t(1537002063,2003034995),t(1747873779,3602036899),t(1955562222,1575990012),t(2024104815,1125592928),t(2227730452,2716904306),t(2361852424,442776044),t(2428436474,593698344),t(2756734187,3733110249),t(3204031479,2999351573),t(3329325298,3815920427),t(3391569614,3928383900),t(3515267271,566280711),t(3940187606,3454069534),t(4118630271,4000239992),t(116418474,1914138554),t(174292421,2731055270),t(289380356,3203993006),t(460393269,320620315),t(685471733,587496836),t(852142971,1086792851),t(1017036298,365543100),t(1126000580,2618297676),t(1288033470,3409855158),t(1501505948,4234509866),t(1607167915,987167468),t(1816402316,1246189591)],d=[];!function(){for(var e=0;80>e;e++)d[e]=t()}();var u=c.SHA512=i.extend({_doReset:function(){this._hash=new s.init([new o.init(1779033703,4089235720),new o.init(3144134277,2227873595),new o.init(1013904242,4271175723),new o.init(2773480762,1595750129),new o.init(1359893119,2917565137),new o.init(2600822924,725511199),new o.init(528734635,4215389547),new o.init(1541459225,327033209)])},_doProcessBlock:function(e,t){for(var n,r=this._hash.words,i=r[0],a=r[1],o=r[2],s=r[3],c=r[4],u=r[5],h=r[6],f=r[7],p=i.high,m=i.low,v=a.high,g=a.low,C=o.high,S=o.low,E=s.high,b=s.low,y=c.high,R=c.low,T=u.high,I=u.low,A=h.high,N=h.low,O=f.high,D=f.low,P=p,w=m,_=v,M=g,k=C,U=S,L=E,F=b,B=y,$=R,x=T,H=I,j=A,V=N,G=O,W=D,q=0;80>q;q++){if(n=d[q],16>q)var J=n.high=0|e[t+2*q],z=n.low=0|e[t+2*q+1];else{var K=d[q-15],Y=K.high,Q=K.low,X=(Q>>>1|Y<<31)^(Q>>>8|Y<<24)^(Q>>>7|Y<<25),Z=d[q-2],ee=Z.high,te=Z.low,ne=(te>>>19|ee<<13)^(te<<3|ee>>>29)^(te>>>6|ee<<26),re=d[q-7],ie=re.high,ae=re.low,oe=d[q-16],se=oe.high,ce=oe.low,z=X+ae,J=((Y>>>1|Q<<31)^(Y>>>8|Q<<24)^Y>>>7)+ie+(z>>>0<X>>>0?1:0),z=z+ne,J=J+((ee>>>19|te<<13)^(ee<<3|te>>>29)^ee>>>6)+(z>>>0<ne>>>0?1:0),z=z+ce,J=J+se+(z>>>0<ce>>>0?1:0);n.high=J,n.low=z}var le=B&x^~B&j,de=$&H^~$&V,ue=P&_^P&k^_&k,he=w&M^w&U^M&U,fe=(P>>>28|w<<4)^(P<<30|w>>>2)^(P<<25|w>>>7),pe=(w>>>28|P<<4)^(w<<30|P>>>2)^(w<<25|P>>>7),me=(B>>>14|$<<18)^(B>>>18|$<<14)^(B<<23|$>>>9),ve=($>>>14|B<<18)^($>>>18|B<<14)^($<<23|B>>>9),ge=l[q],Ce=ge.high,Se=ge.low,Ee=W+ve,be=G+me+(Ee>>>0<W>>>0?1:0),Ee=Ee+de,be=be+le+(Ee>>>0<de>>>0?1:0),Ee=Ee+Se,be=be+Ce+(Ee>>>0<Se>>>0?1:0),Ee=Ee+z,be=be+J+(Ee>>>0<z>>>0?1:0),ye=pe+he,Re=fe+ue+(ye>>>0<pe>>>0?1:0);G=j,W=V,j=x,V=H,x=B,H=$,B=0|L+be+(($=0|F+Ee)>>>0<F>>>0?1:0),L=k,F=U,k=_,U=M,_=P,M=w,P=0|be+Re+((w=0|Ee+ye)>>>0<Ee>>>0?1:0)}m=i.low=m+w,i.high=p+P+(m>>>0<w>>>0?1:0),g=a.low=g+M,a.high=v+_+(g>>>0<M>>>0?1:0),S=o.low=S+U,o.high=C+k+(S>>>0<U>>>0?1:0),b=s.low=b+F,s.high=E+L+(b>>>0<F>>>0?1:0),R=c.low=R+$,c.high=y+B+(R>>>0<$>>>0?1:0),I=u.low=I+H,u.high=T+x+(I>>>0<H>>>0?1:0),N=h.low=N+V,h.high=A+j+(N>>>0<V>>>0?1:0),D=f.low=D+W,f.high=O+G+(D>>>0<W>>>0?1:0)},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,r=8*e.sigBytes;t[r>>>5]|=128<<24-r%32,t[30+(r+128>>>10<<5)]=Math.floor(n/4294967296),t[31+(r+128>>>10<<5)]=n,e.sigBytes=4*t.length,this._process();var i=this._hash.toX32();return i},clone:function(){var e=i.clone.call(this);return e._hash=this._hash.clone(),e},blockSize:32});n.SHA512=i._createHelper(u),n.HmacSHA512=i._createHmacHelper(u)}(),e.SHA512}(n(0),n(8))},function(e,t,n){var r=Math.floor;(function(e){!function(t){function n(e,n,E){function R(e,t,n,r){return this instanceof R?function(e,t,n,r,i){if(g&&C&&(t instanceof C&&(t=new g(t)),r instanceof C&&(r=new g(r))),!(t||n||r||p))return void(e.buffer=l(S,0));if(!s(t,n)){var a=p||Array;i=n,r=t,n=0,t=new a(8)}e.buffer=t,e.offset=n|=0,m===typeof r||("string"==typeof r?T(t,n,r,i||10):s(r,i)?c(t,n,r,i):"number"==typeof i?(A(t,n+O,r),A(t,n+D,i)):0<r?k(t,n,r):0>r?U(t,n,r):c(t,n,S,0))}(this,e,t,n,r):new R(e,t,n,r)}function T(e,t,n,i){var a=0,o=n.length,s=0,c=0;"-"===n[0]&&a++;for(var l,d=a;a<o&&0<=(l=parseInt(n[a++],i));)s=s*i+r((c=c*i+l)/b),c%=b;d&&(s=~s,c?c=b-c:s++),A(e,t+O,s),A(e,t+D,c)}function I(){var e=this.buffer,t=this.offset,n=N(e,t+O),r=N(e,t+D);return E||(n|=0),n?n*b+r:r}function A(e,t,n){e[t+M]=255&n,n>>=8,e[t+_]=255&n,n>>=8,e[t+w]=255&n,n>>=8,e[t+P]=255&n}function N(e,t){return e[t+P]*y+(e[t+w]<<16)+(e[t+_]<<8)+e[t+M]}var O=n?0:4,D=n?4:0,P=n?0:3,w=n?1:2,_=n?2:1,M=n?3:0,k=n?d:h,U=n?u:f,L=R.prototype,F="is"+e,B="_"+F;return L.buffer=void 0,L.offset=0,L[B]=!0,L.toNumber=I,L.toString=function(e){var t=this.buffer,n=this.offset,i=N(t,n+O),a=N(t,n+D),o="",s=!E&&2147483648&i;for(s&&(i=~i,a=b-a),e=e||10;;){var c=i%e*b+a;if(i=r(i/e),a=r(c/e),o=(c%e).toString(e)+o,!i&&!a)break}return s&&(o="-"+o),o},L.toJSON=I,L.toArray=i,v&&(L.toBuffer=a),g&&(L.toArrayBuffer=o),R[F]=function(e){return!(!e||!e[B])},t[e]=R,R}function i(e){var t=this.buffer,n=this.offset;return p=null,!1!==e&&0===n&&8===t.length&&E(t)?t:l(t,n)}function a(t){var n=this.buffer,r=this.offset;if(p=v,!1!==t&&0===r&&8===n.length&&e.isBuffer(n))return n;var i=new v(8);return c(i,0,n,r),i}function o(e){var t=this.buffer,n=this.offset,r=t.buffer;if(p=g,!1!==e&&0===n&&r instanceof C&&8===r.byteLength)return r;var i=new g(8);return c(i,0,t,n),i.buffer}function s(e,t){var n=e&&e.length;return t|=0,n&&t+8<=n&&"string"!=typeof e[t]}function c(e,t,n,r){t|=0,r|=0;for(var i=0;8>i;i++)e[t++]=255&n[r++]}function l(e,t){return Array.prototype.slice.call(e,t,t+8)}function d(e,t,n){for(var r=t+8;r>t;)e[--r]=255&n,n/=256}function u(e,t,n){var r=t+8;for(n++;r>t;)e[--r]=255^255&-n,n/=256}function h(e,t,n){for(var r=t+8;t<r;)e[t++]=255&n,n/=256}function f(e,t,n){var r=t+8;for(n++;t<r;)e[t++]=255^255&-n,n/=256}var p,m="undefined",v=m!==typeof e&&e,g=m!==typeof Uint8Array&&Uint8Array,C=m!==typeof ArrayBuffer&&ArrayBuffer,S=[0,0,0,0,0,0,0,0],E=Array.isArray||function(e){return!!e&&"[object Array]"==Object.prototype.toString.call(e)},b=4294967296,y=16777216;n("Uint64BE",!0,!0),n("Int64BE",!0,!1),n("Uint64LE",!1,!0),n("Int64LE",!1,!1)}("string"!=typeof t.nodeName?t:this||{})}).call(this,n(11).Buffer)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(6),i=n(6),a=n(17).byEbmlID,o=function(){function e(){this._schema=a,this._buffers=[],this._stack=[]}return e.prototype.encode=function(e){var t=this;return r.concat(e.reduce(function(e,n){return e.concat(t.encodeChunk(n))},[])).buffer},e.prototype.encodeChunk=function(e){return"m"===e.type?e.isEnd?this.endTag(e):this.startTag(e):this.writeTag(e),this.flush()},e.prototype.flush=function(){var e=this._buffers;return this._buffers=[],e},e.prototype.getSchemaInfo=function(e){for(var t,n=Object.keys(this._schema).map(Number),r=0;r<n.length;r++)if(t=n[r],this._schema[t].name===e)return new i.Buffer(t.toString(16),"hex");return null},e.prototype.writeTag=function(e){var t=e.name,n=this.getSchemaInfo(t),i=e.data;if(null==n)throw new Error("No schema entry found for "+t);var a=r.encodeTag(n,i);0<this._stack.length?this._stack[this._stack.length-1].children.push({tagId:n,elm:e,children:[],data:a}):this._buffers=this._buffers.concat(a)},e.prototype.startTag=function(e){var t=e.name,n=this.getSchemaInfo(t);if(null==n)throw new Error("No schema entry found for "+t);if(e.unknownSize){var a=r.encodeTag(n,new i.Buffer(0),e.unknownSize);this._buffers=this._buffers.concat(a)}else{var o={tagId:n,elm:e,children:[],data:null};0<this._stack.length&&this._stack[this._stack.length-1].children.push(o),this._stack.push(o)}},e.prototype.endTag=function(e){e.name;var t=this._stack.pop();if(null==t)throw new Error("EBML structure is broken");if(t.elm.name!==e.name)throw new Error("EBML structure is broken");var n=t.children.reduce(function(e,t){if(null===t.data)throw new Error("EBML structure is broken");return e.concat(t.data)},[]),i=r.concat(n);t.data="m"===t.elm.type?r.encodeTag(t.tagId,i,t.elm.unknownSize):r.encodeTag(t.tagId,i),1>this._stack.length&&(this._buffers=this._buffers.concat(t.data))},e}();t.default=o},function(e){"use strict";var t={128:{name:"ChapterDisplay",level:4,type:"m",multiple:!0,minver:1,webm:!0,description:"Contains all possible strings to use for the chapter display."},131:{name:"TrackType",level:3,type:"u",mandatory:!0,minver:1,range:"1-254",description:"A set of track types coded on 8 bits (1: video, 2: audio, 3: complex, 0x10: logo, 0x11: subtitle, 0x12: buttons, 0x20: control)."},133:{name:"ChapString",cppname:"ChapterString",level:5,type:"8",mandatory:!0,minver:1,webm:!0,description:"Contains the string to use as the chapter atom."},134:{name:"CodecID",level:3,type:"s",mandatory:!0,minver:1,description:"An ID corresponding to the codec, see the codec page for more info."},136:{name:"FlagDefault",cppname:"TrackFlagDefault",level:3,type:"u",mandatory:!0,minver:1,default:1,range:"0-1",description:"Set if that track (audio, video or subs) SHOULD be active if no language found matches the user preference. (1 bit)"},137:{name:"ChapterTrackNumber",level:5,type:"u",mandatory:!0,multiple:!0,minver:1,webm:!1,range:"not 0",description:"UID of the Track to apply this chapter too. In the absense of a control track, choosing this chapter will select the listed Tracks and deselect unlisted tracks. Absense of this element indicates that the Chapter should be applied to any currently used Tracks."},145:{name:"ChapterTimeStart",level:4,type:"u",mandatory:!0,minver:1,webm:!0,description:"Timestamp of the start of Chapter (not scaled)."},146:{name:"ChapterTimeEnd",level:4,type:"u",minver:1,webm:!1,description:"Timestamp of the end of Chapter (timestamp excluded, not scaled)."},150:{name:"CueRefTime",level:5,type:"u",mandatory:!0,minver:2,webm:!1,description:"Timestamp of the referenced Block."},151:{name:"CueRefCluster",level:5,type:"u",mandatory:!0,webm:!1,description:"The Position of the Cluster containing the referenced Block."},152:{name:"ChapterFlagHidden",level:4,type:"u",mandatory:!0,minver:1,webm:!1,default:0,range:"0-1",description:"If a chapter is hidden (1), it should not be available to the user interface (but still to Control Tracks; see flag notes). (1 bit)"},16980:{name:"ContentCompAlgo",level:6,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"The compression algorithm used. Algorithms that have been specified so far are: 0 - zlib,   3 - Header Stripping"},16981:{name:"ContentCompSettings",level:6,type:"b",minver:1,webm:!1,description:"Settings that might be needed by the decompressor. For Header Stripping (ContentCompAlgo=3), the bytes that were removed from the beggining of each frames of the track."},17026:{name:"DocType",level:1,type:"s",mandatory:!0,default:"matroska",minver:1,description:"A string that describes the type of document that follows this EBML header. 'matroska' in our case or 'webm' for webm files."},17029:{name:"DocTypeReadVersion",level:1,type:"u",mandatory:!0,default:1,minver:1,description:"The minimum DocType version an interpreter has to support to read this file."},17030:{name:"EBMLVersion",level:1,type:"u",mandatory:!0,default:1,minver:1,description:"The version of EBML parser used to create the file."},17031:{name:"DocTypeVersion",level:1,type:"u",mandatory:!0,default:1,minver:1,description:"The version of DocType interpreter used to create the file."},17476:{name:"SegmentFamily",level:2,type:"b",multiple:!0,minver:1,webm:!1,bytesize:16,description:"A randomly generated unique ID that all segments related to each other must use (128 bits)."},17505:{name:"DateUTC",level:2,type:"d",minver:1,description:"Date of the origin of timestamp (value 0), i.e. production date."},17540:{name:"TagDefault",level:4,type:"u",mandatory:!0,minver:1,webm:!1,default:1,range:"0-1",description:"Indication to know if this is the default/original language to use for the given tag. (1 bit)"},17541:{name:"TagBinary",level:4,type:"b",minver:1,webm:!1,description:"The values of the Tag if it is binary. Note that this cannot be used in the same SimpleTag as TagString."},17543:{name:"TagString",level:4,type:"8",minver:1,webm:!1,description:"The value of the Element."},17545:{name:"Duration",level:2,type:"f",minver:1,range:"> 0",description:"Duration of the segment (based on TimecodeScale)."},17816:{name:"ChapterFlagEnabled",level:4,type:"u",mandatory:!0,minver:1,webm:!1,default:1,range:"0-1",description:"Specify wether the chapter is enabled. It can be enabled/disabled by a Control Track. When disabled, the movie should skip all the content between the TimeStart and TimeEnd of this chapter (see flag notes). (1 bit)"},18016:{name:"FileMimeType",level:3,type:"s",mandatory:!0,minver:1,webm:!1,description:"MIME type of the file."},18017:{name:"FileUsedStartTime",level:3,type:"u",divx:!0,description:"DivX font extension"},18018:{name:"FileUsedEndTime",level:3,type:"u",divx:!0,description:"DivX font extension"},18037:{name:"FileReferral",level:3,type:"b",webm:!1,description:"A binary value that a track/codec can refer to when the attachment is needed."},20529:{name:"ContentEncodingOrder",level:5,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"Tells when this modification was used during encoding/muxing starting with 0 and counting upwards. The decoder/demuxer has to start with the highest order number it finds and work its way down. This value has to be unique over all ContentEncodingOrder elements in the segment."},20530:{name:"ContentEncodingScope",level:5,type:"u",mandatory:!0,minver:1,webm:!1,default:1,range:"not 0",description:"A bit field that describes which elements have been modified in this way. Values (big endian) can be OR'ed. Possible values: 1 - all frame contents, 2 - the track's private data, 4 - the next ContentEncoding (next ContentEncodingOrder. Either the data inside ContentCompression and/or ContentEncryption)"},20531:{name:"ContentEncodingType",level:5,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"A value describing what kind of transformation has been done. Possible values: 0 - compression, 1 - encryption"},20532:{name:"ContentCompression",level:5,type:"m",minver:1,webm:!1,description:"Settings describing the compression used. Must be present if the value of ContentEncodingType is 0 and absent otherwise. Each block must be decompressable even if no previous block is available in order not to prevent seeking."},20533:{name:"ContentEncryption",level:5,type:"m",minver:1,webm:!1,description:"Settings describing the encryption used. Must be present if the value of ContentEncodingType is 1 and absent otherwise."},21368:{name:"CueBlockNumber",level:4,type:"u",minver:1,default:1,range:"not 0",description:"Number of the Block in the specified Cluster."},22100:{name:"ChapterStringUID",level:4,type:"8",mandatory:!1,minver:3,webm:!0,description:"A unique string ID to identify the Chapter. Use for WebVTT cue identifier storage."},22337:{name:"WritingApp",level:2,type:"8",mandatory:!0,minver:1,description:'Writing application ("mkvmerge-0.3.3").'},22612:{name:"SilentTracks",cppname:"ClusterSilentTracks",level:2,type:"m",minver:1,webm:!1,description:"The list of tracks that are not used in that part of the stream. It is useful when using overlay tracks on seeking. Then you should decide what track to use."},25152:{name:"ContentEncoding",level:4,type:"m",mandatory:!0,multiple:!0,minver:1,webm:!1,description:"Settings for one content encoding like compression or encryption."},25188:{name:"BitDepth",cppname:"AudioBitDepth",level:4,type:"u",minver:1,range:"not 0",description:"Bits per sample, mostly used for PCM."},25906:{name:"SignedElement",level:3,type:"b",multiple:!0,webm:!1,description:"An element ID whose data will be used to compute the signature."},26148:{name:"TrackTranslate",level:3,type:"m",multiple:!0,minver:1,webm:!1,description:"The track identification for the given Chapter Codec."},26897:{name:"ChapProcessCommand",cppname:"ChapterProcessCommand",level:5,type:"m",multiple:!0,minver:1,webm:!1,description:"Contains all the commands associated to the Atom."},26914:{name:"ChapProcessTime",cppname:"ChapterProcessTime",level:6,type:"u",mandatory:!0,minver:1,webm:!1,description:"Defines when the process command should be handled (0: during the whole chapter, 1: before starting playback, 2: after playback of the chapter)."},26916:{name:"ChapterTranslate",level:2,type:"m",multiple:!0,minver:1,webm:!1,description:"A tuple of corresponding ID used by chapter codecs to represent this segment."},26931:{name:"ChapProcessData",cppname:"ChapterProcessData",level:6,type:"b",mandatory:!0,minver:1,webm:!1,description:"Contains the command information. The data should be interpreted depending on the ChapProcessCodecID value. For ChapProcessCodecID = 1, the data correspond to the binary DVD cell pre/post commands."},26948:{name:"ChapProcess",cppname:"ChapterProcess",level:4,type:"m",multiple:!0,minver:1,webm:!1,description:"Contains all the commands associated to the Atom."},26965:{name:"ChapProcessCodecID",cppname:"ChapterProcessCodecID",level:5,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"Contains the type of the codec used for the processing. A value of 0 means native Matroska processing (to be defined), a value of 1 means the DVD command set is used. More codec IDs can be added later."},29555:{name:"Tag",level:2,type:"m",mandatory:!0,multiple:!0,minver:1,webm:!1,description:"Element containing elements specific to Tracks/Chapters."},29572:{name:"SegmentFilename",level:2,type:"8",minver:1,webm:!1,description:"A filename corresponding to this segment."},29766:{name:"AttachmentLink",cppname:"TrackAttachmentLink",level:3,type:"u",minver:1,webm:!1,range:"not 0",description:"The UID of an attachment that is used by this codec."},2459272:{name:"CodecName",level:3,type:"8",minver:1,description:"A human-readable string specifying the codec."},408125543:{name:"Segment",level:"0",type:"m",mandatory:!0,multiple:!0,minver:1,description:"This element contains all other top-level (level 1) elements. Typically a Matroska file is composed of 1 segment."},17530:{name:"TagLanguage",level:4,type:"s",mandatory:!0,minver:1,webm:!1,default:"und",description:"Specifies the language of the tag specified, in the Matroska languages form."},17827:{name:"TagName",level:4,type:"8",mandatory:!0,minver:1,webm:!1,description:"The name of the Tag that is going to be stored."},26568:{name:"SimpleTag",cppname:"TagSimple",level:3,recursive:"1",type:"m",mandatory:!0,multiple:!0,minver:1,webm:!1,description:"Contains general information about the target."},25542:{name:"TagAttachmentUID",level:4,type:"u",multiple:!0,minver:1,webm:!1,default:0,description:"A unique ID to identify the Attachment(s) the tags belong to. If the value is 0 at this level, the tags apply to all the attachments in the Segment."},25540:{name:"TagChapterUID",level:4,type:"u",multiple:!0,minver:1,webm:!1,default:0,description:"A unique ID to identify the Chapter(s) the tags belong to. If the value is 0 at this level, the tags apply to all chapters in the Segment."},25545:{name:"TagEditionUID",level:4,type:"u",multiple:!0,minver:1,webm:!1,default:0,description:"A unique ID to identify the EditionEntry(s) the tags belong to. If the value is 0 at this level, the tags apply to all editions in the Segment."},25541:{name:"TagTrackUID",level:4,type:"u",multiple:!0,minver:1,webm:!1,default:0,description:"A unique ID to identify the Track(s) the tags belong to. If the value is 0 at this level, the tags apply to all tracks in the Segment."},25546:{name:"TargetType",cppname:"TagTargetType",level:4,type:"s",minver:1,webm:!1,strong:"informational",description:'An  string that can be used to display the logical level of the target like "ALBUM", "TRACK", "MOVIE", "CHAPTER", etc (see TargetType).'},26826:{name:"TargetTypeValue",cppname:"TagTargetTypeValue",level:4,type:"u",minver:1,webm:!1,default:50,description:"A number to indicate the logical level of the target (see TargetType)."},25536:{name:"Targets",cppname:"TagTargets",level:3,type:"m",mandatory:!0,minver:1,webm:!1,description:"Contain all UIDs where the specified meta data apply. It is empty to describe everything in the segment."},307544935:{name:"Tags",level:1,type:"m",multiple:!0,minver:1,webm:!1,description:"Element containing elements specific to Tracks/Chapters. A list of valid tags can be found here."},17677:{name:"ChapProcessPrivate",cppname:"ChapterProcessPrivate",level:5,type:"b",minver:1,webm:!1,description:'Some optional data attached to the ChapProcessCodecID information. For ChapProcessCodecID = 1, it is the "DVD level" equivalent.'},17278:{name:"ChapCountry",cppname:"ChapterCountry",level:5,type:"s",multiple:!0,minver:1,webm:!1,description:"The countries corresponding to the string, same 2 octets as in Internet domains."},17276:{name:"ChapLanguage",cppname:"ChapterLanguage",level:5,type:"s",mandatory:!0,multiple:!0,minver:1,webm:!0,default:"eng",description:"The languages corresponding to the string, in the bibliographic ISO-639-2 form."},143:{name:"ChapterTrack",level:4,type:"m",minver:1,webm:!1,description:"List of tracks on which the chapter applies. If this element is not present, all tracks apply"},25539:{name:"ChapterPhysicalEquiv",level:4,type:"u",minver:1,webm:!1,description:'Specify the physical equivalent of this ChapterAtom like "DVD" (60) or "SIDE" (50), see complete list of values.'},28348:{name:"ChapterSegmentEditionUID",level:4,type:"u",minver:1,webm:!1,range:"not 0",description:"The EditionUID to play from the segment linked in ChapterSegmentUID."},28263:{name:"ChapterSegmentUID",level:4,type:"b",minver:1,webm:!1,range:">0",bytesize:16,description:"A segment to play in place of this chapter. Edition ChapterSegmentEditionUID should be used for this segment, otherwise no edition is used."},29636:{name:"ChapterUID",level:4,type:"u",mandatory:!0,minver:1,webm:!0,range:"not 0",description:"A unique ID to identify the Chapter."},182:{name:"ChapterAtom",level:3,recursive:"1",type:"m",mandatory:!0,multiple:!0,minver:1,webm:!0,description:"Contains the atom information to use as the chapter atom (apply to all tracks)."},17885:{name:"EditionFlagOrdered",level:3,type:"u",minver:1,webm:!1,default:0,range:"0-1",description:"Specify if the chapters can be defined multiple times and the order to play them is enforced. (1 bit)"},17883:{name:"EditionFlagDefault",level:3,type:"u",mandatory:!0,minver:1,webm:!1,default:0,range:"0-1",description:"If a flag is set (1) the edition should be used as the default one. (1 bit)"},17853:{name:"EditionFlagHidden",level:3,type:"u",mandatory:!0,minver:1,webm:!1,default:0,range:"0-1",description:"If an edition is hidden (1), it should not be available to the user interface (but still to Control Tracks; see flag notes). (1 bit)"},17852:{name:"EditionUID",level:3,type:"u",minver:1,webm:!1,range:"not 0",description:"A unique ID to identify the edition. It's useful for tagging an edition."},17849:{name:"EditionEntry",level:2,type:"m",mandatory:!0,multiple:!0,minver:1,webm:!0,description:"Contains all information about a segment edition."},272869232:{name:"Chapters",level:1,type:"m",minver:1,webm:!0,description:"A system to define basic menus and partition data. For more detailed information, look at the Chapters Explanation."},18094:{name:"FileUID",level:3,type:"u",mandatory:!0,minver:1,webm:!1,range:"not 0",description:"Unique ID representing the file, as random as possible."},18012:{name:"FileData",level:3,type:"b",mandatory:!0,minver:1,webm:!1,description:"The data of the file."},18030:{name:"FileName",level:3,type:"8",mandatory:!0,minver:1,webm:!1,description:"Filename of the attached file."},18046:{name:"FileDescription",level:3,type:"8",minver:1,webm:!1,description:"A human-friendly name for the attached file."},24999:{name:"AttachedFile",level:2,type:"m",mandatory:!0,multiple:!0,minver:1,webm:!1,description:"An attached file."},423732329:{name:"Attachments",level:1,type:"m",minver:1,webm:!1,description:"Contain attached files."},235:{name:"CueRefCodecState",level:5,type:"u",webm:!1,default:0,description:"The position of the Codec State corresponding to this referenced element. 0 means that the data is taken from the initial Track Entry."},21343:{name:"CueRefNumber",level:5,type:"u",webm:!1,default:1,range:"not 0",description:"Number of the referenced Block of Track X in the specified Cluster."},219:{name:"CueReference",level:4,type:"m",multiple:!0,minver:2,webm:!1,description:"The Clusters containing the required referenced Blocks."},234:{name:"CueCodecState",level:4,type:"u",minver:2,webm:!1,default:0,description:"The position of the Codec State corresponding to this Cue element. 0 means that the data is taken from the initial Track Entry."},178:{name:"CueDuration",level:4,type:"u",mandatory:!1,minver:4,webm:!1,description:"The duration of the block according to the segment time base. If missing the track's DefaultDuration does not apply and no duration information is available in terms of the cues."},240:{name:"CueRelativePosition",level:4,type:"u",mandatory:!1,minver:4,webm:!1,description:"The relative position of the referenced block inside the cluster with 0 being the first possible position for an element inside that cluster.",position:"clusterRelative"},241:{name:"CueClusterPosition",level:4,type:"u",mandatory:!0,minver:1,description:"The position of the Cluster containing the required Block.",position:"segment"},247:{name:"CueTrack",level:4,type:"u",mandatory:!0,minver:1,range:"not 0",description:"The track for which a position is given."},183:{name:"CueTrackPositions",level:3,type:"m",mandatory:!0,multiple:!0,minver:1,description:"Contain positions for different tracks corresponding to the timestamp."},179:{name:"CueTime",level:3,type:"u",mandatory:!0,minver:1,description:"Absolute timestamp according to the segment time base."},187:{name:"CuePoint",level:2,type:"m",mandatory:!0,multiple:!0,minver:1,description:"Contains all information relative to a seek point in the segment."},475249515:{name:"Cues",level:1,type:"m",minver:1,description:'A top-level element to speed seeking access. All entries are local to the segment. Should be mandatory for non "live" streams.'},18406:{name:"ContentSigHashAlgo",level:6,type:"u",minver:1,webm:!1,default:0,description:"The hash algorithm used for the signature. A value of '0' means that the contents have not been signed but only encrypted. Predefined values: 1 - SHA1-160 2 - MD5"},18405:{name:"ContentSigAlgo",level:6,type:"u",minver:1,webm:!1,default:0,description:"The algorithm used for the signature. A value of '0' means that the contents have not been signed but only encrypted. Predefined values: 1 - RSA"},18404:{name:"ContentSigKeyID",level:6,type:"b",minver:1,webm:!1,description:"This is the ID of the private key the data was signed with."},18403:{name:"ContentSignature",level:6,type:"b",minver:1,webm:!1,description:"A cryptographic signature of the contents."},18402:{name:"ContentEncKeyID",level:6,type:"b",minver:1,webm:!1,description:"For public key algorithms this is the ID of the public key the the data was encrypted with."},18401:{name:"ContentEncAlgo",level:6,type:"u",minver:1,webm:!1,default:0,description:"The encryption algorithm used. The value '0' means that the contents have not been encrypted but only signed. Predefined values: 1 - DES, 2 - 3DES, 3 - Twofish, 4 - Blowfish, 5 - AES"},28032:{name:"ContentEncodings",level:3,type:"m",minver:1,webm:!1,description:"Settings for several content encoding mechanisms like compression or encryption."},196:{name:"TrickMasterTrackSegmentUID",level:3,type:"b",divx:!0,bytesize:16,description:"DivX trick track extenstions"},199:{name:"TrickMasterTrackUID",level:3,type:"u",divx:!0,description:"DivX trick track extenstions"},198:{name:"TrickTrackFlag",level:3,type:"u",divx:!0,default:0,description:"DivX trick track extenstions"},193:{name:"TrickTrackSegmentUID",level:3,type:"b",divx:!0,bytesize:16,description:"DivX trick track extenstions"},192:{name:"TrickTrackUID",level:3,type:"u",divx:!0,description:"DivX trick track extenstions"},237:{name:"TrackJoinUID",level:5,type:"u",mandatory:!0,multiple:!0,minver:3,webm:!1,range:"not 0",description:"The trackUID number of a track whose blocks are used to create this virtual track."},233:{name:"TrackJoinBlocks",level:4,type:"m",minver:3,webm:!1,description:"Contains the list of all tracks whose Blocks need to be combined to create this virtual track"},230:{name:"TrackPlaneType",level:6,type:"u",mandatory:!0,minver:3,webm:!1,description:"The kind of plane this track corresponds to (0: left eye, 1: right eye, 2: background)."},229:{name:"TrackPlaneUID",level:6,type:"u",mandatory:!0,minver:3,webm:!1,range:"not 0",description:"The trackUID number of the track representing the plane."},228:{name:"TrackPlane",level:5,type:"m",mandatory:!0,multiple:!0,minver:3,webm:!1,description:"Contains a video plane track that need to be combined to create this 3D track"},227:{name:"TrackCombinePlanes",level:4,type:"m",minver:3,webm:!1,description:"Contains the list of all video plane tracks that need to be combined to create this 3D track"},226:{name:"TrackOperation",level:3,type:"m",minver:3,webm:!1,description:"Operation that needs to be applied on tracks to create this virtual track. For more details look at the Specification Notes on the subject."},32123:{name:"ChannelPositions",cppname:"AudioPosition",level:4,type:"b",webm:!1,description:"Table of horizontal angles for each successive channel, see appendix."},159:{name:"Channels",cppname:"AudioChannels",level:4,type:"u",mandatory:!0,minver:1,default:1,range:"not 0",description:"Numbers of channels in the track."},30901:{name:"OutputSamplingFrequency",cppname:"AudioOutputSamplingFreq",level:4,type:"f",minver:1,default:"Sampling Frequency",range:"> 0",description:"Real output sampling frequency in Hz (used for SBR techniques)."},181:{name:"SamplingFrequency",cppname:"AudioSamplingFreq",level:4,type:"f",mandatory:!0,minver:1,default:8e3,range:"> 0",description:"Sampling frequency in Hz."},225:{name:"Audio",cppname:"TrackAudio",level:3,type:"m",minver:1,description:"Audio settings."},2327523:{name:"FrameRate",cppname:"VideoFrameRate",level:4,type:"f",range:"> 0",strong:"Informational",description:"Number of frames per second.  only."},3126563:{name:"GammaValue",cppname:"VideoGamma",level:4,type:"f",webm:!1,range:"> 0",description:"Gamma Value."},3061028:{name:"ColourSpace",cppname:"VideoColourSpace",level:4,type:"b",minver:1,webm:!1,bytesize:4,description:"Same value as in AVI (32 bits)."},21683:{name:"AspectRatioType",cppname:"VideoAspectRatio",level:4,type:"u",minver:1,default:0,description:"Specify the possible modifications to the aspect ratio (0: free resizing, 1: keep aspect ratio, 2: fixed)."},21682:{name:"DisplayUnit",cppname:"VideoDisplayUnit",level:4,type:"u",minver:1,default:0,description:"How DisplayWidth & DisplayHeight should be interpreted (0: pixels, 1: centimeters, 2: inches, 3: Display Aspect Ratio)."},21690:{name:"DisplayHeight",cppname:"VideoDisplayHeight",level:4,type:"u",minver:1,default:"PixelHeight",range:"not 0",description:"Height of the video frames to display. The default value is only valid when DisplayUnit is 0."},21680:{name:"DisplayWidth",cppname:"VideoDisplayWidth",level:4,type:"u",minver:1,default:"PixelWidth",range:"not 0",description:"Width of the video frames to display. The default value is only valid when DisplayUnit is 0."},21725:{name:"PixelCropRight",cppname:"VideoPixelCropRight",level:4,type:"u",minver:1,default:0,description:"The number of video pixels to remove on the right of the image."},21708:{name:"PixelCropLeft",cppname:"VideoPixelCropLeft",level:4,type:"u",minver:1,default:0,description:"The number of video pixels to remove on the left of the image."},21691:{name:"PixelCropTop",cppname:"VideoPixelCropTop",level:4,type:"u",minver:1,default:0,description:"The number of video pixels to remove at the top of the image."},21674:{name:"PixelCropBottom",cppname:"VideoPixelCropBottom",level:4,type:"u",minver:1,default:0,description:"The number of video pixels to remove at the bottom of the image (for HDTV content)."},186:{name:"PixelHeight",cppname:"VideoPixelHeight",level:4,type:"u",mandatory:!0,minver:1,range:"not 0",description:"Height of the encoded video frames in pixels."},176:{name:"PixelWidth",cppname:"VideoPixelWidth",level:4,type:"u",mandatory:!0,minver:1,range:"not 0",description:"Width of the encoded video frames in pixels."},21433:{name:"OldStereoMode",level:4,type:"u",maxver:"0",webm:!1,divx:!1,description:"DEPRECATED, DO NOT USE. Bogus StereoMode value used in old versions of libmatroska. (0: mono, 1: right eye, 2: left eye, 3: both eyes)."},21440:{name:"AlphaMode",cppname:"VideoAlphaMode",level:4,type:"u",minver:3,webm:!0,default:0,description:"Alpha Video Mode. Presence of this element indicates that the BlockAdditional element could contain Alpha data."},21432:{name:"StereoMode",cppname:"VideoStereoMode",level:4,type:"u",minver:3,webm:!0,default:0,description:"Stereo-3D video mode (0: mono, 1: side by side (left eye is first), 2: top-bottom (right eye is first), 3: top-bottom (left eye is first), 4: checkboard (right is first), 5: checkboard (left is first), 6: row interleaved (right is first), 7: row interleaved (left is first), 8: column interleaved (right is first), 9: column interleaved (left is first), 10: anaglyph (cyan/red), 11: side by side (right eye is first), 12: anaglyph (green/magenta), 13 both eyes laced in one Block (left eye is first), 14 both eyes laced in one Block (right eye is first)) . There are some more details on 3D support in the Specification Notes."},154:{name:"FlagInterlaced",cppname:"VideoFlagInterlaced",level:4,type:"u",mandatory:!0,minver:2,webm:!0,default:0,range:"0-1",description:"Set if the video is interlaced. (1 bit)"},224:{name:"Video",cppname:"TrackVideo",level:3,type:"m",minver:1,description:"Video settings."},26277:{name:"TrackTranslateTrackID",level:4,type:"b",mandatory:!0,minver:1,webm:!1,description:"The binary value used to represent this track in the chapter codec data. The format depends on the ChapProcessCodecID used."},26303:{name:"TrackTranslateCodec",level:4,type:"u",mandatory:!0,minver:1,webm:!1,description:"The chapter codec using this ID (0: Matroska Script, 1: DVD-menu)."},26364:{name:"TrackTranslateEditionUID",level:4,type:"u",multiple:!0,minver:1,webm:!1,description:"Specify an edition UID on which this translation applies. When not specified, it means for all editions found in the segment."},22203:{name:"SeekPreRoll",level:3,type:"u",mandatory:!0,multiple:!1,default:0,minver:4,webm:!0,description:"After a discontinuity, SeekPreRoll is the duration in nanoseconds of the data the decoder must decode before the decoded data is valid."},22186:{name:"CodecDelay",level:3,type:"u",multiple:!1,default:0,minver:4,webm:!0,description:"CodecDelay is The codec-built-in delay in nanoseconds. This value must be subtracted from each block timestamp in order to get the actual timestamp. The value should be small so the muxing of tracks with the same actual timestamp are in the same Cluster."},28587:{name:"TrackOverlay",level:3,type:"u",multiple:!0,minver:1,webm:!1,description:"Specify that this track is an overlay track for the Track specified (in the u-integer). That means when this track has a gap (see SilentTracks) the overlay track should be used instead. The order of multiple TrackOverlay matters, the first one is the one that should be used. If not found it should be the second, etc."},170:{name:"CodecDecodeAll",level:3,type:"u",mandatory:!0,minver:2,webm:!1,default:1,range:"0-1",description:"The codec can decode potentially damaged data (1 bit)."},2536000:{name:"CodecDownloadURL",level:3,type:"s",multiple:!0,webm:!1,description:"A URL to download about the codec used."},3883072:{name:"CodecInfoURL",level:3,type:"s",multiple:!0,webm:!1,description:"A URL to find information about the codec used."},3839639:{name:"CodecSettings",level:3,type:"8",webm:!1,description:"A string describing the encoding setting used."},25506:{name:"CodecPrivate",level:3,type:"b",minver:1,description:"Private data only known to the codec."},2274716:{name:"Language",cppname:"TrackLanguage",level:3,type:"s",minver:1,default:"eng",description:"Specifies the language of the track in the Matroska languages form."},21358:{name:"Name",cppname:"TrackName",level:3,type:"8",minver:1,description:"A human-readable track name."},21998:{name:"MaxBlockAdditionID",level:3,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"The maximum value of BlockAdditions for this track."},21375:{name:"TrackOffset",level:3,type:"i",webm:!1,default:0,description:"A value to add to the Block's Timestamp. This can be used to adjust the playback offset of a track."},2306383:{name:"TrackTimecodeScale",level:3,type:"f",mandatory:!0,minver:1,maxver:"3",webm:!1,default:1,range:"> 0",description:"DEPRECATED, DO NOT USE. The scale to apply on this track to work at normal speed in relation with other tracks (mostly used to adjust video speed when the audio length differs)."},2313850:{name:"DefaultDecodedFieldDuration",cppname:"TrackDefaultDecodedFieldDuration",level:3,type:"u",minver:4,range:"not 0",description:"The period in nanoseconds (not scaled by TimcodeScale)\nbetween two successive fields at the output of the decoding process (see the notes)"},2352003:{name:"DefaultDuration",cppname:"TrackDefaultDuration",level:3,type:"u",minver:1,range:"not 0",description:"Number of nanoseconds (not scaled via TimecodeScale) per frame ('frame' in the Matroska sense -- one element put into a (Simple)Block)."},28152:{name:"MaxCache",cppname:"TrackMaxCache",level:3,type:"u",minver:1,webm:!1,description:"The maximum cache size required to store referenced frames in and the current frame. 0 means no cache is needed."},28135:{name:"MinCache",cppname:"TrackMinCache",level:3,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"The minimum number of frames a player should be able to cache during playback. If set to 0, the reference pseudo-cache system is not used."},156:{name:"FlagLacing",cppname:"TrackFlagLacing",level:3,type:"u",mandatory:!0,minver:1,default:1,range:"0-1",description:"Set if the track may contain blocks using lacing. (1 bit)"},21930:{name:"FlagForced",cppname:"TrackFlagForced",level:3,type:"u",mandatory:!0,minver:1,default:0,range:"0-1",description:"Set if that track MUST be active during playback. There can be many forced track for a kind (audio, video or subs), the player should select the one which language matches the user preference or the default + forced track. Overlay MAY happen between a forced and non-forced track of the same kind. (1 bit)"},185:{name:"FlagEnabled",cppname:"TrackFlagEnabled",level:3,type:"u",mandatory:!0,minver:2,webm:!0,default:1,range:"0-1",description:"Set if the track is usable. (1 bit)"},29637:{name:"TrackUID",level:3,type:"u",mandatory:!0,minver:1,range:"not 0",description:"A unique ID to identify the Track. This should be kept the same when making a direct stream copy of the Track to another file."},215:{name:"TrackNumber",level:3,type:"u",mandatory:!0,minver:1,range:"not 0",description:"The track number as used in the Block Header (using more than 127 tracks is not encouraged, though the design allows an unlimited number)."},174:{name:"TrackEntry",level:2,type:"m",mandatory:!0,multiple:!0,minver:1,description:"Describes a track with all elements."},374648427:{name:"Tracks",level:1,type:"m",multiple:!0,minver:1,description:"A top-level block of information with many tracks described."},175:{name:"EncryptedBlock",level:2,type:"b",multiple:!0,webm:!1,description:"Similar to EncryptedBlock Structure)"},202:{name:"ReferenceTimeCode",level:4,type:"u",multiple:!1,mandatory:!0,minver:0,webm:!1,divx:!0,description:"DivX trick track extenstions"},201:{name:"ReferenceOffset",level:4,type:"u",multiple:!1,mandatory:!0,minver:0,webm:!1,divx:!0,description:"DivX trick track extenstions"},200:{name:"ReferenceFrame",level:3,type:"m",multiple:!1,minver:0,webm:!1,divx:!0,description:"DivX trick track extenstions"},207:{name:"SliceDuration",level:5,type:"u",default:0,description:"The (scaled) duration to apply to the element."},206:{name:"Delay",cppname:"SliceDelay",level:5,type:"u",default:0,description:"The (scaled) delay to apply to the element."},203:{name:"BlockAdditionID",cppname:"SliceBlockAddID",level:5,type:"u",default:0,description:"The ID of the BlockAdditional element (0 is the main Block)."},205:{name:"FrameNumber",cppname:"SliceFrameNumber",level:5,type:"u",default:0,description:"The number of the frame to generate from this lace with this delay (allow you to generate many frames from the same Block/Frame)."},204:{name:"LaceNumber",cppname:"SliceLaceNumber",level:5,type:"u",minver:1,default:0,divx:!1,description:"The reverse number of the frame in the lace (0 is the last frame, 1 is the next to last, etc). While there are a few files in the wild with this element, it is no longer in use and has been deprecated. Being able to interpret this element is not required for playback."},232:{name:"TimeSlice",level:4,type:"m",multiple:!0,minver:1,divx:!1,description:"Contains extra time information about the data contained in the Block. While there are a few files in the wild with this element, it is no longer in use and has been deprecated. Being able to interpret this element is not required for playback."},142:{name:"Slices",level:3,type:"m",minver:1,divx:!1,description:"Contains slices description."},30114:{name:"DiscardPadding",level:3,type:"i",minver:4,webm:!0,description:"Duration in nanoseconds of the silent data added to the Block (padding at the end of the Block for positive value, at the beginning of the Block for negative value). The duration of DiscardPadding is not calculated in the duration of the TrackEntry and should be discarded during playback."},164:{name:"CodecState",level:3,type:"b",minver:2,webm:!1,description:"The new codec state to use. Data interpretation is private to the codec. This information should always be referenced by a seek entry."},253:{name:"ReferenceVirtual",level:3,type:"i",webm:!1,description:"Relative position of the data that should be in position of the virtual block."},251:{name:"ReferenceBlock",level:3,type:"i",multiple:!0,minver:1,description:"Timestamp of another frame used as a reference (ie: B or P frame). The timestamp is relative to the block it's attached to."},250:{name:"ReferencePriority",cppname:"FlagReferenced",level:3,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"This frame is referenced and has the specified cache priority. In cache only a frame of the same or higher priority can replace this frame. A value of 0 means the frame is not referenced."},155:{name:"BlockDuration",level:3,type:"u",minver:1,default:"TrackDuration",description:'The duration of the Block (based on TimecodeScale). This element is mandatory when DefaultDuration is set for the track (but can be omitted as other default values). When not written and with no DefaultDuration, the value is assumed to be the difference between the timestamp of this Block and the timestamp of the next Block in "display" order (not coding order). This element can be useful at the end of a Track (as there is not other Block available), or when there is a break in a track like for subtitle tracks. When set to 0 that means the frame is not a keyframe.'},165:{name:"BlockAdditional",level:5,type:"b",mandatory:!0,minver:1,webm:!1,description:"Interpreted by the codec as it wishes (using the BlockAddID)."},238:{name:"BlockAddID",level:5,type:"u",mandatory:!0,minver:1,webm:!1,default:1,range:"not 0",description:"An ID to identify the BlockAdditional level."},166:{name:"BlockMore",level:4,type:"m",mandatory:!0,multiple:!0,minver:1,webm:!1,description:"Contain the BlockAdditional and some parameters."},30113:{name:"BlockAdditions",level:3,type:"m",minver:1,webm:!1,description:"Contain additional blocks to complete the main one. An EBML parser that has no knowledge of the Block structure could still see and use/skip these data."},162:{name:"BlockVirtual",level:3,type:"b",webm:!1,description:"A Block with no data. It must be stored in the stream at the place the real Block should be in display order. (see Block Virtual)"},161:{name:"Block",level:3,type:"b",mandatory:!0,minver:1,description:"Block containing the actual data to be rendered and a timestamp relative to the Cluster Timecode. (see Block Structure)"},160:{name:"BlockGroup",level:2,type:"m",multiple:!0,minver:1,description:"Basic container of information containing a single Block or BlockVirtual, and information specific to that Block/VirtualBlock."},163:{name:"SimpleBlock",level:2,type:"b",multiple:!0,minver:2,webm:!0,divx:!0,description:"Similar to SimpleBlock Structure"},171:{name:"PrevSize",cppname:"ClusterPrevSize",level:2,type:"u",minver:1,description:"Size of the previous Cluster, in octets. Can be useful for backward playing.",position:"prevCluster"},167:{name:"Position",cppname:"ClusterPosition",level:2,type:"u",minver:1,webm:!1,description:"The Position of the Cluster in the segment (0 in live broadcast streams). It might help to resynchronise offset on damaged streams.",position:"segment"},22743:{name:"SilentTrackNumber",cppname:"ClusterSilentTrackNumber",level:3,type:"u",multiple:!0,minver:1,webm:!1,description:"One of the track number that are not used from now on in the stream. It could change later if not specified as silent in a further Cluster."},231:{name:"Timecode",cppname:"ClusterTimecode",level:2,type:"u",mandatory:!0,minver:1,description:"Absolute timestamp of the cluster (based on TimecodeScale)."},524531317:{name:"Cluster",level:1,type:"m",multiple:!0,minver:1,description:"The lower level element containing the (monolithic) Block structure."},19840:{name:"MuxingApp",level:2,type:"8",mandatory:!0,minver:1,description:'Muxing application or library ("libmatroska-0.4.3").'},31657:{name:"Title",level:2,type:"8",minver:1,webm:!1,description:"General name of the segment."},2807730:{name:"TimecodeScaleDenominator",level:2,type:"u",mandatory:!0,minver:4,default:"1000000000",description:"Timestamp scale numerator, see TimecodeScale."},2807729:{name:"TimecodeScale",level:2,type:"u",mandatory:!0,minver:1,default:"1000000",description:"Timestamp scale in nanoseconds (1.000.000 means all timestamps in the segment are expressed in milliseconds)."},27045:{name:"ChapterTranslateID",level:3,type:"b",mandatory:!0,minver:1,webm:!1,description:"The binary value used to represent this segment in the chapter codec data. The format depends on the ChapProcessCodecID used."},27071:{name:"ChapterTranslateCodec",level:3,type:"u",mandatory:!0,minver:1,webm:!1,description:"The chapter codec using this ID (0: Matroska Script, 1: DVD-menu)."},27132:{name:"ChapterTranslateEditionUID",level:3,type:"u",multiple:!0,minver:1,webm:!1,description:"Specify an edition UID on which this correspondance applies. When not specified, it means for all editions found in the segment."},4096955:{name:"NextFilename",level:2,type:"8",minver:1,webm:!1,description:"An escaped filename corresponding to the next segment."},4110627:{name:"NextUID",level:2,type:"b",minver:1,webm:!1,bytesize:16,description:"A unique ID to identify the next chained segment (128 bits)."},3965867:{name:"PrevFilename",level:2,type:"8",minver:1,webm:!1,description:"An escaped filename corresponding to the previous segment."},3979555:{name:"PrevUID",level:2,type:"b",minver:1,webm:!1,bytesize:16,description:"A unique ID to identify the previous chained segment (128 bits)."},29604:{name:"SegmentUID",level:2,type:"b",minver:1,webm:!1,range:"not 0",bytesize:16,description:"A randomly generated unique ID to identify the current segment between many others (128 bits)."},357149030:{name:"Info",level:1,type:"m",mandatory:!0,multiple:!0,minver:1,description:"Contains miscellaneous general information and statistics on the file."},21420:{name:"SeekPosition",level:3,type:"u",mandatory:!0,minver:1,description:"The position of the element in the segment in octets (0 = first level 1 element).",position:"segment"},21419:{name:"SeekID",level:3,type:"b",mandatory:!0,minver:1,description:"The binary ID corresponding to the element name.",type2:"ebmlID"},19899:{name:"Seek",cppname:"SeekPoint",level:2,type:"m",mandatory:!0,multiple:!0,minver:1,description:"Contains a single seek entry to an EBML element."},290298740:{name:"SeekHead",cppname:"SeekHeader",level:1,type:"m",multiple:!0,minver:1,description:"Contains the position of other level 1 elements."},32379:{name:"SignatureElementList",level:2,type:"m",multiple:!0,webm:!1,i:"Cluster|Block|BlockAdditional",description:"A list consists of a number of consecutive elements that represent one case where data is used in signature. Ex:  means that the BlockAdditional of all Blocks in all Clusters is used for encryption."},32347:{name:"SignatureElements",level:1,type:"m",webm:!1,description:"Contains elements that will be used to compute the signature."},32437:{name:"Signature",level:1,type:"b",webm:!1,description:"The signature of the data (until a new."},32421:{name:"SignaturePublicKey",level:1,type:"b",webm:!1,description:"The public key to use with the algorithm (in the case of a PKI-based signature)."},32410:{name:"SignatureHash",level:1,type:"u",webm:!1,description:"Hash algorithm used (1=SHA1-160, 2=MD5)."},32394:{name:"SignatureAlgo",level:1,type:"u",webm:!1,description:"Signature algorithm used (1=RSA, 2=elliptic)."},458458727:{name:"SignatureSlot",level:-1,type:"m",multiple:!0,webm:!1,description:"Contain signature of some (coming) elements in the stream."},191:{name:"CRC-32",level:-1,type:"b",minver:1,webm:!1,description:"The CRC is computed on all the data of the Master element it's in. The CRC element should be the first in it's parent master for easier reading. All level 1 elements should include a CRC-32. The CRC in use is the IEEE CRC32 Little Endian",crc:!0},236:{name:"Void",level:-1,type:"b",minver:1,description:"Used to void damaged data, to avoid unexpected behaviors when using damaged data. The content is discarded. Also used to reserve space in a sub-element for later use."},17139:{name:"EBMLMaxSizeLength",level:1,type:"u",mandatory:!0,default:8,minver:1,description:"The maximum length of the sizes you'll find in this file (8 or less in Matroska). This does not override the element size indicated at the beginning of an element. Elements that have an indicated size which is larger than what is allowed by EBMLMaxSizeLength shall be considered invalid."},17138:{name:"EBMLMaxIDLength",level:1,type:"u",mandatory:!0,default:4,minver:1,description:"The maximum length of the IDs you'll find in this file (4 or less in Matroska)."},17143:{name:"EBMLReadVersion",level:1,type:"u",mandatory:!0,default:1,minver:1,description:"The minimum EBML version a parser has to support to read this file."},440786851:{name:"EBML",level:"0",type:"m",mandatory:!0,multiple:!0,minver:1,description:"Set the EBML characteristics of the data to follow. Each EBML document has to start with this."}},n={};for(var r in t){n[t[r].name.replace("-","_")]=parseInt(r,10)}e.exports={byEbmlID:t,byName:n}},function(e,t,n){"use strict";function r(e,t,n,r,i){var a=c.writeRtpDescription(e.kind,t);if(a+=c.writeIceParameters(e.iceGatherer.getLocalParameters()),a+=c.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":i||"active"),a+="a=mid:"+e.mid+"\r\n",a+=e.rtpSender&&e.rtpReceiver?"a=sendrecv\r\n":e.rtpSender?"a=sendonly\r\n":e.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",e.rtpSender){var o=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=o;var s="msid:"+(r?r.id:"-")+" "+o+"\r\n";a+="a="+s,a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+s,e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+s,a+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+c.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+c.localCName+"\r\n"),a}function i(e,t){var n={codecs:[],headerExtensions:[],fecMechanisms:[]},r=function(e,t){e=parseInt(e,10);for(var n=0;n<t.length;n++)if(t[n].payloadType===e||t[n].preferredPayloadType===e)return t[n]},i=function(e,t,n,i){var a=r(e.parameters.apt,n),o=r(t.parameters.apt,i);return a&&o&&a.name.toLowerCase()===o.name.toLowerCase()};return e.codecs.forEach(function(r){for(var a,o=0;o<t.codecs.length;o++)if(a=t.codecs[o],r.name.toLowerCase()===a.name.toLowerCase()&&r.clockRate===a.clockRate){if("rtx"===r.name.toLowerCase()&&r.parameters&&a.parameters.apt&&!i(r,a,e.codecs,t.codecs))continue;(a=JSON.parse(JSON.stringify(a))).numChannels=Math.min(r.numChannels,a.numChannels),n.codecs.push(a),a.rtcpFeedback=a.rtcpFeedback.filter(function(e){for(var t=0;t<r.rtcpFeedback.length;t++)if(r.rtcpFeedback[t].type===e.type&&r.rtcpFeedback[t].parameter===e.parameter)return!0;return!1});break}}),e.headerExtensions.forEach(function(e){for(var r,i=0;i<t.headerExtensions.length;i++)if(r=t.headerExtensions[i],e.uri===r.uri){n.headerExtensions.push(r);break}}),n}function a(e,t,n){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(n)}function o(e,t){var n=e.getRemoteCandidates().find(function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type});return n||e.addRemoteCandidate(t),!n}function s(e,t){var n=new Error(t);return n.name=e,n.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],n}var c=n(7);e.exports=function(e,t){function n(t,n){n.addTrack(t),n.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function l(t,n){n.removeTrack(t),n.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}function d(t,n,r,i){var a=new Event("track");a.track=n,a.receiver=r,a.transceiver={receiver:r},a.streams=i,e.setTimeout(function(){t._dispatchEvent("track",a)})}var u=function(n){var r=this,i=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){r[e]=i[e].bind(i)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",n=JSON.parse(JSON.stringify(n||{})),this.usingBundle="max-bundle"===n.bundlePolicy,"negotiate"===n.rtcpMuxPolicy)throw s("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(n.rtcpMuxPolicy||(n.rtcpMuxPolicy="require"),n.iceTransportPolicy){case"all":case"relay":break;default:n.iceTransportPolicy="all"}switch(n.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:n.bundlePolicy="balanced"}if(n.iceServers=function(e,t){var n=!1;return(e=JSON.parse(JSON.stringify(e))).filter(function(e){if(e&&(e.urls||e.url)){var r=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var i="string"==typeof r;return i&&(r=[r]),r=r.filter(function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||n?0===e.indexOf("stun:")&&14393<=t&&-1===e.indexOf("?transport=udp"):(n=!0,!0)}),delete e.url,e.urls=i?r[0]:r,!!r.length}})}(n.iceServers||[],t),this._iceGatherers=[],n.iceCandidatePoolSize)for(var a=n.iceCandidatePoolSize;0<a;a--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:n.iceServers,gatherPolicy:n.iceTransportPolicy}));else n.iceCandidatePoolSize=0;this._config=n,this.transceivers=[],this._sdpSessionId=c.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(u.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(u.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),u.prototype.onicecandidate=null,u.prototype.onaddstream=null,u.prototype.ontrack=null,u.prototype.onremovestream=null,u.prototype.onsignalingstatechange=null,u.prototype.oniceconnectionstatechange=null,u.prototype.onconnectionstatechange=null,u.prototype.onicegatheringstatechange=null,u.prototype.onnegotiationneeded=null,u.prototype.ondatachannel=null,u.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},u.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},u.prototype.getConfiguration=function(){return this._config},u.prototype.getLocalStreams=function(){return this.localStreams},u.prototype.getRemoteStreams=function(){return this.remoteStreams},u.prototype._createTransceiver=function(e,t){var n=0<this.transceivers.length,r={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&n)r.iceTransport=this.transceivers[0].iceTransport,r.dtlsTransport=this.transceivers[0].dtlsTransport;else{var i=this._createIceAndDtlsTransports();r.iceTransport=i.iceTransport,r.dtlsTransport=i.dtlsTransport}return t||this.transceivers.push(r),r},u.prototype.addTrack=function(t,n){if(this._isClosed)throw s("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");if(this.transceivers.find(function(e){return e.track===t}))throw s("InvalidAccessError","Track already exists.");for(var r,i=0;i<this.transceivers.length;i++)this.transceivers[i].track||this.transceivers[i].kind!==t.kind||(r=this.transceivers[i]);return r||(r=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(n)&&this.localStreams.push(n),r.track=t,r.stream=n,r.rtpSender=new e.RTCRtpSender(t,r.dtlsTransport),r.rtpSender},u.prototype.addStream=function(e){var n=this;if(15025<=t)e.getTracks().forEach(function(t){n.addTrack(t,e)});else{var r=e.clone();e.getTracks().forEach(function(e,t){var n=r.getTracks()[t];e.addEventListener("enabled",function(e){n.enabled=e.enabled})}),r.getTracks().forEach(function(e){n.addTrack(e,r)})}},u.prototype.removeTrack=function(t){if(this._isClosed)throw s("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var n=this.transceivers.find(function(e){return e.rtpSender===t});if(!n)throw s("InvalidAccessError","Sender was not created by this connection.");var r=n.stream;n.rtpSender.stop(),n.rtpSender=null,n.track=null,n.stream=null,-1===this.transceivers.map(function(e){return e.stream}).indexOf(r)&&-1<this.localStreams.indexOf(r)&&this.localStreams.splice(this.localStreams.indexOf(r),1),this._maybeFireNegotiationNeeded()},u.prototype.removeStream=function(e){var t=this;e.getTracks().forEach(function(e){var n=t.getSenders().find(function(t){return t.track===e});n&&t.removeTrack(n)})},u.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},u.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},u.prototype._createIceGatherer=function(t,n){var r=this;if(n&&0<t)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var i=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(i,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var n=!e.candidate||0===Object.keys(e.candidate).length;i.state=n?"completed":"gathering",null!==r.transceivers[t].bufferedCandidateEvents&&r.transceivers[t].bufferedCandidateEvents.push(e)},i.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),i},u.prototype._gather=function(t,n){var r=this,i=this.transceivers[n].iceGatherer;if(!i.onlocalcandidate){var a=this.transceivers[n].bufferedCandidateEvents;this.transceivers[n].bufferedCandidateEvents=null,i.removeEventListener("localcandidate",this.transceivers[n].bufferCandidates),i.onlocalcandidate=function(e){if(!(r.usingBundle&&0<n)){var a=new Event("icecandidate");a.candidate={sdpMid:t,sdpMLineIndex:n};var o=e.candidate,s=!o||0===Object.keys(o).length;if(s)("new"===i.state||"gathering"===i.state)&&(i.state="completed");else{"new"===i.state&&(i.state="gathering"),o.component=1,o.ufrag=i.getLocalParameters().usernameFragment;var l=c.writeCandidate(o);a.candidate=Object.assign(a.candidate,c.parseCandidate(l)),a.candidate.candidate=l,a.candidate.toJSON=function(){return{candidate:a.candidate.candidate,sdpMid:a.candidate.sdpMid,sdpMLineIndex:a.candidate.sdpMLineIndex,usernameFragment:a.candidate.usernameFragment}}}var d=c.getMediaSections(r._localDescription.sdp);d[a.candidate.sdpMLineIndex]+=s?"a=end-of-candidates\r\n":"a="+a.candidate.candidate+"\r\n",r._localDescription.sdp=c.getDescription(r._localDescription.sdp)+d.join("");var u=r.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});"gathering"!==r.iceGatheringState&&(r.iceGatheringState="gathering",r._emitGatheringStateChange()),s||r._dispatchEvent("icecandidate",a),u&&(r._dispatchEvent("icecandidate",new Event("icecandidate")),r.iceGatheringState="complete",r._emitGatheringStateChange())}},e.setTimeout(function(){a.forEach(function(e){i.onlocalcandidate(e)})},0)}},u.prototype._createIceAndDtlsTransports=function(){var t=this,n=new e.RTCIceTransport(null);n.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var r=new e.RTCDtlsTransport(n);return r.ondtlsstatechange=function(){t._updateConnectionState()},r.onerror=function(){Object.defineProperty(r,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:n,dtlsTransport:r}},u.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var n=this.transceivers[e].iceTransport;n&&(delete n.onicestatechange,delete this.transceivers[e].iceTransport);var r=this.transceivers[e].dtlsTransport;r&&(delete r.ondtlsstatechange,delete r.onerror,delete this.transceivers[e].dtlsTransport)},u.prototype._transceive=function(e,n,r){var a=i(e.localCapabilities,e.remoteCapabilities);n&&e.rtpSender&&(a.encodings=e.sendEncodingParameters,a.rtcp={cname:c.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(a.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(a)),r&&e.rtpReceiver&&0<a.codecs.length&&("video"===e.kind&&e.recvEncodingParameters&&15019>t&&e.recvEncodingParameters.forEach(function(e){delete e.rtx}),a.encodings=e.recvEncodingParameters.length?e.recvEncodingParameters:[{}],a.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(a.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(a.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(a))},u.prototype.setLocalDescription=function(e){var t,n,r=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(s("TypeError",'Unsupported type "'+e.type+'"'));if(!a("setLocalDescription",e.type,r.signalingState)||r._isClosed)return Promise.reject(s("InvalidStateError","Can not set local "+e.type+" in state "+r.signalingState));if("offer"===e.type)t=c.splitSections(e.sdp),n=t.shift(),t.forEach(function(e,t){var n=c.parseRtpParameters(e);r.transceivers[t].localCapabilities=n}),r.transceivers.forEach(function(e,t){r._gather(e.mid,t)});else if("answer"===e.type){t=c.splitSections(r._remoteDescription.sdp),n=t.shift();var o=0<c.matchPrefix(n,"a=ice-lite").length;t.forEach(function(e,t){var a=r.transceivers[t],s=a.iceGatherer,l=a.iceTransport,d=a.dtlsTransport,u=a.localCapabilities,h=a.remoteCapabilities;if(!(c.isRejected(e)&&0===c.matchPrefix(e,"a=bundle-only").length)&&!a.rejected){var f=c.getIceParameters(e,n),p=c.getDtlsParameters(e,n);o&&(p.role="server"),r.usingBundle&&0!==t||(r._gather(a.mid,t),"new"===l.state&&l.start(s,f,o?"controlling":"controlled"),"new"===d.state&&d.start(p));var m=i(u,h);r._transceive(a,0<m.codecs.length,!1)}})}return r._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?r._updateSignalingState("have-local-offer"):r._updateSignalingState("stable"),Promise.resolve()},u.prototype.setRemoteDescription=function(r){var u=this;if(-1===["offer","answer"].indexOf(r.type))return Promise.reject(s("TypeError",'Unsupported type "'+r.type+'"'));if(!a("setRemoteDescription",r.type,u.signalingState)||u._isClosed)return Promise.reject(s("InvalidStateError","Can not set remote "+r.type+" in state "+u.signalingState));var h={};u.remoteStreams.forEach(function(e){h[e.id]=e});var f=[],p=c.splitSections(r.sdp),m=p.shift(),v=0<c.matchPrefix(m,"a=ice-lite").length,g=0<c.matchPrefix(m,"a=group:BUNDLE ").length;u.usingBundle=g;var C=c.matchPrefix(m,"a=ice-options:")[0];return u.canTrickleIceCandidates=!!C&&0<=C.substr(14).split(" ").indexOf("trickle"),p.forEach(function(a,s){var d=c.splitLines(a),p=c.getKind(a),C=c.isRejected(a)&&0===c.matchPrefix(a,"a=bundle-only").length,S=d[0].substr(2).split(" ")[2],E=c.getDirection(a,m),b=c.parseMsid(a),y=c.getMid(a)||c.generateIdentifier();if(C||"application"===p&&("DTLS/SCTP"===S||"UDP/DTLS/SCTP"===S))u.transceivers[s]={mid:y,kind:p,protocol:S,rejected:!0};else{!C&&u.transceivers[s]&&u.transceivers[s].rejected&&(u.transceivers[s]=u._createTransceiver(p,!0));var R,T,I,A,N,O,D,P,w,_,M,k=c.parseRtpParameters(a);C||(_=c.getIceParameters(a,m),(M=c.getDtlsParameters(a,m)).role="client"),D=c.parseRtpEncodingParameters(a);var U=c.parseRtcpParameters(a),L=0<c.matchPrefix(a,"a=end-of-candidates",m).length,F=c.matchPrefix(a,"a=candidate:").map(function(e){return c.parseCandidate(e)}).filter(function(e){return 1===e.component});if(("offer"===r.type||"answer"===r.type)&&!C&&g&&0<s&&u.transceivers[s]&&(u._disposeIceAndDtlsTransports(s),u.transceivers[s].iceGatherer=u.transceivers[0].iceGatherer,u.transceivers[s].iceTransport=u.transceivers[0].iceTransport,u.transceivers[s].dtlsTransport=u.transceivers[0].dtlsTransport,u.transceivers[s].rtpSender&&u.transceivers[s].rtpSender.setTransport(u.transceivers[0].dtlsTransport),u.transceivers[s].rtpReceiver&&u.transceivers[s].rtpReceiver.setTransport(u.transceivers[0].dtlsTransport)),"offer"!==r.type||C){if("answer"===r.type&&!C){T=(R=u.transceivers[s]).iceGatherer,I=R.iceTransport,A=R.dtlsTransport,N=R.rtpReceiver,O=R.sendEncodingParameters,P=R.localCapabilities,u.transceivers[s].recvEncodingParameters=D,u.transceivers[s].remoteCapabilities=k,u.transceivers[s].rtcpParameters=U,F.length&&"new"===I.state&&(!v&&!L||g&&0!==s?F.forEach(function(e){o(R.iceTransport,e)}):I.setRemoteCandidates(F)),g&&0!==s||("new"===I.state&&I.start(T,_,"controlling"),"new"===A.state&&A.start(M)),!i(R.localCapabilities,R.remoteCapabilities).codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length&&R.sendEncodingParameters[0].rtx&&delete R.sendEncodingParameters[0].rtx,u._transceive(R,"sendrecv"===E||"recvonly"===E,"sendrecv"===E||"sendonly"===E),!N||"sendrecv"!==E&&"sendonly"!==E?delete R.rtpReceiver:(w=N.track,b?(!h[b.stream]&&(h[b.stream]=new e.MediaStream),n(w,h[b.stream]),f.push([w,N,h[b.stream]])):(!h.default&&(h.default=new e.MediaStream),n(w,h.default),f.push([w,N,h.default])))}}else{(R=u.transceivers[s]||u._createTransceiver(p)).mid=y,R.iceGatherer||(R.iceGatherer=u._createIceGatherer(s,g)),F.length&&"new"===R.iceTransport.state&&(!L||g&&0!==s?F.forEach(function(e){o(R.iceTransport,e)}):R.iceTransport.setRemoteCandidates(F)),P=e.RTCRtpReceiver.getCapabilities(p),15019>t&&(P.codecs=P.codecs.filter(function(e){return"rtx"!==e.name})),O=R.sendEncodingParameters||[{ssrc:1001*(2*s+2)}];var B=!1;if("sendrecv"!==E&&"sendonly"!==E)R.rtpReceiver&&R.rtpReceiver.track&&(R.associatedRemoteMediaStreams.forEach(function(e){var t=e.getTracks().find(function(e){return e.id===R.rtpReceiver.track.id});t&&l(t,e)}),R.associatedRemoteMediaStreams=[]);else if(B=!R.rtpReceiver,N=R.rtpReceiver||new e.RTCRtpReceiver(R.dtlsTransport,p),B){var $;w=N.track,b&&"-"===b.stream||(b?(!h[b.stream]&&(h[b.stream]=new e.MediaStream,Object.defineProperty(h[b.stream],"id",{get:function(){return b.stream}})),Object.defineProperty(w,"id",{get:function(){return b.track}}),$=h[b.stream]):(!h.default&&(h.default=new e.MediaStream),$=h.default)),$&&(n(w,$),R.associatedRemoteMediaStreams.push($)),f.push([w,N,$])}R.localCapabilities=P,R.remoteCapabilities=k,R.rtpReceiver=N,R.rtcpParameters=U,R.sendEncodingParameters=O,R.recvEncodingParameters=D,u._transceive(u.transceivers[s],!1,B)}}}),void 0===u._dtlsRole&&(u._dtlsRole="offer"===r.type?"active":"passive"),u._remoteDescription={type:r.type,sdp:r.sdp},"offer"===r.type?u._updateSignalingState("have-remote-offer"):u._updateSignalingState("stable"),Object.keys(h).forEach(function(t){var n=h[t];if(n.getTracks().length){if(-1===u.remoteStreams.indexOf(n)){u.remoteStreams.push(n);var r=new Event("addstream");r.stream=n,e.setTimeout(function(){u._dispatchEvent("addstream",r)})}f.forEach(function(e){var t=e[0],r=e[1];n.id!==e[2].id||d(u,t,r,[n])})}}),f.forEach(function(e){e[2]||d(u,e[0],e[1],[])}),e.setTimeout(function(){u&&u.transceivers&&u.transceivers.forEach(function(e){e.iceTransport&&"new"===e.iceTransport.state&&0<e.iceTransport.getRemoteCandidates().length&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},u.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},u.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},u.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"!==this.signalingState||!0===this.needNegotiation||(this.needNegotiation=!0,e.setTimeout(function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}},0))},u.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++}),e="new",0<t.failed?e="failed":0<t.checking?e="checking":0<t.disconnected?e="disconnected":0<t.new?e="new":0<t.connected?e="connected":0<t.completed&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var n=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",n)}},u.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++)}),t.connected+=t.completed,e="new",0<t.failed?e="failed":0<t.connecting?e="connecting":0<t.disconnected?e="disconnected":0<t.new?e="new":0<t.connected&&(e="connected"),e!==this.connectionState){this.connectionState=e;var n=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",n)}},u.prototype.createOffer=function(){var n=this;if(n._isClosed)return Promise.reject(s("InvalidStateError","Can not call createOffer after close"));var i=n.transceivers.filter(function(e){return"audio"===e.kind}).length,a=n.transceivers.filter(function(e){return"video"===e.kind}).length,o=arguments[0];if(o){if(o.mandatory||o.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==o.offerToReceiveAudio&&(i=!0===o.offerToReceiveAudio?1:!1===o.offerToReceiveAudio?0:o.offerToReceiveAudio),void 0!==o.offerToReceiveVideo&&(a=!0===o.offerToReceiveVideo?1:!1===o.offerToReceiveVideo?0:o.offerToReceiveVideo)}for(n.transceivers.forEach(function(e){"audio"===e.kind?0>--i&&(e.wantReceive=!1):"video"===e.kind&&(0>--a&&(e.wantReceive=!1))});0<i||0<a;)0<i&&(n._createTransceiver("audio"),i--),0<a&&(n._createTransceiver("video"),a--);var l=c.writeSessionBoilerplate(n._sdpSessionId,n._sdpSessionVersion++);n.transceivers.forEach(function(r,i){var a=r.track,o=r.kind,s=r.mid||c.generateIdentifier();r.mid=s,r.iceGatherer||(r.iceGatherer=n._createIceGatherer(i,n.usingBundle));var l=e.RTCRtpSender.getCapabilities(o);15019>t&&(l.codecs=l.codecs.filter(function(e){return"rtx"!==e.name})),l.codecs.forEach(function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),r.remoteCapabilities&&r.remoteCapabilities.codecs&&r.remoteCapabilities.codecs.forEach(function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)})}),l.headerExtensions.forEach(function(e){(r.remoteCapabilities&&r.remoteCapabilities.headerExtensions||[]).forEach(function(t){e.uri===t.uri&&(e.id=t.id)})});var d=r.sendEncodingParameters||[{ssrc:1001*(2*i+1)}];a&&15019<=t&&"video"===o&&!d[0].rtx&&(d[0].rtx={ssrc:d[0].ssrc+1}),r.wantReceive&&(r.rtpReceiver=new e.RTCRtpReceiver(r.dtlsTransport,o)),r.localCapabilities=l,r.sendEncodingParameters=d}),"max-compat"!==n._config.bundlePolicy&&(l+="a=group:BUNDLE "+n.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),l+="a=ice-options:trickle\r\n",n.transceivers.forEach(function(e,t){l+=r(e,e.localCapabilities,"offer",e.stream,n._dtlsRole),l+="a=rtcp-rsize\r\n",e.iceGatherer&&"new"!==n.iceGatheringState&&(0===t||!n.usingBundle)&&(e.iceGatherer.getLocalCandidates().forEach(function(e){e.component=1,l+="a="+c.writeCandidate(e)+"\r\n"}),"completed"===e.iceGatherer.state&&(l+="a=end-of-candidates\r\n"))});var d=new e.RTCSessionDescription({type:"offer",sdp:l});return Promise.resolve(d)},u.prototype.createAnswer=function(){var n=this;if(n._isClosed)return Promise.reject(s("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==n.signalingState&&"have-local-pranswer"!==n.signalingState)return Promise.reject(s("InvalidStateError","Can not call createAnswer in signalingState "+n.signalingState));var a=c.writeSessionBoilerplate(n._sdpSessionId,n._sdpSessionVersion++);n.usingBundle&&(a+="a=group:BUNDLE "+n.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),a+="a=ice-options:trickle\r\n";var o=c.getMediaSections(n._remoteDescription.sdp).length;n.transceivers.forEach(function(e,s){if(!(s+1>o)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?a+="m=application 0 DTLS/SCTP 5000\r\n":a+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?a+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(a+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(a+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var c;if(e.stream)"audio"===e.kind?c=e.stream.getAudioTracks()[0]:"video"===e.kind&&(c=e.stream.getVideoTracks()[0]),c&&15019<=t&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1});var l=i(e.localCapabilities,e.remoteCapabilities);!l.codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,a+=r(e,l,"answer",e.stream,n._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(a+="a=rtcp-rsize\r\n")}});var l=new e.RTCSessionDescription({type:"answer",sdp:a});return Promise.resolve(l)},u.prototype.addIceCandidate=function(e){var t,n=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(r,i){if(!n._remoteDescription)return i(s("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var a=e.sdpMLineIndex;if(e.sdpMid)for(var l=0;l<n.transceivers.length;l++)if(n.transceivers[l].mid===e.sdpMid){a=l;break}var d=n.transceivers[a];if(!d)return i(s("OperationError","Can not add ICE candidate"));if(d.rejected)return r();var u=0<Object.keys(e.candidate).length?c.parseCandidate(e.candidate):{};if("tcp"===u.protocol&&(0===u.port||9===u.port))return r();if(u.component&&1!==u.component)return r();if((0===a||0<a&&d.iceTransport!==n.transceivers[0].iceTransport)&&!o(d.iceTransport,u))return i(s("OperationError","Can not add ICE candidate"));var h=e.candidate.trim();0===h.indexOf("a=")&&(h=h.substr(2)),(t=c.getMediaSections(n._remoteDescription.sdp))[a]+="a="+(u.type?h:"end-of-candidates")+"\r\n",n._remoteDescription.sdp=c.getDescription(n._remoteDescription.sdp)+t.join("")}else for(var f=0;f<n.transceivers.length&&(n.transceivers[f].rejected||(n.transceivers[f].iceTransport.addRemoteCandidate({}),(t=c.getMediaSections(n._remoteDescription.sdp))[f]+="a=end-of-candidates\r\n",n._remoteDescription.sdp=c.getDescription(n._remoteDescription.sdp)+t.join(""),!n.usingBundle));f++);r()})},u.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var n=null;if(this.transceivers.forEach(function(e){e.rtpSender&&e.rtpSender.track===t?n=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(n=e.rtpReceiver)}),!n)throw s("InvalidAccessError","Invalid selector.");return n.getStats()}var r=[];return this.transceivers.forEach(function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(t){e[t]&&r.push(e[t].getStats())})}),Promise.all(r).then(function(e){var t=new Map;return e.forEach(function(e){e.forEach(function(e){t.set(e.id,e)})}),t})},["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach(function(t){var n=e[t];if(n&&n.prototype&&n.prototype.getStats){var r=n.prototype.getStats;n.prototype.getStats=function(){return r.apply(this).then(function(e){var t=new Map;return Object.keys(e).forEach(function(n){e[n].type=function(e){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type}(e[n]),t.set(n,e[n])}),t})}}});var h=["createOffer","createAnswer"];return h.forEach(function(e){var t=u.prototype[e];u.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then(function(t){"function"==typeof e[0]&&e[0].apply(null,[t])},function(t){"function"==typeof e[1]&&e[1].apply(null,[t])}):t.apply(this,arguments)}}),(h=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach(function(e){var t=u.prototype[e];u.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)},function(t){"function"==typeof e[2]&&e[2].apply(null,[t])}):t.apply(this,arguments)}}),["getStats"].forEach(function(e){var t=u.prototype[e];u.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)}):t.apply(this,arguments)}}),u}},function(){window.sdkversion="1.54.2"},function(){window.app=angular.module("rainbow",["angular-jwt"]),window.rainbowAdmin=angular.module("rainbowAdmin",[]),window.rainbow=angular.module("rainbow",["rainbowAdmin"])},function(e,t,n){n(12),n(22),n(23),n(24),n(25),n(26),n(27),n(28),n(29),n(30),n(31),n(32),n(33),n(34),n(35),n(36),n(37),n(38),n(62),n(63),n(64),n(65),n(66),n(67),n(68),n(69),n(70),n(71),n(72),n(73),n(74),n(75),n(76),n(77),n(78),n(79),n(80),n(81),n(82),n(83),n(84),n(85),n(86),n(87),n(88),n(89),n(90),n(91),n(92),n(93),n(94),n(95),n(96),n(97),n(98),n(99),n(100),n(101),n(102),n(103),n(104),n(105),n(106),n(107),n(108),n(109),n(110),n(111),n(112),n(113),n(114),n(115),n(116),n(117),n(118),n(119),n(120),n(121),n(122),n(123),n(124),n(125),n(126),n(127),n(128),n(142),n(143),n(144),n(145),n(146),n(147)},function(){angular.module("rainbow").factory("AuthSettings",[function(){"use strict";function e(e){if(0<e.length){if(1===e.length)var t=e[0];else t=e.reduce(function(e,t){return"RAINBOW"===t.type&&"RAINBOW"!==e.type?(e.safetyUrl=t.url||t.loginUrl,e):(t.safetyUrl=e.url||e.loginUrl,t)});this.type=t.type,this.loginUrl=t.url||t.loginUrl,this.logoutUrl=t.logoutUrl,this.safetyUrl=t.safetyUrl}this.setParameter=function(e,t){switch(e){case"uid":this.userId=t();break;case"x-rainbow-app-auth":if("RAINBOW"!==this.type&&this.loginUrl){var n=t((r=new URL(this.loginUrl)).searchParams.get("challenge"));r.searchParams.append(e,n),this.loginUrl=r.href}break;case"token":if("RAINBOW"!==this.type&&this.logoutUrl){var r=new URL(this.logoutUrl),i=t();r.searchParams.append(e,i),this.logoutUrl=r.href}}}}return e.createFromData=function(t){return new e(t)},e}])},function(){function e(e,t,n,r){this.name="RainbowError",this.message=e,this.details=t,this.detailsCode=n,this.detailsData=r,this.stack=(new Error).stack}e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,window.RBError=e},function(){angular.module("rainbow").factory("Company",[function(){"use strict";function e(t){var n=this;e.attributes.forEach(function(e){angular.isDefined(t[e.name])?n[e.name]=t[e.name]:angular.isDefined(e.defaultValue)&&(n[e.name]=e.defaultValue)}),this.state=t.state?t.state:"USA"===t.country?"AL":"CAN"===t.country?"AB":null,this.logo=null,this.filterName=this.name.toLowerCase(),this.updateFromData=function(t){e.attributes.forEach(function(e){angular.isDefined(t[e.name])&&(n[e.name]=t[e.name])})},this.nameForLogs="",this.isActive=function(){return"active"===this.status},this.isInitializing=function(){return"initializing"===this.status},this.isInvited=function(){return"invited"===this.status},this.isFreemium=function(){return"freemium"===this.offerType},this.isPremium=function(){return"premium"===this.offerType}}return e.createFromData=function(t){return new e(t)},e.create=function(t,n){return new e({id:t,name:n})},e.prune=function(e,t){var n=Object.assign({},e);return delete n.dataLocation,n.isBP||(delete n.bpType,delete n.bpBusinessModel,delete n.bpApplicantNumber,delete n.bpCRDid,delete n.bpHasRightToSell,delete n.bpHasRightToConnect,delete n.bpIsContractAccepted),t&&(t.isSuperadmin()||t.isBPAdminFinance())||(delete n.bpType,delete n.adminHasRightToUpdateSubscriptions,delete n.adminAllowedUpdateSubscriptionsOps),""===n.economicActivityClassification&&delete n.economicActivityClassification,t&&(t.isSuperadmin()||null!==n.supportEmail&&""!==n.supportEmail)||delete n.supportEmail,t&&(t.isSuperadmin()||null!==n.privateDC&&""!==n.privateDC)||delete n.privateDC,n},e.StatusValues=["initializing","active","alerting","hold","terminated"],e.VisibilityValues=["private","organization","public"],e.VisibilityValuesWithoutOrg=["private","public"],e.SizeValues=["self-employed","1-10 employees","11-50 employees","51-200 employees","201-500 employees","501-1000 employees","1001-5000 employees","5001-10,000 employees","10,001+ employees"],e.OfferTypes=["freemium","premium"],e.BPTypes=["VAD","DR","IR"],e.BPTypeLabels={IR:"Indirect Reseller",VAD:"Value Added Distributor",DR:"Direct Reseller"},e.BPBusinessModels=["resell"],e.BPBusinessModelLabels={resell:"Resell",referral:"Referral"},e.adminAllowedUpdateSubscriptionsOperations=["all","increase_only"],e.EconomicActivityClassificationTypes={NONE:"notDefined-f",A:"agriculture",B:"mining",C:"manufacturing",D:"electricity",E:"water supply",F:"construction",G:"wholesale",H:"transportation",I:"accommodation",J:"information and communication",K:"financial",L:"real estate activities",M:"professional",N:"administrative",O:"public administration",P:"education",Q:"human health",R:"arts",S:"other service activities",T:"activities of households as employer",U:"activities of extraterritorial organisations and bodies"},e.PrivateDCValues=["HDS"],e.attributes=[{name:"id",defaultValue:void 0},{name:"name",defaultValue:""},{name:"companyContactId",defaultValue:void 0},{name:"adminEmail",defaultValue:""},{name:"supportEmail",defaultValue:void 0},{name:"status",defaultValue:"active"},{name:"economicActivityClassification",defaultValue:"NONE"},{name:"website",defaultValue:void 0},{name:"description",defaultValue:void 0},{name:"visibility",defaultValue:"private"},{name:"visibleBy",defaultValue:[]},{name:"organisationId",defaultValue:""},{name:"userSelfRegisterEnabled",defaultValue:!1},{name:"userSelfRegisterAllowedDomains",defaultValue:[]},{name:"offerType",defaultValue:"freemium"},{name:"country",defaultValue:void 0},{name:"state",defaultValue:null},{name:"size",defaultValue:void 0},{name:"slogan",defaultValue:void 0},{name:"isBP",defaultValue:!1},{name:"bpType",defaultValue:void 0},{name:"bpBusinessModel",defaultValue:void 0},{name:"bpApplicantNumber",defaultValue:void 0},{name:"bpCRDid",defaultValue:void 0},{name:"bpHasRightToSell",defaultValue:void 0},{name:"bpId",defaultValue:void 0},{name:"bpHasRightToConnect",defaultValue:void 0},{name:"adminHasRightToUpdateSubscriptions",defaultValue:!1},{name:"adminAllowedUpdateSubscriptionsOps",defaultValue:"all"},{name:"externalReference",defaultValue:void 0},{name:"externalReference2",defaultValue:void 0},{name:"lastAvatarUpdateDate",defaultValue:null},{name:"lastBannerUpdateDate",defaultValue:null},{name:"avatarShape",defaultValue:"circle"},{name:"catalogId",defaultValue:void 0},{name:"office365Tenant",defaultValue:void 0},{name:"isCentrex",defaultValue:void 0},{name:"tenantCallNumber",defaultValue:void 0},{name:"tenantName",defaultValue:void 0},{name:"numberUsers",defaultValue:void 0},{name:"giphyEnabled",defaultValue:!0},{name:"dataLocation",defaultValue:void 0},{name:"privateDC",defaultValue:void 0}],e.prototype.getNameForLogs=function(){if(!this.nameForLogs&&this.name){var e=this.name.replace(/[^\s](?=.{1,}$)/g,"*");this.nameForLogs=this.name.charAt(0)+e.substr(1)}return this.nameForLogs},e}]),angular.module("rainbow").filter("companyOfferFilter",[function(){"use strict";return function(e){return"freemium"===e?"Freemium":"premium"===e?"Premium":e?e.charAt(0).toUpperCase()+e.slice(1).toLowerCase():e}}])},function(){angular.module("rainbow").factory("CompanyInvitation",[function(){"use strict";function e(e,t,n,r,i,a,o,s,c,l,d,u,h,f){this.id=e,this.companyId=t,this.companyName=n,this.invitedUserId=r,this.invitedUserEmail=i,this.invitingAdminId=a,this.invitingAdminLoginEmail=o,this.invitationDate=s,this.lastNotificationDate=c,this.requestedNotificationLanguage=l,this.status=d,this.acceptationDate=u,this.declinationDate=h,this.invitedToBeCompanyAdmin=f}return e.createFromData=function(t){return new e(t.id,t.companyId,t.companyName,t.invitedUserId,t.invitedUserEmail,t.invitingAdminId,t.invitingAdminLoginEmail,t.invitationDate,t.lastNotificationDate,t.requestedNotificationLanguage,t.status,t.acceptationDate,t.declinationDate,t.invitedToBeCompanyAdmin)},e}])},function(){class e{}e.DELETED="deleted",e.UPLOADING="uploading",e.UPLOADED="uploaded",e.NOT_UPLOADED="not_uploaded",e.DOWNLOADING="downloading",e.UNKNOWN="unknown";class t{constructor(e,t){this.icon=e,this.style=t}}class n{constructor(e){e?(this.availableThumbnail=e.availableThumbnail,this.md5sum=e.md5sum,this.size=e.size,this.wantThumbnailDate=e.wantThumbnailDate):this.availableThumbnail=!1}isThumbnailAvailable(){return this.availableThumbnail}}class r{constructor(e=null,t=null,r=null,i=null,a=null,o=null,s=null,c=null,l=null,d=null,u=null,h=null,f=null,p=0){this.id=e,this.url=t,this.ownerId=r,this.fileName=i,this.extension=a,this.typeMIME=o,this.thumbnailPlaceholder=this.getThumbnailPlaceholderFromMimetype(o),this.size=s,this.registrationDate=c,this.uploadedDate=l,this.dateToSort=d,this.viewers=u,this.state=h,this.thumbnail=new n(f),this.fileToSend=void 0,this.previewBlob=void 0,this.orientation=p||void 0}isMicrosoftFile(){return["docx","doc","ppt","pptx","xls","xlsx"].some(e=>e===this.extension)}isThumbnailPossible(){return this.isImage()||this.isPDF()}isPDF(){return"application/pdf"===this.typeMIME}isImage(){let e="image/";return this.typeMIME&&this.typeMIME.length>=e.length&&this.typeMIME.slice(0,e.length)===e}isAudioVideo(){return["avi","mpg","wma","mp3","wmv","mkv","mov","wav","ogg","mp4","aac"].some(e=>e===this.extension)}isUploaded(){return this.state&&this.state===e.UPLOADED}isAlreadyFileViewer(e){return!(!this.ownerId||this.ownerId!==e)||!!this.viewers&&this.viewers.some(t=>t.viewerId===e)}getDisplayName(){return this.fileName.replace(/\.[^\/.]+$/,"")}getDisplayNameTruncated(){var e=this.fileName.replace(/\.[^\/.]+$/,"");return[e.substring(0,e.length-4),e.slice(-4)]}getExtension(){return this.fileName.toUpperCase()===this.extension.toUpperCase()?"":"."+this.extension}getThumbnailPlaceholderFromMimetype(e){return e?0===e.indexOf("image")?new t("icon_image","imageStyle"):"application/msword"===e||/^application\/vnd.openxmlformats-officedocument.wordprocessingml.*$/.test(e)||"application/vnd.oasis.opendocument.text"===e?new t("icon_doc","docStyle"):/^application\/vnd.ms-powerpoint.*$/.test(e)||/^application\/vnd.openxmlformats-officedocument.presentationml.*$/.test(e)||"application/vnd.oasis.opendocument.presentation"===e?new t("icon_ppt","pptStyle"):0===e.indexOf("application/vnd.ms-excel")||/^application\/vnd.openxmlformats-officedocument.spreadsheetml.*$/.test(e)?new t("icon_xls","xlsStyle"):"application/pdf"===e||"application/vnd.oasis.opendocument.spreadsheet"===e?new t("icon_pdf","pdfStyle"):0===e.indexOf("video/")||0===e.indexOf("audio/")?new t("icon_file-video","imageStyle"):new t("icon_filestandard","otherStyle"):new t("icon_filestandard","otherStyle")}releaseURL(){this.localURL=void 0}}angular.module("rainbow").factory("fileDescriptorFactory",[function(){return(e,t,n,i,a,o,s,c,l,d,u,h,f,p)=>new r(e,t,n,i,a,o,s,c,l,d,u,h,f,p)}])},function(){class e{}e.USER="user",e.ROOM="room";class t{constructor(e,t,n,r=null,i=null){this.contactService=r,this.channelService=i,this.viewerId=e,this.type=t,this.contact=n}get avatarSrc(){if("user"===this.type&&this.contact)this._avatarSrc=this.contact.avatar.src;else if("channel"===this.type&&this.channel)this._avatarSrc=this.channel.getAvatarSrc();else if(this._avatarSrc=null,"user"===this.type&&this.contactService.getContactByDBId(this.viewerId).then(e=>{this.contact=e,this._avatarSrc=this.contact.avatar.src}),"channel"===this.type){let e=this.channelService.getChannelFromCache(this.viewerId,!1);e&&(this.channel=e,this._avatarSrc=this.channel.getAvatarSrc())}return this._avatarSrc}}angular.module("rainbow").factory("fileViewerFactory",[function(){return e=>{let n=[];for(let r of e)n.push(new t(r.viewerId,r.type,r.contact,r.contactService,r.channelService));return n}}]),angular.module("rainbow").factory("fileViewerElementFactory",[function(){return(e,n,r,i,a)=>new t(e,n,r,i,a)}])},function(){angular.module("rainbow").factory("CompanyRequest",[function(){"use strict";function e(e,t,n,r,i,a,o,s,c,l,d){this.id=e,this.requestingUserId=t,this.requestingUserLoginEmail=n,this.requestedCompanyId=r,this.requestedCompanyName=i,this.status=a,this.requestingDate=o,this.requestedNotificationLanguage=s,this.lastNotificationDate=c,this.requestedToCompanyAdmin=l,this.requestedCompanyInvitationId=d}return e.createFromData=function(t){return new e(t.id,t.requestingUserId,t.requestingUserLoginEmail,t.requestedCompanyId,t.requestedCompanyName,t.status,t.requestingDate,t.requestedNotificationLanguage,t.lastNotificationDate,t.requestedToCompanyAdmin,t.requestedCompanyInvitationId)},e}])},function(){angular.module("rainbow").factory("CompanyBpLinkInvitation",[function(){"use strict";function e(e,t,n,r,i,a,o,s,c,l,d,u,h,f,p){this.id=e,this.invitedCompanyId=t,this.invitedCompanyName=n,this.invitedToBeBpIr=r,this.invitingAdminId=i,this.invitingAdminLoginEmail=a,this.invitingCompanyId=o,this.invitingCompanyName=s,this.invitationDate=c,this.lastNotificationDate=l,this.requestedNotificationLanguage=d,this.status=u,this.acceptationDate=h,this.cancelationDate=f,this.declinationDate=p}return e.createFromData=function(t){return new e(t.id,t.invitedCompanyId,t.invitedCompanyName,t.invitedToBeBpIr,t.invitingAdminId,t.invitingAdminLoginEmail,t.invitingCompanyId,t.invitingCompanyName,t.invitationDate,t.lastNotificationDate,t.requestedNotificationLanguage,t.status,t.acceptationDate,t.cancelationDate,t.declinationDate)},e}])},function(){angular.module("rainbow").factory("CompanyBpLinkRequest",[function(){"use strict";function e(e,t,n,r,i,a,o,s,c,l,d,u,h,f,p){this.id=e,this.requestingAdminId=t,this.requestingAdminLoginEmail=n,this.requestingCompanyId=r,this.requestingCompanyName=i,this.requestedCompanyId=a,this.requestedCompanyName=o,this.requestedToBeBpIr=s,this.requestDate=c,this.lastNotificationDate=l,this.requestedNotificationLanguage=d,this.status=u,this.acceptationDate=h,this.cancelationDate=f,this.declinationDate=p}return e.createFromData=function(t){return new e(t.id,t.requestingAdminId,t.requestingAdminLoginEmail,t.requestingCompanyId,t.requestingCompanyName,t.requestedCompanyId,t.requestedCompanyName,t.requestedToBeBpIr,t.requestDate,t.lastNotificationDate,t.requestedNotificationLanguage,t.status,t.acceptationDate,t.cancelationDate,t.declinationDate)},e}])},function(){angular.module("rainbow").factory("Conference",[function(){"use strict";function e(e,t,n,r,i,a,o,s,c,l,d,u,h){this.companyId=e,this.id=t,this.mediaType=n,this.name=r,this.passCodes=i||[],this.scheduled=a,this.scheduledDuration=o,this.scheduledEndDate=s,this.scheduledStartDate=c,this.lastUpdateDate=l,this.scheduledTimezone=d,this.userId=u,this.confDialOutDisabled=h,this.updateFromData=function(e){this.companyId=e.companyId,this.id=e.id,this.mediaType=e.mediaType,this.name=e.name,this.passCodes=e.passCodes,this.scheduled=e.scheduled,this.scheduledDuration=e.scheduledDuration,this.scheduledEndDate=e.scheduledEndDate,this.scheduledStartDate=e.scheduledStartDate,this.lastUpdateDate=e.lastUpdateDate,this.scheduledTimezone=e.scheduledTimezone,this.userId=e.userId,this.confDialOutDisabled=e.confDialOutDisabled}}return e.createFromData=function(t){return new e(t.companyId,t.id,t.mediaType,t.name,t.passCodes,t.scheduled,t.scheduledDuration,t.scheduledEndDate,t.scheduledStartDate,t.lastUpdateDate,t.scheduledTimezone,t.userId,t.confDialOutDisabled)},e}])},function(){angular.module("rainbow").factory("ConferenceSession",["$log","ConferenceParticipant","contactService","$q",function(e,t,n,r){"use strict";function i(i,a,o,s){var c=this;c.id=i,c.participants=a,c.active=o,c.talkerActive=void 0,c.recordingStarted=void 0,c.talkers=void 0,c.isLeaderAlreadyConnected=!1,c.status=null,c.localStreams=[],c.sessions={},c.publishers=[],c.type=s,c.callId=null,c.hasLocalVideo=!1,c.jingleJid=null,c.localVideoSessionId=null,c.localSharingSessionId=null,c.haveJoined=!1,c.cleanupSessionData=function(){e.debug("[ConferenceSession] Cleanup for conferenceSession "+c.id),c.participants=[],c.talkerActive=void 0,c.recordingStarted=void 0,c.talkers=void 0,c.isLeaderAlreadyConnected=!1,c.localStreams=[],c.sessions={},c.publishers=[],c.hasLocalVideo=!1,c.metricsState="",c.recordingStarted=!1,c.status="ended",c.hasLocalSharing=!1,c.reversedVideos=!1,c.jingleJid=null,c.localVideoSessionId=null,c.localSharingSessionId=null,c.haveJoined=!1},c.updateFromData=function(e,t,n){c.id=e,c.participants=t,c.active=n},c.updateActiveState=function(e){c.active=e},c.updateStateFromData=function(e,t,n){c.active=e,c.talkerActive=t,c.recordingStarted=n},c.updateParticipants=function(n){return r(function(r){var i=!1;n||r(!1),c.participants||(c.participants=[]),0===n.length&&(c.participants=[]),n.forEach(function(n){if(n.participantId){e.debug("[conferenceSession] updateParticipants participantId="+n.participantId);var r=c.getParticipantById(n.participantId);r?(e.debug("[conferenceSession] updateParticipants update participantId="+n.participantId),r.updateFromData(n)):(e.debug("[conferenceSession] updateParticipants create participantId="+n.participantId),c.participants.push(t.createFromData(n)),i=!0)}}),r(i)})},c.removeParticipants=function(t){t&&t.forEach(function(t){var n=c.getParticipantIndexById(t);-1!==n&&(e.debug("[conferenceSession] removeParticipants remove participantId="+t),c.participants.splice(n,1))})},c.removePublisher=function(t){if(t){var n=c.getPublisherIndexById(t);-1!==n&&(e.debug("[conferenceSession] removePublisher remove participantId="+t),c.publishers.splice(n,1))}},c.updateTalkers=function(t){e.debug("[conferenceSession] updateTalkers talkers="+t),c.talkers=t},c.isActive=function(){return void 0!==c.active&&c.active},c.isTalkerActive=function(){return void 0!==c.talkerActive&&c.talkerActive},c.isRecordingStarted=function(){return void 0!==c.recordingStarted&&c.recordingStarted},c.getParticipants=function(){return c.participants},c.getConnectedParticipants=function(){return c.participants?c.participants.filter(function(e){return"disconnected"!==e.state}):void 0},c.getConnectedParticipantsExceptLeader=function(){return c.participants?c.participants.filter(function(e){return"disconnected"!==e.state&&"moderator"!==e.role}):void 0},c.getConnectedLeaderParticipantsExcept=function(e){return c.participants?c.participants.filter(function(t){return"disconnected"!==t.state&&"moderator"===t.role&&t.jid_im!==e}):void 0},c.getConnectedParticipantsExcept=function(e){return c.participants?c.participants.filter(function(t){return t.jid_im!==e&&"disconnected"!==t.state}):void 0},c.getLeaderParticipant=function(){return c.participants?c.participants.find(function(e){return"moderator"===e.role&&"disconnected"!==e.state}):void 0},c.getLeaderParticipantById=function(e){return c.participants?c.participants.find(function(t){return"moderator"===t.role&&"disconnected"!==t.state&&t.jid_im===e}):void 0},c.getParticipantById=function(e){return c.participants?c.participants.find(function(t){return t.participantId===e}):void 0},c.getParticipantByJid=function(e){return c.participants?c.participants.find(function(t){return t.jid_im===e}):void 0},c.getNonDisconnectedParticipantByJid=function(e){return c.participants?c.participants.find(function(t){return t.jid_im===e&&"disconnected"!==t.state}):void 0},c.getConnectedParticipantByJid=function(e){return c.participants?c.participants.find(function(t){return t.jid_im===e&&"connected"===t.state}):void 0},c.getParticipantIndexById=function(e){return c.participants?c.participants.findIndex(function(t){return t.participantId===e}):-1},c.getPublisherIndexById=function(e){return c.publishers?c.publishers.findIndex(function(t){return t.participantId===e}):-1},c.isParticipantConnectedByJid=function(e){return void 0!==c.participants&&c.participants.some(function(t){return t.jid_im===e&&"connected"===t.state})},c.isParticipantRingingByJid=function(e){return void 0!==c.participants&&c.participants.some(function(t){return t.jid_im===e&&"ringing"===t.state})},c.isParticipantConnectedWithThisUAByJid=function(e){return c.haveJoined&&void 0!==c.participants&&c.participants.some(function(t){return t.jid_im===e&&"connected"===t.state})},c.getTalkers=function(){return c.talkers},c.setCallId=function(e){c.callId=e},c.getListOfRemoteVideoPublishers=function(){var e=[];if(c.publishers)for(var t=0;t<c.publishers.length;t++)"video"===c.publishers[t].mediaType&&c.publishers[t].jid_im!==n.userContact.jid&&e.push(c.publishers[t]);return e}}return i.createFromData=function(e,t,n,r){return r||(r="pstnAudio"),new i(e,t,n,r)},i}])},function(){angular.module("rainbow").factory("ConferenceParticipant",[function(){"use strict";function e(e,t,n,r,i,a,o,s,c,l,d){this.participantId=e,this.userId=t,this.jid_im=n,this.jid_tel=r,this.role=i,this.mute=a,this.held=o,this.confStartDate=s,this.startDate=c,this.phoneNumber=l,this.state=d,this.updateFromData=function(e){e.userId&&(this.userId=e.userId),this.jid_im=e.jid_im,e.jid_tel&&(this.jid_tel=e.jid_tel),this.role=e.participantRole,this.mute=e.mute,this.held=e.held,this.confStartDate=e.confStartDate,this.startDate=e.startDate,this.phoneNumber=e.phoneNumber,this.state=e.participantState}}return e.createFromData=function(t){return new e(t.participantId,t.userId,t.jid_im,t.jid_tel,t.participantRole,t.mute,t.held,t.confStartDate,t.startDate,t.phoneNumber,t.participantState)},e}])},function(){class e{constructor(e,t,n,r,i,a,o,s,c){this.id=e,this.providerUserId=t,this.providerCompanyId=n,this.confCompanyId=r,this.userId=i,this.companyId=a,this.firstName=o,this.lastName=s,this.providerType=c}}angular.module("rainbow").factory("conferenceUserFactory",function(){return t=>new e(t.id,t.providerUserId,t.providerCompanyId,t.confCompanyId,t.userId,t.companyId,t.firstName,t.lastName,t.providerType)})},function(){class e{constructor(e,t,n,r,i,a,o,s,c,l,d,u,h,f,p){this.userRole="none",this.messageRetrieved=!1,this.messages=[],this.subscribed=!1,this.deleted=!1,this.invited=!1,this.type="SIMPLE",this.pageIndex=0,this.isLoading=!1,this.complete=!1,this.users=[],this.publishersRetreived=!1,this.loaded=!1,this.name=e,this.id=t,this.visibility=n,this.topic=r,this.creatorId=i,this.companyId=a,this.creationDate=o,this.type=d,this.users_count=s,this.subscribers_count=p,this.category=h,this.mode=f,this.lastAvatarUpdateDate=c;let m=this.lastAvatarUpdateDate?"&ts="+new Date(this.lastAvatarUpdateDate).getTime():"";if(this.avatar=config.restServerUrl+"/api/channel-avatar/"+t+"?size=256"+m,void 0!==l&&(this.subscribed=l),void 0!==d&&(this.userRole=d),void 0!==u&&(this.invited=u),!this.mode)switch(this.visibility){case"company":this.mode="company_public";break;case"public":this.mode="all_public";break;case"private":this.mode="company_private"}}isNotMember(){return this.userRole="none"}isOwner(){return"owner"===this.userRole}isPublisher(){return this.subscribed&&("owner"===this.userRole||"publisher"===this.userRole)}isMember(){return"member"===this.userRole}getAvatarSrc(){return this.lastAvatarUpdateDate?this.avatar:"/resources/skins/rainbow/images/channels/default_channel_avatar.png"}static ChannelFactory(){return t=>new e(t.name,t.id,t.visibility,t.topic,t.creatorId,t.companyId,t.creationDate,t.users_count,t.lastAvatarUpdateDate,t.subscribed,t.type,t.invited,t.category,t.mode,t.subscribers_count)}}angular.module("rainbow").factory("Channel",e.ChannelFactory)},function(){class e{constructor(){this.body=void 0,this.date=void 0,this.isRoom=!1,this.isSent=!1,this.messageId=void 0}static SearchTextMsgResultFactory(){return()=>new e}}class t{constructor(e){this.room=null,this.contact=null,this.totalCount=-1,this.convRes=[],this.otherJid=e}getResultFromMsgId(e){for(let t of this.convRes)if(t.messageId===e)return t}addMsgItem(e){this.convRes.push(e)}isRoom(){return this.conversation?null!=this.conversation.room:null!==this.room}}class n{constructor(){this.searchedText="",this.results=[],this.queryIds=[],this.totalCount=0,this.searchCounter=0}isEmpty(){return 0===this.queryIds.length||0===Object.keys(this.results).length}searchCount(){this.searchCounter++}getAvailableCount(){let e=0;for(let t of this.results)e+=t.convRes.length;return e}getTotalCount(){return this.totalCount}clearAll(){this.queryIds=[],this.totalCount=0,this.clearMessagesResults()}clearMessagesResults(){this.results.splice(0,this.results.length)}isCurrentQuery(e){return-1<this.queryIds.indexOf(e)}getItemForConvId(e){for(let t of this.results)if(t.otherJid===e)return t}createNewResult(e){let n=this.getItemForConvId(e);return n||(n=new t(e),this.results.push(n)),n}addNewItemResult(e,n){let r=this.getItemForConvId(e);r||(r=new t(e),this.results.push(r)),r.getResultFromMsgId(n.messageId)||r.addMsgItem(n)}splitText(e,t){var n="",r="",i="",a=this.cleanUpSpecialChars(e).toLowerCase(),o=this.cleanUpSpecialChars(t).toLowerCase(),s=a.indexOf(o);return 0<=s?(0<s&&(n=e.slice(0,s)),r=e.slice(s,s+t.length),e.length>t.length+s&&(i=e.slice(s+t.length,e.length))):n=e,[n,r,i]}cleanUpSpecialChars(e){return e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/[]/g,"A")).replace(/[]/g,"a")).replace(/[]/g,"E")).replace(/[]/g,"e")).replace(/[]/g,"I")).replace(/[]/g,"i")).replace(/[]/g,"O")).replace(/[]/g,"o")).replace(/[]/g,"u")).replace(/[]/g,"c")}}angular.module("rainbow").factory("SearchTextConvResultsFactory",function(){return()=>new n}),angular.module("rainbow").factory("SearchTextMsgResultFactory",e.SearchTextMsgResultFactory)},function(){angular.module("rainbowAdmin").factory("Offer",[function(){"use strict";function e(e,t,n,r,i,a,o,s,c,l,d,u,h,f){this.id=e,this.name=t,this.description=n,this.offerReference=r,this.profileId=i,this.canBeSold=!!a&&a,this.businessModel=o,this.isPrepaid=l,this.prepaidDuration=d,this.autoSubscribe=u,this.hasConference=h,this.isDemo=f,this.isDefault=s,this.isExclusive=c;var p=this.name.toLowerCase();p&&(this.hasConference||-1!==p.indexOf("conference")?p="conference":-1===p.indexOf("enterprise")?-1!==p.indexOf("business")&&(p="business"):p="enterprise"),this.logo="logo-offer-"+p+".svg",this.isEnterprise=function(){return this.name.toLowerCase().startsWith("enterprise")},this.isBusiness=function(){return this.name.toLowerCase().startsWith("business")},this.isEssential=function(){return this.name.toLowerCase().startsWith("essential")},this.isDemo=function(){return this.isDemo||!this.isDefault&&!this.canBeSold&&this.name.toLowerCase().contains("demo")},this.isUserLicense=function(){return this.isDefault||"nb_users"===this.businessModel||"usage"===this.businessModel},this.isFixedLicense=function(){return"flat_fee"===this.businessModel},this.isUserBasedLicense=function(){return"nb_users"===this.businessModel},this.isUsageBasedLicense=function(){return"usage"===this.businessModel}}return e.createFromData=function(t){return new e(t.id,t.name,t.description,t.offerReference,t.profileId,t.canBeSold,t.businessModel,t.isDefault,t.isExclusive,t.isPrepaid,t.prepaidDuration,t.autoSubscribe,t.hasConference,t.isDemo)},e.createFromSubscriptionData=function(t){return new e(t.offerId,t.offerName,void 0,t.offerReference,t.profileId,t.canBeSold,t.businessModel,t.isDefault,t.isExclusive,t.isPrepaid,void 0,void 0,t.hasConference,t.isDemo)},e.createFromSubscriptionCountersData=function(t){return new e(t.offerId,t.offerName,void 0,t.offerReference,void 0,t.canBeSold,t.businessModel,t.isDefault,t.isExclusive,t.isPrepaid,t.prepaidDuration,void 0,t.hasConference,t.isDemo)},e.createFromProfileData=function(t){return new e(t.offerId,t.offerName,void 0,void 0,t.profileId,!1,void 0,t.isDefault,t.isExclusive,t.isPrepaid,t.prepaidDuration,void 0,t.hasConference,t.isDemo)},e.createFromOperationLog=function(t){var n="delete"===t.operationType?t.previousData:t.newData;return new e(n.offerId,n.offerName,n.offerDescription,n.offerReference,n.profileId,n.canBeSold,n.businessModel,n.isDefault,n.isExclusive,n.isPrepaid,n.prepaidDuration,void 0,n.hasConference,n.isDemo)},e.offerComparator=function(e,t){var n=["Essential","Business","Enterprise","Conference"],r=n.findIndex(function(t){return e.name.startsWith(t)}),i=n.findIndex(function(e){return t.name.startsWith(e)});return(r=-1===r?n.length:r)<(i=-1===i?n.length:i)?-1:r>i?1:e.name>t.name?r===n.length?1:-1:e.name<t.name?r===n.length?-1:1:0},e.isExclusive=function(e){return e.isDefault||e.isExclusive},e.isOptional=function(t){return!e.isExclusive(t)},e.isEssential=function(e){return e.isDefault},e.isNotEssential=function(e){return!e.isDefault},e.isModelByNbUsers=function(e){return"nb_users"===e.businessModel},e.isPrepaid=function(e){return e.isPrepaid},e.isNotPrepaid=function(e){return!e.isPrepaid},e}])},function(e,t,n){"use strict";n.r(t);var r=n(1);n.n(r);angular.module("rainbow").factory("Contact",["$q","$rootScope","$interval","$document","$translate","$sce","settingsService","Company","$log","xmppService","authService","utilService",function(e,t,n,i,a,o,s,c,l,d,u,h){function f(e,n,r){var i=this;this.id=e,this.jid=e,this.fullJid=null,this.jidtel=null,this.dbId=null,this.login=null,this.temp=!1,this.status="unknown",this.telStatus="",this.imStatus="offline",this.imStatusStamp=[],this.resources={},this.loginEmail="",this.lastname="",this.firstname="",this.company=r,this.nickname="",this.title="",this.jobTitle="",this.country="",this.defaultAvatar=null,this._avatar=null,this._avatarLoading=!1,this.avatarSrc=null,this.timezone="",this.roles=null,this.confId="",this.phonePro="",this.phoneProCan="",this.phonePbx="",this.phoneInternalNumber="",this.pbxId="",this.mobilePro="",this.mobileProCan="",this.phonePerso="",this.phonePersoCan="",this.mobilePerso="",this.mobilePersoCan="",this.emailPro="",this.emailPerso="",this.oldImStatus=null,this.roster=!1,this.initialized=!1,this._displayName=n||e,this.name={value:this._displayName},this.initials="",this.message="",this.cellStyle="",this.ask="none",this.subscription="none",this.conversation=null,this.adminType=null,this.capabilities=null,this.groups=null,this.mobileResource=null,this.language=null,this.lastActivityDate=null,this.nameUpdatePrio=f.NameUpdatePrio.MAX_UPDATE_PRIO,this.isInDefaultCompany=!1,this.calendarState={},this.guest=!1,this.openInviteId=null,this.isVirtualTerm=!1,this.nameForLogs="",t.$on("$destroy",t.$on("ON_DISPLAY_ORDER_EVENT",function(){i.computeDisplayName()})),t.$on("$destroy",t.$on("ON_DISPLAY_ORDER_EVENT",function(){i.computeDisplayName()}))}return f.create=function(e,t,n,r,i){var a=new f(e,null,r);return t&&n&&(t=t.charAt(0).toUpperCase()+t.slice(1),n=n.charAt(0).toUpperCase()+n.slice(1),a.computeCompleteDisplayName(t,n)),a.login=i,a},f.createByPhoneNumber=function(e){var t=new f(null,e);return t.id=e,t},f.createBotContact=function(e,t,n){var r=new f(e),i=new Image;return i.src="/resources/skins/rainbow/images/emily.jpg",r.lastname=t,r.isBot=!0,r.computeDisplayName(),r.status="online",r.imStatus="online",r.subscription="both",r.avatar=i,r.dbId=n,r},f.updateContactToBot=function(e,t,n){var r=new Image;return r.src="/resources/skins/rainbow/images/emily.jpg",e.lastname=t,e.isBot=!0,e.computeDisplayName(),e.status="online",e.imStatus="online",e.subscription="both",e.avatar=r,e.dbId=n,e},f.AdminType={ORGANIZATION_ADMIN:"organization_admin",COMPANY_ADMIN:"company_admin",SITE_ADMIN:"site_admin",UNDEFINED:"undefined"},f.NameUpdatePrio={NO_UPDATE_PRIO:0,OUTLOOK_UPDATE_PRIO:1,SERVER_UPDATE_PRIO:2,MAX_UPDATE_PRIO:99},Object.defineProperty(f.prototype,"avatar",{set:function(e){this._avatar=e},get:function(){var e=this;if(e._avatar)return e._avatar;if(!e._avatarLoading&&e.avatarSrc){e._avatarLoading=!0;var r=new Image;r.onload=function(){var r=this;n(function(){e._avatar=r,e._avatarLoading=!1,l.log("[contact] Lazily load avatar for "+e.displayNameForLog()+" success"),t.$broadcast("ON_CONTACT_AVATAR_UPDATE",e.jid)},0,1,!0)},r.onerror=function(){l.warn("[contact] Lazily load avatar for "+e.displayNameForLog()+" failure : use text avatar"),e._avatar=e.defaultAvatar,e._avatarLoading=!1},r.src=e.avatarSrc}return e.defaultAvatar}}),Object.defineProperty(f.prototype,"displayName",{set:function(e){this._displayName=e,this.name.value=e,this.displayNameMD5=Object(r.MD5)(r.enc.Latin1.parse(e)).toString(r.enc.Hex)},get:function(){return this._displayName}}),Object.defineProperty(f.prototype,"lastActivityDate",{set:function(e){this._lastActivityDate=e,this.updateLastActivityMessage()},get:function(){return this._lastActivityDate}}),Object.defineProperty(f.prototype,"statusMessage",{get:function(){if((this._currentStatus!==this.status||this._currentLastActivityMessage!==this.lastActivityMessage||this._currentMessage!==this.message)&&(this._currentStatus=this.status,this._currentMessage=this.message,this._currentLastActivityMessage=this.lastActivityMessage,this._statusMessage="unknown"===this.status?this.company&&this.company.name?this.company.name:a.instant("unknown"):"offline"===this.status&&""===this.lastActivityMessage?a.instant("offlineFilter"):"away"===this.status&&""===this.lastActivityMessage?a.instant("shortAway"):a.instant(this.status,{offlineDate:this.lastActivityMessage}),this.message)){var e=a.instant(this.message);"("!==e.charAt(0)&&(e="("+e+")"),this._statusMessage+=" "+e}return this._statusMessage}}),Object.defineProperty(f.prototype,"lastActivityMessage",{get:function(){var e=this;if(!e._lastActivityMessage&&!e._lastActivityInProgress){e._lastActivityInProgress=!0;try{d.connection.lastactivity.query(e.jid,{onResponse:function(t){var n=1e3*$(t).find("query").attr("seconds"),r=(new Date).getTime();e.lastActivityDate=new Date(r-n),e._lastActivityInProgress=!1}})}catch(t){l.error("[Contact] lastActivityDate getter accessor for contact "+e.jid_im+" -- failure : "+t),e._lastActivityInProgress=!1}return null}return this._lastActivityMessage}}),f.prototype.updateLastActivityMessage=function(){if(this._lastActivityDate){var e=moment(this._lastActivityDate);this._lastActivityMessage=moment.locale().startsWith("de")?e.fromNow(!0).replace("Tage","Tagen"):e.fromNow(!0)}else this._lastActivityMessage=""},f.prototype.getLastAvailableDate=function(){var e=null,t=this.imStatusStamp;return Object.keys(t).forEach(function(n){var r=t[n];e?e<r&&(e=r):e=r}),e},f.prototype.updateCalendarPresenceInfo=function(){var e=this.calendarState,t=null,n=null;e.iconId=null;var r=null;e.autoReplyOn?(e.iconId="icon_outofoffice",n="<div style='text-align:left'>"+h.escapeHtml(e.autoReplyInfos.message).replace(/\n/g,"<br/>")+"</div>",t={meetingDate:e.autoReplyInfos.until,message:n},r=e.autoReplyInfos.until?e.autoReplyInfos.untilDate?"calendarAutoReply-date":"calendarAutoReply":"calendarAutoReplySimple"):("busy"===e.message?(e.iconId="icon_inameeting",r=e.untilDate?"calendar-busy-date":"calendar-busy"):"out_of_office"===e.message&&(e.iconId="icon_outofoffice",r=e.untilDate?"calendar-outofoffice-date":"calendar-outofoffice"),t={meetingDate:e.until}),r&&(e.tooltip=a.instant(r,{meetingDate:t.meetingDate}),t.message&&(t.message=t.message.replace(/<script>/g,""),e.tooltip=o.trustAsHtml(e.tooltip+" "+t.message)))},f.prototype.displayNameForLog=function(){return config&&config.debug?this.displayName:this.displayNameMD5},f.prototype.isMobileResource=function(e){return-1!==e.indexOf("mobile_android")||-1!==e.indexOf("mobile_ios")},f.prototype.calculateStatusFromResources=function(e){var t="offline",n="",r="",i="",a=this.fullJid,o=!1,s=config.webrtcWithMobiles;for(var c in this.resources)if(this.resources.hasOwnProperty(c)){if("dnd"===this.resources[c].show&&"phone"===this.resources[c].status){t="busy",n="audioPhone",o=!0,a=c;break}if("xa"===this.resources[c].show||"dnd"===this.resources[c].show&&""===this.resources[c].status){var l=!1;this.resources[c].initStamp?r?this.resources[c].initStamp.getTime()>r.getTime()&&(r=this.resources[c].initStamp,l=!0):(r=this.resources[c].initStamp,l=!0):i?this.resources[c].stamp.getTime()>i.getTime()&&(i=this.resources[c].stamp,r=this.resources[c].stamp,l=!0):(i=this.resources[c].stamp,r=this.resources[c].stamp,l=!0),l&&(t=this.resources[c].show,n=this.resources[c].status)}else"xa"!==t&&("dnd"!==t||"dnd"===t&&""!==n)&&"dnd"===this.resources[c].show&&""!==this.resources[c].status?("presentation"===this.resources[c].status?(t=this.resources[c].show,n="presentation"):(t="busy",n=this.resources[c].status),a=c,o=!0):e&&"online"===this.resources[c].show&&"mode=auto"===this.resources[c].status&&c===this.fullJid?"busy"!==t&&"dnd"!==t&&"presentation"!==n&&(t="online",n="",this.resources[c].status="",this.isMobileResource(c)?t="online-mobile":o=!0):"online"===this.resources[c].show&&"xa"!==t&&"dnd"!==t&&"busy"!==t?(n="","online-mobile"!==t&&(t="online"),this.resources[c].status="",this.isMobileResource(c)?t="online-mobile":(a=c,o=!0),s&&(a=c)):"away"===this.resources[c].show&&"offline"===t&&(t="away",n="",a=c);"mode=auto"===this.resources[c].status&&(this.resources[c].status="")}for(var c in this.resources)this.resources.hasOwnProperty(c)&&"mode=auto"===this.resources[c].status&&(this.resources[c].status="");return e||this.fullJid||(this.fullJid=a),"online-mobile"===t&&o?(t="online",n=""):"online-mobile"===t&&!e&&!s&&(this.fullJid=null,n=""),{presence:t,message:n}},f.prototype.hasAdminRights=function(){return this.isSuperadmin()||this.isBusinessAdmin()||this.isAdmin()||this.isBPAdmin()},f.prototype.isSuperadmin=function(){return 0<=this.roles.indexOf("superadmin")},f.prototype.isBusinessAdmin=function(){return 0<=this.roles.indexOf("business_admin")},f.prototype.isCPaaSGuest=function(){return 0<=this.roles.indexOf("guest")},f.prototype.isGuest=function(){return this.guestMode},f.prototype.isAdmin=function(){return!(!(0<=this.roles.indexOf("admin"))||this.isOrganizationAdmin()&&this.isBPAdmin())},f.prototype.isOrganizationAdmin=function(){return 0<=this.roles.indexOf("admin")&&this.adminType===f.AdminType.ORGANIZATION_ADMIN},f.prototype.isCompanyAdmin=function(){return 0<=this.roles.indexOf("admin")&&this.adminType===f.AdminType.COMPANY_ADMIN},f.prototype.isSiteAdmin=function(){return 0<=this.roles.indexOf("admin")&&this.adminType===f.AdminType.SITE_ADMIN},f.prototype.getAdminType=function(){return 0<=this.roles.indexOf("admin")?this.adminType:f.AdminType.UNDEFINED},f.prototype.isBPAdmin=function(){return this.isBPAdminOperations()||this.isBPAdminFinance()},f.prototype.isBPAdminOperations=function(){return 0<=this.roles.indexOf("bp_admin")},f.prototype.isBPAdminFinance=function(){return 0<=this.roles.indexOf("bp_finance")},f.prototype.updateIMStatus=function(e,n){if(this.imStatusStamp[e.jid]&&this.imStatusStamp[e.jid]>e.stamp)l.info("[Contact] Ignore obsolete presence message for contact "+this.jid);else{l.info("[Contact] updateIMStatus "+JSON.stringify(e)),this.imStatusStamp[e.jid]=e.stamp,e.status&&(this.imStatus=e.status);var r=e.message?e.message:"";if("offline"===this.imStatus)this.fullJid===e.jid&&(this.fullJid=null),delete this.resources[e.jid],delete this.imStatusStamp[e.jid],0===this.resources.length&&(this.message="");else{this.resources[e.jid]?(this.resources[e.jid].show=this.imStatus,this.resources[e.jid].status=r,this.resources[e.jid].stamp=e.stamp):this.resources[e.jid]={show:this.imStatus,status:r,initStamp:e.stamp,stamp:e.stamp},l.info("[Contact] updateIMStatus user resources after update "+JSON.stringify(this.resources)),this.isMobileResource(e.jid)||n||(this.fullJid=e.jid);var i=config.webrtcWithMobiles;!n&&i&&(this.fullJid=e.jid)}if(this.updateRichStatus(n),n&&this.isMobileResource(e.jid)&&("offline"!==e.status&&null===this.mobileResource&&(this.mobileResource=e.jid,l.info("[Contact] updateIMStatus: post event ON_MOBILE_TELEPHONY_STATUS_CHANGED_EVENT"),t.$broadcast("ON_MOBILE_TELEPHONY_STATUS_CHANGED_EVENT","started")),"offline"===e.status)){var a=null;for(var o in this.resources)if(this.resources.hasOwnProperty(o)&&this.isMobileResource(o)){a=o;break}this.mobileResource=a,null===this.mobileResource&&t.$broadcast("ON_MOBILE_TELEPHONY_STATUS_CHANGED_EVENT","stopped")}}},f.prototype.updateTelephonyStatus=function(e,n){var r=this.telStatus;this.telStatus=e,this.updateRichStatus(n),n&&r!==this.telStatus&&t.$broadcast("ON_UPDATE_MYTELEPHONY_STATUS_EVENT")},f.prototype.updatePresenceStatus=function(e){this.status=e},f.prototype.updateRichStatus=function(e){if("EVT_SERVICE_INITIATED"===this.telStatus||"EVT_ESTABLISHED"===this.telStatus)this.status="busy",this.message="audioPhone";else if("subscribe"===this.ask)this.status="wait";else if("none"===this.subscription||"from"===this.subscription)this.status="unknown";else{var n=this.calculateStatusFromResources(e);"xa"===n.presence&&(""!==n.message||e?"away"===n.message&&(n.presence="away",n.message=""):n.presence="offline"),this.status=n.presence,this.message=n.message,e?l.info("[Contact] updateRichStatus MY PRESENCE : "+n.presence+" || message : "+n.message):l.info("[Contact] updateRichStatus presence : "+n.presence+" || message : "+n.message),"offline"!==this.status&&(this.lastActivityDate=null)}e&&t.$broadcast("ON_UPDATE_MYCONTACT_EVENT"),t.$broadcast("ON_UPDATE_CONTACT_RICH_STATUS_EVENT",this)},f.prototype.updateFromUserData=function(e){this.dbId=e.id,this.loginEmail=e.loginEmail,this.firstname=e.firstName,this.lastname=e.lastName,this.nickname=e.nickName?e.nickName:"",this.title=e.title?e.title:"",this.jobTitle=e.jobTitle?e.jobTitle:"",this.organisationId=e.organisationId,this.siteId=e.siteId,this.country=e.country?e.country:"FRA",this.timezone=e.timezone,this.roles=e.roles,this.adminType=e.adminType,this.isBot=!1,this.isTerminated=e.isTerminated,this.isInDefaultCompany=e.isInDefaultCompany,this.lastAvatarUpdateDate=e.lastAvatarUpdateDate,this.initialized=e.isInitialized,this.guestMode=!!e.guestMode&&e.guestMode,this.openInviteId=e.openInviteId?e.openInviteId:this.openInviteId,e.jid_im&&(this.id=e.jid_im,this.jid=e.jid_im,this.jidtel=e.jid_tel),this.company&&this.company.id===e.companyId||(this.company=c.create(e.companyId,e.companyName)),this.phonePro=this.phoneProCan="",this.phonePbx="",this.phoneInternalNumber="",this.pbxId="",this.mobilePro=this.mobileProCan="",this.phonePerso=this.phonePersoCan="",this.mobilePerso=this.mobilePersoCan="",this.voicemailNumber="",this.hasPhoneNumber=!1;var t=this;e.emails&&(t.emailPerso="",e.emails.forEach(function(e){switch(e.type){case"work":t.emailPro=e.email;break;case"home":t.emailPerso=e.email}})),e.phoneNumbers&&(e.phoneNumbers.forEach(function(e){var n=e.number,r=e.numberE164,i=e.deviceType;switch(t.hasPhoneNumber=!0,e.type){case"work":"landline"===i&&(t.phonePro=n,t.phoneProCan=r,e.isFromSystem&&(t.phonePbx=e.shortNumber,e.internalNumber&&(t.phoneInternalNumber=e.internalNumber,("Remote Extension"===e.deviceName||"Any Device"===e.deviceName)&&(t.isVirtualTerm=!0)),t.pbxId=e.pbxId,t.voicemailNumber=e.voiceMailNumber)),"mobile"===i&&(t.mobilePro=n,t.mobileProCan=r);break;case"home":"landline"===i&&(t.phonePerso=n,t.phonePersoCan=r),"mobile"===i&&(t.mobilePerso=n,t.mobilePersoCan=r)}}),this.phoneNumbersInitialized=!0),this.computeDisplayName()},f.prototype.updateName=function(e,t){this.firstname=e,this.lastname=t,this.computeDisplayName(),this.getAvatar()},f.prototype.getNameUpdatePrio=function(){return this.nameUpdatePrio},f.prototype.setNameUpdatePrio=function(e){switch(e){case f.NameUpdatePrio.NO_UPDATE_PRIO:case f.NameUpdatePrio.OUTLOOK_UPDATE_PRIO:case f.NameUpdatePrio.SERVER_UPDATE_PRIO:case f.NameUpdatePrio.MAX_UPDATE_PRIO:this.nameUpdatePrio=e}},f.prototype.containsEmail=function(e){var t=e.toLowerCase();return!(!this.loginEmail||this.loginEmail.toLowerCase()!==t)||!(!this.emailPro||this.emailPro.toLowerCase()!==t)||!(!this.emailPerso||this.emailPerso.toLowerCase()!==t)},f.prototype.computeDisplayName=function(){var e=this.firstname?this.firstname.charAt(0).toUpperCase()+this.firstname.slice(1):null,t=this.lastname?this.lastname.charAt(0).toUpperCase()+this.lastname.slice(1):null,n=this.nickname?this.nickname.charAt(0).toUpperCase()+this.nickname.slice(1):null;t&&e?this.computeCompleteDisplayName(e,t):t&&!e?(this.displayName=t,this.initials=t.charAt(0)):n?(this.displayName=n,this.initials=n.charAt(0)):this.loginEmail?(this.displayName=this.loginEmail,this.initials=this.loginEmail.substring(0,2).toUpperCase()):e?(this.displayName=e,this.initials=e.charAt(0)):(this.displayName="Anonymous",this.initials="A")},f.prototype.computeCompleteDisplayName=function(e,t){var n="",r="";1!==t.length&&2!==e.length?"FL"===s.getSetting("displayOrder")?(n=e+" "+t,r=e.charAt(0)+t.charAt(0)):(n=t+" "+e,r=t.charAt(0)+e.charAt(0)):(n="FL"===s.getSetting("displayOrder")?e+" "+t:t+" "+e,r=e.charAt(0)+e.charAt(1)),this.displayName=n,this.initials=r;for(var i=this.displayName.toUpperCase(),a=0,o=0;o<i.length;o++)a+=i.charCodeAt(o);this.colorIndex=a%12,this.color=f.textAvatarColor[this.colorIndex]},f.prototype.getAvatarInBase64=function(){var t=this,n=this;return e(function(e){try{if(t&&t.avatar&&t.avatar.src||e(),t.avatar.src&&!t.avatar.src.startsWith("data:image/png")){var r=new Image,a=i[0].createElement("canvas");a.width=120,a.height=120;var o=a.getContext("2d");o.rect(0,0,120,120),o.fillStyle=n.color,o.fill(),r.onload=function(){o.drawImage(this,0,0,120,120);var t=a.toDataURL("image/png");e(t)},r.src=t.avatar.src}else e(t.avatar.src)}catch(t){l.warn("[contactService] getAvatarInBase64 error "+t),e()}})},f.prototype.getAvatar=function(n,i){var a=this;if(a.dbId&&a.lastAvatarUpdateDate){var o=config.webservices.protocol+"://"+config.webservices.currentServer;t.cdn&&(o=t.cdnServer);var s=o+"/api/avatar/"+a.dbId+"?size="+(n||256);s+="&update="+Object(r.MD5)(r.enc.Latin1.parse(a.lastAvatarUpdateDate)).toString(r.enc.Hex),a.avatarSrc=s}return u.fromSDK?(a.createTextAvatarImage(),e.when()):e(function(e){a.createTextAvatarImage(),(i||!a.lastAvatarUpdateDate)&&(a.avatar=null),e(a)})},f.prototype.createTextAvatarImage=function(){var e=new Image,t=i[0].createElement("canvas");t.width=e.width=225,t.height=e.height=225;var n=t.getContext("2d");n.rect(0,0,225,225),n.fillStyle=this.color,n.fill(),n.font="bold 100px Helvetica",n.textAlign="center",n.fillStyle="white",n.fillText(this.initials,110,150),e.src=t.toDataURL("image/png"),this.defaultAvatar=e},f.prototype.getGroups=function(){return this.groups},f.prototype.setGroups=function(e){this.groups=e},f.prototype.getOpenInviteId=function(){return this.openInviteId},f.prototype.setOpenInviteId=function(e){this.openInviteId=e},f.prototype.getNameForLogs=function(){if(!this.nameForLogs&&this.displayName){var e=this.displayName.replace(/[^\s](?=.{1,}$)/g,"*");this.nameForLogs=this.displayName.charAt(0)+e.substr(1)}return this.nameForLogs},f.textAvatarColor=["#ff4500","#d38700","#348833","#007356","#00b2a9","#00b0e5","#0085ca","#6639b7","#91278a","#cf0072","#a50034","#d20000"],f}])},function(e,t,n){e.exports=function(e){return function(){if("function"==typeof ArrayBuffer){var t=e.lib,n=t.WordArray,r=n.init,i=n.init=function(e){if(e instanceof ArrayBuffer&&(e=new Uint8Array(e)),(e instanceof Int8Array||"undefined"!=typeof Uint8ClampedArray&&e instanceof Uint8ClampedArray||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array||e instanceof Float64Array)&&(e=new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),e instanceof Uint8Array){for(var t=e.byteLength,n=[],i=0;i<t;i++)n[i>>>2]|=e[i]<<24-i%4*8;r.call(this,n,t)}else r.apply(this,arguments)};i.prototype=n}}(),e.lib.WordArray}(n(0))},function(e,t,n){var r,i=String.fromCharCode;r=function(e){return function(){function t(e){return 4278255360&e<<8|16711935&e>>>8}var n=e,r=n.lib.WordArray,a=n.enc;a.Utf16=a.Utf16BE={stringify:function(e){for(var t,n=e.words,r=e.sigBytes,a=[],o=0;o<r;o+=2)t=65535&n[o>>>2]>>>16-o%4*8,a.push(i(t));return a.join("")},parse:function(e){for(var t=e.length,n=[],i=0;i<t;i++)n[i>>>1]|=e.charCodeAt(i)<<16-i%2*16;return r.create(n,2*t)}};a.Utf16LE={stringify:function(e){for(var n,r=e.words,a=e.sigBytes,o=[],s=0;s<a;s+=2)n=t(65535&r[s>>>2]>>>16-s%4*8),o.push(i(n));return o.join("")},parse:function(e){for(var n=e.length,i=[],a=0;a<n;a++)i[a>>>1]|=t(e.charCodeAt(a)<<16-a%2*16);return r.create(i,2*n)}}}(),e.enc.Utf16},e.exports=r(n(0))},function(e,t,n){e.exports=function(e){return n=(t=e).lib,r=n.WordArray,i=t.algo,a=i.SHA256,o=i.SHA224=a.extend({_doReset:function(){this._hash=new r.init([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428])},_doFinalize:function(){var e=a._doFinalize.call(this);return e.sigBytes-=4,e}}),t.SHA224=a._createHelper(o),t.HmacSHA224=a._createHmacHelper(o),e.SHA224;var t,n,r,i,a,o}(n(0),n(13))},function(e,t,n){e.exports=function(e){return n=(t=e).x64,r=n.Word,i=n.WordArray,a=t.algo,o=a.SHA512,s=a.SHA384=o.extend({_doReset:function(){this._hash=new i.init([new r.init(3418070365,3238371032),new r.init(1654270250,914150663),new r.init(2438529370,812702999),new r.init(355462360,4144912697),new r.init(1731405415,4290775857),new r.init(2394180231,1750603025),new r.init(3675008525,1694076839),new r.init(1203062813,3204075428)])},_doFinalize:function(){var e=o._doFinalize.call(this);return e.sigBytes-=16,e}}),t.SHA384=o._createHelper(s),t.HmacSHA384=o._createHmacHelper(s),e.SHA384;var t,n,r,i,a,o,s}(n(0),n(8),n(14))},function(e,t,n){e.exports=function(e){return function(t){var n=e,r=n.lib,i=r.WordArray,a=r.Hasher,o=n.x64,s=o.Word,c=n.algo,l=[],d=[],u=[];!function(){for(var e=1,t=0,n=0;24>n;n++){l[e+5*t]=(n+1)*(n+2)/2%64;var r=t%5,i=(2*e+3*t)%5;e=r,t=i}for(var e=0;5>e;e++)for(var t=0;5>t;t++)d[e+5*t]=t+(2*e+3*t)%5*5;for(var a=1,o=0;24>o;o++){for(var c=0,h=0,f=0;7>f;f++){if(1&a){var p=(1<<f)-1;32>p?h^=1<<p:c^=1<<p-32}128&a?a=113^a<<1:a<<=1}u[o]=s.create(c,h)}}();var h=[];!function(){for(var e=0;25>e;e++)h[e]=s.create()}();var f=c.SHA3=a.extend({cfg:a.cfg.extend({outputLength:512}),_doReset:function(){for(var e=this._state=[],t=0;25>t;t++)e[t]=new s.init;this.blockSize=(1600-2*this.cfg.outputLength)/32},_doProcessBlock:function(e,t){for(var n=this._state,r=this.blockSize/2,i=0;i<r;i++){var a=e[t+2*i],o=e[t+2*i+1];a=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8),o=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8);var s=n[i];s.high^=o,s.low^=a}for(var c=0;24>c;c++){for(var f=0;5>f;f++){for(var p=0,m=0,v=0;5>v;v++)s=n[f+5*v],p^=s.high,m^=s.low;var g=h[f];g.high=p,g.low=m}for(var f=0;5>f;f++)for(var C=h[(f+4)%5],S=h[(f+1)%5],E=S.high,b=S.low,p=C.high^(E<<1|b>>>31),m=C.low^(b<<1|E>>>31),v=0;5>v;v++)(s=n[f+5*v]).high^=p,s.low^=m;for(var y=1;25>y;y++){var s=n[y],R=s.high,T=s.low,I=l[y];if(32>I)var p=R<<I|T>>>32-I,m=T<<I|R>>>32-I;else var p=T<<I-32|R>>>64-I,m=R<<I-32|T>>>64-I;var A=h[d[y]];A.high=p,A.low=m}var N=h[0],O=n[0];N.high=O.high,N.low=O.low;for(var f=0;5>f;f++)for(var v=0;5>v;v++){var y=f+5*v,s=n[y],D=h[y],P=h[(f+1)%5+5*v],w=h[(f+2)%5+5*v];s.high=D.high^~P.high&w.high,s.low=D.low^~P.low&w.low}var s=n[0],_=u[c];s.high^=_.high,s.low^=_.low}},_doFinalize:function(){var e=this._data,n=e.words,r=(this._nDataBytes,8*e.sigBytes),a=32*this.blockSize;n[r>>>5]|=1<<24-r%32,n[(t.ceil((r+1)/a)*a>>>5)-1]|=128,e.sigBytes=4*n.length,this._process();for(var o=this._state,s=this.cfg.outputLength/8,c=[],l=0;l<s/8;l++){var d=o[l],u=d.high,h=d.low;u=16711935&(u<<8|u>>>24)|4278255360&(u<<24|u>>>8),h=16711935&(h<<8|h>>>24)|4278255360&(h<<24|h>>>8),c.push(h),c.push(u)}return new i.init(c,s)},clone:function(){for(var e=a.clone.call(this),t=e._state=this._state.slice(0),n=0;25>n;n++)t[n]=t[n].clone();return e}});n.SHA3=a._createHelper(f),n.HmacSHA3=a._createHmacHelper(f)}(Math),e.SHA3}(n(0),n(8))},function(e,t,n){e.exports=function(e){return function(){function t(e,t,n){return e^t^n}function n(e,t,n){return e&t|~e&n}function r(e,t,n){return(e|~t)^n}function i(e,t,n){return e&n|t&~n}function a(e,t,n){return e^(t|~n)}function o(e,t){return e<<t|e>>>32-t}var s=e,c=s.lib,l=c.WordArray,d=c.Hasher,u=s.algo,h=l.create([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13]),f=l.create([5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11]),p=l.create([11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6]),m=l.create([8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]),v=l.create([0,1518500249,1859775393,2400959708,2840853838]),g=l.create([1352829926,1548603684,1836072691,2053994217,0]),C=u.RIPEMD160=d.extend({_doReset:function(){this._hash=l.create([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,s){for(var c=0;16>c;c++){var l=s+c,d=e[l];e[l]=16711935&(d<<8|d>>>24)|4278255360&(d<<24|d>>>8)}var u,C,S,E,b,y,R,T,I,A,N=this._hash.words,O=v.words,D=g.words,P=h.words,w=f.words,_=p.words,M=m.words;y=u=N[0],R=C=N[1],T=S=N[2],I=E=N[3],A=b=N[4];for(var k,c=0;80>c;c+=1)k=0|u+e[s+P[c]],k+=16>c?t(C,S,E)+O[0]:32>c?n(C,S,E)+O[1]:48>c?r(C,S,E)+O[2]:64>c?i(C,S,E)+O[3]:a(C,S,E)+O[4],k=0|(k=o(k|=0,_[c]))+b,u=b,b=E,E=o(S,10),S=C,C=k,k=0|y+e[s+w[c]],k+=16>c?a(R,T,I)+D[0]:32>c?i(R,T,I)+D[1]:48>c?r(R,T,I)+D[2]:64>c?n(R,T,I)+D[3]:t(R,T,I)+D[4],k=0|(k=o(k|=0,M[c]))+A,y=A,A=I,I=o(T,10),T=R,R=k;k=0|N[1]+S+I,N[1]=0|N[2]+E+A,N[2]=0|N[3]+b+y,N[3]=0|N[4]+u+R,N[4]=0|N[0]+C+T,N[0]=k},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,r=8*e.sigBytes;t[r>>>5]|=128<<24-r%32,t[14+(r+64>>>9<<4)]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8),e.sigBytes=4*(t.length+1),this._process();for(var i,a=this._hash,o=a.words,s=0;5>s;s++)i=o[s],o[s]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8);return a},clone:function(){var e=d.clone.call(this);return e._hash=this._hash.clone(),e}});s.RIPEMD160=d._createHelper(C),s.HmacRIPEMD160=d._createHmacHelper(C)}(Math),e.RIPEMD160}(n(0))},function(e,t,n){e.exports=function(e){return n=(t=e).lib,r=n.Base,i=n.WordArray,a=t.algo,o=a.SHA1,s=a.HMAC,c=a.PBKDF2=r.extend({cfg:r.extend({keySize:4,hasher:o,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e)},compute:function(e,t){for(var n,r=this.cfg,a=s.create(r.hasher,e),o=i.create(),c=i.create([1]),l=o.words,d=c.words,u=r.keySize,h=r.iterations;l.length<u;){n=a.update(t).finalize(c),a.reset();for(var f=n.words,p=f.length,m=n,v=1;v<h;v++){m=a.finalize(m),a.reset();for(var g=m.words,C=0;C<p;C++)f[C]^=g[C]}o.concat(n),d[0]++}return o.sigBytes=4*u,o}}),t.PBKDF2=function(e,t,n){return c.create(n).compute(e,t)},e.PBKDF2;var t,n,r,i,a,o,s,c}(n(0),n(9),n(10))},function(e,t,n){e.exports=function(e){return e.mode.CFB=function(){function t(e,t,n,r){var i=this._iv;if(i){var a=i.slice(0);this._iv=void 0}else var a=this._prevBlock;r.encryptBlock(a,0);for(var o=0;o<n;o++)e[t+o]^=a[o]}var n=e.lib.BlockCipherMode.extend();return n.Encryptor=n.extend({processBlock:function(e,n){var r=this._cipher,i=r.blockSize;t.call(this,e,n,i,r),this._prevBlock=e.slice(n,n+i)}}),n.Decryptor=n.extend({processBlock:function(e,n){var r=this._cipher,i=r.blockSize,a=e.slice(n,n+i);t.call(this,e,n,i,r),this._prevBlock=a}}),n}(),e.mode.CFB}(n(0),n(2))},function(e,t,n){e.exports=function(e){return e.mode.CTR=(t=e.lib.BlockCipherMode.extend(),n=t.Encryptor=t.extend({processBlock:function(e,t){var n=this._cipher,r=n.blockSize,i=this._iv,a=this._counter;i&&(a=this._counter=i.slice(0),this._iv=void 0);var o=a.slice(0);n.encryptBlock(o,0),a[r-1]=0|a[r-1]+1;for(var s=0;s<r;s++)e[t+s]^=o[s]}}),t.Decryptor=n,t),e.mode.CTR;var t,n}(n(0),n(2))},function(e,t,n){e.exports=function(e){return e.mode.CTRGladman=function(){function t(e){if(255==(255&e>>24)){var t=255&e>>16,n=255&e>>8,r=255&e;255===t?(t=0,255===n?(n=0,255===r?r=0:++r):++n):++t,e=0,e+=t<<16,e+=n<<8,e+=r}else e+=16777216;return e}function n(e){return 0===(e[0]=t(e[0]))&&(e[1]=t(e[1])),e}var r=e.lib.BlockCipherMode.extend(),i=r.Encryptor=r.extend({processBlock:function(e,t){var r=this._cipher,i=r.blockSize,a=this._iv,o=this._counter;a&&(o=this._counter=a.slice(0),this._iv=void 0),n(o);var s=o.slice(0);r.encryptBlock(s,0);for(var c=0;c<i;c++)e[t+c]^=s[c]}});return r.Decryptor=i,r}(),e.mode.CTRGladman}(n(0),n(2))},function(e,t,n){e.exports=function(e){return e.mode.OFB=(t=e.lib.BlockCipherMode.extend(),n=t.Encryptor=t.extend({processBlock:function(e,t){var n=this._cipher,r=n.blockSize,i=this._iv,a=this._keystream;i&&(a=this._keystream=i.slice(0),this._iv=void 0),n.encryptBlock(a,0);for(var o=0;o<r;o++)e[t+o]^=a[o]}}),t.Decryptor=n,t),e.mode.OFB;var t,n}(n(0),n(2))},function(e,t,n){e.exports=function(e){return e.mode.ECB=((t=e.lib.BlockCipherMode.extend()).Encryptor=t.extend({processBlock:function(e,t){this._cipher.encryptBlock(e,t)}}),t.Decryptor=t.extend({processBlock:function(e,t){this._cipher.decryptBlock(e,t)}}),t),e.mode.ECB;var t}(n(0),n(2))},function(e,t,n){e.exports=function(e){return e.pad.AnsiX923={pad:function(e,t){var n=e.sigBytes,r=4*t,i=r-n%r,a=n+i-1;e.clamp(),e.words[a>>>2]|=i<<24-a%4*8,e.sigBytes+=i},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t}},e.pad.Ansix923}(n(0),n(2))},function(e,t,n){e.exports=function(e){return e.pad.Iso10126={pad:function(t,n){var r=4*n,i=r-t.sigBytes%r;t.concat(e.lib.WordArray.random(i-1)).concat(e.lib.WordArray.create([i<<24],1))},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t}},e.pad.Iso10126}(n(0),n(2))},function(e,t,n){e.exports=function(e){return e.pad.Iso97971={pad:function(t,n){t.concat(e.lib.WordArray.create([2147483648],1)),e.pad.ZeroPadding.pad(t,n)},unpad:function(t){e.pad.ZeroPadding.unpad(t),t.sigBytes--}},e.pad.Iso97971}(n(0),n(2))},function(e,t,n){e.exports=function(e){return e.pad.ZeroPadding={pad:function(e,t){var n=4*t;e.clamp(),e.sigBytes+=n-(e.sigBytes%n||n)},unpad:function(e){for(var t=e.words,n=e.sigBytes-1;!(255&t[n>>>2]>>>24-n%4*8);)n--;e.sigBytes=n+1}},e.pad.ZeroPadding}(n(0),n(2))},function(e,t,n){e.exports=function(e){return e.pad.NoPadding={pad:function(){},unpad:function(){}},e.pad.NoPadding}(n(0),n(2))},function(e,t,n){e.exports=function(e){return n=(t=e).lib,r=n.CipherParams,i=t.enc,a=i.Hex,t.format.Hex={stringify:function(e){return e.ciphertext.toString(a)},parse:function(e){var t=a.parse(e);return r.create({ciphertext:t})}},e.format.Hex;var t,n,r,i,a}(n(0),n(2))},function(e,t,n){e.exports=function(e){return function(){var t=e,n=t.lib,r=n.BlockCipher,i=t.algo,a=[],o=[],s=[],c=[],l=[],d=[],u=[],h=[],f=[],p=[];!function(){for(var e=[],t=0;256>t;t++)e[t]=128>t?t<<1:283^t<<1;for(var n,r=0,i=0,t=0;256>t;t++){n=(n=i^i<<1^i<<2^i<<3^i<<4)>>>8^255&n^99,a[r]=n,o[n]=r;var m=e[r],v=e[m],g=e[v],C=257*e[n]^16843008*n;s[r]=C<<24|C>>>8,c[r]=C<<16|C>>>16,l[r]=C<<8|C>>>24,d[r]=C;var C=16843009*g^65537*v^257*m^16843008*r;u[n]=C<<24|C>>>8,h[n]=C<<16|C>>>16,f[n]=C<<8|C>>>24,p[n]=C,r?(r=m^e[e[e[g^m]]],i^=e[e[i]]):r=i=1}}();var m=[0,1,2,4,8,16,32,64,128,27,54],v=i.AES=r.extend({_doReset:function(){if(!this._nRounds||this._keyPriorReset!==this._key){for(var e=this._keyPriorReset=this._key,t=e.words,n=e.sigBytes/4,r=this._nRounds=n+6,i=4*(r+1),o=this._keySchedule=[],s=0;s<i;s++)if(s<n)o[s]=t[s];else{var c=o[s-1];s%n?6<n&&4==s%n&&(c=a[c>>>24]<<24|a[255&c>>>16]<<16|a[255&c>>>8]<<8|a[255&c]):(c=a[(c=c<<8|c>>>24)>>>24]<<24|a[255&c>>>16]<<16|a[255&c>>>8]<<8|a[255&c],c^=m[0|s/n]<<24),o[s]=o[s-n]^c}for(var l=this._invKeySchedule=[],d=0;d<i;d++){if(s=i-d,d%4)var c=o[s];else var c=o[s-4];l[d]=4>d||4>=s?c:u[a[c>>>24]]^h[a[255&c>>>16]]^f[a[255&c>>>8]]^p[a[255&c]]}}},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._keySchedule,s,c,l,d,a)},decryptBlock:function(e,t){var n=e[t+1];e[t+1]=e[t+3],e[t+3]=n,this._doCryptBlock(e,t,this._invKeySchedule,u,h,f,p,o);var n=e[t+1];e[t+1]=e[t+3],e[t+3]=n},_doCryptBlock:function(e,t,n,r,i,a,o,s){for(var c=this._nRounds,l=e[t]^n[0],d=e[t+1]^n[1],u=e[t+2]^n[2],h=e[t+3]^n[3],f=4,p=1;p<c;p++){var m=r[l>>>24]^i[255&d>>>16]^a[255&u>>>8]^o[255&h]^n[f++],v=r[d>>>24]^i[255&u>>>16]^a[255&h>>>8]^o[255&l]^n[f++],g=r[u>>>24]^i[255&h>>>16]^a[255&l>>>8]^o[255&d]^n[f++],C=r[h>>>24]^i[255&l>>>16]^a[255&d>>>8]^o[255&u]^n[f++];l=m,d=v,u=g,h=C}var m=(s[l>>>24]<<24|s[255&d>>>16]<<16|s[255&u>>>8]<<8|s[255&h])^n[f++],v=(s[d>>>24]<<24|s[255&u>>>16]<<16|s[255&h>>>8]<<8|s[255&l])^n[f++],g=(s[u>>>24]<<24|s[255&h>>>16]<<16|s[255&l>>>8]<<8|s[255&d])^n[f++],C=(s[h>>>24]<<24|s[255&l>>>16]<<16|s[255&d>>>8]<<8|s[255&u])^n[f++];e[t]=m,e[t+1]=v,e[t+2]=g,e[t+3]=C},keySize:8});t.AES=r._createHelper(v)}(),e.AES}(n(0),n(4),n(5),n(3),n(2))},function(e,t,n){e.exports=function(e){return function(){function t(e,t){var n=(this._lBlock>>>e^this._rBlock)&t;this._rBlock^=n,this._lBlock^=n<<e}function n(e,t){var n=(this._rBlock>>>e^this._lBlock)&t;this._lBlock^=n,this._rBlock^=n<<e}var r=e,i=r.lib,a=i.WordArray,o=i.BlockCipher,s=r.algo,c=[57,49,41,33,25,17,9,1,58,50,42,34,26,18,10,2,59,51,43,35,27,19,11,3,60,52,44,36,63,55,47,39,31,23,15,7,62,54,46,38,30,22,14,6,61,53,45,37,29,21,13,5,28,20,12,4],l=[14,17,11,24,1,5,3,28,15,6,21,10,23,19,12,4,26,8,16,7,27,20,13,2,41,52,31,37,47,55,30,40,51,45,33,48,44,49,39,56,34,53,46,42,50,36,29,32],d=[1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28],u=[{0:8421888,268435456:32768,536870912:8421378,805306368:2,1073741824:512,1342177280:8421890,1610612736:8389122,1879048192:8388608,2147483648:514,2415919104:8389120,2684354560:33280,2952790016:8421376,3221225472:32770,3489660928:8388610,3758096384:0,4026531840:33282,134217728:0,402653184:8421890,671088640:33282,939524096:32768,1207959552:8421888,1476395008:512,1744830464:8421378,2013265920:2,2281701376:8389120,2550136832:33280,2818572288:8421376,3087007744:8389122,3355443200:8388610,3623878656:32770,3892314112:514,4160749568:8388608,1:32768,268435457:2,536870913:8421888,805306369:8388608,1073741825:8421378,1342177281:33280,1610612737:512,1879048193:8389122,2147483649:8421890,2415919105:8421376,2684354561:8388610,2952790017:33282,3221225473:514,3489660929:8389120,3758096385:32770,4026531841:0,134217729:8421890,402653185:8421376,671088641:8388608,939524097:512,1207959553:32768,1476395009:8388610,1744830465:2,2013265921:33282,2281701377:32770,2550136833:8389122,2818572289:514,3087007745:8421888,3355443201:8389120,3623878657:0,3892314113:33280,4160749569:8421378},{0:1074282512,16777216:16384,33554432:524288,50331648:1074266128,67108864:1073741840,83886080:1074282496,100663296:1073758208,117440512:16,134217728:540672,150994944:1073758224,167772160:1073741824,184549376:540688,201326592:524304,218103808:0,234881024:16400,251658240:1074266112,8388608:1073758208,25165824:540688,41943040:16,58720256:1073758224,75497472:1074282512,92274688:1073741824,109051904:524288,125829120:1074266128,142606336:524304,159383552:0,176160768:16384,192937984:1074266112,209715200:1073741840,226492416:540672,243269632:1074282496,260046848:16400,268435456:0,285212672:1074266128,301989888:1073758224,318767104:1074282496,335544320:1074266112,352321536:16,369098752:540688,385875968:16384,402653184:16400,419430400:524288,436207616:524304,452984832:1073741840,469762048:540672,486539264:1073758208,503316480:1073741824,520093696:1074282512,276824064:540688,293601280:524288,310378496:1074266112,327155712:16384,343932928:1073758208,360710144:1074282512,377487360:16,394264576:1073741824,411041792:1074282496,427819008:1073741840,444596224:1073758224,461373440:524304,478150656:0,494927872:16400,511705088:1074266128,528482304:540672},{0:260,1048576:0,2097152:67109120,3145728:65796,4194304:65540,5242880:67108868,6291456:67174660,7340032:67174400,8388608:67108864,9437184:67174656,10485760:65792,11534336:67174404,12582912:67109124,13631488:65536,14680064:4,15728640:256,524288:67174656,1572864:67174404,2621440:0,3670016:67109120,4718592:67108868,5767168:65536,6815744:65540,7864320:260,8912896:4,9961472:256,11010048:67174400,12058624:65796,13107200:65792,14155776:67109124,15204352:67174660,16252928:67108864,16777216:67174656,17825792:65540,18874368:65536,19922944:67109120,20971520:256,22020096:67174660,23068672:67108868,24117248:0,25165824:67109124,26214400:67108864,27262976:4,28311552:65792,29360128:67174400,30408704:260,31457280:65796,32505856:67174404,17301504:67108864,18350080:260,19398656:67174656,20447232:0,21495808:65540,22544384:67109120,23592960:256,24641536:67174404,25690112:65536,26738688:67174660,27787264:65796,28835840:67108868,29884416:67109124,30932992:67174400,31981568:4,33030144:65792},{0:2151682048,65536:2147487808,131072:4198464,196608:2151677952,262144:0,327680:4198400,393216:2147483712,458752:4194368,524288:2147483648,589824:4194304,655360:64,720896:2147487744,786432:2151678016,851968:4160,917504:4096,983040:2151682112,32768:2147487808,98304:64,163840:2151678016,229376:2147487744,294912:4198400,360448:2151682112,425984:0,491520:2151677952,557056:4096,622592:2151682048,688128:4194304,753664:4160,819200:2147483648,884736:4194368,950272:4198464,1015808:2147483712,1048576:4194368,1114112:4198400,1179648:2147483712,1245184:0,1310720:4160,1376256:2151678016,1441792:2151682048,1507328:2147487808,1572864:2151682112,1638400:2147483648,1703936:2151677952,1769472:4198464,1835008:2147487744,1900544:4194304,1966080:64,2031616:4096,1081344:2151677952,1146880:2151682112,1212416:0,1277952:4198400,1343488:4194368,1409024:2147483648,1474560:2147487808,1540096:64,1605632:2147483712,1671168:4096,1736704:2147487744,1802240:2151678016,1867776:4160,1933312:2151682048,1998848:4194304,2064384:4198464},{0:128,4096:17039360,8192:262144,12288:536870912,16384:537133184,20480:16777344,24576:553648256,28672:262272,32768:16777216,36864:537133056,40960:536871040,45056:553910400,49152:553910272,53248:0,57344:17039488,61440:553648128,2048:17039488,6144:553648256,10240:128,14336:17039360,18432:262144,22528:537133184,26624:553910272,30720:536870912,34816:537133056,38912:0,43008:553910400,47104:16777344,51200:536871040,55296:553648128,59392:16777216,63488:262272,65536:262144,69632:128,73728:536870912,77824:553648256,81920:16777344,86016:553910272,90112:537133184,94208:16777216,98304:553910400,102400:553648128,106496:17039360,110592:537133056,114688:262272,118784:536871040,122880:0,126976:17039488,67584:553648256,71680:16777216,75776:17039360,79872:537133184,83968:536870912,88064:17039488,92160:128,96256:553910272,100352:262272,104448:553910400,108544:0,112640:553648128,116736:16777344,120832:262144,124928:537133056,129024:536871040},{0:268435464,256:8192,512:270532608,768:270540808,1024:268443648,1280:2097152,1536:2097160,1792:268435456,2048:0,2304:268443656,2560:2105344,2816:8,3072:270532616,3328:2105352,3584:8200,3840:270540800,128:270532608,384:270540808,640:8,896:2097152,1152:2105352,1408:268435464,1664:268443648,1920:8200,2176:2097160,2432:8192,2688:268443656,2944:270532616,3200:0,3456:270540800,3712:2105344,3968:268435456,4096:268443648,4352:270532616,4608:270540808,4864:8200,5120:2097152,5376:268435456,5632:268435464,5888:2105344,6144:2105352,6400:0,6656:8,6912:270532608,7168:8192,7424:268443656,7680:270540800,7936:2097160,4224:8,4480:2105344,4736:2097152,4992:268435464,5248:268443648,5504:8200,5760:270540808,6016:270532608,6272:270540800,6528:270532616,6784:8192,7040:2105352,7296:2097160,7552:0,7808:268435456,8064:268443656},{0:1048576,16:33555457,32:1024,48:1049601,64:34604033,80:0,96:1,112:34603009,128:33555456,144:1048577,160:33554433,176:34604032,192:34603008,208:1025,224:1049600,240:33554432,8:34603009,24:0,40:33555457,56:34604032,72:1048576,88:33554433,104:33554432,120:1025,136:1049601,152:33555456,168:34603008,184:1048577,200:1024,216:34604033,232:1,248:1049600,256:33554432,272:1048576,288:33555457,304:34603009,320:1048577,336:33555456,352:34604032,368:1049601,384:1025,400:34604033,416:1049600,432:1,448:0,464:34603008,480:33554433,496:1024,264:1049600,280:33555457,296:34603009,312:1,328:33554432,344:1048576,360:1025,376:34604032,392:33554433,408:34603008,424:0,440:34604033,456:1049601,472:1024,488:33555456,504:1048577},{0:134219808,1:131072,2:134217728,3:32,4:131104,5:134350880,6:134350848,7:2048,8:134348800,9:134219776,10:133120,11:134348832,12:2080,13:0,14:134217760,15:133152,2147483648:2048,2147483649:134350880,2147483650:134219808,2147483651:134217728,2147483652:134348800,2147483653:133120,2147483654:133152,2147483655:32,2147483656:134217760,2147483657:2080,2147483658:131104,2147483659:134350848,2147483660:0,2147483661:134348832,2147483662:134219776,2147483663:131072,16:133152,17:134350848,18:32,19:2048,20:134219776,21:134217760,22:134348832,23:131072,24:0,25:131104,26:134348800,27:134219808,28:134350880,29:133120,30:2080,31:134217728,2147483664:131072,2147483665:2048,2147483666:134348832,2147483667:133152,2147483668:32,2147483669:134348800,2147483670:134217728,2147483671:134219808,2147483672:134350880,2147483673:134217760,2147483674:134219776,2147483675:0,2147483676:133120,2147483677:2080,2147483678:131104,2147483679:134350848}],h=[4160749569,528482304,33030144,2064384,129024,8064,504,2147483679],f=s.DES=o.extend({_doReset:function(){for(var e,t=this._key,n=t.words,r=[],i=0;56>i;i++)e=c[i]-1,r[i]=1&n[e>>>5]>>>31-e%32;for(var a=this._subKeys=[],o=0;16>o;o++){for(var s=a[o]=[],u=d[o],i=0;24>i;i++)s[0|i/6]|=r[(l[i]-1+u)%28]<<31-i%6,s[4+(0|i/6)]|=r[28+(l[i+24]-1+u)%28]<<31-i%6;s[0]=s[0]<<1|s[0]>>>31;for(var i=1;7>i;i++)s[i]>>>=4*(i-1)+3;s[7]=s[7]<<5|s[7]>>>27}for(var h=this._invSubKeys=[],i=0;16>i;i++)h[i]=a[15-i]},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._subKeys)},decryptBlock:function(e,t){this._doCryptBlock(e,t,this._invSubKeys)},_doCryptBlock:function(e,r,i){this._lBlock=e[r],this._rBlock=e[r+1],t.call(this,4,252645135),t.call(this,16,65535),n.call(this,2,858993459),n.call(this,8,16711935),t.call(this,1,1431655765);for(var a=0;16>a;a++){for(var o=i[a],s=this._lBlock,c=this._rBlock,l=0,d=0;8>d;d++)l|=u[d][((c^o[d])&h[d])>>>0];this._lBlock=c,this._rBlock=s^l}var f=this._lBlock;this._lBlock=this._rBlock,this._rBlock=f,t.call(this,1,1431655765),n.call(this,8,16711935),n.call(this,2,858993459),t.call(this,16,65535),t.call(this,4,252645135),e[r]=this._lBlock,e[r+1]=this._rBlock},keySize:2,ivSize:2,blockSize:2});r.DES=o._createHelper(f);var p=s.TripleDES=o.extend({_doReset:function(){var e=this._key,t=e.words;this._des1=f.createEncryptor(a.create(t.slice(0,2))),this._des2=f.createEncryptor(a.create(t.slice(2,4))),this._des3=f.createEncryptor(a.create(t.slice(4,6)))},encryptBlock:function(e,t){this._des1.encryptBlock(e,t),this._des2.decryptBlock(e,t),this._des3.encryptBlock(e,t)},decryptBlock:function(e,t){this._des3.decryptBlock(e,t),this._des2.encryptBlock(e,t),this._des1.decryptBlock(e,t)},keySize:6,ivSize:2,blockSize:2});r.TripleDES=o._createHelper(p)}(),e.TripleDES}(n(0),n(4),n(5),n(3),n(2))},function(e,t,n){e.exports=function(e){return function(){function t(){for(var e=this._S,t=this._i,n=this._j,r=0,i=0;4>i;i++){n=(n+e[t=(t+1)%256])%256;var a=e[t];e[t]=e[n],e[n]=a,r|=e[(e[t]+e[n])%256]<<24-8*i}return this._i=t,this._j=n,r}var n=e,r=n.lib,i=r.StreamCipher,a=n.algo,o=a.RC4=i.extend({_doReset:function(){for(var e=this._key,t=e.words,n=e.sigBytes,r=this._S=[],i=0;256>i;i++)r[i]=i;for(var i=0,a=0;256>i;i++){var o=i%n,s=255&t[o>>>2]>>>24-o%4*8;a=(a+r[i]+s)%256;var c=r[i];r[i]=r[a],r[a]=c}this._i=this._j=0},_doProcessBlock:function(e,n){e[n]^=t.call(this)},keySize:8,ivSize:0});n.RC4=i._createHelper(o);var s=a.RC4Drop=o.extend({cfg:o.cfg.extend({drop:192}),_doReset:function(){o._doReset.call(this);for(var e=this.cfg.drop;0<e;e--)t.call(this)}});n.RC4Drop=i._createHelper(s)}(),e.RC4}(n(0),n(4),n(5),n(3),n(2))},function(e,t,n){e.exports=function(e){return function(){function t(){for(var e=this._X,t=this._C,n=0;8>n;n++)s[n]=t[n];t[0]=0|t[0]+1295307597+this._b,t[1]=0|t[1]+3545052371+(t[0]>>>0<s[0]>>>0?1:0),t[2]=0|t[2]+886263092+(t[1]>>>0<s[1]>>>0?1:0),t[3]=0|t[3]+1295307597+(t[2]>>>0<s[2]>>>0?1:0),t[4]=0|t[4]+3545052371+(t[3]>>>0<s[3]>>>0?1:0),t[5]=0|t[5]+886263092+(t[4]>>>0<s[4]>>>0?1:0),t[6]=0|t[6]+1295307597+(t[5]>>>0<s[5]>>>0?1:0),t[7]=0|t[7]+3545052371+(t[6]>>>0<s[6]>>>0?1:0),this._b=t[7]>>>0<s[7]>>>0?1:0;for(var n=0;8>n;n++){var r=e[n]+t[n],i=65535&r,a=r>>>16;c[n]=((i*i>>>17)+i*a>>>15)+a*a^(0|(4294901760&r)*r)+(0|(65535&r)*r)}e[0]=0|c[0]+(c[7]<<16|c[7]>>>16)+(c[6]<<16|c[6]>>>16),e[1]=0|c[1]+(c[0]<<8|c[0]>>>24)+c[7],e[2]=0|c[2]+(c[1]<<16|c[1]>>>16)+(c[0]<<16|c[0]>>>16),e[3]=0|c[3]+(c[2]<<8|c[2]>>>24)+c[1],e[4]=0|c[4]+(c[3]<<16|c[3]>>>16)+(c[2]<<16|c[2]>>>16),e[5]=0|c[5]+(c[4]<<8|c[4]>>>24)+c[3],e[6]=0|c[6]+(c[5]<<16|c[5]>>>16)+(c[4]<<16|c[4]>>>16),e[7]=0|c[7]+(c[6]<<8|c[6]>>>24)+c[5]}var n=e,r=n.lib,i=r.StreamCipher,a=n.algo,o=[],s=[],c=[],l=a.Rabbit=i.extend({_doReset:function(){for(var e=this._key.words,n=this.cfg.iv,r=0;4>r;r++)e[r]=16711935&(e[r]<<8|e[r]>>>24)|4278255360&(e[r]<<24|e[r]>>>8);var i=this._X=[e[0],e[3]<<16|e[2]>>>16,e[1],e[0]<<16|e[3]>>>16,e[2],e[1]<<16|e[0]>>>16,e[3],e[2]<<16|e[1]>>>16],a=this._C=[e[2]<<16|e[2]>>>16,4294901760&e[0]|65535&e[1],e[3]<<16|e[3]>>>16,4294901760&e[1]|65535&e[2],e[0]<<16|e[0]>>>16,4294901760&e[2]|65535&e[3],e[1]<<16|e[1]>>>16,4294901760&e[3]|65535&e[0]];this._b=0;for(var r=0;4>r;r++)t.call(this);for(var r=0;8>r;r++)a[r]^=i[7&r+4];if(n){var o=n.words,s=o[0],c=o[1],l=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),d=16711935&(c<<8|c>>>24)|4278255360&(c<<24|c>>>8),u=l>>>16|4294901760&d,h=d<<16|65535&l;a[0]^=l,a[1]^=u,a[2]^=d,a[3]^=h,a[4]^=l,a[5]^=u,a[6]^=d,a[7]^=h;for(var r=0;4>r;r++)t.call(this)}},_doProcessBlock:function(e,n){var r=this._X;t.call(this),o[0]=r[0]^r[5]>>>16^r[3]<<16,o[1]=r[2]^r[7]>>>16^r[5]<<16,o[2]=r[4]^r[1]>>>16^r[7]<<16,o[3]=r[6]^r[3]>>>16^r[1]<<16;for(var i=0;4>i;i++)o[i]=16711935&(o[i]<<8|o[i]>>>24)|4278255360&(o[i]<<24|o[i]>>>8),e[n+i]^=o[i]},blockSize:4,ivSize:2});n.Rabbit=i._createHelper(l)}(),e.Rabbit}(n(0),n(4),n(5),n(3),n(2))},function(e,t,n){e.exports=function(e){return function(){function t(){for(var e=this._X,t=this._C,n=0;8>n;n++)s[n]=t[n];t[0]=0|t[0]+1295307597+this._b,t[1]=0|t[1]+3545052371+(t[0]>>>0<s[0]>>>0?1:0),t[2]=0|t[2]+886263092+(t[1]>>>0<s[1]>>>0?1:0),t[3]=0|t[3]+1295307597+(t[2]>>>0<s[2]>>>0?1:0),t[4]=0|t[4]+3545052371+(t[3]>>>0<s[3]>>>0?1:0),t[5]=0|t[5]+886263092+(t[4]>>>0<s[4]>>>0?1:0),t[6]=0|t[6]+1295307597+(t[5]>>>0<s[5]>>>0?1:0),t[7]=0|t[7]+3545052371+(t[6]>>>0<s[6]>>>0?1:0),this._b=t[7]>>>0<s[7]>>>0?1:0;for(var n=0;8>n;n++){var r=e[n]+t[n],i=65535&r,a=r>>>16;c[n]=((i*i>>>17)+i*a>>>15)+a*a^(0|(4294901760&r)*r)+(0|(65535&r)*r)}e[0]=0|c[0]+(c[7]<<16|c[7]>>>16)+(c[6]<<16|c[6]>>>16),e[1]=0|c[1]+(c[0]<<8|c[0]>>>24)+c[7],e[2]=0|c[2]+(c[1]<<16|c[1]>>>16)+(c[0]<<16|c[0]>>>16),e[3]=0|c[3]+(c[2]<<8|c[2]>>>24)+c[1],e[4]=0|c[4]+(c[3]<<16|c[3]>>>16)+(c[2]<<16|c[2]>>>16),e[5]=0|c[5]+(c[4]<<8|c[4]>>>24)+c[3],e[6]=0|c[6]+(c[5]<<16|c[5]>>>16)+(c[4]<<16|c[4]>>>16),e[7]=0|c[7]+(c[6]<<8|c[6]>>>24)+c[5]}var n=e,r=n.lib,i=r.StreamCipher,a=n.algo,o=[],s=[],c=[],l=a.RabbitLegacy=i.extend({_doReset:function(){var e=this._key.words,n=this.cfg.iv,r=this._X=[e[0],e[3]<<16|e[2]>>>16,e[1],e[0]<<16|e[3]>>>16,e[2],e[1]<<16|e[0]>>>16,e[3],e[2]<<16|e[1]>>>16],i=this._C=[e[2]<<16|e[2]>>>16,4294901760&e[0]|65535&e[1],e[3]<<16|e[3]>>>16,4294901760&e[1]|65535&e[2],e[0]<<16|e[0]>>>16,4294901760&e[2]|65535&e[3],e[1]<<16|e[1]>>>16,4294901760&e[3]|65535&e[0]];this._b=0;for(var a=0;4>a;a++)t.call(this);for(var a=0;8>a;a++)i[a]^=r[7&a+4];if(n){var o=n.words,s=o[0],c=o[1],l=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),d=16711935&(c<<8|c>>>24)|4278255360&(c<<24|c>>>8),u=l>>>16|4294901760&d,h=d<<16|65535&l;i[0]^=l,i[1]^=u,i[2]^=d,i[3]^=h,i[4]^=l,i[5]^=u,i[6]^=d,i[7]^=h;for(var a=0;4>a;a++)t.call(this)}},_doProcessBlock:function(e,n){var r=this._X;t.call(this),o[0]=r[0]^r[5]>>>16^r[3]<<16,o[1]=r[2]^r[7]>>>16^r[5]<<16,o[2]=r[4]^r[1]>>>16^r[7]<<16,o[3]=r[6]^r[3]>>>16^r[1]<<16;for(var i=0;4>i;i++)o[i]=16711935&(o[i]<<8|o[i]>>>24)|4278255360&(o[i]<<24|o[i]>>>8),e[n+i]^=o[i]},blockSize:4,ivSize:2});n.RabbitLegacy=i._createHelper(l)}(),e.RabbitLegacy}(n(0),n(4),n(5),n(3),n(2))},function(){function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}angular.module("rainbow").factory("Conversation",["$log","$rootScope","$interval","$filter","contactService","xmppService","Message","uuid4","utilService","fileStorageService","fileServerService","$q","fileViewerFactory","Call","roomService","pstnConferenceService",function(t,n,r,i,a,o,s,c,l,d,u,h,f,p,m,v){"use strict";function g(e){this.id=e,this.dbId=null,this.type=null,this.owner=null,this.contact=null,this.room=null,this.capabilities=null,this.avatar=null,this.presenceStatus=null,this.name=function(){return{}},this.filterName="",this.missedCounter=0,this.missedCalls=0,this.messages=[],this.participantStatuses={},this.draft="",this.status=g.Status.ACTIVE,this.historyIndex=-1,this.historyMessages=[],this.historyDefered=null,this.historyComplete=!1,this.lastModification=void 0,this.creationDate=new Date,this.lastMessageText="",this.lastMessageSender="",this.pip=!0,this.videoCall={status:p.Status.UNKNOWN},this.audioCall=null,this.pstnConferenceSession=null,this.webConferenceSession=null,this.isMutedAudio=!1,this.isMutedVideo=!1,this.infoVisible=!1,this.muted=!1,this.isFavorite=!1,this.lastEditableMsg=null,this.cacheMessages=[]}g.ChatstatesNS="http://jabber.org/protocol/chatstates",g.ReceiptNS="urn:xmpp:receipts",g.Type={ONE_TO_ONE:0,ROOM:1,BOT:2},g.EventType={NEW:0,IM:1,CAPABILITIES:2,FILE:3},g.Status={ACTIVE:{key:0,value:"active"},INACTIVE:{key:1,value:"inactive"},COMPOSING:{key:2,value:"composing"},PAUSED:{key:3,value:"paused"}},g.createOneToOneConversation=function(e){t.info("[Conversation] Create one to one conversation ("+e.id+")");var n=new g(e.id);return n.contact=e,e.conversation=n,e.isBot?(n.avatar="",n.type=g.Type.BOT):(n.avatar=e.avatar?e.avatar.src:null,n.type=g.Type.ONE_TO_ONE),n.name=e.name,e.displayName&&(n.filterName=l.removeDiacritis(e.displayName.toLowerCase())),n},g.createRoomConversation=function(e){t.info("[Conversation] Create room conversation ("+e.jid+")");var n=new g(e.jid);return n.type=g.Type.ROOM,n.room=e,n.filterName=l.removeDiacritis(e.name.toLowerCase()),n.infoVisible=!0,n};var C=c.generate(),S=0;return g.getUniqueMessageId=function(){var e="web_"+C+S;return S++,e},g.stringToStatus=function(e){return"composing"===e?g.Status.COMPOSING:"paused"===e?g.Status.PAUSED:g.Status.ACTIVE},g.prototype.reset=function(){this.messages=[],this.historyIndex=-1,this.historyMessages=[],this.historyComplete=!1,this.currentHistoryId=null,this.lastMessageText=null,this.chatRenderer&&this.chatRenderer.removeAllMessages()},g.prototype.isInCall=function(){return this.pstnConferenceSession?this.pstnConferenceSession.isParticipantConnectedByJid(a.userContact.jid):this.webConferenceSession?this.webConferenceSession.isParticipantConnectedByJid(a.userContact.jid):this.videoCall&&this.videoCall.status&&"Unknown"!==this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"Unknown"!==this.audioCall.status.value&&"incommingCall"!==this.audioCall.status.value&&"queued"!==this.audioCall.status.value},g.prototype.isNotInCall=function(){return!(this.videoCall&&this.videoCall.status&&"Unknown"!==this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"Unknown"!==this.audioCall.status.value||"busy"===a.userContact.status&&""!==a.userContact.message)},g.prototype.isActive=function(){return this.videoCall&&this.videoCall.status&&"active"===this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"active"===this.audioCall.status.value},g.prototype.isHeld=function(){return this.videoCall&&this.videoCall.status&&"held"===this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"held"===this.audioCall.status.value},g.prototype.getMessageById=function(e,t){if(t){var n=this.cacheMessages.find(function(t){return t.id===e});if(n)return n}return this.messages.find(function(t){return t.id===e||!!(0<t.replaceMsgs.length)&&t.replaceMsgs.find(function(t){return t.id===e})})},g.prototype.getMessageByIdInHistory=function(e){return this.historyMessages.find(function(t){return t.id===e})},g.prototype.sendChatMessage=function(e,t){var n=i("emojiShortToUnicode")(e),c=null,l=this,d=g.getUniqueMessageId();if(this.type===g.Type.ONE_TO_ONE){var u=this.contact.jid;c=$msg({to:u,type:"chat",id:d,"xml:lang":a.currentLanguage}).c("body",{"xml:lang":a.currentLanguage}).t(n).up().c("request",{xmlns:g.ReceiptNS}).up().c("active",{xmlns:g.ChatstatesNS}).up()}else c=$msg({to:this.room.jid,type:"groupchat",id:d}).c("body",{"xml:lang":a.currentLanguage}).t(n).up().c("request",{xmlns:g.ReceiptNS}).up().c("active",{xmlns:g.ChatstatesNS}).up();var h=null,f=null;t&&(c=c.c("answeredMsg",{stamp:t.date.getTime()}).t(t.id).up(),h=t.id,f=t.date);var p=null;return(p=this.addChatMessage(a.userContact,new Date,n,d,!0,null,null,h,f))?(p.serverAckTimer=r(function(){p.receiptStatus=s.ReceiptStatus.ERROR,l.updateMessage(p)},1e4),o.send(c),p):null},g.prototype.sendCorrectedChatMessage=function(e,n,c){t.info("[Conversation] >sendCorrectedChatMessage: origMsgId="+c),this.sendAckReadMessages();var l=i("emojiShortToUnicode")(n),d=null,u=this,h=g.getUniqueMessageId();if(t.info("[Conversation] >sendCorrectedChatMessage: messageToSendID="+h),this.type===g.Type.ONE_TO_ONE){var f=this.contact.jid;d=$msg({to:f,type:"chat",id:h,"xml:lang":a.currentLanguage}).c("body",{"xml:lang":a.currentLanguage}).t(l).up().c("replace",{id:c,xmlns:"urn:xmpp:message-correct:0"}).up().c("store",{xmlns:"urn:xmpp:hints"}).up().c("request",{xmlns:g.ReceiptNS}).up().c("active",{xmlns:g.ChatstatesNS}).up()}else d=$msg({to:this.room.jid,type:"groupchat",id:h}).c("body",{"xml:lang":a.currentLanguage}).t(l).up().c("replace",{id:c,xmlns:"urn:xmpp:message-correct:0"}).t(l).up().c("store",{xmlns:"urn:xmpp:hints"}).up().c("request",{xmlns:g.ReceiptNS}).up().c("active",{xmlns:g.ChatstatesNS}).up();return e?(e.serverAckTimer=r(function(){e.receiptStatus=s.ReceiptStatus.ERROR,u.updateMessage(e)},1e4),e.addReplaceMsg(h,n),o.send(d),h):null},g.prototype.sendIsTypingState=function(e){var t=null,n=g.getUniqueMessageId(),r=e?"composing":"active";if(this.type===g.Type.ONE_TO_ONE){var i=this.contact.jid;t=$msg({to:i,type:"chat",id:n,"xml:lang":a.currentLanguage}).c(r,{xmlns:g.ChatstatesNS}).up()}else t=$msg({to:this.room.jid,type:"groupchat",id:n}).c(r,{xmlns:g.ChatstatesNS}).up();o.send(t)},g.prototype.sendRecordingMessage=function(e){var t=i("emojiShortToUnicode")(e),n=null,c=this,l=g.getUniqueMessageId();if(this.type===g.Type.ONE_TO_ONE){var d=this.contact.jid;n=$msg({to:d,type:"chat",id:l,"xml:lang":a.currentLanguage}).c("body",{"xml:lang":a.currentLanguage}).up().c("recording",{xmlns:"jabber:iq:recordingP2P"}).t(t).up().c("request",{xmlns:g.ReceiptNS}).up().c("active",{xmlns:g.ChatstatesNS}).up()}e=null;return(e=this.addRecordingMessage(a.userContact,new Date,t,l))?(e.serverAckTimer=r(function(){e.receiptStatus=s.ReceiptStatus.ERROR,c.updateMessage(e)},1e4),o.send(n),e):null},g.prototype.sendExistingFSMessage=function(e,t){if(!e)return null;var n=i("emojiShortToUnicode")(e.data),r=null,c=e.id;if(this.type===g.Type.ONE_TO_ONE){var l=this.contact.jid;r=$msg({to:l,type:"chat",id:c,"xml:lang":a.currentLanguage}).c("body",{"xml:lang":a.currentLanguage}).t(n).up().c("request",{xmlns:g.ReceiptNS}).up().c("active",{xmlns:g.ChatstatesNS}).up()}else r=$msg({to:this.room.jid,type:"groupchat",id:c}).c("body",{"xml:lang":a.currentLanguage}).t(n).up().c("request",{xmlns:g.ReceiptNS}).up().c("active",{xmlns:g.ChatstatesNS}).up();var d=config.restServerUrl+"/api/rainbow/fileserver/v1.0/files/"+t.id;return r.c("x",{xmlns:"jabber:x:oob"}).c("url",{},d).c("mime",{},t.typeMIME).c("filename",{},t.fileName).c("size",{},t.size).up().c("store",{xmlns:"urn:xmpp:hints"}),e.fileId=t.id,e.setReceiptStatus(s.ReceiptStatus.SENT),this.updateMessage(e),o.send(r),e},g.prototype.sendAckReceivedMessage=function(e){if(!(e.receiptStatus>=s.ReceiptStatus.UNREAD)){t.info("[Conversation] "+this.id+" send received ack for message "+e.id);var n=this.type===g.Type.ONE_TO_ONE?this.contact.jid:this.room.jid,r=a.userContact.jid,i=$msg({to:n,from:r,type:"chat"}).c("received",{xmlns:g.ReceiptNS,event:"received",entity:"client",id:e.id});this.type!==g.Type.ONE_TO_ONE&&(i=$msg({to:n,from:r,type:"groupchat"}).c("received",{xmlns:g.ReceiptNS,event:"received",entity:"client",type:"muc",id:e.id})),o.send(i),e.setReceiptStatus(s.ReceiptStatus.UNREAD)}},g.prototype.sendAckReadMessage=function(e){if(e.receiptStatus!==s.ReceiptStatus.READ){t.info("[Conversation] "+this.id+" send read ack for message "+e.id);var n=this.type===g.Type.ONE_TO_ONE?this.contact.jid:this.room.jid,r=a.userContact.jid,i=$msg({to:n,from:r,type:"chat"}).c("received",{xmlns:g.ReceiptNS,event:"read",entity:"client",id:e.id});this.type!==g.Type.ONE_TO_ONE&&(i=$msg({to:n,from:r,type:"groupchat"}).c("received",{xmlns:g.ReceiptNS,event:"read",entity:"client",type:"muc",id:e.id})),o.send(i),e.setReceiptStatus(s.ReceiptStatus.READ)}},g.prototype.sendAckReadMessages=function(){t.info("[Conversation] "+this.id+" sendAckReadMessages");var e=!1,n=this;return this.messages.forEach(function(t){(t.receiptStatus===s.ReceiptStatus.SENT||t.receiptStatus===s.ReceiptStatus.UNREAD)&&(t.side===s.Side.LEFT||t.side===s.Side.ADMIN)&&(n.sendAckReadMessage(t),e=!0)}),e},g.prototype.sendFSMessage=function(r,i){t.debug("[conversation] >sendFSMessage");var a,o,c=h.defer(),l=this,p=r.name.split(".").pop(),m=r.type,v="object"===e(i)?i:void 0;return a=this.type===g.Type.ONE_TO_ONE?f([{viewerId:this.contact.dbId,type:"user"}]):f([{viewerId:this.room.dbId,type:"room"}]),d.createFileDescriptor(r.name,p,r.size,a).then(function(e){return o=e,e.fileToSend=r,e.isImage()&&r.preview&&(e.previewBlob=r.preview),v||(v=l.addFSMessage(e.id,m,i,"uploading")),v.fileId=e.id,v.fileName=e.fileName,e.state="uploading",n.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:e,cancelable:!0}),u.uploadAFileByChunk(e,r,v,null).then(function(){return t.debug("uploadAFileByChunk success"),h.resolve(e)},function(e){t.debug("uploadAFileByChunk error"),d.deleteFileDescriptor(o.id);var r=e.translatedMessage?e.translatedMessage:"Unable to share file";return n.$broadcast("ON_SHOW_INFO_MESSAGE",{type:"error",messageKey:r}),o.state="uploadError",v.receiptStatus=s.ReceiptStatus.ERROR,v.fileErrorMsg=r,l.updateMessage(v),h.reject(e)})}).then(function(e){e.state="uploaded",e.chunkPerformed=0,e.chunkTotalNumber=0,n.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:e}),l.sendExistingFSMessage(v,e),c.resolve(v)},function(e){t.debug("createFileDescriptor error"),c.reject(e)}),c.promise},g.prototype.sendEFSMessage=function(e,t){var r=this,i=e.extension,a="",o=null,c=this.addFSMessage(e.id,i,t,e.state);return this.type===g.Type.ONE_TO_ONE?(a="user",o=this.contact.dbId):(a="room",o=this.room.dbId),d.addFileViewer(e.id,o,a).then(function(){r.sendExistingFSMessage(c,e)}).catch(function(e){var t=e.translatedMessage?e.translatedMessage:"Unable to share file";n.$broadcast("ON_SHOW_INFO_MESSAGE",{type:"error",messageKey:t}),c.receiptStatus=s.ReceiptStatus.ERROR,r.updateMessage(c)}),c},g.prototype.addAdminBubbleMessage=function(e,n,r,i){if(this.getMessageById(i))return t.info("[Conversation] "+this.id+" add addAdminBubbleMessage message ("+i+") already exists."),null;t.info("[Conversation] "+this.id+" add addAdminBubbleMessage from "+e.jid+" : "+r);var a=s.Side.ADMIN,o=s.create(i,n,e,a,r+"MsgRoom",!1);return o.setReceiptStatus(s.ReceiptStatus.SENT),this.addMessage(o)},g.prototype.addFTMessage=function(e,n,r,i){t.info("[Conversation] "+this.id+" add FT message from "+e.jid+" : "+r.message);var o=a.isUserContact(e)?"R":"L",c=s.createFTMessage(i,n,e,o,r.message,!1,r);return this.addMessage(c)},g.prototype.addFSMessage=function(e,n,r,o){t.info("[Conversation] "+this.id+" add FS message from me");var c=g.getUniqueMessageId(),l=i("emojiShortToUnicode")(r),d=new Date;t.info("[Conversation] "+this.id+" add FILE SHARING message from me");var u=s.createFileSharingMessage(c,d,a.userContact,"R",l,o,e);return u.setReceiptStatus(s.ReceiptStatus.IN_PROGRESS),this.addMessage(u)},g.prototype.addChatMessage=function(e,n,r,i,o,c,l,d,u){if(this.getMessageById(i))return t.info("[Conversation] "+this.id+" add CHAT message ("+i+") already exists."),null;t.info("[Conversation] "+this.id+" add CHAT message ("+i+") from "+e.jid);var h=a.isUserContact(e)?"R":"L",f=s.create(i,n,e,h,r,!1,c,l,d,u);return o?f.setReceiptStatus(s.ReceiptStatus.IN_PROGRESS):f.setReceiptStatus(s.ReceiptStatus.SENT),this.addMessage(f)},g.prototype.addRecordingMessage=function(e,t,n,r){var i=s.createRecordingAdminMessage(r,t,e,"ADMIN",n);return this.addMessage(i)},g.prototype.addFileMessage=function(e,n,r,i){t.info("[Conversation] "+this.id+" add FILE message from "+e.jid+" : "+r);var o=a.isUserContact(e)?"R":"L",c=s.createFileMessage(i,n,e,o,r,!1);return this.addMessage(c)},g.prototype.addFileSharingMessage=function(e,n,r,i,o,c){t.info("[Conversation] "+this.id+" add FILE SHARING message from "+e.jid+" : "+r);var l=a.isUserContact(e)?"R":"L",d=s.createFileSharingMessage(i,n,e,l,r,!1,o,c);return this.addMessage(d)},g.prototype.addConferenceMessage=function(e,n,r,i){if("reminder"===i.type){var o=m.getRoomByJid(i.roomjid),c=v.conferenceSessions[o.getPstnConfEndpointId()];if(c&&c.isActive()&&c.isParticipantConnectedByJid(a.userContact.jid))return}t.info("[Conversation] "+this.id+" add CONFERENCE message from "+e.jid);var l=s.createConferenceMessage(r,n,e,"ADMIN",!1,i);return this.addMessage(l)},g.prototype.addWebRTCMessage=function(e,n,r,i){if(this.getMessageById(i))return t.info("[Conversation] "+this.id+" add addWebRTCMessage message ("+i+") already exists."),null;t.info("[Conversation] "+this.id+" add WebRTC message from "+e.jid+" : "+r);var o=a.isUserContact(e)?s.Side.RIGHT:s.Side.LEFT,c=s.createWebRTCMessage(i,n,e,o,r,!1);return this.addMessage(c)},g.prototype.updateMessage=function(e){this.chatRenderer&&this.chatRenderer.updateMessage(e,this.room)},g.prototype.addMessage=function(e){if(this.messages.find(function(t){return t.id===e.id}))return t.info("[Conversation] "+this.id+" try to add an already stored message with id "+e.id),e;if(e.side===s.Side.LEFT)e.type===s.Type.WEBRTC&&(this.missedCalls+=1),this.setStatusMessage(e.from,g.Status.ACTIVE);else{var o=this.lastEditableMsg;this.lastEditableMsg=e,this.updateMessage(o)}if(this.messages.push(e),this.chatRenderer&&(this.chatRenderer.appendMessages([e],this.room),this.contact&&this.contact._lastActivityDate)){var c=Math.abs(new Date-this.contact._lastActivityDate)/1e3/3600/24;if(this.contact.roster&&"offline"===this.contact.status&&14<=c){var l=this.chatRenderer;l.displayInfoMessage(i("translate")("offlineSendMail"),i("translate")("warningOfflineSendMail"),function(e,t){e?(l.sendingInfoMessage(i("translate")("sendingMail")),a.notifyImByEmail(t).then(function(){l.displayInfoMessage(i("translate")("sendMailSuccess")),r(function(){l.hideInfoMessage()},3e3,1)}).catch(function(e){l.displayErrorMessage(e),r(function(){l.hideInfoMessage()},5e3,1)})):l.hideInfoMessage()})}}return this.lastModification=new Date,this.lastMessageText=e.data,n.$broadcast("ON_CONVERSATION_UPDATED_EVENT",this.id),e},g.prototype.addMessageInHistoryMessages=function(e){if(e&&(this.historyMessages.push(e),e.side===s.Side.RIGHT&&(!this.lastEditableMsg||e.date.getTime()>this.lastEditableMsg.date.getTime()))){var t=this.lastEditableMsg;this.lastEditableMsg=e,this.updateMessage(t)}},g.prototype.addMessageInCacheMessages=function(e){e&&this.cacheMessages.push(e)},g.prototype.removeMessage=function(e){var t=this.messages.lastIndexOf(e);-1!==t&&this.messages.splice(t,1)},g.prototype.sendChatStatus=function(e){if(t.info("[Conversation] "+this.id+" setStatus "+e.value),this.status!==e&&(this.status=e,e!==g.Status.IDLE)){var n=null,r="";this.type===g.Type.ONE_TO_ONE?(r=this.contact.jid,n=$msg({to:r,type:"chat"}).c(e.value,{xmlns:g.ChatstatesNS})):(r=this.room.jid,n=$msg({to:r,type:"groupchat"}).c(e.value,{xmlns:g.ChatstatesNS}));try{o.connection.send(n)}catch(e){t.error("[Conversation] sendChatStatus error "+e)}}},g.prototype.setStatusMessage=function(e,n){t.info("[Conversation] "+this.id+" add status message from "+e.jid+" : "+n.value),this.participantStatuses[e.jid]=n,this.chatRenderer&&this.chatRenderer.updateStatuses&&this.chatRenderer.updateStatuses()},g.prototype.sendInvitation=function(e){try{var n=e.jid,r={xmlns:"jabber:x:conference",jid:this.id},i=$msg({from:o.connection.jid,to:n}).c("x",r);o.connection.send(i)}catch(e){t.error("[Conversation] sendInvitation error "+e)}},g.prototype.ackReadAllMessages=function(){var e=this;this.messages.forEach(function(t){(t.receiptStatus===s.ReceiptStatus.SENT||t.receiptStatus===s.ReceiptStatus.UNREAD)&&(t.setReceiptStatus(s.ReceiptStatus.READ),e.chatRenderer&&e.chatRenderer.updateMessage(t,e.room))})},g}])},function(){angular.module("rainbow").factory("Message",["$log","$filter","$interval","ReplaceMsg","roomService",function(e,t,n,r,i){"use strict";function a(e,t,n,r,i,o,s,c,l,d,u,h,f){this.id=e,this.index=null,this.type=t,this.date=n,this.from=r,this.side=i,this.data=o,this.status=s,this.receiptStatus=a.ReceiptStatus.NONE,this.serverAckTimer=null,this.fileId=c,this.fileName=u,this.isMarkdown=l,this.subject=d,this.answeredMsgId=h,this.answeredMsgDate=f,this.replaceMsgs=[]}return a.Type={CHAT:{key:0,value:"Chat"},FILE:{key:1,value:"File"},FS:{key:2,value:"FileSharing"},FT:{key:3,value:"FileTransfert"},WEBRTC:{key:4,value:"WebRTC CAll"},RECORDING:{key:5,value:"Recording"}},a.ReceiptStatus={NONE:0,ERROR:1,IN_PROGRESS:2,SENT:3,UNREAD:4,READ:5},a.Side={LEFT:"L",RIGHT:"R",ADMIN:"ADMIN"},a.ReceiptStatusText=["none","ko","inProgress","sent","received","read"],a.create=function(e,n,r,i,o,s,c,l,d,u){var h=t("emojiUnicodeToShort")(o);return new a(e,a.Type.CHAT,n,r,i,h,s,null,c,l,null,d,u)},a.createFileSharingMessage=function(e,n,r,i,o,s,c,l){var d=t("emojiUnicodeToShort")(o);return new a(e,a.Type.FS,n,r,i,d,s,c,null,null,l)},a.createConferenceMessage=function(e,n,r,o,s,c){var l=i.getRoomByJid(c.roomjid),d="";switch(c.type){case"invite":d=t("translate")("headerConferenceMessage",{sender:r._displayName,firstname:r.firstname,bubblename:l.name});break;case"reminder":d=l&&l.owner?t("translate")("conferenceReminderMessageforOwner",{sender:r._displayName}):t("translate")("conferenceReminderMessage",{sender:r._displayName});break;default:d=t("translate")("headerConferenceMessage",{sender:r._displayName,firstname:r.firstname,bubblename:l.name})}l.desc&&(d+="<br>"+t("translate")("conferenceSuject")+l.desc);var u=d;return new a(e,a.Type.CHAT,n,r,o,u,s)},a.createFileMessage=function(e,t,n,r,i,o){return new a(e,a.Type.FILE,t,n,r,i,o)},a.createWebRTCMessage=function(e,t,n,r,i,o){return new a(e,a.Type.WEBRTC,t,n,r,i,o)},a.createFTMessage=function(e,t,n,r,i,o,s){var c=new a(e,a.Type.FT,t,n,r,i,o);return c.fileTransfert=s,c},a.createBubbleAdminMessage=function(e,t,n,r){var i=a.Side.ADMIN;return a.create(e,t,n,i,r+"MsgRoom",!1)},a.createRecordingAdminMessage=function(e,t,n,r,i){var o=r+"Recording";i&&(o+=i);var s=a.Side.ADMIN;return new a(e,a.Type.RECORDING,t,n,s,o,!1)},a.prototype.addReplaceMsg=function(e,t){var n=r.create(e,t);this.replaceMsgs.push(n)},a.prototype.isTextModified=function(){return 0<this.replaceMsgs.length},a.prototype.getLastTextModified=function(){return 0<this.replaceMsgs.length?this.replaceMsgs[this.replaceMsgs.length-1].body:this.data},a.prototype.isDeleted=function(){return 0===this.getLastTextModified().length},a.prototype.setReceiptStatus=function(t){return this.serverAckTimer&&t>a.ReceiptStatus.IN_PROGRESS&&(n.cancel(this.serverAckTimer),this.serverAckTimer=null),t>this.receiptStatus&&(this.receiptStatus=t,e.info("[Message] "+this.id+" : "+a.ReceiptStatusText[t])),this},a}])},function(){angular.module("rainbow").factory("Room",[function(){"use strict";function e(t,n,r,i,a,o,s,c,l,d,u){this.dbId=t,this.jid=n,this.name=r,this.nameForLogs="",this.desc=i,this.type=e.Type.PRIVATE,this.users=[],this.history=s||e.History.NONE,this.customData=c||{},this.ownerContact=null,this.organizers=[],this.members=[],this.avatarContacts=[],this.owner=!1,this.isModerator=!1,this.confEndpoints=o||[],this.conference=void 0===l?null:l,this.status="none",this.creationDate=a,this.initPresPromise=null,this.avatar=d,this.guestEmails=[],this.isActive=u,e.prototype.toString=function(){return"Room "+this.dbId+" "+this.name+" "+this.jid},e.prototype.updateAvatarInfo=function(){var e=[],t=this.users.slice();if(!this.avatar){t.sort(function(e,t){return new Date(e.date)-new Date(t.date)});for(var n=0;n<t.length;n++){var r=t[n].contact,i=t[n].status;if(r.dbId!==this.ownerContact.dbId&&(("accepted"===i||"invited"===i)&&e.push(r),2===e.length))break}this.avatarContacts=e}},e.prototype.isUserOwner=function(e){return!!e&&this.ownerContact.jid===e.jid},e.prototype.isUserModerator=function(e){return void 0!==this.getOrganizerFromContactJid(e.jid)},e.prototype.isUserStatusAccepted=function(e){var t=this.getUserByJid(e.jid);return void 0!==t&&"accepted"===t.status},e.prototype.isUserStillBelongToRoom=function(e){var t=this.getUserByJid(e);return!(t&&("unsubscribed"===t.status||"deleted"===t.status))},e.prototype.getOrganizerFromContactJid=function(e){var t;return this.organizers.forEach(function(n){n.contact.jid===e&&(t=n)}),t},e.prototype.getUserByJid=function(e){for(var t=0;t<this.users.length;t++)if(e===this.users[t].contact.jid)return this.users[t];return null},e.prototype.getPstnConfEndpointId=function(){if(this.confEndpoints&&this.confEndpoints.length)for(var e=0;e<this.confEndpoints.length;e++)if("pstnAudio"===this.confEndpoints[e].mediaType)return this.confEndpoints[e].confEndpointId;return null},e.prototype.getSFUConfEndpointId=function(){if(this.confEndpoints&&this.confEndpoints.length)for(var e=0;e<this.confEndpoints.length;e++)if("webrtc"===this.confEndpoints[e].mediaType)return this.confEndpoints[e].confEndpointId;return null},e.prototype.getSFUSharingConfEndpointId=function(){if(this.confEndpoints&&this.confEndpoints.length)for(var e=0;e<this.confEndpoints.length;e++)if("webrtcSharingOnly"===this.confEndpoints[e].mediaType)return this.confEndpoints[e].confEndpointId;return null},e.prototype.isMeetingRoom=function(){return this.conference&&"pstnAudio"===this.conference.mediaType},e.prototype.isWebConferenceRoom=function(){return this.conference&&"pstnAudio"!==this.conference.mediaType&&this.getSFUConfEndpointId()},e.prototype.isMeetingOrWebConferenceRoom=function(){return this.isMeetingRoom()||this.getSFUConfEndpointId()},e.prototype.getNameForLogs=function(){if(!this.nameForLogs&&this.name){var e=this.name.replace(/[^\s](?=.{1,}$)/g,"*");this.nameForLogs=this.name.charAt(0)+e.substr(1)}return this.nameForLogs}}return e.Type={PRIVATE:0,PUBLIC:1},e.Privilege={USER:"user",MODERATOR:"moderator",GUEST:"guest"},e.History={ALL:"all",NONE:"none"},e.create=function(t,n,r,i,a,o,s,c,l,d,u){return new e(t,n,r,i,a,o,s,c,l,d,u)},e}])},function(){angular.module("rainbow").factory("Call",["$log",function(e){"use strict";function t(t,n,r,i){this.status=t,this.id=n,this.conversationId=null,this.connectionId=null,this.type=r,this.isVm=!1,this.contact=i,this.remoteMedia=0,this.localMedia=0,this.isEscalated=!1,this.startDate=new Date,this.isInitiator=!1,this.participants=null,this.isRemoteVideoMuted=!1,this.isConference=!1,this.avatars=i&&i.avatar?[this.contact.avatar.src]:[],this.subject=void 0,this.currentCalled={contactPhoneNumber:"",contact:null,participantsPhoneNumbers:[],participants:[]},this.fullJid="",this.mediaPillarCall=null,this.isSecondary=!1,this.relevant=!0,this.relevantEquipmentId="unknown",e.debug("[CALL] createCall : "+this)}return t.Status={UNKNOWN:{key:0,value:"Unknown"},DIALING:{key:1,value:"dialing"},QUEUED_INCOMMING:{key:2,value:"queuedIncomming"},QUEUED_OUTGOING:{key:10,value:"queuedOutGoing"},RINGING_INCOMMING:{key:3,value:"incommingCall"},RINGING_OUTGOING:{key:4,value:"ringingOutgoing"},ACTIVE:{key:5,value:"active"},HOLD:{key:6,value:"held"},PUT_ON_HOLD:{key:7,value:"putOnHold"},RELEASING:{key:8,value:"releasing"},ANSWERING:{key:9,value:"answering"},CONNECTING:{key:12,value:"connecting"},ERROR:{key:11,value:"error"}},t.Type={WEBRTC:{key:1,value:"Video"},PHONE:{key:2,value:"Phone"}},t.Media={AUDIO:1,VIDEO:2,PHONE:4,SHARING:8},t.create=function(e,n,r,i){return new t(e,n,r,i)},t.prototype.setCallId=function(t){this.id=t,e.debug("[CALL] setId : "+this)},t.prototype.isInConversationWithMobile=function(){return!!this.fullJid&&(-1!==this.fullJid.indexOf("mobile_android")||-1!==this.fullJid.indexOf("mobile_ios"))},t.prototype.setConversationId=function(t){this.conversationId=t,e.debug("[CALL] setConversationId : "+this)},t.prototype.setConnectionId=function(n){this.connectionId=n,this.id=t.getIdFromConnectionId(n),e.debug("[CALL] setConnectionId : "+this)},t.prototype.setStatus=function(t){this.status=t,e.debug("[CALL] setStatus : "+this)},t.prototype.setType=function(t){this.type=t,e.debug("[CALL] setType : "+this)},t.prototype.setIsVm=function(t){this.isVm=t,e.debug("[CALL] setVm : "+this)},t.prototype.setContact=function(t){this.contact=t,this.avatars=[this.contact.avatar.src],e.debug("[CALL] setContact : "+t)},t.prototype.setParticipants=function(t){this.participants=t,this.avatars=[];var n=this;this.participants.forEach(function(e){n.avatars.push(e.avatar.src)}),e.debug("[CALL] setParticipants : "+t.join())},t.prototype.setSubject=function(e){this.subject=e},t.prototype.getCurrentCalled=function(){return this.currentCalled},t.prototype.setCurrentCalled=function(t){t?this.contact&&this.contact.id?(this.currentCalled.contactPhoneNumber=t.contactPhoneNumber&&""!==t.contactPhoneNumber?t.contactPhoneNumber:"",this.currentCalled.contact=t.contact?t.contact:null,this.currentCalled.participantsPhoneNumbers=null,this.currentCalled.participants=null,e.debug("[Call] setCurrentCalled contactPhoneNumber : "+t.contactPhoneNumber),e.debug("[Call] setCurrentCalled call "+this.id+" contactPhoneNumber = "+t.contactPhoneNumber)):(this.currentCalled.contactPhoneNumber="",this.currentCalled.contact=null,this.currentCalled.participantsPhoneNumbers=t.participantsPhoneNumbers&&0<t.participantsPhoneNumbers.length?t.participantsPhoneNumbers:null,this.currentCalled.participants=t.participants&&0<t.participants.length?t.participants:null,this.currentCalled.participantsPhoneNumbers&&0<this.currentCalled.participantsPhoneNumbers.length&&(e.debug("[Call] setCurrentCalled participantsPhoneNumbers : "+t.participantsPhoneNumbers.join()),e.debug("[Call] setCurrentCalled "+this.id+" participantsPhoneNumbers : "+t.participantsPhoneNumbers.join()))):(this.currentCalled.contactPhoneNumber="",this.currentCalled.contact=null,this.currentCalled.participantsPhoneNumbers=null,this.currentCalled.participants=null)},t.prototype.setCurrentCalledContactNumber=function(t){e.debug("[Call] setCurrentCalledContactNumber call "+this.id+" phoneNumber = "+t),this.currentCalled.contactPhoneNumber=t},t.prototype.setRelevantEquipmentId=function(e){this.relevantEquipmentId=e},t.getIdFromConnectionId=function(e){return e},t.getCallIdFromConnectionId=function(e){return e?e.split("#")[0]:null},t.getDeviceIdFromConnectionId=function(e){return e?e.split("#")[1]:null},t.prototype.getMediaPillarCall=function(){return this.mediaPillarCall},t.prototype.setMediaPillarCall=function(e){this.mediaPillarCall=e||null},t.prototype.isMediaPillarCall=function(){return null!==this.mediaPillarCall},t.prototype.toString=function(){return"(type:"+this.type.value+", id:"+this.id+", status:"+this.status.value+(this.vm?"(voicemail))":")")},t.prototype.isInCallWithMediaPillar=function(){return this.fullJid&&-1!==this.fullJid.indexOf("mp_")},t}])},function(){!function(){"use strict";angular.module("rainbow").factory("RBNotification",["$log","$rootScope","$notification","$filter","notify",function(e,t,n,r,i){function a(t){e.info("[RBNotification] Create notification"),this.icon=t.icon,this.displayName=t.displayName,this.message=t.body,this.type=t.type,this.tag=t.tag,this.title=t.title,this.tooltip=t.tooltip,this.delay=t.delay?t.delay:o,this.focusAction=t.focusAction,this.sound=null,this.answerAudioButton=null,this.answerVideoButton=null,this.answerSharingButton=null,this.answerAudioButtonDisabled=null,this.answerClick=!1,this.declineButton=null,this.declineClick=!1,this.answerWithTemplateIMClick=!1,this.answerWithIMButton=null,this.bottomRightButton=null,this.handler=null,this.ascope=null,this.isSent=!1}var o=8e5,s=this;return a.notifs=[],a.create=function(e){var t=a.notifs[e.id];return t?(t.update(e),t):(t=new a(e),a.notifs[e.id]=t,t)},a.hide=function(n){e.info("[RBNotification] Hide notification");var r=a.notifs[n];r&&r.handler.close(),delete a.notifs[n],t.$broadcast("NOTIFICATION_HIDE_EVENT",this)},a.createNotificationListener=function(e){t.$on("$destroy",t.$on("NOTIFICATION_SHOW_EVENT",function(t,n){n.display(e)}))},a.prototype.update=function(t){e.info("[RBNotification] >update"),this.icon=t.icon,this.displayName=t.displayName,this.message=t.body,this.type=t.type,this.tag=t.tag,this.delay=t.delay?t.delay:o,this.focusAction=t.focusAction},a.prototype.send=function(){this.isSent||(this.isSent=!0,t.$broadcast("NOTIFICATION_SHOW_EVENT",this))},a.prototype.addAnswerAudioButton=function(e){this.answerAudioButton=e},a.prototype.addAnswerVideoButton=function(e){this.answerVideoButton=e},a.prototype.addAnswerSharingButton=function(e){this.answerSharingButton=e},a.prototype.addAnswerAudioButtonDisabled=function(e){this.answerAudioButtonDisabled=e},a.prototype.addDeclineButton=function(e){this.declineButton=e},a.prototype.addAnswerWithIMButton=function(e){this.answerWithIMButton=e},a.prototype.addBottomRightButton=function(e){this.bottomRightButton=e},a.prototype.display=function(e){if(!t.appVisible){var a=n(this.displayName,{tag:this.tag,body:this.message,icon:this.icon,delay:4e3});this.focusAction&&a.$on("click",this.focusAction)}s.answerClick=!1,s.declineClick=!1,s.answerWithTemplateIMClick=!1;var o=null;this.ascope||(this.ascope=e.$new(!0),this.ascope.notification=this,this.ascope.showIMTemplates=!1,this.ascope.answerAudioButtonClick=function(e){s.answerClick||(e.answerAudioButton.action(),s.answerClick=!0)},this.ascope.answerVideoButtonClick=function(e){s.answerClick||(e.answerVideoButton.action(),s.answerClick=!0)},this.ascope.answerSharingButtonClick=function(e){s.answerClick||(e.answerSharingButton.action(),s.answerClick=!0)},this.ascope.declineButtonClick=function(e){s.declineClick||(e.declineButton.action(),s.declineClick=!0)},this.ascope.answerWithIMButtonClick=function(e){if(e.ascope.showIMTemplates)e.ascope.showIMTemplates=!1,e.ascope.templatesIM=[];else{o=e;var t=[];e.answerWithIMButton&&Array.isArray(e.answerWithIMButton.choice)&&e.answerWithIMButton.choice.forEach(function(e){t.push(e)}),e.ascope.templatesIM=t,e.ascope.showIMTemplates=!0}},this.ascope.addBottomRightButtonClick=function(e){e.bottomRightButton.action()},this.ascope.answerWithTemplateIM=function(e){if(!s.answerWithTemplateIMClick){if(o){var t="";o.answerWithIMButton.label!==e.label&&(t=r("translate")(e.label)),o.answerWithIMButton.action(t)}s.answerWithTemplateIMClick=!0}}),this.handler||(this.handler=i({container:document.getElementById("leftArea"),position:"left",templateUrl:"notificationCallTemplate.html",message:this.title,duration:this.delay,startTop:80,scope:this.ascope}))},a}])}()},function(){angular.module("rainbow").factory("CallLog",[function(){"use strict";function e(t,n,r,i,a,o,s,c,l,d){this.id=t,this.contact=n,this.state=r,this.duration=i,this.direction=c,this.callSubject=l,this.isLatestCall=d,a="unknown"===a||"audio"===a||"webrtc"===a?e.Type.WEBRTC:"telephone"===a?e.Type.TELEPHONE:e.Type.CONFERENCE,this.type=a,this.read=o,this.date=s}return e.create=function(t,n,r,i,a,o,s,c,l,d){return new e(t,n,r,i,a,o,s,c,l,d)},e.getNames=function(e){var t={firstname:"",lastname:""};return e&&e.contact&&(t.firstname=e.contact.firstname.toUpperCase(),t.lastname=e.contact.lastname.toUpperCase(),e&&e.date&&(t.date=e.date.getTime())),t},e.getDate=function(e){return e&&e.date?e.date.getTime():0},e.sortByContact=function(e,t){var n=-1;if(e&&e.value.lastname&&t&&t.value.lastname){var r=e.value.lastname,i=t.value.lastname;0===(n=r.localeCompare(i))&&(r=e.value.firstname,i=t.value.firstname,0===(n=r.localeCompare(i))&&t.value.date&&e.value.date&&(n=t.value.date-e.value.date))}return n},e.sortByDate=function(e,t){var n=1;return e&&t&&(n=t.value-e.value),n},e.Type={WEBRTC:"webrtc",TELEPHONE:"telephone",CONFERENCE:"conference"},e}])},function(){!function(){"use strict";angular.module("rainbow").factory("Document",["$log","$filter",function(e,t){function n(t,n,r,i,a,o){this.publisher=t,this.item_id=a,this.data=n,this.timestamp=r,this.authorjid=i,this.pub_id=o,e.debug("[Document] createActu : "+this)}return n.create=function(e,t){return new n(e,t,Date.now(),e.jid)},n.createForSharing=function(e,t){return console.log(t.item_id),""===t.item_id?new n(e,"Repost",Date.now(),t.authorjid,t.pub_id):new n(e,"Repost",Date.now(),t.authorjid,t.item_id)},n.createFromXML=function(e,t){return new n(e,t.childNodes[0].childNodes[0].nodeValue,parseInt(t.childNodes[1].childNodes[0].nodeValue,10),t.childNodes[2].childNodes[0].nodeValue,1===t.childNodes[3].childNodes.length?t.childNodes[3].childNodes[0].nodeValue:"",t.parentNode.attributes.getNamedItem("id").nodeValue)},n.prototype.messageFilter=function(e){return t("quoteFilter")(t("emojione")(t("linky")(t("emojiUnicodeToShort")(e,"_blank"))))},n.prototype.setPubId=function(e){this.pub_id=e},n.prototype.setItemId=function(e){this.item_id=e},n.prototype.getXML=function(){return[{data:$build("entry").c("data",this.data).up().c("timestamp",this.timestamp).up().c("jidauthor",this.authorjid).up().c("item_id",this.item_id).tree()}]},n.prototype.getTime=function(e){return moment(this.timestamp).format(e)},n.prototype.toString=function(){return"(jid:"+this.contact+", id:"+this.pub_id+", data:"+this.data+", tsmp:"+this.timestamp+" )"},n}])}()},function(){angular.module("rainbow").factory("Group",[function(){"use strict";function e(e,t,n,r){this.id=e,this.name=t,this.comment=n||"",this.isFavorite=!!r&&r,this.users=[],this.sortedUserList=[]}return e.createFromData=function(t){return new e(t.id,t.name,t.comment,t.isFavorite)},e}])},function(){angular.module("rainbow").factory("Invitation",["userInfoService",function(e){"use strict";function t(t,n,r,i,a,o,s,c,l,d,u,h){this.id=t,this.invitedUserId=n,this.invitedUserEmail=r,this.invitedPhoneNumber=h,this.invitingUserId=i,this.invitingUserEmail=a,this.requestNotificationLanguage=o,this.invitingDate=s,this.lastNotificationDate=c,this.status=l,this.type=d,this.defaultAvatar=null,this.inviteToJoinMeeting=u,this.createDefaultAvatar=function(){if(!this.defaultAvatar&&this.invitedUserEmail){var t=e.computeUserColor(this.invitedUserEmail),n=this.invitedUserEmail.substring(0,2).toUpperCase();this.defaultAvatar=e.createDefaultAvatarImage(n,t)}}}return t.create=function(e,n,r,i,a,o,s,c,l,d,u){return new t(e,n,r,i,a,o,s,c,l,d,u)},t.createFromData=function(e){var n=new t(e.id,e.invitedUserId,e.invitedUserEmail,e.invitingUserId,e.invitingUserEmail,e.requestNotificationLanguage,e.invitingDate,e.lastNotificationDate,e.status,e.type,e.inviteToJoinMeeting,e.invitedPhoneNumber);return n.createDefaultAvatar(),n},t}])},function(){angular.module("rainbow").factory("VoiceMail",["profileService",function(e){"use strict";function t(){this.VMFlag=!1,this.VMCounter=0,this.infoMsg="",this.voiceMailFeatureEnabled=e.isFeatureEnabled(e.FeaturesEnum.TELEPHONY_VOICE_MAIL),this.setVMFlag=function(e){this.VMFlag=e},this.getVMFlag=function(){return this.VMFlag},this.setVMCounter=function(e){0<e?(this.VMFlag=!0,this.VMCounter=e):this.VMCounter=0},this.getVMCounter=function(){return this.VMCounter},this.setInfoMsg=function(e){this.infoMsg=e},this.getInfoMsg=function(){return this.infoMsg},this.getDisplayState=function(){return this.voiceMailFeatureEnabled}}return t.create=function(){return new t},t}])},function(){angular.module("rainbow").factory("ReplaceMsg",["$filter",function(e){"use strict";function t(e,t){this.id=e,this.body=t}return t.create=function(n,r){return new t(n,e("emojiUnicodeToShort")(r))},t}])},function(){angular.module("rainbow").factory("Organisation",[function(){"use strict";function e(e,t,n){this.id=e,this.name=t,this.visibility=n,this.companies=[]}return e.createFromData=function(t){return new e(t.id,t.name,t.visibility)},e}])},function(){angular.module("rainbow").factory("Site",[function(){"use strict";function e(e,t,n,r,i,a){this.id=e,this.name=t||"",this.status=n||"",this.companyId=r||"",this.settings=i||"",angular.isDefined(a)&&(this.isCentrex=a)}return e.createFromData=function(t){return new e(t.id,t.name,t.status,t.companyId,t.settings,t.isCentrex)},e.create=function(t,n,r,i){return new e(t,n,r,i)},e.StatusValues=["active","alerting","hold","terminated"],e}])},function(){angular.module("rainbow").factory("System",[function(){"use strict";function e(e,t,n,r,i,a,o,s,c,l,d,u,h,f,p,m,v,g,C){this.id=e||null,this.jid_pbxagent=n||"",this.jid_password=r||"",this.pbxMainBundlePrefix=i||["0"],this.usePbxMainBundlePrefix=!angular.isDefined(p)||p,this.pbxNumberingTranslator=m||[],this.type=o||null,this.country=d||"FRA",this.name=u||"",this.jid_pbxagent_password=h||"",this.jid_pbxagent_password_activating=f||"",l&&(this.siteId=l),t&&(this.pbxId=t),a&&(this.serverPingTimeout=a),s&&(this.status=s),c&&(this.version=c),angular.isDefined(v)&&(this.isCentrex=v),angular.isDefined(g)&&(this.isShared=g),C&&(this.bpId=C)}return e.createFromData=function(t){return new e(t.id,t.pbxId,t.jid_pbxagent,t.jid_password,t.pbxMainBundlePrefix,t.serverPingTimeout,t.type,t.status,t.version,t.siteId,t.country,t.name,t.jid_pbxagent_password,t.jid_pbxagent_password_activating,t.usePbxMainBundlePrefix,t.pbxNumberingTranslator,t.isCentrex,t.isShared,t.bpId)},e.create=function(){return new e},e.StatusValues=["created","activating","activated"],e}]),angular.module("rainbow").filter("serverTypeFilter",[function(){"use strict";return function(e){return"oxo"===e?"OXO Connect":"oxe"===e?"OmniPCX Enterprise":"third_party"===e?"Third party PBX":e}}]),angular.module("rainbow").filter("systemStateFilter",[function(){"use strict";return function(e){return"created"===e?"pending":"activating"===e?"connecting":"activated"===e?"normal":void 0}}]),angular.module("rainbow").filter("systemStateColorFilter",[function(){"use strict";return function(e){return"created"===e?"color_orange":"activating"===e?"color_red":"activated"===e?"color_green":void 0}}])},function(){angular.module("rainbow").factory("SystemsGroup",[function(){"use strict";function e(e,t,n,r){this.id=e||null,this.name=t,this.companies=n||[],this.systems=r,this.containsSystem=function(e){return!!this.systems&&this.systems.some(function(t){return t.systemId===e})}}return e.createFromData=function(t){return new e(t.id,t.name,t.companies,t.systems)},e.create=function(t,n,r,i){return new e(t,n,r,i)},e}])},function(){angular.module("rainbow").factory("User",["Subscription","userInfoService",function(e,t){"use strict";function n(r,i){var a=this;n.attributes.forEach(function(e){r&&angular.isDefined(r[e.name])?a[e.name]=r[e.name]:!i&&angular.isDefined(e.defaultValue)&&(a[e.name]=e.defaultValue)}),this.subscriptions=[],this.updateFromData=function(e){n.attributes.forEach(function(t){angular.isDefined(e[t.name])&&(a[t.name]=e[t.name])})},this.fillSubscriptionMap=function(){var e={};this.subscriptions.forEach(function(t){e[t.id]=t}),this.subscriptionMap=e},this.fillMainSubscriptionField=function(){var t=this.subscriptions.filter(e.isExclusive).sort(e.subscriptionComparator);0<t.length&&(this.mainSubscription=t[t.length-1],this.mainSubscriptionName=this.mainSubscription.offerName);var n=this.subscriptions.filter(e.isOptional);0<n.length&&(this.optionalSubscriptionNames=n.map(function(e){return e.offerName}).join(", ")),this.subscriptionNames=this.mainSubscriptionName+(this.optionalSubscriptionNames?", "+this.optionalSubscriptionNames:"")},this.getMainSubscription=function(){return this.mainSubscription||this.fillMainSubscriptionField(),this.mainSubscription},this.getOptionalSubscriptions=function(){return this.subscriptions.filter(e.isOptional)},this.getMainSubscriptionName=function(){return this.mainSubscriptionName||this.fillMainSubscriptionField(),this.mainSubscriptionName},this.getOptionalSubscriptionNames=function(){return this.mainSubscriptionName||this.fillMainSubscriptionField(),this.optionalSubscriptionNames},this.hasUserRoleOnly=function(){return 1===this.roles.length&&-1!==this.roles.indexOf(n.RoleValues.USER)},this.isAdmin=function(){return-1!==this.roles.indexOf(n.RoleValues.ADMIN)},this.isOrganizationAdmin=function(){return!!this.isAdmin()&&"organization_admin"===this.adminType},this.isSiteAdmin=function(){return!!this.isAdmin()&&"site_admin"===this.adminType},this.isCompanyAdmin=function(){return!!this.isAdmin()&&"company_admin"===this.adminType},this.isBPAdmin=function(){return this.isBPAdminOperations()||this.isBPAdminFinance()},this.isBPAdminOperations=function(){return-1!==this.roles.indexOf(n.RoleValues.BP_ADMIN_OPERATIONS)},this.isBPAdminFinance=function(){return-1!==this.roles.indexOf(n.RoleValues.BP_ADMIN_FINANCE)},this.isSuperadmin=function(){return-1!==this.roles.indexOf(n.RoleValues.SUPERADMIN)},this.isBusinessAdmin=function(){return-1!==this.roles.indexOf(n.RoleValues.BUSINESS_ADMIN)},this.isPublicChannelsAdmin=function(){return-1!==this.roles.indexOf(n.RoleValues.PUBLIC_CHANNELS_ADMIN)},this.isAllCompanyChannelsAdmin=function(){return-1!==this.roles.indexOf(n.RoleValues.ALL_COMPANY_CHANNELS_ADMIN)},this.isClosedChannelsAdmin=function(){return-1!==this.roles.indexOf(n.RoleValues.CLOSED_CHANNELS_ADMIN)},this.computeDisplayName=function(){var e=t.getNameInformation(this.firstName,this.lastName);this.displayName=e.displayName,this.initials=e.initials},this.getPhoneNumbers=function(e,t){return this.phoneNumbers?this.phoneNumbers.filter(function(n){return n.type===e&&n.deviceType===t}):[]},this.getSystemPhoneNumber=function(){return this.phoneNumbers?this.phoneNumbers.find(function(e){return angular.isDefined(e.systemId)}):void 0},this.getActivePhoneNumber=function(e,t){var n=this.getPhoneNumbers(e,t);if(1<n.length){var r=n.find(function(e){return angular.isDefined(e.systemId)});if(r)return r}return n[0]}}return n.createFromData=function(t,r){t&&t.roles&&t.roles.includes("private_channels_admin")&&t.roles.splice(t.roles.indexOf("private_channels_admin"),1,n.RoleValues.ALL_COMPANY_CHANNELS_ADMIN);var i=new n(t,r);return t.profiles&&(t.profiles.forEach(function(t){var n=e.createFromData(t);n.isTerminated()||i.subscriptions.push(n)}),i.fillMainSubscriptionField()),i.computeDisplayName(),i},n.create=function(){return new n},n.prune=function(e){return Object.assign({},e)},n.VisibilityValues=["private","public"],n.RoleValues={USER:"user",GUEST:"guest",SUPERADMIN:"superadmin",SUPPORT:"support",BUSINESS_ADMIN:"business_admin",ADMIN:"admin",BP_ADMIN_OPERATIONS:"bp_admin",BP_ADMIN_FINANCE:"bp_finance",PUBLIC_CHANNELS_ADMIN:"public_channels_admin",ALL_COMPANY_CHANNELS_ADMIN:"all_company_channels_admin",CLOSED_CHANNELS_ADMIN:"closed_channels_admin"},n.AuthenticationTypeValues=[{value:"RAINBOW",label:"rainbowLogin"},{value:"SAML",label:"companySingleSignOn"},{value:"DEFAULT",label:"defaultLogin"}],n.attributes=[{name:"id",defaultValue:null},{name:"loginEmail",defaultValue:""},{name:"firstName",defaultValue:""},{name:"lastName",defaultValue:""},{name:"displayName",defaultValue:""},{name:"nickName",defaultValue:""},{name:"title",defaultValue:""},{name:"jobTitle",defaultValue:""},{name:"companyId",defaultValue:""},{name:"companyName",defaultValue:""},{name:"siteId",defaultValue:""},{name:"systemId",defaultValue:""},{name:"accountType",defaultValue:"free"},{name:"country",defaultValue:"FRA"},{name:"timezone",defaultValue:"Europe/Paris"},{name:"emails",defaultValue:[]},{name:"phoneNumbers",defaultValue:[]},{name:"roles",defaultValue:["user"]},{name:"adminType",defaultValue:"company_admin"},{name:"isActive",defaultValue:!1},{name:"isInitialized",defaultValue:!1},{name:"password",defaultValue:void 0},{name:"jid_im",defaultValue:""},{name:"jid_tel",defaultValue:""},{name:"language",defaultValue:"en"},{name:"lastAvatarUpdateDate",defaultValue:null},{name:"visibility",defaultValue:void 0},{name:"authenticationType",defaultValue:void 0}],n}])},function(){angular.module("rainbow").factory("Subscription",["Offer",function(e){"use strict";function t(e,t,n,r,i,a,o,s,c,l,d,u,h,f,p,m,v,g,C,S,E,b,y,R,T){this.id=e,this.offerId=t,this.offerName=n,this.offerReference=r,this.profileId=i,this.profileName=a,this.maxNumberUsers=o,this.numberAssignedUsers=s,this.status=c,this.syncOngoing=!!l&&l,this.updatingMaxNumberUsers=d,void 0!==u&&(this.nbBPLicences=u),void 0!==h&&(this.nbAssignedBPUsers=h),void 0!==f&&(this.nbLicencesAssignedToECs=f),void 0!==p&&(this.nbLicencesUsed=p),void 0!==m&&(this.nbFreeLicences=m),this.businessModel=v,this.canBeSold=g,this.isPrepaid=E,this.expirationDate=b,this.autoRenew=y,this.hasConference=R,this.isDemo=T,this.isDefault=C,this.isExclusive=S,this.isEnterprise=function(){return this.offerName.toLowerCase().startsWith("enterprise")},this.isBusiness=function(){return this.offerName.toLowerCase().startsWith("business")},this.isEssential=function(){return this.offerName.toLowerCase().startsWith("essential")},this.isDemo=function(){return this.isDemo||!this.isDefault&&!this.canBeSold&&this.offerName.toLowerCase().contains("demo")},this.isTerminated=function(){return"terminated"===this.status},this.isTerminating=function(){return"terminating"===this.status},this.isUserLicense=function(){return this.isDefault||"nb_users"===this.businessModel||"usage"===this.businessModel}}return t.createFromData=function(e){return new t(e.id?e.id:e.subscriptionId,e.offerId,e.offerName,e.offerReference,e.profileId,e.profileName,e.maxNumberUsers,e.numberAssignedUsers,e.status,e.syncOngoing,e.updatingMaxNumberUsers,e.nbBPLicences,e.nbAssignedBPUsers,e.nbLicencesAssignedToECs,e.nbLicencesUsed,e.nbFreeLicences,e.businessModel,e.canBeSold,e.isDefault,e.isExclusive,e.isPrepaid,e.expirationDate,e.autoRenew,e.hasConference,e.isDemo)},t.subscriptionComparator=function(t,n){var r=new e(t.offerId,t.offerName,null,null,t.profileId,t.canBeSold,t.businessModel,t.isDefault,t.isExclusive,t.isPrepaid),i=new e(n.offerId,n.offerName,null,null,n.profileId,n.canBeSold,n.businessModel,n.isDefault,n.isExclusive,n.isPrepaid);return e.offerComparator(r,i)},t.isUserLicense=function(e){return e.isDefault||"nb_users"===e.businessModel||"usage"===e.businessModel},t.isExclusive=function(e){return e.isDefault||e.isExclusive},t.isOptional=function(e){return!t.isExclusive(e)},t.isConference=function(e){return t.isOptional(e)&&(e.hasConference||"usage"===e.businessModel)},t.isNotConference=function(e){return t.isOptional(e)&&!(e.hasConference||"usage"===e.businessModel)},t.withLicenses=function(e){return e.isDefault||"usage"===e.businessModel||"nb_users"===e.businessModel&&0<e.maxNumberUsers},t.isPrepaid=function(e){return e.isPrepaid},t.isMonthly=function(e){return!e.isPrepaid},t}])},function(){angular.module("rainbow").factory("IceServer",[function(){"use strict";function e(e,t,n,r){this.id=e,this.urls=t,this.username=n,this.credential=r}return e.createFromData=function(t){return new e(t.id,t.urls,t.username,t.credential)},e}])},function(){angular.module("rainbow").factory("PhoneNumber",[function(){"use strict";function e(e,t,n,r,i,a,o,s,c,l,d,u,h,f,p,m,v,g){this.id=e,this.shortNumber=t,this.number=n,this.numberE164=r,this.pbxUserId=i,this.userId=a,this.type=o,this.deviceType=s,this.pbxId=c,this.isFromSystem=l,this.isMonitored=d,this.systemId=u,this.country=h,this.voiceMailNumber=f,this.deviceName=p,this.firstName=m,this.lastName=v,this.internalNumber=g}return e.createFromData=function(t){return new e(t.id?t.id:t.phoneNumberId,t.shortNumber,t.number,t.numberE164,t.pbxUserId,t.userId,t.type,t.deviceType,t.pbxId,t.isFromSystem,t.isMonitored,t.systemId,t.country,t.voiceMailNumber,t.deviceName,t.firstName,t.lastName,t.internalNumber)},e}])},function(){angular.module("rainbow").service("helpersService",[function(){"use strict";this.chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",this.findIndex=function(e,t){return e.findIndex(t)},this.checkBrowser=function(e){return-1!==navigator.userAgent.indexOf(e)},this.randomString=function(e){e=e||10;for(var t,n="";0<e;)t=Math.floor(Math.random()*this.chars.length),n+=this.chars.charAt(t),e--;return n}}])},function(e,t,n){"use strict";n.r(t);var r=n(1);n.n(r);angular.module("rainbow").service("userInfoService",["$q","$log","$interval","$rootScope","settingsService",function(e,t,n,i,a){var o=this;o.userColors=["#ff4500","#d38700","#348833","#007356","#00b2a9","#00b0e5","#0085ca","#6639b7","#91278a","#cf0072","#a50034","#d20000"],o.getAvatarImage=function(a,s,c,l,d){return e(function(e){d=void 0!==d&&d;var u=s?o.createDefaultAvatarImage(s,c):null;if(d){var h=config.webservices.protocol+"://"+config.webservices.currentServer;i.cdn&&(h=i.cdnServer);var f=h+"/api/avatar/"+a+"?size="+(l||256);d&&(f+="&update="+Object(r.MD5)(r.enc.Latin1.parse(d)).toString(r.enc.Hex));var p=new Image;p.onload=function(){var r=this;n(function(){t.log("[avatarService] Load avatar for "+a+" success"),e(r)},1,1)},p.onerror=function(){n(function(){t.warn("[avatarService] Load avatar for "+a+" failure : use text avatar"),e(u)},1,1)},p.src=f}else e(u)})},o.getNameInformation=function(e,t){var n={displayName:"",initials:""};return 1!==t.length&&2!==e.length?"FL"===a.getSetting("displayOrder")?(n.displayName=e+" "+t,n.initials=e.charAt(0).toUpperCase()+t.charAt(0).toUpperCase()):(n.displayName=t+" "+e,n.initials=t.charAt(0).toUpperCase()+e.charAt(0).toUpperCase()):(n.displayName="FL"===a.getSetting("displayOrder")?e+" "+t:t+" "+e,n.initials=e.charAt(0).toUpperCase()+e.charAt(1).toUpperCase()),n},o.createDefaultAvatarImage=function(e,t){var n=new Image,r=document.createElement("canvas");r.width=n.width=225,r.height=n.height=225;var i=r.getContext("2d");return i.rect(0,0,225,225),i.fillStyle=t,i.fill(),i.font="bold 100px Helvetica",i.textAlign="center",i.fillStyle="white",i.fillText(e,110,150),n.src=r.toDataURL("image/png"),n},o.computeUserColor=function(e){try{for(var n={colorIndex:0,color:o.userColors[0]},r=e.toUpperCase(),i=0,a=0;a<r.length;a++)i+=r.charCodeAt(a);n.colorIndex=i%12,n.color=o.userColors[n.colorIndex]}catch(e){t.error("[UserInfoService] computeUserColor failure"),n.colorIndex=1,n.color=o.userColors[n.colorIndex]}return n}}])},function(){angular.module("rainbow").service("errorHelperService",["$filter",function(e){"use strict";var t=this;t.ErrorCodeLabels={0:"errorNoServerResponse",400210:"invalidPhoneNumber",400400:"errorWrongPassword",400500:"invalidFile",400504:"companyNameAlreadyExist",400505:"BPCompanyWithoutPaymentConfigurationData",400506:"NoActiveSubscriptionToOffer",400511:"ActiveDirectoryDomainAlreadyUsed",400552:"BPCompanyAndECCompanyMustNotBeSame",400973:"noCreateUserPermission",400975:"userAlreadyExistsInOtherCompany",400983:"userAlreadyExistsInOtherCompany",400990:"noUserFound",400993:"noUserFound",401:"Authorization failure",401102:"Authorization failure",401202:"errorInvalidToken",401500:"errorUnauthorized",401501:"errorLoginForbidden",401510:"errorUnauthorized",401520:"errorUserNotActive",401521:"errorUserNotActive",403:"Forbidden",403000:"accessDeniedNotRequiredRole",403001:"accessDeniedNotOwner",403034:"cantDeselectDefaultWebRTCGateway",403035:"cantDeleteDefaultWebRTCGateway",403200:"notAllowedToChangeRole",403203:"notAllowedToChangeRole",403204:"notAllowedToMoveExistingUserToThisCompany",403301:"notAllowedToManageCompany",403304:"notAllowedToAddAnotherAdmin",403311:"errorRemoveSyncOngoingSubscriptionForbidden",403315:"errorRemoveSubscriptionForbidden",403316:"errorRemoveAdminAllocatedSubscriptionForbidden",403317:"errorRemoveClientAllocatedSubscriptionForbidden",403500:"notAllowedBlacklistedEmail",403501:"notAllowedBlacklistedEmail",403503:"NotAllowedSelfRegistrationEmail",403504:"notAllowedLoggedInUserEmail",403507:"notAllowedSupportEmail",403513:"companyNotABpCompany",403516:"companyNotABpCompany",403517:"companySeenAsTerminated",403518:"companyBpTypeIncompatible",403519:"companyAlreadyLinkedToBp",403520:"companyNotVadBp",403531:"resetPasswordBlocked",403532:"resetPasswordForbidden",403608:"errorAssignSubscriptionSyncOngoing",403609:"errorAssignSubscriptionSyncOngoing",403610:"maxSubscriptionAllocationReached",403611:"notAllowedToCreateAnEquipment",403615:"maximumNumberConferenceParticipantsReach",403616:"subscriptionCompanyAdminEssentialAlreadyExists",403617:"roleCompanyAdminEssentialAlreadyExists",403620:"MaximumNumberRoomUsersReach",403630:"uploadErrorMaxQuotaReached",403655:"userAlreadyCompanyMember",403700:"errorDeleteSiteWithSystems",403701:"errorDeleteOrganisationLinkedCompany",403702:"errorDeleteCompanyWithSubscriptions",403703:"errorDeleteCompanyWithSites",403704:"errorDeleteCompanyWithUsers",403705:"errorDeleteCompanyStillTerminated",403706:"errorRemoveBusinessPartnerRole",404:"resourceNotFound",404000:"resourceNotFound",404001:"resourceNotFoundUpdateImpossible",404002:"resourceNotFoundDeleteImpossible",404300:"noValidOfferReferenceInACTISFile",404301:"offerNotFound",409000:"userAlreadyCreated",409011:"noMessagesToExport",409552:"internalNumberAlreadyUsed",409600:"userAlreadyExist",409601:"invitationReSentConflict",409602:"userAlreadyNetworkMember",409603:"invitationReSentConflict",409620:"offerAlreadySubscribed",409623:"conferenceOfferAlreadySubscribed",409625:"errorUpdateSyncOngoingSubscriptionForbidden",409800:"companyNotIrBp",409801:"companyNotLinkedToBp",409802:"actisCompanyAdminMismatch",409803:"actisCompanyNameMismatch",413000:"uploadErrorTooLarge",500:"errorInternalServerError",1001:"extensionNotLinkedToEquipment",1002:"extensionHasNoIdentifier",1003:"extensionDoesNotExist",1004:"extensionLookupFailure",1005:"extensionConflict",1006:"nonUniqueEquipmentForExtension",1007:"userAlreadyAssociatedToExtension",1008:"extensionAssociatedToAnotherUser",1009:"failedToAttachExtension",1010:"userHasNoExtension",1011:"userHasTooManyExtensions",1012:"failedToDetachExtension"},t.portalErrorCodeLabels={massprovisioning:{400502:"invalidColumnName",400506:"invalidValueInActionColumn",403610:"errorMaxSubscriptionReached"}},t.handleErrorMessage=function(e,n){t.getErrorFullMessage(e,n)},t.handleError=function(e,n){var r=t.getPortal(e),i=e.status;e.data&&e.data.errorDetailsCode&&(i=e.data.errorDetailsCode);var a=new Error(t.getDetailedErrorMessage(e));return a.status=e.status,a.fieldErrors=t.getBadRequestFieldErrors(e),a.errorDetailsCode=i,a.errorDetailsLabel=t.getErrorCodeLabel(i,r),a.translatedMessage=t.getTranslatedErrorMessage(e,n,r),a.portal=r,a},t.getPortal=function(e){var t=e.config?e.config.url:void 0,n=t?t.match(/api\/rainbow\/(\w+)\//):void 0;return n?n[1]:void 0},t.getBadRequestFieldErrors=function(e){var n={};if(400===e.status){if(e.data&&e.data.errorDetails instanceof Array)e.data.errorDetails.forEach(function(e){n[e.param]||(n[e.param]={ok:!1,message:e.msg,value:e.value})});else if(e.data&&e.data.errorDetails&&e.data.errorDetails.param){var r=e.data.errorDetails;n[r.param]={ok:!1,message:r.msg,value:r.value}}e.data&&400511===e.data.errorDetailsCode&&(n.office365Tenant={ok:!1,message:t.ErrorCodeLabels[400511]})}return n},t.getErrorMessage=function(e){var n=t.getStatusErrorMessage(e);return e.data&&e.data.errorMsg&&(n="",n+=e.data.errorDetails?e.data.errorDetails instanceof Array?"one or more fields are invalid":e.data.errorDetails.msg?e.data.errorDetails.msg:e.data.errorDetails:e.data.errorMsg),n},t.getStatusErrorMessage=function(e){return 500===e.status?"Internal server error":415===e.status?"Unsupported Media Type":413===e.status?"Request Entity Too Large":404===e.status?"Resource not found":403===e.status?"Access is forbidden":401===e.status?"Authorization failure":400===e.status?"Bad request":e.statusText?e.statusText:"Unknown error"},t.getDetailedErrorMessage=function(e){var n=t.getErrorMessage(e);return e.data&&e.data.errorDetails&&e.data.errorDetails instanceof Array&&0<e.data.errorDetails.length&&(n+=" : "+e.data.errorDetails[0].msg),n},t.getTranslatedErrorMessage=function(e,n,r){if(500===e.status)return t.getLocalizedError("500");var i=null;e.data&&e.data.errorDetailsCode&&(i=e.data.errorDetailsCode);var a;return a=e.data&&e.data.errorDetailsData?Object.assign(e.data.errorDetailsData,n):n,t.getTranslatedErrorMessageByDetailsCode(i,a,t.getErrorMessage(e),r)},t.getTranslatedErrorMessageByDetailsCode=function(n,r,i,a){var o;return n&&(o=t.getLocalizedError(n,r,a)),o||(o=n?e("translate")("anErrorOccurred",{errorcode:n}):e("translate")("anErrorOccurred"),i&&(o+=" ("+e("translate")(i)+")")),o},t.getLocalizedError=function(n,r,i){var a;if(n){var o=t.getErrorCodeLabel(n,i);if(o){var s=e("translate")(o,r);s!==o&&(a=s)}}return a},t.getErrorCodeLabel=function(e,n){return n&&t.portalErrorCodeLabels[n]&&t.portalErrorCodeLabels[n][e]?t.portalErrorCodeLabels[n][e]:t.ErrorCodeLabels[e]},t.getErrorFullMessage=function(e,t){var n=t?t+" failure : ":"";return e&&e.data?(n+=e.data.errorMsg,e.data.errorDetails&&(n+=" - ",e.data.errorDetails instanceof Array?e.data.errorDetails.forEach(function(e){n+=e.msg}):e.data.errorDetails.msg?n+=e.data.errorDetails.msg:n+=e.data.errorDetails)):n+="Unknow error - Something goes really wrong",n}}])},function(){angular.module("rainbow").service("pushImageHelperService",["$log","$q","$http","authService","errorHelperService",function(e,t,n,r,i){"use strict";var a=this;a.pushImage=function(o,s,c){return t(function(l,d){var u=null;if(c&&c.nosize)u=function(){var e=new Image;return e.src=s,t.when(e)};else{var h=c&&c.width?c.width:512,f=c&&c.height?c.height:512;u=function(){return a.resizeImage(s,h,f)}}u().then(function(t){var s=a.getBinaryData(t);n({method:"POST",url:o,headers:r.getPostHeader("image/"+s.type),data:s.data,transformRequest:[]}).then(function(){e.info("[pushImageHelperService] pushImage : success"),l()},function(t){var n=i.handleError(t);d(n),e.error("[pushImageHelperService] "+i.getErrorFullMessage(t,"pushImage"))})})})},a.resizeImage=function(e,n,r){return t(function(t){var i=new Image;i.src=e,i.onload=function(){var e=i.width,a=i.height;e>a?e>n&&(a*=n/e,e=n):a>r&&(e*=r/a,a=r);var o=document.createElement("canvas");o.width=e,o.height=a,i.width=e,i.height=a,o.getContext("2d").drawImage(this,0,0,e,a);var s=new Image;s.src=o.toDataURL("image/png"),t(s)}})},a.getBinaryData=function(e){for(var t=e.src.indexOf("image/")+6,n=e.src.indexOf(";base64,"),r=e.src.slice(n+8),i=e.src.slice(t,n),a=window.atob(r),o=a.length,s=new Uint8Array(o),c=0;c<o;c++)s[c]=a.charCodeAt(c);return{type:i,data:s}}}])},function(){angular.module("rainbow").service("$localStorage",["$q",function(e){"use strict";this.get=function(t){for(var n={},r=0;r<t.length;r++)n[t[r]]=localStorage.getItem(t[r]);return e.when(n)},this.set=function(t){for(var n=Object.keys(t),r=0;r<n.length;r++)localStorage.setItem(n[r],t[n[r]]);return e.when()},this.remove=function(t){for(var n=0;n<t.length;n++)localStorage.removeItem(t[n]);return e.when()}}])},function(){angular.module("rainbow").service("authService",["$http","$q","$window","$log","$localStorage","$interval","$rootScope","$translate","jwtHelper","settingsService","AuthSettings",function(e,t,n,r,i,a,o,s,c,l,d){"use strict";var u=this;try{window.SHA256=CryptoJS.SHA256}catch(t){}u.onInit=function(){r.info("[authService] === INITIALIZATION ==="),u.SSO_LOGIN_POPUP_WINDOW_NAME="Single Sign-On Login",u.login=null,u.token=null,u.jidIm=null,u.jidTel=null,u.jidPwd=null,u.initialized=null,u.renewAppTokenInterval=null,u.renewTokenInterval=null,u.userData=null,u.firstUse=null===localStorage.getItem("firstUse"),u.browserFingerprint=null,u.isGuest=!1,u.logingItself=!1,u.trueLoging=!1,config.appModuleKey||(config.appModuleKey=angular.module("rainbow").moduleIds?angular.module("rainbow").moduleIds.join(""):"default"),u.sdkHostForced=null,u.appToken=null,u.fromSDK=!1,u.firstUseNewVersion=!1;var e=localStorage.getItem("version");u.getMajorVersion(e)!==u.getMajorVersion(version)&&(u.firstUseNewVersion=!0),i.set({version:version})},u.getMajorVersion=function(e){if(!e)return null;var t=/\d+\.\d+/g.exec(e);return t&&0<t.length?t[0]:null},u.registerEventsHandler=function(){u.visibilityHandlerRemoval&&u.visibilityHandlerRemoval(),u.visibilityHandlerRemoval=o.$on("ON_APP_VISIBLE_CHANGE_EVENT",function(e,t){t&&u.startTokenSurvey()})},u.isInitialized=function(){return u.initialized},u.isFirstUse=function(){return u.firstUse},u.getRequestHeader=function(){var e={Authorization:"Bearer "+u.token,Accept:"application/json"};return u.fromSDK&&u.appToken,e},u.getRequestHeaderWithRange=function(e){var t=u.getRequestHeader();return t.Range=e,t},u.getPostHeader=function(e){var t=u.getRequestHeader();return t["Content-Type"]=e||"application/json",t},u.getPostHeaderWithRange=function(e,t){var n=u.getPostHeader(t);return n["Content-Range"]=e,n},u.authenticateOnHost=function(e,t,n,r,i){return u.sdkHostForced=n,u.appToken=r,u.fromSDK=!0,i?(config.xmpp.currentServer=u.sdkHostForced,config.webservices.currentServer=u.sdkHostForced,config.restServerUrl=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port,u.authenticateWithToken(i)):u.authenticate(e,t,!1)},u.authenticate=function(e,n,i,a){return t(function(t,o){r.info('[authService] authenticate with "'+e+'"'),u.getLocalStorageAuthInfo(!1).then(function(){return u.logon(e,n,i,a)}).then(function(){u.registerEventsHandler(),t()}).catch(function(e){r.error("[authService] authenticate failure -- "+e.message),o(e)})})},u.getUserAuthenticationSettings=function(n,i){return t(function(t,a){if(i){var o=d.createFromData([{type:"RAINBOW",loginUrl:config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/authentication/v1.0/login"}]);t(o)}else{var s={};u.setInformationHeaders(s),e({method:"GET",url:config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/authentication/v1.0/urls?uid="+n,headers:s,timeout:15e3}).then(function(e){var r=d.createFromData(e.data.data);r.setParameter("uid",function(){return n}),r.setParameter("x-rainbow-app-auth",u.getRainbowAppAuth.bind(this,config.rainbowApiClientKey,config.appModuleKey)),t(r)},function(e){var t='authenticate for login "'+n+'" failure : ',i="errorUltimateUnknownError";e||(t+="Ultimate unknown error"),0===e.status||-1===e.status?(t+="No server response",i="errorNoServerResponse"):404===e.status?(t+=e.data.errorDetails,i="unknownAccount"):500===e.status&&(t+=e.data.errorDetails,i="errorInternalServerError"),r.info("[authService] "+t),a(new RBError(t,i))})}})},u.getBasicAuthorizationCredentials=function(e,t){return n.btoa(unescape(encodeURIComponent((e||"")+":"+(t||""))))},u.getRainbowAppAuth=function(e,t,r){return n.btoa(unescape(encodeURIComponent((e||"")+":"+SHA256((t||"")+(r||"")))))},u.logon=function(a,c,l,d){return t(function(t,h){var f={Authorization:"Basic "+n.btoa(unescape(encodeURIComponent(a+":"+c))),Accept:"application/json"};u.setInformationHeaders(f),config.rainbowApiClientKey&&(f["x-rainbow-app-auth"]="Basic "+n.btoa(unescape(encodeURIComponent(config.rainbowApiClientKey+":"+SHA256(config.appModuleKey+c))))),u.fromSDK&&u.appToken&&u.appToken.appID&&(f["x-rainbow-app-auth"]="Basic "+n.btoa(unescape(encodeURIComponent(u.appToken.appID+":"+SHA256(u.appToken.appSecret+c)))));var p=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/authentication/v1.0/login";if(d)switch(d.type){case"RAINBOW":p=d.loginUrl;break;case"SAML":default:d.safetyUrl&&(p=d.safetyUrl)}e({method:"GET",withCredentials:!0,url:p,headers:f,timeout:15e3}).then(function(e){r.info('[authService] authenticate with "'+a+'" success'),o.disconnected=!1,u.userData=e.data.loggedInUser,u.token=e.data.token,u.userId=e.data.loggedInUser.id,u.login=e.data.loggedInUser.loginEmail,u.jidIm=e.data.loggedInUser.jid_im,u.jidTel=e.data.loggedInUser.jid_tel,u.jidPwd=e.data.loggedInUser.jid_password,u.initialized=e.data.loggedInUser.isInitialized,u.companyId=e.data.loggedInUser.companyId,u.logingItself=!0,u.trueLoging=!0,u.isGuest=e.data.loggedInUser.guestMode,u.creationDate=e.data.loggedInUser.creationDate,u.xmppDomain=u.jidIm.split("@")[1],u.handleUserLanguage(),i.get(["firstUse"]).then(function(e){("false"===e.firstUse||!1===e.firstUse)&&(u.firstUse=!1)}),i.set({firstUse:"false"}),u.rememberMe=l,l?(r.info("[authService] store credentials"),i.set({token:u.token,login:u.login,id:u.userId})):u.removeCredentials(),u.startTokenSurvey(),t()},function(e){var t,n,i='authenticate for login "'+a+'" failure : ',o="errorUltimateUnknownError";e||(i+="Ultimate unknown error"),0===e.status||-1===e.status?(i+="No server response",o="errorNoServerResponse"):401===e.status?(u.removeCredentials(),i+=e.data.errorDetails,t=e.data.errorDetailsCode,401500===e.data.errorDetailsCode?o=d&&c?s.instant("wrongAuthPwd",{text:s.instant("forgotYourPassword")}):"errorUnauthorized":401501===e.data.errorDetailsCode&&(o="errorLoginForbidden",e.data.errorDetailsData&&(n={delay:e.data.errorDetailsData.forbiddenDelay}))):500===e.status&&(i+=e.data.errorDetails,o="errorInternalServerError"),r.info("[authService] "+i),h(new RBError(i,o,t,n))})})},u.logout=function(){return t(function(e){var t=localStorage.getItem("authType");u.removeCredentials(),"true"!==l.getSetting("disableSingleLogout")&&u.authSettings&&u.authSettings.logoutUrl&&"SAML"===t?(r.info("[authService] SAML logout"),u.authSettings.setParameter("token",function(){return u.token}),e(u.authSettings.logoutUrl)):(r.info("[authService] logout"),e())})},u.setInformationHeaders=function(e){e["x-rainbow-client"]=u.getInformationHeadersApp(),e["x-rainbow-client-version"]=u.getInformationHeadersAppVersion()},u.getInformationHeadersApp=function(){return"web_sdk"},u.getInformationHeadersAppVersion=function(){return window.sdkversion?window.sdkversion:"9.9.99"},u.authenticateWithToken=function(e,n){return t(function(t,a){if(e){var o=c.decodeToken(e);if(u.token=e,u.login=o.user.loginEmail,u.userId=o.user.id,o.saml)var s="SAML";n?(r.info("[authService] store credentials"),i.set({token:u.token,login:u.login,id:u.userId,authType:s})):u.removeCredentials(),u.startTokenSurvey().then(function(){return u.getUserData()}).then(function(){return u.getUserAuthenticationSettings(u.login)}).then(function(e){u.authSettings=e}).then(function(){u.registerEventsHandler(),t()}).catch(function(e){var t=e?e.message:"unknown error";r.error("[authService] authenticateWithToken failure -- "+t),a(new Error(t))})}else a(new Error("No token provided"))})},u.authenticateWithProvidedCredentials=function(e){return e?u.getLocalStorageAuthInfo(!1).then(function(){return u.authenticateWithToken(e,u.rememberMe)}):u.authenticateWithLocalCredentials()},u.authenticateWithLocalCredentials=function(e){return t(function(n,i){u.getLocalStorageAuthInfo(!0).then(function(){return e&&u.login!==e?t.reject(new Error("Login account mismatch")):t.resolve()}).then(function(){return u.startTokenSurvey()}).then(function(){return u.getUserData()}).then(function(){return u.getUserAuthenticationSettings(u.login)}).then(function(e){u.authSettings=e}).then(function(){u.registerEventsHandler(),n()}).catch(function(e){r.error("[authService] authenticateWithLocalCredentials failure -- "+e.message),i(e)})})},u.getLocalStorageAuthInfo=function(e){return t(function(t,n){i.get(["token","appToken","login","server","support","id","rememberMe"]).then(function(i){r.info("[authService] get authentication token"),i.server&&"null"!==i.server&&"undefined"!==i.server?(config.xmpp.currentServer=i.server,config.webservices.currentServer=i.server,"openrainbow.net"===i.server&&(config.appModuleKey=config.dotNetAppModuleKey,config.rainbowApiClientKey=config.dotNetRainbowApiClientKey),"openrainbow.com"===i.server&&(config.appModuleKey=config.dotComAppModuleKey,config.rainbowApiClientKey=config.dotComRainbowApiClientKey)):u.sdkHostForced?(config.xmpp.currentServer=u.sdkHostForced,config.webservices.currentServer=u.sdkHostForced):(config.xmpp.currentServer=config.xmpp.server,config.webservices.currentServer=config.webservices.server),config.restServerUrl=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port,u.rememberMe=i.rememberMe,u.logingItself=!0,e?(u.token=i.token,u.appToken=i.appToken,u.login=i.login,u.userId=i.id,u.token&&u.login?t():n(new Error("No existing token"))):t()})})},u.startTokenSurvey=function(){return t(function(e,t){u.startAppTokenSurvey().then(function(){return u.startUserTokenSurvey()}).then(function(){r.debug("[authService] startTokenSurvey success"),e()}).catch(function(e){e&&e.message||(e=new Error("Unknown error")),r.error("[authService] startTokenSurvey failure -- "+e.message),t(e)})})},u.startUserTokenSurvey=function(e){var n=c.decodeToken(u.token),i=1e3*n.exp,s=(i-1e3*n.iat)/2,l=new Date(i),d=i-(new Date).valueOf();if(e&&r.info("[authService] on logon"),r.info("[authService] Extract auth token info (countRenewed: "+n.countRenewed+", maxTokenRenew: "+n.maxTokenRenew+", tokenExpirationDuration: "+d+")"),0>d)return r.info("[authService] auth token has already expired, display login page"),u.renewTokenInterval&&a.cancel(u.renewTokenInterval),u.token=null,o.$broadcast("ON_AUTH_TOKEN_EXPIRE"),t.reject(new Error("Token expired"));if(d<s)return r.info("[authService] auth token will expire in less "+s/1e3+" seconds, re-new it immediately"),u.renewAuthToken();var h=d-s;return r.info("[authService] start auth token survey (expirationDate: "+l+" tokenExpirationDuration: "+d+"ms usedExpirationDuration: "+h+"ms)"),u.renewTokenInterval&&a.cancel(u.renewTokenInterval),u.renewTokenInterval=a(function(){u.renewAuthToken()},h),t.resolve()},u.renewAuthToken=function(){return t(function(t,n){r.info("[authService] re-new authentication token"),e({method:"GET",url:config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/authentication/v1.0/renew",headers:u.getRequestHeader()}).then(function(e){r.info("[authService] renew authentication token success"),u.token=e.data.token,i.set({token:u.token}),o.$broadcast("ON_AUTH_TOKEN_RENEW"),u.startTokenSurvey(),t()},function(e){var t="renew authentication token failure -- "+(e.data&&e.data.errorDetails?e.data.errorDetails:"no details"),i=new Error(t);i.details="AUTH_TOKEN_EXPIRED",r.error("[authService] "+t),a.cancel(u.renewTokenInterval),o.$broadcast("ON_AUTH_TOKEN_EXPIRE"),n(i)})})},u.startAppTokenSurvey=function(){if(!u.appToken||"string"!=typeof u.appToken||!u.appToken.length)return r.info("[authService] No application token."),t.resolve();var e=c.decodeToken(u.appToken),n=1e3*e.exp,i=new Date(n),o=n-(new Date).valueOf();if(r.info("[authService] Extract application token info (countRenewed: "+e.countRenewed+", maxTokenRenew: "+e.maxTokenRenew+")"),0>o)return r.info("[authService] application token has already expired, re-new it immediately"),u.renewAppToken();if(3e4>o)return r.info("[authService] application token will expire in less 5 minutes, re-new it immediately"),u.renewAppToken();var s=o-24e3;return r.info("[authService] start application token survey (expirationDate: "+i+" tokenExpirationDuration: "+o+"ms usedExpirationDuration: "+s+"ms)"),u.renewAppTokenInterval&&a.cancel(u.renewAppTokenInterval),u.renewAppTokenInterval=a(function(){u.renewAppToken()},s),t.when()},u.renewAppToken=function(){return t(function(t,n){r.info("[authService] re-new application token"),e({method:"GET",url:config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/applications/v1.0/authentication/renew",headers:u.getRequestHeader()}).then(function(e){r.info("[authService] renew application token success"),u.appToken=e.data.token,i.set({appToken:u.appToken}),o.$broadcast("ON_APP_TOKEN_RENEW"),u.startAppTokenSurvey(),t()},function(e){var t="renew application token failure -- "+(e.data&&e.data.errorDetails?e.data.errorDetails:"no details"),i=new Error(t);i.details="APP_TOKEN_EXPIRED",r.error("[authService] "+t),a.cancel(u.renewAppTokenInterval),o.$broadcast("ON_APP_TOKEN_EXPIRE"),n(i)})})},u.getUserData=function(){return t(function(t,n){e({method:"GET",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+u.userId,headers:u.getRequestHeader()}).then(function(e){u.userData=e.data.data,u.login=e.data.data.loginEmail,u.jidIm=e.data.data.jid_im,u.jidTel=e.data.data.jid_tel,u.jidPwd=e.data.data.jid_password,u.initialized=e.data.data.isInitialized,u.companyId=e.data.data.companyId,u.isGuest=e.data.data.guestMode,u.xmppDomain=u.jidIm.split("@")[1],u.handleUserLanguage(),t(u.userData)},function(e){u.removeCredentials(),n(new Error("Wrong token -- "+e.message))})})},u.getCompanySAMLConfiguration=function(n){return t(function(t,i){r.debug("[authService] Get assertion configuration for a company"),e({method:"GET",url:config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/authentication/v1.0/saml/"+n+"/metadata.xml",headers:u.getRequestHeader()}).then(function(e){r.debug("[authService] getCompanySAMLConfiguration success"),t(e.data)},function(e){r.error("[authService] getCompanySAMLConfiguration failure -- "+JSON.stringify(e)),i(e)})})},u.getFingerPrint=function(){return t(function(e){u.browserFingerprint?e(u.browserFingerprint):imprint.test(["audio","availableScreenResolution","canvas","colorDepth","cookies","cpuClass","deviceDpi","doNotTrack","indexedDb","installedFonts","language","localIp","localStorage","pixelRatio","platform","plugins","processorCores","screenResolution","sessionStorage","timezoneOffset","touchSupport","userAgent","webGl"]).then(function(t){u.browserFingerprint=t,e(t)})})},u.handleUserLanguage=function(){var e=u.userData.language;e&&l.setAppliLangageCodeFromServer(e)},u.removeCredentials=function(){r.info("[authService] remove credentials");var e=["token","id","authType"];u.isGuest&&e.push("login"),i.remove(e),u.isGuest=!1},u.onInit()}])},function(){angular.module("rainbow").service("xmppService",["$rootScope","$log","$q","$interval","authService","helpersService","settingsService","utilService",function(e,t,n,r,i,a,o,s){"use strict";var c=this;c.disconnectionHandler=null,Strophe.log=function(e,n){switch(e){case Strophe.LogLevel.WARN:t.warn(n);break;case Strophe.LogLevel.ERROR:case Strophe.LogLevel.FATAL:t.error(n);break;default:t.debug(n)}},c.start=function(e){t.info(""),t.info("[xmppService] === STARTING ===");var r=performance.now();c.showBodyMessage="true"===o.getSetting("showBodyMessage"),c.started=!1,c.connected=!1,c.stropheStatus=null,c.presenceStatus="offline";var a=config.xmpp.pingInterval?config.xmpp.pingInterval:6e4;return this.pingTimeout=2*a,c.serverURL=config.xmpp.protocol+"://"+config.xmpp.currentServer+":"+config.xmpp.port+"/websocket",c.presenceWaitingList=[],c.jidsToRemove=[],c.fullJid=null,i.jidIm&&i.jidPwd?this.connect().then(function(){c.started=!0;var n=Math.round(performance.now()-r);e.push({service:"xmppService",startDuration:n}),t.info("[xmppService] === STARTED ("+n+" ms) ===")}).catch(function(e){return t.error("[xmppService] === STARTING FAILURE ("+e.message+") === "),n.reject(new Error("Starting failure : "+e.message))}):(t.info("Starting failure : No valid XMPP credentials"),n.reject(new Error("No valid XMPP credentials")))},c.stop=function(){try{return this.disconnect("Stop service").finally(function(){c.connection=null,c.started=!1,c.stropheStatus=null,c.presenceWaitingList=[],c.deferDisconnect=null,c.fullJid=null})}catch(e){return t.error("XMPP disconnect error : "+e),c.connection=null,c.started=!1,c.stropheStatus=null,c.presenceWaitingList=[],c.deferDisconnect=null,c.fullJid=null,n.when()}},c.connect=function(){t.info("[xmppService] -- ASK CONNECTION --");try{var a=n.defer();if(c.stropheStatus===Strophe.Status.CONNECTING||c.stropheStatus===Strophe.Status.CONNECTED||c.stropheStatus===Strophe.Status.AUTHENTICATING){t.info("[xmppService] already connecting");var o=new Error("XMPP service already-connected");return o.details="XMPP_ALLREADY_CONNECTED",n.reject(o)}return c.connection=new Strophe.Connection(c.serverURL+"?x-rainbow-client="+i.getInformationHeadersApp()+"&x-rainbow-client-version="+i.getInformationHeadersAppVersion()+"&x-rainbow-xmpp-dom="+i.xmppDomain),c.connection.rawInput=function(e){return c.handleRawXmppMessage(e,"Recv: ")},c.connection.rawOutput=function(e){return c.handleRawXmppMessage(e,"Sent: ")},c.connecting=!0,c.generateRandomFullJid(i.jidIm).then(function(n){c.fullJid&&(n=c.fullJid),c.connection.connect(n,i.jidPwd,function(n,o){switch(c.stropheStatus=n,o=angular.isUndefined(o)?"":o,n){case Strophe.Status.CONNECTING:t.info("[xmppService] -- Connecting --"),e.$broadcast("ON_CONNECTION_STATE_CHANGE_EVENT","inProgress");break;case Strophe.Status.AUTHFAIL:t.error("[xmppService] -- Authentication failure -- "+o),a.reject(new Error("Authentication failure -- "+o));break;case Strophe.Status.CONNFAIL:c.connecting&&(t.error("[xmppService] -- Connection failure -- "+o),a.reject(new Error("Connection failure -- "+o)));break;case Strophe.Status.CONNECTED:t.info("[xmppService] -- Connected -- "+c.connection.jid),c.connecting=!1,c.connected=!0,c.jid=i.jidIm,c.fullJid=c.connection.jid,c.connection.addHandler(c.onRosterChanged,"jabber:iq:roster","iq","set"),c.connection.addHandler(c.onMamMessageReceived,Strophe.NS.MAM,"message",null),c.connection.addHandler(c.onMamMessageReceived,Strophe.NS.MAM,"iq",null),c.connection.addHandler(c.onSearchTextMessageReceived,"urn:xmpp:mam:tmp","message",null),c.connection.jingle&&c.connection.jingle.attachHandlers(),c.addPresenceHandler(),c.presenceWaitingList=[],c.connection.ping.addPingHandler(function(e){var n=new Date;return t.info("[xmppService] -- Receive keepAlive Ping request ("+n+")"),c.connected&&c.connection.ping.pong(e),!0}),c.enableCarbon(),a.resolve();break;case Strophe.Status.DISCONNECTING:t.info("[xmppService] -- Disconnecting -- "+o);break;case Strophe.Status.DISCONNECTED:t.info("[xmppService] -- Disconnected -- "+c.fullJid),c.started?(e.$broadcast("ON_CONNECTION_STATE_CHANGE_EVENT","disconnected"),-1===c.jidsToRemove.indexOf(c.fullJid)&&(c.jidsToRemove.push(c.fullJid),c.jidsToRemove.forEach(function(e){t.info("[xmppService] -- invalid jid to remove -- "+e)})),c.deferDisconnect?(t.info("[xmppService] -- disable ping connection watcher"),c.connectionWatcherPromise&&r.cancel(c.connectionWatcherPromise),c.connected=!1,c.deferDisconnect.resolve()):c.connected&&!c.connecting?(t.error("[xmppService] -- Unexpected disconnection"),c.connecting=!0,c.connected=!1,e.disconnected=!0,c.disconnectionHandler()):c.connected||c.connecting||!c.fullJid?!c.connected&&!c.connecting&&!c.fullJid&&(t.error("[xmppService] -- Unexpected disconnection without fullJid"),c.connecting=!0,c.disconnectionHandler()):(t.error("[xmppService] -- Unexpected disconnection with fullJid"),c.connecting=!0,c.disconnectionHandler())):(t.info("[xmppService] -- received disconnect event but service not started !!"),t.info("[xmppService] -- disable ping connection watcher"),c.connectionWatcherPromise&&r.cancel(c.connectionWatcherPromise),e.disconnected=!0);break;default:t.error("[xmppService] -- Connection to the xmpp server failure -- "+n+" -- "+o),c.connecting?a.reject(new Error("Connection failure -- "+o)):c.disconnectionHandler()}})}),a.promise}catch(a){return t.error("XMPP service connect error : "+a),n.reject("catch-connect-error")}},c.handleRawXmppMessage=function(e,n){if(c.connectionWatcherPromise&&r.cancel(c.connectionWatcherPromise),c.connectionWatcherPromise=r(c.connectionWatcher,c.pingTimeout),!(-1<e.indexOf("<PHOTO>"))){var i=n;if(-1<e.indexOf("<message")&&(-1<e.indexOf("<body")||-1<e.indexOf("<content>")))i+=c.messageBodyDiscretion(e);else{var a=e,o=$(e).find("data");if(o&&"http://jabber.org/protocol/ibb"===o.attr("xmlns")&&(o.html("Encoded file in base 64"),i+=o.html()),!c.showBodyMessage){if(-1!==e.indexOf("<identity")){var l=e.indexOf("firstName="),d=e.indexOf("'",l);if(-1!==l&&-1!==d){var u=e.indexOf("'",d+1);d+1!==u&&(a=e.substr(0,d+2)+"***"+e.substr(u))}var h=a.indexOf("lastName="),f=a.indexOf("'",h);if(-1!==h&&-1!==f){var p=a.indexOf("'",f+1);f+1!==p&&(a=a.substr(0,f+2)+"***"+a.substr(p))}}if(-1!==a.indexOf("<caller_info")||-1!==a.indexOf("<callee_info")){var m=a.indexOf("number="),v=a.indexOf("'",m);if(-1!==m&&-1!==v){var g=a.indexOf("'",v+1);if(v+1!==g){var C=a.substr(v+1,g-v-1);a=a.substr(0,v+1)+s.anonymizePhoneNumber(C)+a.substr(g)}}}if(-1!==a.indexOf("<caller>")){var S=a.indexOf("<caller>"),E=a.indexOf("</caller>",S);-1===(C=a.substring(S+8,E)).indexOf("@")&&-1===C.indexOf("janus")&&(a=a.substr(0,S+8)+s.anonymizePhoneNumber(C)+a.substr(E))}if(-1!==a.indexOf("<callee>")){var b=a.indexOf("<callee>"),y=a.indexOf("</callee>",b);-1===(C=a.substring(b+8,y)).indexOf("@")&&-1===C.indexOf("janus")&&(a=a.substr(0,b+8)+s.anonymizePhoneNumber(C)+a.substr(y))}}i+=a}t.debug(i)}},c.messageBodyDiscretion=function(e){return c.showBodyMessage?e:(e=c.messageTagDiscretion("content",e),e=c.messageTagDiscretion("body",e),e=c.messageTagDiscretion("subject",e))},c.messageTagDiscretion=function(e,t){var n=t.indexOf("<"+e);if(-1!==n){var r=t.indexOf(">",n),i=t.indexOf("/>",n);if(-1!==r&&r!==i+1)return t.substr(0,r+2)+"***"+t.substr(t.indexOf("</"+e+">")-1)}return t},this.connectionWatcher=function(){try{if(t.error("[xmppService] -- Connection watcher : so bad, no message since "+c.pingTimeout/1e3+" seconds (no ping)"),c.connection){var e=c.stropheStatus===Strophe.Status.CONNECTED?"Have lost connectivity":"Stuck in reconnecting state";t.info("[xmppService] -- Connection watcher -- "+e),c.stropheStatus=null,c.connection.disconnect("No ping")}}catch(e){t.error("connectionWatcher error "+e)}},c.disconnect=function(e){return c.deferDisconnect=n.defer(),t.info("[xmppService] -- ASK DISCONNECTION --"),this.connected?c.stropheStatus===Strophe.Status.CONNECTED&&c.connection.disconnect(e):(t.info("[xmppService] -- disconnect - service is not started"),c.deferDisconnect.resolve()),c.deferDisconnect.promise},c.generateRandomFullJid=function(e){return c.generateRandomFullJidForWeb(e)},c.generateRandomFullJidForWeb=function(e){return n.when(e+"/web_sdk_"+version+"_"+a.randomString(8))},c.removeOldConnection=function(){r(function(){var e=c.jidsToRemove.map(function(e){return e&&""!==e?e===c.fullJid?void t.info("[xmppService] -- ignore disconnect obsolete jid for "+e):c.disconnectObsoleteJid(e).then(function(){t.info("[xmppService] -- disconnect obsolete jid -- "+e+" done")}):void t.info("[xmppService] -- ignore disconnect obsolete jid for empty jid")});c.jidsToRemove=[],n.all(e).catch(function(e){t.warn("[xmppService] -- somethings goes wrong during obsolete jid removal -- "+e.message)})},1e4,1)},c.disconnectObsoleteJid=function(e){var t=$iq({type:"set",id:a.randomString(8),from:c.fullJid}).c("disconnect",{xmlns:"jabber:iq:configuration"}).c("to").t(e);return c.sendIQ(t)},this.onRosterChanged=function(t){try{return angular.element(t).find("item").each(function(){var t=Strophe.getBareJidFromJid(angular.element(this).attr("jid")),n="favorites"===angular.element(this).find("group").first().text(),r=angular.element(this).attr("subscription"),i=angular.element(this).attr("ask");e.$apply(function(){e.$broadcast("ON_ROSTER_CHANGED_EVENT",{jid:t,subscription:r||"none",favorite:n,ask:i||"none"})})}),!0}catch(t){return!0}},this.addHistoryHandler=function(e){this.historyHandler=e},this.addSearchTextHandler=function(e){this.searchTextHandler=e},this.addHistoryCallLogsHandler=function(e){this.callLogHandler=e},this.onMamMessageReceived=function(e){t.info("[XmppService] onMamMessageReceived");try{var n=angular.element(e).find("result").attr("queryid");return n||(n=angular.element(e).find("fin").attr("queryid")),n&&0!==n.indexOf("tel_")&&c.historyHandler?c.historyHandler(e):c.callLogHandler&&c.callLogHandler(e),!0}catch(e){return!0}},this.onSearchTextMessageReceived=function(e){t.info("[XmppService] onSearchTextMessageReceived");try{var n=angular.element(e).find("result").attr("queryid");return n||(n=angular.element(e).find("fin").attr("queryid")),c.searchTextHandler&&c.searchTextHandler(n,e),!0}catch(e){return t.warn("[XmppService] onSearchTextMessageReceived error : "+e.message),!0}},this.addPresenceHandler=function(){return t.info("[xmppService] -- Add presence handler"),this.connection.addHandler(c.onPresence,null,"presence"),n.when()},this.sendPresence=function(e,n,r){if(this.connection||c.stropheStatus===Strophe.Status.CONNECTED)try{t.info("Send presence "+e+" - "+n+" ("+c.jid+")");var a=$pres();if(a.c("priority").t("5"),a.up(),e&&"online"!==e&&a.c("show").t(e),!n||e&&"online"!==e?n&&a.up().c("status").t(n):a.c("status").t(n),!this.connection||!this.connection.send)return void t.error('Try to send "presence IQ" but no xmpp connection');!0===r&&(a.c("application",{xmlns:"jabber:iq:application"}),a.c("appid").t(config.rainbowApiClientKey).up(),a.c("userid").t(i.userId)),this.connection.send(a)}catch(e){return void t.error("this.connection.send error : "+e)}else t.error('[xmppService] Try to send "presence IQ" but no xmpp connection')},this.resetPresence=function(e){t.info("Reset presence to "+c.presenceStatus+" ("+c.jid+")"),c.sendPresence(e.show,e.status)},this.onPresence=function(n){try{var r=angular.element(n).attr("from"),i=Strophe.getBareJidFromJid(r),a=angular.element(n).find("x").attr("xmlns"),o=angular.element(n).attr("type"),s=angular.element(n).find("show").text();if(a&&0===a.indexOf(Strophe.NS.MUC))return!0;if(0<angular.element(n).find("actor").length&&"jabber:iq:configuration"===angular.element(n).find("actor").attr("xmlns")&&(0<angular.element(n).find("avatar").length?e.$broadcast("ON_VCARD_UPDATE_EVENT",i,"avatar"):0<angular.element(n).find("data").length&&e.$broadcast("ON_VCARD_UPDATE_EVENT",i,"data"),angular.element(n).find("x").length&&"vcard-temp:x:update"===angular.element(n).find("x").attr("xmlns")))return!0;if("error"===o)t.error("Receive error presence message");else if("subscribe"===o)t.info("Receive subscribe from ("+i+")"),e.$broadcast("ON_ROSTER_SUBSCRIBE_EVENT",i);else{var l=$(n),d="offline",u="";"unavailable"!==o&&(s=l.find("show").text(),u=l.find("status").text(),d=""===s||"chat"===s?"online":"dnd"===s?"dnd":"xa"===s?"xa":"away");var h=l.find("delay").attr("stamp"),f=h?new Date(h):new Date,p=l.find("until").text(),m={jid:r,status:d,message:u,stamp:f,until:p=p?new Date(p):null};e.$$listeners&&e.$$listeners.ON_ROSTER_PRESENCE_CHANGED_EVENT?e.$broadcast("ON_ROSTER_PRESENCE_CHANGED_EVENT",m):(t.info("[XMPP Service] Receive presence message but contact service is not ready yet"),c.presenceWaitingList.push(m))}return!0}catch(n){return!0}},this.getPresenceWaitingList=function(){return c.presenceWaitingList},this.resetPresenceWaitingList=function(){c.presenceWaitingList=[]},this.enableCarbon=function(){var e=$iq({type:"set"});return e.c("enable",{xmlns:"urn:xmpp:carbons:2"}),c.sendIQ(e)},this.send=function(e){if(!c.connection&&c.stropheStatus!==Strophe.Status.CONNECTED)return t.error('[xmppService] Try to send "stanza" but no xmpp connection'),n.reject(new Error("No XMPP connection"));try{this.connection.send(e)}catch(e){return t.error("[xmppService] this.connection.send error : "+e),n.when()}return n.when()},this.sendIQ=function(e,r){if(!this.connection&&c.stropheStatus!==Strophe.Status.CONNECTED)return t.error('[xmppService] Try to send "iq" but no xmpp connection'),n.reject(new Error("No XMPP connection"));var i=n.defer();try{this.connection.sendIQ(e,function(e){i.resolve(e)},function(e){null===e?i.reject(new Error("XMPP request timeout")):i.reject(new Error(e.innerHTML))},r&&r>1e4?r:1e4)}catch(e){return t.error("[xmppService] this.connection.sendIQ error : "+e),n.reject(new Error("this.connection.sendIQ error"))}return i.promise},this.getBareJidFromJid=function(e){return Strophe.getBareJidFromJid(e)},this.getResourceFromJid=function(e){return Strophe.getResourceFromJid(e)},this.addHandler=function(e,t,n,r,i,a,o){return this.connection.addHandler(e,t,n,r,i,a,o)},this.deleteHandler=function(e){this.connection&&this.connection.deleteHandler(e)},this.addFileTransfertHandlers=function(e,t){this.connection.ibb.addIBBHandler(e),this.connection.si_filetransfer.addFileHandler(t)},this.addCallLogsHandler=function(e){this.rtcStartRef&&(this.connection.deleteHandler(this.rtcStartRef),this.rtcStartRef=null),this.rtcEndRef&&(this.connection.deleteHandler(this.rtcEndRef),this.rtcEndRef=null),this.rtcRingingRef&&(this.connection.deleteHandler(this.rtcRingingRef),this.rtcRingingRef=null),this.rtcStartRef=this.connection.addHandler(e,null,"message","webrtc-start"),this.rtcEndRef=this.connection.addHandler(e,null,"message","webrtc-end"),this.rtcRingingRef=this.connection.addHandler(e,null,"message","webrtc-ringing")},this.addTelephonyCallLogsHandler=function(e){this.telephonyMessageRef&&(this.connection.deleteHandler(this.telephonyMessageRef),this.telephonyMessageRef=null),this.telephonyIqRef&&(this.connection.deleteHandler(this.telephonyIqRef),this.telephonyIqRef=null),this.telephonyMessageRef=c.connection.addHandler(e,Strophe.NS.CALLLOG,"message",null),this.telephonyIqRef=c.connection.addHandler(e,Strophe.NS.CALLLOG,"iq",null)},this.addPubSubPublishHandler=function(e){c.connection.addHandler(e,"jabber:client","message","headline",null,"pubsub.demo-all-in-one-dev-1.opentouch.cloud")},this.getIpAddress=function(){return n(function(e,t){if(RTCPeerConnection){var n=new RTCPeerConnection({iceServers:[]}),r=function(){},i=[];n.createDataChannel(""),n.createOffer(n.setLocalDescription.bind(n),r),n.onicecandidate=function(a){if(a&&a.candidate&&a.candidate.candidate){var o=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(a.candidate.candidate);if(o&&2<=o.length){var s=o[1];i.push(s)}}else{if(n.onicecandidate=r,!i.length)return void t();e(i)}}}else t()})}}])},function(){angular.module("rainbow").service("contactService",["$q","$rootScope","$translate","$log","$injector","$http","xmppService","authService","Contact","$interval","settingsService","PromiseQueue","companyService","errorHelperService","utilService",function(e,t,n,r,i,a,o,s,c,l,d,u,h,f,p){"use strict";var m=this;m.start=function(n){r.info(""),r.info("[contactService] === STARTING ===");var i=performance.now();return e(function(a,f){if(m.userContact=null,m.contacts=[],m.dbContacts=[],m.jtelContacts={},m.contactPromises=[],m.getOrCreateContactPromises=[],m.networkSize=0,m.started=!1,m.changePasswordInfo=null,m.subscriptionPromiseQueue=u.create(),m.presentationModeActive=!1,m.awayStateActive=!1,m.busyState={status:null,message:null},m.forcedState=!1,m.manualState=!1,m.currentLanguage=d.getSetting("lang"),m.langUpdateEventHandlerCleaner&&m.langUpdateEventHandlerCleaner(),m.langUpdateEventHandlerCleaner=t.$on("ON_LANGUAGE_UPDATED_EVENT",function(e,t){m.currentLanguage=t,m.updateContactsLastActivity()}),m.rosterUpdateEventHandlerCleaner&&m.rosterUpdateEventHandlerCleaner(),m.rosterUpdateEventHandlerCleaner=t.$on("ON_ROSTER_CHANGED_EVENT",m.rosterChangedHandler),m.presenceUpdateEventHandlerCleaner&&m.presenceUpdateEventHandlerCleaner(),m.presenceUpdateEventHandlerCleaner=t.$on("ON_ROSTER_PRESENCE_CHANGED_EVENT",m.contactPresenceChangedHandler),m.calendarPresenceEventHandlerCleaner&&m.calendarPresenceEventHandlerCleaner(),m.calendarPresenceEventHandlerCleaner=t.$on("ON_CONTACT_CALENDAR_STATUS_CHANGE",m.contactCalendarPresenceChangedHandler),r.info("[contactService] Create userContact ("+o.jid+")"),m.userContact=new c,m.userContact.ask=null,m.userContact.subscription=null,m.userContact.id=o.jid,m.userContact.jid=o.jid,m.userContact.fullJid=o.fullJid,m.userContact.language=m.currentLanguage,m.userContact.updateFromUserData(s.userData),m.userContact.getAvatar(),m.userContact.updateRichStatus(),m.retrieveOpenInviteId().catch(function(){m.resetOpenInviteId()}),m.dbContacts[m.userContact.dbId]=m.userContact,m.contacts[m.userContact.id]=m.userContact,m.jtelContacts[m.userContact.jidtel]=m.userContact,!s.userData.language){var p=d.getAppliLanguageCodeForServer();m.updateUserContact({language:p})}m.getUserSettings().then(function(t){return m.manageCalendarPresencePrompt(t),d.settings.activeAlarm=t.activeAlarm,d.settings.activeNotif=t.activeNotif,r.info("[contactService] Get alarm & notif data ("+d.settings.activeAlarm+" / "+d.settings.activeNotif+")"),d.settings.protectionAgainstMailTypeOffline=t.protectionAgainstMailTypeOffline,r.info("[contactService] Get mail setting data ("+d.settings.protectionAgainstMailTypeOffline+")"),e.resolve()}).then(function(){return h.getCompanyById(m.userContact.company.id)}).then(function(e){return m.userContact.company=e,m.attachHandlers(),m.getMyNetwork()}).then(function(){return m.updateNetworkWithRosterInfo()}).then(function(){m.appActiveEventHandlerCleaner&&m.appActiveEventHandlerCleaner(),m.appActiveEventHandlerCleaner=t.$watch("appActive",function(e){return r.info("[contactService] AppActive changed : "+e),!e&&m.userContact&&"online"===m.userContact.status&&(m.awayStateActive=!0),e&&m.awayStateActive&&(m.awayStateActive=!1),angular.isDefined(e)&&m.updatePresence(!0),!0}),m.vcardUpdateEventHandlerCleaner&&m.vcardUpdateEventHandlerCleaner(),m.vcardUpdateEventHandlerCleaner=t.$on("ON_VCARD_UPDATE_EVENT",m.onVCardChangeEvent),m.getMissedPresenceMessages();var e=Math.round(performance.now()-i);n.push({service:"contactService",startDuration:e}),r.info("[contactService] === STARTED ("+e+" ms) ==="),m.started=!0,a()}).catch(function(e){r.error("[contactService] === STARTING FAILURE === "+e.message),f(e)}),m.connectionStateEventHandlerCleaner&&m.connectionStateEventHandlerCleaner(),m.connectionStateEventHandlerCleaner=t.$on("ON_CONNECTION_STATE_CHANGE_EVENT",m.onConnectionStateChangeEvent),m.contactLastActivityTimerInterval=l(m.updateContactsLastActivity,6e4)})},m.manageCalendarPresencePrompt=function(e){if(void 0!==e.promptForCalendarPresence)d.setSetting("disableCalendarPresence",e.promptForCalendarPresence?"false":"true"),r.info("[contactService] promptForCalendarPresence -- "+e.promptForCalendarPresence);else{var t="true"!==d.getSetting("disableCalendarPresence");r.info("[contactService] MIGRATION NECESSARY -- promptForCalendarPresence : "+t),m.setUserSettings({promptForCalendarPresence:t})}},m.getMyNetwork=function(){return e(function(e,t){var n=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/networks?limit=2000";a({method:"GET",url:n,headers:s.getRequestHeader()}).then(function(t){var n=t.data.data;r.info("[contactService] GetMyNetwork success -- find "+n.length+" contact(s)"),n.forEach(function(e){var t=new c;t.updateFromUserData(e),m.contacts[t.id]=t,m.dbContacts[t.dbId]=t,m.jtelContacts[t.jidtel]=t,t.updateRichStatus(),t.getAvatar(),m.sendUpdateEvent(t)}),m.networkSize=n.length,e()},function(){var e="GetMyNetwork failure";r.error("[contactService] "+e),t(new Error(e))})})},m.updateNetworkWithRosterInfo=function(){return e(function(e,t){o.sendIQ($iq({type:"get"}).c("query",{xmlns:"jabber:iq:roster"})).then(function(t){r.info("[contactService] Get rosters info successfully"),$(t).find("item").each(function(){var e=$(this),t=o.getBareJidFromJid(e.attr("jid"));if(t&&t.length&&!m.isTelJid(t)){var n=m.contacts[t];if(n){var i=e.attr("ask"),a=e.attr("subscription");n.ask=angular.isDefined(i)?i:"none",n.subscription=angular.isDefined(a)?a:"none",n.roster=!0,n.updateRichStatus(),r.info("[contactService] Update contact from roster ("+n.ask+", "+n.subscription+") "+t)}}}),e()}).catch(function(e){r.error("[contactService] Get rosters failure : "+e.message),t(e)})})},m.getMissedPresenceMessages=function(){r.info("[contactService] GetMissedPresenceMessages");try{var e=o.getPresenceWaitingList();if(e.length){for(r.info("[contactService] GetMissedPresenceMessages length "+e.length);0<e.length;){var t=e.pop();m.contactPresenceChangedHandler(null,t)}o.resetPresenceWaitingList()}}catch(e){r.error("[contactService] GetMissedPresenceMessages error "+e)}},m.attachHandlers=function(){r.info("[contactService] AttachHandlers"),this.contactConfigRef&&(o.connection.deleteHandler(this.contactConfigRef),this.contactConfigRef=null),this.contactConfigRef=o.connection.addHandler(m.onUserManagementEvent,null,"message","management")},m.stop=function(){return r.info("[contactService] Stopping"),m.userContact=null,m.contacts=null,m.dbContacts=null,m.started=!1,m.presentationModeActive=!1,m.awayStateActive=!1,m.busyState={status:null,message:null},m.forcedState=!1,m.manualState=!1,r.info("[contactService] Stopped"),m.vcardUpdateEventHandlerCleaner&&(m.vcardUpdateEventHandlerCleaner(),m.vcardUpdateEventHandlerCleaner=null),m.connectionStateEventHandlerCleaner&&(m.connectionStateEventHandlerCleaner(),m.connectionStateEventHandlerCleaner=null),m.contactLastActivityTimerInterval&&(l.cancel(m.contactLastActivityTimerInterval),m.contactLastActivityTimerInterval=null),e.when()},m.onConnectionStateChangeEvent=function(e,t){if("disconnected"===t&&m.userContact){for(var n in m.userContact.resources={},m.contacts)m.contacts.hasOwnProperty(n)&&!m.contacts[n].isBot&&(m.contacts[n].resources={},"unknown"!==m.contacts[n].status&&"none"!==m.contacts[n].subscription&&(m.contacts[n].status="offline",m.contacts[n].imStatusStamp={}));m.presentationModeActive=!1,m.awayStateActive=!1,m.busyState={status:null,message:null},m.forcedState=!1,m.manualState=!1}},m.onVCardChangeEvent=function(t,n,i){r.info("[contactService] onVCardChangeEvent event: "+t+" || status: "+n+" || type: "+i),l(function(){var t=m.getContactByJid(n);t&&("avatar"===i||"data"===i?m.getVCardByDbId(t.dbId,!0).then(function(){return"avatar"===i?t.getAvatar(256,!0):e.when()}).then(function(){m.sendUpdateEvent(t)}):m.sendUpdateEvent(t))},2e3,1)},m.onUserManagementEvent=function(e){try{var n=$(e).find("usersettings");if(n.length&&"update"===n.attr("action"))return r.info("[contactService] onUserManagementEvent - should update the presence"),m.sendPresenceFromConfiguration(),!0;var i=$(e).find("userpassword");if(i.length&&"update"===i.attr("action"))return r.info("[contactService] onUserManagementEvent - userPassword updated"),m.changePasswordInfo||(m.changePasswordInfo={fromThirdParty:!0}),!0;var a=$(e).find("openinvite");if(a.length&&"update"===a.attr("action")){r.info("[contactService] onUserManagementEvent - update about openinviteid");var o=m.userContact.getOpenInviteId();return m.retrieveOpenInviteId().then(function(){o!==m.userContact.getOpenInviteId()&&t.$broadcast("ON_OPEN_INVITE_ID_UPDATED_EVENT")}),!0}return!0}catch(e){return!0}},m.updateUserContactFullJid=function(){m.userContact.fullJid=o.fullJid,m.attachHandlers()},this.getMinimumContactByDBId=function(t){return e(function(e){e(m.createEmptyContactContact(t))})},m.createEmptyContactContact=function(e){var t=m.createBasicContact(e);return t.initials="?",t.displayName="Unknown contact",t.lastname="Unknown contact",t.firstname="",t.temp=!0,t.avatar=new Image,t.avatar.src="/resources/skins/rainbow/images/conversations/unknownContact.png",t},m.getContact=function(e,t){var n=e||t;return this.isUserContactJid(n)?m.userContact:this.contacts[n]},m.getOrCreateContact=function(t,n){if(!t&&!n)return e.reject(new Error("No jid or no phoneNumber"));m.contacts||(m.contacts=[]);var i=m.getContact(t,n);if(i)return e.resolve(i);if(t&&-1===t.indexOf("@"))return e.reject(new Error("Invalid jid "+t));var a=t||n;return t?(m.getOrCreateContactPromises[a]||(m.getOrCreateContactPromises[a]=e(function(e,o){m.getVCardInfoByJid(t).then(function(r){(i=m.createBasicContact(t,n,!1)).updateFromUserData(r),i.updateRichStatus(),i.getAvatar(),m.contacts[i.id]=i,m.dbContacts[i.dbId]=i,m.jtelContacts[i.jidtel]=i,m.sendUpdateEvent(i),e(i),delete m.getOrCreateContactPromises[a]}).catch(function(e){r.error("[contactService] getOrCreateContact -- failure -- "+e.message),o(e),delete m.getOrCreateContactPromises[a]})})),m.getOrCreateContactPromises[a]):e.resolve(i=m.createBasicContact(null,n))},this.createBasicContact=function(e,t,n){r.debug("[contactService] CreateContact "+e+" "+p.anonymizePhoneNumber(t));var i=new c;if(!e)return i.id=t,i.initials="?",i.displayName=t||"Unknown contact",i.lastname=t||"Unknown contact",i.firstname="",i.phoneProCan=t||"",i.temp=!0,i.avatar=new Image,i.avatar.src="/resources/skins/rainbow/images/conversations/unknownContact.png",i.setNameUpdatePrio(c.NameUpdatePrio.NO_UPDATE_PRIO),i;var a=e;return a||(a=t,i.phoneProCan=t),a||(a="anonymous"),i.jid=e,i.id=a,i.ask="none",i.subscription="none",i.updateRichStatus(),!1!==n&&(m.contacts[i.id]=i),i},this.getContactByJid=function(e){var t=null;return this.isUserContactJid(e)?t=m.userContact:this.contacts?t=this.contacts[e]:this.contacts=[],t},this.getContactByEmail=function(e){var t=null;for(var n in this.contacts)this.contacts.hasOwnProperty(n)&&this.contacts[n].containsEmail(e)&&(t=this.contacts[n]);return t},this.getContacts=function(){var e=[];for(var t in this.contacts)this.contacts.hasOwnProperty(t)&&e.push(this.contacts[t]);return e},this.searchContacts=function(e){return this.getContacts().filter(function(t){return(t.roster||t.isBot)&&!t.isTerminated&&m.contactMatcher(t,e)})},this.contactMatcher=function(e,t){var n=e.firstname+" "+e.lastname,r=t.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").split(/[ ]+/),i=n.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").split(/[ ]+/);return r.every(function(e){return i.some(function(t,n){return!(!t.length||0!==t.indexOf(e)||(i[n]="",0))})})},m.getContactById=function(e){return m.dbContacts[e]},m.getContactByDBId=function(t,n){var i=m.dbContacts[t];if(!n&&i)return e.when(i);var o=m.contactPromises[t];if(o)return r.debug("[contactService] getContactByDBId for "+t+" already lauched"),o.promise;var c=e.defer();m.contactPromises[t]=c;var l=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+t;return a({method:"GET",url:l,headers:s.getRequestHeader()}).then(function(e){var n=e.data.data;r.info("[contactService] GetContactByDBId ("+t+") -- "+n.jid_im+" -- success");var a=i||m.createBasicContact(n.jid_im);a.updateFromUserData(n),a.getAvatar(),m.dbContacts[a.dbId]=a,m.jtelContacts[a.jidtel]=a,c.resolve(a),delete m.contactPromises[t]},function(e){var n=f.handleError(e);c.reject(n),delete m.contactPromises[t],r.error("[contactService] "+f.getErrorFullMessage(e,"GetContactByDBId"))}),c.promise},m.completeContactPhoneNumbers=function(t){return e(function(e,n){return t.isBot?void n(new Error("No phone numbers for bot contacts")):void(t.phoneNumbersInitialized?e(t):m.getContactByDBId(t.dbId,!0).then(function(t){e(t)}).catch(function(e){n(e)}))})},m.getOpenInviteIdLink=function(){var e=this.userContact.getOpenInviteId(),t=n.instant("notAvailable"),r=config.webUrl.replace("web","meet");return e&&(t=r+"/"+e),t},m.retrieveOpenInviteId=function(){return e(function(e,t){var n=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+m.userContact.dbId+"/open-invites";a({method:"GET",url:n,headers:s.getRequestHeader()}).then(function(n){var i=n.data.data;if(i&&i.openInviteId)m.userContact.setOpenInviteId(i.openInviteId),e(i.openInviteId);else{var a="retrieveOpenInviteId failure -- No openInviteId";r.error("[contactService] "+a),t(new Error(a))}},function(){var e="retrieveOpenInviteId failure";r.error("[contactService] "+e),t(new Error(e))})})},m.resetOpenInviteId=function(){return e(function(e,t){var n=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+m.userContact.dbId+"/open-invites/reset";a({method:"POST",url:n,headers:s.getRequestHeader()}).then(function(n){var i=n.data.data;if(i&&i.openInviteId)m.userContact.setOpenInviteId(i.openInviteId),e(i.openInviteId);else{var a="resetOpenInviteId failure -- something wrong when resetting";r.error("[contactService] "+a),t(new Error(a))}},function(){var e="resetOpenInviteId failure";r.error("[contactService] "+e),t(new Error(e))})})},this.getContactsByJids=function(t){return e(function(e,n){r.info("[contactService] getContactsByJids with ["+t.join()+"]");var i=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port;a({method:"POST",headers:s.getPostHeader(),url:i+"/api/rainbow/enduser/v1.0/users/jids?limit=1000",data:{jid_im:t}}).then(function(t){t.data.data.forEach(function(e){var t=m.getContactByJid(e.jid_im);t||(t=new c),t.updateFromUserData(e),m.contacts[t.id]=t,m.dbContacts[t.dbId]=t,m.jtelContacts[t.jidtel]=t,t.getAvatar(),t.temp=!1}),e()},function(e){var t=f.handleError(e);n(t),r.error("[contactService] "+f.getErrorFullMessage(e,"getContactsByJids"))})})},this.getContactsByEmails=function(t){return e(function(e,n){r.info("[contactService] getContactsByEmails with ["+t.join()+"]");var i=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/loginemails",o=t.map(function(e){return e.toLowerCase()});a({method:"POST",headers:s.getPostHeader(),url:i,data:{loginEmail:o}}).then(function(t){var n={},r=[];t.data.data.forEach(function(e){var t=m.dbContacts[e.id];t||(t=new c,m.contacts[t.id]=t,m.dbContacts[t.dbId]=t,m.jtelContacts[t.jidtel]=t),t.updateFromUserData(e),t.getAvatar(),n[t.loginEmail]=t,r.push(t),o.splice(o.indexOf(t.loginEmail.toLowerCase()),1)}),e({contacts:n,contactsArray:r,emails:o})},function(e){var t=f.handleError(e);n(t),r.error("[contactService] "+f.getErrorFullMessage(e,"getContactsByEmails"))})})},m.getUserSettings=function(){return e(function(e){var t=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+m.userContact.dbId+"/settings";a({method:"GET",url:t,headers:s.getRequestHeader()}).then(function(t){r.info("[contactService] GetUserSettings success");var n=t.data.data.presence||"online",i=t.data.data.activeAlarm||"relax1",a=t.data.data.activeNotif||"notif1",o=t.data.data.promptForCalendarPresence,s=t.data.data.protectionAgainstMailTypeOffline;e({presence:n,activeAlarm:i,activeNotif:a,promptForCalendarPresence:o,protectionAgainstMailTypeOffline:s})},function(t){r.error("[contactService] "+f.getErrorFullMessage(t,"GetUserSettings")),e({presence:"online",activeAlarm:"relax1",activeNotif:"notif1",promptForCalendarPresence:!1})})})},m.setUserSettings=function(t){return e(function(e,n){var i=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+m.userContact.dbId+"/settings";a({method:"PUT",url:i,headers:s.getRequestHeader(),data:t}).then(function(){r.info("[contactService] SetUserSettings "+JSON.stringify(t)+" -- success"),e()},function(e){var t=f.handleError(e);r.error("[contactService] "+f.getErrorFullMessage(e,"SetUserSettings")),n(t)})})},m.getVCardByDbId=function(t,n){return e(function(e,i){var o=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+t;a({method:"GET",url:o,headers:s.getRequestHeader()}).then(function(t){var r=t.data.data,i=m.contacts[r.jid_im];i.updateFromUserData(r),i.updateRichStatus(m.isUserContactJid(r.jid_im)),n||i.getAvatar(),m.sendUpdateEvent(i),e(i)},function(e){var t=f.handleError(e);i(t),r.error("[contactService] "+f.getErrorFullMessage(e,"getVCardByDbId"))})})},m.getVCardInfoByJid=function(t){return e(function(e,n){var i=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/jids/"+t;a({method:"GET",url:i,headers:s.getRequestHeader()}).then(function(t){e(t.data.data)}).catch(function(e){r.error("[contactService] "+f.getErrorFullMessage(e,"getVCardInfoByJid")),n(f.handleError(e))})})},m.getVCardInfoByEmail=function(t){return e(function(e,n){var i=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/loginemails?format=full";a({method:"POST",url:i,headers:s.getRequestHeader(),data:{loginEmail:[t]}}).then(function(t){e(t.data.data)}).catch(function(e){r.error("[contactService] "+f.getErrorFullMessage(e,"getVCardsByEmail")),n()})})},this.pushAvatarImage=function(t){var n=e.defer(),i=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port;r.info("[contactService] Push avatar image ");var o=m.userContact.avatar;return m.resizeImage(t,512,512).then(function(e){m.userContact.avatar=e;var t=m.getBinaryData(e);a({method:"POST",url:i+"/api/rainbow/enduser/v1.0/users/"+m.userContact.dbId+"/avatar",headers:s.getPostHeader("image/"+t.type),data:t.data,transformRequest:[]}).then(function(){n.resolve()},function(e){m.userContact.avatar=o;var t=f.handleError(e);n.reject(t),r.error("[contactService] "+f.getErrorFullMessage(e,"pushAvatarImage"))})}),n.promise},this.resizeImage=function(t,n,r){var i=e.defer(),a=new Image;return a.src=t,a.onload=function(){var e=a.width,t=a.height;e>t?e>n&&(t*=n/e,e=n):t>r&&(e*=r/t,t=r);var o=document.createElement("canvas");o.width=e,o.height=t,a.width=e,a.height=t,a.crossOrigin="Anonymous",o.getContext("2d").drawImage(this,0,0,e,t);var s=new Image;s.src=o.toDataURL("image/png"),i.resolve(s)},i.promise},this.getBinaryData=function(e){for(var t=e.src.indexOf("image/")+6,n=e.src.indexOf(";base64,"),r=e.src.slice(n+8),i=e.src.slice(t,n),a=window.atob(r),o=a.length,s=new Uint8Array(o),c=0;c<o;c++)s[c]=a.charCodeAt(c);return{type:i,data:s}},this.sendSubscription=function(t){return"to"===t.subscribe||"both"===t.subscribe?e.when(t):(m.sendSubscribeInvitation(t.jid),m.sendSubscribeInvitation(t.jidtel),e.when(t))},m.sendSubscribeInvitation=function(e){return r.info("[contactService] Send subscribe invitation to "+e),o.send($pres({to:e,type:"subscribe"}))},m.rosterChangedHandler=function(e,t){m.subscriptionPromiseQueue.add(function(){return m.rosterChangedHandlerPromise(t)})},m.rosterChangedHandlerPromise=function(n){return m.isTelJid(n.jid)?(r.debug("[contactService] Contact changed ("+n.jid+") ignored"),e.when()):e(function(e){var i=n.subscription,a=n.ask,o=n.jid;m.getOrCreateContact(o).then(function(o){"remove"===i?(o.ask="none",o.subscription="none",o.roster=!1):(o.ask=a,o.subscription=i,o.roster=!0,"both"===i&&m.updatePresence(!0)),o.updateRichStatus(),m.sendUpdateEvent(o),t.$broadcast("ON_CONTACT_ROSTER_UPDATE_EVENT"),r.info("[contactService] rosterChangedHandler - contact "+n.jid+" changed ("+a+", "+i+") success"),e()}).catch(function(t){r.error("[contactService] rosterChangedHandler - contact "+n.jid+" failure - "+t.message),e()})})},this.updateUserContact=function(t){r.info("[contactService] updateUserContact");var n=e.defer(),i=config.restServerUrl+"/api/rainbow/enduser/v1.0/";return a({method:"PUT",url:i+"users/"+s.userId,headers:s.getPostHeader(),data:t}).then(function(e){r.info("[contactService] updateUserContact successfully"),m.userContact.updateFromUserData(e.data.data),n.resolve()},function(e){var t=f.handleError(e);n.reject(t),r.error("[contactService] "+f.getErrorFullMessage(e,"updateUserContact"))}),n.promise},m.updateUserPassword=function(t,n,i){var o=e.defer();return m.changePasswordInfo={defered:o,newPassword:n},a({method:"PUT",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+s.userId+"/change-password",headers:s.getPostHeader(),data:{oldPassword:t,newPassword:n}}).then(function(){r.info("[contactService] updateUserPasswordRequest -- success"),i||o.resolve()}).catch(function(e){r.error("[contactService] "+f.getErrorFullMessage(e,"updateUserPasswordRequest")),m.changePasswordInfo=null,o.reject(f.handleError(e))}),o.promise},this.deleteUserAccount=function(){return e(function(e,t){r.info("[contactService] deleteUserAccount"),a({method:"DELETE",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+m.userContact.dbId,headers:s.getRequestHeader()}).then(function(){r.info("[contactService] deleteUserAccount -- success"),e()}).catch(function(e){r.error("[contactService] "+f.getErrorFullMessage(e,"deleteUserAccount")),t(f.handleError(e))})})},this.isTelJid=function(e){return 0===e.indexOf("tel_")},this.getImJid=function(e){var t=o.getBareJidFromJid(e);if(this.isTelJid(t)){var n=this.jtelContacts[t];return n?n.jid:(r.warn("[contactService] -- getIMJid("+e+") -- failure -- no associated contact"),null)}return t},this.getRessourceFromJid=function(e){var t="";if(e){var n=e.indexOf("/");-1!==n&&(t=e.substr(n+1))}return t},this.isUserContactJid=function(e){return!(!m.userContact||!e||0===e.length)&&e.startsWith(m.userContact.jid)},this.isUserContact=function(e){return!(!e||!e.jid||0===e.jid.length)&&(m.userContact?e.jid.startsWith(m.userContact.jid):e.jid.startsWith(o.jid))},m.updateContactsLastActivity=function(){m.contacts&&Object.keys(m.contacts).forEach(function(e){m.contacts[e].updateLastActivityMessage()})},m.updateLastActivity=function(e){e.lastActivityDate="offline"===e.status||"away"===e.status?e.getLastAvailableDate():null},this.createBotContact=function(e,t,n){var r;return r=m.contacts[e]?c.updateContactToBot(m.contacts[e],t,n):c.createBotContact(e,t,n),m.contacts[r.id]=r,r},this.contactPresenceChangedHandler=function(e,t){if("calendar"!==m.getRessourceFromJid(t.jid)){var n=m.getImJid(t.jid);!n||n.startsWith("room")||m.getOrCreateContact(n).then(function(e){m.isTelJid(t.jid)?(r.info("[contactService] Update telephony presence ("+n+") : "+t.message),e.updateTelephonyStatus(t.message,m.isUserContact(e))):(r.info("[contactService] Update im presence contact ("+n+") : "+t.status+" "+t.stamp),m.isUserContact(e)&&"mode=auto"===t.message&&"online"!==e.status&&e.resources.hasOwnProperty(t.jid)&&t.jid!==e.fullJid&&"EVT_SERVICE_INITIATED"!==e.telStatus&&"EVT_ESTABLISHED"!==e.telStatus&&(e.resources[e.fullJid]&&"online"===e.resources[e.fullJid].show?r.info("[contactService] Current ressource is already online, ignore message!"):(m.manualState&&(r.info("[contactService] User is in manual state, leave it"),m.setUserContactStatus("online","mode=auto")),m.busyState&&"dnd"===m.busyState.status&&"busy"!==m.userContact.status&&(r.info("[contactService] User is in call, re-update presence state"),l(function(){m.updatePresence(!0)},500,1,!0)))),e.updateIMStatus(t,m.isUserContact(e)),m.updateLastActivity(e)),m.sendUpdateEvent(e)})}},this.contactCalendarPresenceChangedHandler=function(e,t){t.updateCalendarPresenceInfo()},this.setUserContactStatus=function(e,t,n){try{if(r.info("[contactService] Set userContact status : "+e+(t?"("+t+")":"")),o.started)"online"===e?(m.manualState=!1,o.sendPresence(null,t,n)):(m.manualState=!0,"away"===e?o.sendPresence("away",t):"dnd"===e?o.sendPresence("dnd",t):"xa"==e&&o.sendPresence("xa",t));else if("online"===e){i.get("serviceLauncher").startServices()}}catch(e){r.error("[contactService] Set userContact status error : "+e)}},this.sendPresenceFromConfiguration=function(n){r.info("(with auth info)");var i=e.defer();return m.getUserSettings().then(function(e){var a="",o=e.presence;if("invisible"===o?o="xa":"away"==o&&(o="xa",a="away"),r.info("[contactService] sendPresenceFromConfiguration -> getUserSettings are "+o+" || message : "+a),m.userContact&&m.userContact.resources&&m.userContact.resources[m.userContact.fullJid]){var s=m.userContact.resources[m.userContact.fullJid];s&&(s.show!==o||"xa"===s.show&&s.status!==a)?(!m.busyState||"dnd"!==m.busyState.status||m.manualState)&&(r.info("[contactService] sendPresenceFromConfiguration should update my status from "+s.show+" to "+o+" ("+a+")"),m.setUserContactStatus(o,a,n)):t.$broadcast("ON_RELOAD_CAPABILITIES_FOR_MY_CONYTACT")}else r.info("[contactService] sendPresenceFromConfiguration set initial presence "),m.setUserContactStatus(o,a,n);i.resolve()}).catch(function(){r.info("[contactService] sendPresenceFromConfiguration failure, send online"),m.setUserContactStatus("online",null,n),i.resolve()}),i.promise},m.updateUserSettings=function(e,t){var n="online";"xa"===e&&"away"===t?n="away":"dnd"===e?n="dnd":"xa"==e&&(n="invisible"),m.setUserSettings({presence:n})};var v,g=null;this.onPresentationModeChangedEvent=function(e,t){"active"===t?m.presentationModeActive=!0:"disable"==t&&(m.presentationModeActive=!1),null===g&&(r.debug("[contactService] onPresentationModeChangedEvent status:"+t+" request presence update"),g=m.presentationModeActive,m.updatePresence()),function e(){r.debug("[contactService] startUpdatePresentationModeRefreshTimer"),null!==v&&(l.cancel(v),v=null),v=l(function(){r.debug("[contactService] startUpdatePresentationModeRefreshTimer interval reach"),g===m.presentationModeActive?(r.debug("[contactService] startUpdatePresentationModeRefreshTimer interval - no presence update needed"),g=null):(r.debug("[contactService] startUpdatePresentationModeRefreshTimer interval - request presence update"),g=m.presentationModeActive,m.updatePresence(),e())},1e3,1,!0)}()},this.changeMyPresence=function(e){if(r.info("[contactService] changeMyPresence "+e+" "+m.userContact.message),("dnd"!==e||"presentation"!==m.userContact.message)&&"busy"!==e){var t="";"online"===e&&(t="mode=auto"),"away"===e&&(e="xa",t="away"),m.setUserContactStatus(e,t),"online"===e&&l(function(){m.manualState=!1,m.updatePresence()},1e3,1,!0),m.updateUserSettings(e,t)}},this.computeStatusList=function(){var e=[];return m.userContact&&m.userContact.status&&(r.info("[contactService] computeStatusList "+m.userContact.status+" "+m.userContact.message),e="offline"===m.userContact.status?["online"]:"busy"===m.userContact.status?["busy"]:"dnd"===m.userContact.status&&"presentation"===m.userContact.message?["dnd"]:["online","away","xa","dnd"]),e},this.resetBusyState=function(){r.info("[contactService] resetBusyState"),m.setBusyState(null,null,!0),m.sendPresenceFromConfiguration()},this.setBusyState=function(e,t,n){r.info("[contactService] setBusyState -- "+e+" -- "+t),m.busyState={status:e,message:t},n||m.updatePresence()},t.$on("$destroy",t.$on("ON_PRESENTATION_MODE_CHANGED_EVENT",m.onPresentationModeChangedEvent)),this.updatePresence=function(e){r.info("[contactService] updatePresence"),m.manualState?(r.info("[contactService] updatePresence manualState"),"away"===m.userContact.status&&m.busyState&&"dnd"===m.busyState.status&&(m.setUserContactStatus("online","mode=auto"),l(function(){m.updatePresence()},1e3,1,!0))):!m.presentationModeActive||m.busyState&&m.busyState.status?m.busyState&&"dnd"===m.busyState.status?(r.info("[contactService] updatePresence dnd "+m.busyState.message),o.sendPresence("dnd",m.busyState.message)):m.awayStateActive?(r.info("[contactService] updatePresence away"),o.sendPresence("away","")):m.userContact&&"online"!==m.userContact.status?(r.info("[contactService] updatePresence online"),m.setUserContactStatus("online")):e&&m.userContact&&"online"===m.userContact.status&&(r.info("[contactService] updatePresence forced online"),m.setUserContactStatus("online")):(r.info("[contactService] updatePresence dnd presentation"),o.sendPresence("dnd","presentation"))},this.removeContact=function(t){return e(function(e,n){return t?(r.info("[contactService] removeContact : "+t.displayNameForLog()),void m.removeContactFromRoster(t.dbId).then(function(){r.info("[contactService] removeContact : "+t.displayNameForLog()+" success"),e()}).catch(function(e){r.error("[contactService] removeContact: "+t.displayNameForLog()+" failure : "+e.message),n(e)})):(r.error("[contactService] removeContact : missing contact !"),void n())})},this.removeContactFromRoster=function(t){return e(function(e,n){if(!t)return r.error("[contactService] removeContactFromRoster : missing id !"),void n();r.info("[contactService] removeContactFromRoster for id "+t);var i=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/networks/"+t;a({method:"DELETE",url:i,headers:s.getRequestHeader()}).then(function(){r.info("[contactService] removeContactFromRoster success for id "+t),e()},function(e){var t="removeContactFromRoster failure: no server response";e&&(t="removeContactFromRoster failure: "+JSON.stringify(e)),r.error("[contactService] "+t),n(new Error(t))})})},this.sendUpdateEvent=function(e){var n=m.isUserContact(e)?"ON_USER_CONTACT_UPDATED_EVENT":"ON_CONTACT_UPDATED_EVENT";t.$broadcast(n,e)},this.myMobileAvailable=function(){return m.userContact?m.userContact.mobileResource:null},this.notifyImByEmail=function(t){return e(function(e,n){a({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/notifications/emails/offline",headers:s.getRequestHeader(),data:{userId:t.dbId}}).then(function(t){var n="";t.data&&t.data.data&&t.data.data.email&&(n=t.data.data.email.substr(0,3)+"***"+t.data.data.email.substr(-3)),r.info("[contactService] notifyImByEmail "+n+" - success"),e()},function(e){r.error("[contactService] notifyImByEmail failure ("+e.data.errorDetailsCode+") : "+e.data.errorDetails.errorMsg),n(e)})})}}])},function(){!function(){"use strict";angular.module("rainbow").service("botService",["$http","$q","$log","authService","contactService","conversationService",function(e,t,n,r,i,a){var o=this;o.init=function(){o.bots=[],o.emily=null,this.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/"},o.start=function(e){n.info("[botService] === STARTING ===");var r=performance.now();return t(function(t,i){o.init(),o.getBots().then(function(){n.info(""),o.findEmily(),o.unlockWaitingConversations();var i=Math.round(performance.now()-r);e.push({service:"botService",startDuration:i}),n.info("[botService] === STARTED ("+i+" ms) ==="),n.info(""),t()}).catch(function(e){n.info("[botService] === STARTING FAILURE === "+e.message),i()})})},o.stop=function(){n.info("[botService] === STOPPED ===")},o.getBots=function(){return t(function(t,i){e({method:"GET",url:o.portalURL+"bots",headers:r.getRequestHeader()}).then(function(e){n.info("[botService] getBots success"),o.bots=e.data.data,t(o.bots)}).catch(function(e){var t="getBots failure "+e.data.errorDetails+" with status "+e.status;n.error("[botService] "+t),i(new Error(t))})})},o.findEmily=function(){o.bots.forEach(function(e){"Emily"===e.name&&(o.emily=e,n.info("[botService] Emily is found"),i.createBotContact(o.emily.jid,o.emily.name,o.emily.id))})},o.getEmily=function(){return o.emily},o.openConversationWithEmily=function(){return t(function(e,t){n.info("[botService] openConversationWithEmily");var r=i.getContactByJid(o.emily.jid);a.getOrCreateOneToOneConversation(r.jid).then(function(t){a.setActiveConversation(t),e(t)}).catch(function(){n.error("[botService] openConversationWithEmily failure"),t()})})},o.unlockWaitingConversations=function(){a.unlockWaitingBotConversations(!0)}}])}()},function(){angular.module("rainbow").service("conversationService",["$q","$log","$rootScope","$http","$interval","xmppService","authService","contactService","Conversation","Call","videoService","telephonyService","roomService","settingsService","ConversationServiceEventHandler","ConversationServiceHistoryHandler","utilService","profileService","SearchTextConvResultsFactory","pstnConferenceService","webrtcGatewayService",function(e,t,n,r,i,a,o,s,c,l,d,u,h,f,p,m,v,g,C,S,E){"use strict";var b=this;this.started=!1;b.start=function(r){t.info(""),t.info("[conversationService] === STARTING ===");var i=e.defer(),a=performance.now();return this.pendingMessages={},this.activeConversation=null,this.conversations=[],this.conversationCreationPromise={},this.inCallConversations=[],this.idleConversations=[],this.involvedContactIds=[],this.favoriteConversations=[],this.searchTextResults=C(),this.waitingBotConversations=[],this.botServiceReady=!1,this.isBasicCallAllowed=g.isFeatureEnabled(g.FeaturesEnum.TELEPHONY_BASIC_CALL),this.isSecondCallAllowed=g.isFeatureEnabled(g.FeaturesEnum.TELEPHONY_SECOND_CALL),this.attachHandlers(),t.info("[conversationService] getServerConversations"),b.getServerConversations().then(function(){b.started=!0,b.linkAllActiveCallsToConversations();var e=Math.round(performance.now()-a);r.push({service:"conversationService",startDuration:e}),t.info("[conversationService] === STARTED ("+e+" ms) ==="),i.resolve()}).catch(function(e){t.info("[conversationService] === STARTING FAILURE === "+e.message),i.reject(e)}),this.contactUpdateEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event ON_CONTACT_UPDATED_EVENT, rehandle it"),this.contactUpdateEventHandlerCleaner()),this.contactUpdateEventHandlerCleaner=n.$on("ON_CONTACT_UPDATED_EVENT",this.onContactChangedEvent),this.roomUpdateEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event "+h.ROOM_UPDATE_EVENT+", rehandle it"),this.roomUpdateEventHandlerCleaner()),this.roomUpdateEventHandlerCleaner=n.$on(h.ROOM_UPDATE_EVENT,this.onRoomChangedEvent),this.roomAddConferenceEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event "+h.ROOM_ADD_CONF_ENDPOINT_EVENT+", rehandle it"),this.roomAddConferenceEventHandlerCleaner()),this.roomAddConferenceEventHandlerCleaner=n.$on(h.ROOM_ADD_CONF_ENDPOINT_EVENT,this.onRoomAddConferenceEvent),this.roomHistoryUpdateEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event "+h.ROOM_HISTORY_UPDATE_EVENT+", rehandle it"),this.roomHistoryUpdateEventHandlerCleaner()),this.roomHistoryUpdateEventHandlerCleaner=n.$on(h.ROOM_HISTORY_UPDATE_EVENT,this.onRoomHistoryChangedEvent),this.roomAdminMessageEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event "+h.ROOM_ADMIN_MESSAGE_EVENT+", rehandle it"),this.roomAdminMessageEventHandlerCleaner()),this.roomAdminMessageEventHandlerCleaner=n.$on(h.ROOM_ADMIN_MESSAGE_EVENT,this.onRoomAdminMessageEvent),this.callUpdateEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event ON_CALL_UPDATED_EVENT, rehandle it"),this.callUpdateEventHandlerCleaner()),this.callUpdateEventHandlerCleaner=n.$on("ON_CALL_UPDATED_EVENT",this.onCallEvent),this.conversationUpdateEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event ON_CONVERSATIONS_UPDATED_EVENT, rehandle it"),this.conversationUpdateEventHandlerCleaner()),this.conversationUpdateEventHandlerCleaner=n.$on("ON_CONVERSATIONS_UPDATED_EVENT",this.onConversationEvent),this.capacityUpdateEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event ON_UPDATE_MYCONTACT_EVENT, rehandle it"),this.capacityUpdateEventHandlerCleaner()),this.capacityUpdateEventHandlerCleaner=n.$on("ON_UPDATE_MYCONTACT_EVENT",this.onMyContactChangedEvent),this.telephonyStateEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event ON_TELEPHONY_STATUS_CHANGED_EVENT, rehandle it"),this.telephonyStateEventHandlerCleaner()),this.telephonyStateEventHandlerCleaner=n.$on("ON_TELEPHONY_STATUS_CHANGED_EVENT",this.onTelephonyStateChangeEvent),this.conferenceStateEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event ON_CONFERENCE_STATE_EVENT, rehandle it"),this.conferenceStateEventHandlerCleaner()),this.conferenceStateEventHandlerCleaner=n.$on("ON_CONFERENCE_STATE_EVENT",this.onConferenceStateChangeEvent),this.conferenceParticipantsEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event ON_CONFERENCE_PARTICIPANT_EVENT, rehandle it"),this.conferenceParticipantsEventHandlerCleaner()),this.conferenceParticipantsEventHandlerCleaner=n.$on("ON_CONFERENCE_PARTICIPANT_EVENT",this.onConferenceParticipantChangeEvent),this.reloadCapabilitiesForMyContactEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event ON_RELOAD_CAPABILITIES_FOR_MY_CONYTACT, rehandle it"),this.reloadCapabilitiesForMyContactEventHandlerCleaner()),this.reloadCapabilitiesForMyContactEventHandlerCleaner=n.$on("ON_RELOAD_CAPABILITIES_FOR_MY_CONYTACT",this.onReloadCapabilitiesForMyContactEvent),i.promise},this.attachHandlers=function(){this.removeHandlers(),t.info("[conversationService] attachHandlers"),this.conversationHistoryHandler=m.create(this),this.conversationServiceEventHandler=p.create(this),a.addHistoryHandler(function(e){return b.conversationHistoryHandler.onHistoryMessageReceived(e)}),a.addSearchTextHandler(function(e,n){if(t.info("[conversationService] addSearchTextHandler"),b.searchTextResults.isCurrentQuery(e)){t.info("[conversationService] searchText: queryId are matching");var r=b.conversationHistoryHandler.onSearchTextMessageReceived(n);r&&(t.info("[conversationService] searchText: save item result"),b.searchTextResults.addNewItemResult(r.otherJid,r))}else t.info("[conversationService] searchText: queryId are NOT matching : "+e)}),this.messageHandlerRef||(this.messageHandlerRef=a.addHandler(function(e){return b.conversationServiceEventHandler.onChatMessageReceived(e),!0},null,"message","chat")),this.messageMucHandlerRef||(this.messageMucHandlerRef=a.addHandler(function(e){return b.conversationServiceEventHandler.onChatMessageReceived(e),!0},null,"message","groupchat")),this.fileMessageHandlerRef||(this.fileMessageHandlerRef=a.addHandler(function(e){return b.conversationServiceEventHandler.onFileMessageReceived(e),!0},null,"message","file")),this.webrtcMessageHandlerRef||(this.webrtcMessageHandlerRef=a.addHandler(function(e){return b.conversationServiceEventHandler.onWebRTCMessageReceived(e),!0},null,"message","webrtc")),this.convMessageHandlerRef||(this.convMessageHandlerRef=a.addHandler(function(e){return b.conversationServiceEventHandler.onManagementMessageReceived(e),!0},null,"message","management")),this.receiptMessageHandlerRef||(this.receiptMessageHandlerRef=a.addHandler(function(e){return b.conversationServiceEventHandler.onReceiptMessageReceived(e),!0},null,"message")),this.audioConfMessageHandlerRef||(this.audioConfMessageHandlerRef=a.addHandler(function(e){return b.conversationServiceEventHandler.onConferenceMessageReceived(e),!0},"jabber:x:audioconference","message","chat"))},this.removeHandlers=function(){t.info("[conversationService] removeHandlers "),this.conversationHistoryHandler&&(this.conversationHistoryHandler=null),this.conversationServiceEventHandler&&(this.conversationServiceEventHandler=null),this.messageHandlerRef&&(a.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),this.fileMessageHandlerRef&&(a.deleteHandler(this.fileMessageHandlerRef),this.fileMessageHandlerRef=null),this.webrtcMessageHandlerRef&&(a.deleteHandler(this.webrtcMessageHandlerRef),this.webrtcMessageHandlerRef=null),this.convMessageHandlerRef&&(a.deleteHandler(this.convMessageHandlerRef),this.convMessageHandlerRef=null),this.receiptMessageHandlerRef&&(a.deleteHandler(this.receiptMessageHandlerRef),this.receiptMessageHandlerRef=null),this.messageMucHandlerRef&&(a.deleteHandler(this.messageMucHandlerRef),this.messageMucHandlerRef=null),this.recordingMessageHandlerRef&&(a.deleteHandler(this.recordingMessageHandlerRef),this.recordingMessageHandlerRef=null),this.audioConfMessageHandlerRef&&(a.deleteHandler(this.audioConfMessageHandlerRef),this.audioConfMessageHandlerRef=null)},b.stop=function(){return t.info("[conversationService] === STOPPING ==="),this.conversations=null,this.messageHandlerRef&&(a.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),this.fileMessageHandlerRef&&(a.deleteHandler(this.fileMessageHandlerRef),this.fileMessageHandlerRef=null),this.webrtcMessageHandlerRef&&(a.deleteHandler(this.webrtcMessageHandlerRef),this.webrtcMessageHandlerRef=null),this.recordingMessageHandlerRef&&(a.deleteHandler(this.recordingMessageHandlerRef),this.recordingMessageHandlerRef=null),this.audioConfMessageHandlerRef&&(a.deleteHandler(this.audioConfMessageHandlerRef),this.audioConfMessageHandlerRef=null),this.contactUpdateEventHandlerCleaner&&(this.contactUpdateEventHandlerCleaner(),this.contactUpdateEventHandlerCleaner=null),this.roomUpdateEventHandlerCleaner&&(this.roomUpdateEventHandlerCleaner(),this.roomUpdateEventHandlerCleaner=null),this.roomAddConferenceEventHandlerCleaner&&(this.roomAddConferenceEventHandlerCleaner(),this.roomAddConferenceEventHandlerCleaner=null),this.roomAdminMessageEventHandlerCleaner&&(this.roomAdminMessageEventHandlerCleaner(),this.roomAdminMessageEventHandlerCleaner=null),this.callUpdateEventHandlerCleaner&&(this.callUpdateEventHandlerCleaner(),this.callUpdateEventHandlerCleaner=null),this.conversationUpdateEventHandlerCleaner&&(this.conversationUpdateEventHandlerCleaner(),this.conversationUpdateEventHandlerCleaner=null),this.capacityUpdateEventHandlerCleaner&&(this.capacityUpdateEventHandlerCleaner(),this.capacityUpdateEventHandlerCleaner=null),this.telephonyStateEventHandlerCleaner&&(this.telephonyStateEventHandlerCleaner(),this.telephonyStateEventHandlerCleaner=null),this.started=!1,t.info("[conversationService] === STOPPED ==="),e.when()},b.getServerConversations=function(){var n=e.defer();return r({method:"GET",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+s.userContact.dbId+"/conversations",headers:o.getRequestHeader()}).then(function(r){t.info("[conversationService] getServerConversations -- success");var i=[];r.data.data.forEach(function(e){t.info("[conversationService] getServerConversations -- create conversation "+e.jid_im+" "+e.id);var n,r=parseInt(e.unreadMessageNumber,10),a=!0===e.mute;n="user"===e.type?b.getOrCreateOneToOneConversation(e.jid_im,e.id,e.lastMessageDate,e.lastMessageText,r,a,e.creationDate,e.isFavorite):b.getRoomConversation(e.jid_im,e.id,e.lastMessageDate,e.lastMessageText,r,!0,a,e.creationDate,e.isFavorite,e.lastMessageSender,e.topic,e.type),i.push(n)}),e.all(i).then(function(){return b.removeOlderConversations()}).then(function(){b.orderConversations(),n.resolve()}).catch(function(e){var r="getServerConversations failure: "+e.message;t.error("[conversationService] "+r),n.reject(new Error(r))})},function(e){var r="getServerConversations failure: no server response";e&&(r="getServerConversations failure: "+JSON.stringify(e)),t.error("[conversationService] "+r),n.reject(new Error(r))}),n.promise},this.createServerConversation=function(n){return e(function(e,i){n.dbId&&e(n);var a=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+s.userContact.dbId+"/conversations",l=null;switch(n.type){case c.Type.ONE_TO_ONE:l={peerId:n.contact.dbId,type:"user"};break;case c.Type.ROOM:l={peerId:n.room.dbId,type:"room"};break;case c.Type.BOT:n.type=c.Type.ONE_TO_ONE,l={peerId:n.contact.dbId,type:"bot"}}r({method:"POST",url:a,headers:o.getRequestHeader(),data:l}).then(function(t){n.dbId=t.data.data.id,e(n)}).catch(function(e){var n="createServerConversation failure: "+e.data.errorDetails;t.warn("[conversationService] "+n),i(new Error(n))})})},this.deleteServerConversation=function(n){var i=e.defer();return n?(r({method:"DELETE",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+s.userContact.dbId+"/conversations/"+n,headers:o.getRequestHeader()}).then(function(){t.info("[conversationService] deleteServerConversation success: "+n),b.orderConversations(),i.resolve()},function(e){if(404002===e.data.errorDetailsCode)t.info("[conversationService] deleteServerConversation success: "+n),i.resolve();else{var r="deleteServerConversation failure: "+e.data.errorDetails;t.warn("[conversationService] "+r),i.reject(new Error(r))}}),i.promise):e.when()},this.isAddingFavoritePossible=function(){return 10>b.favoriteConversations.length},this.updateServerConversation=function(n){var i=e.defer();return n?(r({method:"PUT",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+s.userContact.dbId+"/conversations/"+n.dbId,headers:o.getPostHeader(),data:{mute:n.muted,isFavorite:n.isFavorite}}).then(function(){t.info("[conversationService] updateServerConversation success: "+n.dbId),i.resolve()},function(e){var n="updateServerConversation failure: "+e.data.errorDetails;t.warn("[conversationService] "+n),i.reject(new Error(n))}),i.promise):e.when()},this.ackAllMessages=function(n){return e(function(e,i){if(!n)return t.error("[conversationService] ackAllMessages for conversation error -- missing conversation id"),void i();var a=b.getConversationByDbId(n);return a?(t.info("[conversationService] ackAllMessages for conversation "+n),a.ackReadAllMessages(),void r({method:"PUT",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+s.userContact.dbId+"/conversations/"+n+"/markallread",headers:o.getPostHeader()}).then(function(){t.info("[conversationService] ackAllMessages success: "+n),e()},function(e){var n="ackAllMessages failure: "+e.data.errorDetails;t.warn("[conversationService] "+n),i(new Error(n))})):(t.error("[conversationService] ackAllMessages for conversation error -- can not find conversation"),void i())})},this.getOrCreateOneToOneConversation=function(r,i,a,o,l,d,u,h){if(t.info("[conversationService] getOrCreateOneToOneConversation "+r+" "+i+" "+l+" favorite : "+h),!b.conversationCreationPromise[r]){var f=b.getConversationById(r);if(f)return f.preload=!0,e.resolve(f);b.conversationCreationPromise[r]=e(function(e,f){s.getOrCreateContact(r).then(function(e){var t=c.createOneToOneConversation(e);return t.lastModification=a?new Date(a):void 0,t.lastMessageText=o,t.muted=d,t.isFavorite=h,t.creationDate=u?new Date(u):new Date,t.preload=!1,b.computeCapabilitiesForContact(e),t.dbId=i,t.missedCounter=l||0,b.createServerConversation(t)}).then(function(t){b.conversations[t.contact.id]=t,b.orderConversations(),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",t,c.EventType.NEW),e(t),delete b.conversationCreationPromise[r]}).catch(function(e){var n="getOrCreateOneToOneConversation "+r+" failure "+e.message;t.error("[conversationService] "+n),f(new Error(n)),delete b.conversationCreationPromise[r]})})}return b.conversationCreationPromise[r]},this.getRoomConversation=function(r,a,o,s,l,d,u,f,p,m,v,g){if(t.info("[conversationService] getRoomConversation "+r+" favorite : "+p),!b.conversationCreationPromise[r]){var C=b.getConversationById(r);if(C)return C.preload=!0,e.resolve(C);b.conversationCreationPromise[r]=e(function(e,d){i(function(){var i=h.getRoomByJid(r);if(i){var C=c.createRoomConversation(i);C.dbId=a,C.lastModification=o?new Date(o):void 0,C.lastMessageText=s,C.muted=u,C.isFavorite=p,C.creationDate=f?new Date(f):new Date,C.preload=!1,C.lastMessageSender=m,C.room&&v&&(C.room.desc=v),l&&(C.missedCounter=l),a?(b.conversations[C.id]=C,b.getRoomConferences(C).then(function(){n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",C,c.EventType.NEW),e(C),delete b.conversationCreationPromise[r]}).catch(function(e){var n="getRoomConversation "+r+" failure "+e.message;t.error("[conversationService] "+n),d(new Error(n)),delete b.conversationCreationPromise[r]})):b.createServerConversation(C).then(function(t){b.conversations[t.id]=t,b.orderConversations(),i&&"unsubscribed"!==i.status&&h.sendInitialRoomPresence(i),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",t,c.EventType.NEW),e(t),delete b.conversationCreationPromise[r]})}else"bot"!==g&&t.error("[conversationService] getRoomConversation ("+r+") failure : no such room"),b.waitingBotConversations.push({jid:r,conversationDbId:a,lastModification:o,lastMessageText:s,missedIMCounter:l,muted:u,isFavorite:p,creationDate:f}),b.unlockWaitingBotConversations(),e(),delete b.conversationCreationPromise[r]},1,1)})}return b.conversationCreationPromise[r]},b.getRoomConferences=function(t){return e(function(e){var n=t.room.confEndpoints;n&&n.forEach(function(e){if("pstnAudio"===e.mediaType){var n=S.getConferenceSessionById(e.confEndpointId);n&&(t.pstnConferenceSession=n)}}),e()})},b.updateRoomConferences=function(){b.getConversations().forEach(function(e){if(e.room&&e.room.confEndpoints){var t=S.getConferenceSessionById(e.room.getPstnConfEndpointId());e.pstnConferenceSession=t||null}else e.pstnConferenceSession=null})},this.closeConversation=function(n){return e(function(e,r){t.info("[conversationService] closeConversation "+n.id),b.deleteServerConversation(n.dbId).then(function(){b.removeConversation(n),e()}).catch(function(e){r(e)})})},this.removeConversation=function(e){if(t.info("[conversationService] remove conversation "+e.id),e.videoCall&&e.videoCall.status!==l.Status.UNKNOWN)t.info("[conversationService] Ignore conversation deletion message for conversation"+e.id);else{delete b.conversations[e.id],b.orderConversations();var r=b.getOrderedConversations();b.activeConversation&&!(0<=r.idle.indexOf(b.activeConversation))&&(0<r.idle.length?b.setActiveConversation(r.idle.first()):0<r.inCall.length?b.setActiveConversation(r.inCall.first()):b.setActiveConversation(null)),e.contact&&(e.contact.conversation=null,e.contact=null),n.$broadcast("ON_CONVERSATION_REMOVE_EVENT",e)}},this.getConversationByDbId=function(e){if(b.conversations)for(var t in b.conversations)if(b.conversations.hasOwnProperty(t)&&b.conversations[t].dbId===e)return b.conversations[t];return null},this.getConversationByRoomDbId=function(e){if(b.conversations)for(var t in b.conversations)if(b.conversations.hasOwnProperty(t)&&b.conversations[t].room&&b.conversations[t].room.dbId===e)return b.conversations[t];return null},this.removeOlderConversations=function(){if(!o.fromSDK){var n=parseInt(f.getSetting("nbMaxConversations"),10);(!n||15>n)&&(f.setSetting("nbMaxConversations",15),n=15);var r=b.getNotFavoritesConversations().sort(b.sortFunction);if(t.info("[conversationService] removeOlderConversations -- maxConversations : "+n),r.length>n){t.info("[conversationService] removeOlderConversations -- orderedConversations : "+r.length);for(var i=[],a=n;a<r.length;a++)i.push(b.closeConversation(r[a]));return e.all(i)}}return e.when()},this.searchConversations=function(e){var t=v.removeDiacritis(e.toLowerCase()).trim().split(/[ ]+/);return b.getOrderedConversations().idle.filter(function(e){var n=e.filterName.trim().split(/[ ]+/);return t.every(function(e){return n.some(function(t){return!(!t.length||0!==t.indexOf(e))})})})},this.searchFavoritesConversations=function(e){var t=v.removeDiacritis(e.toLowerCase()).trim().split(/[ ]+/);return b.getOrderedConversations().favorites.filter(function(e){var n=e.filterName.trim().split(/[ ]+/);return t.every(function(e){return n.some(function(t){return!(!t.length||0!==t.indexOf(e))})})})},this.sendFSMessage=function(t,r,i){var a=e.defer();return i&&0!==i.length||(i=r.name),t.sendFSMessage(r,i).then(function(e){b.pendingMessages[e.id]={conversation:t,message:e},a.resolve(e)},function(e){var t=e.translatedMessage?e.translatedMessage:"Unable to share file";n.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"fileTransfer",popupBodyTranslated:t,okLabel:"ok"}),a.reject(e)}),a.promise},this.sendEFSMessage=function(e,t,r){var i=e.sendEFSMessage(t,r);return this.pendingMessages[i.id]={conversation:e,message:i},n.$broadcast("ON_SEND_EFS_MESSAGE",t),i},this.sendChatMessage=function(e,t){var n=e.sendChatMessage(t,null);return this.pendingMessages[n.id]={conversation:e,message:n},n},this.sendAnswerChatMessage=function(e,t,n){var r=e.sendChatMessage(t,n);return this.pendingMessages[r.id]={conversation:e,message:r},r},this.sendIsTypingState=function(e,t){e.sendIsTypingState(t)},this.sendRecordingMessage=function(e,t){var n=e.sendRecordingMessage(t);return this.pendingMessages[n.id]={conversation:e,message:n},n},this.sendCorrectedChatMessage=function(e,n,r){var i=e.getMessageById(r);if(i.from.jid===s.userContact.jid)if(e.lastEditableMsg.id===i.id){var a=e.sendCorrectedChatMessage(i,n,r);this.pendingMessages[a]={conversation:e,message:i}}else t.info("[conversationService] sendCorrectedChatMessage forbidden Action - only last sent message can be modified");else t.info("[conversationService] sendCorrectedChatMessage forbidden Action - only sent messages can be modified")},this.removeAllMessages=function(n){t.info("[conversationService] removeAllMessage "+n.id);var r=e.defer(),i={queryid:a.connection.getUniqueId(),with:n.id,onComplete:function(){r.resolve()}},o=a.connection.getUniqueId();return a.connection.mam.delete(o,i),r.promise},this.removeMessagesFromConversation=function(n,r,i){t.info("[conversationService] removeMessagesFromConversation "+n.id),t.info("[conversationService] removing "+i+" messages after "+r);var o=e.defer(),s={queryid:"remove_"+n.id,with:n.id,start:moment(r).format("YYYY-MM-DDTHH:mm:ss.SSSSSSZ"),max:i,onComplete:function(){t.info("[conversationService] MAM Message deleted !!!"),o.resolve()}};return a.connection.mam.delete(n.id,s),o.promise},this.sendConversationByEmail=function(n){var i=e.defer(),a=s.userContact,c=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+a.dbId+"/conversations/"+n.dbId+"/downloads";return r({method:"POST",url:c,headers:o.getRequestHeader(),data:{}}).then(function(){t.error("[conversationService] sendConversationByEmail - success"),i.resolve()},function(e){var n={message:"Impossible to download conversation"};e&&e.data&&409011===e.data.errorDetailsCode&&(n.message="No messages to export for the last 30 days.",n.messageKey="noMessagesToExport"),t.error("[adminUserService] sendConversationByEmail - "+n.message),i.reject(n)}),i.promise},this.getHistoryPage=function(e,t){return b.conversationHistoryHandler.getHistoryPage(e,t)},this.getHistoryPageAroundMsg=function(e,t){return b.conversationHistoryHandler.getHistoryPageAroundMsg(e,20,t+"000")},this.retrieveMsgByDate=function(e,n){return t.debug("[conversationService] >retrieveMsgByDate: "+n),b.conversationHistoryHandler.retrieveMsgByDate(e,n+"000")},this.clearSearchText=function(){t.debug("[conversationService] - clearSearchText"),this.searchTextResults.clearAll()},this.clearAndGetAllMessagesResults=function(n,r){t.debug("[conversationService] - clearAndGetAllMessagesResults"),this.searchTextResults.clearAll(),this.searchTextResults.searchCount();var i=[];r.forEach(function(e){e.desc&&(!e.desc||e.desc.startsWith("Rainbow_OutlookCreation_InternalUseOnly"))||i.push(b.searchTextInRoom(s.userContact.jid,e,n,5,b.searchTextResults.searchCounter))}),e.all(i).finally(function(){t.debug("[conversationService] - ALL SearchText Promises finished"),b.searchTextInConversations(n,100)})},this.searchTextInConversations=function(n,r){t.debug("[conversationService] - searchTextInConversations: "+n);var i=e.defer(),o=a.connection.getUniqueId();return this.searchTextResults.queryIds.push(o),this.searchTextResults.searchedText=n,t.debug("[conversationService] - searchTextResults QueryId: "+o),b.conversationHistoryHandler.searchTextInConversations(o,n,r).then(function(e){b.searchTextResults.totalCount+=parseInt(e,10),b.searchTextResults.results.forEach(function(r){if(r.convRes.sort(function(e,t){return e.date?t.date?moment(e.date).diff(moment(t.date)):1:-1}),!r.isRoom()){b.getConversationTextCount(n,r.otherJid).then(function(e){r.totalCount=parseInt(e,10)});var a=s.getContactByJid(r.otherJid);a?(r.contact=a,!a.avatar&&a.getAvatar()):s.getContactsByJids([r.otherJid]).then(function(){if(t.info("[conversations] getContactsByJids success"),a=s.getContactByJid(r.otherJid))r.contact=a,a.avatar||a.getAvatar();else{t.info("[conversations] Contact with Id "+r.otherJid+" not Found");var e=b.searchTextResults.results.indexOf(r);0<=e&&(b.searchTextResults.results.splice(e,1),b.searchTextResults.totalCount-=r.totalCount)}})}i.resolve(parseInt(e,10))})}).catch(function(e){t.warn("[conversationService] - searchTextInConversations: Error "+e.message),i.reject(e)}),i.promise},this.searchTextResultsInConversation=function(n,r){t.debug("[conversationService] - searchTextResultsInConversation: "+n);var i=e.defer(),o=a.connection.getUniqueId();return this.searchTextResults.clearAll(),this.searchTextResults.queryIds.push(o),r.room?b.searchTextInRoom(s.userContact.jid,r.room,n,5,this.searchTextResults.searchCounter).then(function(e){var t=b.searchTextResults.createNewResult(r.id);t.totalCount=parseInt(e,10),t.conversation=r,t.room=r.room,b.searchTextResults.results.forEach(function(e){e.convRes.sort(function(e,t){return e.date?t.date?moment(e.date).diff(moment(t.date)):1:-1})}),b.searchTextResults.totalCount=parseInt(e,10),i.resolve(parseInt(e,10))}):b.conversationHistoryHandler.searchTextResultsInConversation(o,n,r.id,5).then(function(e){var t=b.searchTextResults.createNewResult(r.id);t.totalCount=parseInt(e,10),t.contact=r.contact,t.conversation=r,b.searchTextResults.results.forEach(function(e){e.convRes.sort(function(e,t){return e.date?t.date?moment(e.date).diff(moment(t.date)):1:-1})}),b.searchTextResults.totalCount=parseInt(e,10),i.resolve(parseInt(e,10))}),i.promise},this.searchTextMoreResultsInConversation=function(n,r,i){t.debug("[conversationService] - searchTextMoreResultsInConversation: "+n);var o=e.defer(),c=a.connection.getUniqueId();return this.searchTextResults.queryIds.push(c),r.room?b.conversationHistoryHandler.searchTextMoreResultsInRoom(c,n,s.userContact.jid,r.room.jid,i+"000",5).then(function(e){b.searchTextResults.results.forEach(function(e){e.convRes.sort(function(e,t){return e.date?t.date?moment(e.date).diff(moment(t.date)):1:-1})}),o.resolve(parseInt(e,10))}):b.conversationHistoryHandler.searchTextMoreResultsInConversation(c,n,r.id,i+"000",5).then(function(e){b.searchTextResults.results.forEach(function(e){e.convRes.sort(function(e,t){return e.date?t.date?moment(e.date).diff(moment(t.date)):1:-1})}),o.resolve(parseInt(e,10))}),o.promise},this.getConversationTextCount=function(e,n){t.debug("[conversationService] - getConversationTextCount: "+e);var r=a.connection.getUniqueId();return this.searchTextResults.queryIds.push(r),b.conversationHistoryHandler.getConversationTextCount(r,e,n)},this.searchTextInRoom=function(n,r,i,o,s){t.debug("[conversationService] - searchTextInRoom: "+i);var c=e.defer();if(this.searchTextResults.searchCounter!==s)return t.debug("[conversationService] - counter has changed - skip promise"),c.promise;var l=a.connection.getUniqueId();return this.searchTextResults.queryIds.push(l),b.conversationHistoryHandler.searchTextInRoom(l,n,r.jid,i,o).then(function(e){t.info("[conversationService] - searchTextInRoom: Room response received : "+e);var n=parseInt(e,10);0<n&&(b.searchTextResults.totalCount+=n,b.searchTextResults.results.forEach(function(t){t.otherJid===r.jid&&(t.totalCount=parseInt(e,10),t.room=r)})),c.resolve(e)}).catch(function(e){t.warn("[conversationService] - searchTextInRoom: Error "+e.message),c.reject(e)}),c.promise},this.setActiveConversation=function(e){return t.debug("[conversationService] - setActiveConversation: "+(e?e.id:"null")),this.activeConversation=e,this.activeConversation},this.setMostRecentConversationActive=function(){var e=b.getConversations().sort(b.sortFunction);return 0<e.length?this.setActiveConversation(e.first()):this.setActiveConversation(null)},this.getActiveConversation=function(){return this.activeConversation},this.getConversationById=function(e){return b.conversations?b.conversations[e]:null},this.getConversations=function(){var e=[];for(var t in b.conversations)b.conversations.hasOwnProperty(t)&&e.push(b.conversations[t]);return e},this.getNotFavoritesConversations=function(){var e=[];for(var t in b.conversations)b.conversations.hasOwnProperty(t)&&(b.conversations[t].isFavorite||e.push(b.conversations[t]));return e},this.orderConversations=function(){b.inCallConversations=[],b.idleConversations=[],b.involvedContactIds=[],b.favoriteConversations=[],Object.keys(b.conversations).forEach(function(e){var t=b.conversations[e];if(t.type===c.Type.ROOM&&t.room.owner&&t.room.isMeetingRoom()){var n=S.getConferenceSessionById(t.room.getPstnConfEndpointId());if(n&&n.isActive())return}t.isFavorite&&b.favoriteConversations.push(t),t.isInCall()&&!t.isFavorite?b.inCallConversations.push(t):!t.isFavorite&&b.idleConversations.push(t),t.type===c.Type.ONE_TO_ONE&&b.involvedContactIds.push(t.contact.id)}),b.idleConversations.sort(b.sortFunction)},this.getOrderedConversations=function(){return{inCall:b.inCallConversations,idle:b.idleConversations,contactIds:b.involvedContactIds,favorites:b.favoriteConversations}},this.sortFunction=function(e,t){var n=e.lastModification,r=e.creationDate,i=t.lastModification,a=t.creationDate;return(!i&&a?a:i)-(!n&&r?r:n)},this.formatDate=function(e){return moment(e).utc().format("YYYY-MM-DDTHH:mm:ss")+"Z"},this.resetConversationMissedCounters=function(e){n.appVisible&&(e.missedCounter=0,e.missedCalls=0,this.updateMissedCounters())},this.decreaseMissedIMCounterForConversation=function(e){0<e.missedCounter&&(e.missedCounter-=1),this.updateMissedCounters()};var y=0,R=0;this.updateMissedCounters=function(){var e=0,t=[];Object.keys(b.conversations).forEach(function(n){var r=b.conversations[n];0!==r.missedCounter&&(e+=r.missedCounter,t.push(r))}),e===y&&0==R||(y=e,R=0,n.$broadcast("ON_MISSED_COUNTER_CHANGED_EVENT",{missedIMCounter:e,missedCallCounter:0,missedIMDetails:t}))},this.dropConversationCall=function(e){e.audioCall&&u.releaseCall(e.audioCall),e.videoCall&&(d.attachLocalMediaStream(!1),d.attachDistantMediaStream(!1),d.releaseCall(e.videoCall))},this.holdConversationCall=function(e){e.audioCall&&(u.holdCall(e.audioCall),e.videoCall&&(d.attachLocalMediaStream(!1),d.attachDistantMediaStream(!1),d.releaseCall(e.videoCall)))},this.retrieveConversationCall=function(e){e.audioCall&&u.retrieveCall(e.audioCall),e.videoCall&&t.error("Not implemented for the moment")},this.allowDesktopSharing=function(){return!1},this.allowAdvancedDesktopSharing=function(){return!1},this.updateConversationCall=function(e,t){t.type===l.Type.WEBRTC?e.videoCall=t:t.type===l.Type.PHONE&&(e.audioCall=t),t.setConversationId(e.id),this.computeCapabilitiesForContact(e.contact),b.computeCapabilitiesForMyContact()},this.computeCapabilitiesForContact=function(e,r){var i=!1,a=!1,o=!1,h=!1,f=!1,p=e.status,m=e.fullJid,v=s.userContact;if(e.jid!==v.jid){var g=e.company&&s.userContact.company&&"Rainbow"!==e.company.name&&"Default"!==e.company.name&&e.company.name===s.userContact.company.name,C=this.getConversationById(e.id);if(d.started){var S=C?C.videoCall:null;(!S||S.status===l.Status.UNKNOWN)&&("unknown"===p&&g||"online"===p||"online-mobile"===p||"away"===p||"busy"===p&&"audioPhone"===e.message)&&(a=!0,o=!0)}if(u.started){var E=e.phonePro||e.phonePbx&&e.pbxId||e.mobilePro||e.phonePerso||e.mobilePerso,b=u.getActiveCallsForContact(e);0===b.length&&E&&(i=!0),(0!==b.length||d.getMediaPillarAudioCall())&&m&&(f=!0)}("online"===p||"busy"===p||"away"===p||"dnd"===p)&&(h=!0);var y={telephony:i,webRTC:a,sharedDesktop:o,fileTransfert:h,mediaAvailable:i||a,addMedia:f};(e.isBot||e.displayName&&-1!==e.displayName.indexOf("E-HELPER"))&&(y={telephony:!1,webRTC:!1,sharedDesktop:!1,fileTransfert:!1,mediaAvailable:!1,addMedia:!1}),e.capabilities=y,C&&(C.capabilities=y,!r&&n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",C,c.EventType.CAPABILITIES)),t.info('[conversationService] update capabilities for contact "'+e.displayNameForLog()+'" capabilities (tel:'+i+", webRTC:"+a+", sharing: "+o+", addMedia: "+f+")")}else this.computeCapabilitiesForMyContact()},this.computeCapabilitiesForMyContact=function(){var e=!1,n=!1,r=!1,i=s.userContact;if(d.started){var a=d.isUserContactInCall();a||"busy"===i.status&&("busy"!==i.status||"audioPhone"!==i.message)||(n=!0,b.allowDesktopSharing()&&(r=!0)),a&&d.getMediaPillarAudioCall()&&!d.getCurrentSharingCall()&&b.allowDesktopSharing()&&(r=!0)}if(u.started){var o=u.getCalls();E.isMediaPillarCallSituation()&&1<=Object.keys(d.calls).length?e=!!(1<=o.length&&b.isSecondCallAllowed):(0===o.length&&b.isBasicCallAllowed||1===o.length&&b.isSecondCallAllowed)&&(e=!0)}var c={telephony:e,webRTC:n,sharedDesktop:r,mediaAvailable:e||n};i.capabilities=c,t.info("[conversationService] update capabilities for my contact : capabilities (tel:"+e+", webRTC:"+n+", sharing: "+r+")")},this.onCallEvent=function(e,r){switch(r.type){case l.Type.WEBRTC:if(E.isMediaPillarJid(r.fullJid))return;b.getOrCreateOneToOneConversation(r.contact.id).then(function(e){b.updateConversationCall(e,r),b.orderConversations(),n.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:e,call:r})});break;case l.Type.PHONE:if(r.status===l.Status.UNKNOWN&&(r.contact&&!u.getConferenceCallForContact(r.contact)&&d.endAllCallsForContact(r.contact),r.isConference&&i(function(){(r.participants||[]).forEach(function(e){e&&0===u.getActiveCallsForContact(e).length&&d.endAllCallsForContact(e)})},1e3,1)),E.isMediaPillarCallSituation(r)){if(!r.isSecondary)return void n.$broadcast("ON_UPDATE_TELEPHONY_ICON_EVENT");if(r.status===l.Status.RINGING_INCOMMING)return}if(r.status!==l.Status.UNKNOWN&&null!==r.connectionId)if(t.info("[ConversationService] onCallEvent -- "+r.connectionId+"  -- relevantEquipmentId : "+r.relevantEquipmentId),l.getDeviceIdFromConnectionId(r.connectionId)!==r.relevantEquipmentId&&r.status!==l.Status.ACTIVE)return void n.$broadcast("ON_UPDATE_TELEPHONY_ICON_EVENT");n.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:r})}},this.onReloadCapabilitiesForMyContactEvent=function(){t.info("[conversationService] onReloadCapabilitiesForMyContactEvent"),b.computeCapabilitiesForMyContact()},this.onConversationEvent=function(){b.updateMissedCounters()},this.onContactChangedEvent=function(e,t){b.computeCapabilitiesForContact(t),b.computeCapabilitiesForMyContact()},this.onTelephonyStateChangeEvent=function(){var e=b.getConversations();e&&e.forEach(function(e){e.type===c.Type.ONE_TO_ONE&&b.computeCapabilitiesForContact(e.contact)}),b.computeCapabilitiesForMyContact()},this.onConferenceStateChangeEvent=function(){b.updateRoomConferences(),b.orderConversations(),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT")},this.onConferenceParticipantChangeEvent=function(){b.orderConversations(),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT")},this.onRoomChangedEvent=function(e,t,n){if(t){var r=b.getConversationById(t.jid);r&&("remove"===n?b.closeConversation(r):r.room=t)}},this.onRoomHistoryChangedEvent=function(e,t){if(t){var n=b.getConversationById(t.jid);n&&n.chatRenderer&&(n.reset(),n.chatRenderer.loadMore())}},this.onRoomAdminMessageEvent=function(e,n,r,i,a){t.info("[conversationService] onRoomAdminMessageEvent");var o=b.getConversationById(n);o&&"welcome"===i&&o.room&&o.room.ownerContact&&(r=o.room.ownerContact.jid);var c=s.getContactByJid(r);if(o&&c){if(!o.room.owner&&"invitation"===i)return;if(o.room&&o.room.isMeetingRoom())return;b.conversationServiceEventHandler.onRoomAdminMessageReceived(o,c,i,a)}},this.onRoomAddConferenceEvent=function(){t.info("[conversationService] onRoomAddConferenceEvent"),b.orderConversations(),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT")},this.onMyContactChangedEvent=function(){b.getOrderedConversations().idle.forEach(function(e){e.type===c.Type.ONE_TO_ONE&&b.computeCapabilitiesForContact(e.contact)}),b.computeCapabilitiesForMyContact()},this.reinit=function(){var n=e.defer();return t.info("[conversationService] Re-initialize conversation service"),b.activeConversation&&(b.activeConversation.reset(),b.activeConversation=null),delete b.conversations,b.conversations=[],b.botServiceReady=!0,t.info("[conversationService] getServerConversations"),b.getServerConversations().then(function(){b.linkAllActiveCallsToConversations(),n.resolve()}).catch(function(){i(function(){t.info("[conversationService] getServerConversations failure, try again"),b.getServerConversations().then(function(){b.linkAllActiveCallsToConversations()})},1e4,1,!0),n.resolve()}),n.promise},this.linkAllActiveCallsToConversations=function(){for(var e in u.calls)if(u.calls.hasOwnProperty(e)){var t=u.calls[e];n.$broadcast("ON_CALL_UPDATED_EVENT",t)}for(var e in d.calls)if(d.calls.hasOwnProperty(e)){t=d.calls[e];n.$broadcast("ON_CALL_UPDATED_EVENT",t)}},this.unlockWaitingBotConversations=function(e){e&&(b.botServiceReady=!0),b.botServiceReady&&(b.botServiceReady=!1,b.waitingBotConversations.forEach(function(e,t){var n=s.getContactByJid(e.jid);n&&(b.getOrCreateOneToOneConversation(n.jid,e.conversationDbId,e.lastModification,e.lastMessageText,e.missedIMCounter,e.muted,e.creationDate,e.isFavorite),b.waitingBotConversations.splice(t,1))}),b.waitingBotConversations=[])}}])},function(){angular.module("rainbow").factory("ConversationServiceEventHandler",["$q","$log","$rootScope","contactService","xmppService","roomService","Conversation","Message","fileStorageService","fileServerService","webrtcGatewayService",function(e,t,n,r,i,a,o,s,c,l,d){"use strict";function u(e){this.conversationService=e}return u.create=function(e){return new u(e)},u.prototype.onChatMessageReceived=function(e){t.info("[ConversationServiceEventHandler] onChatMessageReceived");try{var n=this,i=$(e);return 0<i.find("event").length||0<i.find("propose").length||0<i.find("received").length?t.info("[ConversationServiceEventHandler] onChatMessageReceived ignore the message"):0<i.find("recording").length?(t.info("[ConversationServiceEventHandler] onChatMessageReceived : recording msg case"),this.onRecordingMessageReceived(e)):this.extractStanzaData(e).then(function(t){t.body||t.oob||t.conference||t.replace?n.handleChatMessage(t):!t.outgoingMessage&&!r.isUserContact(t.participant)&&t.status&&n.handleStatusMessage(t.conversation,t.participant,e)}),!0}catch(e){return t.error("[ConversationServiceEventHandler] onChatMessageReceived ERROR "+e),!0}},u.prototype.onConferenceMessageReceived=function(e){t.info("[ConversationServiceEventHandler] onConferenceMessageReceived");try{var n=this;return 0<$(e).find("event").length?this.extractStanzaData(e).then(function(e){e.conference&&n.handleChatMessage(e)}):t.info("[ConversationServiceEventHandler] onConferenceMessageReceived ignore the message"),!0}catch(e){return t.error("[ConversationServiceEventHandler] onConferenceMessageReceived ERROR "+e),!0}},u.prototype.onFileTransfertReceived=function(e){var t=i.getBareJidFromJid(e.from),r=this;this.conversationService.getOrCreateOneToOneConversation(t).then(function(t){var i=t.contact,a=o.getUniqueMessageId(),s=t.addFTMessage(i,new Date,e,a);t.setStatusMessage(i,o.Status.ACTIVE),t===r.conversationService.activeConversation&&n.appVisible&&"conversations"===n.activeApplication||(t.missedCounter+=1),t.sendAckReceivedMessage(s),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",t,o.EventType.FILE)})},u.prototype.onRoomAdminMessageReceived=function(e,r,i,a){t.info("[ConversationServiceEventHandler] onRoomAdminMessageReceived");var s=e.addAdminBubbleMessage(r,new Date,i,a);e.setStatusMessage(r,o.Status.ACTIVE),e.sendAckReceivedMessage(s),e===this.conversationService.activeConversation&&n.appVisible&&"conversations"===n.activeApplication||(e.missedCounter+=1),n.$broadcast("ON_CONVERSATION_MESSAGE_RECEIVED",s,e,!1),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",e,o.EventType.IM)},u.prototype.onFileMessageReceived=function(e){t.info("[ConversationServiceEventHandler] onFileMessageReceived");try{return this.extractStanzaData(e).then(function(e){if(e.body){var t=e.conversation;t.addFileMessage(e.participant,e.date,e.body,e.messageId),t.setStatusMessage(e.participant,o.Status.ACTIVE),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",t,o.EventType.FILE)}}),!0}catch(e){return t.error("[ConversationServiceEventHandler] onFileMessageReceived ERROR "+e),!0}},u.prototype.onWebRTCMessageReceived=function(e){t.info("[ConversationServiceEventHandler] onWebRTCMessageReceived");try{return 0<angular.element(e).find("call_log").length?this.extractWebrtcStanzaData(e).then(function(e){if(e&&e.body){var t=e.conversation;t.addWebRTCMessage(e.participant,e.date,e.body,e.messageId),t.setStatusMessage(e.participant,o.Status.ACTIVE),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",t)}}):this.extractStanzaData(e).then(function(e){if(e&&e.body){var t=e.conversation;t.addWebRTCMessage(e.participant,e.date,e.body,e.messageId),t.setStatusMessage(e.participant,o.Status.ACTIVE),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",t)}}),!0}catch(e){return t.error("[ConversationServiceEventHandler] onWebRTCMessageReceived error "+e),!0}},u.prototype.onManagementMessageReceived=function(e){try{var r=angular.element(e),i=r.find("conversation");if(i){var a=this.conversationService.getConversationByDbId(i.attr("id")),s=i.attr("action");if(t.info("[ConversationServiceEventHandler] onManagementMessageReceived ("+s+" conversation)"),a)switch(s){case"create":a.dbId=i.getAttribute("id"),a.lastModification=new Date(i.find("lastMessageDate").text()),a.missedCounter=parseInt(i.find("unreadMessageNumber").text(),10)||0,a.isFavorite="true"===i.find("isFavorite").text(),this.conversationService.orderConversations(),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT");break;case"delete":this.conversationService.removeConversation(a);break;case"update":a.isFavorite="true"===i.find("isFavorite").text(),this.conversationService.orderConversations(),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT")}else if("create"===s){var c=i.find("peer").text(),l=i.attr("id"),d=new Date(i.find("lastMessageDate").text()),u=i.find("lastMessageText").text(),h=i.find("lastMessageSender").text(),f=parseInt(i.find("unreadMessageNumber").text(),10)||0,p="true"===i.find("mute").text(),m="true"===i.find("isFavorite").text(),v=i.find("type").text();(v===o.Type.ONE_TO_ONE||v===o.Type.BOT?this.conversationService.getOrCreateOneToOneConversation(c):this.conversationService.getRoomConversation(c)).then(function(e){t.info("[ConversationServiceEventHandler] onManagementMessageReceived update conversation ("+e.id+")"),e.dbId=l,e.lastModification=d?new Date(d):void 0,e.lastMessageText=u,e.lastMessageSender=h,e.muted=p,e.isFavorite=m,e.preload=!0,e.missedCounter=f,v===o.Type.BOT&&(e.type=o.Type.ONE_TO_ONE),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",e)})}}if(r.find("mute")||r.find("unmute")){var g=r.find("mute"),C=!1;g.length&&(C=!g.text().length||"true"===g.text());var S=r.find("mute").attr("conversation")||r.find("unmute").attr("conversation");(a=this.conversationService.getConversationByDbId(S))&&(t.info("[ConversationServiceEventHandler] onManagementMessageReceived : mute is changed to "+C),a.muted=C)}return!0}catch(e){return t.error("[ConversationServiceEventHandler] onManagementMessageReceived error "+e),!0}},u.prototype.onReceiptMessageReceived=function(e){t.info("[ConversationServiceEventHandler] onReceiptMessageReceived");try{var a=angular.element(e),o=i.getBareJidFromJid(a.attr("from")),c=a.find("message");r.isUserContactJid(o)&&0<c.length&&(a=angular.element(c));var l=a.find("received");if(l.length&&0<l.length){var d=angular.element(l).attr("id"),u=angular.element(l).attr("entity"),h=angular.element(l).attr("event");if("server"===u&&"received"===h){var f=this.conversationService.pendingMessages[d];if(f&&f.message){var p=f.message,m=f.conversation;t.info("[conversationService] Receive server ack ("+m.id+", "+p.id+")"),p.setReceiptStatus(s.ReceiptStatus.SENT),m.updateMessage(p),delete this.conversationService.pendingMessages[d],n.$broadcast("ON_CONVERSATION_RECEIPT_RECEIVED",p,m,"server")}}else if("client"===u){var v=this;this.extractStanzaData(e).then(function(t){v.handleReceiptReceiveMessage(t.conversation,e)})}}else if(a.find("mark_as_read").length){var g=a.find("mark_as_read").attr("with");if(m=this.conversationService.getConversationById(g))switch(a.find("mark_as_read").attr("id")){case"all-received":m.missedCounter=0;break;case"all-sent":m.ackReadAllMessages();break;default:t.error("[ConversationServiceEventHandler] onReceiptMessageReceived error - unknown read type")}}return!0}catch(e){return t.error("[ConversationServiceEventHandler] onReceiptMessageReceived error "+e),!0}},u.prototype.extractStanzaData=function(n){var o=i.getBareJidFromJid(angular.element(n).attr("from")),s={},c=null,l=null,d=null,u=e.defer(),h=angular.element(n).find("message");if(r.isUserContactJid(o)&&0<h.length){var f=i.getBareJidFromJid(angular.element(h).attr("from")),p=i.getResourceFromJid(angular.element(h).attr("from")),m=i.getBareJidFromJid(angular.element(h).attr("to")),v=i.getResourceFromJid(angular.element(h).attr("to"));if(s.outgoingMessage=r.isUserContactJid(f),s.body=angular.element(h).find("body").text(),s.participant=s.outgoingMessage?r.userContact:null,s.messageId=angular.element(h).attr("id"),s.carbon=!0,s.answeredMsg=angular.element(h).find("answeredMsg"),c=s.outgoingMessage?m:f,l=s.outgoingMessage?v:p,d=angular.element(h).find("delay"),(P=angular.element(h).find("x[xmlns='jabber:x:oob']"))&&P.length){var g=angular.element(P).find("url").text(),C=angular.element(P).find("mime").text(),S=angular.element(P).find("filename").text(),E=angular.element(P).find("size").text();s.oob={url:g,mime:C,filename:S,filesize:E}}if((w=$(n).find("x[xmlns='jabber:x:audioconference']"))&&w.length){var b=(U=$(w)).attr("subject"),y=U.attr("confendpointid"),R=w.attr("jid"),T=w.attr("type");s.conference={type:T,subject:b,confendpointid:y,roomjid:R,ownerjid:c}}if((_=h.find("replace"))&&_.length){var I=_.attr("id");s.replace={id:I}}s.status=null;var A=angular.element(n).find("composing"),N=angular.element(n).find("paused"),O=angular.element(n).find("active");A.length?s.status="composing":N.length?s.status="paused":O.length&&(s.status="active")}else{var D=$(n);s.outgoingMessage=!1,s.body=D.find("body").text(),s.messageId=D.attr("id"),s.carbon=!1,s.answeredMsg=D.find("answeredMsg"),c=i.getBareJidFromJid(D.attr("from")),l=i.getResourceFromJid(D.attr("from")),d=D.find("delay");var P,w,_,M="push"===D.find("retransmission").attr("source");if((P=D.find("x[xmlns='jabber:x:oob']"))&&P.length){var k=$(P);g=k.find("url").text(),C=k.find("mime").text(),S=k.find("filename").text(),E=k.find("size").text();s.oob={url:g,mime:C,filename:S,filesize:E}}if((w=D.find("x[xmlns='jabber:x:audioconference']"))&&w.length){var U,L=(U=$(w)).attr("message");y=U.attr("confendpointid"),R=w.attr("jid"),T=w.attr("type");if(s.conference={type:T,message:L,confendpointid:y,roomjid:R,ownerjid:c},"reminder"!==T)return t.debug("[conversationServiceEventHandler] ignored message stanza for conference"),u.resolve(s),u.promise;c=R}if((_=D.find("replace"))&&_.length){I=_.attr("id");s.replace={id:I}}var F=D.find("content[xmlns='urn:xmpp:content']");F&&"text/markdown"===F.attr("type")&&(s.markdown=!0,s.body=F.text()),(b=D.find("subject"))&&""!==b.text()&&(s.subject=b.text()),s.status=null;A=D.find("composing"),N=D.find("paused"),O=D.find("active");A.length?s.status="composing":N.length?s.status="paused":O.length&&(s.status="active")}if(s.date=new Date,s.offline=!1,"Offline Storage"===d.text()&&(s.date=new Date(d.attr("stamp")),s.offline=!0),M){var B=this.conversationService.getConversationById(c);if(B)u.reject();else{var x=this.conversationService;(c.startsWith("room_")?x.getRoomConversation(c):x.getOrCreateOneToOneConversation(c)).then(function(e){B=e,u.reject()})}return u.promise}var H=this.conversationService.getConversationById(c);if(s.convReady=H&&null!=H.dbId,s.body||H||s.oob||s.conference)if(0===c.indexOf("room_")){var j=a.getRoomByJid(c),V=(b=D.find("subject")).length&&""===b.text();j&&"accepted"!==j.status||V?t.info("[conversationServiceEvent] extractStanzaData -- ignore this stanza message"):this.conversationService.getRoomConversation(c).then(function(e){return s.conversation=e,s.conference&&s.conference.ownerjid?r.getOrCreateContact(s.conference.ownerjid):(l&&-1!==l.indexOf("/")&&(l=l.split("/")[0]),r.getOrCreateContact(l))}).then(function(e){s.participant=e,u.resolve(s)}).catch(function(e){t.error("[conversationServiceEventHandler] impossible to fetch conversation "+e.message),u.reject()})}else this.conversationService.getOrCreateOneToOneConversation(c).then(function(e){s.conversation=e,s.participant||(s.participant=e.contact),u.resolve(s)}).catch(function(e){t.error("[conversationServiceEventHandler] impossible to fetch conversation "+e.message),u.reject()});else if($(n).find("deleted")){var G=$(n).find("deleted")[0];if(G&&"all"===G.getAttribute("id")){var W=this.conversationService.getConversationById(G.getAttribute("with"));W&&(t.info("[conversationServiceEventHandler] Remove all messages for conversation "+W.id),W.reset())}}else t.debug("[conversationServiceEventHandler] ignored message stanza"),u.reject();return u.promise},u.prototype.extractWebrtcStanzaData=function(n){t.debug("[conversationServiceEventHandler] extractWebrtcStanzaData");var i=this;return e(function(e,a){var o={messageId:$(n).attr("id"),callerJid:$(n).find("caller").text(),calleeJid:$(n).find("callee").text(),state:$(n).find("state").text()},s=null;if(r.isUserContactJid(o.callerJid)?(s=o.calleeJid,o.participant=r.userContact):s=o.callerJid,-1!==s.indexOf("janusgateway"))return t.debug("[conversationServiceEventHandler] extractWebrtcStanzaData -- ignore Janus message"),a();if(d.isMediaPillarJid(o.callerJid))return t.debug("[conversationServiceEventHandler] extractWebrtcStanzaData -- ignore MediaPillar message"),e();var c=0;$(n).find("duration")&&(c=parseInt($(n).find("duration").text(),10)),o.duration=0<c?"("+moment.duration(c,"ms").format("h[H] mm[m] ss[s]")+")":0;var l=$(n).find("date").text();l&&(l=new Date(l)),o.date=l,o.body="","missed"===o.state?o.body="missedCall||"+l:"answered"===o.state&&(o.body="activeCallMsg||"+l+"||"+o.duration),i.conversationService.getOrCreateOneToOneConversation(s).then(function(t){o.conversation=t,o.participant||(o.participant=t.contact),e(o)}).catch(function(e){t.error("[conversationServiceEventHandler] impossible to fetch conversation "+e.message),a()})})},u.prototype.handleChatMessage=function(e){t.info("[ConversationServiceEventHandler] handleChatMessage");var r=this,i=e.conversation,a=null,o=e.body;if(e.oob){var s=e.oob.url,d=e.oob.filename,u=c.extractFileIdFromUrl(s);c.retrieveAndStoreOneFileDescriptor(u).then(function(t){a=i.addFileSharingMessage(e.participant,e.date,e.body,e.messageId,u,d),r.acknowledgeHandledChatMessage(e,i,a),l.getBlobThumbnailFromFileDescriptor(t).then(function(e){var r=c.getFileDescriptorById(t.id);r.previewBlob=e,n.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:r.id})}),n.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:t.id})}).catch(function(e){t.info("[ConversationServiceEventHandler] handleChatMessage error "+e)})}else if(e.conference){var h={type:e.conference.type,message:e.conference.subject,confendpointid:e.conference.confendpointid,roomjid:e.conference.roomjid};if(i=this.conversationService.getConversationById(h.roomjid),n.$broadcast("ROOM_UPDATE_CONFID"),!i)return!0;a=i.addConferenceMessage(e.participant,e.date,e.messageId,h)}else if(e.replace)(a=i.getMessageById(e.replace.id))&&e.participant.jid!==a.from.jid?(t.warn("[ConversationServiceEventHandler] handleChatMessage : message Replaced by somebody else - Skip"),a=null):(!a&&(a=i.addChatMessage(e.participant,e.date,"",e.messageId,null,e.markdown,e.subject,null,null)),a.addReplaceMsg(e.messageId,o));else if(0<o.length){var f=e.answeredMsg?e.answeredMsg.text():null,p=e.answeredMsg?e.answeredMsg.attr("stamp"):null;a=i.addChatMessage(e.participant,e.date,e.body,e.messageId,null,e.markdown,e.subject,f,p)}a&&r.acknowledgeHandledChatMessage(e,i,a)},u.prototype.acknowledgeHandledChatMessage=function(e,i,a){return t.info("[ConversationServiceEventHandler] acknowledgeHandledChatMessage"),a?(a.side===s.Side.LEFT?(i===this.conversationService.activeConversation&&"away"!==r.userContact.status&&n.appVisible&&"conversations"===n.activeApplication?i.sendAckReceivedMessage(a):(i.sendAckReceivedMessage(a),!e.offline&&e.convReady&&(i.missedCounter+=1)),a.isTextModified()&&i.updateMessage(a)):(e.carbon?a.setReceiptStatus(s.ReceiptStatus.SENT):a.setReceiptStatus(s.ReceiptStatus.IN_PROGRESS),i.updateMessage(a)),i.setStatusMessage(e.participant,o.Status.ACTIVE),n.$broadcast("ON_CONVERSATION_MESSAGE_RECEIVED",a,i,e.carbon),void n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",i)):(a=i.getMessageById(e.messageId),i.room&&a&&a.side===s.Side.RIGHT&&i.sendAckReceivedMessage(a),!0)},u.prototype.handleReceiptReceiveMessage=function(e,i){t.info("[ConversationServiceEventHandler] handleReceiptReceiveMessage");var a=angular.element(i).find("received[xmlns='urn:xmpp:receipts']");if(a.length){var o=angular.element(a).attr("id"),c=e.getMessageById(o);if(c){(u=angular.element(i).attr("from").split("/")[1])||(u=angular.element(i).attr("from"));var l=angular.element(a).attr("event");(e.room&&r.isUserContactJid(u)||!e.room)&&("received"===l?c.setReceiptStatus(s.ReceiptStatus.UNREAD):"read"===l&&(c.setReceiptStatus(s.ReceiptStatus.READ),e.missedCounter=0)),r.isUserContactJid(u)&&"read"===l&&"L"===c.side&&(e.missedCounter=0),e.updateMessage(c),n.$broadcast("ON_CONVERSATION_RECEIPT_RECEIVED",c,e,l),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",e)}else{var d=angular.element(i).attr("from"),u=(l=angular.element(a).attr("event"),"");d&&(u=d.split("/")[1]),u||(u=d),r.isUserContactJid(u)&&"read"===l&&(e.missedCounter=0,n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",e))}}},u.prototype.handleStatusMessage=function(e,r,i){t.info("[conversationServiceEventHandler] handleStatusMessage ");var a;a="thread"===angular.element(i).children().prop("tagName")?o.stringToStatus(angular.element(angular.element(i).children()[1]).prop("tagName")):o.stringToStatus(angular.element(i).children().prop("tagName")),e.setStatusMessage(r,a),n.$broadcast("ON_CONVERSATIONS_STATUS_MESSAGE_EVENT",e,r,a)},u.prototype.onRecordingMessageReceived=function(e){t.info("[ConversationServiceEventHandler] onRecordingMessageReceived");try{var r=e.textContent;return this.extractStanzaData(e).then(function(e){if("start"===r)(t=e.conversation).addRecordingMessage(e.participant,e.date,r,e.messageId),t.setStatusMessage(e.participant,o.Status.ACTIVE),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",t),n.$broadcast("ON_RECORDING_START_MSG_RECEIVED");else if("stop"===r){var t;(t=e.conversation)&&t.addRecordingMessage(e.participant,e.date,r,e.messageId),n.$broadcast("ON_RECORDING_STOP_MSG_RECEIVED")}else"remoteStopVideo"===r?n.$broadcast("ON_RECORDING_REMOTESTOPVIDEO_MSG_RECEIVED"):"remoteChangeMediaVideo"===r?n.$broadcast("ON_RECORDING_REMOTECHANGEMEDIAVIDEO_MSG_RECEIVED"):"remoteStopSharing"===r?n.$broadcast("ON_RECORDING_REMOTESTOPSHARING_MSG_RECEIVED"):"remoteChangeMediaSharing"===r&&n.$broadcast("ON_RECORDING_REMOTECHANGEMEDIASHARING_MSG_RECEIVED")}),!0}catch(e){return t.error("[ConversationServiceEventHandler] onRecordingMessageReceived error "+e),!0}},u}])},function(){angular.module("rainbow").factory("ConversationServiceHistoryHandler",["$log","$q","$filter","$rootScope","xmppService","contactService","fileStorageService","fileServerService","Message","SearchTextMsgResultFactory",function(e,t,n,r,i,a,o,s,c,l){"use strict";function d(e){this.conversationService=e}return d.create=function(e){return new d(e)},d.prototype.getHistoryPage=function(e,t){var n=this,r=e.room;return r&&r.initPresPromise?r.initPresPromise.promise.then(function(){return n.getHistoryPageInternal(e,t)}):this.getHistoryPageInternal(e,t)},d.prototype.getHistoryPageInternal=function(n,r){if(n.currentHistoryId&&n.currentHistoryId===n.historyIndex)return e.info("[ConversationServiceHistoryHandler] getHistoryPage("+n.id+", "+r+", "+n.historyIndex+") already asked"),t.when();n.currentHistoryId=n.historyIndex,e.info("[ConversationServiceHistoryHandler] getHistoryPage("+n.id+", "+r+", "+n.historyIndex+")");var o=n.historyDefered=t.defer();if(a.isUserContact(n.contact))return o.reject(),o.promise;if(n.historyComplete)return e.info("[ConversationServiceHistoryHandler] getHistoryPage("+n.id+") : already complete"),o.reject(),o.promise;var s={queryid:n.id,with:n.id,max:r,before:""};return-1!==n.historyIndex&&(s.before=n.historyIndex),n.room?(s={queryid:n.id,with:a.userContact.jid,max:r,before:""},-1!==n.historyIndex&&(s.before=n.historyIndex),i.connection.mam.querymuc(n.id,n.room.jid,s)):i.connection.mam.query(n.id,s),o.promise},d.prototype.retrieveMsgByDate=function(n,r){n.historyDefered=t.defer();var i=t.defer();if(a.isUserContact(n.contact))return i.reject(),i.promise;var o="cache_"+n.id;return d.prototype.getCommonHistoryPageAroundMsg(o,n,1,r,"after",function(){e.info("[ConversationServiceHistoryHandler] retrieveMsgByDate finished"),i.resolve()}),i.promise},d.prototype.getHistoryPageAroundMsg=function(n,r,i){n.historyDefered=t.defer();var o=t.defer();return a.isUserContact(n.contact)?(o.reject(),o.promise):(d.prototype.getCommonHistoryPageAroundMsg(n.id,n,r+1,i,"after",function(){e.info("[ConversationServiceHistoryHandler] getCommonHistoryPageAroundMsg BEFORE finished"),d.prototype.getCommonHistoryPageAroundMsg(n.id,n,r,i,"before",function(){e.info("[ConversationServiceHistoryHandler] getCommonHistoryPageAroundMsg AFTER finished"),o.resolve()})}),o.promise)},d.prototype.getCommonHistoryPageAroundMsg=function(t,n,r,o,s,c){var l;(e.info("[ConversationServiceHistoryHandler] getCommonHistoryPageAroundMsg("+t+", "+r+", "+n.historyIndex+")"),n.room)?((l={queryid:t,with:a.userContact.jid,max:r,onComplete:c})[s]=o,i.connection.mam.querymuc(t,n.room.jid,l)):((l={queryid:t,with:n.id,max:r,onComplete:c})[s]=o,i.connection.mam.query(t,l))},d.prototype.searchTextInConversations=function(n,r,a){e.info("[ConversationServiceHistoryHandler] searchTextInConversations("+r+")");var o=t.defer(),s=i.connection.getUniqueId(),c=$iq({id:s,type:"get"}).c("query",{queryid:n,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(a).up().c("before").up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(r).up().up();return i.sendIQ(c).then(function(t){e.info("[ConversationServiceHistoryHandler] sendIq Success: "+r);var n=$(t).find("query").find("set").find("count").text();e.info("[ConversationServiceHistoryHandler] >searchTextInConversations: count= "+n),o.resolve(n)}).catch(function(t){e.info("[ConversationServiceHistoryHandler] sendIq Failure: "+t.message),o.reject(t)}),o.promise},d.prototype.getConversationTextCount=function(n,r,a){e.info("[ConversationServiceHistoryHandler] getConversationTextCount("+r+")");var o=t.defer(),s=i.connection.getUniqueId(),c=$iq({id:s,type:"get"}).c("query",{queryid:n,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t("0").up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(r).up().up().c("field",{var:"with",type:"text-single"}).c("value").t(a).up().up();return i.sendIQ(c).then(function(t){e.info("[ConversationServiceHistoryHandler] sendIq Success: "+r);var n=$(t).find("query").find("set").find("count").text();e.info("[ConversationServiceHistoryHandler] >getConversationTextCount: count= "+n),o.resolve(n)}).catch(function(t){e.info("[ConversationServiceHistoryHandler] sendIq Failure: "+t.message),o.reject(t)}),o.promise},d.prototype.searchTextResultsInConversation=function(n,r,a,o){e.info("[ConversationServiceHistoryHandler] searchTextResultsInConversation("+r+")");var s=t.defer(),c=i.connection.getUniqueId(),l=$iq({id:c,type:"get"}).c("query",{queryid:n,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(o).up().c("before").up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(r).up().up().c("field",{var:"with",type:"text-single"}).c("value").t(a).up().up();return i.sendIQ(l).then(function(t){e.info("[ConversationServiceHistoryHandler] sendIq Success: "+r);var n=$(t).find("query").find("set").find("count").text();e.info("[ConversationServiceHistoryHandler] >getConversationTextCount: count= "+n),s.resolve(n)}).catch(function(t){e.info("[ConversationServiceHistoryHandler] sendIq Failure: "+t.message),s.reject(t)}),s.promise},d.prototype.searchTextMoreResultsInConversation=function(n,r,a,o,s){e.info("[ConversationServiceHistoryHandler] searchTextMoreResultsInConversation("+r+")");var c=t.defer(),l=i.connection.getUniqueId(),d=$iq({id:l,type:"get"}).c("query",{queryid:n,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(s).up().c("before").t(o).up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(r).up().up().c("field",{var:"with",type:"text-single"}).c("value").t(a).up().up();return i.sendIQ(d).then(function(t){e.info("[ConversationServiceHistoryHandler] sendIq Success: "+r);var n=$(t).find("query").find("set").find("count").text();e.info("[ConversationServiceHistoryHandler] >getConversationTextCount: count= "+n),c.resolve(n)}).catch(function(t){e.info("[ConversationServiceHistoryHandler] sendIq Failure: "+t.message),c.reject(t)}),c.promise},d.prototype.searchTextInRoom=function(n,r,a,o,s){e.info("[ConversationServiceHistoryHandler] searchTextInRoom("+o+")");var c=t.defer(),l=i.connection.getUniqueId(),d=$iq({to:a,id:l,type:"get"}).c("query",{queryid:n,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(s).up().c("before").up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"with",type:"text-single"}).c("value").t(r).up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(o).up().up();return i.sendIQ(d).then(function(t){e.info("[ConversationServiceHistoryHandler] sendIq Success: "+o);var n=$(t).find("query").find("set").find("count").text();e.info("[ConversationServiceHistoryHandler] >searchTextInRoom: count= "+n),c.resolve(n)}).catch(function(t){e.info("[ConversationServiceHistoryHandler] >searchTextInRoom: Failure: "+t.message),c.reject(t)}),c.promise},d.prototype.searchTextMoreResultsInRoom=function(n,r,a,o,s,c){e.info("[ConversationServiceHistoryHandler] searchTextMoreResultsInConversation("+r+")");var l=t.defer(),d=i.connection.getUniqueId(),u=$iq({to:o,id:d,type:"get"}).c("query",{queryid:n,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(c).up().c("before").t(s).up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(r).up().up().c("field",{var:"with",type:"text-single"}).c("value").t(a).up().up();return i.sendIQ(u).then(function(t){e.info("[ConversationServiceHistoryHandler] sendIq Success: "+r);var n=$(t).find("query").find("set").find("count").text();e.info("[ConversationServiceHistoryHandler] >getConversationTextCount: count= "+n),l.resolve(n)}).catch(function(t){e.info("[ConversationServiceHistoryHandler] sendIq Failure: "+t.message),l.reject(t)}),l.promise},d.prototype.onHistoryMessageReceived=function(t){e.info("[ConversationServiceHistoryHandler] onHistoryMessageReceived");try{var l=null,d=$(t),u=d.find("result").attr("queryid");if(u){if(l=this.conversationService.getConversationById(u)){if(d.find("call_log").length)return this.onWebrtcHistoryMessageReceived(t,l);var h=d.find("forwarded message").attr("from"),f=!1;if(!(G=h&&0===h.indexOf("room_")?h.split("/")[1]:i.getBareJidFromJid(d.find("forwarded message").attr("from")))&&d.find("event").length&&(f=d.find("event").attr("name"),G=d.find("event").attr("jid"),"welcome"===f&&l.room&&l.room.ownerContact&&(G=l.room.ownerContact.jid)),!G)return e.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived - Receive message without valid fromJid information"),!0;var p=a.getContactByJid(G),m=d.find("forwarded message").attr("type"),v=d.find("forwarded message").attr("id"),g=new Date(d.find("forwarded delay").attr("stamp")),C=d.find("forwarded message body").text(),S=d.find("forwarded message ack"),E=d.find("forwarded message x[xmlns='jabber:x:oob']"),b=d.find("forwarded message x[xmlns='jabber:x:bubble:conference:pstn']"),y=d.find("content[xmlns='urn:xmpp:content']"),R=d.find("replace"),T=d.find("answeredMsg"),I=a.isUserContact(p)?c.Side.RIGHT:c.Side.LEFT;if(p||(e.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived missing contact for jid : "+G+", ignore message"),p=a.createEmptyContactContact(G)),f){if(e.info("[ConversationServiceHistoryHandler] ("+l.id+") add Room admin event message "+f),m="admin",l.room&&l.room.isMeetingRoom()&&("welcome"===f||"conferenceAdd"===f||"conferenceRemove"===f||"invitation"===f))return!0;if(("conferenceAdd"===f||"conferenceRemove"===f)&&l.room&&l.room.ownerContact){var A=d.find("event").attr("jid"),N=l.room.getUserByJid(A);p=N&&N.contact?N.contact:l.room.ownerContact}}var O=l.getMessageById(v);if(O||(O=l.historyMessages.find(function(e){return e.id===v})),O)e.info("[ConversationServiceHistoryHandler] ("+l.id+") try to add an already stored message with id "+O.id);else{switch(m){case"file":O=c.createFileMessage(v,g,p,I,C,!1);break;case"webrtc":O=c.createWebRTCMessage(v,g,p,I,C,!1);break;case"admin":O=c.createBubbleAdminMessage(v,g,p,f);break;case"recording":O=c.createRecordingAdminMessage(v,g,p,"Admin");break;default:if(E&&E.length){var D=$(E),P=D.find("url").text(),w=D.find("filename").text(),_=o.extractFileIdFromUrl(P);O=c.createFileSharingMessage(v,g,p,I,C,!1,_,w),o.retrieveAndStoreOneFileDescriptor(_).then(function(e){e&&"not_uploaded"===e.state&&(O.receiptStatus=1,O.fileErrorMsg=n("translate")("file_notuploaded")),s.getBlobThumbnailFromFileDescriptor(e).then(function(t){e.previewBlob=t,r.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:e.id})}),r.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:e.id})}).catch(function(t){e.info("[ConversationServiceHistoryHandler] onHistoryMessageReceived error "+t)})}else if(b&&b.length){var M=$(b),k=M.attr("subject"),U=M.attr("confendpointid"),L=b.attr("jid");if("reminder"===b.attr("type"))return!0;O=c.createConferenceMessage(v,g,p,I,!1,{subject:k,confendpointid:U,roomjid:L})}else{var F=y&&"text/markdown"===y.attr("type");if(C=F?y.text():C,R&&R.length){var B=R.attr("id"),x=l.getMessageByIdInHistory(B);x||(x=c.create(B,g,p,I,C,!1,F,null,null,null),O=x),p.jid===x.from.jid?x&&x.addReplaceMsg(v,C):(e.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived : message Replaced by somebody else - Skip"),O=null)}else{var H=T?T.text():null,j=T?T.attr("stamp"):null;O=c.create(v,g,p,I,C,!1,F,null,H,j)}}}O&&(O.receiptStatus="true"===angular.element(S).attr("read")?5:"true"===angular.element(S).attr("recv")?4:3,e.info("[ConversationServiceHistoryHandler] onHistoryMessageReceived : pushing msg inside historyMessages"),l.addMessageInHistoryMessages(O))}}else if(u.startsWith("cache_")){e.info("[ConversationServiceHistoryHandler] onHistoryMessageReceived : Query Id for Cached Message");var V=u.substr(6);if(l=this.conversationService.getConversationById(V)){var G;if(e.info("[ConversationServiceHistoryHandler] onHistoryMessageReceived : Conversation Found"),!(G=(h=d.find("forwarded message").attr("from"))&&0===h.indexOf("room_")?h.split("/")[1]:i.getBareJidFromJid(d.find("forwarded message").attr("from")))&&d.find("event").length&&(f=d.find("event").attr("name"),G=d.find("event").attr("jid"),"welcome"===f&&l.room&&l.room.ownerContact&&(G=l.room.ownerContact.jid)),!G)return e.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived - Receive message without valid fromJid information"),!0;p=a.getContactByJid(G),v=d.find("forwarded message").attr("id"),g=new Date(d.find("forwarded delay").attr("stamp")),C=d.find("forwarded message body").text(),I=a.isUserContact(p)?c.Side.RIGHT:c.Side.LEFT;p||(e.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived missing contact for jid : "+G+", ignore message"),p=a.createEmptyContactContact(G)),(O=c.create(v,g,p,I,C,!1,!1))&&l.addMessageInCacheMessages(O)}}}else if(u=angular.element(t).find("fin").attr("queryid"),l=this.conversationService.getConversationById(u)){l.historyComplete="true"===angular.element(t).find("fin").attr("complete");var W=angular.element(t).find("fin set first").text();-1===l.historyIndex?(l.messages.unshift.apply(l.messages,l.historyMessages),l.chatRenderer&&l.chatRenderer.prependMessages(l.messages,l.room)):(l.messages.unshift.apply(l.messages,l.historyMessages),l.chatRenderer&&l.chatRenderer.prependMessages(l.historyMessages,l.room)),l.historyIndex=W,l.historyMessages=[],l.lastMessageText=angular.isDefined(l.messages)&&0<l.messages.length?l.messages[l.messages.length-1].data:"",l.historyDefered&&l.historyDefered.resolve(l)}return!0}catch(t){return e.error("[ConversationServiceHistoryHandler] onHistoryMessageReceived error : "+t),!0}},d.prototype.onSearchTextMessageReceived=function(t){e.info("[ConversationServiceHistoryHandler] onSearchTextMessageReceived");try{var n,r=$(t),o=r.find("forwarded message").attr("from"),s=r.find("forwarded message").attr("to"),c=!1,d=!1;if(a.isUserContactJid(o)?(e.info("[ConversationServiceHistoryHandler] sent message"),c=!0,n=s):(e.info("[ConversationServiceHistoryHandler] received message"),c=!1,n=o),n&&0===n.indexOf("room_")?(n=n.split("/")[0],d=!0):n=i.getBareJidFromJid(n),!n)return void e.warn("[ConversationServiceHistoryHandler] onSearchTextMessageReceived - Receive message without valid otherJid information");var u=r.find("forwarded message").attr("id"),h=new Date(r.find("forwarded delay").attr("stamp")),f=r.find("forwarded message body").text(),p=l();return p.body=f,p.date=h,p.isRoom=d,p.isSent=c,p.messageId=u,p.otherJid=n,p}catch(t){return e.error("[ConversationServiceHistoryHandler] onSearchTextMessageReceived error : "+t),!0}},d.prototype.onWebrtcHistoryMessageReceived=function(t,n){console.log("onWebrtcHistoryMessageReceived");try{var r=$(t),i=r.find("forwarded message").attr("id"),o=r.find("caller").text(),s=r.find("state").text(),l=0;r.find("duration")&&(l=r.find("duration").text(),l=parseInt(l,10)),l=0<l?"("+moment.duration(l,"ms").format("h[H] mm[m] ss[s]")+")":0;var d=r.find("date").text();d=d?new Date(d):new Date(r.find("forwarded delay").attr("stamp"));var u="";"missed"===s?u="missedCall||"+d:"answered"===s&&(u="activeCallMsg||"+d+"||"+l);var h=n.getMessageById(i);if(h||(h=n.historyMessages.find(function(e){return e.id===i})),h)e.info("[ConversationServiceHistoryHandler] ("+n.id+") try to add an already stored message with id "+h.id);else{var f=a.getContactByJid(o);f||(e.warn("[ConversationServiceHistoryHandler] onWebrtcHistoryMessageReceived missing contact for jid : "+o+", ignore message"),f=a.createEmptyContactContact(o));var p=a.isUserContact(f)?c.Side.RIGHT:c.Side.LEFT;h=c.createWebRTCMessage(i,d,f,p,u,!1);var m=r.find("forwarded message ack");m&&(h.receiptStatus="true"===angular.element(m).attr("read")?5:"true"===angular.element(m).attr("received")?4:3),n.historyMessages.push(h)}return!0}catch(e){return console.error(e),!0}},d}])},function(){angular.module("rainbow").service("telephonyService",["$q","$interval","$http","$rootScope","$log","xmppService","contactService","authService","Call","TelephonyServiceEventHandler","errorHelperService","VoiceMail","profileService","utilService","videoService","$injector",function(e,t,n,r,i,a,o,s,c,l,d,u,h,f,p,m){"use strict";var v=this,g=[],C="urn:xmpp:pbxagent:callservice:1";v.start=function(e){i.info("[telephonyService] === STARTING ==="),v.startDate=performance.now(),v.stats=e,v.calls=[],v.started=!1,v.agentStatus={phoneApi:"disconnected",xmppAgent:"stopped",agentVersion:"unknown"},v.voicemailNumber=o.userContact.voicemailNumber,v.pbxId=o.userContact.pbxId,v.makingCall=!1,v.starting=!1,v.voiceMail=u.create(),v.forwardObject={},v.nomadicObject={},v.nomadicAnswerNotTakedIntoAccount=!1,v.isBasicCallAllowed=h.isFeatureEnabled(h.FeaturesEnum.TELEPHONY_BASIC_CALL),v.isSecondCallAllowed=h.isFeatureEnabled(h.FeaturesEnum.TELEPHONY_SECOND_CALL),v.isTransferAllowed=h.isFeatureEnabled(h.FeaturesEnum.TELEPHONY_TRANSFER_CALL),v.isConferenceAllowed=h.isFeatureEnabled(h.FeaturesEnum.TELEPHONY_CONFERENCE_CALL),v.isVMDeflectCallAllowed=h.isFeatureEnabled(h.FeaturesEnum.TELEPHONY_DEFLECT_CALL),v.voiceMailFeatureEnabled=h.isFeatureEnabled(h.FeaturesEnum.TELEPHONY_VOICE_MAIL),v.isForwardEnabled=h.isFeatureEnabled(h.FeaturesEnum.TELEPHONY_CALL_FORWARD),v.isNomadicEnabled=h.isFeatureEnabled(h.FeaturesEnum.TELEPHONY_NOMADIC),v.userJidTel=s.jidTel,v.portalURL=config.restServerUrl+"/api/rainbow/telephony/v1.0/",g.push(r.$on("ON_ROSTER_PRESENCE_CHANGED_EVENT",v.onTelPresenceChange)),v.telephonyEventHandler=l.create(v),i.info("[telephonyService] starting on user jidTel: "+v.userJidTel),o.userContact&&(i.info("[telephonyService] starting user email: "+o.userContact.emailPro+", full jid: "+o.userContact.fullJid),i.info("[telephonyService] starting phonePbx: "+o.userContact.phonePbx+", phonePro: "+o.userContact.phonePro+", voicemailNumber: "+o.userContact.voicemailNumber+", pbxId: "+o.userContact.pbxId)),o.userContact&&(o.userContact.telStatus?(i.info("[telephonyService] start with my existing telephony presence "+o.userContact.telStatus+" of user contact ("+o.userContact.jidtel+") "),v.onTelPresenceChange(null,{jid:v.userJidTel+"/phone",status:o.userContact.telStatus})):(i.info("[telephonyService] Subscribe and wait for my telephony presence ("+o.userContact.jidtel+")"),o.sendSubscribeInvitation(o.userContact.jidtel)))},v.onTelPresenceChange=function(t,n){if(o.isTelJid(n.jid)){if("phone"!==o.getRessourceFromJid(n.jid))return!0;var a=o.getImJid(n.jid);if(!a)return!0;var s=n.status;o.isUserContactJid(a)&&("unavailable"===s||"offline"===s?(i.info("[telephonyService] received my telephony presence -- "+s),v.started=!1,v.telephonyOfflineCallManagement(),r.$broadcast("ON_TELEPHONY_STATUS_CHANGED_EVENT","stopped"),i.info("[telephonyService] === STOPPED ===")):!v.started&&!v.starting&&(i.info("[telephonyService] received my telephony presence -- "+s),v.starting=!0,v.getAgentStatus().then(function(){return v.attachHandlers(),v.isNomadicEnabled?v.getNomadicStatus().then(function(){var e=v.nomadicObject.featureActivated&&v.nomadicObject.modeActivated&&!v.nomadicObject.makeCallInitiatorIsMain;return v.getTelephonyState(e)}):v.getTelephonyState(!1)}).then(function(){return v.isForwardEnabled?v.getForwardStatus():e.when()}).then(function(){var e=Math.round(performance.now()-v.startDate);v.stats.push({service:"telephonyService",startDuration:e}),i.info("[telephonyService] === STARTED ("+e+" ms) ==="),v.started=!0,v.starting=!1,r.$broadcast("ON_TELEPHONY_STATUS_CHANGED_EVENT","started")}).catch(function(e){v.starting=!1,i.error("[telephonyService] receive telephony presence but error in initialization - "+(e?e.message:"unknown error"))})))}return!0},v.telephonyOfflineCallManagement=function(){i.info("[telephonyService] telephony Offline Call Management");try{var e=m.get("webrtcGatewayService");Object.keys(v.calls||[]).forEach(function(t){var n=v.calls[t];n&&((n.status===c.Status.RINGING_INCOMMING||n.status===c.Status.QUEUED_INCOMMING)&&(n.mediaPillarCall&&n.mediaPillarCall.webrtcCallRef&&(i.info("[telephonyService] Offline Call Management: release MP webrtc call for phone call "+n.id+" in state "+n.status.value),p.releaseCall(n.mediaPillarCall.webrtcCallRef)),i.info("[telephonyService] Offline Call Management: stop popup and ringing tone for phone call "+n.id+" in state "+n.status.value),n.setStatus(c.Status.UNKNOWN),r.$broadcast("ON_CALL_UPDATED_EVENT",n)),n.status===c.Status.RINGING_OUTGOING&&e.isMediaPillarCallSituation(n)&&n.mediaPillarCall&&n.mediaPillarCall.webrtcCallRef&&(i.info("[telephonyService] Offline Call Management: release MP webrtc call for phone call "+n.id+" in state "+n.status.value),p.releaseCall(n.mediaPillarCall.webrtcCallRef)),e.isMediaPillarCallSituation(n)&&n.status===c.Status.ACTIVE?(i.info("[telephonyService] Offline Call Management: keep MP call for phone call "+n.id+" in state "+n.status.value),n.pbxConnectionDown=!0):delete v.calls[n.id])})}catch(e){var t=e&&e.message?e.message:"Unknown error",n=e&&e.stack?e.stack:"Unknown stack";i.error("[telephonyService] telephonyOfflineCallManagement  exception  -- "+t+" : "+n)}},v.getTelephonyState=function(t){var n,r=e.defer();return n=t?$iq({type:"get",to:v.userJidTel+"/phone"}).c("callservice",{xmlns:C}).c("connections",{deviceType:"SECONDARY"}):$iq({type:"get",to:v.userJidTel+"/phone"}).c("callservice",{xmlns:C}).c("connections"),a.sendIQ(n,6e4).then(function(n){var a=v.getErrorMessage(n,"getTelephonyState");if(a)return i.info("[telephonyService] getTelephonyState -- failure -- "+a),r.reject(new Error(a)),r.promise;var o=angular.element(n).find("connection");if(i.info("[telephonyService] getTelephonyState ("+(t?"SECONDARY":"MAIN")+") -- success -- "+o.length+" existing call(s)"),0===o.length)return r.resolve(),r.promise;var s=[];return o.each(function(){s.push(v.createCallFromConnectionElem(this,t))}),e.all(s).then(function(){i.info("[telephonyService] getTelephonyState ("+(t?"SECONDARY":"MAIN")+") -- calls creation completed -- "+o.length+" calls created"),r.resolve()}).catch(function(e){i.error("[telephonyService] getTelephonyState -- calls creation failure -- "+e.message),r.reject(e)}),r.promise}).catch(function(e){i.error("[telephonyService] getTelephonyState -- failure -- "+e.message),r.reject(e)}),r.promise},v.getAgentStatus=function(){var t=e.defer(),n=$iq({type:"get",to:v.userJidTel+"/phone"}).c("pbxagentstatus",{xmlns:"urn:xmpp:pbxagent:monitoring:1"});return a.sendIQ(n,6e4).then(function(e){var n=angular.element(e).find("phoneapi").text(),r=angular.element(e).find("xmppagent").text(),a=angular.element(e).find("version").text();a&&(v.agentStatus={phoneApi:n,xmppAgent:r,agentVersion:a}),i.info("[telephonyService] getAgentStatus -- success -- version "+a),t.resolve()}).catch(function(e){var n="getAgentStatus -- failure : "+e.message;i.error("[telephonyService] "+n),t.reject(new Error(n))}),t.promise},v.getSnapshotCall=function(t){return i.info("[telephonyService] getSnapshotCall"),e(function(e,n){var r=$iq({type:"get",to:v.userJidTel+"/phone"}).c("callservice",{xmlns:C}).c("snapshotCall",{callId:t});a.sendIQ(r).then(function(t){console.error(t),e()}).catch(function(e){var t="getSnapshotCall failure : "+e.message;i.error("[telephonyService] "+t),n(new Error(t))})})},v.getVoiceMessageCounter=function(){return e(function(e,t){if(!v.voiceMailFeatureEnabled){var n=new Error("getVoiceMessageCounter failure - Not Allowed");return n.status=n.errorDetailsCode="403",i.error("[telephonyService] "+n.message),void t(n)}var r=$iq({type:"get",to:v.userJidTel+"/phone"}).c("callservice",{xmlns:C}).c("messaging");a.sendIQ(r).then(function(t){console.error(t),e()}).catch(function(e){var n="getVoiceMessageCounter failure : "+e.message;i.error("[telephonyService] "+n),t(new Error(n))})})},v.createCallFromConnectionElem=function(t,n){return e(function(e,a){var s=angular.element(t),l=s.attr("endpointIm"),d=s.attr("endpointTel"),u=s.attr("callId"),p=s.attr("endpointLci"),m=s.attr("lci"),g=s.find("participant"),C=s.find("identity").attr("firstName"),S=s.find("identity").attr("lastName"),E="",b="";if(l||d||(d="****"),h.isFeatureEnabled(h.FeaturesEnum.TELEPHONY_PHONE_BOOK)&&0===g.length&&S&&S.length&&(b=S,C&&C.length&&(E=C),i.info("[telephonyService] createCallFromConnectionElem - name resolution for: "+u+" for phoneNumber:"+f.anonymizePhoneNumber(d)+" with firstname : "+E.slice(0,1)+"***")),"LCI_INITIATED"!==m){(0===g.length?o.getOrCreateContact(l,d):v.getParticipantsFromParticipantsElem(g)).then(function(t){var a=c.Status.ACTIVE;"LCI_HELD"===m&&"LCI_CONNECTED"===p&&(a=c.Status.HOLD),"LCI_CONNECTED"===m&&"LCI_HELD"===p&&(a=c.Status.PUT_ON_HOLD),"LCI_CONNECTED"===m&&"LCI_QUEUED"===p&&(a=c.Status.QUEUED_OUTGOING),"LCI_QUEUED"===m&&"LCI_CONNECTED"===p&&(a=c.Status.QUEUED_INCOMMING),"LCI_ALERTING"===m&&(a=c.Status.RINGING_INCOMMING);var o=null;0===g.length?(t&&t.temp&&""!==b&&t.updateName(E,b),o=v.getOrCreateCall(a,u,t),i.info("[telephonyService] createCallFromConnectionElem - create call for user: "+t.id+" with callId: "+u+" "+m)):((o=v.getOrCreateCall(a,u)).setParticipants(t),o.isConference=!0,i.info("[telephonyService] createCallFromConnectionElem - create conference call with callId: "+u+" "+m));o.relevantEquipmentId=c.getDeviceIdFromConnectionId(u),o.isSecondary=n,r.$broadcast("ON_CALL_UPDATED_EVENT",o),e(o)}).catch(function(e){i.error("[TelephonyService] createCallFromConnectionElem - failure - "+e.message),a(e)})}else e()})},v.getParticipantsFromParticipantsElem=function(t){return e(function(n,r){var i=[],a=[];t.each(function(){var t=angular.element(this),n=t.find("endpointTel").text(),r=t.find("endpointIm").text();r&&o.isUserContactJid(r)||a.push(e(function(e,t){r||n||(n="****"),o.getOrCreateContact(r,n).then(function(t){i.push(t),e()}).catch(function(e){t(e)})}))}),e.all(a).then(function(){n(i)},function(e){r(e)})})},v.getOrCreateCall=function(e,t,n){var r=v.calls[t];return r?(r.setConnectionId(t),r.startDate=new Date):((r=c.create(e,null,c.Type.PHONE,n)).setConnectionId(t),v.calls[r.id]=r),r},v.attachHandlers=function(){i.info("[telephonyService] attachHandlers"),v.started=!1,0===Object.keys(v.calls||[]).length&&(r.telephonyAreaClass=""),v.messageHandlerRef&&(a.deleteHandler(v.messageHandlerRef),v.messageHandlerRef=null),v.messageHandlerRef=a.addHandler(function(e){return v.telephonyEventHandler.onCallserviceMessageReceived(e),!0},C,"message",null)},v.stop=function(){i.info(""),i.info("[telephonyService] === STOPPING ==="),v.started=!1,v.userJidTel=null,v.calls=null,v.messageHandlerRef&&(a.deleteHandler(v.messageHandlerRef),v.messageHandlerRef=null);for(var t;t=g.pop();)t();return i.info("[telephonyService] === STOPPED ==="),r.$broadcast("ON_TELEPHONY_STATUS_CHANGED_EVENT","stopped"),e.when()},v.getCallToHangOut=function(){var e=v.getCalls();if(!e||0===e.length)return null;var t=e[0].status;return 1===e.length||t===c.Status.DIALING||t===c.Status.ACTIVE||t===c.Status.PUT_ON_HOLD?e[0]:e[1]},v.getActiveCall=function(){var e=null;return Object.keys(v.calls||[]).forEach(function(t){var n=v.calls[t];n.status===c.Status.ACTIVE&&(e=n)}),e},v.getCalls=function(){var e=[];return Object.keys(v.calls||[]).forEach(function(t){var n=v.calls[t],r=n.status;(r===c.Status.DIALING&&n.currentCalled.contactPhoneNumber||r===c.Status.RINGING_OUTGOING||r===c.Status.QUEUED_OUTGOING||r===c.Status.ACTIVE||r===c.Status.HOLD||r===c.Status.PUT_ON_HOLD||r===c.Status.ERROR)&&e.push(v.calls[t])}),e},v.getActiveCallsForContact=function(e){var t=[];return e&&e.jid&&Object.keys(v.calls||[]).forEach(function(n){v.calls[n].contact&&v.calls[n].contact.jid===e.jid&&(v.calls[n].status===c.Status.DIALING||v.calls[n].status===c.Status.RINGING_OUTGOING||v.calls[n].status===c.Status.ACTIVE||v.calls[n].status===c.Status.HOLD||v.calls[n].status===c.Status.PUT_ON_HOLD)&&t.push(v.calls[n])}),t},v.getConferenceCallForContact=function(e){var t=null;return e&&e.jid&&Object.keys(v.calls||[]).forEach(function(n){v.calls[n].status===c.Status.ACTIVE&&v.calls[n].isConference&&(v.calls[n].participants||[]).some(function(t){return t&&t.jid===e.jid})&&(t=v.calls[n])}),t},v.makeCall=function(t,n,r){var a=v.getActiveCall();return v.makingCall?(i.warn("[telephonyService] makeCall failure - makeCall already making a call"),e.reject()):(v.makingCall=!0,a?v.makeConsultationCall(t,n,a.connectionId):v.makeSimpleCall(t,n,r))},v.makeSimpleCall=function(a,o,l){return e(function(e,u){if(i.info("[telephonyService] makeSimpleCall to "+(a?a.getNameForLogs():f.anonymizePhoneNumber(o))),!v.isBasicCallAllowed){var h=new Error("makeSimpleCall failure - Not Allowed");return h.status=h.errorDetailsCode="403",i.error("[telephonyService] "+h.message),v.makingCall=!1,void u(h)}if(m.get("webrtcGatewayService").isMediaPillarCallSituation()&&1<=Object.keys(p.calls).length)return i.info("[telephonyService] makeCall failure - webrtcgateway call not possible when webrtc call already engaged"),v.makingCall=!1,r.$broadcast("ON_CALL_NOTALLOWED_EVENT","webCallAlreadyProgress"),void u("webCallAlreadyProgress");var g=v.getPhoneInfo(a,o),C="POST",S=v.portalURL+"calls",E={calleeExtNumber:g.longNumber,calleeIntNumber:g.internalNumber,calleeShortNumber:g.shortNumber,calleePbxId:g.pbxId,calleeDisplayName:a.displayName,callSubject:l,secondaryDeviceMakeCall:angular.isDefined(v.nomadicObject.makeCallInitiatorIsMain)&&!0===v.nomadicObject.featureActivated&&v.isNomadicEnabled?v.nomadicObject.makeCallInitiatorIsMain?"false":"true":void 0};i.info("[telephonyService] makeSimpleCall POST "+S),i.info("[telephonyService] makeSimpleCall data: "+JSON.stringify(E)),n({method:C,url:S,headers:s.getRequestHeader(),data:E}).then(function(t){i.info("[telephonyService] makeSimpleCall success : callee "+f.anonymizePhoneNumber(o));var n=c.create(c.Status.DIALING,null,c.Type.PHONE,a);n.setConnectionId(t.data.data.callId),n.setRelevantEquipmentId(c.getDeviceIdFromConnectionId(n.connectionId)),n.isSecondary=v.nomadicObject&&!v.nomadicObject.makeCallInitiatorIsMain,n.isOwner=!0,v.calls[n.id]=n,i.info("[telephonyService] makeSimpleCall Call created ("+n+")"),v.makingCall=!1,n.setIsVm(o===v.voicemailNumber),r.$broadcast("ON_CALL_UPDATED_EVENT",n),e(n.id)},function(e){var n=c.create(c.Status.ERROR,null,c.Type.PHONE,a);n.errorMessage=e&&"403"===e.errorDetailsCode?"notAllowed":"invalidPhoneNumber",v.calls[n.contact.id]=n,n.autoClear=t(function(){v.clearCall(n)},5e3,1),v.makingCall=!1,r.$broadcast("ON_CALL_UPDATED_EVENT",n);var o=d.handleError(e);u(o),i.error("[telephonyService] "+d.getErrorFullMessage(e,"makeCall"))})})},v.makeConsultationCall=function(a,o,l){return e(function(e,u){if(i.info("[telephonyService] makeConsultationCall to "+(a?a.getNameForLogs():f.anonymizePhoneNumber(o))),!v.isSecondCallAllowed){var h=new Error("makeConsultationCall failure - Not Allowed");return h.status=h.errorDetailsCode="403",i.error("[telephonyService] "+h.message),v.makingCall=!1,void u(h)}var p=v.getPhoneInfo(a,o),m="POST",g=v.portalURL+"calls/"+encodeURIComponent(l)+"/consultation",C={calleeExtNumber:p.longNumber,calleeIntNumber:p.internalNumber,calleeShortNumber:p.shortNumber,calleePbxId:p.pbxId,calleeDisplayName:a.displayName};i.info("[telephonyService] makeConsultationCall POST "+g),i.info("[telephonyService] makeConsultationCall data: "+JSON.stringify(C)),n({method:m,url:g,headers:s.getRequestHeader(),data:C}).then(function(t){i.info("[telephonyService] makeConsultationCall success : callee "+f.anonymizePhoneNumber(o));var n=c.create(c.Status.DIALING,null,c.Type.PHONE,a);n.setConnectionId(t.data.data.callId),n.setRelevantEquipmentId(c.getDeviceIdFromConnectionId(n.connectionId)),n.isSecondary=v.nomadicObject&&!v.nomadicObject.makeCallInitiatorIsMain,n.isOwner=!0,v.calls[n.id]=n,i.info("[telephonyService] makeConsultationCall Call created ("+n+")"),v.makingCall=!1,n.setIsVm(o===v.voicemailNumber),r.$broadcast("ON_CALL_UPDATED_EVENT",n),e(n.id)},function(e){var n=c.create(c.Status.ERROR,null,c.Type.PHONE,a);n.errorMessage=e&&"403"===e.errorDetailsCode?"notAllowed":"invalidPhoneNumber",v.calls[n.contact.id]=n,n.autoClear=t(function(){v.clearCall(n)},5e3,1),v.makingCall=!1;var o=d.handleError(e);v.deleteCallIfInvalid(o,v.calls[c.getIdFromConnectionId(l)]),r.$broadcast("ON_CALL_UPDATED_EVENT",n),u(o),i.error("[telephonyService] "+d.getErrorFullMessage(e,"makeConsultationCall"))})})},v.makeCallByPhoneNumber=function(t){return e(function(e,n){if(i.info("[telephonyService] makeCallByPhoneNumber : "+f.anonymizePhoneNumber(t)),o.userContact.phonePro===t||o.userContact.phoneProCan===t||o.userContact.phonePbx===t){var r="makeCallByPhoneNumber failure: impossible to call its own phone number";return i.error("[telephonyService] "+r),void n(new Error(r))}o.getOrCreateContact(null,t).then(function(e){return e,v.makeCall(e,t)}).then(function(){e()}).catch(function(e){var t="makeCallByPhoneNumber failure "+(e?e.message:"");i.error("[telephonyService] - callService - "+t),n(new Error(t))})})},v.getPhoneInfo=function(e,t){var n=t,r="",i="",a="";return e&&(t===e.phonePro||t===e.phoneProCan?(n=e.phoneProCan?e.phoneProCan:"",r=e.phonePbx,a=e.pbxId,i=e.phoneInternalNumber):t===e.phonePbx&&(n="",r=e.phonePbx,a=e.pbxId,i=e.phoneInternalNumber)),{longNumber:n,shortNumber:r,pbxId:a,internalNumber:i}},v.getErrorMessage=function(e,t){var n=t+" failure : ";if("error"===angular.element(e).attr("type")){var r=angular.element(e).find("error");if(r){var a=r.attr("type"),o=r.attr("code");a&&(n+=a+" : ","modify"===a&&(n+=r.find("text").text())),o&&"503"===o&&(n+="Agent error : service unavailable"),i.error("[telephonyService] "+n)}else n+="Unknown error";return n}return null},v.releaseCall=function(t){return e(function(e,a){if(i.info("[telephonyService] releaseCall "+t.id),!v.isBasicCallAllowed){var o=new Error("releaseCall failure - Not Allowed");return o.status=o.errorDetailsCode="403",i.error("[telephonyService] "+o.message),void a(o)}if(!v.started&&!v.starting){if(t.pbxConnectionDown)return t.mediaPillarCall&&t.mediaPillarCall.webrtcCallRef&&t.mediaPillarCall.webrtcCallRef.status!==c.Status.UNKNOWN?(i.info("[telephonyService] releaseCall "+t.id+" with pbx connection down : we release the mediapillar web call: "+t.mediaPillarCall.webrtcCallRef),p.releaseCall(t.mediaPillarCall.webrtcCallRef)):i.info("[telephonyService] releaseCall "+t.id+" with pbx connection down : "+(t.mediaPillarCall?t.mediaPillarCall.webrtcCallRef?"no need to release webrtc call with status "+t.mediaPillarCall.webrtcCallRef:"no MP webrtc call to release":"no MP context!")),i.info("[telephonyService] releaseCall "+t.id+" with pbx connection down : we remove the phone call"),v.clearCall(t),void e(t);var l=new Error("releaseCall failure - Telephony not started");return i.error("[telephonyService] releaseCall rejected : Telephony not started"),void a(l)}var u="DELETE",h=v.portalURL+"calls/"+encodeURIComponent(t.connectionId);i.info("[telephonyService] releaseCall "+u+" "+h),n({method:u,url:h,headers:s.getRequestHeader()}).then(function(){t.setStatus(c.Status.UNKNOWN),t.startDate=null,t.vm=!1,i.info("[telephonyService] releaseCall "+t.id+" - success"),r.$broadcast("ON_CALL_UPDATED_EVENT",t),delete v.calls[t.id],e(t)},function(e){var n=d.handleError(e);v.deleteCallIfInvalid(n,t),a(n),i.error("[telephonyService] "+d.getErrorFullMessage(e,"releaseCall"))})})},v.deleteCallIfInvalid=function(e,t){e&&"telephony"===e.portal&&404100===e.errorDetailsCode&&"Invalid connection identifier."===e.message&&t&&(i.warn("[telephonyService] deleteCallIfInvalid: delete client call non existing on server: "+t.id),t.setStatus(c.Status.UNKNOWN),r.$broadcast("ON_CALL_UPDATED_EVENT",t),v.calls[t.id]&&delete v.calls[t.id])},v.answerCall=function(t){return e(function(e,a){i.info("[telephonyService] answerCall : "+t.id);var o=v.getActiveCall();if(!v.isBasicCallAllowed){var l=new Error("answerCall failure - Not Allowed");return l.status=l.errorDetailsCode="403",i.error("[telephonyService] "+l.message),void a(l)}t.status===c.Status.QUEUED_INCOMMING&&o?v.holdCall(o).then(function(){return v.answerCall(t)}).then(function(t){e(t)}).catch(function(e){var t="answerCall failure : "+e.message;i.error("[telephonyService] - callService -  "+t),a(new Error(t))}):n({method:"PUT",url:v.portalURL+"calls/"+encodeURIComponent(t.connectionId)+"/answer",headers:s.getRequestHeader()}).then(function(n){t.setConnectionId(n.data.data.callId),t.setStatus(c.Status.ACTIVE),i.info("[telephonyService] answerCall success : "+f.anonymizePhoneNumber(t.contact.phone)+" Call ("+t+")"),r.$broadcast("ON_CALL_UPDATED_EVENT",t),e(t)},function(e){e.data&&"Device is not able to answer a call"===e.data.errorDetails&&r.$broadcast("ON_OPEN_GLOBAL_POPUP",{autoClose:!1,okLabel:"close",popupTitle:"warning",popupBody:"deviceDoesntAllowAnswer"}),t.setStatus(c.Status.UNKNOWN);var n=d.handleError(e);a(n),i.error("[telephonyService] "+d.getErrorFullMessage(e,"answerCall"))})})},v.holdCall=function(t){return e(function(e,a){if(t&&t.status!==c.Status.HOLD){if(!v.isSecondCallAllowed){var o=new Error("holdCall failure - Not Allowed");return o.status=o.errorDetailsCode="403",i.error("[telephonyService] "+o.message),void a(o)}n({method:"PUT",url:v.portalURL+"calls/"+encodeURIComponent(t.connectionId)+"/hold",headers:s.getRequestHeader()}).then(function(n){i.info("[telephonyService] holdCall success : "+f.anonymizePhoneNumber(t.contact.phone)+" Call ("+t+")"),t.setConnectionId(n.data.data.callId),t.setStatus(c.Status.HOLD),r.$broadcast("ON_CALL_UPDATED_EVENT",t),e(t)},function(e){var t=d.handleError(e);a(t),i.error("[telephonyService] "+d.getErrorFullMessage(e,"holdCall"))})}else e(t)})},v.retrieveCall=function(t){return e(function(e,a){if(i.info("[telephonyService] retrieveCall : "+t.contact.displayNameForLog()),!v.isSecondCallAllowed){var o=new Error("retrieveCall failure - Not Allowed");return o.status=o.errorDetailsCode="403",i.error("[telephonyService] "+o.message),void a(o)}var l=v.getActiveCall();l?v.holdCall(l).then(function(){return v.retrieveCall(t)}).then(function(t){e(t)}).catch(function(e){var t="retrieveCall failure : "+e.message;i.error("[telephonyService] - callService -  "+t),a(new Error(t))}):n({method:"PUT",url:v.portalURL+"calls/"+encodeURIComponent(t.connectionId)+"/retrieve",headers:s.getRequestHeader()}).then(function(n){i.info("[telephonyService] retrieveCall success : "+f.anonymizePhoneNumber(t.contact.phone)+" Call ("+t+")"),t.setConnectionId(n.data.data.callId),t.setStatus(c.Status.ACTIVE),r.$broadcast("ON_CALL_UPDATED_EVENT",t),e()},function(e){var n=d.handleError(e);v.deleteCallIfInvalid(n,t),a(n),i.error("[telephonyService] "+d.getErrorFullMessage(e,"retrieveCall"))})})},v.deflectCallToVM=function(t){return e(function(e,r){if(t){if(!v.isVMDeflectCallAllowed){var a=new Error("deflectCall failure - Not Allowed");return a.status=a.errorDetailsCode="403",i.error("[telephonyService] "+a.message),void r(a)}i.info("[telephonyService] deflectCallToVM "+t.contact.displayNameForLog()),n({method:"PUT",url:v.portalURL+"calls/"+encodeURIComponent(t.connectionId)+"/deflect",headers:s.getRequestHeader(),data:{calleeExtNumber:"",calleeIntNumber:v.voicemailNumber,calleeShortNumber:v.voicemailNumber,calleePbxId:v.pbxId}}).then(function(){i.info("[telephonyService] deflectCall success"),e()},function(e){var t=d.handleError(e);r(t),i.error("[telephonyService] "+d.getErrorFullMessage(e,"deflectCallToVM"))})}else e(t)})},v.transfertCall=function(t,r){return e(function(e,a){if(t&&r){if(!v.isTransferAllowed){var o=new Error("transferCall failure - Not Allowed");return o.status=o.errorDetailsCode="403",i.error("[telephonyService] "+o.message),void a(o)}i.info("[telephonyService] transfertCall held("+r.contact.displayName+") to active("+t.contact.displayName+")"),n({method:"PUT",url:v.portalURL+"calls/"+encodeURIComponent(t.connectionId)+"/transfer/"+encodeURIComponent(r.connectionId),headers:s.getRequestHeader()}).then(function(){i.info("[telephonyService] transferCall success"),e()},function(e){var t=d.handleError(e);a(t),i.error("[telephonyService] "+d.getErrorFullMessage(e,"transfertCall"))})}else e()})},v.conferenceCall=function(t,r){return e(function(e,a){if(t&&r){if(!v.isConferenceAllowed){var o=new Error("conferenceCall failure - Not Allowed");return o.status=o.errorDetailsCode="403",i.error("[telephonyService] "+o.message),void a(o)}i.info("[telephonyService] conferenceCall "+t.contact.displayName+" and "+r.contact.displayName),n({method:"PUT",url:v.portalURL+"calls/"+encodeURIComponent(t.connectionId)+"/conference/"+encodeURIComponent(r.connectionId),headers:s.getRequestHeader()}).then(function(){i.info("[telephonyService] conferenceCall success"),e()},function(e){var t=d.handleError(e);a(t),i.error("[telephonyService] "+d.getErrorFullMessage(e,"conferenceCall"))})}else e()})},v.forwardToDevice=function(t){return e(function(e,r){if(i.info("[telephonyService] forwardToDevice : "+t),!v.isForwardEnabled){var a=new Error("forwardToDevice failure - Not Allowed");return a.status=a.errorDetailsCode="403",i.error("[telephonyService] "+a.message),void r(a)}if(o.userContact.phonePro===t||o.userContact.phoneProCan===t||o.userContact.phonePbx===t){var c="forwardToDevice failure: impossible to forward its own phone number";return i.error("[telephonyService] "+c),void r(new Error(c))}o.getOrCreateContact(null,t).then(function(a){var o=v.getPhoneInfo(a,t);n({method:"PUT",url:v.portalURL+"forward",headers:s.getRequestHeader(),data:{calleeExtNumber:o.longNumber,calleeIntNumber:o.internalNumber,calleeShortNumber:o.shortNumber,calleePbxId:o.pbxId,calleeDisplayName:a.displayName}}).then(function(){e()},function(e){var t=d.handleError(e);r(t),i.error("[telephonyService] "+d.getErrorFullMessage(e,"forwardToDevice"))})})})},v.forwardToVoicemail=function(){return e(function(e,t){if(i.info("[telephonyService] forwardToVoicemail"),!v.voiceMailFeatureEnabled||!v.isForwardEnabled){var r=new Error("forwardToVoicemail failure - voicemail/forward feature not enabled");return r.status=r.errorDetailsCode="404",i.error("[telephonyService] "+r.message),void t(r)}n({method:"PUT",url:v.portalURL+"forward",headers:s.getRequestHeader(),data:{calleeExtNumber:"",calleeIntNumber:v.voicemailNumber,calleePbxId:v.pbxId}}).then(function(){i.info("[telephonyService] forwardToVoicemail success"),e()},function(e){var n=d.handleError(e);t(n),i.error("[telephonyService] "+d.getErrorFullMessage(e,"forwardToVoicemail"))})})},v.cancelForward=function(){return e(function(e,t){if(i.info("[telephonyService] cancelForward"),!v.isForwardEnabled){var r=new Error("cancelForward failure - Not Allowed");return r.status=r.errorDetailsCode="403",i.error("[telephonyService] "+r.message),void t(r)}o.userContact.phonePbx?n({method:"PUT",url:v.portalURL+"forward",headers:s.getRequestHeader(),data:{calleeExtNumber:"",calleeIntNumber:"CANCELFORWARD",calleePbxId:v.pbxId}}).then(function(){i.info("[telephonyService] cancelForward success"),e()},function(e){var n=d.handleError(e);t(n),i.error("[telephonyService] "+d.getErrorFullMessage(e,"cancelForward"))}):t()})},v.getForwardStatus=function(){return e(function(e,t){if(!v.isForwardEnabled){var r=new Error("getForwardStatus failure - Not Allowed");return r.status=r.errorDetailsCode="403",i.error("[telephonyService] "+r.message),void t(r)}v.starting||v.started?n({method:"GET",url:v.portalURL+"forward",headers:s.getRequestHeader()}).then(function(){i.info("[telephonyService] getForwardStatus success"),e()},function(e){var n=d.handleError(e);t(n),i.error("[telephonyService] "+d.getErrorFullMessage(e,"getForwardStatus"))}):t(new Error("getForwardStatus failure - Telephony not started"))})},v.getForwardObject=function(){return v.forwardObject},v.nomadicLogin=function(t,r){return e(function(e,a){if(!v.isNomadicEnabled||!v.nomadicObject.featureActivated){var c=new Error("nomadicLogin failure - Not Allowed");return c.status=c.errorDetailsCode="403",i.error("[telephonyService] "+c.message),void a(c)}if(o.userContact.phonePro===t||o.userContact.phoneProCan===t||o.userContact.phonePbx===t){var l="nomadicLogin failure: impossible to use its own phone number like nomadic phone";return i.error("[telephonyService] "+l),void a(new Error(l))}i.info("[telephonyService] nomadicLogin : "+t),r=r||!1,v.nomadicAnswerNotTakedIntoAccount=r,o.getOrCreateContact(null,t).then(function(r){var o=v.getPhoneInfo(r,t);n({method:"PUT",url:v.portalURL+"nomadic/login",headers:s.getRequestHeader(),data:{destinationExtNumber:o.longNumber,destinationIntNumber:o.internalNumber,destinationShortNumber:o.shortNumber,destinationPbxId:o.pbxId,destinationDisplayName:r.displayName,destinationCountry:r.country}}).then(function(){i.info("[telephonyService] nomadicLogin success"),e()},function(e){var t=d.handleError(e);a(t),i.error("[telephonyService] "+d.getErrorFullMessage(e,"nomadicLogin"))})})})},v.nomadicLoginOnOfficePhone=function(){return e(function(e,t){if(!v.isNomadicEnabled||!v.nomadicObject.featureActivated){var r=new Error("nomadicLoginOnOfficePhone failure - Not Allowed");return r.status=r.errorDetailsCode="403",i.error("[telephonyService] "+r.message),void t(r)}i.info("[telephonyService] nomadicLoginOnOfficePhone"),n({method:"PUT",url:v.portalURL+"nomadic/login",headers:s.getRequestHeader()}).then(function(){i.info("[telephonyService] nomadicLoginOnOfficePhone success"),e()},function(e){var n=d.handleError(e);t(n),i.error("[telephonyService] "+d.getErrorFullMessage(e,"nomadicLoginOnOfficePhone"))})})},v.nomadicLogout=function(){return e(function(e,t){if(!v.isNomadicEnabled||!v.nomadicObject.featureActivated){var r=new Error("nomadicLogout failure - Not Allowed");return r.status=r.errorDetailsCode="403",i.error("[telephonyService] "+r.message),void t(r)}i.info("[telephonyService] nomadicLogout"),n({method:"PUT",url:v.portalURL+"nomadic/logout",headers:s.getRequestHeader()}).then(function(){i.info("[telephonyService] nomadicLogout success"),e()},function(e){var n=d.handleError(e);t(n),i.error("[telephonyService] "+d.getErrorFullMessage(e,"nomadicLogout"))})})},v.getNomadicStatus=function(){return e(function(e,t){if(!v.isNomadicEnabled){var r=new Error("getNomadicStatus failure - Not Allowed");return r.status=r.errorDetailsCode="403",i.error("[telephonyService] "+r.message),void t(r)}v.starting||v.started?n({method:"GET",url:v.portalURL+"nomadic",headers:s.getRequestHeader()}).then(function(t){i.info("[telephonyService] getNomadicStatus success"),v.updateNomadicData(t.data.data),e()},function(e){var n=d.handleError(e);t(n),i.error("[telephonyService] "+d.getErrorFullMessage(e,"getNomadicStatus"))}):t(new Error("getNomadicStatus failure - Telephony not started"))})},v.setNomadicState=function(){return e(function(e,t){i.info("[telephonyService] setNomadicState"),n({method:"PUT",url:v.portalURL+"nomadic/state",headers:s.getRequestHeader(),data:{makeCallInitiatorIsMain:"true"}}).then(function(){i.info("[telephonyService] setNomadicState success"),e()},function(e){var n=d.handleError(e);t(n),i.error("[telephonyService] "+d.getErrorFullMessage(e,"setNomadicState"))})})},v.updateNomadicData=function(e){i.info("[telephonyService] updateNomadicData destination:"+e.destination+" featureActivated:"+e.featureActivated+" makeCallInitiatorIsMain:"+e.makeCallInitiatorIsMain+" modeActivated:"+e.modeActivated+" monodevice:"+o.userContact.isVirtualTerm);var t=JSON.parse(JSON.stringify(v.nomadicObject));v.nomadicObject.featureActivated="true"===e.featureActivated,v.nomadicObject.modeActivated="true"===e.modeActivated,v.nomadicObject.destination=e.destination,v.nomadicObject.makeCallInitiatorIsMain="true"===e.makeCallInitiatorIsMain;var n=t.makeCallInitiatorIsMain!==v.nomadicObject.makeCallInitiatorIsMain;if(v.nomadicAnswerNotTakedIntoAccount||r.$broadcast("ON_CALL_NOMADIC_EVENT",v.nomadicObject),v.nomadicAnswerNotTakedIntoAccount=!1,o.userContact.isVirtualTerm&&v.nomadicObject.featureActivated&&(""===v.nomadicObject.destination||void 0===v.nomadicObject.destination)&&(o.userContact.mobileProCan||o.userContact.mobilePerso)){var a=o.userContact.mobileProCan?o.userContact.mobileProCan:o.userContact.mobilePerso;v.nomadicLogin(a)}return n},v.getNomadicObject=function(){return v.nomadicObject},v.getNomadicDestination=function(){return v.nomadicObject.destination},v.sendDtmf=function(t,a){return e(function(e,o){t&&a?n({method:"PUT",url:v.portalURL+"calls/"+encodeURIComponent(t.connectionId)+"/dtmf",headers:s.getRequestHeader(),data:{dtmf:a}}).then(function(){r.$broadcast("ON_DTMF_SENT",a),e()},function(e){var t=d.handleError(e);o(t),i.error("[telephonyService] "+d.getErrorFullMessage(e,"sendDtmf"))}):o()})},v.clearCall=function(e,t){i.info("[telephonyService] clearCall for call id: "+e.id),e.setStatus(c.Status.UNKNOWN),t||r.$broadcast("ON_CALL_UPDATED_EVENT",e),e.contact&&delete v.calls[e.contact.id],e.getCurrentCalled()&&e.setCurrentCalled(null)},v.startAsPhoneNumber=function(e){var t=e.trim().split(".").join(""),n=t.match(/^(\+|\d|#|\*|\(|\)|\.|-|\s|\/)*$/);return!!n&&n[0]===t},v.updateContactFromOutlookInfos=function(){return i.info("[telephonyService] default updateContactFromOutlookInfos"),e.reject()}}])},function(){angular.module("rainbow").factory("TelephonyServiceEventHandler",["$log","$q","$rootScope","$interval","$injector","contactService","Call","profileService","Contact","PromiseQueue","pstnConferenceService","utilService",function(e,t,n,r,i,a,o,s,c,l,d,u){"use strict";function h(e){this.telephonyService=e,this.promiseQueue=l.create()}return h.create=function(e){return new h(e)},h.CallFailureLabels={DESTNOTOBTAINABLE:"outOfService",DONOTDISTURB:"dnd",TRUNKSBUSY:"trunksbusy",BUSY:"busy"},h.prototype.onCallserviceMessageReceived=function(t){try{var n=$(t),r=this;if("Offline Storage"===n.find("delay").text())return!0;var i=n.find("callservice").children(),a=i.prop("tagName").split(":"),o=a[a.length-1].toLowerCase(),s=i.attr("callId");s=s?" -- "+s:"";var c=i.attr("deviceType"),l=c?" -- "+c:"",d=i.attr("oldCallId");d=d?" -- old "+d:"",c||(c="MAIN");var u=this.telephonyService.getNomadicObject(),h=!u||u.makeCallInitiatorIsMain||!u.modeActivated;if(!["messaging","forwarded","nomadicstatus","openDesktop"].includes(o)&&("MAIN"===c&&!h||"SECONDARY"===c&&h))return e.info("[TelephonyServiceEventHandler] onCallserviceMessageReceived -- "+o.toUpperCase()+s+d+l+" => IGNORED"),!0;switch(e.info("[TelephonyServiceEventHandler] onCallserviceMessageReceived -- "+o.toUpperCase()+s+d+l),o){case"initiated":this.promiseQueue.add(function(){return r.onInitiatedEvent(i)});break;case"originated":this.promiseQueue.add(function(){return r.onOriginatedEvent(i)});break;case"delivered":this.promiseQueue.add(function(){return r.onDeliveredEvent(i)});break;case"established":this.promiseQueue.add(function(){return r.onEstablishedEvent(i)});break;case"retrievecall":this.promiseQueue.add(function(){return r.onRetrieveCallEvent(i)});break;case"queued":this.promiseQueue.add(function(){return r.onQueuedEvent(i)});break;case"holdcall":case"held":this.promiseQueue.add(function(){return r.onHeldEvent(i)});break;case"diverted":this.promiseQueue.add(function(){return r.onDivertedEvent(i)});break;case"transfercall":case"transferred":this.promiseQueue.add(function(){return r.onTransferEvent(i)});break;case"conferenced":this.promiseQueue.add(function(){return r.onConferenceEvent(i)});break;case"connectioncleared":this.promiseQueue.add(function(){return r.onClearCallEvent(i)});break;case"failed":this.promiseQueue.add(function(){return r.onFailCallEvent(i)});break;case"messaging":this.promiseQueue.add(function(){return r.onVoiceMessageEvent(i)});break;case"updatecall":this.promiseQueue.add(function(){return r.onUpDateCallEvent(i)});break;case"forwarded":this.promiseQueue.add(function(){return r.onCallForwardedEvent(i)});break;case"callsubject":this.promiseQueue.add(function(){return r.onCallSubjectEvent(i)});break;case"nomadicstatus":this.promiseQueue.add(function(){return r.onCallNomadicEvent(i)});break;case"openDesktop":e.info("[TelephonyServiceEventHandler] openDesktop detected ")}return!0}catch(t){return e.error("[TelephonyServiceEventHandler] onCallserviceMessageReceived -- failure -- "+t.message),!0}},h.prototype.onInitiatedEvent=function(n){e.info("[TelephonyServiceEventHandler] onInitiatedEvent");var r=this;return this.getCall(n).then(function(a){try{var s=n.attr("deviceState"),c=n.attr("newCallId");return void 0===c?r.computeCallRelevancy(n,a):r.getOrCreateCall(c).then(function(t){e.info("[TelephonyServiceEventHandler] onInitiatedEvent : changed call id from "+a.id+" to "+c),r.computeCallRelevancy(n,t),"LCI_CONNECTED"===s?t.setStatus(o.Status.ACTIVE):t.setStatus(a.status),t.setContact(a.contact),t.isOwner=a.isOwner;var l=d.getConferenceSessionWithConnId(a.connectionId);(l&&l.setCallId(c),a.isMediaPillarCall())&&i.get("webrtcGatewayService").replaceCallRefs(t,a);r.telephonyService.clearCall(a),r.sendCallUpdateEvent(a),r.sendCallUpdateEvent(t),delete r.telephonyService.calls[a.id]}),t.when()}catch(n){var l="onInitiatedEvent -- "+n.message;return e.error("[TelephonyServiceEventHandler] "+l),t.reject(new Error(l))}})},h.prototype.onOriginatedEvent=function(n){e.info("[TelephonyServiceEventHandler] onOriginatedEvent");var r=this;return this.getCall(n).then(function(a){try{var o=n.attr("endpointIm"),s=n.attr("endpointTel"),c=n.attr("newCallId"),l={contactPhoneNumber:"",contact:a.contact,participantsPhoneNumbers:null,participants:null};return o||s?l.contactPhoneNumber=s||"":a.contact&&a.contact.temp&&(l.contactPhoneNumber=a.contact.id),a.setCurrentCalled(l),void 0===c?r.sendCallUpdateEvent(a):r.getOrCreateCall(c,o,s).then(function(t){e.info("[TelephonyServiceEventHandler] onOriginatedEvent : changed call id from "+a.id+" to "+c),r.computeCallRelevancy(n,t),t.setStatus(a.status),t.setContact(a.contact),t.setCurrentCalled(l),t.isOwner=a.isOwner;var o=d.getConferenceSessionWithConnId(a.connectionId);(o&&o.setCallId(c),a.isMediaPillarCall())&&i.get("webrtcGatewayService").replaceCallRefs(t,a);r.telephonyService.clearCall(a),r.sendCallUpdateEvent(a),r.sendCallUpdateEvent(t),delete r.telephonyService.calls[a.id]}),t.when()}catch(n){var u="onOriginatedEvent -- "+n.message;return e.error("[TelephonyServiceEventHandler] "+u),t.reject(new Error(u))}})},h.prototype.onDeliveredEvent=function(n){e.info("[TelephonyServiceEventHandler] onDeliveredEvent");var r=this;return this.getCall(n).then(function(i){try{if(r.computeCallRelevancy(n,i),i.status===o.Status.QUEUED_INCOMMING)return t.resolve();var a=n.attr("type"),s=n.attr("endpointIm"),c=n.attr("endpointTel");return i.setStatus("outgoing"===a?o.Status.RINGING_OUTGOING:o.Status.RINGING_INCOMMING),i.startDate=null,i.vm=!1,r.updateCallContact(s,c,n,i)}catch(n){var l="onDeliveredEvent -- "+n.message;return e.error("[TelephonyServiceEventHandler] "+l),t.reject(new Error(l))}})},h.prototype.onEstablishedEvent=function(n){e.info("[TelephonyServiceEventHandler] onEstablishedEvent");var r=this;return this.getCall(n).then(function(i){try{r.computeCallRelevancy(n,i);var s=n.attr("endpointIm"),c=n.attr("endpointTel"),l=n.attr("callId");if(i.contact&&i.contact.id)return i.setStatus(o.Status.ACTIVE),i.setConnectionId(l),r.sendCallUpdateEvent(i,n),r.updateCallContact(s,c,n,i);if(!(i.participants&&0<i.participants.length))return e.info("[TelephonyServiceEventHandler] onEstablishedEvent, no call contact / no participants"),s||c||(c="****"),a.getOrCreateContact(s,c).then(function(e){return i.setContact(e),i.setStatus(o.Status.ACTIVE),h={contactPhoneNumber:c,contact:e},i.setCurrentCalled(h),r.sendCallUpdateEvent(i,n),t.when()});for(var d=null,u=0;u<i.participants.length&&!d;u++)i.participants[u].id===s?d=i.participants[u]:i.currentCalled.participantsPhoneNumbers&&0<i.currentCalled.participantsPhoneNumbers.length&&i.currentCalled.participantsPhoneNumbers[u]===c&&(d=i.participants[u]);i.participants=[],i.isConference=!1;var h=i.getCurrentCalled();return d?(i.setContact(d),i.setStatus(o.Status.ACTIVE),h={contactPhoneNumber:c,contact:d},i.setCurrentCalled(h),r.sendCallUpdateEvent(i,n),t.when()):(s||c||(c="****"),a.getOrCreateContact(s,c).then(function(e){return i.setContact(e),i.setStatus(o.Status.ACTIVE),h={contactPhoneNumber:c,contact:e},i.setCurrentCalled(h),r.sendCallUpdateEvent(i,n),t.when()}))}catch(n){var f="onEstablishedEvent -- "+n.message;return e.error("[TelephonyServiceEventHandler] "+f),t.reject(new Error(f))}})},h.prototype.onRetrieveCallEvent=function(t){e.info("[TelephonyServiceEventHandler] onRetrieveCallEvent");var n=this;return this.getCall(t,!0).then(function(e){e.setStatus(o.Status.ACTIVE),n.sendCallUpdateEvent(e,t)})},h.prototype.onClearCallEvent=function(n){var r=this,i=n.attr("callId"),a=o.getIdFromConnectionId(i);return e.info("[TelephonyServiceEventHandler] onClearCallEvent, connectionId: "+i),this.telephonyService.calls[a]?this.getCall(n).then(function(e){r.computeCallRelevancy(n,e),r.telephonyService.clearCall(e,!0),r.sendCallUpdateEvent(e,n)}):(e.info("[TelephonyServiceEventHandler] onClearCallEvent, no call for connectionId: "+i),t.resolve())},h.prototype.onHeldEvent=function(n){e.info("[TelephonyServiceEventHandler] onHeldEvent");var r=this;return this.getCall(n,!0).then(function(i){try{var a=n.attr("callId");return o.getDeviceIdFromConnectionId(i.connectionId)===o.getDeviceIdFromConnectionId(a)?i.setStatus(o.Status.HOLD):i.setStatus(o.Status.PUT_ON_HOLD),r.sendCallUpdateEvent(i,n),t.when()}catch(n){var s="onHeldEvent -- "+n.message;return e.error("[TelephonyServiceEventHandler] "+s),t.reject(new Error(s))}})},h.prototype.onQueuedEvent=function(n){e.info("[TelephonyServiceEventHandler] onQueuedEvent");var r=this,i=n.attr("cause");return"PARK"===i?(e.warn("[TelephonyServiceEventHandler] onQueuedEvent - ignore PARK cause"),t.when()):"NEWCALL"===i?(e.warn("[TelephonyServiceEventHandler] onQueuedEvent - ignore NEWCALL cause"),t.when()):this.getCall(n).then(function(i){try{r.computeCallRelevancy(n,i);var a=n.attr("type"),s=n.attr("endpointIm"),c=n.attr("endpointTel"),l="outgoing"===a?o.Status.QUEUED_OUTGOING:o.Status.QUEUED_INCOMMING;return i.setStatus(l),i.startDate=null,i.vm=!1,i.relevantEquipmentId=o.getDeviceIdFromConnectionId(i.connectionId),r.updateCallContact(s,c,n,i)}catch(n){var d="onQueuedEvent -- "+n.message;return e.error("[TelephonyServiceEventHandler] "+d),t.reject(new Error(d))}})},h.prototype.onDivertedEvent=function(n){e.info("[TelephonyServiceEventHandler] onDivertedEvent");var r=n.attr("oldCallId"),a=o.getIdFromConnectionId(r),s=this.telephonyService.calls[a];return s?(this.computeCallRelevancy(n,s),i.get("webrtcGatewayService").isMediaPillarCallCase()?s.isSecondary?this.telephonyService.clearCall(s):this.telephonyService.clearCall(s,!0):this.telephonyService.clearCall(s),this.sendCallUpdateEvent(s,n),t.when()):(e.warn("[TelephonyServiceEventHandler] onDivertedEvent - receive divertedEvent on unknown call --- ignored"),t.when())},h.prototype.onTransferEvent=function(n){e.info("[TelephonyServiceEventHandler] onTransferEvent");var r=this,i=n.attr("activeCallId"),a=n.attr("heldCallId"),s=n.attr("newCallId"),c=o.getIdFromConnectionId(i),l=this.telephonyService.calls[c];if(a){var d=o.getIdFromConnectionId(a),u=this.telephonyService.calls[d];u.setStatus(o.Status.UNKNOWN),l.setStatus(o.Status.UNKNOWN),r.sendCallUpdateEvent(u),r.sendCallUpdateEvent(l)}if(s){var h=n.attr("newEndpointIm"),f=n.attr("newEndpointTel"),p=n.attr("deviceState");return p||(p=n.attr("deviceStatus")),l.setStatus(o.Status.UNKNOWN),r.sendCallUpdateEvent(l),h||f||(f="****"),this.getOrCreateCall(s,h,f).then(function(e){return p&&"LCI_ALERTING"===p?e.setStatus(o.Status.RINGING_INCOMMING):e.setStatus(o.Status.ACTIVE),e.relevantEquipmentId=o.getDeviceIdFromConnectionId(s),r.updateCallContact(h,f,n,e)})}return t.resolve()},h.prototype.onConferenceEvent=function(n){e.info("[TelephonyServiceEventHandler] onConferenceEvent");var r=this,i=n.find("primaryOldCallId").text(),s=n.find("secondaryOldCallId").text(),c=n.find("newCallId").text(),l=o.getIdFromConnectionId(i),d=o.getIdFromConnectionId(s),u=this.telephonyService.calls[l],h=this.telephonyService.calls[d],f=[],p=[],m=[];return n.find("participant").each(function(){var n=angular.element(this),i=n.find("endpointTel").text(),o=n.find("endpointIm").text();o&&a.isUserContactJid(o)||p.push(t(function(t){o||i||(i="****"),!o&&u&&u.contact&&u.currentCalled.contactPhoneNumber===i?(f.push(u.contact),m.push(i),t()):!o&&h&&h.contact&&h.currentCalled.contactPhoneNumber===i?(f.push(h.contact),m.push(i),t()):a.getOrCreateContact(o,i).then(function(n){f.push(n),m.push(i),r.telephonyService.updateContactFromOutlookInfos(n,i).then(function(t){t?e.debug("[TelephonyServiceEventHandler] on conferenced, update from outlook for contact :"+n.displayNameMD5):e.debug("[TelephonyServiceEventHandler] on conferenced, no update from outlook for contact :"+n.displayNameMD5)},function(){e.debug("[TelephonyServiceEventHandler] on conferenced, no Outlook search available")}).finally(function(){t()})}).catch(function(n){e.error("[TelephonyServiceEventHandler] onConferenceEvent - Impossible to get contact - "+n.message),t()})}))}),t.all(p).finally(function(){var t=!1;u&&(t=t||u.isSecondary),h&&(t=t||h.isSecondary);var n=r.createConferenceCall(c,f),i=n.getCurrentCalled();i.participants=f,i.participantsPhoneNumbers=m,n.setCurrentCalled(i),n.setStatus(o.Status.ACTIVE),n.relevantEquipmentId=o.getDeviceIdFromConnectionId(c),n.isSecondary=t,e.debug("[TelephonyServiceEventHandler] on conferenced, create new call: "+n),r.sendCallUpdateEvent(n),u&&(u.setStatus(o.Status.UNKNOWN),e.debug("[TelephonyServiceEventHandler] on conferenced, updated primaryOldCall: "+u),r.sendCallUpdateEvent(u)),h&&(h.setStatus(o.Status.UNKNOWN),e.debug("[TelephonyServiceEventHandler] on conferenced, updated secondaryOldCall: "+h),r.sendCallUpdateEvent(h))})},h.prototype.onVoiceMessageEvent=function(r){if(e.info("[TelephonyServiceEventHandler] onVoiceMessageEvent"),!s.isFeatureEnabled(s.FeaturesEnum.TELEPHONY_VOICE_MAIL))return e.info("[TelephonyServiceEventHandler] onVoiceMessageEvent feature not enabled => IGNORED event"),t.when();var i=r.find("voiceMessageCounter").text();if(i){var a=+i;Number.isInteger(a)&&0<=a&&(e.info("[TelephonyServiceEventHandler] onVoiceMessageEvent "+a+" voice message(s)"),this.telephonyService.voiceMail.setVMCounter(a),this.telephonyService.voiceMail.setVMFlag(0<a),this.telephonyService.voiceMail.setInfoMsg(""),n.$broadcast("ON_VOICE_MESSAGE_UPDATE_EVENT",a))}return"changed"===r.find("voiceMessageWaiting").text()&&(e.info("[TelephonyServiceEventHandler] onVoiceMessageEvent voiceMessageWaiting : changed => retrieve counter"),this.telephonyService.getVoiceMessageCounter()),t.when()},h.prototype.onUpDateCallEvent=function(n){e.info("[TelephonyServiceEventHandler] onUpDateCallEvent");var i=this;return this.getCall(n).then(function(o){var l=n.attr("endpointIm"),d=n.attr("endpointTel"),h="",f="",p=n.find("identity").attr("firstName"),m=n.find("identity").attr("lastName"),v=n.find("identity").attr("displayName"),g=!1;if(!config.permitSearchFromPhoneBook&&!s.isFeatureEnabled(s.FeaturesEnum.TELEPHONY_PHONE_BOOK))return e.debug("[TelephonyServiceEventHandler] onUpDateCallEvent xnames not allowed for the user profile => IGNORED event"),t.when();if(m&&m.length)f=m,p&&p.length&&(h=p),e.info("[TelephonyServiceEventHandler] onUpDateCallEvent received for call "+o.id+" for phoneNumber:"+u.anonymizePhoneNumber(d)+" with name : "+h.slice(0,1)+"***");else{if(!v||!v.length||v===d)return e.info("[TelephonyServiceEventHandler] onUpDateCallEvent xnames not available => IGNORED event"),t.when();f=v,e.info("[TelephonyServiceEventHandler] onUpDateCallEvent only displayName available")}return a.getOrCreateContact(l,d).then(function(t){if(t.temp){if(t.updateName(h,f),o.contact&&o.contact.id){var a={contactPhoneNumber:d,contact:t};(o.contact.id!==t.id||o.contact.displayName===d||o.contact.getNameUpdatePrio()===c.NameUpdatePrio.OUTLOOK_UPDATE_PRIO)&&(t.setNameUpdatePrio(c.NameUpdatePrio.SERVER_UPDATE_PRIO),o.setContact(t),o.setCurrentCalled(a),g=!0,e.debug("[TelephonyServiceEventHandler] onUpDateCallEvent xnames updated for "+d+" with contact : "+t.displayNameMD5))}else if(o.participants&&0<o.participants.length){a=o.getCurrentCalled();for(var s=0;s<o.participants.length;s++)o.participants[s].temp?o.participants[s].phoneProCan&&o.participants[s].phoneProCan===d&&(e.debug("[TelephonyServiceEventHandler] onUpDateCallEvent temp participant "+o.participants[s].displayNameMD5+" updated with : "+t.displayNameMD5),o.participants[s]=t,o.participants[s].setNameUpdatePrio(c.NameUpdatePrio.SERVER_UPDATE_PRIO),a.participantsPhoneNumbers[s]=d,a.participants[s]=t,g=!0):e.debug("[TelephonyServiceEventHandler] onUpDateCallEvent STRANGE former participant was a rainbow: "+o.participants[s].displayNameMD5);o.setCurrentCalled(a)}}else if(o.contact&&o.contact.id){a={contactPhoneNumber:d,contact:t};o.contact.id!==t.id&&(o.contact.temp&&(o.contact.updateName(h,f),o.contact.setNameUpdatePrio(c.NameUpdatePrio.SERVER_UPDATE_PRIO)),o.setContact(t),o.setCurrentCalled(a),g=!0,e.debug("[TelephonyServiceEventHandler] onUpDateCallEvent call update with rainbow contact : "+t.displayNameMD5))}else if(o.participants&&0<o.participants.length){for(a=o.getCurrentCalled(),s=0;s<o.participants.length;s++)o.participants[s].temp?o.participants[s].phoneProCan&&o.participants[s].phoneProCan===d&&(e.debug("[TelephonyServiceEventHandler] onUpDateCallEvent temp participant "+o.participants[s].displayNameMD5+" updated with : "+t.displayNameMD5),o.participants[s]=t,o.setParticipants(o.participants),a.participantsPhoneNumbers[s]=d,a.participants[s]=t,g=!0):o.participants[s].jid===l?(a.participantsPhoneNumbers[s]=d,a.participants[s]=o.participants[s],g=!0,e.debug("[TelephonyServiceEventHandler] onUpDateCallEvent rainbow participant "+o.participants[s].displayNameMD5+" updated with the same : "+t.displayNameMD5)):e.debug("[TelephonyServiceEventHandler] onUpDateCallEvent other participant not updated : "+o.participants[s].displayNameMD5+" vs "+t.displayNameMD5);o.setCurrentCalled(a)}g?r(function(){i.sendCallUpdateEvent(o,n)},300,1):e.debug("[TelephonyServiceEventHandler] onUpDateCallEvent, no update needed for call : "+o.id)})})},h.prototype.onFailCallEvent=function(t){e.info("[TelephonyServiceEventHandler] onFailCallEvent");var n=t.attr("cause"),r=this;return this.getCall(t).then(function(e){e.setStatus(o.Status.ERROR),e.errorMessage=h.CallFailureLabels[n],e.errorMessage||(e.errorMessage=n),r.sendCallUpdateEvent(e,t)})},h.prototype.onCallNomadicEvent=function(n){e.info("[TelephonyServiceEventHandler] onCallNomadicEvent");var r={destination:n.attr("destination"),featureActivated:n.attr("featureActivated"),makeCallInitiatorIsMain:n.attr("makeCallInitiatorIsMain"),modeActivated:n.attr("modeActivated")};if(this.telephonyService.updateNomadicData(r)){var i=this.telephonyService.nomadicObject.featureActivated&&this.telephonyService.nomadicObject.modeActivated&&!this.telephonyService.nomadicObject.makeCallInitiatorIsMain;this.telephonyService.getTelephonyState(i)}return t.when()},h.prototype.onCallForwardedEvent=function(r){var i=r.attr("forwardType"),a=r.attr("forwardTo");return e.info("[TelephonyServiceEventHandler] onCallForwardedEvent forwardType: "+i+" forwardTo: "+a),n.$broadcast("ON_CALL_FORWARDED_EVENT",{forwardType:i,forwardTo:a}),this.telephonyService.forwardObject.forwardType=i,this.telephonyService.forwardObject.forwardTo=a,t.when()},h.prototype.onCallSubjectEvent=function(n){e.info("[TelephonyServiceEventHandler] onCallSubjectEvent");var r=this;return this.getCall(n).then(function(i){try{i.subject=n.find("subject").text(),i.subject&&r.sendCallUpdateEvent(i)}catch(n){var a="onCallSubjectEvent -- "+n.message;e.error("[TelephonyServiceEventHandler] "+a),t.reject(new Error(a))}})},h.prototype.computeCallRelevancy=function(t,n){var r=t.attr("newCallId"),i=r||t.attr("callId"),a=t.attr("deviceType"),s=o.getDeviceIdFromConnectionId(i),c=this.telephonyService.getNomadicObject(),l=c.makeCallInitiatorIsMain;a||(a="MAIN"),c.modeActivated||(l=!0),"MAIN"===a&&l&&(n.relevantEquipmentId=s,n.connectionId=i),"SECONDARY"!==a||l||(n.relevantEquipmentId=s,n.connectionId=i),n.isSecondary=a&&"SECONDARY"===a&&!l,e.info("[TelephonyServiceEventHandler] computeCallRelevancy -- relevantEquipmentId: "+n.relevantEquipmentId+" connectionId: "+n.connectionId+" isSecondary: "+n.isSecondary)},h.prototype.getCall=function(e,n){var r=this;return t(function(t){var i=e.attr("endpointIm"),a=e.attr("endpointTel"),o=e.attr("callId");r.getOrCreateCall(o,i,a,n).then(function(e){t(e)})})},h.prototype.getOrCreateCall=function(n,r,i,s){var c=this;if(s){var l=n;n=Object.keys(this.telephonyService.calls||[]).find(function(e){return c.telephonyService.calls[e].status!==o.Status.UNKNOWN&&o.getCallIdFromConnectionId(e)===o.getCallIdFromConnectionId(n)}),e.debug("[TelephonyServiceEventHandler] getOrCreateCall - search call with callId: "+o.getCallIdFromConnectionId(n)+" from connection id: "+l+" => found connectionId: "+n)}if(!n)return t.reject("no connection id");var d=this.telephonyService.calls[n];return d?(e.debug("[TelephonyServiceEventHandler] getOrCreateCall - "+n+" - "+u.anonymizePhoneNumber(i)+" - "+r+" => found call: "+d),t.when(d)):(e.debug("[TelephonyServiceEventHandler] getOrCreateCall - "+n+" - "+u.anonymizePhoneNumber(i)+" - "+r+" => not found : create call..."),t(function(e){r||i?a.getOrCreateContact(r,i).then(function(t){e(c.telephonyService.getOrCreateCall(o.Status.UNKNOWN,n,t))}):e(c.telephonyService.getOrCreateCall(o.Status.UNKNOWN,n))}))},h.prototype.createConferenceCall=function(e,t){var n=o.create(o.Status.UNKNOWN,null,o.Type.PHONE);return n.setConnectionId(e),n.isConference=!0,n.setParticipants(t),this.telephonyService.calls[n.id]=n,n},h.prototype.sendCallUpdateEvent=function(e,t){var r=this.extractInfoEvent(t);n.$broadcast("ON_CALL_UPDATED_EVENT",e,r)},h.prototype.extractInfoEvent=function(e){var t={actionElemName:"",cause:""};if(e&&null!==e){var n=e.prop("tagName").split(":");t.actionElemName=n[n.length-1].toLowerCase(),t.cause=e.attr("cause"),t.cause=t.cause?t.cause:""}else t=null;return t},h.prototype.analyzeContactChange=function(e,t,n){var r=!1,i=!1;return e||t?n.isConference?void 0:n.contact?(""===e?n.contact.temp?n.contact.id===t?n.contact.displayName===t&&(r=!1,i=!0):(r=!0,i=!0):""!==n.getCurrentCalled().contactPhoneNumber&&""!==t&&n.getCurrentCalled().contactPhoneNumber!==t&&(r=!0,i=!0):n.contact.id!==e&&(r=!0,i=!1),r||i?{updateContactToBeDone:r,searchOutlookToBeDone:i}:null):{updateContactToBeDone:!0,searchOutlookToBeDone:!0}:null},h.prototype.updateCallContact=function(n,r,i,o){var s=this,c=i.prop("tagName").split(":"),l=c[c.length-1].toLowerCase();try{var d=s.analyzeContactChange(n,r,o);return o.isConference||""===r||o.setCurrentCalledContactNumber(r),d?a.getOrCreateContact(n,r).then(function(n){return d.searchOutlookToBeDone?s.telephonyService.updateContactFromOutlookInfos(n,r).then(function(t){t?(e.debug("[TelephonyServiceEventHandler] on "+l+", update from outlook for contact :"+n.displayNameMD5),s.makeUpdateContact(o,n,r,l)):(e.debug("[TelephonyServiceEventHandler] on "+l+", no update from outlook for contact :"+n.displayNameMD5),d.updateContactToBeDone?(e.debug("[TelephonyServiceEventHandler] on "+l+", update contact :"+n.displayNameMD5),s.makeUpdateContact(o,n,r,l)):s.sendCallUpdateEvent(o,i))},function(){e.debug("[TelephonyServiceEventHandler] on "+l+", no Outlook search available"),d.updateContactToBeDone?(e.debug("[TelephonyServiceEventHandler] on "+l+", update contact :"+n.displayNameMD5),s.makeUpdateContact(o,n,r,l)):s.sendCallUpdateEvent(o,i)}):(e.debug("[TelephonyServiceEventHandler] on "+l+", update contact :"+n.displayNameMD5),s.makeUpdateContact(o,n,r,l),t.when())}):(s.sendCallUpdateEvent(o,i),t.when())}catch(n){var u="updateCallContact -- "+n.message;return e.error("[TelephonyServiceEventHandler] "+u),t.reject(new Error(u))}},h.prototype.makeUpdateContact=function(e,t,n,i){var a=this;e.setContact(t),e.setCurrentCalled({contactPhoneNumber:n,contact:t}),"delivered"===i&&e.status===o.Status.RINGING_INCOMMING?r(function(){a.sendCallUpdateEvent(e)},300,1):a.sendCallUpdateEvent(e)},h}])},function(){angular.module("rainbow").service("directoryService",["$q","$rootScope","$log","$http","$injector","contactService","authService","orderByFilter","conversationService",function(e,t,n,r,i,a,o,s,c){"use strict";var l=this;this.start=function(e){n.info(""),n.info("[directoryService] === STARTING ===");var t=performance.now();try{l.centralizedService=i.get("centralizedService")}catch(e){}var r=Math.round(performance.now()-t);e.push({service:"directoryService",startDuration:r}),n.info("[directoryService] === STARTED ("+r+" ms) ===")},this.stop=function(){n.info("[directoryService] Stopping"),n.info("[directoryService] Stopped")},this.search=function(i,l,d,u){return n.info("[directoryService] searchContact with text "+i),e(function(e,h){d||(d=20);var f=config.restServerUrl+"/api/rainbow/search/v1.0/users?limit="+d+"&displayName="+encodeURIComponent(i);u&&(f+="&companyId="+encodeURIComponent(u)),r({method:"GET",url:f,headers:o.getRequestHeader()}).then(function(t){var r=t.data.data;n.info("[directoryService] search find "+r.length+" contact(s)");var o=[];if(r.forEach(function(e){if(!a.isUserContactJid(e.jid_im)){var t;if(!(t=a.getContactByJid(e.jid_im)))(t=a.createBasicContact(e.jid_im)).updateFromUserData(e),t.getAvatar(),a.dbContacts[e.id]=t,a.jtelContacts[t.jidtel]=t;t.dbId=e.id,t.updateRichStatus(),c.computeCapabilitiesForContact(t,!1),o.push(t)}}),l){var d=a.searchContacts(i);o=o.concat(d.filter(function(e){return e.roster&&0>o.indexOf(e)}))}o=s(o,"_displayName",!1),e(o)},function(e){401===e.data.errorCode&&t.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT"),n.warn("[directoryService] searchContact failure "+e.data.errorMsg),h(new Error("Directory service failure"))})})},this.searchUserByLogin=function(i){n.info('[directoryService] searchUserByLogin with "'+i+'"');var s=e.defer(),c=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/enduser/v1.0/";return r({method:"POST",url:c+"users/loginEmails",headers:o.getPostHeader(),data:{loginEmail:[i]}}).then(function(e){var t=e.data.data;1===t.length?a.getOrCreateContact(t[0].jid_im).then(function(e){e.loginEmail=i,s.resolve(e)}).catch(function(){s.resolve(null)}):s.resolve(null)},function(e){401===e.data.errorCode&&t.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT"),n.warn('[directoryService] searchUserByLogin with "'+i+'" failure'),s.reject(new Error('Directory searchUserByLogin with "'+i+'" failure'))}),s.promise},this.searchUserByJid=function(i){n.info('[directoryService] searchUserByJid with "'+i+'"');var s=e.defer(),c=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/enduser/v1.0/users/jids/";return r({method:"GET",url:c+encodeURIComponent(i),headers:o.getRequestHeader()}).then(function(e){var t=e.data;t?a.getOrCreateContact(i).then(function(e){e.updateFromUserData(t.data),s.resolve(e)}).catch(function(){s.resolve(null)}):s.resolve(null)},function(e){401===e.data.errorCode&&t.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT"),n.warn('[directoryService] searchUserByJid with "'+i+'" failure'),s.reject(new Error('Directory searchUserByJid with "'+i+'" failure'))}),s.promise},this.searchOutlookUsersByName=function(t){return e(function(e){l.centralizedService?l.centralizedService.outlook.searchByNameWithAvatar(t,2).then(function(t){e(t)}).catch(function(){e([])}):e([])})},this.searchOutlookUsersByEmail=function(t){return e(function(e){l.centralizedService?l.centralizedService.outlook.searchByEmailWithAvatar(t,2).then(function(t){e(t)}).catch(function(){e([])}):e([])})},this.searchAllContacts=function(t,r,i,o,s){return n.info("[directoryService] searchAllContacts with text "+t),e(function(e){var n=[];r&&(n=a.searchContacts(t)),l.search(t,!1,o,s).then(function(r){n=n.concat(r.filter(function(e){return!e.roster||0>n.indexOf(e)})),i?l.searchOutlookUsersByEmail(t).then(function(r){var i=[];l.centralizedService&&(r&&r.length&&(i=l.centralizedService.outlook.mergeOutlookContact(i,r)),l.searchOutlookUsersByName(t).then(function(t){t&&t.length&&(i=l.centralizedService.outlook.mergeOutlookContact(i,t)),n=n.concat(i),e(n)}))}):e(n)})})}}])},function(){angular.module("rainbow").service("invitationService",["$q","$log","$http","$rootScope","authService","Invitation","contactService","xmppService","errorHelperService","settingsService",function(e,t,n,r,i,a,o,s,c,l){"use strict";var d=this;d.start=function(n){t.info(""),t.info("[invitationService] === STARTING ===");var i=performance.now();d.receivedInvitations={},d.sentInvitations={},d.acceptedInvitationsArray=[],d.sentInvitationsArray=[],d.receivedInvitationsArray=[],d.listeners=[],d.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/",d.attachHandlers(),d.getAllSentInvitations(),d.getAllReceivedInvitations();var a=Math.round(performance.now()-i);return n.push({service:"invitationService",startDuration:a}),t.info("[invitationService] === STARTED ("+a+" ms) ==="),d.listeners.push(r.$on("ON_ROSTER_CHANGED_EVENT",d.getAllSentInvitations)),e.when()},d.stop=function(){var n;if(t.info(""),t.info("[invitationService] === STOPPING ==="),d.listeners)for(;n=d.listeners.pop();)n();return t.info("[invitationService] === STOPPED ==="),e.when()},d.attachHandlers=function(){t.info("[invitationService] attachHandlers"),d.contactConfigRef&&(s.connection.deleteHandler(d.contactConfigRef),d.contactConfigRef=null),d.contactConfigRef=s.connection.addHandler(d.onInvitationsUpdate,null,"message","management")},d.onInvitationsUpdate=function(e){var n=$(e).find("userinvite");if(n.length){var r=n.attr("id"),i=n.attr("type"),a=n.attr("action");switch(i){case"received":d.handleReceivedInvitation(r,a);break;case"sent":d.handleSentInvitation(r,a);break;default:t.warn("[invitationService] onInvitationsUpdate - received unexpected type - "+i)}}return!0},d.handleReceivedInvitation=function(e,n){t.info("[invitationService] handleReceivedInvitation"),"delete"===n?(delete d.receivedInvitations[e],d.updateReceivedInvitationsArray()):d.getServerInvitation(e).then(function(e){var t=null,n="none";switch(e.status){case"pending":d.receivedInvitations[e.id]=e,t=e,n="ask";break;case"accepted":case"auto-accepted":d.receivedInvitations[e.id]=e,r.$broadcast("ON_INVITATION_ACCEPTED",e.invitingUserId);break;default:delete d.receivedInvitations[e.id],n="unknown"}e.invitingUserId?d.updateContactInvitationStatus(e.invitingUserId,n,t).then(function(){d.updateReceivedInvitationsArray()}):d.updateReceivedInvitationsArray(),r.$broadcast("ON_INVITATION_CHANGED",e)})},d.handleSentInvitation=function(n,i){return e(function(e){t.info("[invitationService] handleSentInvitation"),"delete"===i?(delete d.sentInvitations[n],d.updateReceivedInvitationsArray(),e()):(d.getServerInvitation(n).then(function(t){var n=null;switch(t.status){case"pending":d.sentInvitations[t.id]=t,n="wait";break;case"accepted":case"auto-accepted":r.$broadcast("ON_INVITATION_ACCEPTED",t.invitedUserId);break;default:delete d.sentInvitations[t.id],n="unknown"}t.invitedUserId?d.updateContactInvitationStatus(t.invitedUserId,n,t).then(function(){d.updateSentInvitationsArray(),e()}):(d.updateSentInvitationsArray(),e())}),"resend"==i&&r.$broadcast("ON_INVITATIONS_RE_SEND",n))})},d.updateReceivedInvitationsArray=function(){for(var e in d.receivedInvitationsArray=[],d.acceptedInvitationsArray=[],d.receivedInvitations)if(d.receivedInvitations.hasOwnProperty(e)){var t=d.receivedInvitations[e];switch(t.status){case"pending":d.receivedInvitationsArray.push(t);break;case"accepted":case"auto-accepted":d.acceptedInvitationsArray.push(t)}}d.receivedInvitationsArray.sort(d.sortInvitationArray),d.acceptedInvitationsArray=d.acceptedInvitationsArray.filter(function(e){var t=moment(e.lastNotificationDate);return 168>moment.duration(moment().diff(t)).asHours()}),d.acceptedInvitationsArray.sort(d.sortInvitationArray),r.$broadcast("ON_INVITATIONS_NUMBER_UPDATED")},d.updateSentInvitationsArray=function(){for(var e in d.sentInvitationsArray=[],d.sentInvitations)d.sentInvitations.hasOwnProperty(e)&&d.sentInvitationsArray.push(d.sentInvitations[e]);d.sentInvitationsArray.sort(d.sortInvitationArray),r.$broadcast("ON_INVITATIONS_NUMBER_UPDATED")},d.getServerInvitation=function(r){return e(function(e,s){n({method:"GET",url:d.portalURL+o.userContact.dbId+"/invitations/"+r,headers:i.getRequestHeader()}).then(function(n){t.info("[invitationService] getServerInvitation success");var r=a.createFromData(n.data.data);e(r)},function(e){var n=c.handleError(e);s(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"getServerInvitation"))})})},d.getReceivedInvitations=function(){return d.receivedInvitationsArray},d.getAcceptedInvitations=function(){return d.acceptedInvitationsArray},d.getSentInvitations=function(){return d.sentInvitationsArray},d.getInvitationsNumberForCounter=function(){return d.receivedInvitationsArray.length},d.getAllInvitationsNumber=function(){return d.receivedInvitationsArray.length+d.sentInvitationsArray.length+d.acceptedInvitationsArray.length},d.getInvitation=function(e){var t=d.receivedInvitations[e];return t||(t=d.acceptedInvitationsArray[e]),t||(t=d.sentInvitations[e]),t},d.joinContactInvitation=function(r){return e(function(e,a){t.info("[invitationService] joinContactInvitation contact ("+r.jid+")"),n({method:"POST",url:d.portalURL+o.userContact.dbId+"/invitations",headers:i.getRequestHeader(),data:{invitedUserId:r.dbId}}).then(function(){t.info("[invitationService] joinContactInvitation - success ("+r.jid+")"),"unknown"===r.status&&d.updateContactInvitationStatus(r.dbId,"wait"),e()},function(e){var n=c.handleError(e);a(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"joinContactInvitation"))})})},d.sendInvitationByEmail=function(r,a){return e(function(e,o){var s=l.getAppliLanguageCodeForServer();t.info("[invitationService] sendInvitationByEmail"),n({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/notifications/emails/invite-by-end-user",headers:i.getRequestHeader(),data:{email:r,lang:s,customMessage:a}}).then(function(){t.info("[invitationService] sendInvitationByEmail - success"),e()},function(e){var n=c.handleError(e);o(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"sendInvitationByEmail"))})})},d.cancelOneSendInvitation=function(r){return e(function(e,a){n({method:"POST",url:d.portalURL+r.invitingUserId+"/invitations/"+r.id+"/cancel",headers:i.getRequestHeader()}).then(function(){t.info("[invitationService] cancelOneSendInvitation success"),e()},function(e){var n=c.handleError(e);a(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"cancelOneSendInvitation"))})})},d.reSendInvitation=function(r){return e(function(e,a){n({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+o.userContact.dbId+"/invitations/"+r+"/re-send",headers:i.getRequestHeader()}).then(function(){t.info("[invitationService] reSendInvitation "+r+" - success"),e()},function(e){var n=c.handleError(e);a(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"reSendInvitation"))})})},d.sendInvitationsParBulk=function(r){return!r.length||100<r.length?(t.error("[invitationService] sendInvitationsParBulk mail list length not correct"),e.reject()):e(function(e,a){n({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+o.userContact.dbId+"/invitations/bulk",headers:i.getRequestHeader(),data:{emails:r}}).then(function(){t.info("[invitationService] sendInvitationsParBulk - success"),e()},function(e){var n=c.handleError(e);a(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"sendInvitationsParBulk"))})})},d.acceptInvitation=function(r){return e(function(e,a){n({method:"POST",url:d.portalURL+r.invitedUserId+"/invitations/"+r.id+"/accept",headers:i.getRequestHeader()}).then(function(){t.info("[invitationService] acceptInvitation success"),e()},function(e){var n=c.handleError(e);a(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"acceptInvitation"))})})},d.declineInvitation=function(r){return e(function(e,a){n({method:"POST",url:d.portalURL+r.invitedUserId+"/invitations/"+r.id+"/decline",headers:i.getRequestHeader()}).then(function(){t.info("[invitationService] declineInvitation success"),e()},function(e){var n=c.handleError(e);a(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"declineInvitation"))})})},d.updateContactInvitationStatus=function(t,n,r){return e(function(e){o.getContactByDBId(t).then(function(t){switch(n){case"ask":t.status="unknown",t.ask="ask",t.invitation=r;break;case"wait":t.status="wait",t.ask="subscribe",t.invitation=r;break;default:t.ask="none",t.invitation=null}t.updateRichStatus(),e()})})},d.sortInvitationArray=function(e,t){return new Date(t.lastNotificationDate)-new Date(e.lastNotificationDate)},d.getAllReceivedInvitations=function(){return e(function(e,r){n({method:"GET",url:d.portalURL+o.userContact.dbId+"/invitations/received?format=full&status=pending&status=accepted&status=auto-accepted&limit=500",headers:i.getRequestHeader()}).then(function(n){var r=n.data.data;t.info("[invitationService] getAllReceivedInvitations success (find "+r.length+" invitations)"),d.receivedInvitations={},d.acceptedInvitations={},r.forEach(function(e){if("pending"===e.status&&"registration"!==e.type){var t=a.createFromData(e);d.receivedInvitations[e.id]=t,e.invitingUserId&&d.updateContactInvitationStatus(e.invitingUserId,"ask",t)}else("accepted"===e.status||"auto-accepted"===e.status)&&(d.receivedInvitations[e.id]=a.createFromData(e))}),d.updateReceivedInvitationsArray(),e(d.receivedInvitations)},function(e){var n=c.handleError(e);r(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"getAllReceivedInvitations"))})})},d.getAllSentInvitations=function(){return e(function(e,r){n({method:"GET",url:d.portalURL+o.userContact.dbId+"/invitations/sent?format=full&status=pending&limit=500",headers:i.getRequestHeader()}).then(function(n){var r=n.data.data;t.info("[invitationService] getAllSentInvitations success (find "+r.length+" invitations)"),d.sentInvitations={},r.forEach(function(e){if("pending"===e.status&&!e.inviteToJoinMeeting){var t=a.createFromData(e);d.sentInvitations[e.id]=t,void 0!==t.invitedUserId&&d.updateContactInvitationStatus(t.invitedUserId,"wait",t)}}),d.updateSentInvitationsArray(),e(d.sentInvitations)},function(e){var n=c.handleError(e);r(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"getAllSentInvitations"))})})}}])},function(e,t,n){"use strict";var r=Math.round;n.r(t);var i=n(1);n.n(i);angular.module("rainbow").service("roomService",["$q","$log","$rootScope","$http","$filter","$interval","authService","contactService","fileStorageService","xmppService","Room","utilService","profileService","errorHelperService","helpersService","orderByFilter","$translate",function(e,t,n,a,o,s,c,l,d,u,h,f,p,m,v,g,C){var S=this;S.ROOM_UPDATE_EVENT="ROOM_UPDATE_EVENT",S.ROOM_AVATAR_UPDATE_EVENT="ROOM_AVATAR_UPDATE_EVENT",S.ROOM_HISTORY_UPDATE_EVENT="ROOM_HISTORY_UPDATE_EVENT",S.ROOM_ADMIN_MESSAGE_EVENT="ROOM_ADMIN_MESSAGE_EVENT",S.ROOM_INVITATION="ROOM_INVITATION",S.ROOM_ADD_CONF_ENDPOINT_EVENT="ROOM_ADD_CONF_ENDPOINT_EVENT",S.ROOM_REMOVE_CONF_ENDPOINT_EVENT="ROOM_REMOVE_CONF_ENDPOINT_EVENT",S.ROOM_ADD_USERS_EVENT="ROOM_ADD_USERS_EVENT",S.ROOM_DELETE_USERS_EVENT="ROOM_DELETE_USERS_EVENT",S.ROOM_ADD_CONF_GUESTS_EVENT="ROOM_ADD_CONF_GUESTS_EVENT",S.ROOM_DELETE_CONF_GUESTS_EVENT="ROOM_DELETE_CONF_GUESTS_EVENT",S.ON_OPEN_INVITE_ROOM_ID_UPDATED_EVENT="ON_OPEN_INVITE_ROOM_ID_UPDATED_EVENT",S.RoomUserStatus={INVITED:"invited",ACCEPTED:"accepted",UNSUBSCRIBED:"unsubscribed",REJECTED:"rejected",DELETED:"deleted"},S.listeners=[],S.start=function(n){return e(function(e){var i=performance.now();t.info(""),t.info("[roomService] === STARTING ==="),S.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/",S.invitationCounter=0,S.meetingInvitationCounter=0,S.rooms={},S.roomsByJids={},S.roomsInProgress={},S.contactsInProgress={},S.updateLater={},S.maxRoomsUsers=p.getFeatureLimitMax(p.FeaturesEnum.BUBBLE_PARTICIPANT_COUNT),S.openInviteRoomId="",S.attachHandlers(),S.getServerRooms().then(function(){S.computeInvitationCounter();var a=r(performance.now()-i);n.push({service:"roomService",startDuration:a}),t.info("[roomService] === STARTED ("+a+" ms) ==="),e()}).catch(function(n){t.error("[roomService] === STARTING FAILURE === "+n.message),S.computeInvitationCounter(),S.reconnect(),e()})})},S.stop=function(){return t.info(""),t.info("[roomService] === STOPPING ==="),S.listeners.forEach(function(e){e()}),S.rooms={},S.roomsByJids={},t.info("[roomService] === STOPPED ==="),e.when()},S.attachHandlers=function(){t.info("[roomService] attachHandlers"),this.roomPresenceRef&&(u.connection.deleteHandler(this.roomPresenceRef),this.roomPresenceRef=null),this.roomPresenceRef=u.connection.addHandler(S.onRoomPresence,"http://jabber.org/protocol/muc#user","presence"),this.roomMessageRef&&(u.connection.deleteHandler(this.roomMessageRef),this.roomMessageRef=null),this.roomMessageRef=u.connection.addHandler(S.onRoomMessage,"jabber:x:conference","message"),this.roomInfoMessageRef&&(u.connection.deleteHandler(this.roomInfoMessageRef),this.roomInfoMessageRef=null),this.roomInfoMessageRef=u.connection.addHandler(S.onRoomInfoMessage,null,"message","groupchat"),this.roomMessageConfigRef&&(u.connection.deleteHandler(this.roomMessageConfigRef),this.roomMessageConfigRef=null),this.roomMessageConfigRef=u.connection.addHandler(S.onRoomMessageConfig,null,"message","management"),this.roomHistoryInfoRef&&(u.connection.deleteHandler(this.roomHistoryInfoRef),this.roomHistoryInfoRef=null),this.roomHistoryInfoRef=u.connection.addHandler(S.onRoomHistoryInfoMessage,"jabber:iq:notification","message"),this.roomNotificationRef&&(u.connection.deleteHandler(this.roomNotificationRef),this.roomNotificationRef=null),this.roomNotificationRef=u.connection.addHandler(S.onRoomNotificationMessage,"jabber:x:bubble:conference","message"),S.listeners.push(n.$on("ON_CONNECTION_STATE_CHANGE_EVENT",S.onConnectionStateChange))},S.reconnect=function(){t.info("[roomService] reconnect"),S.attachHandlers(),S.getServerRooms().then(function(){S.computeInvitationCounter(),t.info("[roomService] reconnect success")}).catch(function(e){t.error("[roomService] reconnect failure -- "+e.message)})},S.onConnectionStateChange=function(e,n){t.info("[roomService] onConnectionStateChange status:"+n),"disconnected"===n&&S.rooms&&Object.keys(S.rooms).forEach(function(e){var n=S.rooms[e];n&&(n.initPresInterval&&(t.info("[roomService] onConnectionStateChange cancel initPresence retryer for room: "+n.jid+" "+n.getNameForLogs()),s.cancel(n.initPresInterval),n.initPresInterval=null),n.initPresPromise&&(t.info("[roomService] onConnectionStateChange remove initPresPromise for room: "+n.jid+" "+n.getNameForLogs()),n.initPresPromise=null))})},S.getRooms=function(){var e=[];return Object.keys(S.rooms).forEach(function(t){e.push(S.rooms[t])}),e},S.searchRooms=function(e){var t=e.toLowerCase().trim().split(/[ ]+/);return S.getRooms().filter(function(e){if("accepted"!==e.status)return!1;var n=e.name.toLowerCase().trim().split(/[ -]+/);return t.every(function(t){return n.some(function(r,i){return!(!r.length||0!==f.removeDiacritis(r).indexOf(f.removeDiacritis(t))||(n[i]="",e.filterName=f.removeDiacritis(e.name),0))})})})},S.getMyRooms=function(){return S.getRooms().filter(function(e){return e.owner})},S.getRoomById=function(e){return S.rooms[e]},S.getRoomByJid=function(e){return S.roomsByJids[e]},S.computeInvitationCounter=function(){S.invitationCounter=0,S.meetingInvitationCounter=0,Object.keys(S.rooms).forEach(function(e){var t=S.rooms[e];"invited"===t.status&&(t.isMeetingRoom()&&p.isFeatureEnabled("CONFERENCE_PARTICIPANT_ALLOWED")?S.meetingInvitationCounter+=1:S.invitationCounter+=1)})},S.getOrderedRooms=function(e){return"creationDate"===e?g(S.getRooms(),S.getCreationDate,!0,S.sortByDate):g(S.getRooms(),S.getName,!1,S.sortByName)},S.getMyOrderedRooms=function(e){return"creationDate"===e?g(S.getMyRooms(),S.getCreationDate,!0,S.sortByDate):g(S.getMyRooms(),S.getName,!1,S.sortByName)},S.getServerRoom=function(n){return e(function(e,r){t.info("[roomService] getServerRoom("+n+")"),a({method:"GET",url:S.portalURL+"rooms/"+n+"?format=full",headers:c.getRequestHeader()}).then(function(e){var r=e.data.data;return t.info("[roomService] getServerRoom("+n+") successfully"),S.getAllRoomsParticipants([r])}).then(function(t){var n=S.createRoomFromData(t[0]);e(n)},function(e){var i=e.data?e.data.errorDetails:e.data,a="getServerRoom("+n+") failure: "+i;t.error("[roomService] "+a),r(new Error(a))})})},S.getServerRooms=function(){var n=function(n,r,i){return e(function(e,o){a({method:"GET",headers:c.getRequestHeader(),url:S.portalURL+"rooms?format=full&userId="+l.userContact.dbId+"&status=invited&status=accepted&status=unsubscribed&offset="+n+"&limit="+r}).then(function(n){i=i.concat(n.data.data),t.info("[roomService] getServerRooms retrieved "+n.data.data.length+" rooms, total "+i.length+", existing "+n.data.total),e({rooms:i,finished:i.length===n.data.total})}).catch(function(e){o(e)})})},r=function r(i,a,o){return e(function(e,s){n(i,a,o).then(function(n){n.finished?(t.info("[roomService] getServerRooms no need to loop again. All rooms retrieved..."),e(n.rooms)):(i+=a,t.info("[roomService] getServerRooms need another loop to get more rooms... ["+n.rooms.length+"]"),r(i,a,n.rooms).then(function(t){e(t)}).catch(function(e){s(e)}))}).catch(function(e){s(e)})})};return e(function(e,n){r(0,1e3,[]).then(function(e){var n=e;return t.info("[roomService] getServerRooms successfully: find "+n.length+" room(s)"),S.getAllRoomsParticipants(n)}).then(function(t){t.forEach(function(e){S.createRoomFromData(e)}),e()}).catch(function(e){var r="getServerRooms failure: "+(e.data?e.data.errorDetails:e.message);t.error("[roomService] "+r),n(new Error(r))})})},S.getAllRoomsParticipants=function(n){var i=e.defer(),o=function(n,r,i,o){return e(function(e,s){a({method:"GET",headers:c.getRequestHeader(),url:S.portalURL+"rooms/"+n.id+"/users?format=full&offset="+r+"&limit="+i}).then(function(n){o=o.concat(n.data.data),t.info("[roomService] getAllRoomsParticipants retrieved "+n.data.data.length+" users, total "+o.length+", existing "+n.data.total),e({users:o,finished:o.length===n.data.total})}).catch(function(e){s(e)})})},s=function n(r,a,s,c){return e(function(e,l){o(r,a,s,c).then(function(i){i.finished?(t.info("[roomService] getAllRoomsParticipants no need to loop again. All users retrieved..."),e(i.users)):(a+=s,t.info("[roomService] getAllRoomsParticipants need another loop to get more users... ["+i.users.length+"]"),n(r,a,s,i.users).then(function(t){e(t)}).catch(function(e){l(e)}))}).catch(function(e){i.reject(e)})})},d=performance.now(),u={},h=[];return n.forEach(function(t){var n=e.defer();return h.push(n),t.activeUsersCounter&&t.users.length<t.activeUsersCounter?s(t,0,100,[]).then(function(e){t.users=e,n.resolve(t)}).catch(function(e){reject(e)}):n.resolve(t),n.promise.then(function(e){e.users.forEach(function(e){var t=l.getContactByJid(e.jid_im);u[e.jid_im]||t&&!t.temp||(u[e.jid_im]=e.jid_im)})})}),e.all(h).then(function(){var e=Object.keys(u);return e.length?l.getContactsByJids(e).then(function(){var a=performance.now();t.info("[roomService] getAllRoomsParticipants - get "+e.length+" participants in "+r(a-d)+" milliseconds."),i.resolve(n)}):(t.info("[roomService] getAllRoomsParticipants - nothing to get, all known."),void i.resolve(n))}),i.promise},S.createRoomFromData=function(e){var r=h.create(e.id,e.jid,e.name,e.topic,e.creationDate,e.confEndpoints,e.history,e.customData,e.conference,e.avatar,e.isActive),a=l.dbContacts[e.creator];if(!a)return t.error("[roomService] createRoomFromData -- failure -- Impossible to find owner of room "+e.name+" --- ignored"),r;r.ownerContact=a,r.owner=a.jid===l.userContact.jid,e.users.forEach(function(e){var t=l.getContactById(e.userId);t&&(r.users.push({contact:t,status:e.status,date:new Date(e.additionDate),privilege:e.privilege}),l.isUserContact(t)&&(r.status=e.status))}),r.guestEmails=e.guestEmails,S.refreshMemberAndOrganizerLists(r);var o=r.getUserByJid(l.userContact.jid);if(r.isModerator=o&&o.status!==S.RoomUserStatus.UNSUBSCRIBED&&r.isUserModerator(l.userContact),S.rooms[r.dbId]&&S.rooms[r.dbId].initPresPromise&&(r.initPresPromise=S.rooms[r.dbId].initPresPromise),r.updateAvatarInfo(),e.lastAvatarUpdateDate){var s=config.restServerUrl;n.cdn&&(s=n.cdnServer),r.avatar=s+"/api/room-avatar/"+e.id+"?size=512&update="+Object(i.MD5)(i.enc.Latin1.parse(e.lastAvatarUpdateDate)).toString(i.enc.Hex)}return S.rooms[r.dbId]=r,S.roomsByJids[r.jid]=r,n.$broadcast(S.ROOM_UPDATE_EVENT,r),"accepted"===r.status&&r.isActive&&S.sendInitialRoomPresenceSync(r),r},S.refreshMemberAndOrganizerLists=function(e){e.organizers=[],e.members=[],e.users.forEach(function(t){(t.status===S.RoomUserStatus.ACCEPTED||t.status===S.RoomUserStatus.INVITED||t.contact.jid===e.ownerContact.jid)&&(t.privilege===h.Privilege.MODERATOR?e.organizers.push(t):e.members.push(t))})},S.equalContactsArrayByDbId=function(e,t){if(e===t)return!0;if(null===e||null===t)return!1;if(e.length!==t.length)return!1;for(var n=0;n<e.length;++n)if(e[n].dbId!==t[n].dbId)return!1;return!0},S.getOrCreateRoomWithContacts=function(n,r){return e(function(e){var i=null,a=[].concat([l.userContact],n).sort(S.sortObjectByProperty("dbId"));if(S.getMyRooms().some(function(e){return!(!e||e.status!==S.RoomUserStatus.ACCEPTED||!S.equalContactsArrayByDbId(e.users.map(function(e){return e.contact}).sort(S.sortObjectByProperty("dbId")),a)||(i=e,t.debug("[roomService] getOrCreateRoomWithContacts - Found Room "+e.getNameForLogs()),0))}),i)r.length?S.addRoomUsers(i,null,r).then(function(){e(i)}):e(i);else{for(var s,c=l.userContact.initials+" "+o("translate")("bubble")+" ",d=S.getMyRooms().filter(function(e){return e&&0===e.name.indexOf(c)}),u=function(e){return e&&e.name===s},h=null,f=1;!h;)s=c+f.toString(),d.sort(S.sortObjectByProperty("name")).some(u)||(h=s),f++;S.createRoomWithContacts(h,"",n,r).then(function(t){e(t)})}})},S.createRoomWithContacts=function(n,r,i,a){return e(function(e,o){S.createRoom(n,r,!0).then(function(e){return S.addRoomUsers(e,i,a)}).then(function(t){e(t)}).catch(function(e){var n="createRoomWithContacts failure: "+e.message;t.error("[roomService] "+n),o(new Error(n))})})},S.setAvatarRoom=function(r,i){var o=e.defer();return i?(S.resizeImage(i,512,512).then(function(e){var i=S.getBinaryData(e);a({method:"POST",url:S.portalURL+"rooms/"+r.id+"/avatar",headers:c.getPostHeader("image/"+i.type),data:i.data,transformRequest:[]}).then(function(e){t.info("[roomService] setAvatarRoom success: "+e.data.status);var i=config.restServerUrl;n.cdn&&(i=n.cdnServer),r.avatar=i+"/api/room-avatar/"+r.id+"?size=512&rand="+v.randomString(),o.resolve(r)},function(e){var n=m.handleError(e);t.error("[roomService] "+m.getErrorFullMessage(e,"setAvatarRoom")),o.reject(n)})}),o.promise):(o.resolve(r),o.promise)},S.deleteAvatarRoom=function(n){return e(function(e,r){a({method:"DELETE",url:S.portalURL+"rooms/"+n+"/avatar",headers:c.getRequestHeader()}).then(function(){t.info("[roomService] avatar room sucessfully deleted"),e()}).catch(function(e){r(e)})})},S.resizeImage=function(t,n,r){var i=e.defer(),a=new Image;return a.src=t,a.onload=function(){var e=a.width,t=a.height;e>t?e>n&&(t*=n/e,e=n):t>r&&(e*=r/t,t=r);var o=document.createElement("canvas");o.width=e,o.height=t,a.width=e,a.height=t,o.getContext("2d").drawImage(this,0,0,e,t);var s=new Image;s.src=o.toDataURL("image/png"),i.resolve(s)},i.promise},S.getBinaryData=function(e){for(var t=e.src.indexOf("image/")+6,n=e.src.indexOf(";base64,"),r=e.src.slice(n+8),i=e.src.slice(t,n),a=window.atob(r),o=a.length,s=new Uint8Array(o),c=0;c<o;c++)s[c]=a.charCodeAt(c);return{type:i,data:s}},S.pushContactInRoom=function(n,r){return e(function(e){l.getContactByDBId(n.userId).then(function(i){r.users.push({contact:i,status:n.status,date:new Date(n.additionDate),privilege:n.privilege}),l.isUserContact(i)&&(r.status=n.status),t.info("[roomService] pushContactInRoom success"),e()}).catch(function(n){t.info("[roomService] pushContactInRoom failure : "+n.message),e()})})},S.addRoomUser=function(r,i,o,s,l){return e(function(e,d){if(r.users.some(function(e){return!(e.status!==S.RoomUserStatus.INVITED&&e.status!==S.RoomUserStatus.ACCEPTED&&e.status!==S.RoomUserStatus.REJECTED||e.contact.dbId!==i.dbId)}))return t.debug("[roomService] user: "+i.dbId+" already invited or accepted, will not be added"),void e(r);if(r.users.filter(function(e){return e.status!==S.RoomUserStatus.DELETED}).length>=S.maxRoomsUsers){var u=new Error("addRoomUser failure - Not Allowed : Participants max limit has been reached: "+S.maxRoomsUsers);return u.status=u.errorDetailsCode="403",t.error("[roomService] "+u.message),void d(u)}var f=S.RoomUserStatus.INVITED;"boolean"==typeof l&&l&&(f=S.RoomUserStatus.ACCEPTED);var p=o||"JustForFun",m=s||h.Privilege.USER;a({method:"POST",url:S.portalURL+"rooms/"+r.dbId+"/users",headers:c.getPostHeader(),data:{userId:i.dbId,privilege:m,reason:p,status:f}}).then(function(a){t.info("[roomService] addRoomUser "+i.displayNameForLog()+" to room "+r.dbId+"("+r.getNameForLogs()+") success");var o=a.data.data,s=r.getUserByJid(o.jid_im);s?(s.status=o.status,s.date=new Date,s.privilege=o.privilege):r.users.push({contact:i,status:f,date:new Date,privilege:m}),S.refreshMemberAndOrganizerLists(r),n.$broadcast(S.ROOM_UPDATE_EVENT,r),e(r)},function(e){var n="addRoomUser "+i.displayNameForLog()+" to room "+r.dbId+"("+r.getNameForLogs()+") failure: "+e.data.errorDetails;t.error("[roomService] "+n),d(new Error(n))})})},S.addRoomUsers=function(r,i,a){return e(function(o,s){var c=[];i.forEach(function(e){r.users.some(function(t){if(t.contact.dbId===e.dbId){switch(t.status){case S.RoomUserStatus.UNSUBSCRIBED:c.push(S.ownerReinviteRejectedUser(r,e));break;case S.RoomUserStatus.DELETED:c.push(S.ownerReinviteDeletedUser(r,e));break;case S.RoomUserStatus.REJECTED:c.push(S.ownerReinviteRejectedUser(r,e))}return!0}return!1})||c.push(S.addRoomUser(r,e))}),e.all(c).then(function(){t.info("[roomService] addRoomUsers success"),n.$broadcast(S.ROOM_ADD_USERS_EVENT,r),o(r)}).then(function(){S.inviteGuestEmailToJoinRoom(r,a)}).catch(function(e){var n="addRoomUsers failure: "+e.message;t.error("[roomService] "+n),s(new Error(n))})})},S.deleteRoomUsers=function(r,i){return e(function(a,o){var s=[];i.forEach(function(e){r.users.some(function(t){return!(t.contact.dbId!==e.dbId)})&&s.push(S.ownerDeletesUserFromRoom(r,e))}),e.all(s).then(function(){t.info("[roomService] deleteRoomUsers success"),n.$broadcast(S.ROOM_DELETE_USERS_EVENT,r),a(r)}).catch(function(e){var n="deleteRoomUsers failure: "+e.message;t.error("[roomService] "+n),o(new Error(n))})})},S.sendInitialRoomPresence=function(e,n){var r=n?" -- attempt "+n:"";t.info("[roomService] sendInitialRoomPresence "+r+" -- "+e.getNameForLogs()+" -- "+e.dbId);var i=$pres({to:e.jid+"/"+u.fullJid});i.c("x",{xmlns:"http://jabber.org/protocol/muc"}).c("history",{maxchars:"0"}),u.send(i)},S.sendInitialRoomPresenceSync=function(n){if(n.initPresPromise)return n.initPresPromise.promise;var r=n.initPresPromise=e.defer();S.sendInitialRoomPresence(n,"0");var i=0;return n.initPresInterval=s(function(){i<5?S.sendInitialRoomPresence(n,++i):(t.error("[roomService] sendInitialRoomPresenceSync : no response after "+i+" retries => clean presence promise and interval for "+n.getNameForLogs()+" -- "+n.jid),n.initPresPromise=null)},5e3,6),r.promise},S.sendPresenceWithResponseWait=function(t){if(t.initPresPromiseReceived)return S.sendInitialRoomPresence(t),e.when(t);var n=t.initPresPromise=e.defer();return S.sendInitialRoomPresence(t),n.promise},S.sendUnavailableRoomPresence=function(e){var t=$pres({to:e.jid+"/"+l.userContact.jid,type:"unavailable"});t.c("x",{xmlns:"http://jabber.org/protocol/muc"}),u.send(t)},S.createRoom=function(n,r,i,o,s,d){var u=n.charAt(0)+"***"+n.slice(-1);return t.info('[roomService] createRoom "'+u+'"'),e(function(e,f){(void 0===s||s&&"boolean"!=typeof s)&&(s=!0);var p={name:n,topic:r,history:i?"all":"none",disableNotifications:s};d&&(p.mediaType=d),a({method:"POST",url:S.portalURL+"rooms/",headers:c.getPostHeader(),data:p}).then(function(e){var t=e.data.data;return S.setAvatarRoom(t,o)}).then(function(n){S.rooms[n.id]&&(t.info('[roomService] createRoom -- room "'+u+'" already exists'),e(S.rooms[n.id]));var r=h.create(n.id,n.jid,n.name,n.topic,n.creationDate,n.confEndpoints,n.history,n.customData,n.conference,n.avatar,n.isActive);r.ownerContact=l.userContact,r.owner=!0,r.isModerator=!0,r.status="accepted",S.rooms[r.dbId]=r,S.roomsByJids[r.jid]=r,t.info('[roomService] createRoom "'+u+'" -- success'),e(S.sendInitialRoomPresenceSync(r))}).catch(function(e){var n=e;e&&e.data&&(n=e.data.errorDetailsCode+" "+e.data.errorDetails),t.error('[roomService] createRoom "'+u+'" -- failure : '+n),f(e)})})},S.updateRoomUser=function(r,i,o,s){var l={};return o&&(l.status=o),s&&(l.privilege=s),e(function(e,o){a({method:"PUT",url:S.portalURL+"rooms/"+r.dbId+"/users/"+i.dbId,headers:c.getPostHeader(),data:l}).then(function(a){t.info("[roomService] updateRoomUser "+i.displayNameForLog()+" to room "+r.dbId+"("+r.getNameForLogs()+") success");var o=a.data.data;r.users.forEach(function(e){e.contact.jid===o.jid_im&&(e.privilege=o.privilege,e.status=o.status)}),S.refreshMemberAndOrganizerLists(r),n.$broadcast(S.ROOM_UPDATE_EVENT,r),e(r)},function(e){var n="updateRoomUser "+i.displayNameForLog()+" to room "+r.dbId+"("+r.getNameForLogs()+") failure: "+e.data.errorDetails;t.error("[roomService] "+n),o(new Error(n))})})},S.ownerArchiveRoom=function(n){return t.info("[roomService] ownerArchiveRoom"),e(function(r,i){var a=[];n.users.forEach(function(e){l.isUserContact(e.contact)||e.status===S.RoomUserStatus.DELETED||e.status===S.RoomUserStatus.REJECTED||a.push(S.unsubscribeUserFromRoom(n,e.contact))}),e.all(a).then(function(){t.info("[roomService] unsubscribe all other users successfully"),S.unsubscribeMeFromRoom(n).then(function(){t.info("[roomService] ownerArchiveRoom successfully"),r(n)})}).catch(function(e){var n="ownerArchiveRoom failure: "+e.message;t.error("[roomService] "+n),i(new Error(n))})})},S.unsubscribeUserFromRoom=function(e,t){return S.updateRoomUser(e,t,S.RoomUserStatus.UNSUBSCRIBED)},S.ownerDeletesUserFromRoom=function(r,i){return t.info("[roomService] ownerDeletesUserFromRoom"),e(function(e,o){var s=i.dbId;a({method:"DELETE",url:S.portalURL+"rooms/"+r.dbId+"/users/"+s,headers:c.getRequestHeader()}).then(function(){t.info("[roomService] ownerDeletesUserFromRoom "+s+" from room "+r.dbId+"("+r.getNameForLogs()+") success"),n.$broadcast(S.ROOM_UPDATE_EVENT,r),e(r)},function(e){var n="ownerDeletesUserFromRoom "+s+" from room "+r.dbId+"("+r.getNameForLogs()+") failure: "+e.data.errorDetails;t.error("[roomService] "+n),o(new Error(n))})})},S.ownerReinviteRejectedUser=function(n,r,i,a,o){return e(function(e,s){S.ownerDeletesUserFromRoom(n,r).then(function(){S.addRoomUser(n,r,i,a,o).then(function(){t.info("[roomService] ownerReinviteRejectedUser "+r.dbId+" from room "+n.dbId+"("+n.getNameForLogs()+") success"),e(n)})}).catch(function(e){var n="ownerReinviteRejectedUser failure: "+e.message;t.error("[roomService] "+n),s(new Error(n))})})},S.ownerReinviteDeletedUser=function(n,r,i,a,o){return e(function(e,s){S.addRoomUser(n,r,i,a,o).then(function(){t.info("[roomService] ownerReinviteDeletedUser "+r.dbId+" from room "+n.dbId+"("+n.getNameForLogs()+") success"),e(n)}).catch(function(e){var n="ownerReinviteDeletedUser failure: "+e.message;t.error("[roomService] "+n),s(new Error(n))})})},S.ownerDeleteRoom=function(r){return e(function(e,i){var o=r.dbId;return o?void a({method:"DELETE",url:S.portalURL+"rooms/"+o,headers:c.getRequestHeader()}).then(function(){t.info("[roomService] ownerDeleteRoom "+r.dbId+"("+r.getNameForLogs()+") success"),delete S.rooms[r.dbId],n.$broadcast(S.ROOM_UPDATE_EVENT,r),e(r)},function(e){var a="ownerDeleteRoom ("+o+") failure: unknown error occurred";e&&e.data&&(a="ownerDeleteRoom ("+o+") failure: "+e.data.errorDetails),e&&404===e.status&&(t.info("[roomService] ownerDeleteRoom "+r.dbId+"("+r.getNameForLogs()+") not found, deleting it from local storage"),delete S.rooms[r.dbId],n.$broadcast(S.ROOM_UPDATE_EVENT,r)),t.error("[roomService] "+a),i(new Error(a))}):void t.error("[roomService] ownerDeleteRoom failure because the roomId is empty ...")})},S.ownerUpdateRoom=function(n){return t.info("[roomService] ownerUpdateRoom"),e(function(e,r){var i={name:n.name,topic:n.desc,visibility:n.type?"public":"private"};a({method:"PUT",url:S.portalURL+"rooms/"+n.dbId,headers:c.getPostHeader(),data:i}).then(function(n){var r=n.data.data;S.rooms[r.id].desc=r.topic,S.rooms[r.id].type="private"===r.visibility?h.Type.PRIVATE:h.Type.PUBLIC,t.info("[roomService] ownerUpdateRoom successfully ("+r.id+", "+r.jid+")"),e(S.rooms[r.id])},function(e){var n="ownerUpdateRoom failure: "+e.data.errorDetails;t.error("[roomService] "+n),r(new Error(n))})})},S.changeRoomOwner=function(n,r){return t.info("[roomService] changeRoomOwner"),e(function(e,i){if(!n||!r){var o="changeRoomOwner error: - missing room or new owner";return t.error("[roomService] "+o),void i(new Error(o))}var s={owner:r.dbId},d=n.confEndpoints&&n.confEndpoints.length?n.confEndpoints[0].confEndpointId:"";S.deleteRoomConferenceEndPoint(n,d).then(function(){a({method:"PUT",url:S.portalURL+"rooms/"+n.dbId,headers:c.getPostHeader(),data:s}).then(function(){n.ownerContact=r,n.owner=r.jid===l.userContact.jid,t.info("[roomService] changeRoomOwner successfully ("+n.dbId+")"),e(S.rooms[n.dbId])},function(e){var n="changeRoomOwner failure: "+e.data.errorDetails;t.error("[roomService] "+n),i(new Error(n))})}).catch(function(e){t.error("[roomService] changeRoomOwner error"),i(e)})})},S.ownerUpdateRoomCustomData=function(n){return t.info("[roomService] ownerUpdateRoomCustomData"),e(function(e,r){var i={customData:n.customData};a({method:"PUT",url:S.portalURL+"rooms/"+n.dbId+"/custom-data",headers:c.getPostHeader(),data:i}).then(function(n){var r=n.data.data;t.info("[roomService] ownerUpdateRoomCustomData successfully got ("+JSON.stringify(r,null,4)+")"),e(r.customData||{})},function(e){var n="ownerUpdateRoomCustomData failure: "+e.data.errorDetails;t.error("[roomService] "+n),r(new Error(n))})})},S.ownerUpdateRoomNameAndDescription=function(n){return t.info("[roomService] ownerUpdateRoomNameAndDescription"),e(function(e,r){var i={name:n.name,topic:n.desc,visibility:n.type?"public":"private"};a({method:"PUT",url:S.portalURL+"rooms/"+n.dbId,headers:c.getPostHeader(),data:i}).then(function(n){var r=n.data.data;S.rooms[r.id].desc=r.topic,S.rooms[r.id].type="private"===r.visibility?h.Type.PRIVATE:h.Type.PUBLIC,(r.conference||r.confEndpoints)&&(S.rooms[r.id].conference=r.conference?r.conference:null,S.rooms[r.id].confEndpoints=r.confEndpoints?r.confEndpoints:[]),t.info("[roomService] ownerUpdateRoomNameAndDescription successfully ("+r.id+", "+r.jid+")"),e(S.rooms[r.id])},function(e){var n="ownerUpdateRoomNameAndDescription failure: "+e.data.errorDetails;t.error("[roomService] "+n),r(new Error(n))})})},S.updateMyRoomUser=function(n,r){return e(function(e,i){a({method:"PUT",url:S.portalURL+"rooms/"+n.dbId+"/users/"+l.userContact.dbId,headers:c.getPostHeader(),data:{status:r}}).then(function(){t.info("[roomService] updateMyRoomUser "+l.userContact.displayNameForLog()+" to room "+n.dbId+"("+n.getNameForLogs()+") success"),e(n)},function(e){var r="updateMyRoomUser "+l.userContact.displayNameForLog()+" to room "+n.dbId+"("+n.getNameForLogs()+") failure: "+e.data.errorDetails;t.error("[roomService] "+r),i(new Error(r))})})},S.unsubscribeMeFromRoom=function(e){return S.updateMyRoomUser(e,S.RoomUserStatus.UNSUBSCRIBED)},S.participantCloseRoom=function(r){return t.info("[roomService] participantCloseRoom"),e(function(e,i){var o=l.userContact.dbId;a({method:"DELETE",url:S.portalURL+"rooms/"+r.dbId+"/users/"+o,headers:c.getRequestHeader()}).then(function(){t.info("[roomService] participantCloseRoom "+o+" from room "+r.dbId+"("+r.getNameForLogs()+") success"),delete S.rooms[r.dbId],n.$broadcast(S.ROOM_UPDATE_EVENT,r),e(r)},function(e){var n="participantCloseRoom "+o+" from room "+r.dbId+"("+r.getNameForLogs()+") failure: "+e.data.errorDetails;t.error("[roomService] "+n),i(new Error(n))})})},S.acceptRoomInvitation=function(e){return S.updateMyRoomUser(e,S.RoomUserStatus.ACCEPTED).then(function(){return d.retrieveReceivedFilesForRoom(e.dbId)}).then(function(){return S.sendInitialRoomPresenceSync(e)})},S.declineRoomInvitation=function(e){return S.updateMyRoomUser(e,S.RoomUserStatus.REJECTED)},S.getRoomConferenceEndPoint=function(n,r){return t.info("[roomService] getRoomConferenceEndPoint"),e(function(e,i){a({method:"GET",url:S.portalURL+"rooms/"+n.dbId+"/conference/"+r,headers:c.getRequestHeader()}).then(function(i){var a=i.data.data;t.info("[roomService] getRoomConferenceEndPoint "+r+" from room "+n.dbId+"success"),e(a)},function(e){var a="getRoomConferenceEndPoint "+r+" from room "+n.dbId+"failure: "+e.data.errorDetails;t.error("[roomService] "+a),i(new Error(a))})})},S.addRoomConferenceEndPoint=function(r,i,o){if(t.info("[roomService] addRoomConferenceEndPoint"),null===i||angular.isUndefined(i)){var s=new Error("No ConferenceEndPoint to associate with Room");return e.reject(s)}return e(function(e,s){var l=!1;return r.confEndpoints.forEach(function(e){e.confEndpointId===i.id&&(l=!0)}),l?(t.info("[roomService] addRoomConferenceEndPoint : already attached to room !"),void e(r)):(o&&"pstnAudio"===o&&Object.keys(S.rooms).forEach(function(e){S.rooms[e].conference&&!S.rooms[e].conference.scheduled&&S.rooms[e].getPstnConfEndpointId()===i.id&&S.deleteRoomConferenceEndPoint(S.rooms[e],i.id)}),void a({method:"POST",url:S.portalURL+"rooms/"+r.dbId+"/conferences",headers:c.getPostHeader(),data:{confId:i.id}}).then(function(a){var o=a.data.data;t.debug("[roomService] addRoomConferenceEndPoint response data:"+JSON.stringify(o)),r.confEndpoints.push(o),t.info("[roomService] addRoomConferenceEndPoint "+i.id+" to room "+r.dbId+"success"),n.$broadcast(S.ROOM_ADD_CONF_ENDPOINT_EVENT,r),e(r)},function(e){var n=m.handleError(e);t.error("[roomService] addRoomConferenceEndPoint "+n.message),s(n)}))})},S.deleteRoomConferenceEndPoint=function(r,i){return t.info("[roomService] deleteRoomConferenceEndPoint"),e(function(e,o){if(!r||!i)return t.info("[roomService] deleteRoomConferenceEndPoint : missing parameters "),void e();var s=!1;if(r.confEndpoints&&r.confEndpoints.length)for(var l=0;l<r.confEndpoints.length;l++)if(r.confEndpoints[l].confEndpointId===i){s=!0;break}return s?void a({method:"DELETE",url:S.portalURL+"rooms/"+r.dbId+"/conferences/"+i,headers:c.getRequestHeader()}).then(function(a){var o=a.data.data;t.info("[roomService] deleteRoomConferenceEndPoint "+i+" from room "+r.dbId+"success"),r.confEndpoints=o,n.$broadcast(S.ROOM_REMOVE_CONF_ENDPOINT_EVENT,r),e()},function(a){var s="deleteRoomConferenceEndPoint "+i+" from room "+r.dbId+"failure: "+a.data.errorDetails;t.error("[roomService] "+s),404===a.status?(r.confEndpoints=[],n.$broadcast(S.ROOM_REMOVE_CONF_ENDPOINT_EVENT,r),e(a.status)):o(new Error(s))}):(t.info("[roomService] deleteRoomConferenceEndPoint : room has no such conference attached"),void e())})},S.inviteGuestEmailToJoinRoom=function(r,i){return t.info("[roomService] inviteGuestEmailToJoinRoom"),i&&i.length?e(function(e,o){a({method:"POST",url:S.portalURL+"rooms/"+r.dbId+"/invitations",headers:c.getRequestHeader(),data:{scenario:"chat",emails:i,lang:c.userData.language}}).then(function(t){r.guestEmails=t.data.data.guestEmails,n.$broadcast("ROOM_ADD_CONF_GUESTS_EVENT",r),e(r)}).catch(function(e){var n=m.handleError(e);t.error("[roomService] inviteGuestEmailToJoinRoom "+n.message),o(n)})}):e.resolve(r)},S.ownerCancelGuestFromRoom=function(r,i){return t.info("[roomService] ownerCancelGuestFromRoom"),i&&i.length?e(function(e,o){a({method:"POST",url:S.portalURL+"rooms/"+r.dbId+"/invitations/cancel",headers:c.getRequestHeader(),data:{scenario:"chat",emails:i,lang:c.userData.language}}).then(function(t){r.guestEmails=t.data.guestEmails,n.$broadcast("ROOM_REMOVE_CONF_GUESTS_EVENT",r),e(r)}).catch(function(e){var n=m.handleError(e);t.error("[roomService] ownerCancelGuestFromRoom "+n.message),o(n)})}):e.resolve(r)},S.notifyRoomUsersJoinConference=function(r,i,o,s,l){return t.info("[roomService] notifyRoomUsersJoinConference"),s=angular.isDefined(s)?s:"false",l=angular.isDefined(l)?l:"false",e(function(e,d){var u=r.getPstnConfEndpointId();if(u){var h=r.desc;a({method:"POST",url:S.portalURL+"rooms/"+r.dbId+"/invitations",headers:c.getPostHeader(),data:{scenario:"pstn-conference",confId:u,noMail:s.toString(),update:l.toString(),users:i?i.map(function(e){return e.dbId}):void 0,emails:o,instantMessage:h,lang:c.userData.language}}).then(function(){t.info("[roomService] notifyRoomUsersJoinConference "+u+" from room "+r.dbId+"success"),S.rooms[r.dbId].guestEmails=o,n.$broadcast("ROOM_ADD_CONF_GUESTS_EVENT",S.rooms[r.dbId]),e(S.rooms[r.dbId])},function(e){var n="notifyRoomUsersJoinConference "+u+" from room "+r.dbId+"failure: "+e.data.errorDetails;t.error("[roomService] "+n),d(new Error(n))})}else e(r)})},S.notifyUsersCancelConference=function(r,i,o,s){return t.debug("[roomService] notifyUsersCancelConference"),s=angular.isDefined(s)?s:"false",e(function(e,l){var d=r.getPstnConfEndpointId();d?a({method:"DELETE",url:S.portalURL+"rooms/"+r.dbId+"/invitations",headers:c.getPostHeader(),data:{scenario:"pstn-conference",confId:d,noMail:s.toString(),users:i?i.map(function(e){return e.dbId}):void 0,emails:o,lang:c.userData.language}}).then(function(){t.info("[roomService] notifyUsersCancelConference "+d+" from room "+r.dbId+"success"),S.rooms[r.dbId].guestEmails=S.rooms[r.dbId].guestEmails.filter(function(e){return-1===o.indexOf(e)}),n.$broadcast("ROOM_DELETE_CONF_GUESTS_EVENT",S.rooms[r.dbId]),e(S.rooms[r.dbId])},function(e){var n="notifyUsersCancelConference "+d+" from room "+r.dbId+"failure: "+e.data.errorDetails;t.error("[roomService] "+n),l(new Error(n))}):e(r)})},S.getRoomByConferenceEndpointId=function(n){return t.info("[roomService] getRoomFromConferenceEndpointId"),e(function(e,r){a({method:"GET",url:S.portalURL+"rooms?userId="+l.userContact.dbId+"&confId="+n+"&format=full",headers:c.getRequestHeader()}).then(function(i){t.info("[roomService] getRoomFromConferenceEndpointId -- "+n+" -- success");var a=i.data.data;a.length?S.getRoomById(a[0].id)?e(S.getRoomById(a[0].id)):(S.createRoomFromData(a[0]),e(S.getRoomById(a[0].id))):(t.info("[roomService] getRoomFromConferenceEndpointId -- no room with confId "+n),r())},function(e){var i="getRoomFromConferenceEndpointId -- "+n+" -- failure: "+e.data.errorDetails;t.error("[roomService] "+i),r(new Error(i))})})},S.onRoomMessage=function(e){t.info("[roomService] onRoomMessage");try{if(0<angular.element(e).find("event").length&&("conferenceAdd"===angular.element(e).find("event").attr("name")||"conferenceRemove"===angular.element(e).find("event").attr("name")))return!0;var r=angular.element(e).find("x").attr("thread");return S.getServerRoom(r).then(function(e){e.isMeetingRoom()&&n.$broadcast("MEETING_CREATED_EVENT",e),S.computeInvitationCounter(),n.$broadcast(S.ROOM_INVITATION,e),n.$broadcast(S.ROOM_UPDATE_EVENT,e)}).catch(function(e){t.error("[roomService] onRoomMessage failure :  impossible to get associated room : "+e.message)}),!0}catch(e){return t.error("[roomService] onRoomMessage error "+e),!0}},S.onRoomNotificationMessage=function(e){try{var r=$(e),i=r.find("x");if(r.find("event").length&&i.length){var a=r.find("event").attr("name");if(!a||"invitation"!==a)return!0;t.info("[roomService] onRoomNotificationMessage");var o=$(i[0]).attr("roomid");return o?(S.getServerRoom(o).then(function(e){e.isMeetingRoom()&&n.$broadcast("MEETING_CREATED_EVENT",e),S.computeInvitationCounter(),n.$broadcast(S.ROOM_INVITATION,e),n.$broadcast(S.ROOM_UPDATE_EVENT,e)}).catch(function(e){t.error("[roomService] onRoomNotificationMessage failure :  impossible to get associated room : "+e.message)}),!0):(t.info("[roomService] onRoomNotificationMessage error -- missing roomId"),!0)}}catch(e){return t.error("[roomService] onRoomNotificationMessage error "+e),!0}},S.onRoomInfoMessage=function(e){t.info("[roomService] onRoomInfoMessage");try{if(0<angular.element(e).find("event").length){t.info("[roomService] onRoomInfoMessage : room event message");var r=angular.element(e).attr("from"),i=u.getBareJidFromJid(r),a=angular.element(e).find("event").attr("jid"),o=angular.element(e).find("event").attr("name"),c=angular.element(e).attr("id");if(t.info("[roomService] onRoomInfoMessage : room event message with parameters "+i+" || "+a+" || "+o+" || "+c),i&&a&&o&&c){var d=(f=S.getRoomByJid(i)).getUserByJid(a);switch(d&&"deleted"!==d.status&&n.$broadcast(S.ROOM_ADMIN_MESSAGE_EVENT,i,a,o,c),o){case"conferenceAdd":s(function(){S.getServerRoom(f.dbId).then(function(e){t.info("[roomService] onRoomInfoMessage : conferenceAdd event"),n.$broadcast("ROOM_UPDATE_CONFID",e),n.$broadcast("ROOM_ADD_CONF_ENDPOINT_EVENT",e),n.$broadcast("ON_CONFERENCE_STARTED_INVITATION",e,d)})},2e3,1);break;case"conferenceRemove":s(function(){S.getServerRoom(f.dbId).then(function(e){t.info("[roomService] onRoomInfoMessage : conferenceRemove event"),n.$broadcast("ROOM_REMOVE_CONF_ENDPOINT_EVENT",e),n.$broadcast("ON_CONFERENCE_ENDED_INVITATION",e)})},2e3,1);break;case"invitation":f.isUserModerator(l.userContact)&&(!d||d.status===S.RoomUserStatus.DELETED)&&S.getServerRoom(f.dbId).then(function(e){n.$broadcast(S.ROOM_UPDATE_EVENT,e)})}}}else if(0<angular.element(e).find("subject").length){r=angular.element(e).attr("from");var h=u.getBareJidFromJid(r),f=S.getRoomByJid(h),p=angular.element(e).find("subject").text();f&&p&&(t.info("[roomService] onRoomInfoMessage : update subject of room"),f.desc=p,n.$broadcast(S.ROOM_UPDATE_EVENT,f))}return!0}catch(e){return t.error("[roomService] onRoomInfoMessage error "+e),!0}},S.onRoomHistoryInfoMessage=function(e){var r=$(e).find("changed");if(0<r.length){var i=r.attr("with"),a=S.getRoomByJid(i);t.debug("[roomService] onRoomHistoryInfoMessage with "+i),n.$broadcast(S.ROOM_HISTORY_UPDATE_EVENT,a)}return!0},S.onRoomMessageConfig=function(e){try{var r=$(e),i=r.find("room"),a=r.find("delay");if("management"===r.attr("type")&&0<i.length){var o=i.attr("roomid"),s=i.attr("userjid"),c=i.attr("status"),d=i.attr("topic"),u=i.attr("name"),p=i.attr("scheduledStartDate"),m=i.attr("scheduledEndDate"),v=i.attr("scheduledTimezone"),g=i.attr("lastAvatarUpdateDate"),E=r.find("avatar"),b=null;0<E.length&&(b="delete"===E.attr("action")?"delete":"update");var y=i.attr("privilege"),R=i.attr("customData"),T=S.getRoomById(o);if(t.info("[roomService] onRoomMessageConfig -- management -- "+o),0<a.length&&"Offline Storage"===a.text())return t.info("[roomService] onRoomMessageConfig -- management delay msg skipped --"),!0;var I=i.find("guests");if(0<I.length&&(t.info("[roomService] onRoomMessageConfig -- "+o+" -- update guests list"),"update"===I.attr("action")&&(T.guestEmails=[],$(I).find("email").each(function(e,t){T.guestEmails.push(t.textContent)}))),T&&c)(N=T.getUserByJid(s))?N&&(t.info("[roomService] onRoomMessageConfig update user status"),S.updateUserStatus(T,N,c)):(t.info("[roomService] onRoomMessageConfig room exists, but user not. Update the room"),S.getServerRoom(o).then(function(){T.updateAvatarInfo()}));else if(T&&u)t.info("[roomService] onRoomMessageConfig update Room name or topic"),T.name=u,T.desc=d||"",S.roomsByJids[T.jid].name=u,S.rooms[T.dbId].name=u,S.roomsByJids[T.jid].desc=d||"",S.rooms[T.dbId].desc=d||"",T.isMeetingRoom()&&S.getServerRoom(T.dbId).then(function(){n.$broadcast("MEETING_UPDATE_EVENT",T)}),n.$broadcast(S.ROOM_UPDATE_EVENT,T);else if(T&&R){t.info("[roomService] onRoomMessageConfig update Room customData");var A=f.extractHtmlContent(R);try{R=JSON.parse(A)}catch(e){t.error("[roomService] onRoomMessageConfig update Room Parsing error:",e),R={}}T.customData=R,S.roomsByJids[T.jid].customData=R,S.rooms[T.dbId].customData=R,n.$broadcast(S.ROOM_UPDATE_EVENT,T)}else if(T&&T.conference&&p&&m&&v)t.info("[roomService] onRoomMessageConfig update Room conference data"),T.conference.scheduledStartDate=moment(p).toISOString(),T.conference.scheduledEndDate=moment(m).toISOString(),T.conference.scheduledTimezone=v,T.conference.scheduledDuration=moment.duration(moment(m).diff(moment(p))).asMinutes(),n.$broadcast(S.ROOM_UPDATE_EVENT,T);else if(T&&(g||b))t.info("[roomService] onRoomMessageConfig "+b+" avatar"),S.getServerRoom(T.dbId).then(function(e){e.updateAvatarInfo(),n.$broadcast(S.ROOM_AVATAR_UPDATE_EVENT,T)});else if(T&&y){var N;if(t.info("[roomService] onRoomMessageConfig update user's privilege "+y),(N=s?T.getUserByJid(s):null)&&N.contact&&N.contact.jid!==l.userContact.jid&&"owner"!==y?("moderator"===y?N.privilege=h.Privilege.MODERATOR:"user"===y&&(N.privilege=h.Privilege.USER),l.getVCardByDbId(N.contact.dbId).then(function(){S.refreshMemberAndOrganizerLists(T),n.$broadcast(S.ROOM_UPDATE_EVENT,T)})):S.getServerRoom(T.dbId).then(function(e){S.refreshMemberAndOrganizerLists(e),n.$broadcast(S.ROOM_UPDATE_EVENT,e)}),"owner"===y&&N&&N.contact&&N.contact.jid===l.userContact.jid){var O=C.instant("promotedToOwner",{name:_escape(T.name)});n.$broadcast("GLOBAL_NOTIFY_MESSAGE_EVENT",O)}}else void 0===T&&o&&!S.roomsInProgress[o]&&"deleted"!==c&&"rejected"!==c?(S.roomsInProgress[o]=!0,t.info("[roomService] onRoomMessageConfig -- room does not exist, create new one"),S.getServerRoom(o).then(function(e){delete S.roomsInProgress[o],t.info("[roomService] onRoomMessageConfig -- sendInitialRoomPresence to the new room"),S.sendInitialRoomPresence(e),S.updateLater[o]&&(delete S.updateLater[o],t.info("[roomService] onRoomMessageConfig -- later update of the new room"),S.getServerRoom(o).then(function(e){e.updateAvatarInfo()}))})):S.roomsInProgress[o]&&(S.updateLater[o]=o)}var D=angular.element(e).find("openinvite");if(D&&"update"===D.attr("action"))(o=D.find("roomid").text())?S.openInviteRoomId&&S.openInviteRoomId!==o?(t.debug("[roomService] room bound to openinviteId changed"),S.openInviteRoomId="",S.retrieveOpenInviteRoom().then(function(){n.$broadcast(S.ON_OPEN_INVITE_ROOM_ID_UPDATED_EVENT)})):n.$broadcast(S.ON_OPEN_INVITE_ROOM_ID_UPDATED_EVENT):(n.$broadcast(S.ON_OPEN_INVITE_ROOM_ID_UPDATED_EVENT),t.warn("[roomService] openInviteId unbound"));return!0}catch(e){return t.info("[roomService] onRoomMessageConfig  -- failure -- "+e.message),!0}},S.onRoomPresence=function(e){try{var r=angular.element(e),i=r.attr("from"),a=u.getBareJidFromJid(i),o=u.getResourceFromJid(i),c=r.find("status"),d=null;c.each(function(e,t){"332"===$(t).attr("code")&&(d="332"),"338"===$(t).attr("code")&&(d="338"),"339"===$(t).attr("code")&&(d="339")});var h=S.getRoomByJid(a);return h&&("338"===d?(t.info("[roomService] onRoomPresence - "+h.dbId+"- Deactivated"),h.isActive=!1,n.$broadcast(S.ROOM_UPDATE_EVENT,h)):"339"===d?(t.info("[roomService] onRoomPresence - "+h.dbId+"- Reactivated"),S.sendInitialRoomPresenceSync(h),h.isActive=!0,n.$broadcast(S.ROOM_UPDATE_EVENT,h)):(t.info("[roomService] onRoomPresence -- "+h.dbId),-1!==o.indexOf("/")&&(o=u.getBareJidFromJid(o)),l.isUserContactJid(o)?"332"===d?(t.error("[roomService] disconnected from room "+h.getNameForLogs()+" because of a system shutdown"),S.sendInitialRoomPresenceSync(h)):h.initPresPromise&&(t.info("[roomService] onRoomPresence - initPresPromise resolved"),h.initPresPromise.resolve(h),h.initPresInterval&&s.cancel(h.initPresInterval),h.initPresPromise=null,n.$broadcast(S.ROOM_UPDATE_EVENT,h),h.initPresPromiseReceived=!0):h.dbId&&!S.rooms[h.dbId]&&S.getServerRoom(h.dbId))),!0}catch(e){return t.error("[roomService] onRoomPresence error "+e),!0}},S.updateUserStatus=function(e,r,i){if(t.info("[roomService] "+r.status+" || "+i),l.isUserContactJid(r.contact.jid)&&r.status!==i)switch(t.info("[roomService] my new status "+i),i){case"deleted":delete S.roomsByJids[e.jid],delete S.rooms[e.dbId],t.info("[roomService] deleteRoom successfully ("+e.dbId+")"),S.sendUnavailableRoomPresence(e),S.computeInvitationCounter(),e.isMeetingRoom()&&n.$broadcast("MEETING_DELETE_EVENT",e),n.$broadcast(S.ROOM_UPDATE_EVENT,e,"remove");break;case"unsubscribed":t.info("[roomService] unsubscribed successfully ("+e.dbId+")"),S.sendUnavailableRoomPresence(e),e.status=S.RoomUserStatus.UNSUBSCRIBED,r.status=i,e.updateAvatarInfo(),e.isModerator=!1,S.computeInvitationCounter(),n.$broadcast(S.ROOM_UPDATE_EVENT,e);break;case"accepted":d.retrieveReceivedFilesForRoom(e.dbId).then(function(){S.sendInitialRoomPresence(e),e.status=S.RoomUserStatus.ACCEPTED,r.status=i,e.updateAvatarInfo(),S.computeInvitationCounter(),n.$broadcast(S.ROOM_UPDATE_EVENT,e)});break;case"rejected":delete S.roomsByJids[e.jid],delete S.rooms[e.dbId],e.status=S.RoomUserStatus.REJECTED,r.status=i,S.computeInvitationCounter(),n.$broadcast(S.ROOM_UPDATE_EVENT,e)}else r&&!l.isUserContactJid(r.contact.jid)&&(t.info("[roomService] Update user with status "+i),r.status===S.RoomUserStatus.DELETED&&i===S.RoomUserStatus.ACCEPTED&&(r.date=new Date,r.privilege===h.Privilege.MODERATOR&&(r.privilege=h.Privilege.USER)),r.status=i,e.updateAvatarInfo(),S.refreshMemberAndOrganizerLists(e),n.$broadcast(S.ROOM_UPDATE_EVENT,e))},S.findRoomsWithConfId=function(e){return S.getRooms().filter(function(t){return!(!t.confEndpoints||!t.confEndpoints.length)&&t.confEndpoints.some(function(t){return t.confEndpointId===e})})},S.removeConfIdInAllRooms=function(t){var n=[];return t.forEach(function(e){e.confEndpoints&&0<e.confEndpoints.length&&n.push(S.deleteRoomConferenceEndPoint(e,e.confEndpoints[0].confEndpointId))}),e.all(n)},S.getCreationDate=function(e){return e.creationDate?moment(e.creationDate):moment()},S.sortByDate=function(e,t){var n=1;return e&&t&&(n=e.value-t.value),n},S.bindOpenInviteToRoom=function(n,r){return e(function(e,i){a({method:"PUT",url:S.portalURL+"users/"+l.userContact.dbId+"/open-invites/bind",headers:c.getRequestHeader(),data:{roomId:n}}).then(function(){t.info("[roomService] openInvite "+r+" successfully bound to room "+n),e(S.rooms[n])}).catch(function(e){t.error("[roomService] Error binding openInviteId to Room"),i(e)})})},S.unbindOpenInviteFromRoom=function(){return e(function(e,n){a({method:"PUT",url:S.portalURL+"users/"+l.userContact.dbId+"/open-invites/unbind",headers:c.getRequestHeader()}).then(function(r){var i=r.data.data;i&&i.openInviteId&&i.roomId?(t.error("[roomService] An error occured, room "+i.roomId+" is still bound with openInviteId "+i.openInviteId),n()):(S.openInviteRoomId="",t.info("[roomService] openInvite successfully unbound"),e())},function(){var e="unbindOpenInvite failure";t.error("[roomService] "+e),n(new Error(e))})})},S.joinRoomUsingOpenInviteId=function(n){return e(function(e,r){a({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/rooms/open-invites",headers:c.getRequestHeader(),data:{openInviteId:n}}).then(function(t){var n=t.data.data;n&&n.roomId?e(n.roomId):r()}).catch(function(e){t.error("[roomService] Error retrieveRoomFromOpenInvite"),r(e)})})},S.retrieveRoomIdFromOpenInviteId=function(){return e(function(e,n){a({method:"GET",url:S.portalURL+"users/"+l.userContact.dbId+"/open-invites",headers:c.getRequestHeader()}).then(function(r){var i=r.data.data;i&&i.roomId?e(i.roomId):(t.error("[roomService] Error - no roomId associated to openInviteId"),n())}).catch(function(e){t.error("[roomService] Error retrieveRoomFromOpenInvite"),n(e)})})},S.retrieveOpenInviteRoom=function(){return t.debug("[roomService] retrieveOpenInviteRoom"),e(function(e,n){S.openInviteRoomId?S.rooms[S.openInviteRoomId]?e(S.rooms[S.openInviteRoomId]):(t.warn("[roomService] retrieveOpenInviteRoom - unknown room"),S.openInviteRoomId="",S.unbindOpenInviteFromRoom().finally(function(){n()})):S.retrieveRoomIdFromOpenInviteId().then(function(r){if(r){S.openInviteRoomId=r;var i=S.getRoomById(r);if(i)return void e(i);t.warn("[roomService] retrieveOpenInviteRoom - room with openInvite not found locally, retrieving it from server."),S.getServerRoom(r).then(function(t){e(t)}).catch(function(){t.warn("[roomService] retrieveOpenInviteRoom - no room attached"),n(new Error("[roomService] retrieveOpenInviteRoom - no room attached"))})}else t.warn("[roomService] retrieveOpenInviteRoom - no room attached"),n(new Error("[roomService] retrieveOpenInviteRoom - no room attached"))}).catch(function(){t.warn("[roomService] retrieveOpenInviteRoom - no room attached"),n(new Error("[roomService] retrieveOpenInviteRoom - no room attached"))})})},S.getName=function(e){return e.name},S.sortByName=function(e,t){return e&&t&&"string"===e.type&&"string"===t.type&&e.value&&t.value?e.value.localeCompare(t.value):-1},S.sortObjectByProperty=function(e){return function(t,n){return t[e]<n[e]?-1:t[e]>n[e]?1:0}}}])},function(){!function(){"use strict";angular.module("rainbow").service("groupService",["$q","$rootScope","$log","$http","authService","contactService","xmppService","Group","usersService","utilService",function(e,t,n,r,i,a,o,s,c,l){var d=this;this.started=!1,d.ON_REMOVE_GROUP_USER_EVENT="ON_REMOVE_GROUP_USER_EVENT",d.ON_ADD_GROUP_USER_EVENT="ON_ADD_GROUP_USER_EVENT",d.ON_GROUP_USERS_UPDATE_EVENT="ON_GROUP_USERS_UPDATE_EVENT",d.ON_CREATED_GROUP_EVENT="ON_CREATED_GROUP_EVENT",d.ON_UPDATE_GROUP_EVENT="ON_UPDATE_GROUP_EVENT",d.ON_REMOVED_GROUP_EVENT="ON_REMOVED_GROUP_EVENT",this.start=function(){n.info(""),n.info("[groupService] === STARTING ==="),d.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+i.userId+"/";var t=e.defer();return d.$q=e,d.groups=null,a.userContact.isCPaaSGuest()?t.resolve():(this.attachHandlers(),this.getGroups(),d.started=!0,n.info("[groupService] === STARTED ==="),t.resolve(),t.promise)},this.stop=function(){return n.info("[groupService] === STOPPING ==="),d.conversations=null,d.groups=null,this.groupMessageHandlerRef&&(o.deleteHandler(this.groupMessageHandlerRef),this.groupMessageHandlerRef=null),this.started=!1,n.info("[groupService] === STOPPED ==="),e.when()},this.getGroups=function(){return d.groups?e.when(d.groups):d.getRemoteGroups()},d.getGroupsAsArray=function(){var e=[];for(var t in d.groups)d.groups.hasOwnProperty(t)&&e.push(d.groups[t]);return e},this.searchGroups=function(e){var t=e.toLowerCase().trim().split(/[ ]+/);return d.groups.filter(function(e){var n=e.name.toLowerCase().trim().split(/[ ]+/);return t.every(function(t){return n.some(function(r,i){return!(!r.length||0!==l.removeDiacritis(r).indexOf(l.removeDiacritis(t))||(n[i]="",e._displayName=l.removeDiacritis(e.name),0))})})})},this.getRemoteGroups=function(){n.info("[groupService] getGroups");var t=e.defer();return r({method:"GET",url:d.portalURL+"groups?format=full",headers:i.getRequestHeader()}).then(function(t){var r=t.data.data;n.info("[groupService] getGroups success (find "+t.data.total+" group(s))"),d.groups=[];var i=[];return r.forEach(function(e){var t=s.createFromData(e);d.groups.push(t),angular.forEach(e.users,function(e){i=a.getContactByDBId(e).then(function(e){e&&t.users.push(e)})}),d.logGroupUsers(t),d.sortUsersInGroup(t)}),e.all(i)},function(e){var r="getGroups"+d.handleErrorMessage(e);t.reject(new Error(r)),n.error("[groupService] "+r)}).then(function(){t.resolve(d.groups)}),t.promise};var u=function(n,r){return e(function(e){d.groups.some(function(i){return i.id===n&&(i.users.some(function(e){return r===e.dbId})?(e(i),t.$broadcast(d.ON_ADD_GROUP_USER_EVENT,n,r),!0):(a.getContactByDBId(r).then(function(a){i.users.push(a),d.sortUsersInGroup(i),a.getGroups()?a.getGroups().push(i):a.setGroups([i]),t.$broadcast(d.ON_ADD_GROUP_USER_EVENT,n,r),e(i)}),!0))})||(t.$broadcast(d.ON_ADD_GROUP_USER_EVENT,n,r),e())})};this.getGroup=function(t){n.info("[groupService] getGroup  for "+t);var o=e.defer(),c=null;return r({method:"GET",url:d.portalURL+"groups/"+t,headers:i.getRequestHeader()}).then(function(t){var r=t.data.data,i=[];return c=s.createFromData(r),n.info("[groupService] getGroup success for "+c.name+" : "+c.id),d.groups.some(function(e,t){return e.id===r.id&&(d.groups[t]=c,angular.forEach(r.users,function(e){i=a.getContactByDBId(e.id).then(function(e){e&&(d.groups[t].users.push(e),d.sortUsersInGroup(d.groups[t]))})}),!0)})||(d.groups.push(c),angular.forEach(r.users,function(e){i=a.getContactByDBId(e.id).then(function(e){if(e){c.users.push(e),d.sortUsersInGroup(c);var t=[c];e.getGroups()?e.getGroups().push(c):e.setGroups(t)}})})),e.all(i)},function(e){var t="getGroup"+d.handleErrorMessage(e);o.reject(new Error(t)),n.error("[groupService] "+t)}).then(function(){o.resolve(c)}),o.promise},this.addGroup=function(t){n.info("[groupService] addGroup : "+t.name);var a=e.defer();return r({method:"POST",url:d.portalURL+"groups",headers:i.getPostHeader(),data:{name:t.name,comment:t.comment,isFavorite:t.isFavorite}}).then(function(e){n.info("[groupService] addGroup success for : "+t.name);var r=e.data.data,i=s.createFromData(r);a.resolve(i)},function(e){var t="addGroup"+d.handleErrorMessage(e);a.reject(new Error(t)),n.error("[groupService] "+t)}),a.promise};var h=function(e){angular.forEach(d.groups,function(t,n){t.id===e&&d.groups.splice(n,1)})};this.removeGroup=function(t){n.info("[groupService] removeGroup : "+t);var a=e.defer();return r({method:"DELETE",url:d.portalURL+"groups/"+t,headers:i.getRequestHeader()}).then(function(){n.info("[groupService] removeGroup success for : "+t),h(t),a.resolve()},function(e){var t="removeGroup"+d.handleErrorMessage(e);a.reject(new Error(t)),n.error("[groupService] "+t)}),a.promise},this.updateGroup=function(t){n.info("[groupService] updateGroup for : "+t.name);var a=e.defer();return r({method:"PUT",url:d.portalURL+"groups/"+t.id,headers:i.getRequestHeader(),data:{name:t.name,comment:t.comment,isFavorite:t.isFavorite}}).then(function(){n.info("[groupService] updateGroup success for : "+t.name),a.resolve()},function(e){var t=d.handleErrorMessage(e,"updateGroup");a.reject(t),n.error("[groupService] "+t.message)}),a.promise},this.getGroupUsers=function(t){n.info("[groupService] getGroupUsers : "+t);var a=e.defer();return r({method:"GET",url:d.portalURL+"groups/"+t+"/users",headers:i.getRequestHeader()}).then(function(e){var r=e.data.data;n.info("[groupService] getGroupUsers success for "+t+" (find "+e.data.total+" users(s))"),a.resolve(r.users)},function(e){var t="getGroupUsers"+d.handleErrorMessage(e);a.reject(new Error(t)),n.error("[groupService] "+t)}),a.promise},this.addGroupUser=function(e,a){n.info("[groupService] addGroupUser");var o=d.$q.defer();return e.users.some(function(e){return a.dbId===e.dbId})?(n.info("[groupService] addGroupUser - user: "+a.id+" already exist in group: "+e.name+" - no remote action"),void o.resolve()):(r({method:"POST",url:d.portalURL+"groups/"+e.id+"/users/"+a.dbId,headers:i.getPostHeader()}).then(function(r){n.info("[groupService] addGroupUser success: "+a.id+"/"+e.name),u(e.id,a.dbId).then(function(e){if(e)o.resolve(e);else{var t=r.data.data,n=s.createFromData(t);o.resolve(n)}}),t.$broadcast(d.ON_GROUP_USERS_UPDATE_EVENT)},function(e){var t="addGroupUser"+d.handleErrorMessage(e);o.reject(new Error(t)),n.error("[groupService] "+t)}),o.promise)};var f=function(e,t){angular.forEach(d.groups,function(n){n.id===e&&(angular.forEach(n.users,function(r,i){r.dbId===t&&(n.users.splice(i,1),r.getGroups()&&angular.forEach(r.getGroups(),function(t,n){t.id===e&&r.getGroups().splice(n,1)}))}),d.sortUsersInGroup(n))})};this.getGroupById=function(e){var t=null;return angular.forEach(d.groups,function(n){n.id===e&&(t=n)}),t},this.removeGroupUser=function(a,o){n.info("[groupService] removeGroupUser : "+a+"/"+o.id);var s=e.defer();return r({method:"DELETE",url:d.portalURL+"groups/"+a+"/users/"+o.dbId,headers:i.getRequestHeader()}).then(function(){n.info("[groupService] removeGroupUser success : "+a+"/"+o.id),f(a,o.dbId);var e=d.getGroupById(a);t.$broadcast(d.ON_GROUP_USERS_UPDATE_EVENT),s.resolve(e)},function(e){var t="removeGroupUser"+d.handleErrorMessage(e);s.reject(new Error(t)),n.error("[groupService] "+t)}),s.promise},this.getUserGroups=function(t){if(!t)return n.info("[groupService] getUserGroups for unknown user !"),e.when();n.info("[groupService] getUserGroups for user : "+t.id);var a=e.defer(),o=t.getGroups();return o?e.when(o):(r({method:"GET",url:d.portalURL+"groups?userId="+t.dbId,headers:i.getRequestHeader()}).then(function(e){var r=e.data.data;n.info("[groupService] getUserGroups success (find "+e.data.total+" group(s))");var i=[];r.forEach(function(e){var t=s.createFromData(e);i.push(t)}),t.setGroups(i),d.logUserGroups(t.displayNameForLog(),i),a.resolve(i)},function(e){var t="getUserGroups"+d.handleErrorMessage(e);a.reject(new Error(t)),n.error("[groupService] "+t)}),a.promise)},this.getGroupFromName=function(t){n.info("[groupService] getGroupFromName : "+t);var r=e.defer();return this.getGroups().then(function(e){var n=null;e.forEach(function(e){e.name===t&&(n=e)}),r.resolve(n)}),r.promise},this.sortUsersInGroup=function(e){e&&(e.sortedUserList=c.getFilterAndOrderUsersGroupedByOrderLabelAndUpdateActivity(e.users,t.orderType,t.filterType,!0))},this.searchLocalGroup=function(e){var t=[];return n.info("[groupService] searchLocalGroup with text "+e),e&&d.groups.forEach(function(n){0<=n.name.toLowerCase().indexOf(e.toLowerCase().toString())&&t.push(n)}),t},this.extractStanzaData=function(t){var n=e.defer(),r={outgoingMessage:!1};return r.body=angular.element(t)[0].firstChild,r.messageId=angular.element(t).attr("id"),n.resolve(r),n.promise},this.onGroupMessageReceived=function(e){try{return this.extractStanzaData(e).then(function(e){if(e.body&&"group"===e.body.tagName){var n=e.body.getAttribute("action"),r=e.body.getAttribute("scope"),i=e.body.getAttribute("id");switch(r){case"group":switch(n){case"create":d.getGroup(i),t.$broadcast(d.ON_CREATED_GROUP_EVENT,i);break;case"update":var a=e.body.getAttribute("name"),o=e.body.getAttribute("comment"),s="true"===e.body.getAttribute("isFavorite");t.$broadcast(d.ON_UPDATE_GROUP_EVENT,i,a,o,s);break;case"delete":h(i),t.$broadcast(d.ON_REMOVED_GROUP_EVENT,i)}break;case"user":var c=e.body.getAttribute("userId");switch(n){case"create":u(i,c);break;case"delete":f(i,c),t.$broadcast(d.ON_REMOVE_GROUP_USER_EVENT,i,c)}}}}),!0}catch(e){return!0}},this.attachHandlers=function(){d.removeHandlers(),d.groupMessageHandlerRef||(d.groupMessageHandlerRef=o.addHandler(function(e){return d.onGroupMessageReceived(e)},null,"message","management"))},this.removeHandlers=function(){d.groupMessageHandlerRef&&(o.deleteHandler(d.groupMessageHandlerRef),d.groupMessageHandlerRef=null)},this.handleBadRequest=function(e,t){if(400===t.status&&t.data.errorDetails&&0<t.data.errorDetails.length){var n={};t.data.errorDetails.forEach(function(e){n[e.param]=e.msg});var r=new Error(e+" failure: BadRequest");return r.fieldErrors=n,r}return null},this.handleErrorMessage=function(e){var t=" failure: ";return 500===e.status&&(t+="Internal server error"),403===e.status?t+="Access is forbidden for the current user":404===e.status?t+=e.data.errorMsg:e.data&&e.data.errorDetails&&(t+=e.data.errorDetails),t},this.logUserGroups=function(e,t){var r="";t&&0!==t.length&&(t.forEach(function(e){e.name&&(r+=" "+e.name)}),n.info("[groupService] logUserGroups for "+e+":"+r))},this.logGroupUsers=function(e){var t="";e&&e.users&&0!==e.users.length&&(t=e.users.map(function(e){return e.displayNameForLog()}).join(" / "),n.info("[groupService] logGroupUsers for "+e.name+": "+t))}}])}()},function(){const e=3e5,t=9e5;var n;!function(e){e[e.Unknow=0]="Unknow",e[e.Free=1]="Free",e[e.WaitWebrtc=2]="WaitWebrtc",e[e.WaitTelephony=3]="WaitTelephony",e[e.CallOffer=4]="CallOffer",e[e.CallOnGoing=5]="CallOnGoing",e[e.CallActive=6]="CallActive",e[e.CallActiveNoWebMedia=7]="CallActiveNoWebMedia",e[e.TelCallReleasing=8]="TelCallReleasing",e[e.WebCallReleasing=9]="WebCallReleasing",e[e.RemoteControled=10]="RemoteControled",e[e.AnomalyCCS=11]="AnomalyCCS"}(n||(n={}));class r{constructor(t,n,r,i,a,o,s,c,l,d,u,h,f,p,m){this.$q=t,this.$rootScope=n,this.$log=r,this.$http=i,this.authService=a,this.$interval=o,this.xmppService=s,this.videoService=c,this.errorHelperService=l,this.contactService=d,this.profileService=u,this.Call=h,this.uuid4=f,this.telephonyService=p,this.settingsService=m,this.started=!1,this.listeners=[],this.myContact=null,this.mediaPillarContact=null,this.mediaPillarConfigured=!1,this.mediaPillarAlive=!1,this.mediaPillarJid="",this.evtQueue=[],this.SEM=0,this.fakeMediaPillarJid="00a241586a984a869c73719007b27921@demo-all-in-one-dev-1.opentouch.cloud",this.TO_transition=15e3,this.TO_transition_long=3e4,this.TO_NoWebMedia=6e4,this.TO_PILLAR_POLLING=e,this.mediaPillarKeepAliveSuspend=!1}start(t){return this.$q(r=>{let i=performance.now();this.mediaPillarConfigured=!1,this.mediaPillarAlive=!1,this.portalURL=config.restServerUrl+"/api/rainbow/mediapillar/v1.0/mediapillars",this.myContact=this.contactService.userContact,this.mediaPillarContact=null,this.mediaPillarCallContext={callState:n.Free,keepAlive_TO:null,callState_TO:null,isOutgoingCall3PCC:!1,telephonyCallRefs:[],webrtcCallRef:null,mediaPillarJid:"",rainbowPhoneNumber:"",remoteExtension:"",previousCallConnectionId:null,previousCallStatus:null,updateContactFlag:!1},this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.TELEPHONY_WEBRTC_PSTN_CALLING)?(this.$log.info("[WebrtcGatewayService] === STARTING ==="),this.started=!0,this.SEM=0,this.resetEvtAutomaton(),this.getMediaPillarData().then(n=>{this.mediaPillarContact=this.createMediaPillarContact(n),this.mediaPillarCallContext.mediaPillarJid=n,this.$log.info("[WebrtcGatewayService] Pillar remoteExtension used : "+this.mediaPillarCallContext.remoteExtension),""===this.mediaPillarCallContext.remoteExtension?(this.$log.warn("[WebrtcGatewayService] no remoteExtention available "),this.mediaPillarConfigured=!1):this.mediaPillarConfigured=!0,this.mediaPillarConfigured&&this.dummyRegisterMediaPillarCall().then(()=>{this.mediaPillarAlive=!0,this.$log.info("[WebrtcGatewayService] Pseudo media pillar register OK with extension "+this.mediaPillarCallContext.remoteExtension),this.$rootScope.$broadcast("ON_WEBRTCGATEWAY_STATE_CHG",this.mediaPillarAlive)}).catch(()=>{this.mediaPillarAlive=!1,this.$log.info("[WebrtcGatewayService] Pseudo media pillar register KO"),this.$log.info("[WebrtcGatewayService] Initial polling activated on starting issue"),this.mediaPillarKeepAlivePolling("START",e),this.$rootScope.$broadcast("ON_WEBRTCGATEWAY_STATE_CHG",this.mediaPillarAlive)}),this.listeners.push(this.$rootScope.$on("ON_CONNECTION_STATE_CHANGE_EVENT",(t,n)=>{"disconnected"===n?(this.$log.info("[WebrtcGatewayService] onConnectionStateChangeEvent : disconnected then MP keepalive suspended"),this.mediaPillarKeepAliveSuspend=!0):"connected"==n&&(this.$log.info("[WebrtcGatewayService] onConnectionStateChangeEvent : connected then keepalive as necessary"),this.mediaPillarKeepAliveSuspend=!1,this.TO_PILLAR_POLLING=e)})),this.listeners.push(this.$rootScope.$on("ON_CALL_UPDATED_EVENT",(e,t,n)=>{this.onCallEvent(e,t,n)})),this.listeners.push(this.$rootScope.$on("ON_MEDIAPILLAR_CALL_REMOTE_CTRL_EVENT",(e,t)=>{this.onRemoteCtrlCall(e,t)}));var a=Math.round(performance.now()-i);t.push({service:"WebrtcGatewayService",startDuration:a}),this.$log.info("[WebrtcGatewayService] === STARTED ("+a+" ms) ==="),r()}).catch(e=>{this.mediaPillarCallContext.mediaPillarJid="",this.mediaPillarCallContext.rainbowPhoneNumber="",this.mediaPillarCallContext.remoteExtension="",this.mediaPillarConfigured=!1,this.mediaPillarAlive=!1,this.$log.info("[WebrtcGatewayService] === STARTING FAILURE === "+e.message),r()})):(this.$log.info("[WebrtcGatewayService] === NO WEBRTCGATEWAY ENVOLVED === "),r())})}stop(){return this.$log.info("[WebrtcGatewayService] === STOPPING ==="),this.started=!1,this.mediaPillarConfigured=!1,this.mediaPillarAlive=!1,this.mediaPillarKeepAlivePolling("STOP",0),this.mediaPillarCallContext&&(this.releaseMediaPillarCallContext(),this.mediaPillarCallContext.callState=n.Unknow,this.mediaPillarCallContext.mediaPillarJid="",this.mediaPillarCallContext.rainbowPhoneNumber="",this.mediaPillarCallContext.remoteExtension=""),this.listeners&&this.listeners.forEach(e=>{e()}),this.$log.info("[WebrtcGatewayService] === STOPPED ==="),this.$q.resolve()}onCallEvent(e,t,n){if(this.isMediaPillarCallCase()){if(this.SEM++,this.$log.info("[WebrtcGatewayService] onCallEvent IN("+this.SEM+") state = "+this.mediaPillarCallContext.callState),this.$log.info("[WebrtcGatewayService] onCallEvent "+this.mediaPillarCallContext.callState+" --- "+t.type.value+"("+t.id+","+t.status.value+")"),t.connectionId===this.mediaPillarCallContext.previousCallConnectionId&&t.status===this.mediaPillarCallContext.previousCallStatus)return this.mediaPillarCallContext.previousCallConnectionId=t.connectionId,this.mediaPillarCallContext.previousCallStatus=t.status,this.$log.info("[WebrtcGatewayService] onCallEvent | DEBOUNCE EVT"),this.SEM--,void this.$log.info("[WebrtcGatewayService] onCallEvent OUT("+this.SEM+")");if(t.type.value===this.Call.Type.PHONE.value&&null===t.id)return this.mediaPillarCallContext.previousCallConnectionId=t.connectionId,this.mediaPillarCallContext.previousCallStatus=t.status,this.$log.info("[WebrtcGatewayService] onCallEvent | FILTER EVT null/error"),this.SEM--,void this.$log.info("[WebrtcGatewayService] onCallEvent OUT("+this.SEM+")");if(n&&null!==n&&(this.$log.info("[WebrtcGatewayService] onCallEvent tel infoEvt : Evt = "+n.actionElemName+" / cause = "+n.cause),"updatecall"===n.actionElemName&&(this.mediaPillarCallContext.updateContactFlag=!0,this.$log.info("[WebrtcGatewayService] updateContactFlag = true"))),this.mediaPillarCallContext.previousCallConnectionId=t.connectionId,this.mediaPillarCallContext.previousCallStatus=t.status,this.evtQueue.push(t),1<this.evtQueue.length)return this.SEM--,void this.$log.info("[WebrtcGatewayService] onCallEvent OUT("+this.SEM+") evt pushed = "+t.status.value);for(;this.evtQueue.length;){try{this.processEvt(this.evtQueue[0])}catch(e){this.$log.error("[WebrtcGatewayService] onCallEvent queue processing | call : "+this.evtQueue[0].status.value+" Error : "+e)}this.evtQueue.splice(0,1)}this.SEM--,this.$log.info("[WebrtcGatewayService] onCallEvent OUT("+this.SEM+") state = "+this.mediaPillarCallContext.callState),0!==this.SEM&&(this.$log.error("[WebrtcGatewayService] onCallEvent OUT | Unmanaged Eventing Reentrancy Situation"),this.resetEvtAutomaton(),this.SEM=0)}}processEvt(e){if(this.$log.info("[WebrtcGatewayService] processEvt | process "+e.type.value+"("+e.id+","+e.status.value+") in MPcontextCallstate = "+this.mediaPillarCallContext.callState),e.type.value===this.Call.Type.PHONE.value){var t=this.telephonyService.getCalls().length;if((()=>{let t=!1;return e.status===this.Call.Status.DIALING&&(e.isSecondary=!0),e.isSecondary?e.status===this.Call.Status.UNKNOWN||e.status===this.Call.Status.RINGING_INCOMMING||e.status===this.Call.Status.QUEUED_INCOMMING||e.status===this.Call.Status.ACTIVE?(this.addTelCallRefs(e),t=!1):this.mediaPillarCallContext.callState===n.RemoteControled?(this.$log.info("[WebrtcGatewayService] processEvt |  RemoteControled state for call : "+e.id+" then ignore"),t=!0):(this.addTelCallRefs(e),1<this.mediaPillarCallContext.telephonyCallRefs.length?(this.$log.info("[WebrtcGatewayService] processEvt |  nthCall : "+this.mediaPillarCallContext.telephonyCallRefs.length+" then ignore"),t=!0):t):(this.$log.info("[WebrtcGatewayService] processEvt | NOT SECONDARY then ignore"),t=!0)})())this.$log.info("[WebrtcGatewayService] processEvt |  call("+e.id+" / SEC "+e.isSecondary+", "+e.status.value+") -> EVT IGNORED"),this.$log.info("[WebrtcGatewayService] processEvt |  telephonyCallRefs.length = "+this.mediaPillarCallContext.telephonyCallRefs.length),this.$log.info("[WebrtcGatewayService] processEvt |  calls.length = "+t);else switch(this.$log.info("[WebrtcGatewayService] processEvt |  call("+e.id+" / SEC "+e.isSecondary+", "+e.status.value+") -> EVT PROCESSED"),this.$log.info("[WebrtcGatewayService] processEvt |  telephonyCallRefs.length = "+this.mediaPillarCallContext.telephonyCallRefs.length),this.$log.info("[WebrtcGatewayService] processEvt |  calls.length = "+t),e.status){case this.Call.Status.RINGING_INCOMMING:this.onTelCallIncomming(e);break;case this.Call.Status.DIALING:this.onTelCallDialling(e);break;case this.Call.Status.RINGING_OUTGOING:this.onTelCallOutgoing(e);break;case this.Call.Status.ACTIVE:this.onTelCallActive(e);break;case this.Call.Status.UNKNOWN:this.onTelCallReleasing(e)}}else if(this.isMediaPillarJid(this.xmppService.getBareJidFromJid(e.fullJid)))switch(e.status){case this.Call.Status.RINGING_INCOMMING:this.onWebrtcCallIncomming(e);break;case this.Call.Status.CONNECTING:this.onWebrtcCallConnecting(e);break;case this.Call.Status.ACTIVE:this.onWebrtcCallActive(e);break;case this.Call.Status.ANSWERING:this.onWebrtcCallAnswering(e);break;case this.Call.Status.UNKNOWN:this.onWebrtcCallReleasing(e)}else this.$log.info("[WebrtcGatewayService] processEvt | process call("+e.id+","+e.status.value+") -> Not a webrtcgateway case")}releaseMediaPillarCallContext(){this.mediaPillarCallContext.callState=n.Free,this.stopCallStateTimeOut(),this.mediaPillarCallContext.isOutgoingCall3PCC=!1,this.mediaPillarCallContext.updateContactFlag=!1,0<this.mediaPillarCallContext.telephonyCallRefs.length&&this.$log.warn("[WebrtcGatewayService] releaseMediaPillarCallContext | reset context but telephonyCallRefs not empty !"),null!==this.mediaPillarCallContext.webrtcCallRef&&this.$log.warn("[WebrtcGatewayService] releaseMediaPillarCallContext | reset context but webrtcCallRef not null !"),this.mediaPillarCallContext.telephonyCallRefs=[],this.mediaPillarCallContext.webrtcCallRef=null,this.mediaPillarCallContext.previousCallConnectionId=null,this.mediaPillarCallContext.previousCallStatus="",this.$log.log("[WebrtcGatewayService] releaseMediaPillarCallContext | =====  mediaPillarCallContext RELEASED  ===== ")}resetEvtAutomaton(){this.evtQueue=[]}stopCallStateTimeOut(){this.mediaPillarCallContext.callState_TO&&this.$interval.cancel(this.mediaPillarCallContext.callState_TO),this.mediaPillarCallContext.callState_TO=null}onRemoteCtrlCall(e,t){this.$log.info("[WebrtcGatewayService] onRemoteCtrlCall for call "+t.id+" in previous state: "+this.mediaPillarCallContext.callState+": => Becomes REMOTECONTROLED"),this.mediaPillarCallContext.callState=n.RemoteControled,this.stopCallStateTimeOut()}addTelCallRefs(e){if(null==e)return void this.$log.warn("[WebrtcGatewayService] addTelCallRefs | ANOMALY callRef not valid");let t=!1;for(var n=0;n<this.mediaPillarCallContext.telephonyCallRefs.length;n++)this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.telephonyCallRefs[n].id===e.id&&(t=!0);t||this.mediaPillarCallContext.telephonyCallRefs.push(e)}removeTelCallRefs(e){if(null!=e)for(let t=0;t<this.mediaPillarCallContext.telephonyCallRefs.length;)this.mediaPillarCallContext.telephonyCallRefs[t].id===e.id?(this.mediaPillarCallContext.telephonyCallRefs.splice(t,1),0===t&&this.mediaPillarCallContext.telephonyCallRefs.length&&(this.mediaPillarCallContext.telephonyCallRefs[0].setMediaPillarCall(this.getMediaPillarCallContext()),this.$log.log("[WebrtcGatewayService] removeTelCallRefs | master MP call becomes : "+this.mediaPillarCallContext.telephonyCallRefs[0].id))):t++;else this.$log.warn("[WebrtcGatewayService] removeTelCallRefs | ANOMALY callRef not valid")}putAsMasterTelCallRefs(e){if(null==e)return void this.$log.warn("[WebrtcGatewayService] putAsMasterTelCallRefs | ANOMALY callRef not valid");let t=-1;for(var n=0;n<this.mediaPillarCallContext.telephonyCallRefs.length;n++)this.mediaPillarCallContext.telephonyCallRefs[n].id===e.id&&(t=n);if(this.$log.log("[WebrtcGatewayService] putAsMasterTelCallRefs | master MP call is : "+e.id),0!==t)if(-1!==t){let n=this.mediaPillarCallContext.telephonyCallRefs[0];this.mediaPillarCallContext.telephonyCallRefs[0]=e,this.mediaPillarCallContext.telephonyCallRefs[t]=n,e.setMediaPillarCall(this.getMediaPillarCallContext())}else this.$log.warn("[WebrtcGatewayService] putAsMasterTelCallRefs | Anomaly call not in telephonyCallRefs")}isMasterTelCallRefs(e){return null==e?(this.$log.warn("[WebrtcGatewayService] isMasterTelCallRefs | ANOMALY callRef not valid"),!1):0!==this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.telephonyCallRefs[0].id===e.id}isInTelCallRefs(e){if(null==e)return void this.$log.warn("[WebrtcGatewayService] isInTelCallRefs | ANOMALY callRef not valid");let t=-1;for(var n=0;n<this.mediaPillarCallContext.telephonyCallRefs.length;n++)this.mediaPillarCallContext.telephonyCallRefs[n].id===e.id&&(t=n);return-1!==t}replaceCallRefs(e,t){if(null==e||null==t)return void this.$log.warn("[WebrtcGatewayService] replaceCallRefs | ANOMALY callRef not valid");let n=!1,r=e.isMediaPillarCall(),i=t.isMediaPillarCall();this.isInTelCallRefs(e)&&(n=!0,this.$log.warn("[WebrtcGatewayService] replaceCallRefs | ANOMALY newcallRef already existing"),this.removeTelCallRefs(e));let a=-1;for(var o=0;o<this.mediaPillarCallContext.telephonyCallRefs.length;o++)this.mediaPillarCallContext.telephonyCallRefs[o].id===t.id&&(a=o);-1===a?(this.$log.warn("[WebrtcGatewayService] replaceCallRefs | ANOMALY oldCallRef not found"),n&&(this.addTelCallRefs(e),r&&e.setMediaPillarCall(this.getMediaPillarCallContext()))):(this.mediaPillarCallContext.telephonyCallRefs[a]=e,i&&e.setMediaPillarCall(this.getMediaPillarCallContext()),t.setMediaPillarCall(null),0===a&&this.$log.log("[WebrtcGatewayService] replaceCallRefs | master MP call becomes : "+this.mediaPillarCallContext.telephonyCallRefs[0].id))}automatonDefenseTimout(t){let r=0;if(null==t)this.mediaPillarCallContext.callState!==n.CallActive&&this.mediaPillarCallContext.callState!==n.CallActiveNoWebMedia&&this.mediaPillarCallContext.callState!==n.RemoteControled&&this.mediaPillarCallContext.callState!==n.CallOffer&&this.mediaPillarCallContext.callState!==n.CallOnGoing&&(this.$log.log("[WebrtcGatewayService] automatonDefenseTimout | anomaly timout in unexpected state"),r=2);else if(t.type.value===this.Call.Type.PHONE.value)switch(this.$log.log("[WebrtcGatewayService] automatonDefenseTimout | transition telcall call="+t.id+" evt="+t.status.value+" then timout"),t.status){case this.Call.Status.RINGING_OUTGOING:case this.Call.Status.RINGING_INCOMMING:break;default:this.mediaPillarCallContext.callState!==n.CallActive&&this.mediaPillarCallContext.callState!==n.CallActiveNoWebMedia&&this.mediaPillarCallContext.callState!==n.CallOffer&&this.mediaPillarCallContext.callState!==n.CallOnGoing&&(r=2)}else if(this.isMediaPillarJid(this.xmppService.getBareJidFromJid(t.fullJid)))switch(this.$log.log("[WebrtcGatewayService] automatonDefenseTimout | transition webrtc "+t.status.value+" then timout"),t.status){case this.Call.Status.ACTIVE:break;default:this.mediaPillarCallContext.callState!==n.CallActive&&this.mediaPillarCallContext.callState!==n.CallActiveNoWebMedia&&this.mediaPillarCallContext.callState!==n.CallOffer&&this.mediaPillarCallContext.callState!==n.CallOnGoing&&(r=3)}else this.$log.warn("[WebrtcGatewayService] automatonDefenseTimout | anomaly transition webrtc call but Not a webrtcgateway case"),r=2;switch(0!=r&&this.$log.warn("[WebrtcGatewayService] automatonDefenseTimout | actionlevel "+r),r){case 0:break;case 1:this.TO_PILLAR_POLLING=e,this.mediaPillarAlive||this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING);break;case 2:this.TO_PILLAR_POLLING=e,this.mediaPillarAlive||this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.releaseMediaPillarCallContext();break;case 3:this.TO_PILLAR_POLLING=e,this.mediaPillarAlive||this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.MediaPillarReleaseWebrtcCall(),this.releaseMediaPillarCallContext();break;default:this.TO_PILLAR_POLLING=e,this.mediaPillarAlive||this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.MediaPillarCallTerminator()}this.mediaPillarCallContext.callState!==n.Free&&(this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(null)},this.TO_transition,1))}onTelCallIncomming(e){if(1<this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.callState!==n.Free&&this.mediaPillarCallContext.callState!==n.WaitTelephony&&this.mediaPillarCallContext.callState!==n.WaitWebrtc)return this.$log.info("[WebrtcGatewayService] onTelCallIncomming | nth calls BUT trig the GUI & link the call"),e.setMediaPillarCall(this.getMediaPillarCallContext()),this.$log.info("[WebrtcGatewayService] onTelCallIncomming | ON_CONVERSATION_CALL_UPDATED_EVENT for call = "+e.id),this.mediaPillarCallContext.updateContactFlag=!0,void this.$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:e});switch(this.$log.info("[WebrtcGatewayService] onTelCallIncomming | mediapilaryse as necessary for call "+e.id),this.mediaPillaryseTheCall(e,null)){case"Ok":if(this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(e)},this.TO_transition,1),!this.isMediaPillarOutgoingCall()&&this.mediaPillarCallContext.callState===n.CallOffer&&this.mediaPillarCallContext.webrtcCallRef)for(var t=0;t<this.mediaPillarCallContext.telephonyCallRefs.length;t++)(this.mediaPillarCallContext.telephonyCallRefs[t].status===this.Call.Status.RINGING_INCOMMING||this.mediaPillarCallContext.telephonyCallRefs[t].status===this.Call.Status.QUEUED_INCOMMING)&&(this.$log.info("[WebrtcGatewayService] onTelCallIncomming | ON_CONVERSATION_CALL_UPDATED_EVENT for call = "+e.id),this.mediaPillarCallContext.updateContactFlag=!0,this.$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:this.mediaPillarCallContext.telephonyCallRefs[t]}));break;case"Update":this.isMediaPillarOutgoingCall()||!this.mediaPillarCallContext.webrtcCallRef||e.status!==this.Call.Status.RINGING_INCOMMING&&e.status!==this.Call.Status.QUEUED_INCOMMING?this.$log.info("[WebrtcGatewayService] onTelCallIncomming | ignore update call"):(this.$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:e}),this.$log.info("[WebrtcGatewayService] onTelCallIncomming | update call"));break;case"Ignore":this.$log.info("[WebrtcGatewayService] onTelCallIncomming | ignore evt");break;default:this.$log.error("[WebrtcGatewayService] onTelCallIncomming | media Pillar call anomaly "+status)}}onTelCallDialling(e){if(this.mediaPillarCallContext.callState===n.Free||this.mediaPillarCallContext.callState===n.WaitTelephony)switch(this.mediaPillarCallContext.isOutgoingCall3PCC=!0,this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(e)},this.TO_transition,1),this.mediaPillaryseTheCall(e,null)){case"Ok":this.mediaPillarCallContext.webrtcCallRef&&this.mediaPillarCallContext.callState===n.CallOffer&&(this.videoService.answerCall(this.mediaPillarCallContext.webrtcCallRef,"audio"),this.$log.info("[WebrtcGatewayService] onTelCallDialling | outgoing3PCC then send webrtc proceed")),this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(e)},this.TO_transition,1);break;case"Ignore":case"Update":this.$log.info("[WebrtcGatewayService] onTelCallDialling | ignore evt");break;default:this.$log.error("[WebrtcGatewayService] onTelCallDialling | media Pillar call anomaly "+status),this.MediaPillarCallTerminator()}else this.mediaPillarCallContext.callState===n.CallOffer||this.mediaPillarCallContext.callState===n.CallOnGoing?(this.$log.warn("[WebrtcGatewayService] onTelCallDialling | media Pillar call anomaly, on state : "+this.mediaPillarCallContext.callState),this.$log.info("[WebrtcGatewayService] onTelCallDialling | ignored , on state : "+this.mediaPillarCallContext.callState)):(this.$log.warn("[WebrtcGatewayService] onTelCallDialling | media Pillar call anomaly, MP context not compatible"),this.MediaPillarCallTerminator())}onTelCallOutgoing(e){this.isMediaPillarOutgoingCall()?(this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(e)},this.TO_transition_long,1)):(this.$log.warn("[WebrtcGatewayService] onTelCallOutgoing | media Pillar, not a 1st 3PCC outgoing call then ignore & release MP CallContext"),this.releaseMediaPillarCallContext())}onTelCallActive(e){switch(this.mediaPillarCallContext.callState){case n.CallOnGoing:this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState=n.CallActive;break;case n.TelCallReleasing:this.$log.warn("[WebrtcGatewayService] onTelCallActive | media Pillar recv tel active on state = "+this.mediaPillarCallContext.callState),this.$log.info("[WebrtcGatewayService] onTelCallActive | media Pillar , RE-ACTIVATION"),this.stopCallStateTimeOut(),e.setMediaPillarCall(this.getMediaPillarCallContext()),this.mediaPillarCallContext.callState=n.CallActive;break;case n.CallActive:this.$log.info("[WebrtcGatewayService] onTelCallActive | media Pillar , ignore tel active on state CallActive ");break;case n.WebCallReleasing:this.$log.info("[WebrtcGatewayService] onTelCallActive | media Pillar recv tel active on state WebCallReleasing then releaseMediaPillarCallContext"),this.releaseMediaPillarCallContext();break;case n.Free:this.$log.info("[WebrtcGatewayService] onTelCallActive | media Pillar recv tel active on state = 1 ; probably call taken on deskphone ; ignore active & release call context "),this.releaseMediaPillarCallContext();break;default:this.$log.info("[WebrtcGatewayService] onTelCallActive | Anomaly media Pillar recv tel active on state = "+this.mediaPillarCallContext.callState)}}onTelCallReleasing(e){return this.telephonyService.getCalls().length,1<this.mediaPillarCallContext.telephonyCallRefs.length?(e.setMediaPillarCall(null),this.removeTelCallRefs(e),void this.$log.info("[WebrtcGatewayService] onTelCallReleasing -- "+e.id+" -- postpone mediaPillarCallContext release ;  remaining calls = "+this.mediaPillarCallContext.telephonyCallRefs.length)):void(this.isMediaPillarReleasableCall()?(e.setMediaPillarCall(null),this.removeTelCallRefs(e),this.mediaPillarCallContext.webrtcCallRef&&this.mediaPillarCallContext.callState!==n.WebCallReleasing&&this.mediaPillarCallContext.callState!==n.RemoteControled?this.mediaPillarCallContext.callState===n.TelCallReleasing?this.$log.info("[WebrtcGatewayService] onTelCallReleasing -- "+e.id+" -- ignore telrelease on state = "+this.mediaPillarCallContext.callState):(this.mediaPillarCallContext.callState=n.TelCallReleasing,this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(e)},this.TO_transition,1),this.$log.info("[WebrtcGatewayService] onTelCallReleasing -- "+e.id+" -- wait web release: state = "+this.mediaPillarCallContext.callState)):this.mediaPillarCallContext.callState!==n.Free&&(this.releaseMediaPillarCallContext(),this.$log.info("[WebrtcGatewayService] onTelCallReleasing -- "+e.id+" -- release MP context"))):(this.$log.warn("[WebrtcGatewayService] onTelCallReleasing | media Pillar call release anomaly on state = "+this.mediaPillarCallContext.callState),this.MediaPillarCallTerminator()))}onWebrtcCallIncomming(e){if(this.mediaPillarCallContext.webrtcCallRef)this.$log.info("[WebrtcGatewayService] onWebrtcCallIncomming -- "+e.id+" --- ignored other incomming");else switch(this.mediaPillaryseTheCall(null,e)){case"Ok":if(this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(e)},this.TO_transition,1),this.isMediaPillarOutgoingCall())this.videoService.answerCall(this.mediaPillarCallContext.webrtcCallRef,"audio"),this.$log.info("[WebrtcGatewayService] onWebrtcCallIncomming | outgoing3PCC then send webrtc proceed");else if(this.mediaPillarCallContext.callState===n.CallOffer)for(var t=0;t<this.mediaPillarCallContext.telephonyCallRefs.length;t++)(this.mediaPillarCallContext.telephonyCallRefs[t].status===this.Call.Status.RINGING_INCOMMING||this.mediaPillarCallContext.telephonyCallRefs[t].status===this.Call.Status.QUEUED_INCOMMING)&&(this.$log.info("[WebrtcGatewayService] onWebrtcCallIncomming | ON_CONVERSATION_CALL_UPDATED_EVENT for call = "+this.mediaPillarCallContext.telephonyCallRefs[t].id),this.$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:this.mediaPillarCallContext.telephonyCallRefs[t]}));break;case"Ignore":break;default:this.$log.error("[WebrtcGatewayService] onWebrtcCallIncomming | media Pillar call anomaly "+status)}}onWebrtcCallConnecting(){this.mediaPillarCallContext.callState===n.CallActive&&(this.$log.info("[WebrtcGatewayService] onWebrtcCallConnecting -- media Pillar call reconnecting"),this.mediaPillarCallContext.callState=n.CallActiveNoWebMedia,this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.timeOutCallActiveNoWebMedia()},this.TO_NoWebMedia,1))}onWebrtcCallActive(){this.mediaPillarCallContext.callState===n.CallActiveNoWebMedia&&(this.$log.info("[WebrtcGatewayService] onWebrtcCallConnecting -- media Pillar call reconnected"),this.mediaPillarCallContext.callState=n.CallActive,this.stopCallStateTimeOut())}onWebrtcCallAnswering(e){this.mediaPillarCallContext.callState=n.CallOnGoing,this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(e)},this.TO_transition,1)}onWebrtcCallReleasing(e){this.isMediaPillarReleasableCall()?(e.setMediaPillarCall(null),this.mediaPillarCallContext.webrtcCallRef=null,0!==this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.callState!==n.TelCallReleasing?this.mediaPillarCallContext.callState===n.WebCallReleasing?this.$log.info("[WebrtcGatewayService] onWebrtcCallReleasing -- "+e.id+" -- ignore webrelease on state = "+this.mediaPillarCallContext.callState):(this.mediaPillarCallContext.callState=n.WebCallReleasing,this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(e)},this.TO_transition,1),this.releasePbxCallIfPbxConnectionDown(),this.$log.info("[WebrtcGatewayService] onWebrtcCallReleasing -- "+e.id+" -- wait tel release: state = "+this.mediaPillarCallContext.callState)):(this.releaseMediaPillarCallContext(),this.$log.info("[WebrtcGatewayService] onWebrtcCallReleasing -- "+e.id+" -- release MP context"))):(this.$log.warn("[WebrtcGatewayService] onWebrtcCallReleasing | media Pillar call release anomaly on state = "+this.mediaPillarCallContext.callState),this.MediaPillarCallTerminator())}releasePbxCallIfPbxConnectionDown(){let e=this.getActivePbxCall();e&&e.pbxConnectionDown&&(this.$log.info("[WebrtcGatewayService] releasePbxCallIfPbxConnectionDown | release call"+e),this.telephonyService.releaseCall(e),e.mediaPillarCall=null)}mediaPillarMakeCall(e,t){this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall");let n=this.getMyMediaPillarJid();if(6<e.length&&t&&(e=t.phonePbx),this.videoService.makingCall=!0,""!==n){var r,i="web_"+this.uuid4.generate();if(t&&null!==t)(r=this.Call.create(this.Call.Status.DIALING,i,this.Call.Type.WEBRTC,t)).fullJid=n,this.mediaPillarStartCall(r,e,n);else(r=this.Call.create(this.Call.Status.DIALING,i,this.Call.Type.WEBRTC,this.mediaPillarContact)).fullJid=n,this.mediaPillarStartCall(r,e,n)}else this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall ANOMALY no mediaPillarJid")}mediaPillarStartCall(e,t,n){this.$log.info("[WebrtcGatewayService] mediaPillarStartCall for phone number "+t),this.initiateMediaPillarCall(e).then(()=>{this.dummyRegisterMediaPillarCall().then(()=>{this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall for number "+t),this.videoService.makeJingleCall(e,n,t)}).catch(()=>{this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall ANOMALY dummyRegisterMediaPillarCall then abort call"),this.abortCall(e)})}).catch(()=>{this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall ANOMALY initiateMediaPillarCall then abort call"),this.abortCall(e)})}abortCall(e){this.videoService.makingCall=!1,e&&this.videoService.removeCallObject(e),this.videoService.resetToSafeState()}initiateMediaPillarCall(e){return this.$q((t,n)=>{this.$log.info("[WebrtcGatewayService] initiateMediaPillarCall");var r=["audio"];this.videoService.getBrowserMedia(r).then(n=>{e.isInitiator=!0,this.videoService.localStreams.push(n),this.videoService.calls[e.id]=e,e.localMedia|=this.Call.Media.AUDIO,this.contactService.setBusyState("dnd",this.videoService.calculatePresenceMessage(e)),this.$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",e),t()}).catch(e=>{this.$log.info("[WebrtcGatewayService]   | initate call failure : "+JSON.stringify({error:e.message})),0<=r.indexOf("sharing")||-1===e.toString().indexOf("getUserMedia")||this.videoService.openErrorPopup(),n(e)})})}dummyRegisterMediaPillarCall(){return this.$q((e,t)=>{var n=$iq({from:this.myContact.fullJid,to:this.mediaPillarCallContext.mediaPillarJid,type:"set"}).c("mediapillar",{xmlns:"urn:xmpp:janus:1"}).c("register").c("jidIm").t(this.contactService.userContact.jid).up().c("jidTel").t(this.contactService.userContact.jidtel).up().c("number").t(this.mediaPillarCallContext.rainbowPhoneNumber).up().c("displayName").t(this.myContact.displayName).up().c("secret").t(this.mediaPillarCallContext.rainbowPhoneNumber).up();this.xmppService.sendIQ(n).then(()=>{e()}).catch(e=>{this.IsMediaPillarUserSelected()&&this.$log.warn("[WebrtcGatewayService] dummyRegisterMediaPillarCall -- register failure -- "+e.message),t(e)})})}getMediaPillarData(){return this.$q((e,t)=>{this.$http({method:"GET",url:this.portalURL+"/data",headers:this.authService.getRequestHeader()}).then(n=>{if(this.$log.log("[WebrtcGatewayService] getMediaPillarData success"),n.data&&n.data.data){let t=n.data.data.prefix,r=n.data.data.rainbowPhoneNumber;t&&r&&(this.mediaPillarCallContext.rainbowPhoneNumber=r,this.mediaPillarCallContext.remoteExtension=t+r);let i=n.data.data.jid_im;i&&-1===i.indexOf("/")&&(i+="/mediapillar"),e(i)}else this.$log.error("[WebrtcGatewayService] getMediaPillarData success -- missing data"),t(new Error("[WebrtcGatewayService] getMediaPillarData -- missing data in response"))}).catch(e=>{let n=this.errorHelperService.handleError(e);this.$log.info("[WebrtcGatewayService] getMediaPillarData error -- "+n.message),t(n)})})}mediaPillarKeepAlivePolling(e,t){this.started&&("START"===e?(this.mediaPillarCallContext&&this.mediaPillarCallContext.keepAlive_TO&&(this.$interval.cancel(this.mediaPillarCallContext.keepAlive_TO),this.mediaPillarCallContext.keepAlive_TO=null),this.mediaPillarCallContext.keepAlive_TO=this.$interval(()=>{this.mediaPillarKeepAlive()},t,1)):"STOP"===e?(this.mediaPillarCallContext&&this.mediaPillarCallContext.keepAlive_TO&&this.$interval.cancel(this.mediaPillarCallContext.keepAlive_TO),this.mediaPillarCallContext.keepAlive_TO=null):this.$log.error("[WebrtcGatewayService] mediaPillarKeepAlivePolling cmd error : "+e))}mediaPillarUserSelectAndPolling(e){this.started&&(this.$log.log("[WebrtcGatewayService] mediaPillarUserSelectAndPolling : "+e),e?(this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.mediaPillarKeepAlive()):this.mediaPillarAlive&&this.mediaPillarKeepAlivePolling("STOP",0))}mediaPillarKeepAlive(){if(this.$log.info("[WebrtcGatewayService] mediaPillarKeepAlive"),this.mediaPillarKeepAliveSuspend)this.$log.info("[WebrtcGatewayService] KeepAlive suspended");else{let n=!1;this.dummyRegisterMediaPillarCall().then(()=>{n=!0,this.$log.info("[WebrtcGatewayService] mediaPillarKeepAlive webrtcgateway is UP")}).catch(()=>{n=!1,this.$log.info("[WebrtcGatewayService] mediaPillarKeepAlive webrtcgateway is DOWN")}).finally(()=>{this.mediaPillarAlive!==n&&(this.mediaPillarAlive=n,this.$rootScope.$broadcast("ON_WEBRTCGATEWAY_STATE_CHG",this.mediaPillarAlive),this.$log.info("[WebrtcGatewayService] mediaPillarKeepAlive ON_WEBRTCGATEWAY_STATE_CHG")),this.mediaPillarAlive?this.TO_PILLAR_POLLING<t?this.TO_PILLAR_POLLING+=t/500:this.TO_PILLAR_POLLING=t:(this.TO_PILLAR_POLLING=e,this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING)),this.IsMediaPillarUserSelected()&&this.mediaPillarAlive&&this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING)})}}forceMPpooling(){this.started&&(this.$log.log("[WebrtcGatewayService] forceMPpooling "),this.TO_PILLAR_POLLING=e,this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.$rootScope.$broadcast("ON_WEBRTCGATEWAY_STATE_CHG",this.mediaPillarAlive))}getMyMediaPillarJid(){return this.$log.info("[WebrtcGatewayService] getMyMediaPillarJid : "+this.mediaPillarCallContext.mediaPillarJid),this.mediaPillarCallContext.mediaPillarJid}getMyMediaPillarRemoteExtension(){return this.mediaPillarCallContext.remoteExtension}shouldUseMediaPillar(){this.isMediaPillarAvailable()&&this.IsMediaPillarUserSelected();return void 0!==config.devMediaPillarEnabled&&config.devMediaPillarEnabled||!1,!1}isMediaPillarConfigured(){return this.mediaPillarConfigured&&this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.TELEPHONY_WEBRTC_PSTN_CALLING)}isMediaPillarAvailable(){var e=this.isMediaPillarConfigured();return e=e&&this.mediaPillarAlive}IsMediaPillarUserSelected(){return!this.telephonyService.nomadicObject.makeCallInitiatorIsMain&&this.telephonyService.getNomadicDestination()===this.getMyMediaPillarRemoteExtension()}isMediaPillarJid(e){let t=-1;return!!e&&0===(t=e.search("mp_"))}isMediaPillarCallCase(){return this.isMediaPillarAvailable()&&this.IsMediaPillarUserSelected()}isMediaPillarCallSituation(e){var t=this.isMediaPillarCallCase();if(e)if(e.type===this.Call.Type.WEBRTC)t=t&&this.isMediaPillarJid(e.fullJid);else if(1>=this.telephonyService.getCalls().length&&1>=this.mediaPillarCallContext.telephonyCallRefs.length)switch(e.status){case this.Call.Status.RINGING_INCOMMING:case this.Call.Status.RINGING_OUTGOING:case this.Call.Status.QUEUED_INCOMMING:case this.Call.Status.DIALING:case this.Call.Status.RELEASING:break;default:t=!!e.mediaPillarCall&&t&&this.isInTelCallRefs(e)}else switch(e.status){case this.Call.Status.RINGING_INCOMMING:case this.Call.Status.RINGING_OUTGOING:case this.Call.Status.QUEUED_INCOMMING:case this.Call.Status.DIALING:case this.Call.Status.RELEASING:break;default:e.mediaPillarCall?t=(t=t&&1<=e.mediaPillarCall.telephonyCallRefs.length)&&this.isInTelCallRefs(e):t=!1}return t}mediaPillaryseTheCall(e,t){if(this.mediaPillarCallContext.callState!==n.Free){if(e&&this.mediaPillarCallContext.updateContactFlag)return this.$log.info("[WebrtcGatewayService] mediaPillaryseTheCall | only Update"),"Update";if(t&&this.mediaPillarCallContext.callState!==n.WaitWebrtc)return this.$log.info("[WebrtcGatewayService] mediaPillaryseTheCall | only Ignore"),"Ignore"}var r="";if(!e&&!t)return"NoCallRef";if(e&&t)return"toManyCallRef";if(e){switch(this.mediaPillarCallContext.callState){case n.Free:this.mediaPillarCallContext.callState=n.WaitWebrtc,r="Ok";break;case n.WaitTelephony:this.mediaPillarCallContext.callState=n.CallOffer,r="Ok";break;default:this.mediaPillarCallContext.callState=n.AnomalyCCS,r="Ano_inTel_contextCallState_"+this.mediaPillarCallContext.callState}"Ok"==r&&(this.putAsMasterTelCallRefs(e),e.setMediaPillarCall(this.getMediaPillarCallContext()))}else if(t){switch(this.mediaPillarCallContext.webrtcCallRef=t,this.mediaPillarCallContext.callState){case n.Free:this.mediaPillarCallContext.callState=n.WaitTelephony,r="Ok";break;case n.WaitWebrtc:this.mediaPillarCallContext.callState=n.CallOffer,r="Ok";break;default:this.mediaPillarCallContext.callState=n.AnomalyCCS,r="Ano_inWrtc_contextCallState_"+this.mediaPillarCallContext.callState}"Ok"==r&&t.setMediaPillarCall(this.getMediaPillarCallContext())}return r}getMediaPillarCallContext(){return this.mediaPillarCallContext}isMediaPillarOutgoingCall(){var e;switch(this.mediaPillarCallContext.callState){case n.WaitWebrtc:case n.WaitTelephony:case n.CallOffer:case n.CallOnGoing:case n.CallActive:case n.CallActiveNoWebMedia:case n.TelCallReleasing:case n.WebCallReleasing:e=!0;break;default:e=!1}return e&&this.mediaPillarCallContext.isOutgoingCall3PCC}isMediaPillarReleasableCall(){var e;switch(this.mediaPillarCallContext.callState){case n.AnomalyCCS:case n.Unknow:e=!1;break;default:e=!0}return e}MediaPillarReleaseWebrtcCall(){this.mediaPillarCallContext.webrtcCallRef&&(this.mediaPillarCallContext.webrtcCallRef.mediaPillarCall=null,this.videoService.releaseCall(this.mediaPillarCallContext.webrtcCallRef))}timeOutCallActiveNoWebMedia(){this.$log.info("[WebrtcGatewayService] timeOutCallActiveNoWebMedia"),this.mediaPillarCallContext.callState===n.CallActiveNoWebMedia&&(this.MediaPillarCallTerminator(),this.mediaPillarKeepAlive(),this.$log.info("[WebrtcGatewayService] timeOutCallActiveNoWebMedia noWebMedia then release calls if existing & force keepalive"))}MediaPillarCallTerminator(){0!==this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.telephonyCallRefs.forEach(e=>{null!==e&&e.type.value===this.Call.Type.PHONE.value&&(e.mediaPillarCall=null,this.telephonyService.releaseCall(e),this.$log.info("[WebrtcGatewayService] MediaPillarCallTerminator | release call"+e))}),this.MediaPillarReleaseWebrtcCall(),this.releaseMediaPillarCallContext(),this.resetEvtAutomaton(),this.TO_PILLAR_POLLING+=e,this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.$log.warn("[WebrtcGatewayService] MediaPillarCallTerminator | Full cleaning")}createMediaPillarContact(e){this.$log.info("[webrtcGatewayService] createMediaPillarContact -- "+e);let t=this.contactService.createBasicContact(e);return t.displayName="mediaPillar",t.avatar=new Image,t.avatar.src="/resources/skins/rainbow/images/conversations/unknownContact.png",t}muteAudio(e,t,n){if(e){if(this.isMediaPillarCallSituation(e)){let i=this.mediaPillarCallContext.webrtcCallRef;if(i){var r=this.xmppService.connection.jingle.sessions[i.id];if(r){r.muteAudio(t),e.isMuted=t,n&&(n.isMutedAudio=t),this.$log.info("[webrtcGatewayService] muteAudio conversation: "+(n?n.id:"undefined")+" / call: "+e.id+"-- "+(t?"mute":"unumute"));let i={call:e};n&&(i.conversation=n),this.$rootScope.$broadcast("ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT",i)}else this.$log.error("[webrtcGatewayService] muteAudio "+e.id+" -- failure: no session")}}}else this.$log.error("[webrtcGatewayService] muteAudio - trying to mute a non existing call !")}getActivePbxCall(){return this.isMediaPillarCallCase()&&this.mediaPillarCallContext?this.mediaPillarCallContext.telephonyCallRefs.find(e=>e.status===this.Call.Status.ACTIVE):null}}r.$inject=["$q","$rootScope","$log","$http","authService","$interval","xmppService","videoService","errorHelperService","contactService","profileService","Call","uuid4","telephonyService","settingsService"],angular.module("rainbow").service("webrtcGatewayService",r)},function(){angular.module("rainbow").service("callLogService",["$q","$log","$rootScope","$interval","contactService","xmppService","CallLog","orderByFilter","profileService","$injector","telephonyService","webrtcGatewayService",function(e,t,n,r,i,a,o,s,c,l,d,u){"use strict";var h=this;this.started=!1,this.callLogs=[],this.orderByNameCallLogs=[],this.orderByDateCallLogs=[],this.orderByDateCallLogsBruts=[],this.simplifiedCallLogs=[],this.callLogsPromises=[],this.callLogNamespace="jabber:iq:telephony:call_log",this.callLogAckNamespace="urn:xmpp:telephony:call_log:receipts",this.callLogNotificationsNamespace="jabber:iq:notification:telephony:call_log",this.callLogHandlerRef=null,this.callLogMessageAckRef=null,this.callLogNotificationRef=null,this.numberMissedCalls=0,this.lastTimestamp=null,this.callLogsHistory=[],this.telephonyCallLog={},this.telephonyCallLogHistory={},this.deferedObject=null,this.callLogComplete=!1,this.callLogIndex=-1,this.start=function(n){return t.info(""),t.info("[callLogService] === STARTING ==="),this.attachHandlers(),r(function(){var e=performance.now();h.getCallLogHistoryPage().then(function(){var r=Math.round(performance.now()-e);n.push({service:"callLogService",startDuration:r}),t.info("[callLogService] === STARTED ("+r+" ms) ==="),h.started=!0}).catch(function(){t.error("[callLogService] === STARTING FAILURE ===")})},3e3,1,!0),e.when()},this.stop=function(){return t.info("[callLogService] Stopping"),this.started=!1,this.callLogs=[],this.callLogsPromises=[],this.callLogHandlerRef=null,this.callLogMessageAckRef=null,this.orderByNameCallLogs=[],this.orderByDateCallLogs=[],this.orderByDateCallLogsBruts=[],this.simplifiedCallLogs=[],this.numberMissedCalls=0,this.lastTimestamp=null,this.telephonyCallLog={},this.telephonyCallLogHistory={},this.callLogComplete=!1,this.callLogIndex=-1,this.callLogsHistory=[],t.info("[callLogService] Stopped"),e.when()},this.attachHandlers=function(){t.info("[callLogService] attachHandlers"),h.callLogHandlerRef&&(a.connection.deleteHandler(h.callLogHandlerRef),h.callLogHandlerRef=null),h.callLogMessageAckRef&&(a.connection.deleteHandler(h.callLogMessageAckRef),h.callLogMessageAckRef=null),h.callLogNotificationRef&&(a.connection.deleteHandler(h.callLogNotificationRef),h.callLogNotificationRef=null),h.callLogHandlerRef=a.connection.addHandler(h.onCallLogMessageReceived,h.callLogNamespace,null,null),h.callLogMessageAckRef=a.connection.addHandler(h.onCallLogAckReceived,h.callLogAckNamespace,null,null),h.callLogNotificationRef=a.connection.addHandler(h.callLogNotificationReceived,h.callLogNotificationsNamespace,null,null),h.started&&h.lastTimestamp&&r(function(){h.getCallLogHistoryPage(h.lastTimestamp)},1e3,1,!0)},this.getCallLogHistoryPage=function(n){t.info("[callLogService] getCallLogHistoryPage");var r=i.userContact,o=$iq({from:r.jid,type:"set"}).c("query",{xmlns:this.callLogNamespace});return o.c("set",{xmlns:"http://jabber.org/protocol/rsm"}),o.c("max").t(75).up(),n?o.c("after").t(n).up():o.c("before").t("").up(),o.up(),o.up(),a.sendIQ(o),e.when()},this.deleteOneCallLog=function(e){t.info("[callLogService] deleteOneCallLog "+e);var n=i.userContact,r=$iq({from:n.jid,to:n.jid,type:"set"}).c("delete",{xmlns:this.callLogNamespace,call_id:e});a.sendIQ(r)},this.deleteCallLogsForContact=function(e){t.info("[callLogService] deleteCallLogsForContact "+e);var n=i.userContact,r=$iq({from:n.jid,to:n.jid,type:"set"}).c("delete",{xmlns:this.callLogNamespace,peer:e});a.sendIQ(r)},this.deleteAllCallLogs=function(){t.info("[callLogService] deleteAllCallLogs");var e=i.userContact,n=$iq({from:e.jid,to:e.jid,type:"set"}).c("delete",{xmlns:this.callLogNamespace});a.sendIQ(n)},this.markCallLogAsRead=function(e){t.info("[callLogService] markCallLogAsRead "+e);var n=i.userContact,r=$msg({from:n.jid,to:n.jid}).c("read",{xmlns:this.callLogAckNamespace,call_id:e});a.sendIQ(r)},this.markAllCallsLogsAsRead=function(){t.info("[callLogService] markAllCallsLogsAsRead ");for(var e=i.userContact,n=0;n<h.callLogs.length;n++)if(!h.callLogs[n].read){var r=$msg({from:e.jid,to:e.jid}).c("read",{xmlns:this.callLogAckNamespace,call_id:h.callLogs[n].id});a.sendIQ(r)}},this.onCallLogMessageReceived=function(r){try{0<$(r).find("call_log").length?h.callLogsPromises.push(h.createCallLogFromMessage(r)):0<$(r).find("count").length&&0<$(r).find("query").length?(h.lastTimestamp=$(r).find("last").text(),t.info("[callLogService] onCallLogMessageReceived : all call logs received"),e.all(h.callLogsPromises).finally(function(){t.info("[callLogService] onCallLogMessageReceived : all call logs are ready"),h.callLogsPromises=[],h.orderCallLogsFunction(),n.$broadcast("ON_CALL_LOG_UPDATED");var e=h.getMissedCallLogCounter();e!==h.numberMissedCalls&&(h.numberMissedCalls=e,n.$broadcast("ON_CALL_LOG_ACK_UPDATED"))})):t.info("[callLogService] onCallLogMessageReceived : ignored !")}catch(e){return t.error("[callLogService] onCallLogMessageReceived "+e),!0}return!0},this.onCallLogAckReceived=function(e){try{if(t.info("[callLogService] onCallLogAckReceived"),0<$(e).find("read").length){var r=$(e).find("read").attr("call_id");h.callLogAckUpdate(r);var i=h.getMissedCallLogCounter();i!==h.numberMissedCalls&&(h.numberMissedCalls=i,n.$broadcast("ON_CALL_LOG_ACK_UPDATED"))}}catch(e){return t.error("[callLogService] onCallLogAckReceived "+e),!0}return!0},this.callLogNotificationReceived=function(r){t.info("[callLogService] callLogNotificationReceived");try{if(0<$(r).find("deleted_call_log").length){t.info("[callLogService] callLogNotificationReceived : deleted IQ");var i=$(r).find("deleted_call_log").attr("peer");i?h.removeCallLogsForUser(i):h.resetCallLogs()}else 0<$(r).find("updated_call_log").length&&(t.info("[callLogService] callLogNotificationReceived : Update call-logs"),h.callLogsPromises.push(h.createCallLogFromMessage(r)),e.all(h.callLogsPromises).finally(function(){t.info("[callLogService] callLogNotificationReceived : update is done"),h.callLogsPromises=[],h.orderCallLogsFunction(),n.$broadcast("ON_CALL_LOG_UPDATED");var e=h.getMissedCallLogCounter();e!==h.numberMissedCalls&&(h.numberMissedCalls=e,n.$broadcast("ON_CALL_LOG_ACK_UPDATED"))}))}catch(e){return t.error("[callLogService] callLogNotificationReceived ERROR "+e),!0}return!0},this.removeCallLogsForUser=function(e){e.endsWith("@_")&&(e=e.substring(0,e.length-2)),t.info("[callLogService] removeCallLogsForUser with jid: "+e);for(var r=[],i=0;i<h.callLogs.length;i++)h.callLogs[i].contact&&(h.callLogs[i].contact.jid===e||h.callLogs[i].contact.id===e)||r.push(h.callLogs[i]);h.callLogs=r,h.orderCallLogsFunction(),n.$broadcast("ON_CALL_LOG_UPDATED");var a=h.getMissedCallLogCounter();a!==h.numberMissedCalls&&(h.numberMissedCalls=a,n.$broadcast("ON_CALL_LOG_ACK_UPDATED"))},this.createCallLogFromMessage=function(n){var r=e.defer(),a=$(n),s=null,f=null,p="",m=a.find("call_id").text(),v=a.find("caller").text(),g=a.find("callee").text(),C=a.find("state").text(),S=parseInt(a.find("duration").text(),10),E=a.find("subject").text(),b="",y="",R="",T="webrtc";if(v&&-1!==v.indexOf("janusgateway")||g&&-1!==g.indexOf("janusgateway"))return t.info("[callLogService] createCallLogFromMessage ignore janusgateway call-logs"),void e.when();if(v&&u.isMediaPillarJid(v)||g&&u.isMediaPillarJid(g))return t.info("[callLogService] createCallLogFromMessage ignore janusgateway call-logs"),void e.when();var I=a.find("call_log").attr("type");I||(I=a.find("type").text());var A="true"===a.find("ack").attr("read"),N=a.find("delay").attr("stamp"),O="conference"===a.find("call_log").attr("service");return(c.isFeatureEnabled(c.FeaturesEnum.TELEPHONY_PHONE_BOOK)||config.permitSearchFromPhoneBook)&&(b=a.find("identity")),S=0<S?moment.duration(S,"ms").format("h[H] mm[m] ss[s]"):0,N&&(N=new Date(N)),O?(s=v,T="conference",p=i.isUserContactJid(v)?"outgoing":"incoming",-1===s.indexOf("@")&&(f=s,s=null)):("phone"===I&&(T="telephone"),i.isUserContactJid(v)?(s=g,p="outgoing"):(s=v,p="incoming"),-1===s.indexOf("@")&&(f=s,s=null,T="telephone")),s||f?i.getOrCreateContact(s,f).then(function(e){if(t.info("[callLogService] createCallLogFromMessage otherParticipant jid:"+s+"  Number:"+f+" => contact retrieved (temp:"+e.temp+")"),!O&&!s&&e.temp){if(b&&b.length){var n=b.attr("firstName"),i=b.attr("lastName"),a=b.attr("displayName");y=n||"",""===(R=i||"")&&""===y&&a&&0!==a.length&&a!==f&&(R=a),(y.length||R.length)&&(t.debug("[callLogService] createCallLogFromMessage  xNames updated from directories for contact "+e.id),e.updateName(y,R))}else try{l.get("centralizedService").outlook.updateContactFromOutlookInfos(e,f,!0).then(function(n){n?t.debug("[callLogService] createCallLogFromMessage  xNames updated from outlook for contact "+e.id):t.debug("[callLogService] createCallLogFromMessage no update from outlook for contact :"+e.id)},function(){t.debug("[callLogService] createCallLogFromMessage  no Outlook search available")})}catch(e){}var c=!1;if(d.started)c=e.displayName.match(/^[0-9A-D #\-\+\*\(\)\.\/]{1,32}$/)&&d.startAsPhoneNumber(e.displayName);c&&e.phoneProCan&&""!==e.phoneProCan&&(e.displayName=e.phoneProCan)}var u=o.create(m,e,C,S,T,A,N,p,E);h.logAlreadyExists(u)||"failed"===C||"ongoing"===C?t.info("[callLogService] createCallLogFromMessage ignore call log with id: "+m+", state: "+C):h.callLogs.push(u),t.info("[callLogService] createCallLogFromMessage success"),r.resolve(u)}).catch(function(e){t.error("[callLogService] createCallLogFromMessage error "+e),r.resolve()}):(t.info("[callLogService] createCallLogFromMessage  No jid or no phoneNumber "),r.resolve()),r.promise},this.getOrderByNameCallLogs=function(){return h.orderByNameCallLogs},this.getOrderByDateCallLogs=function(){return 0!==h.orderByDateCallLogs.length&&(h.orderByDateCallLogs[0].isLatestCall=!0,h.orderByDateCallLogs[1]&&(h.orderByDateCallLogs[1].isLatestCall=!1)),h.orderByDateCallLogs},this.getOrderByDateCallLogsBruts=function(){return h.orderByDateCallLogsBruts},this.getSimplifiedCallLogs=function(){return h.simplifiedCallLogs},this.orderCallLogsFunction=function(){t.info("[callLogService] orderByFunction"),h.orderByNameCallLogs=s(h.callLogs,o.getNames,!1,o.sortByContact),h.orderByDateCallLogsBruts=s(h.callLogs,o.getDate,!1,o.sortByDate),h.simplifiedCallLogs=h.simplifyCallLogs(h.orderByDateCallLogsBruts),h.orderByNameCallLogs=h.fusionInformation(h.orderByNameCallLogs),h.orderByDateCallLogs=h.fusionInformation(h.orderByDateCallLogsBruts)},this.simplifyCallLogs=function(e){for(var t=[],n=0;n<e.length;n++)t[n]={},t[n].contact=e[n].contact.id,t[n].contactDisplayName=e[n].contact.displayName,t[n].contactInitials=e[n].contact.initials,t[n].id=e[n].id,t[n].state=e[n].state,t[n].duration=e[n].duration,t[n].direction=e[n].direction,t[n].type=e[n].type,t[n].read=e[n].read,t[n].date=e[n].date;return t},this.fusionInformation=function(e){for(var t={},n=0,r=[],i=0;i<e.length;i++){var a=e[i],o=a.contact.jid;if(a.contact.jid||(o=a.contact.id),"conference"!==a.type)if(0!==i)if(t[o]){var s=r[t[o]-1];s.editable&&(s.isMissed&&"missed"===a.state&&"incoming"===a.direction?s.count++:s.isNotAnswered&&"missed"===a.state&&"outgoing"===a.direction?s.count++:s.editable=!1)}else n++,t[o]=n+1,r[n]=a,r[n].count=1,r[n].editable=!0,"missed"===a.state&&"incoming"===a.direction?r[n].isMissed=!0:"missed"===a.state&&"outgoing"===a.direction&&(r[n].isNotAnswered=!0);else t[o]=1,r[n]=a,r[n].count=1,r[n].editable=!0,"missed"===a.state&&"incoming"===a.direction?r[n].isMissed=!0:"missed"===a.state&&"outgoing"===a.direction&&(r[n].isNotAnswered=!0);else 0!==i&&n++,r[n]=a,r[n].count=1,r[n].editable=!1}return r},this.callLogAckUpdate=function(e){h.callLogs.forEach(function(t){t.id!==e||(t.read=!0)})},this.getMissedCallLogCounter=function(){var e=0;return h.callLogs.forEach(function(t){t.read||"missed"!==t.state||"incoming"!==t.direction||e++}),e},this.getNumberMissedCalls=function(){return h.numberMissedCalls},this.resetCallLogs=function(){t.info("[callLogService] resetCallLogs"),h.callLogs=[],h.getCallLogHistoryPage()},this.logAlreadyExists=function(e){var t;for(t=0;t<h.callLogs.length;t++)if(h.callLogs[t].id===e.id)return!0;return!1}}])},function(){angular.module("rainbow").service("videoService",["$q","$rootScope","$window","$log","$http","$interval","xmppService","contactService","Call","browserService","gRTCStatsService","fRTCStatsService","platformService","gaService","settingsService","authService","VideoServiceEventHandler","extensionSharingService",function(e,t,n,r,i,a,o,s,c,l,d,u,h,f,p,m,v,g){"use strict";var C=this;this.started=!1,this.connected=!1,this.RTC=null,this.videoEventHandler=null,this.config=null,this.calls={},this.localStream=null,this.autoreleaseTimeout=null,this.callsStats={},this.localStreams=[],this.makingCall=!1,this.reconnectCall=!1,this.statsInterval=null,this.audioProfileChanging=!1,this.reverseAudioCallInitiated=!1,this.alreadyAttaching=!1;var S=[];this.callsStatsSimplified={},this.allowDesktopSharing=function(){return!1},this.allowAdvancedDesktopSharing=function(){return!1},this.getDesktopSharingSource=function(){return null},this.askToAddSharing=function(){return!1},this.askToStartSharing=function(){return!1},this.start=function(n){r.webrtc("[videoService] SERVICE | === STARTING ===");var i=performance.now();if(this.RTC=C.getBrowserMethodHandler(),this.RTC){C.started=!0,C.connected=!0,C.setWebrtcConfiguration();var a=Math.round(performance.now()-i);n.push({service:"videoService",startDuration:a}),r.info("[videoService] SERVICE | === STARTED ("+a+" ms) ===")}else r.error("[videoService] SERVICE | === STARTING FAILURE ===  webRTC capable browser is really required !");return S.push(t.$on("ON_CONNECTION_STATE_CHANGE_EVENT",C.onConnectionStateChangeEvent)),S.push(t.$on("ON_INPUT_DEVICE_CHANGED_EVENT",C.onAudioProfileChangeEvent)),S.push(t.$on("ON_VIDEO_INPUT_DEVICE_CHANGED_EVENT",C.onVideoInputChangeEvent)),this.attachHandlers(),e.when()},this.stop=function(){try{if(this.started){r.webrtc("[videoService] SERVICE | === STOPPING ==="),this.started=!1;for(var t;t=S.pop();)t();for(var n in C.removeHandlers(),C.config=null,C.calls)if(C.calls.hasOwnProperty(n)){var i=C.calls[n];C.removeCallObject(i)}o.connection.jingle.terminate(),C.connected=!1,C.reconnectCall=!1,C.makingCall=!1,C.statsInterval&&window.clearInterval(C.statsInterval),r.webrtc("SERVICE | === STOPPED ===")}return e.when()}catch(t){return r.webrtc("[videoService] SERVICE | === STOPPING ERROR : "+t),e.when()}},this.attachHandlers=function(){this.removeHandlers(),r.info("[videoService] attachHandlers"),this.videoEventHandler=v.create(this)},this.removeHandlers=function(){r.info("[videoService] removeHandlers"),this.videoEventHandler&&(this.videoEventHandler=null)},this.setWebrtcConfiguration=function(){return r.webrtc("[videoService] setWebrtcConfiguration"),e(function(e,t){C.config?(r.webrtc("[videoService] setWebrtcConfiguration from stored variable"),o.connection.jingle.ice_config=C.config,e()):(r.webrtc("[videoService] setWebrtcConfiguration from server"),C.getIceConfig().then(function(t){C.config=t,o.connection.jingle.ice_config=C.config,p.setIceConfig(C.config),r.webrtc("[videoService] setWebrtcConfiguration from server success !"),e()}).catch(function(e){r.error("[videoService] setWebrtcConfiguration from server ERROR : "+e),-1!==e.status&&C.openErrorPopup("IceConfigurationFailed"),t()}))})},this.onConnectionStateChangeEvent=function(e,n){try{if("disconnected"===n){for(var i in r.info("MEDIA   | onConnectionStateChangeEvent : disconnected"),C.connected=!1,C.config=null,C.calls)if(C.calls.hasOwnProperty(i)){var a=C.calls[i];C.reconnectCall=!0,a&&a.status!==c.Status.UNKNOWN&&(r.webrtc("INFO    | onConnectionStateChangeEvent : disconnected -> call goes to connecting state"),a.setStatus(c.Status.CONNECTING),t.$broadcast("ON_CALL_UPDATED_EVENT",a)),C.statsInterval&&window.clearInterval(C.statsInterval)}}else if("connected"===n){for(var i in r.info("MEDIA   | onConnectionStateChangeEvent : connected"),C.attachHandlers(),C.setWebrtcConfiguration(),C.connected=!0,C.statsInterval&&(window.clearInterval(C.statsInterval),C.statsinterval=null),C.calls)if(C.calls.hasOwnProperty(i)){a=C.calls[i];var l=o.connection.jingle.sessions[a.id];C.reconnectCall&&l&&l.peerconnection&&(r.info("MEDIA   | onConnectionStateChangeEvent : connected - start reconnection on session "+a.id),l.me=s.userContact.fullJid,l.isInitiator&&(l.initiator=l.me),l.connection=o.connection,s.setBusyState("dnd",C.calculatePresenceMessage(a)),l.sendTransportReplace())}C.reconnectCall=!1}}catch(e){r.info("MEDIA   | onConnectionStateChangeEvent : disconnected error : "+e)}},C.isUserContactInCall=function(){for(var e in C.calls)if(C.calls.hasOwnProperty(e)){if(C.calls[e].status!==c.Status.UNKNOWN)return!0}return!1},this.getCurrentActiveSession=function(){for(var e in C.calls)if(C.calls.hasOwnProperty(e)){var t=C.calls[e];if(t.status!==c.Status.UNKNOWN)return o.connection.jingle.sessions[t.id]}return null},C.getMediaPillarAudioCall=function(){for(var e in C.calls)if(C.calls.hasOwnProperty(e)){var t=C.calls[e];if(t.status!==c.Status.UNKNOWN&&t.localMedia&c.Media.AUDIO&&t.isMediaPillarCall())return t}return null},C.getMediaPillarSession=function(){var e=C.getMediaPillarAudioCall();return e?o.connection.jingle.sessions[e.id]:null},C.getCurrentSharingCall=function(){for(var e in C.calls)if(C.calls.hasOwnProperty(e)){var t=C.calls[e];if(t.status!==c.Status.UNKNOWN&&(t.localMedia===c.Media.SHARING||t.remoteMedia===c.Media.SHARING))return t}return null},C.endAllCallsForContact=function(e){if(e)for(var t in r.webrtc("[videoService] endAllCallsForContact "+e.jid),C.calls)if(C.calls.hasOwnProperty(t)){var n=C.calls[t];n.status!==c.Status.UNKNOWN&&n.contact&&n.contact.jid===e.jid&&C.releaseCall(n)}},C.onVideoInputChangeEvent=function(){for(var e in r.webrtc("MEDIA   | onVideoInputChangeEvent"),C.calls)if(C.calls.hasOwnProperty(e)){var t=C.calls[e];o.connection.jingle.sessions[t.id]&&t.localMedia&&t.localMedia===c.Media.AUDIO+c.Media.VIDEO&&(r.webrtc("MEDIA   | audio + video call, renegotiate the profile"),C.escalateToVideoCall(t,!0))}},C.onAudioProfileChangeEvent=function(){if(r.webrtc("MEDIA   | onAudioProfileChangeEvent"),C.audioProfileChanging)r.webrtc("MEDIA   | onAudioProfileChangeEvent -- already changing");else for(var e in C.calls)if(C.calls.hasOwnProperty(e)){var t=C.calls[e];o.connection.jingle.sessions[t.id]&&t.localMedia&&(C.audioProfileChanging=!0,a(function(e){C.audioProfileChanging=!1,C.renegotiateCurrentCall(e)},500,1,!0,t))}},this.renegotiateCurrentCall=function(e){e.localMedia===c.Media.AUDIO||e.localMedia===c.Media.AUDIO+c.Media.SHARING?(r.webrtc("MEDIA   | renegotiate the audio profile"),C.addAudioToCall(e,!0)):(e.localMedia===c.Media.AUDIO+c.Media.VIDEO||e.localMedia===c.Media.AUDIO+c.Media.SHARING+c.Media.VIDEO)&&(r.webrtc("MEDIA   | audio + video call, renegotiate the profile"),C.addVideoToCall(e,!0))},this.getCallByJid=function(e){var t=null;if(!e)return t;for(var n in r.webrtc("[videoService] getCallByJid "+e),C.calls)if(C.calls.hasOwnProperty(n)){var i=C.calls[n];if(i.contact&&i.contact.jid===e){t=i;break}}return t},this.resetAudioOutputElement=function(){return!h.allowDevicesManagement()||this.audioProfileChanging?void 0:$("#globalAudioTag").length?(r.webrtc("[videoService] resetAudioOutputElement"),this.audioProfileChanging=!0,void h.getCurrentSpeaker().then(function(e){var t="default";e&&e.id&&(t=e.id);var n="default";"default"!==t&&DetectRTC.audioOutputDevices.forEach(function(e){"default"!==e.deviceId&&"communications"!==e.deviceId&&e.deviceId!==t&&(n=e.deviceId)}),$("#globalAudioTag")[0].setSinkId(n).then(function(){r.webrtc("[videoService] resetAudioOutputElement sinkId is "+$("#globalAudioTag")[0].sinkId),"default"===t?C.audioProfileChanging=!1:$("#globalAudioTag")[0].setSinkId(t).then(function(){r.webrtc("[videoService] resetAudioOutputElement sinkId is "+$("#globalAudioTag")[0].sinkId),C.audioProfileChanging=!1,$("#globalAudioTag")[0].load&&$("#globalAudioTag")[0].load()}).catch(function(){C.audioProfileChanging=!1})}).catch(function(e){r.warn("[videoService] resetAudioOutputElement globalAudioTag error "+e),C.audioProfileChanging=!1}),a(function(){$("#largevideo")[0]&&$("#largevideo")[0].setSinkId(n).then(function(){r.webrtc("[videoService] resetAudioOutputElement largevideo "+$("#largevideo")[0].sinkId),"default"!==t&&$("#largevideo")[0].setSinkId(t).then(function(){r.webrtc("[videoService] resetAudioOutputElement largevideo "+$("#largevideo")[0].sinkId)}).catch(function(e){r.warn("[videoService] resetAudioOutputElement largevideo error "+e)})}).catch(function(e){r.warn("[videoService] resetAudioOutputElement largevideo error "+e)}),$("#p2pSecondVideo")[0]&&$("#p2pSecondVideo")[0].setSinkId(n).then(function(){"default"!==t&&$("#p2pSecondVideo")[0].setSinkId(t).then(function(){r.webrtc("[videoService] resetAudioOutputElement p2pSecondVideo "+$("#p2pSecondVideo")[0].sinkId)}).catch(function(e){r.warn("[videoService] resetAudioOutputElement p2pSecondVideo error "+e)})}).catch(function(e){r.warn("[videoService] resetAudioOutputElement p2pSecondVideo error "+e)})},3e3,1)}).catch(function(){r.webrtc("[videoService] resetAudioOutputElement getCurrentSpeaker error"),C.audioProfileChanging=!1})):void r.warn("[videoService] resetAudioOutputElement -- missing global audio tag !")},this.disableAudioVideoMedia=function(e,t){if(e?r.webrtc("MEDIA   | disableAudioVideoMedia for session "+JSON.stringify({sid:e.sid})):t?r.webrtc("MEDIA   | disableAudioVideoMedia no session, sessionId: "+t):r.webrtc("MEDIA   | disableAudioVideoMedia no session, no session Id"),!e&&!t){var n=C.localStreams.length;if(0<C.localStreams.length)for(C.localStreams.forEach(function(e){e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),e=null});0<C.localStreams.length;){C.localStreams.pop();null}r.webrtc("MEDIA   | disableAudioVideoMedia : All local streams stopped and removed: "+n)}if(e){if(0<e.localStreams.length){var i=e.localStreams.length;for(e.localStreams.forEach(function(e){e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),e=null}),C.localStreams=C.localStreams.filter(function(t){return!e.localStreams.includes(t)});0<e.localStreams.length;){e.localStreams.pop();null}r.webrtc("MEDIA   | disableAudioVideoMedia : Session streams stopped and removed: "+i+". Remaining local streams: "+C.localStreams.length)}}else if(t){var a=C.localStreams.filter(function(e){return e.callId===t});if(a){i=a.length;a.forEach(function(e){e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),C.localStreams.splice(C.localStreams.indexOf(e),1),e=null}),r.webrtc("MEDIA   | disableAudioVideoMedia : Locals streams for sessionId "+t+" stopped and removed: "+i+". Remaining local streams: "+C.localStreams.length)}}C.statsInterval&&(window.clearInterval(C.statsInterval),C.statsinterval=null)},this.attachDistantMediaStreams=function(e,t){if(e){if(C.alreadyAttaching)return;C.alreadyAttaching=!0;var n=o.connection.jingle.sessions[t.id];if(n.remoteStreams){var i,a;if(1<n.remoteStreams.length)n.remoteStreams[0].getAudioTracks().length?(a=n.remoteStreams[0],i=n.remoteStreams[1]):(i=n.remoteStreams[0],a=n.remoteStreams[1]),0<i.getVideoTracks().length&&(r.webrtc("attachDistantMediaStreams video track for element largevideo "+i.id),C.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),i,i.id),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0)),0<i.getAudioTracks().length&&(r.webrtc("attachDistantMediaStreams audio track for element globalAudioTag "+i.id),C.RTC.attachMediaStream(angular.element("#globalAudioTag"),i)),0<a.getVideoTracks().length&&(r.webrtc("attachDistantMediaStreams video track for element p2pSecondVideo "+a.id),C.RTC.attachMediaStreamIfNeeded(angular.element("#p2pSecondVideo"),a,a.id),angular.element("#p2pSecondVideo")[0]&&(angular.element("#p2pSecondVideo")[0].muted=!0,angular.element("#p2pSecondVideo")[0].volume=0)),0<a.getAudioTracks().length&&(r.webrtc("attachDistantMediaStreams audio track for element globalAudioTag "+a.id),C.RTC.attachMediaStream(angular.element("#globalAudioTag"),a));else n.remoteStreams.forEach(function(e){0<e.getVideoTracks().length&&(r.webrtc("attachDistantMediaStreams video track"),C.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),e,e.id),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0),C.RTC.attachMediaStreamIfNeeded(angular.element("#p2pSecondVideo"),e,e.id),angular.element("#p2pSecondVideo")[0]&&(angular.element("#p2pSecondVideo")[0].muted=!0,angular.element("#p2pSecondVideo")[0].volume=0)),0<e.getAudioTracks().length&&(r.webrtc("attachDistantMediaStreams audio track"),C.RTC.attachMediaStream(angular.element("#globalAudioTag"),e))});C.alreadyAttaching=!1}}else C.isUserContactInCall()||(this.RTC.clearMediaStream(angular.element("#largevideo"),null),this.RTC.clearMediaStream(angular.element("#globalVideoTag"),null),this.RTC.clearMediaStream(angular.element("#globalAudioTag"),null))},this.attachLocalMediaStreams=function(e){if(r.webrtc("attachLocalMediaStreams "+e),e){if(this.localStreams&&this.localStreams.length){var t=!1;this.localStreams.forEach(function(e){e.getVideoTracks().length&&e.getAudioTracks().length?(t?C.RTC.attachMediaStreamIfNeeded($("#minivideo2"),e,e.id):(t=!0,C.RTC.attachMediaStreamIfNeeded($("#minivideo"),e,e.id)),C.RTC.attachMediaStreamIfNeeded($("#callVideoPip"),e,e.id)):e.getVideoTracks().length&&(t?C.RTC.attachMediaStreamIfNeeded($("#minivideo2"),e,e.id):(t=!0,C.RTC.attachMediaStreamIfNeeded($("#minivideo"),e,e.id)),C.RTC.attachMediaStreamIfNeeded($("#callSharingPip"),e,e.id))})}$("#callVideoPip")[0]&&($("#callVideoPip")[0].volume=0),$("#minivideo")[0]&&($("#minivideo")[0].volume=0),$("#minivideo2")[0]&&($("#minivideo2")[0].volume=0),$("#callSharingPip")[0]&&($("#callSharingPip")[0].volume=0)}else this.RTC.clearMediaStream($("#minivideo"),null),this.RTC.clearMediaStream($("#minivideo2"),null),this.RTC.clearMediaStream($("#callVideoPip"),null),this.RTC.clearMediaStream($("#callSharingPip"),null)},this.pushInLocalStreams=function(e,t){e.callId=t,C.localStreams.push(e)},this.openErrorPopup=function(e){e||(e="cameraNotAvailable"),t.$broadcast("ON_WEBRTC_CALL_ERROR_EVENT",e)},this.openCalendarBusyPopup=function(e){t.$broadcast("ON_WEBRTC_CALENDAR_BUSY_EVENT",e)},this.makeVideoCall=function(e){C.makeCall(e,"videoOnly")},this.makeCall=function(e,t,n){return r.webrtc("MEDIA   | makeCall to "+JSON.stringify({displayName:e.displayNameForLog(),resources:e.resources})),C.makingCall?void r.info("MEDIA   | makeCall already making a call !"):(C.makingCall=!0,void this.videoEventHandler.sendProposition(e,t,n))},this.makeJingleCall=function(e,n,i){r.webrtc("MEDIA   | makeJingleCall"),C.setWebrtcConfiguration().then(function(){var a="";e.localMedia&c.Media.AUDIO&&(a="audio"),e.localMedia&c.Media.VIDEO&&(a=a?"audio+video":"video"),n&&""!==n&&r.webrtc("MEDIA   | makeJingleCall in mediaPillar case for number : "+i),n&&""!==n&&i&&""!==i?(a="sip",o.connection.jingle.initiate(n,o.connection.jid,a,C.localStreams,e.id,null,i)):o.connection.jingle.initiate(e.fullJid,o.connection.jid,a,C.localStreams,e.id),e.status=c.Status.CONNECTING,t.$broadcast("ON_CALL_UPDATED_EVENT",e)}).catch(function(t){r.webrtc("MEDIA   | makeCall failure : "+JSON.stringify({error:t.message})),C.makingCall=!1,e&&C.removeCallObject(e),C.resetToSafeState()})},this.makeJingleSharingCall=function(e){r.webrtc("MEDIA   | makeJingleSharingCall - make desktop sharing call");var n="sharing";e.localMedia===c.Media.SHARING&&(n="sharing-only"),C.setWebrtcConfiguration().then(function(){r.webrtc("SHARING | getUserMedia success");var i=C.getMediaPillarSession(),a=i?C.localStreams.filter(function(e){return!(i.localStreams&&i.localStreams.includes(e))}):C.localStreams;o.connection.jingle.initiate(e.fullJid,o.connection.jid,n,a,e.id),e.status=c.Status.CONNECTING,t.$broadcast("ON_CALL_UPDATED_EVENT",e)}).catch(function(t){C.makingCall=!1,e&&C.removeCallObject(e),C.resetToSafeState(),r.webrtc("MEDIA   | makeJingleSharingCall failure : "+JSON.stringify({error:t.message}))})},this.startDesktopSharing=function(e,t){C.makingCall?r.info("MEDIA   | startDesktopSharing already making a call !"):(C.makingCall=!0,!C.askToStartSharing(e.jid,t)&&C.makeDesktopSharingCall(e,t))},this.startSharingCancelled=function(){C.makingCall=!1},this.makeDesktopSharingCall=function(e,t){t||(t="sharing"),r.webrtc("MEDIA   | makeDesktopSharingCall - trying to start a desktop sharing call with media "+t),this.videoEventHandler.sendProposition(e,t)},this.answerJingleCall=function(e){r.webrtc("MEDIA   | answerJingleCall "+e.id);var n=[],i="audio";e.localMedia&c.Media.AUDIO&&n.push("audio"),e.localMedia&c.Media.VIDEO&&(n.push("video"),i="audio+video"),e.localMedia===c.Media.VIDEO&&(i="video");var a={};e.isInConversationWithMobile()&&(a=C.getMobileMediaConstraints("video")),C.setWebrtcConfiguration().then(function(){C.getBrowserMedia(n,a.fixedVideoWidth,a.fixedVideoHeight,a.fixedFrameRate).then(function(n){var r=o.connection.jingle.sessions[e.id];n?(C.pushInLocalStreams(n,e.id),r.addStream(C.localStreams[0]),r.localStreams.push(C.localStreams[0])):i=null,r.localType=i,r.sendAnswer(),r.accept(),t.$broadcast("ON_CALL_UPDATED_EVENT",e)}).catch(function(t){r.webrtc("MEDIA   | answerJingleCall failure for : "+e+" failure : "+t.message),-1!==t.toString().indexOf("getUserMedia")&&(C.releaseCall(e),C.openErrorPopup()),C.resetToSafeState()})})},this.answerCall=function(e,t){this.videoEventHandler.acceptProposition(e,t)},this.rejectCall=function(e,t){e?(C.makingCall=!1,C.autoreleaseTimeout&&a.cancel(C.autoreleaseTimeout),o.connection.jingle.sessions[e.id]?C.releaseCall(e):e.isInitiator?this.videoEventHandler.retractProposition(e):this.videoEventHandler.rejectProposition(e,t)):r.webrtc("MEDIA   | rejectCall - trying to rejectCall a non existing call !")},this.releaseCall=function(e,t,n){return e?(C.makingCall=!1,void this.execute("releaseCall",function(){r.webrtc("MEDIA   | releaseCall : "+e);try{var i=o.connection.jingle.sessions[e.id];C.disableAudioVideoMedia(i),s.resetBusyState(),C.autoreleaseTimeout&&a.cancel(C.autoreleaseTimeout),C.createOrUpdateStatisticsForCall(e.id),C.callsStats[e.id]&&delete C.callsStats[e.id],C.callsStatsSimplified[e.id]&&delete C.callsStatsSimplified[e.id],C.removeCallObject(e,t,n),C.displayWebRTCStats(e.id)}catch(t){r.webrtc("MEDIA   | releaseCall ERROR"),r.error(t),C.createOrUpdateStatisticsForCall(e.id),C.callsStats[e.id]&&delete C.callsStats[e.id],C.callsStatsSimplified[e.id]&&delete C.callsStatsSimplified[e.id],C.resetToSafeState(),C.displayWebRTCStats(e.id),C.removeCallObject(e)}})):void r.webrtc("MEDIA   | releaseCall - trying to release a non existing call !")},this.askToAddDesktopSharing=function(e){r.webrtc("MEDIA   | askToAddDesktopSharing - Desktop sharing escalation"),!C.askToAddSharing(e.id)&&C.addSharingToCall(e.videoCall)},this.addAudioToCall=function(e,t){r.webrtc("MEDIA   | addAudioToCall");var n=o.connection.jingle.sessions[e.id];n.isRenegotiating=!0,this.getBrowserMedia(["audio"]).then(function(r){C.stopActiveAudioVideoStreams(n),C.pushInLocalStreams(r,e.id);for(var i=0;i<C.localStreams.length;i++)n.removeStream(C.localStreams[i]);var a=t?"contentModify":"contentAdd";C.updateCurrentCall(e,n,"audio",a)}).catch(function(t){r.webrtc("MEDIA   | addAudioToCall failure : "+t),C.releaseCall(e),C.resetToSafeState()})},this.addSharingToCall=function(e){r.webrtc("MEDIA   | addSharingToCall - Desktop sharing escalation");var t=o.connection.jingle.sessions[e.id];t.isRenegotiating=!0;var n={};e.isInConversationWithMobile()&&(n=C.getMobileMediaConstraints("sharing")),this.getBrowserMedia(["sharing"],null,null,n.fixedFrameRate).then(function(n){for(var r=0;r<C.localStreams.length;r++)t.removeStream(C.localStreams[r]),t.localStreams[r]=null;t.localStreams=[],C.pushInLocalStreams(n,e.id);for(r=0;r<C.localStreams.length;r++)t.removeStream(C.localStreams[r]);C.updateCurrentCall(e,t,"sharing","contentAdd")}).catch(function(e){r.webrtc("MEDIA   | addSharingToCall failure : "+e),t.isRenegotiating=!1,-1!==e.toString().indexOf("getUserMedia")&&C.openErrorPopup()})},this.addVideoToCall=function(e,t){r.webrtc("MEDIA   | addVideoToCall");var n=o.connection.jingle.sessions[e.id];n.isRenegotiating=!0;var i={};e.isInConversationWithMobile()&&(i=C.getMobileMediaConstraints("video")),C.getBrowserMedia(["audio","video"],i.fixedVideoWidth,i.fixedVideoHeight,i.fixedFrameRate).then(function(r){C.stopActiveAudioVideoStreams(n),C.pushInLocalStreams(r,e.id);for(var i=0;i<C.localStreams.length;i++)n.removeStream(C.localStreams[i]);var a=t?"contentModify":"contentAdd";C.updateCurrentCall(e,n,"video",a)}).catch(function(t){r.webrtc("MEDIA   | addVideoToCall failure for : "+e+" failure : "+t.message),-1===t.toString().indexOf("getUserMedia")?(C.releaseCall(e),C.resetToSafeState()):(r.info("addVideoToCall impossible, no webcam plugged"),C.openErrorPopup())})},this.removeSharingFromCall=function(e){r.webrtc("MEDIA   | removeSharingFromCall");var t=o.connection.jingle.sessions[e.id];this.stopAllActiveStreams(t);var n=["audio"];e.localMedia&c.Media.VIDEO&&n.push("video"),t.isRenegotiating=!0,C.getBrowserMedia(n).then(function(n){C.pushInLocalStreams(n,e.id),C.updateCurrentCall(e,t,"sharing","contentRemove")}).catch(function(t){r.webrtc("MEDIA   | removeSharingFromCall failure for : "+e+" failure : "+t.message),-1!==t.toString().indexOf("getUserMedia")&&C.openErrorPopup(),C.releaseCall(e),C.resetToSafeState()})},this.removeVideoFromCall=function(e){r.webrtc("MEDIA   | removeVideoFromCall"),this.reverseAudioCallInitiated=!0;var t=o.connection.jingle.sessions[e.id];this.stopActiveAudioVideoStreams(t),this.localStreams.forEach(function(e){t.removeStream(e)}),t.isRenegotiating=!0,C.getBrowserMedia(["audio"]).then(function(n){C.pushInLocalStreams(n,e.id),C.updateCurrentCall(e,t,"video","contentRemove")}).catch(function(t){r.webrtc("MEDIA   | removeVideoFromCall failure for : "+e+" failure : "+t),-1!==t.toString().indexOf("getUserMedia")&&C.openErrorPopup(),C.releaseCall(e),C.resetToSafeState()})},this.calculatePresenceMessage=function(e){var t="audio";return e&&e.localMedia&c.Media.VIDEO&&(t="video"),e&&e.remoteMedia&c.Media.VIDEO&&(t="video"),e&&e.localMedia&c.Media.SHARING&&(t="sharing"),e&&e.remoteMedia&c.Media.SHARING&&(t="sharing"),t},this.calculateAudioState=function(e){var t=0;return e.availableIncomingAudioBandwidth&&(t=15>e.availableIncomingAudioBandwidth&&0<e.availableIncomingAudioBandwidth?1:15<=e.availableIncomingAudioBandwidth&&30>e.availableIncomingAudioBandwidth?2:3),t},this.calculateVideoState=function(e){var t=0;return e.availableIncomingVideoBandwidth&&(t=300>e.availableIncomingVideoBandwidth?1:300<=e.availableIncomingVideoBandwidth&&500>e.availableIncomingVideoBandwidth?2:3),t},this.execute=function(e,t,n){this.started||"releaseCall"===e?t(n):r.webrtc("MEDIA   | "+e+" failure : videoService is not started")},this.getOrCreateCallByCallId=function(e){var t=C.calls[e];if(!t){var n=o.connection.jingle.sessions[e],r=o.getBareJidFromJid(n.peerjid),i=s.getContactByJid(r);t=c.create(c.Status.UNKNOWN,e,c.Type.WEBRTC,i),C.calls[t.id]=t}return t},this.getCallByContact=function(e){for(var t in this.calls)if(this.calls.hasOwnProperty(t)){var n=C.calls[t];if(n.contact&&e.jid===n.contact.jid)return n}return null},this.removeCallObject=function(e,n,i){try{if(e){r.debug("removeCallObject Call id: "+e.id),e.status=c.Status.UNKNOWN;var a=o.connection.jingle.sessions?o.connection.jingle.sessions[e.id]:null;C.disableAudioVideoMedia(a,e.id),delete C.calls[e.id],t.$broadcast("ON_CALL_UPDATED_EVENT",e),a&&o.connection.jingle.terminate(e.id,n,i)}}catch(e){r.error("removeCallObject error "+e)}},this.updateRemoteTypeMedia=function(e,t){t.remoteMedia="audio"===e?c.Media.AUDIO:"video"===e?c.Media.VIDEO:"audio+video"===e?c.Media.AUDIO|c.Media.VIDEO:"sharing"===e?c.Media.SHARING|c.Media.AUDIO:"sharing-only"===e?c.Media.SHARING:null,r.debug("REMOTE TYPE || REMOTE MEDIA  "+t.remoteMedia)},this.checkStreamAndStatus=function(e,t){return e&&(0===e.getAudioTracks().length&&0===e.getVideoTracks().length||!1===e.active)?(C.openErrorPopup(),!1):!t.capabilities||t.capabilities.webRTC||(r.webrtc("MEDIA   | initSharedDesktop failure : remote contact is no more available"),e.stop&&e.stop(),C.openErrorPopup("remoteUserNoMoreAvailable"),!1)},this.displayWebRTCStats=function(e){try{var t=null,n=0;if(d.hasStatsForCall(e)){if(r.webrtc("STATS   | Bundle policy used: "+d.getBundlePolicyForCall(e)),0===(t=d.getStreamsDetailsFromCall(e)).length)r.webrtc("STATS   | No channel information available for call "+e);else for(n=0;n<t.length;n++)r.webrtc("STATS   | "+t[n].id+": "+JSON.stringify(t[n].streams));var i=d.getCodecDetailsFromCall(e);r.webrtc("STATS   | codecs used: "+JSON.stringify(i)),f.trackCodecsUsed(i.codec.audio,i.codec.video)}else if(u.hasStatsForCall(e))if(r.webrtc("STATS   | Bundle policy used: "+u.getBundlePolicyForCall(e)),0===(t=u.getStreamsDetailsFromCall(e)).length)r.webrtc("STATS   | No channel information available for call "+e);else for(n=0;n<t.length;n++)r.webrtc("STATS   | "+t[n].id+": "+JSON.stringify(t[n].streams))}catch(e){r.error("[videoService] displayWebRTCStats error : "+e)}},this.muteAudio=function(e,n){var i=e.videoCall;if(i){r.webrtc("MEDIA   | mute audio: "+i+" | state: "+n),e.isMutedAudio=n,i.isMuted=n;var a=o.connection.jingle.sessions[i.id];a?(a.muteAudio(n),t.$broadcast("ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT",{conversation:e,call:i})):r.webrtc("MEDIA   | muteAudio - trying to mute a non existing session !")}else r.webrtc("MEDIA   | muteAudio - trying to mute a non existing call !")},this.muteVideo=function(e,n){var i=e.videoCall;if(i){r.webrtc("MEDIA   | muteVideo: "+i);var a=o.connection.jingle.sessions[i.id];a&&(a.muteVideo(n),a.sendMute(n)),t.$broadcast("ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT",{conversation:e,call:i})}else r.webrtc("MEDIA   | muteVideo - trying to mute a non existing call !")},this.stopAllActiveStreams=function(e){this.stopActiveAudioVideoStreams(e,!0)},this.stopActiveAudioVideoStreams=function(e,t){if(0<C.localStreams.length)if(C.localStreams.forEach(function(e){(e.getAudioTracks().length||t)&&(e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),e=null)}),t)for(;C.localStreams.length;){C.localStreams.pop();null}else for(var n=0;n<C.localStreams.length;n++)if(C.localStreams[n]&&C.localStreams[n].getAudioTracks().length){C.localStreams.splice(n,1);null}if(e&&e.localStreams){if(e.localStreams.forEach(function(n){(n.getAudioTracks().length||t)&&(n.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),n.stop&&n.stop(),e.removeStream(n))}),t)for(;e.localStreams.length;){e.localStreams.pop();null}e.localStreams=[]}e&&o.connection.jingle.localStream&&e.removeStream(o.connection.jingle.localStream)},this.resetToSafeState=function(){r.webrtc("MEDIA   | resetToSafeState"),C.autoreleaseTimeout&&a.cancel(C.autoreleaseTimeout),(C.localStream||C.localStreams.length)&&C.disableAudioVideoMedia(),s.resetBusyState()},this.vidRes={1080:[1920,1080],720:[1280,720],360:[640,360],180:[320,180],960:[960,720],640:[640,480],320:[320,240]},this.getMobileMediaConstraints=function(e){var t={};return"sharing"===e?t.fixedFrameRate=3:"video"==e&&(t.fixedFrameRate=20,t.fixedVideoWidth=640,t.fixedVideoHeight=480),t},this.minFirefoxWebRTCVersion=45,this.minChromeWebRTCVersion=42,this.minEdgeWebRTCVersion=25,this.firefoxPreferedSharing="screen",this.getBrowserMedia=function(n,i,a,o){return n&&0!==n.length?new Promise(function(s,c){var l=e.defer(),d={audio:!1,video:!1},u=i||1280,p=a||720,m=[];if(h.allowDevicesManagement()){if(0<=n.indexOf("audio")){var v=e.defer();h.getCurrentMicrophone().then(function(e){d.audio=!e||{optional:[{sourceId:e.id}]},v.resolve(d);var t="default";e&&(t="id - "+e.id+" and label "+e.label),r.info("[VideoService] GetUserMedia for microphone "+t)}),m.push(v.promise)}if(0<=n.indexOf("video")){var S=o||30,E=e.defer();h.getCurrentCamera().then(function(e){d.video=e&&"default"!==e.id?{width:u,height:p,frameRate:S,deviceId:{exact:e.id}}:{width:u,height:p,frameRate:S},E.resolve(d);var t="default";e&&(t="id - "+e.id+" and label "+e.label),r.info("[VideoService] GetUserMedia for camera "+t)}),m.push(E.promise)}}else 0<=n.indexOf("audio")&&(d.audio=!0),0<=n.indexOf("video")&&(d.video={width:u,height:p});if(0<=n.indexOf("sharing")){S=o||8;if(g.extensionFound)d.video={mandatory:{chromeMediaSource:"desktop",maxWidth:1920,maxHeight:1080,maxFrameRate:S}},m.push(g.getStreamToShareFromExtension(d));else if("firefox"===adapter.default.browserDetails.browser)d.video={mediaSource:C.firefoxPreferedSharing};else{var b=C.getDesktopSharingSource(),y=b&&b.chromeMediaSource?b.chromeMediaSource:"desktop",R=b&&b.chromeMediaSourceId?b.chromeMediaSourceId:null;d.video={mandatory:{chromeMediaSource:y,maxWidth:1920,minWidth:1920,maxHeight:1080,minHeight:1080,maxFrameRate:S}},R&&(d.video.mandatory.chromeMediaSourceId=R)}}e.all(m).then(function(){l.resolve(d)}).catch(function(){l.resolve()}),l.promise.then(function(e){if(r.info("[VideoService] GetUserMedia with constraint "+JSON.stringify(e)),e)try{navigator.mediaDevices.getUserMedia(e).then(function(e){r.webrtc("MEDIA   | getUserMedia success"),e.getAudioTracks().length&&r.info("[videoService] getUserMedia audio stream kind "+e.getAudioTracks()[0].kind+", id "+e.getAudioTracks()[0].id+", label "+e.getAudioTracks()[0].label+", readyState "+e.getAudioTracks()[0].readyState+", enabled "+e.getAudioTracks()[0].enabled),e.getVideoTracks().length&&r.info("[videoService] getUserMedia video stream kind "+e.getVideoTracks()[0].kind+", id "+e.getVideoTracks()[0].id+", label "+e.getVideoTracks()[0].label+", readyState "+e.getVideoTracks()[0].readyState+", enabled "+e.getVideoTracks()[0].enabled),e&&(0===e.getAudioTracks().length&&0===e.getVideoTracks().length||!1===e.active)&&(r.webrtc("Stream has no active audio or video tracks"),f.trackGetUserMediaErrorNoTrack(),c(new Error("getUserMedia failure : Stream has no active audio or video tracks"))),g.extensionFound&&0<=n.indexOf("sharing")&&(e.getVideoTracks()[0].onended=function(){r.info("Stop screensharing in chrome has been triggered"),t.$broadcast("ON_CHROME_STOP_SCREEN_SHARING_TRIGGERED")}),e&&e.getAudioTracks().length&&(e.getAudioTracks()[0].onended=function(e){r.error("audio stream track ended"),console.log(this),console.log(e)}),s(e),f.trackGetUserMediaSuccess()}).catch(function(e){r.webrtc("MEDIA   | getUserMedia failure: "+e),f.trackGetUserMediaError(),t.$broadcast("ON_WEBRTC_GETUSERMEDIA_ERROR",e),c(new Error("getUserMedia failure "+e))})}catch(e){r.webrtc("MEDIA   | getUserMedia failure: "+e),f.trackGetUserMediaError(),c(new Error("getUserMedia failure "+e))}else c({message:"getUserMedia cancelled"})})}):e.when()},this.getBrowserMethodHandler=function(){var e="",t=null;if(navigator.mozGetUserMedia&&n.mozRTCPeerConnection){if(e=l.extractBrowserVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1),r.webrtc("BROWSER | Detect Firefox navigator (version "+e+")"),e<this.minFirefoxWebRTCVersion)return r.webrtc("BROWSER | Firefox navigator is not WebRTC capable before version "+this.minFirefoxWebRTCVersion),t;t={browser:"firefox",attachMediaStream:function(e,t){e&&e[0]&&(e[0].mozSrcObject=t,e[0].srcObject=t,e[0].play())},pc_constraints:{},clearMediaStream:function(e){try{angular.isDefined(e[0])&&(e[0].pause(),e[0].mozSrcObject=null,e[0].srcObject=null,e[0].uniqueId=null)}catch(e){r.webrtc("BROWSER | clearMediaStream failure "+e)}},attachMediaStreamIfNeeded:function(e,t,n){r.webrtc("BROWSER | attachMediaStreamIfNeeded for ID "+n),e&&e[0]&&(e[0].uniqueId!==n||!e[0].mozSrcObject&&!e[0].srcObject)&&(e[0].uniqueId=n,C.RTC.attachMediaStream(e,t))}}}else if(navigator.webkitGetUserMedia&&n.webkitRTCPeerConnection){if(e=l.extractBrowserVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2),r.webrtc("BROWSER | Detect Chrome navigator (version "+e+")"),e<this.minChromeWebRTCVersion)return r.webrtc("BROWSER | Chrome navigator is not WebRTC capable before version "+this.minChromeWebRTCVersion),t;t={browser:"chrome",attachMediaStream:function(e,t){r.webrtc("BROWSER | attachMediaStream to element"),e&&e[0]&&(e[0].srcObject=t),a(function(){e&&e[0]&&e[0].load&&e[0].load()},1e3,1)},pc_constraints:{},clearMediaStream:function(e){angular.isDefined(e[0])&&(e[0].pause(),e[0].srcObject=null,e[0].uniqueId=null)},attachMediaStreamIfNeeded:function(e,t,n){r.webrtc("BROWSER | attachMediaStreamIfNeeded for ID "+n),e&&e[0]&&(e[0].uniqueId!==n||!e[0].srcObject)&&(e[0].uniqueId=n,C.RTC.attachMediaStream(e,t))}}}return t},this.getIceConfig=function(){return e(function(e,t){var n=config.restServerUrl+"/api/rainbow/geolocation/v1.0/";i({method:"GET",url:n+"settings/iceservers?nbServers=2",headers:m.getRequestHeader()}).then(function(t){r.info("[videoService] getIceConfig success");var n=t.data.data;n.forEach(function(e){delete e.id},this),e({iceServers:n})}).catch(function(e){r.error("[videoService] getIceConfig failure -- "+e.message),t(e)})})},this.calculateNewCallType=function(e,t,n,i){var a=t.localType;return"contentAdd"===i&&("video"===n?(a=e.localMedia&c.Media.SHARING?"sharing+video":"video",e.localMedia|=c.Media.VIDEO):"sharing"===n?(a=e.localMedia&c.Media.VIDEO?"sharing+video":"sharing",e.localMedia|=c.Media.SHARING):"audio"==n&&(e.localMedia&c.Media.SHARING?(a="sharing",e.localMedia|=c.Media.AUDIO):(a="audio",e.localMedia=c.Media.AUDIO))),"contentRemove"===i&&("video"===n?e.localMedia&c.Media.SHARING?(a="sharing",e.localMedia=c.Media.AUDIO|c.Media.SHARING):(a="audio",e.localMedia=c.Media.AUDIO):"sharing"==n&&(e.localMedia&c.Media.VIDEO?(a="video",e.localMedia=c.Media.AUDIO|c.Media.VIDEO):(a="audio",e.localMedia=c.Media.AUDIO))),"contentModify"===i&&e.localMedia&c.Media.VIDEO&&!(e.localMedia&c.Media.SHARING)&&(a="video"),r.info("[videoService] calculateNewCallType for type "+n+" and action "+i+" with result "+a),a},this.updateCurrentCall=function(e,n,i,a){r.info("[videoService] updateCurrentCall for type "+i+" and action "+a);for(var o=this.calculateNewCallType(e,n,i,a),c=0;c<C.localStreams.length;c++)"chrome"===adapter.default.browserDetails.browser?n.addStream(C.localStreams[c]):n.replaceStream(C.localStreams[c]),n.localStreams.push(C.localStreams[c]);switch(a){case"contentAdd":n.contentAdd(o);break;case"contentRemove":n.contentRemove(o);break;case"contentModify":n.contentModify(o)}s.setBusyState("dnd",C.calculatePresenceMessage(e)),t.$broadcast("ON_CALL_UPDATED_EVENT",e),t.$broadcast("ON_WEBRTC_CALL_ESCALATION",e)},this.createOrUpdateStatisticsForCall=function(e){var t=this.calls[e];if(t){var n=[];return this.callsStats[e]?(n.push({connectionId:e,stats:this.callsStats[e]}),void this.updateStatisticsForCall(this.callsStats[e].id,e,t.contact.dbId,"ended",n)):(r.info("[videoService] createOrUpdateStatisticsForCall "+e),this.callsStats[e]={},n.push({connectionId:e,stats:this.callsStats[e]}),void this.createStatisticsForSession(e,t.contact.dbId,"pending",n).then(function(t){C.callsStats[e].id=t,r.info("[videoService] createOrUpdateStatisticsForCall success for session "+e+" with id "+t)}).catch(function(e){r.error("[videoService] createOrUpdateStatisticsForCall "+e.message)}))}r.warn("[videoService] createOrUpdateStatisticsForCall -- missing call "+e)},this.createStatisticsForSession=function(t,n,a,o){return e(function(e,s){r.info("[videoService] createStatisticsForSession "+t);var c=config.restServerUrl+"/api/rainbow/metrics/v1.0/";i({method:"POST",url:c+"webrtcmetrics",headers:m.getRequestHeader(),data:{callId:t,peerId:n,callState:a,metrics:o}}).then(function(n){r.info("[videoService] createStatisticsForSession success"),n&&n.data&&n.data.data&&n.data.data.id&&C.callsStats[t]&&e(n.data.data.id)},function(e){r.error("[videoService] createStatisticsForSession failure "+e.errorMsg),s(new Error(e.errorMsg))})})},this.updateStatisticsForCall=function(e,t,n,a,o){if(r.info("[videoService] updateStatisticsForCall "+t),e){var s=config.restServerUrl+"/api/rainbow/metrics/v1.0/";i({method:"POST",url:s+"webrtcmetrics/"+e+"/metrics",headers:m.getRequestHeader(),data:{metrics:o}}).then(function(){r.info("[videoService] updateStatisticsForCall success")},function(e){r.error("[videoService] updateStatisticsForCall failure "+e.errorMsg)})}else r.warn("[videoService] updateStatisticsForCall -- missing id for callId "+t)},angular.element(document).bind("transportreplace.jingle",function(e,t){r.webrtc("JINGLE  | transportreplace.jingle "+t);var n=o.connection.jingle.sessions[t];n?n.sendAnswer(void 0,"transport-accept"):r.warn("JINGLE  | transportreplace.jingle no such session !")}),angular.element(document).bind("callactive.jingle",function(e,t){r.webrtc("JINGLE  | callactive "+t)}),angular.element(document).bind("remotestreamadded.jingle",function(e,n,i){r.webrtc("JINGLE  | remoteStreamadded "+n);var a=o.connection.jingle.sessions[n];if(a&&a.remoteStreams&&!a.confId){var s=C.calls[n];s&&C.attachDistantMediaStreams(!0,s),t.$broadcast("ON_WEBRTC_REMOTE_STREAM_ADDED",a.remoteStreams)}i&&C.resetAudioOutputElement()}),angular.element(document).bind("remotestreamremoved.jingle",function(e,t){r.webrtc("JINGLE  | remotestreamremoved "+t)}),angular.element(document).bind("callaccepted.jingle",function(e,t){r.webrtc("JINGLE  | callaccepted "+t);var n=C.calls[t],i=o.connection.jingle.sessions[t];n&&i&&(C.statsInterval&&(r.webrtc("JINGLE  | remove getStats interval"),window.clearInterval(C.statsInterval),C.statsinterval=null),C.createOrUpdateStatisticsForCall(n.id),r.webrtc("JINGLE  | start getStats interval"),C.statsInterval=i.getStats(5e3)),n&&n.status.key!==c.Status.ACTIVE.key&&(r.webrtc("INFO    | call has been accepted. Set current call to ACTIVE state"),angular.element(document).trigger("callactive.jingle",[t]))}),angular.element(document).bind("nostuncandidates.jingle",function(e,t){r.webrtc("JINGLE  | nostuncandidates "+t),f.trackICENoSTUNCandidate()}),angular.element(document).bind("ringing.jingle",function(e,t){r.webrtc("JINGLE  | callremoteringing "+t)}),angular.element(document).bind("mediafailure.jingle",function(){r.webrtc("JINGLE  | callmediafailure")}),angular.element(document).bind("mute.jingle",function(e,n){r.webrtc("JINGLE  | mute "+n);var i=C.calls[n];i.isRemoteVideoMuted=!0,t.$broadcast("ON_CALL_UPDATED_EVENT",i)}),angular.element(document).bind("unmute.jingle",function(e,n){r.webrtc("JINGLE  | unmute "+n);var i=C.calls[n];i.isRemoteVideoMuted=!1,t.$broadcast("ON_CALL_UPDATED_EVENT",i)}),angular.element(document).bind("hold.jingle",function(e,n){r.webrtc("JINGLE  | hold "+n);var i=o.connection.jingle.sessions[n];i?(i.muteAudio(!0),t.$broadcast("ON_HOLD_TONE_EVENT","hold")):r.webrtc("MEDIA   | hold - received on a non existing session !")}),angular.element(document).bind("unhold.jingle",function(e,n){r.webrtc("JINGLE  | unhold "+n);var i=o.connection.jingle.sessions[n];i?(i.muteAudio(!1),t.$broadcast("ON_HOLD_TONE_EVENT","unhold")):r.webrtc("MEDIA   | unhold - received on a non existing session !")}),angular.element(document).bind("remoteIceFailed.jingle",function(e){r.webrtc("JINGLE  | remoteIceFailed "+e),C.openErrorPopup("IceConnectionFailed")}),angular.element(document).bind("mediamodified.jingle",function(e,t,n){r.webrtc("JINGLE  | mediamodified "+t),C.videoEventHandler.mediaModified(t,n)}),angular.element(document).bind("statsChrome.jingle",function(e,t,n){for(var r=0;r<n.length;++r)switch(n[r].type){case"googComponent":d.addStreamToCall(t,n[r]);break;case"ssrc":d.addSSRCToStream(t,n[r])}}),angular.element(document).bind("statsFirefox.jingle",function(e,t,n){for(var r=0;r<n.length;++r)switch(n[r].type){case"inboundrtp":case"outboundrtp":u.addStreamToCall(t,n[r]);break;case"candidatepair":u.addCandidatePairToCall(t,n[r])}}),angular.element(document).bind("webrtcFirefoxStats.jingle",function(e,n,r){C.callsStats.sid||(C.callsStats.sid={}),C.callsStats[n]||(C.callsStats[n]={});var i=C.calls[n];if(i){var a=C.calculateAudioState(r),o=0;i.remoteMedia&c.Media.VIDEO&&(o=C.calculateVideoState(r));var s=C.callsStats[n];s&&(r.videoReceived?s.video=r:s.audio=r,C.callsStats[n]=s),t.$broadcast("ON_WEBRTC_CALL_STATS",a,o)}}),angular.element(document).bind("webrtcConnectionType.jingle",function(e,t,n){var i=C.calls[t];n&&(r.webrtc("STATS   | Local candidate ("+n.localAddress+") type is "+n.localCandidateType),r.webrtc("STATS   | Remote candidate  ("+n.remoteAddress+") type is "+n.remoteCandidateType),i&&i.isInitiator&&f.trackICEUsed(n.localCandidateTypee,n.remoteCandidateType),n.networkType&&(r.webrtc("STATS   | Network type is "+n.networkType),i&&i.isInitiator&&f.trackICETopology(n.networkType)))}),angular.element(document).bind("webrtcSessionStats.jingle",function(e,t,n){C.callsStats.sid||(C.callsStats.sid={}),C.callsStats[t]||(C.callsStats[t]={});var r=C.callsStats[t].id;C.callsStats[t]=n,C.callsStats[t].id=r}),this.escalateToSharingCall=function(e,t){r.webrtc("MEDIA   | escalateToSharingCall - Desktop sharing escalation");var n=o.connection.jingle.sessions[e.id];n.isRenegotiating=!0,this.getBrowserMedia(["sharing"]).then(function(r){n.removeStream(C.localStreams[0]),n.localStreams[0]=null,n.localStreams=[],C.pushInLocalStreams(r,e.id),C.updateCurrentSharingCall(e,n,t)}).catch(function(e){r.webrtc("MEDIA   | escalateToSharingCall failure : "+e),n.isRenegotiating=!1,-1!==e.toString().indexOf("getUserMedia")&&C.openErrorPopup()})},this.escalateToVideoCall=function(e,t){r.webrtc("MEDIA   | Escalate to video call");var n=o.connection.jingle.sessions[e.id];n.isRenegotiating=!0,C.getBrowserMedia(["audio","video"]).then(function(r){C.stopActiveAudioVideoStreams(n),C.pushInLocalStreams(r,e.id);for(var i=0;i<C.localStreams.length;i++)n.localStreams.push(C.localStreams[i]);C.updateCurrentAudioOrVideoCall(e,n,"video",t)}).catch(function(t){r.webrtc("MEDIA   | escalateToVideoCall failure for : "+e+" failure : "+t.message),-1===t.toString().indexOf("getUserMedia")?(C.releaseCall(e),C.resetToSafeState()):(r.info("Escalation to video impossible, no webcam plugged"),C.openErrorPopup())})},this.addAudioToSharingCall=function(e){r.webrtc("MEDIA   | addAudioToSharingCall");var t=o.connection.jingle.sessions[e.id];t.isRenegotiating=!0,C.localStreams.length&&t.removeStream(C.localStreams[0]),t.localStreams[0]=null,t.localStreams=[],this.getBrowserMedia(["audio"]).then(function(n){C.pushInLocalStreams(n,e.id),C.updateCurrentSharingCall(e,t)}).catch(function(t){r.webrtc("MEDIA   | addAudioToSharingCall failure : "+t),C.releaseCall(e),C.resetToSafeState()})},this.reverseToAudioCall=function(e,t){r.webrtc("MEDIA   | reverseToAudioCall"),this.reverseAudioCallInitiated=!0;var n=o.connection.jingle.sessions[e.id];this.stopActiveAudioVideoStreams(n),n.isRenegotiating=!0,C.getBrowserMedia(["audio"]).then(function(r){C.pushInLocalStreams(r,e.id);for(var i=0;i<C.localStreams.length;i++)n.localStreams.push(C.localStreams[i]);C.updateCurrentAudioOrVideoCall(e,n,"audio",t)}).catch(function(t){r.webrtc("MEDIA   | reverseToAudioCall failure for : "+e+" failure : "+t.message),-1!==t.toString().indexOf("getUserMedia")&&C.openErrorPopup(),C.releaseCall(e),C.resetToSafeState()})},C.updateCurrentSharingCall=function(e,n,i){if(r.webrtc("MEDIA   | updateCurrentSharingCall | Add new streams to the current session"),!n||!o.connection.jingle.sessions[e.id])return C.disableAudioVideoMedia(),C.resetToSafeState(),void C.removeCallObject(e);var a="audio";"chrome"===adapter.default.browserDetails.browser?(n.localStreams.push(C.localStreams[0]),n.addStream(C.localStreams[0]),C.localStreams[1]&&(a=e.localMedia===c.Media.AUDIO||e.localMedia===c.Media.SHARING?"sharing":"sharing+video",e.localMedia=e.localMedia|c.Media.SHARING|c.Media.AUDIO,n.localStreams.push(C.localStreams[1]),n.addStream(C.localStreams[1]),n.localStreams.push(C.localStreams[1]),n.addStream(C.localStreams[1]))):(e.localMedia=c.Media.AUDIO,n.replaceStream(C.localStreams[0])),i?n.contentModify(a):n.contentAdd(a),s.setBusyState("dnd",C.calculatePresenceMessage(e)),t.$broadcast("ON_CALL_UPDATED_EVENT",e),t.$broadcast("ON_WEBRTC_CALL_ESCALATION",e)},this.updateCurrentAudioOrVideoCall=function(e,n,i,a){r.webrtc("MEDIA   | updateCurrentAudioOrVideoCall | Add new stream to the current session");for(var o=0;o<C.localStreams.length;o++)"chrome"===adapter.default.browserDetails.browser?n.addStream(C.localStreams[o]):n.replaceStream(C.localStreams[o]);a?n.contentModify(n.localType):"audio"===i?e.localMedia&c.Media.SHARING?(n.contentRemove("sharing"),n.localType="sharing",e.localMedia=c.Media.AUDIO|c.Media.SHARING):(n.contentRemove("audio"),n.localType="audio",e.localMedia=c.Media.AUDIO):"video"==i&&(e.localMedia&c.Media.SHARING?(n.contentAdd("sharing+video"),n.localType="sharing+video"):(n.contentAdd("video"),n.localType="audio+video"),e.localMedia|=c.Media.VIDEO),s.setBusyState("dnd",C.calculatePresenceMessage(e)),t.$broadcast("ON_CALL_UPDATED_EVENT",e),t.$broadcast("ON_WEBRTC_CALL_ESCALATION",e)},this.attachLocalMediaStream=function(e){e?(this.localStreams&&this.localStreams.length&&this.localStreams[0].getVideoTracks().length&&this.RTC.attachMediaStream($("#minivideo"),this.localStreams[0]),$("#minivideo")[0]&&($("#minivideo")[0].volume=0)):this.RTC.clearMediaStream($("#minivideo"),null)},this.attachDistantMediaStream=function(e,t){if(e){var n=o.connection.jingle.sessions[t.id];n.remoteStreams?n.remoteStreams.forEach(function(e){0<e.getVideoTracks().length&&(r.webrtc("attachDistantMediaStream video track"),C.RTC.attachMediaStream(angular.element("#largevideo"),e),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0)),0<e.getAudioTracks().length&&(r.webrtc("attachDistantMediaStream audio track"),C.RTC.attachMediaStream(angular.element("#globalAudioTag"),e))}):n.remoteStream&&(0<n.remoteStream.getVideoTracks().length&&(r.error("attachDistantMediaStream NOT GOOD !!! video track"),C.RTC.attachMediaStream(angular.element("#largevideo"),n.remoteStream),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0)),0<n.remoteStream.getAudioTracks().length&&(r.error("attachDistantMediaStream NOT GOOD !!! audio track"),C.RTC.attachMediaStream(angular.element("#globalAudioTag"),n.remoteStream)))}else C.isUserContactInCall()||(this.RTC.clearMediaStream(angular.element("#largevideo"),null),this.RTC.clearMediaStream(angular.element("#globalVideoTag"),null),this.RTC.attachMediaStream(angular.element("#globalAudioTag"),null))},this.sendDTMF=function(e,t,n){var i=o.connection.jingle.sessions[t.id];if(i&&i.peerconnection){var a=i.peerconnection.getSenders().find(function(e){return e.dtmf&&e.track&&e.track.enabled&&"audio"===e.track.kind}),s=a?a.dtmf:null;s?(r.debug("sendDTMF: dtmf sender found on webrtc session for call id "+t.id+" dialstring: "+e),s.ontonechange=n?this.silentToneChangeEventHandle:this.handleToneChangeEvent,s.insertDTMF(e)):r.error("sendDTMF: no dtmf sender found on webrtc session for call id "+t.id)}else r.error("sendDTMF: no webrtc session found for call id "+t.id)},this.handleToneChangeEvent=function(e){""!==e.tone&&(r.debug("Tone played: "+e.tone),t.$broadcast("ON_DTMF_SENT",e.tone))},this.silentToneChangeEventHandle=function(e){r.debug("Tone played: "+e.tone)}}])},function(){angular.module("rainbow").factory("VideoServiceEventHandler",["$log","$rootScope","$interval","contactService","xmppService","Call","gaService","uuid4",function(e,t,n,r,i,a,o,s){"use strict";function c(e){this.videoService=e,this.nameSpace="urn:xmpp:jingle-message:0"}return c.create=function(e){return new c(e)},c.prototype.setRemoteTypeMedia=function(t,n){n.remoteMedia=0;for(var r=0;r<t.length;r++)switch(t[r]){case"audio":n.remoteMedia|=a.Media.AUDIO;break;case"video":n.remoteMedia|=a.Media.VIDEO;break;case"sharing":n.remoteMedia|=a.Media.SHARING;break;default:n.remoteMedia=null}e.debug("REMOTE TYPE || REMOTE MEDIA  "+n.remoteMedia)},c.prototype.setLocalTypeMedia=function(t,n){n.localMedia=0;for(var r=0;r<t.length;r++)switch(t[r]){case"audio":n.localMedia|=a.Media.AUDIO;break;case"video":n.localMedia|=a.Media.VIDEO;break;case"sharing":n.localMedia|=a.Media.SHARING;break;default:n.localMedia=null}e.debug("LOCAL TYPE || LOCAL MEDIA  "+n.localMedia)},c.prototype.sendProposition=function(o,c,l){e.info("[VideoServiceEventHandler]   | sendProposition to "+JSON.stringify({displayName:o.displayNameForLog(),resources:o.resources}));var d=this,u=["audio"],h=[];"video"===c?u.push("video"):"videoOnly"===c?u=["video"]:"sharing"===c?(u=["sharing"],h=["audio"]):"sharingOnly"==c&&(u=["sharing"]);var f="web_"+s.generate(),p=a.create(a.Status.DIALING,f,a.Type.WEBRTC,o);this.videoService.getBrowserMedia(u).then(function(a){d.videoService.getBrowserMedia(h).then(function(c){if(d.videoService.makingCall&&d.videoService.started){p.isInitiator=!0,a.callId=f,d.videoService.localStreams.push(a),c&&(c.callId=f,d.videoService.localStreams.push(c),u.push(h.pop())),d.videoService.calls[p.id]=p,d.setLocalTypeMedia(u,p);var m="web_"+s.generate(),v=$msg({from:r.userContact.fullJid,to:o.jid,id:m});v.c("propose",{xmlns:d.nameSpace,id:f}),l&&v.c("subject",{xmlns:"urn:xmpp:jingle-subject:0"}).t(l).up(),v.c("description",{xmlns:"urn:xmpp:jingle:apps:rtp:1",media:u[0]}).up(),u[1]&&(v=v.c("description",{xmlns:"urn:xmpp:jingle:apps:rtp:1",media:u[1]}).up()),i.send(v),d.videoService.makingCall=!1,r.setBusyState("dnd",d.videoService.calculatePresenceMessage(p)),t.$broadcast("ON_CALL_UPDATED_EVENT",p),d.videoService.autoreleaseTimeout&&n.cancel(d.videoService.autoreleaseTimeout),d.videoService.autoreleaseTimeout=n(function(t){e.webrtc("MEDIA   | send proposition : no response after 30 seconds : release the call"),p&&d.videoService.rejectCall(t)},3e4,1,!0,p)}else e.warn("[VideoServiceEventHandler]   | sendProposition -- call should no longer be made !"),d.videoService.makingCall=!1,a.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),a.stop&&a.stop(),a=null,c&&(c.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),c.stop&&c.stop(),c=null)}).catch(function(t){e.info("[VideoServiceEventHandler]   | sendProposition failure : "+JSON.stringify({error:t.message})),d.videoService.makingCall=!1,-1!==t.toString().indexOf("getUserMedia")&&d.videoService.openErrorPopup(),d.videoService.removeCallObject(p),d.videoService.resetToSafeState(),d.videoService.autoreleaseTimeout&&n.cancel(d.videoService.autoreleaseTimeout)})}).catch(function(t){e.info("[VideoServiceEventHandler]   | sendProposition failure : "+JSON.stringify({error:t.message})),d.videoService.makingCall=!1,0<=u.indexOf("sharing")||-1===t.toString().indexOf("getUserMedia")||d.videoService.openErrorPopup(),d.videoService.removeCallObject(p),d.videoService.resetToSafeState()})},c.prototype.retractProposition=function(t){e.info("[VideoServiceEventHandler]   | retractProposition for call "+t.id);var n="web_"+s.generate(),a=$msg({from:r.userContact.fullJid,to:t.contact.jid,id:n}).c("retract",{xmlns:this.nameSpace,id:t.id});i.send(a),r.resetBusyState(),this.videoService.removeCallObject(t)},c.prototype.acceptProposition=function(o,c){e.info("[VideoServiceEventHandler]   | acceptProposition for call "+o.id);var l="web_"+s.generate(),d=$msg({from:r.userContact.fullJid,to:r.userContact.jid,id:l}).c("accept",{xmlns:this.nameSpace,id:o.id});i.send(d);var u="web_"+s.generate();d=$msg({from:r.userContact.fullJid,to:o.fullJid,id:u}).c("proceed",{xmlns:this.nameSpace,id:o.id}),i.send(d);var h=["audio"];c&&"video"===c&&h.push("video"),o.remoteMedia===a.Media.VIDEO&&(h=["video"]),o.remoteMedia===a.Media.SHARING&&(h=[]),this.setLocalTypeMedia(h,o),r.setBusyState("dnd",this.videoService.calculatePresenceMessage(o)),o.status=a.Status.ANSWERING,t.$broadcast("ON_CALL_UPDATED_EVENT",o);var f=this;f.videoService.autoreleaseTimeout&&n.cancel(f.videoService.autoreleaseTimeout),f.videoService.autoreleaseTimeout=n(function(t){t&&(null===o.getMediaPillarCall()?e.webrtc("[VideoServiceEventHandler] | acceptProposition autoreleaseTimeout after 45 s : remove the call "+t.id):e.warn("[webrtcgateway/VideoServiceEventHandler] | acceptProposition autoreleaseTimeout after 45 s : remove the call :"+t.id),f.videoService.removeCallObject(t),r.resetBusyState())},45e3,1,!0,o)},c.prototype.rejectProposition=function(o,c){e.info("[VideoServiceEventHandler]   | rejectProposition for call "+o.id);var l="web_"+s.generate(),d=$msg({from:r.userContact.fullJid,to:r.userContact.jid,id:l}).c("reject",{xmlns:this.nameSpace,id:o.id});i.send(d);var u=o.getMediaPillarCall(),h=u&&u.mediaPillarJid?u.mediaPillarJid:o.contact.jid,f="web_"+s.generate();d=$msg({from:r.userContact.fullJid,to:h,id:f}).c("reject",{xmlns:this.nameSpace,id:o.id,reason:c}),i.send(d),o&&(o.status=a.Status.UNKNOWN,delete this.videoService.calls[o.id],t.$broadcast("ON_CALL_UPDATED_EVENT",o)),this.videoService.setWebrtcConfiguration(),this.videoService.autoreleaseTimeout&&n.cancel(this.videoService.autoreleaseTimeout)},c.prototype.onMessageReceived=function(n){var r=this;try{t.$apply(function(){e.info("[VideoServiceEventHandler]   | onMessageReceived");var t=$(n);0<t.find("error").length||0<t.find("delay").length||0<$(n).find("service-unavailable").length?r.onMessageReceivedError():0<t.find("propose").length?r.onPropositionReceived(n):0<t.find("retract").length?r.onRetractReceived(n):0<t.find("reject").length?r.onRejectReceived(n):0<t.find("accept").length?r.onAcceptReceived(n):0<t.find("proceed").length&&r.onProceedReceived(n)})}catch(t){return e.error("[VideoServiceEventHandler]   | onMessageReceived error "+t),!0}return!0},c.prototype.onMessageReceivedError=function(t){e.info("[VideoServiceEventHandler]   | onMessageReceivedError");var n=$(t).find("propose").attr("id"),r=this.videoService.calls[n];r&&e.error("[VideoServiceEventHandler]   | onMessageReceivedError call is in "+r.status.value+" state")},c.prototype.onPropositionReceived=function(o){e.info("[VideoServiceEventHandler]   | onPropositionReceived");var s=$(o).find("propose").attr("id"),c=this.videoService.calls[s],l=this;if(c){if(0<$(o).find("subject").length){var d=$(o).find("subject")[0];e.debug("[VideoServiceEventHandler]   | onPropositionReceived subject Detected: "+d.textContent),c.setSubject(d.textContent)}c.setStatus(a.Status.RINGING_INCOMMING),this.setRemoteTypeMedia(h,c),t.$broadcast("ON_CALL_UPDATED_EVENT",c),l.videoService.autoreleaseTimeout&&n.cancel(l.videoService.autoreleaseTimeout),l.videoService.autoreleaseTimeout=n(function(t){t&&(e.webrtc("[VideoServiceEventHandler]   | onPropositionReceived autoreleaseTimeout after 2 min : remove the call "+t.id),l.videoService.removeCallObject(t))},12e4,1,!0,c)}else{var u=$(o).attr("from"),h=[],f=i.getBareJidFromJid(u);(c=a.create(a.Status.UNKNOWN,s,a.Type.WEBRTC)).fullJid=u,l.videoService.calls[c.id]=c,r.getOrCreateContact(f).then(function(r){for(var i,s=$(o).find("description").length,d=0;d<s;d++)i=$(o).find("description")[d],h.push($(i).attr("media"));if(l.videoService.calls[c.id]){if(c.contact=r,0<$(o).find("subject").length){var u=$(o).find("subject")[0];e.debug("[VideoServiceEventHandler]   | onPropositionReceived subject Detected: "+u.textContent),c.setSubject(u.textContent)}c.setStatus(a.Status.RINGING_INCOMMING),l.setRemoteTypeMedia(h,c),t.$broadcast("ON_CALL_UPDATED_EVENT",c),l.videoService.autoreleaseTimeout&&n.cancel(l.videoService.autoreleaseTimeout),l.videoService.autoreleaseTimeout=n(function(t){t&&(e.webrtc("[VideoServiceEventHandler]   | onPropositionReceived autoreleaseTimeout after 2 min : remove the call "+t.id),l.videoService.removeCallObject(t))},12e4,1,!0,c)}}).catch(function(t){e.error("[VideoServiceEventHandler]   | onPropositionReceived error "+t),l.videoService.removeCallObject(c)})}},c.prototype.onRetractReceived=function(t){e.info("[VideoServiceEventHandler]   | onRetractReceveid");var i=$(t).find("retract").attr("id"),o=this.videoService.calls[i];o&&(o.status===a.Status.ANSWERING&&r.resetBusyState(),this.videoService.removeCallObject(o)),this.videoService.autoreleaseTimeout&&n.cancel(this.videoService.autoreleaseTimeout)},c.prototype.onRejectReceived=function(i){e.info("[VideoServiceEventHandler]   | onRejectReceived");var o=$(i).find("reject").attr("id"),s=this.videoService.calls[o],c=$(i).attr("from"),l="calendarBusy"===$(i).find("reject").attr("reason");this.videoService.autoreleaseTimeout&&n.cancel(this.videoService.autoreleaseTimeout),s&&(s.status===a.Status.RINGING_INCOMMING&&(null!==s.getMediaPillarCall()&&t.$broadcast("ON_MEDIAPILLAR_CALL_REMOTE_CTRL_EVENT",s),this.videoService.removeCallObject(s)),s.status===a.Status.DIALING&&(r.resetBusyState(),this.videoService.removeCallObject(s)),(s.status===a.Status.ACTIVE||s.status===a.Status.CONNECTING)&&s.fullJid&&s.fullJid===c&&(r.resetBusyState(),this.videoService.removeCallObject(s))),l&&this.videoService.openCalendarBusyPopup(s.contact.id)},c.prototype.onAcceptReceived=function(i){e.info("[VideoServiceEventHandler]   | onAcceptReceived");var a=$(i).find("accept").attr("id"),o=this.videoService.calls[a],s=$(i).attr("from");o&&s!==r.userContact.fullJid&&(null!==o.getMediaPillarCall()&&t.$broadcast("ON_MEDIAPILLAR_CALL_REMOTE_CTRL_EVENT",o),this.videoService.removeCallObject(o)),s!==r.userContact.fullJid&&this.videoService.autoreleaseTimeout&&n.cancel(this.videoService.autoreleaseTimeout)},c.prototype.onProceedReceived=function(t){e.info("[VideoServiceEventHandler]   | onProceedReceived"),this.videoService.autoreleaseTimeout&&n.cancel(this.videoService.autoreleaseTimeout);var r=$(t).find("proceed").attr("id"),i=this.videoService.calls[r],o=$(t).attr("from");if(i.fullJid=o,i.isInConversationWithMobile()&&i.localMedia&a.Media.VIDEO){var s=this,c=[],l=s.videoService.getMobileMediaConstraints("video");c=["audio","video"],i.localMedia&a.Media.AUDIO||(c=["video"]),s.videoService.getBrowserMedia(c,l.fixedVideoWidth,l.fixedVideoHeight,l.fixedFrameRate).then(function(t){e.info("[VideoServiceEventHandler]   | onProceedReceived --\x3e renegociate video quality"),i.localMedia&a.Media.VIDEO&&s.videoService.stopActiveAudioVideoStreams(null,!0),s.videoService.localStreams.push(t),s.videoService.makeJingleCall(i)}).catch(function(t){e.info("[VideoServiceEventHandler]   | onProceedReceived "+i+" failure : "+t.message),-1===t.toString().indexOf("getUserMedia")?(s.videoService.releaseCall(i),s.videoService.resetToSafeState()):(e.info("onProceedReceived impossible, no webcam plugged"),s.videoService.openErrorPopup())})}else i.localMedia&a.Media.SHARING?this.videoService.makeJingleSharingCall(i):this.videoService.makeJingleCall(i)},c.prototype.incomingCall=function(a){e.info("[VideoServiceEventHandler] incomingCall "+a);var o=this,s=null,c=i.connection.jingle.sessions[a];if(c&&c.peerjid){var l=i.getBareJidFromJid(c.peerjid),d=r.getContactByJid(l);s=this.videoService.getCallByJid(d.jid)}s?(c.sendRinging(),n(function(e){o.videoService.answerJingleCall(e)},350,1,!0,s),t.$broadcast("ON_CALL_UPDATED_EVENT",s),this.videoService.autoreleaseTimeout&&n.cancel(this.videoService.autoreleaseTimeout),this.videoService.statsInterval&&(e.info("[VideoServiceEventHandler] remove getStats interval"),window.clearInterval(this.videoService.statsInterval),this.videoService.statsinterval=null),o.videoService.createOrUpdateStatisticsForCall(s.id),e.info("[VideoServiceEventHandler] start getStats interval"),this.videoService.statsInterval=c.getStats(5e3)):(e.warn("[VideoServiceEventHandler] incomingCall no such call ! Terminate the session "),r.resetBusyState(),c&&c.terminate())},c.prototype.activeCall=function(r){e.info("[VideoServiceEventHandler] activeCall "+r);var s=i.connection.jingle.sessions[r];this.videoService.autoreleaseTimeout&&n.cancel(this.videoService.autoreleaseTimeout);var c=this.videoService.calls[r];this.videoService.updateRemoteTypeMedia(s.remoteType,c),c&&c.status.key!==a.Status.RELEASING.key&&c.status.key!==a.Status.UNKNOWN.key&&(c.setStatus(a.Status.ACTIVE),t.$broadcast("ON_CALL_UPDATED_EVENT",c)),c.isInitiator&&o.trackCallSuccessNumber(s.localType)},c.prototype.terminatedCall=function(t,a){0===Object.keys(i.connection.jingle.sessions).length&&e.webrtc("INFO    | all calls terminated");var s=this.videoService.calls[t];return s||0===this.videoService.calls.length?("busy"===a&&this.videoService.openErrorPopup("remoteUserNoMoreAvailable"),this.videoService.autoreleaseTimeout&&n.cancel(this.videoService.autoreleaseTimeout),this.videoService.disableAudioVideoMedia(null,t),this.videoService.createOrUpdateStatisticsForCall(t),this.videoService.callsStats[t]&&delete this.videoService.callsStats[t],s&&("cancel"!==a&&o.trackCallDuration((new Date).getTime()-s.startDate.getTime()),this.videoService.removeCallObject(s)),n(function(){r.resetBusyState()},1e3,1,!0),this.videoService.statsInterval&&(window.clearInterval(this.videoService.statsInterval),this.videoService.statsinterval=null),void this.videoService.displayWebRTCStats(t)):void e.webrtc("INFO    | terminatedCall : no call with "+t+" exists.")},c.prototype.onJingleError=function(e){var t=this;e&&t.videoService.calls[e]&&t.videoService.calls[e].status!==a.Status.ACTIVE&&(t.videoService.removeCallObject(t.calls[e]),t.videoService.resetToSafeState(),t.videoService.openErrorPopup("IceConnectionFailed"))},c.prototype.iceConnectionStateChange=function(n,s){e.info("[VideoServiceEventHandler] iceConnectionStateChange for "+n);var c=this,l=null,d=c.videoService.calls[s.sid];try{if(s.peerconnection&&"stable"===s.peerconnection.signalingState&&"connected"===s.peerconnection.iceConnectionState){e.webrtc("INFO    | ICE Connection established successfully"),angular.element("#globalAudioTag")[0]&&e.info("[VideoServiceEventHandler] sinkId for globalAudioTag is "+angular.element("#globalAudioTag")[0].sinkId),c.videoService.reconnectCall=!1,(l=c.videoService.calls[n])&&l.status!==a.Status.ACTIVE&&(e.webrtc("INFO    | ICE Connection : call is active now !"),this.activeCall(n)),s.isRenegotiating&&(e.webrtc("INFO    | Renegotiating done"),s.isRenegotiating=!1,t.$broadcast("ON_WEBRTC_CALL_ESCALATION",l),t.$broadcast("ON_WEBRTC_CALL_ESCALATION_SUCCESS",l)),o.endNegotiationTime();var u=o.negotiationTime();u&&(e.webrtc("INFO    | negotiation time: "+u+"ms"),o.trackNegotiationTime()),l&&l.isInitiator&&o.trackICESuccess(n)}s.peerconnection&&"stable"===s.peerconnection.signalingState&&"completed"===s.peerconnection.iceConnectionState&&(e.webrtc("INFO    | ICE Connection completed successfully"),c.videoService.reconnectCall=!1,(l=c.videoService.calls[n])&&l.status!==a.Status.ACTIVE&&(e.webrtc("INFO    | ICE Connection : call is active now !"),this.activeCall(n)),s.isRenegotiating&&(e.webrtc("INFO    | Renegotiating done"),s.isRenegotiating=!1,t.$broadcast("ON_WEBRTC_CALL_ESCALATION",l),t.$broadcast("ON_WEBRTC_CALL_ESCALATION_SUCCESS",l))),s.peerconnection&&"stable"===s.peerconnection.signalingState&&"disconnected"===s.peerconnection.iceConnectionState&&(e.webrtc("INFO    | signalingState disconnected"),d&&d.status!==a.Status.UNKNOWN&&(e.webrtc("INFO    | iceConnectionStateChange go to connecting state"),d.setStatus(a.Status.CONNECTING),t.$broadcast("ON_CALL_UPDATED_EVENT",d)),!c.videoService.connected&&(c.videoService.reconnectCall=!0)),s.peerconnection&&"stable"===s.peerconnection.signalingState&&"failed"===s.peerconnection.iceConnectionState&&(e.webrtc("INFO    | signalingState FAILED"),d&&d.status!==a.Status.UNKNOWN&&(e.webrtc("INFO    | iceConnectionStateChange go to connecting state"),d.setStatus(a.Status.CONNECTING),t.$broadcast("ON_CALL_UPDATED_EVENT",d),t.$broadcast("ON_RECORDING_CNXLOST_EVENT")),!c.videoService.connected&&(c.videoService.reconnectCall=!0))}catch(t){try{e.error("JINGLE  | iceconnectionstatechange error "+t),d?c.videoService.removeCallObject(d,"unsupported-applications"):i.connection.jingle.terminate(null,"unsupported-applications"),r.resetBusyState()}catch(t){e.error("JINGLE  | iceconnectionstatechange error "+t),r.resetBusyState()}}},c.prototype.mediaModified=function(n,o){e.info("[VideoServiceEventHandler] mediaModified "+n);var s=this.videoService.calls[n];i.connection.jingle.sessions[n].isRenegotiating=!0,s.remoteMedia="sharing"===o?a.Media.AUDIO|a.Media.SHARING:"video"===o?a.Media.AUDIO|a.Media.VIDEO:"sharing+video"===o?a.Media.AUDIO|a.Media.VIDEO|a.Media.SHARING:a.Media.AUDIO,r.setBusyState("dnd",this.videoService.calculatePresenceMessage(s)),t.$broadcast("ON_WEBRTC_CALL_ESCALATION",s)},c}])},function(){angular.module("rainbow").service("webrtcServiceEventHandler",["$log","$q","$rootScope","videoService","webConferenceService","xmppService","contactService","Call",function(e,t,n,r,i,a,o,s){"use strict";var c=this;this.nameSpace="urn:xmpp:jingle-message:0",this.messageHandlerRef=null,this.started=!1,this.start=function(){return this.started=!0,this.attachHandlers(),t.when()},this.stop=function(){return this.started=!1,c.removeHandlers(),t.when()},this.attachHandlers=function(){this.removeHandlers(),e.info("[webrtcServiceEventHandler] attachHandlers"),this.messageHandlerRef||(this.messageHandlerRef=a.addHandler(function(t){try{return c.onMessageReceived(t),!0}catch(t){return e.error("[webrtcServiceEventHandler] caught error "+t),!0}},c.nameSpace,"message"))},this.removeHandlers=function(){e.info("[webrtcServiceEventHandler] removeHandlers"),this.messageHandlerRef&&(a.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null)},this.onMessageReceived=function(t){var n=$(t).attr("from"),s=a.getBareJidFromJid(n),c=$(t).find("propose").find("conference").attr("id");if(i.getConferenceSessionById(c))try{if(e.info("[webrtcServiceEventHandler]   | onMessageReceived"),0<$(t).find("propose").length){var l=$(t).find("propose").attr("id"),d=$msg({from:o.userContact.fullJid,to:o.userContact.jid}).c("accept",{xmlns:this.nameSpace,id:l});a.send(d);d=$msg({from:o.userContact.fullJid,to:s}).c("proceed",{xmlns:this.nameSpace,id:l});return a.send(d),!0}}catch(e){return r.videoEventHandler.onMessageReceived(t)}return r.videoEventHandler.onMessageReceived(t)},this.checkSessionAudioSentHealthStatus=function(t){e.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- 0 audio packets sent !");var o=r.calls[t];if(!o||o.isInCallWithMediaPillar()){var c=i.getActiveConferenceSession();if(c&&c.id&&c.active&&"connected"===c.status){var l=i.getRemoteAudioSession(c.id);if(l&&l.sid===t){if(r.callsStatsSimplified[t].numberOfErrorAudioSent+=1,r.callsStatsSimplified[t].numberOfErrorAudioSent%2)return void e.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- ingore");e.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- renego SFU conference"),i.onAudioProfileChangeEvent()}}}else if(o.status.key===s.Status.ACTIVE.key&&o.localMedia&s.Media.AUDIO&&!o.isMuted){if(r.callsStatsSimplified[t].numberOfErrorAudioSent+=1,r.callsStatsSimplified[t].numberOfErrorAudioSent%2)return void e.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- ingore");var d=a.connection.jingle.sessions[o.id];d&&!d.isRenegotiating&&(e.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- renego P2P call"),r.renegotiateCurrentCall(o)),n.$broadcast("ON_WEBRTC_CALL_AUDIO_ISSUE",!0)}},this.checkSessionAudioReceivedHealthStatus=function(t){e.info("[webrtcServiceEventHandler]   | checkSessionAudioReceivedHealthStatus --- user hears nothing !");var n=r.calls[t];if(n&&!n.isInCallWithMediaPillar())n.status.key===s.Status.ACTIVE.key&&n.remoteMedia&s.Media.AUDIO&&(r.callsStatsSimplified[t].errorAudioReceived=1,e.info("[webrtcServiceEventHandler]   | checkSessionAudioReceivedHealthStatus --- reset output device"),r.resetAudioOutputElement());else{var a=i.getActiveConferenceSession();if(a&&a.id&&a.active&&"connected"===a.status){var o=i.getRemoteAudioSession(a.id);o&&o.sid===t&&(r.callsStatsSimplified[t].errorAudioReceived=1,e.info("[webrtcServiceEventHandler]   | checkSessionAudioReceivedHealthStatus --- renego SFU conference"),r.resetAudioOutputElement())}}},angular.element(document).bind("callincoming.jingle",function(t,n){e.webrtc("webrtcServiceEventHandler  | callincoming.jingle "+n);var o=a.connection.jingle.sessions[n];o&&o.confId?i.onIncomingCall(n):r.videoEventHandler.incomingCall(n)}),angular.element(document).bind("callterminated.jingle",function(t,a,o){n.$apply(function(){var t=o||"";(e.webrtc("webrtcServiceEventHandler  | callterminated "+a+" reason: "+t),"multi-device"===o)?i.onConferenceCallSwitched(a):r.calls[a]?r.videoEventHandler.terminatedCall(a,t):i.onTerminatedCall(a)})}),angular.element(document).bind("iceconnectionstatechange.jingle",function(t,n,a){a.peerconnection?(e.webrtc("JINGLE  | iceconnectionstatechange "+n+" "+a.peerconnection.iceConnectionState+"|"+a.peerconnection.signalingState),r.calls[n]?r.videoEventHandler.iceConnectionStateChange(n,a):i.onIceConnectionStateChange(n,a)):e.webrtc("JINGLE  | iceconnectionstatechange - peerConnection does not exist anymore !!!")}),angular.element(document).bind("error.jingle",function(t,n){e.error("JINGLE  | callerror"),n&&n.error&&e.error(JSON.stringify(n.error));var a=n.sid;a&&(r.calls[a]?r.videoEventHandler.onJingleError(a):i.onJingleError(a))}),angular.element(document).bind("webrtcSessionStatsSimplyfied.jingle",function(t,i,a){r.callsStatsSimplified[i]||(r.callsStatsSimplified[i]={},r.callsStatsSimplified[i].numberOfErrorAudioSent=0,r.callsStatsSimplified[i].errorAudioReceived=0),a.numberOfErrorAudioSent=r.callsStatsSimplified[i].numberOfErrorAudioSent,a.errorAudioReceived=r.callsStatsSimplified[i].errorAudioReceived,r.callsStatsSimplified[i]=a,e.info("[videoService] on webrtcSessionStatsSimplyfied for session "+i+" : "+JSON.stringify(a)),"chrome"===adapter.default.browserDetails.browser&&71>adapter.default.browserDetails.version&&(0===a.packetsAudioSent||0===a.audioInputLevel?c.checkSessionAudioSentHealthStatus(i):(r.callsStatsSimplified[i].numberOfErrorAudioSent&&n.$broadcast("ON_WEBRTC_CALL_AUDIO_ISSUE",!1),r.callsStatsSimplified[i].numberOfErrorAudioSent=0)),a.packetsAudioReceived&&0===a.audioOutputLevel&&0===a.errorAudioReceived&&c.checkSessionAudioReceivedHealthStatus(i)})}])},function(){angular.module("rainbow").service("settingsService",["$rootScope","$translate","$localStorage",function(e,t,n){"use strict";var r=this;r.initialize=function(){r.defaultLanguage={label:"English",settingCode:"en",code:"en",isoCode:"en",codeMoment:"en",unicode:"1f1ec-1f1e7",beta:!1},r.languages=[r.defaultLanguage,{label:"Franais",settingCode:"fr",code:"fr",isoCode:"fr",codeMoment:"fr",unicode:"1f1eb-1f1f7",beta:!1},{label:"Deutsch",settingCode:"de",code:"de",isoCode:"de",codeMoment:"de",unicode:"1f1e9-1f1ea",beta:!1},{label:"Espaol",settingCode:"es-es",code:"es-es",isoCode:"es-ES",codeMoment:"es",unicode:"1f1ea-1f1f8",beta:!1},{label:"Suomi",settingCode:"fi",code:"fi",isoCode:"fi",codeMoment:"fi",unicode:"1f1eb-1f1ee",beta:!0},{label:"Italiano",settingCode:"it",code:"it",isoCode:"it",codeMoment:"it",unicode:"1f1ee-1f1f9",beta:!1},{label:"",settingCode:"he",code:"he",isoCode:"he",codeMoment:"he",unicode:"1f1ee-1f1f1",beta:!1},{label:"",settingCode:"ja",code:"ja",isoCode:"ja",codeMoment:"ja",unicode:"1f1ef-1f1f5",beta:!1},{label:"",settingCode:"ko",code:"ko",isoCode:"ko",codeMoment:"ko",unicode:"1f1f0-1f1f7",beta:!1},{label:"Nederlands",settingCode:"nl",code:"nl",isoCode:"nl",codeMoment:"nl",unicode:"1F1F3-1F1F1",beta:!1},{label:"Nynorsk",settingCode:"no",code:"no",isoCode:"no",codeMoment:"nn",unicode:"1F1F3-1F1F4",beta:!0},{label:"Portugus do Brasil",settingCode:"pt-br",code:"pt-BR",isoCode:"pt-BR",codeMoment:"pt-br",unicode:"1F1E7-1F1F7",beta:!1},{label:"Portugus",settingCode:"pt-pt",code:"pt-PT",isoCode:"pt-PT",codeMoment:"pt",unicode:"1F1F5-1F1F9",beta:!1},{label:"Polski",settingCode:"pl",code:"pl",isoCode:"pl",codeMoment:"pl",unicode:"1F1F5-1F1F1",beta:!0},{label:"Svenskt",settingCode:"sv-se",code:"sv-SE",isoCode:"sv-SE",codeMoment:"sv",unicode:"1F1F8-1F1EA",beta:!0},{label:"Trke",settingCode:"tr",code:"tr",isoCode:"tr",codeMoment:"tr",unicode:"1f1f9-1f1f7",beta:!1},{label:"",settingCode:"zh-cn",code:"zh-cn",isoCode:"zh-CN",codeMoment:"zh-cn",unicode:"1f1e8-1f1f3",beta:!1},{label:"",settingCode:"zh-tw",code:"zh-TW",isoCode:"zh-TW",codeMoment:"zh-tw",unicode:"1F1F9-1F1FC",beta:!1}],r.languageCodes=r.getAvailableLanguages().map(function(e){return e.settingCode}),r.settings={init:!0,lang:"en",imSound:"true",imNotif:"true",notifReminder:"gentle",displayOrder:"FL",nbMaxConversations:"100",skin:"rainbow",microphone:"default",headsetMicrophone:null,speakerphoneMicrophone:null,customMicrophone:null,headsetDeviceName:null,speakerphoneDeviceName:null,speaker:"default",headsetSpeaker:null,speakerphoneSpeaker:null,customSpeaker:null,ringingSpeaker:"default",camera:"default",audioProfile:"handfree",currentDevice:null,iceConfig:null,sdk:!1,userWiewOrderType:"lastname",userWiewFilterType:"all",one2oneColors:"true",accessibleColors:"false",autoStartAnimatedGif:"false",translationMsg:"false",server:null,activeAlarm:"relax1",activeNotif:"stairs",devMode:"false",hasSecondRinger:"false",validationMode:"false",disableCalendarPresence:"false",giphy:"false",deviceList:"[]",displayFilesType:"document-cell--as-grid",handFreeInputDeviceName:null,handFreeOutputDeviceName:null,customSpeakerName:null,customMicrophoneName:null,showBodyMessage:"false",bubblesFilterType:"all",bubblesOrderType:"creationDate",suggestionDisplayed:"null",protectionAgainstMailTypeOffline:!1,channelMarkdown:"false",chrisPrankMode:"true",joinSfuSound:"true",disableSingleSignOn:"true",disableSingleSignOnAuthPopup:"true",disableSingleLogout:"false",enableSingleSignOnConfig:"false",guideTourDisplayed:"null",searchFilterValue:"NoFiltering"},n.get(Object.keys(r.settings)).then(function(a){a.nbMaxConversations?15>parseInt(a.nbMaxConversations,10)&&r.setSetting("nbMaxConversations",15):a.nbMaxConversations=r.settings.nbMaxConversations;if(a.skin||(a.skin=r.settings.skin),e.default_language&&(a.lang=i(e.default_language),r.setSetting("lang",a.lang)),"default"===a.headsetMicrophone&&(a.headsetMicrophone=null),"default"===a.headsetSpeaker&&(a.headsetSpeaker=null),"default"===a.speakerphoneMicrophone&&(a.speakerphoneMicrophone=null),"default"===a.speakerphoneSpeaker&&(a.speakerphoneSpeaker=null),"default"===a.customMicrophone&&(a.customMicrophone=null),"default"===a.customSpeaker&&(a.customSpeaker=null),null===a.init){var o=navigator.languages?navigator.languages[0]:navigator.language||navigator.userLanguage;r.settings.lang=a.lang?a.lang:i(o),n.set(r.settings)}else Object.keys(a).forEach(function(e){null!==a[e]&&(r.settings[e]=a[e])});var s=r.getAppliLanguage();t.use(s.code),moment.locale(s.codeMoment)})},r.getSetting=function(e){return r.settings[e]},r.setSetting=function(e,t){r.settings[e]=t,n.set(r.settings)},r.getAvailableLanguages=function(){return r.languages.filter(function(e){return!1===e.beta||config.betaLanguages})},r.getAppliLanguage=function(){var e=r.getAvailableLanguages().filter(function(e){return e.settingCode===r.settings.lang})[0];return e||r.defaultLanguage},r.setAppliLanguageCode=function(n,i){i?r.setSetting("lang",n):r.settings.lang=n;var a=r.getAppliLanguage();moment.locale(a.codeMoment),t.use(a.code).then(function(){e.$broadcast("ON_LANGUAGE_UPDATED_EVENT",n)})},r.getAppliLanguageCodeForServer=function(){var e=r.settings.lang.split("-");return 1===e.length?r.settings.lang:e[0]+"-"+e[1].toUpperCase()},r.setAppliLangageCodeFromServer=function(e){var t=e.split("-"),n=t[0];n&&(n=n.toLowerCase()),2===t.length&&(n+="-"+t[1].toLowerCase()),n=i(n),n=0<=r.languageCodes.indexOf(n)?n:"en",r.setAppliLanguageCode(n)},r.getLanguageByIsoCode=function(e){return r.languages.find(function(t){return t.isoCode===e})},r.getBestLanguageForIsoCode=function(e){var t=r.getLanguageByIsoCode(e);if(!t){if(-1!==e.indexOf("-")){var n=e.split("-")[0];t=r.getLanguageByIsoCode(n)}t||(t=r.getLanguageByIsoCode("en"))}return t},r.setIceConfig=function(e){r.settings.iceConfig=e},r.forceTurn=function(t){config.turnOn=t;var n=t?"Debug mode : Only use turn servers":"Normal mode : use stun and turn servers";e.$broadcast("ON_SETTING_FORCE_TURN_EVENT",n)},r.enableRemoteConsole=function(e){var t=document.createElement("script");t.src="//console.re/connector.js",t.id="consolerescript",t.setAttribute("data-channel",e),t.onreadystatechange=t.onload=function(){app.remoteConsole.info=!0,app.remoteConsole.debug=!0,app.remoteConsole.log=!0,console.re.info("Connected")},document.getElementsByTagName("head")[0].appendChild(t)};var i=function(e){var t="en";if(e){var n=e.split("-")[0];t="en"===n?"en":"fr"===n?"fr":"de"===n?"de":"es"===n?"es-es":"fi"===n?"fi":"it"===n?"it":"he"===n?"he":"ja"===n?"ja":"ko"===n?"ko":"nl"===n?"nl":"no"===n?"no":"pt"===n?"pt-br"===e.toLowerCase()?"pt-br":"pt-pt":"pl"===n?"pl":"sv"===n?"sv-SE":"tr"===n?"tr":"zh"===n?0<=["zh-cn","zh-tw"].indexOf(e.toLowerCase())?e.toLowerCase():"zh-cn":"en"}return t};r.initialize()}])},function(){var e=Number.parseInt;class t{constructor(){this.messages=[],this.complete=!1,this.pageIndex=0,this.isLoading=!1,this.type="AGGREGATE"}}class n{constructor(e,t,n,r,i,a,o,s,c,l,d){this.$q=e,this.$http=t,this.$log=n,this.$rootScope=r,this.authService=i,this.xmppService=a,this.contactService=o,this.Channel=s,this.roomService=c,this.Contact=l,this.profileService=d,this.listeners=[],this.channels={},this.channelsList=[],this.LIST_EVENT_TYPE={ADD:0,UPDATE:1,REMOVE:2,DELETE:3,SUBSCRIBE:4,UNSUBSCRIBE:5,CREATE:6},this.USER_ROLE={NONE:"none",OWNER:"owner",PUBLISHER:"publisher",MEMBER:"member"},this.MESSAGE_ACTION={ADD:0,RETRACT:1},this.xmpp_message_handler=null,this.xmpp_management_handler=null,this.notificationCounter=0,this.messageCounter=0,this.invitationCounter=0,this.CHANNEL_UPDATE_EVENT="CHANNEL_UPDATE_EVENT",this.CHANNEL_MESSAGE_RECEIVED="CHANNEL_MESSAGE_RECEIVED",this.CHANNEL_USERS_UPDATE_EVENT="CHANNEL_USERS_UPDATE_EVENT",this.CHANNEL_NOTIFICATION_NUMBER_UPDATED="CHANNEL_NOTIFICATION_NUMBER_UPDATED",this.CHANNEL_USER_SUBSCRIPTION_EVENT="CHANNEL_USER_SUBSCRIPTION_EVENT"}start(e){return this.$q(t=>{if(!this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.CHANNEL_ACTIVATED))return t();if(this.contactService.userContact.isCPaaSGuest())return t();this.$log.info("[channelService] === STARTING ===");let n=performance.now();this.init(),this.getMyChannels().then(()=>{let r=Math.round(performance.now()-n);this.$log.info("[channelService] === STARTED ("+r+" ms) ==="),e.push({service:"channelService",startDuration:r}),t()}).catch(e=>{this.$log.info("[channelService] === STARTING FAILURE === "+e.message),t()})})}init(){this.feedChannel=new t,this.portalURL=config.restServerUrl+"/api/rainbow/channels/v1.0/channels",this.attachHandlers(),this.attachListeners()}attachHandlers(){this.$log.info("[channelService] attachHandlers"),this.xmpp_message_handler&&(this.xmppService.connection.deleteHandler(this.xmpp_message_handler),this.xmpp_message_handler=null),this.xmpp_management_handler&&(this.xmppService.connection.deleteHandler(this.xmpp_management_handler),this.xmpp_management_handler=null),this.xmpp_message_handler=this.xmppService.connection.addHandler(e=>this.onChannelMessageReceived(e),null,"message","headline"),this.xmpp_management_handler=this.xmppService.connection.addHandler(e=>this.onChannelManagementReceived(e),null,"message","management")}attachListeners(){this.listeners.push(this.$rootScope.$on(this.CHANNEL_USERS_UPDATE_EVENT,(e,t,n)=>this.usersUpdateHandler(e,t,n)))}stop(){return this.$q(e=>{this.$log.info("[channelService] === STOPPING ==="),this.listeners.forEach(e=>{e()}),this.channels={},this.channelsList=[],this.feedChannel=null,this.notificationCounter=0,this.$log.info("[channelService] === STOPPED ==="),e()})}reconnect(){return this.$q(e=>{this.$log.info("[channelService] reconnect"),this.stop(),this.start([]),e()})}removeChannelFromCache(e){return this.$q((t,n)=>{let r=this.getChannelFromCache(e);if(r){let i=r.name;r.invited&&this.decrementInvitationCounter(),delete this.channels[e],this.updateChannelsList(),this.feedChannel.messages=[],this.retrieveLatests().then(()=>{t(i)}).catch(e=>{n(e)})}})}onChannelMessageReceived(e){try{return this.$rootScope.$apply(()=>{let t=angular.element(e).find("event");if(t&&"http://jabber.org/protocol/pubsub#event"===t.attr("xmlns")){this.$log.info("[channelService] onChannelMessageReceived ");let e=t.find("items"),n=e.find("item"),r=e.find("retract");if(1===n.length)this.onNewMessage(n);else if(1===r.length){let t=r.attr("id"),n=e.attr("node").split(":")[0];this.onRetractMessage(n,t)}}}),!0}catch(e){return this.$log.error("[channelService] onChannelMessageReceived -- failure -- "+e.message),!0}}onNewMessage(e){let t=e.find("entry"),n=e.attr("id"),r=t.attr("channelId"),i=t.attr("creation")?"modify":"new";this.$log.info("[channelService] onChannelMessageReceived -- "+i+" message "+n+" on channel "+r);let a={id:n,displayId:n+"-"+t.attr("timestamp"),channelId:r,from:t.attr("from"),fromDetails:null,new:!1,entry:{type:t.find("type").length?t.find("type")[0].textContent:"",message:t.find("message").length?t.find("message")[0].textContent:"",title:t.find("title").length?t.find("title")[0].textContent:"",url:t.find("url").length?t.find("url")[0].textContent:"",images:[],attachments:[],video:null},modified:"modify"==i,timestamp:new Date(t.attr("timestamp"))};a.entry.message=a.entry.message.replace(/<a/gi,"<a target='_blank' rel='noopener noreferrer' ");let o=e.find("images");0!==o.length&&o.find("id").each((e,t)=>{a.entry.images.push({id:t.textContent})});let s=e.find("attachments");0!==s.length&&s.find("id").each((e,t)=>{a.entry.attachments.push({id:t.textContent})});let c=e.find("video");0!==c.length&&(a.entry.video={provider:c.find("provider")[0].textContent,id:c.find("id")[0].textContent});let l=this.getChannelFromCache(r);this.contactService.getOrCreateContact(a.from).then(e=>{if(a.fromDetails={displayName:e.displayName,id:e.dbId,avatar:e.avatar},a.fromContact=e,"new"==i)l.loaded&&l.messages.unshift(a),this.feedChannel.messages.unshift(a),this.contactService.userContact.jid!==a.from&&(a.new=!0,this.incrementMessagesCounter()),this.$rootScope.$broadcast(this.CHANNEL_MESSAGE_RECEIVED,this.MESSAGE_ACTION.ADD,a);else{let e=l.messages.findIndex(e=>e.id===n),t=this.feedChannel.messages.findIndex(e=>e.id===n);-1!==e&&l.messages.splice(e,1,a),-1!==t&&this.feedChannel.messages.splice(t,1,a)}})}onRetractMessage(e,t){this.$log.info("[channelService] onChannelMessageReceived -- retract message "+t+" on channel "+e);let n=this.getChannelFromCache(e),r=n.messages.findIndex(e=>e.id===t);if(-1!==r){n.messages[r].new&&this.decrementMessagesCounter(),n.messages.splice(r,1)}let i=this.feedChannel.messages.findIndex(e=>e.id===t);-1!==i&&this.feedChannel.messages.splice(i,1),this.$rootScope.$broadcast(this.CHANNEL_MESSAGE_RECEIVED,this.MESSAGE_ACTION.RETRACT,t)}onChannelManagementReceived(t){try{return this.$rootScope.$apply(()=>{let n=angular.element(t).find("channel");if(n&&0<n.length){let e=n.attr("channelid"),t=this.getChannelFromCache(e);if(t){let r=n.find("avatar"),i=n.find("name"),a=n.find("topic"),o=n.find("category");r&&0<r.length&&this.onAvatarChange(e,r),i&&0<i.length&&(t.name=i.text()),a&&0<a.length&&(t.topic=a.text()),o&&0<o.length&&(t.category=o.text())}let r=n.attr("action");switch(this.$log.info("[channelService] onChannelManagementReceived -- "+r+" event received on channel "+e),r){case"add":this.onAddToChannel(e);break;case"update":this.onUpdateToChannel(e);break;case"remove":this.onRemovedFromChannel(e);break;case"subscribe":this.onSubscribeToChannel(e,n.attr("subscribers"));break;case"unsubscribe":this.onUnsubscribeToChannel(e,n.attr("subscribers"));break;case"delete":this.onDeleteChannel(e)}}let r=angular.element(t).find("channel-subscription");if(r&&0<r.length){let t=r.attr("channelid"),n=r.attr("action"),i=r.attr("id"),a=r.attr("subscribers");switch(this.getChannelFromCache(t).subscribers_count=e(a),this.$log.info("[channelService] onChannelManagementReceived -- subscription-"+n+" event received on channel "+t),n){case"subscribe":this.onUserSubscribeEvent(t,i);break;case"unsubscribe":this.onUserUnsubscribeEvent(t,i)}}}),!0}catch(e){return this.$log.error("[channels] onChannelManagementReceived -- failure -- "+e.message),!0}}onAvatarChange(e,t){let n=t.attr("action"),r=t.attr("lastAvatarUpdateDate")?new Date(t.attr("lastAvatarUpdateDate")):null;if(this.$log.info("[channelService] onChannelManagementReceived -- "+n+" avatar for "+e),"delete"===n||"update"===n){let t=this.getChannelFromCache(e);t.lastAvatarUpdateDate=r,null!==r&&(t.avatar=config.restServerUrl+"/api/channel-avatar/"+e+"?size=256&ts="+new Date(r).getTime())}}onUpdateToChannel(e){this.getChannelFromCache(e),this.getChannel(e).then(e=>{e.invited&&(this.addChannelToCache(e),this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.ADD,e.id))})}onAddToChannel(e){let t=this.getChannelFromCache(e);this.getChannel(e).then(n=>{t||n.invited?!t&&n.invited?(this.addChannelToCache(n),this.incrementInvitationCounter(),this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,n.id)):t&&n.userRole!==this.USER_ROLE.NONE&&(t.userRole=n.userRole,this.feedChannel.messages=[],this.retrieveLatests().then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,e)})):(this.addChannelToCache(n),this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.ADD,n.id))})}onRemovedFromChannel(e){this.removeChannelFromCache(e).then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.DELETE,e)})}onSubscribeToChannel(t,n){let r=this.getChannelFromCache(t),i=e(n);r?(r.invited=!1,r.subscribed=!0,r.subscribers_count=i,this.feedChannel.messages=[],this.retrieveLatests().then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,t)})):this.getChannel(t).then(e=>(this.addChannelToCache(e),this.feedChannel.messages=[],this.retrieveLatests())).then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,t)})}onUnsubscribeToChannel(t,n){let r=e(n),i=this.getChannelFromCache(t);i.subscribers_count=r,i.subscribed=!1,this.feedChannel.messages=[],this.retrieveLatests().then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.UNSUBSCRIBE,t)})}onDeleteChannel(e){this.removeChannelFromCache(e).then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.DELETE,e)})}onUserSubscribeEvent(e,t){this.$rootScope.$broadcast(this.CHANNEL_USER_SUBSCRIPTION_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,e,t)}onUserUnsubscribeEvent(e,t){this.$rootScope.$broadcast(this.CHANNEL_USER_SUBSCRIPTION_EVENT,this.LIST_EVENT_TYPE.UNSUBSCRIBE,e,t)}getChannelNextPage(e,t=!1){return this.$q((r,i)=>{let a="AGGREGATE"===e.type?"feedChannel":e.id;if(e.isLoading)return this.$log.info("[channelService] getChannelNextPage("+a+", "+e.pageIndex+") -- ignored (isLoading)"),r();e.isLoading=!0,t&&(e.pageIndex=0);e.messages.length;let o=(e.pageIndex+1)*n.PAGE_SIZE;if(o<=e.messages.length)this.$log.info("[channelService] getChannelNextPage("+a+", "+e.pageIndex+") -- success from cache"),e.pageIndex+=1,e.isLoading=!1,r({messages:e.messages,nbMessages:o});else if(e.complete)this.$log.info("[channelService] getChannelNextPage("+a+", "+e.pageIndex+") -- success from cache (complete)"),e.isLoading=!1,r({messages:e.messages,nbMessages:e.messages.length});else{let t=e.messages,o=t.length?t[t.length-1].timestamp:null;this.getChannelMessages(e,o).then(t=>{t<n.PAGE_SIZE&&(e.complete=!0),this.$log.info("[channelService] getChannelNextPage("+a+", "+e.pageIndex+") -- success from server "+(e.complete?"(complete)":"")+" -- retreive "+t+" message(s)"),e.pageIndex+=1,e.loaded=!0,e.isLoading=!1,r({messages:e.messages,nbMessages:e.messages.length})}).catch(t=>{e.isLoading=!1,this.channelErrorHandler("getChannelNextPage("+a+", "+e.pageIndex+")",i,t)})}})}getChannelPublishers(e){return this.$q((t,n)=>e.publishersRetreived?t():void this.getChannelUsers(e.id,{format:"full",types:"owner publisher"}).then(n=>{n.data.forEach(t=>{let n=this.contactService.getContactByJid(t.jid_im);n||((n=new this.Contact).updateFromUserData(t),n.updateRichStatus(),this.contactService.contacts[n.id]=n,this.contactService.dbContacts[n.dbId]=n,this.contactService.jtelContacts[n.jidtel]=n),e.users.push(n)}),e.publishersRetreived=!0,this.$log.info("[channelService] getChannelPublishers ("+e.id+") -- success -- find "+n.length+" publisher(s)"),t()}).catch(t=>{this.channelErrorHandler("getChannelPublishers ("+e.id+")",n,t)}))}getChannelMessages(e,t){return this.$q(r=>{let i=null;(i="AGGREGATE"===e.type?this.getLatestMessages(10,t):this.getChannelItems(e.id,n.PAGE_SIZE,t)).then(t=>{t.forEach(e=>{"null"===e.entry.images&&(e.entry.images=[]),("null"===e.entry.attachments||void 0===e.entry.attachments)&&(e.entry.attachments=[]),e.entry.attachments instanceof Array||(e.entry.attachments=[e.entry.attachments]),e.entry.message&&(e.entry.message=e.entry.message.replace(/<a/gi,"<a target='_blank' rel='noopener noreferrer' ")),e.entry.message&&e.entry.message,this.contactService.getOrCreateContact(e.from).then(t=>{e.fromDetails={displayName:t.displayName,id:t.dbId,avatar:t.avatar},e.fromContact=t})}),e.messages.push.apply(e.messages,t),r(t.length)})})}getMyChannels(){return this.$q((e,t)=>{this.$http({method:"GET",url:this.portalURL+"?format=full",headers:this.authService.getRequestHeader()}).then(t=>{this.$log.info("[channelService] getMyChannels -- success"),t.data.data.forEach(e=>{let t=this.Channel(e);t.invited&&this.incrementInvitationCounter(),(t.subscribed||t.invited)&&(this.channels[t.id]=t)}),this.updateChannelsList(),e(this.channelsList)}).catch(e=>{this.channelErrorHandler("getMyChannels",t,e)})})}createChannel(e,t,n="",r="globalnews",i=!1,a=100){return this.$q((o,s)=>{let c=this.portalURL+(i?"?auto_provisioning=true":"");this.$http({method:"POST",url:c,headers:this.authService.getPostHeader(),data:{name:e,mode:t,topic:n,category:r,max_items:a}}).then(n=>{this.$log.info("[channelService] createChannel -- "+e+" -- "+t+" -- success");let r=this.Channel(n.data.data);o(r)}).catch(n=>{this.channelErrorHandler("createChannel -- "+e+" -- "+t,s,n)})})}deleteChannel(e){return this.$q((t,n)=>{this.$http({method:"DELETE",url:this.portalURL+"/"+e,headers:this.authService.getPostHeader()}).then(n=>{this.$log.info("[channelService] deleteChannel -- "+e+" -- success"),t(n)}).catch(t=>{this.channelErrorHandler("deleteChannel ("+e+")",n,t)})})}findChannels(e){return this.$q((t,n)=>{let r="?sortOrder="+(e.sortOrder&&1===e.sortOrder?"1":"-1");void 0!==e.subscribed&&(r+="&subscribed="+e.subscribed),e.name&&(r+="&name="+e.name),e.topic&&(r+="&topic="+e.topic),e.limit&&(r+="&limit="+e.limit),e.offset&&(r+="&offset="+e.offset),e.sortField&&(r+="&sortField="+e.sortField),e.category&&(r+="&category="+e.category),this.$http({method:"GET",url:this.portalURL+"/search"+r,headers:this.authService.getRequestHeader()}).then(e=>{let n=[];e.data.data.forEach(e=>{n.push(this.Channel(e))}),t(n)}).catch(e=>{this.channelErrorHandler("findChannels ("+r+")",n,e)})})}browseChannels(e){return this.$q((t,n)=>{let r="?sortOrder="+(e.sortOrder&&1===e.sortOrder?"1":"-1");e.category&&(r+="&category="+e.category),e.excluded_category&&(r+="&excluded_category="+e.excluded_category),void 0!==e.subscribed&&(r+="&subscribed="+e.subscribed),e.limit&&(r+="&limit="+e.limit),e.offset&&(r+="&offset="+e.offset),e.sortField&&(r+="&sortField="+e.sortField),this.$http({method:"GET",url:this.portalURL+"/browse"+r,headers:this.authService.getRequestHeader()}).then(e=>{let n=[];e.data.data.forEach(e=>{n.push(this.Channel(e))}),t(n)}).catch(e=>{this.channelErrorHandler("browseChannels ("+r+")",n,e)})})}getChannel(e){return this.$q((t,n)=>{this.$http({method:"GET",url:this.portalURL+"/"+e,headers:this.authService.getRequestHeader()}).then(n=>{this.$log.info("[channelService] getChannel -- "+e+" -- success");let r=this.Channel(n.data.data);t(r)}).catch(t=>{this.channelErrorHandler("getChannel ("+e+")",n,t)})})}getChannelFromCache(e){let t=this.channels[e];return void 0===t?null:t}publishToChannel(e,t,n,r,i,a,o,s,c){return this.$q((a,l)=>{let d={type:n,title:i||"",message:r||"",images:o||[],attachments:c||[]},u=t?"?itemId="+t:"";s&&(d.video=s),this.$http({method:"POST",url:this.portalURL+"/"+e+"/publish"+u,headers:this.authService.getRequestHeader(),data:d}).then(t=>{this.$log.info("[channelService] publishToChannel -- "+e+" -- "+n+" -- success"),a(t)}).catch(t=>{this.channelErrorHandler("publishToChannel ("+e+")",l,t)})})}subscribeToChannel(e){return this.$q((t,n)=>{this.$http({method:"POST",url:this.portalURL+"/"+e.id+"/subscribe",headers:this.authService.getRequestHeader()}).then(n=>{this.$log.info("[channelService] subscribeToChannel -- "+e.id+" -- success"),e.subscribed=!0,e.users_count+=1,t(n)}).catch(t=>{this.channelErrorHandler("subscribeToChannel ("+e.id+")",n,t)})})}unsubscribeToChannel(e){return this.$q((t,n)=>{this.$http({method:"DELETE",url:this.portalURL+"/"+e.id+"/subscribe",headers:this.authService.getRequestHeader()}).then(n=>{this.$log.info("[channelService] unsubscribeToChannel -- success"),e.subscribed=!1,e.users_count-=1,t(n)}).catch(e=>{this.channelErrorHandler("unsubscribeToChannel",n,e)})})}updateChannel(e,t){return this.$q((n,r)=>{this.$http({method:"PUT",url:this.portalURL+"/"+e,headers:this.authService.getPostHeader(),data:t}).then(t=>{let r=this.getChannelFromCache(e);r.name=t.data.data.name,r.topic=t.data.data.topic,r.category=t.data.data.category,this.$log.info("[channelService] updateChannel ( "+e+") -- success"),this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.UPDATE,r.id),n(r)}).catch(t=>{this.channelErrorHandler("updateChannel ("+e+")",r,t)})})}getChannelItems(e,t,n=null,r=null){return this.$q((i,a)=>{this.$http({method:"GET",url:this.portalURL+"/"+e+"/items",headers:this.authService.getRequestHeader(),params:{max:t,before:n,after:r}}).then(e=>{this.$log.info("[channelService] getChannelItems -- success"),this.chewReceivedItems(e.data.data.items),i(e.data.data.items)}).catch(e=>{this.channelErrorHandler("getChannelItems",a,e)})})}deleteChannelItem(e,t){return this.$q((n,r)=>{this.$http({method:"DELETE",url:this.portalURL+"/"+e+"/items/"+t,headers:this.authService.getRequestHeader()}).then(()=>{this.$log.info("[channelService] deleteChannelItem ("+e+") -- success"),n()}).catch(t=>{this.channelErrorHandler("deleteChannelItem ("+e+")",r,t)})})}getChannelUsers(e,t){return this.$q((n,r)=>{let i={};t&&(t.format&&"string"==typeof t.format&&t.format.length&&(i.format=t.format),t.types&&"string"==typeof t.types&&t.types.length&&(i.types=t.types),t.limit&&"number"==typeof t.limit&&0<t.limit&&(i.limit=t.limit),t.offset&&"number"==typeof t.offset&&0<t.offset&&(i.offset=t.offset),t.sortField&&"string"==typeof t.sortField&&t.sortField.length&&(i.sortField=t.sortField),t.sortOrder&&("-1"===t.sortOrder||"1"===t.sortOrder)&&(i.sortOrder=t.sortOrder)),this.$http({method:"GET",url:this.portalURL+"/"+e+"/users",headers:this.authService.getRequestHeader(),params:i}).then(t=>{this.$log.info("[channelService] getChannelUsers ("+e+") -- success"),n(t.data)}).catch(t=>{this.channelErrorHandler("getChannelUsers ("+e+")",r,t)})})}searchUsersByName(e,t,n){return n.displayName=t,this.$q((t,r)=>{this.$http({method:"GET",url:this.portalURL+"/"+e+"/users/search",headers:this.authService.getRequestHeader(),params:n}).then(n=>{this.$log.info("[channelService] searchUsersByName ("+e+" -- success"),t(n.data.data)}).catch(t=>{this.channelErrorHandler("searchUsersByName ("+e+")",r,t)})})}deleteChannelAvatar(e){return this.$q((t,n)=>{this.$http({method:"DELETE",url:this.portalURL+"/"+e+"/avatar",headers:this.authService.getRequestHeader()}).then(n=>{this.$log.info("[channelService] deleteChannelAvatar "+e+" -- success"),t(n)}).catch(t=>{this.channelErrorHandler("deleteChannelAvatar "+e,n,t)})})}uploadChannelAvatar(e,t,n){return this.$q((r,i)=>{this.roomService.resizeImage(t,n,n).then(t=>{var n=this.roomService.getBinaryData(t);this.$http({method:"POST",url:this.portalURL+"/"+e+"/avatar",headers:this.authService.getPostHeader("image/"+n.type),data:n.data,transformRequest:[]}).then(t=>{this.$log.info("[channelService] uploadChannelAvatar "+e+" -- success"),r(t)}).catch(e=>{this.channelErrorHandler("uploadChannelAvatar",i,e)})})})}updateChannelUsers(e,t,n){return this.$q((r,i)=>{let a=t.map(e=>({id:e.dbId,type:n}));this.$http({method:"PUT",url:this.portalURL+"/"+e+"/users",headers:this.authService.getRequestHeader(),data:{data:a}}).then(t=>{this.$log.info("[channelService] updateChannelUsers -- success");let n=t.data.data;this.$rootScope.$broadcast(this.CHANNEL_USERS_UPDATE_EVENT,e,n),r(n)}).catch(e=>{this.channelErrorHandler("updateChannelUsers",i,e)})})}usersUpdateHandler(e,t,n){let r=this.getChannelFromCache(t);if(null!==n&&(r.users_count+=n.added.length-n.removed.length,r.users.length)){for(let e=0;e<n.added.length;e++)this.contactService.getContactByDBId(n.added[e]).then(e=>{r.users.push(e)});for(let e=0;e<n.removed.length;e++)for(let t=r.users.length-1;0<=t;t--)if(r.users[t].dbId===n.removed[e]){r.users.splice(t,1);break}}}retrieveUsers(e){if(this.$log.info("Retrieving users"),0===e.users.length&&e.userRole===this.USER_ROLE.OWNER){let t,n=this.contactService.userContact;return n.type="owner",this.getChannelUsers(e.id,{format:"full",types:"publisher",limit:19}).then(n=>(t=n.data.length?n.data:[],19>t.length?this.getChannelUsers(e.id,{format:"full",types:"member",limit:19-t.length}):[])).then(r=>{t.push.apply(t,r.data);const i=t;return this.usersToContacts(i).then(t=>(e.users=t,e.users.unshift(n),t))})}return this.$q.resolve(null)}usersToContacts(e){if(null!==e){let t=[];for(let n,r=0;r<e.length;r++)(n=this.Contact.create(e[r].jid_im,e[r].firstName,e[r].lastName,e[r].company,e[r].loginEmail)).dbId=e[r].id,n.lastAvatarUpdateDate=e[r].lastAvatarUpdateDate,n.type=e[r].type||e[r].affiliation,t.push(n.getAvatar());return this.$q.all(t).then(e=>e)}}retrieveMessages(e){return e.messageRetrieved?this.$q.resolve(null):this.getChannelItems(e.id,100,null,null).then(t=>{e.messages=t;let n=[];var r=Array.from(new Set(e.messages.map(e=>e.from)));for(let e,t=0;t<r.length;t++)e=this.contactService.getOrCreateContact(r[t]),n.push(e);return this.$q.all(n).then(t=>{for(let n,r=0;r<e.messages.length;r++)n=t.find(t=>t.id===e.messages[r].from),e.messages[r].fromDetails={displayName:n.displayName,id:n.dbId,avatar:n.avatar},e.messages[r].fromContact=n;return e.messageRetrieved=!0,this.$q.resolve(e.messages)})})}retrieveLatests(e=null){return this.getLatestMessages(10,e,null).then(e=>(this.feedChannel.messages.push.apply(this.feedChannel.messages,e),e.length))}incrementMessagesCounter(){this.messageCounter+=1,this.updateNotificationCounter()}decrementMessagesCounter(){this.messageCounter-=1,this.updateNotificationCounter()}incrementInvitationCounter(){this.invitationCounter+=1,this.updateNotificationCounter()}decrementInvitationCounter(){this.invitationCounter-=1,this.updateNotificationCounter()}ackMessages(){this.messageCounter=0,this.updateNotificationCounter(),this.feedChannel.messages.forEach(e=>{e.new=!1})}updateNotificationCounter(){this.notificationCounter=this.messageCounter+this.invitationCounter,0>this.notificationCounter&&(this.notificationCounter=0),this.$rootScope.$broadcast(this.CHANNEL_NOTIFICATION_NUMBER_UPDATED,this.notificationCounter)}removeAllUsersFromChannel(e){return this.$q((t,n)=>{this.$http({method:"DELETE",url:this.portalURL+"/"+e+"/users",headers:this.authService.getRequestHeader()}).then(n=>{this.$log.info("[channelService] Removed all users from channel -- success"),this.$rootScope.$broadcast(this.CHANNEL_USERS_UPDATE_EVENT,e,null),t(n)}).catch(e=>{this.channelErrorHandler("removeAllUsersFromChannel",n,e)})})}getPortalInfos(){return this.$q((e,t)=>{this.$http({method:"GET",url:config.restServerUrl+"/api/rainbow/channels/v1.0/about",headers:this.authService.getRequestHeader()}).then(t=>{this.$log.info("[channelService] successfully retrieved portal infos -- success"),e(t.data)}).catch(e=>{this.channelErrorHandler("getPortalInfos",t,e)})})}getLatestMessages(e,t=null,n=null){return this.$q((r,i)=>{this.$http({method:"GET",url:this.portalURL+"/latest-items",headers:this.authService.getRequestHeader(),params:{max:e,before:t,after:n}}).then(e=>{this.chewReceivedItems(e.data.data.items),r(e.data.data.items)}).catch(e=>{this.channelErrorHandler("getLatestMessages",i,e)})})}acceptInvitation(e){return this.$q((t,n)=>{this.$http({method:"PUT",url:this.portalURL+"/"+e+"/accept",headers:this.authService.getRequestHeader()}).then(n=>{this.$log.info("[channelService] acceptInvitation ("+e+") -- success"),this.decrementInvitationCounter(),t(n)}).catch(e=>{this.channelErrorHandler("acceptInvitation",n,e)})})}declineInvitation(e){return this.$q((t,n)=>{this.$http({method:"PUT",url:this.portalURL+"/"+e+"/decline",headers:this.authService.getRequestHeader()}).then(n=>{this.$log.info("[channelService] declineInvitation ("+e+") -- success"),this.decrementInvitationCounter(),t(n)}).catch(e=>{this.channelErrorHandler("declineInvitation",n,e)})})}chewReceivedItems(e){e.forEach(e=>{"urn:xmpp:channels:simple"===e.type&&(e.entry={message:e.message},delete e.message),e.displayId=e.id+"-"+e.timestamp,e.modified=void 0!==e.creation})}updateChannelsList(){this.channelsList=Object.keys(this.channels).map(e=>this.channels[e])}addChannelToCache(e){this.channels[e.id]=e,this.updateChannelsList()}channelErrorHandler(e,t,n){let r=null;n.data?(this.$log.error("[channelService] "+e+" -- failure -- "+n.data.errorDetails),r=new RBError(n.data.errorMsg,n.data.errorDetails,n.data.errorDetailsCode)):(this.$log.error("[channelService] "+e+" -- failure -- Server failure"),r=new RBError("Server failure")),t(r)}}n.PAGE_SIZE=10,n.$inject=["$q","$http","$log","$rootScope","authService","xmppService","contactService","Channel","roomService","Contact","profileService"],angular.module("rainbow").service("channelService",n)},function(){},function(e,t,n){"use strict";n.r(t);var r=n(1);n.n(r);angular.module("rainbow").service("companyService",["$q","$log","$http","$rootScope","authService","errorHelperService","userInfoService","Company",function(e,t,n,i,a,o,s,c){var l=this,d=[];l.start=function(n){t.info(""),t.info("[companyService] === STARTING ===");var r=performance.now();l.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/",l.companies={};var a=Math.round(performance.now()-r);return n.push({service:"companyService",startDuration:a}),t.info("[companyService] === STARTED ("+a+" ms) ==="),d.push(i.$on("ON_COMPANY_CHANGE_EVENT",function(e,t){l.getCompanyById(t,!0)})),e.when()},l.stop=function(){t.info(""),t.info("[companyService] === STOPPING ===");for(var n;n=d.pop();)n();return t.info("[companyService] === STOPPED ==="),l.companies={},e.when()},l.searchCompanies=function(r,i,s,d){return e(function(e,u){var h=l.portalURL+"companies?name="+r+"&format=full";null!=i&&(h+="&hasBP="+i),null!=s&&(h+="&isBP="+s),d&&(h+="&bpType="+d),n({method:"GET",url:h,headers:a.getRequestHeader()}).then(function(n){var i=n.data.data,a=[];angular.forEach(i,function(e){if("Default"!==e.name&&"Rainbow"!==e.name&&"active"===e.status){var t=l.companies[e.id];t||(t=c.createFromData(e),l.companies[t.id]=t,l.getCompanyLogo(t)),a.push(t)}}),t.info("[companyService] searchCompanies with criteria '"+r+"' - success - found "+i.length+" companies : returns "+a.length+" companies"),e(a)},function(e){var n=o.handleError(e);t.error("[companyService] "+o.getErrorFullMessage(e,"searchCompanies")),u(n)})})},l.getCompanyById=function(r,i){return e(function(e,s){if(!r)return t.error("[companyService] getCompanyById -- missing companyId"),void s(new Error("[companyService] getCompanyById -- missing companyId"));var d=l.companies[r];d&&!i?(t.info("[companyService] getCompanyById (cache) "+r+" - success"),e(d)):n({method:"GET",url:l.portalURL+"companies/"+r,headers:a.getRequestHeader()}).then(function(n){var i=n.data.data;d?(d.updateFromData(i),t.info("[companyService] getCompanyById (update) "+r+" - success")):(d=c.createFromData(i),l.companies[d.id]=d,t.info("[companyService] getCompanyById "+r+" - success")),l.getCompanyLogo(d),l.getCompanyBanner(d),e(d)},function(e){var n=o.handleError(e);t.error("[companyService] "+o.getErrorFullMessage(e,"getCompanyById")),s(n)})})},l.getAdministratorIds=function(r){return e(function(e,i){var s=l.portalURL+"companies/"+r+"/administrators";n({method:"GET",url:s,headers:a.getRequestHeader()}).then(function(n){var r=n.data.data,i=[];r.forEach(function(e){i.push(e.id)}),t.info("[companyService] getAdministratorIds success)"),e(i)},function(e){var n=o.handleError(e);t.error("[companyService] "+o.getErrorFullMessage(e,"getAdministratorIds")),i(n)})})},l.getCompanyLogo=function(n){return e(function(e,r){var a=s.computeUserColor(n.name),o=n.name.substr(0,1);s.getAvatarImage(n.id,o,a.color,130,n.lastAvatarUpdateDate).then(function(r){n.logo=r,i.$broadcast("ON_COMPANY_LOGO_UPDATED",n.id),t.info("[companyService] getCompanyLogo - "+n.getNameForLogs()+" - success"),e(r)}).catch(function(e){t.error("[companyService] getCompanyLogo - failure - "+e.message),r(e)})})},l.getCompanyBanner=function(n){return e(function(e){var a=new Image;if(n.lastBannerUpdateDate){var o=config.webservices.protocol+"://"+config.webservices.currentServer;i.cdn&&(o=i.cdnServer);var s=o+"/api/banner/"+n.id+"?size=831";s+="&update="+Object(r.MD5)(r.enc.Latin1.parse(n.lastBannerUpdateDate)).toString(r.enc.Hex),a.onload=function(){var r=this;i.$apply(function(){n.banner=r,i.$broadcast("ON_COMPANY_BANNER_UPDATED",n.id),t.log("[companyService] Load banner for "+n.getNameForLogs()+" success"),e(r)})},a.onerror=function(){i.$apply(function(){t.warn("[companyService] Load banner for "+n.getNameForLogs()+" failure"),e(null)})},a.src=s}else a.src="/cache/images/company-banner-01.svg",n.banner=a,i.$broadcast("ON_COMPANY_BANNER_UPDATED",n.id),t.log("[companyService] Load default banner for "+n.getNameForLogs()+" success"),e(a)})}}])},function(){!function(){"use strict";angular.module("rainbow").service("browserService",[function(){this.extractBrowserVersion=function(e,t,n){var r=e.match(t);return r&&r.length>=n&&parseInt(r[n],10)}}])}()},function(){angular.module("rainbow").service("gRTCStatsService",[function(){"use strict";var e={};this.resetStatsForAllCalls=function(){e={}},this.resetStatsForCall=function(t){t in e&&delete e[t]},this.getCalls=function(){return e},this.nbCalls=function(){return Object.keys(e).length},this.hasStatsForCall=function(t){return t in e},this.addStreamToCall=function(t,n){t in e||(e[t]={});var r=e[t];r[n.id]={},r[n.id].stream=n},this.nbStreamsInACall=function(t){return t in e?Object.keys(e[t]).length:0},this.getBundlePolicyForCall=function(t){if(!(t in e))return"unknown";var n=e[t],r=0,i=this.nbStreamsInACall(t);for(var a in n)"selectedCandidatePairId"in n[a].stream&&r++;return 4===i?0==r?"failed":1==r?"max-bundle":2==r?"balanced":4==r?"max-compat":"unknown":2===i?0==r?"failed":1==r?"max-bundle":2==r?"max-compat":"unknown":"unknown"},this.addSSRCToStream=function(t,n){var r=null,i=null;"ssrc"===n.type&&t in e&&(r=e[t],n.transportId in r&&(!(i=r[n.transportId]).ssrc&&(i.ssrc={}),i.ssrc[n.ssrc]=n))},this.hasSSRCInStream=function(t,n,r){var i=null,a=null;return!!(t in e)&&!!(n in(i=e[t]))&&(!!(a=i[n]).ssrc&&r in a.ssrc)},this.getSSRCMediaType=function(t,n,r){var i=null,a=null;return t in e?n in(i=e[t])?(a=i[n]).ssrc&&r in a.ssrc?a.ssrc[r].mediaType:"unknown":"unknown":"unknown"},this.getSSRCDirection=function(n,r,i){var a=null,o=null,s=null;return n in e?r in(a=e[n])?(o=a[r]).ssrc&&i in o.ssrc?(s=o.ssrc[i],t(s.id)):"unknown":"unknown":"unknown"},this.getSSRCAudioCodecName=function(t,n,r){var i=null,a=null;return t in e?n in(i=e[t])?(a=i[n]).ssrc&&r in a.ssrc?a.ssrc[r].googCodecName:"unknown":"unknown":"unknown"},this.isSSRCFlowing=function(n,r,i){var a,o,s;if(!(n in e))return!1;if(!(r in(a=e[n])))return!1;if(!(o=a[r]).ssrc)return!1;if(!(i in o.ssrc))return!1;s=o.ssrc[i];return 0<("IN"===t(s.id)?parseInt(s.bytesReceived,10):parseInt(s.bytesSent,10))},this.getStreamsDetailsFromCall=function(t){var n=null,r=null;if(!(t in e))return[];n=e[t];var i=[];for(var a in n)if(n.hasOwnProperty(a)){r=n[a];var o="no",s="no",c=!1,l=!1,d=!1,u=!1;for(var h in r.ssrc)if(r.ssrc&&r.ssrc.hasOwnProperty&&r.ssrc.hasOwnProperty(h)){var f=this.getSSRCMediaType(t,a,h),p=this.getSSRCDirection(t,a,h),m=this.isSSRCFlowing(t,a,h);"audio"===f&&"IN"===p&&m?c=!0:"audio"===f&&"OUT"===p&&m?d=!0:"video"===f&&"IN"===p&&m?l=!0:"video"===f&&"OUT"===p&&m&&(u=!0)}c&&d?o="IN|OUT":c?o="IN":d&&(o="OUT"),l&&u?s="IN|OUT":l?s="IN":u&&(s="OUT"),c||d||l||u?i.push({id:a,streams:{audio:o,video:s}}):i.push({id:a,streams:{}})}return i},this.getCodecDetailsFromCall=function(t){var n=null,r=null,i="-",a="-",o={codec:{audio:i,video:a}};if(!(t in e))return o;for(var s in n=e[t])if(n.hasOwnProperty(s))for(var c in(r=n[s]).ssrc)"audio"===r.ssrc[c].mediaType&&(i=this.getSSRCAudioCodecName(t,s,c)),"video"===r.ssrc[c].mediaType&&(a=this.getSSRCAudioCodecName(t,s,c));return o.codec.audio=i,o.codec.video=a,o};var t=function(e){return-1<e.indexOf("recv")?"IN":"OUT"}}])},function(){angular.module("rainbow").service("fRTCStatsService",[function(){"use strict";var e={};this.getCalls=function(){return e},this.nbCalls=function(){return Object.keys(e).length},this.addStreamToCall=function(t,n){if(!n.isRemote){t in e||(e[t]={});var r=e[t];r.streams||(r.streams={}),r.streams[n.id]={},r.streams[n.id]=n}},this.nbStreamsInACall=function(t){return t in e?Object.keys(e[t].streams).length:0},this.resetStatsForAllCalls=function(){e={}},this.resetStatsForCall=function(t){t in e&&delete e[t]},this.hasStatsForCall=function(t){return t in e},this.hasSSRCInStream=function(t,n,r){var i=null;return!!(t in e)&&!!(i=e[t]).streams&&!!(n in i.streams)&&i.streams[n].ssrc===r},this.hasStreamInCall=function(t,n){return!!(t in e)&&n in e[t].streams},this.getSSRCMediaType=function(t,n){var r=null;return t in e?n in(r=e[t]).streams?r.streams[n].mediaType:"unknown":"unknown"},this.getStreamsDetailsFromCall=function(n){var r=null;if(!(n in e))return[];r=e[n];var i=[];for(var a in r.streams)if(r.streams.hasOwnProperty(a)){var o=this.getSSRCMediaType(n,a),s=t(a);"audio"===o?i.push({id:a,streams:{audio:s}}):"video"===o&&i.push({id:a,streams:{video:s}})}return i},this.addCandidatePairToCall=function(t,n){var r=null,i=!1;if(t in e){(r=e[t]).candidatesPairs||(r.candidatesPairs=[]);for(var a=0;a<r.candidatesPairs.length;a++)if(r.candidatesPairs[a].id===n.id){i=!0;break}!i&&"succeeded"===n.state&&n.selected&&r.candidatesPairs.push(n)}},this.getNbCandidatePairs=function(t){var n=null,r=0;return t in e?((n=e[t]).candidatesPairs&&(r=n.candidatesPairs.length),r):r},this.getBundlePolicyForCall=function(t){var n="unknown";if(!(t in e))return n;switch(this.getNbCandidatePairs(t)){case 0:n="failed";break;case 1:n="max-bundle";break;case 2:n=2<this.nbStreamsInACall(t)?"balanced":"max-compat";break;default:n="max-compat"}return n};var t=function(e){return-1<e.indexOf("inbound")?"IN":"OUT"}}])},function(){var e=Math.round;angular.module("rainbow").service("platformService",["$log","$rootScope","$window","$interval","settingsService","$q","$filter","$http","authService","errorHelperService",function(t,n,r,i,a,o,s,c,l,d){"use strict";function u(){return h(),m.isAskingMedia?void t.info("[PlatformService] onAudioInputChange -- already asking media -- ignore"):(m.isAskingMedia=!0,void i(m.testGetUserMedia,2e3,1))}function h(){var e;e=m.isHandfreeAvailable(),E!==e&&(t.info("[PlatformService] Handfree is now "+(e?"available":"unavailable")),E=e,S.HANDFREE.available=e,n.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",e),n.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT"),!e&&m.getCurrentSpeaker().then(function(e){e&&e.id&&p(e.id)})),function(e){b!==e&&(t.info("[PlatformService] Headset is now "+(e?"available":"unavailable")),b=e,S.HEADSET.available=e,e?a.getSetting("audioProfile")===S.HANDFREE.value&&(a.setSetting("audioProfile",S.HEADSET.value),m.getCurrentSpeaker().then(function(e){e&&e.id&&p(e.id)})):(a.getSetting("audioProfile")===S.HEADSET.value&&a.setSetting("audioProfile",S.HANDFREE.value),m.getCurrentSpeaker().then(function(e){e&&e.id&&p(e.id)})),n.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",e),n.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT"))}(m.isHeadsetAvailable()),function(e){y!==e&&(t.info("[PlatformService] Speakerphone is now "+(e?"available":"unavailable")),y=e,S.SPEAKERPHONE.available=e,n.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",e),n.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT"),!e&&m.getCurrentSpeaker().then(function(e){e&&e.id&&p(e.id)}))}(m.isSpeakerphoneAvailable()),function(e){R!==e&&(t.info("[PlatformService] Custom is now "+(e?"available":"unavailable")),R=e,S.CUSTOM.available=e,n.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",e),n.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT"),!e&&m.getCurrentSpeaker().then(function(e){e&&e.id&&p(e.id)}))}(m.isCustomAvailable())}function f(e,n){h(),t.info("[PlatformService] updateOutputDevice "+n),m.allowDevicesManagement()&&n&&p(n)}function p(e){t.info("[PlatformService] updateCurrentOutputDevice "+e),angular.element("#globalAudioTag")[0]&&angular.element("#globalAudioTag")[0].sinkId!==e&&T!==e?(T=e,t.info("[PlatformService] updateCurrentOutputDevice current ID "+angular.element("#globalAudioTag")[0].sinkId+" new id "+e),m.setSpeakerForElement(angular.element("#globalAudioTag")[0],"default").then(function(){m.setSpeakerForElement(angular.element("#globalAudioTag")[0],e),T=""}).catch(function(){T=""})):t.info("[PlatformService] updateCurrentOutputDevice -- ignored ")}var m=this,v=[];m.$q=o,this.isWin=0<=navigator.platform.toUpperCase().indexOf("WIN"),m.start=function(r){return o(function(a){var o=performance.now();t.info(""),t.info("[platformService] === STARTING ==="),m.languages=["en","fr","es","de","it"],v.push(n.$on("$translateChangeSuccess",function(){m.fixDeviceLabels()})),v.push(n.$on("ON_INPUT_DEVICE_CHANGED_EVENT",u)),v.push(n.$on("ON_OUTPUT_DEVICE_CHANGED_EVENT",f)),v.push(n.$on("ON_CONNECTION_STATE_CHANGE_EVENT",m.onAuthenticationStatusChangedEvent)),m.isAskingMedia=!1,m.hasAudioPermission=!1,m.hasVideoPermission=!1,m.stopWatcher(),i(m.startWatcher,2e3,1);var s=e(performance.now()-o);r.push({service:"platformService",startDuration:s}),t.info("[platformService] === STARTED ("+s+" ms) ==="),a()})},m.stop=function(){return t.info("[platformService] === STOPPING ==="),v.forEach(function(e){e()}),m.stopWatcher(),this.mediaDevicesLength=0,this.mediaDevices=[],t.info("[platformService] === STOPPED ==="),o.when()},m.onAuthenticationStatusChangedEvent=function(e,n){"connected"===n&&(m.allowDevicesManagement()&&angular.element("#globalAudioTag")[0]&&(!angular.element("#globalAudioTag")[0].sinkId||"default"===angular.element("#globalAudioTag")[0].sinkId)&&(t.info("[platformService] onAuthenticationStatusChangedEvent -- update global audio tag"),m.getCurrentSpeaker().then(function(e){e&&e.id&&p(e.id)})),m.testGetUserMedia())},this.audioDevices=0,this.videoDevices=0,this.detectRTCLoaded=function(){m.hasAudioPermission=DetectRTC.isWebsiteHasMicrophonePermissions,m.hasVideoPermission=DetectRTC.isWebsiteHasWebcamPermissions,m.fixDeviceLabels();var e=!1,n=!1,r=m.shouldAskGetUserMedia();(DetectRTC.audioInputDevices&&DetectRTC.audioInputDevices.length||DetectRTC.audioOutputDevices&&DetectRTC.audioOutputDevices.length)&&(!m.hasAudioPermission||r.audio?e=!0:C=!0),DetectRTC.videoInputDevices&&DetectRTC.videoInputDevices.length&&(!m.hasVideoPermission||r.video?n=!0:g=!0),e||n?!m.isAskingMedia&&(m.isAskingMedia=!0,m.getUserMedia(e,n)):(m.fixDeviceLabels(),M().then(function(){m.isDesktop()&&m.updateNewDesktopDevicesIds(),h(),m.audioDevices!==DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length&&(m.audioDevices=DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length,m.audioMediaDeviceUpdated()),m.videoDevices!==DetectRTC.videoInputDevices.length&&(m.videoDevices=DetectRTC.videoInputDevices.length,m.videoMediaDeviceUpdated()),angular.forEach(DetectRTC.MediaDevices,function(e){e&&t.info("[PlatformService] DetectRTC.MediaDevices device "+e.id+" with kind "+e.kind+" with label "+e.label)}),m.getCurrentSpeaker().then(function(e){e&&e.id&&p(e.id)}),m.newDevice&&m.checkAndUpdateHandFreeProfile(),m.startWatcher()}))},this.testGetUserMedia=function(){if(m.hasAudioPermission){var n=performance.now();m.getCurrentMicrophone().then(function(r){var i={},a="default";r?(i.audio={optional:[{sourceId:r.id}]},a="id - "+r.id+" and label "+r.label):i.audio=!0,t.info("[PlatformService] testGetUserMedia -- getUserMedia for Mic "+a),navigator.mediaDevices.getUserMedia(i).then(function(r){var i=e(performance.now()-n);t.info("[PlatformService] testGetUserMedia -- getUserMedia success for time : "+i+" ms"),angular.forEach(r.getTracks(),function(e){t.info("[PlatformService] testGetUserMedia mediaStreamTrack -- "+e.label),e.stop()}),m.isAskingMedia=!1}).catch(function(e){t.info("[PlatformService] testGetUserMedia -- getUserMedia error "+e),m.isAskingMedia=!1})})}else t.info("[PlatformService] testGetUserMedia -- no audio permission given")},this.shouldAskGetUserMedia=function(){var e={audio:!1,video:!1};return angular.forEach(DetectRTC.MediaDevices,function(t){t&&t.label&&-1!==t.label.indexOf("invoke getUserMedia")&&("audioinput"===t.kind||"audiooutput"===t.kind?e.audio=!0:e.video=!0)}),t.info("[platformService] shouldAskGetUserMedia : audio "+e.audio+" and video "+e.video),e},this.updateNewDesktopDevicesIds=function(){var e=a.getSetting("handFreeInputDeviceName"),t=a.getSetting("handFreeOutputDeviceName"),n=a.getSetting("headsetDeviceName"),r=a.getSetting("customMicrophoneName"),i=a.getSetting("customSpeakerName");(e||t||n||r||i)&&angular.forEach(DetectRTC.MediaDevices,function(o){"audioinput"===o.kind?(o.normalizedLabel===n&&a.setSetting("headsetMicrophone",o.id),o.normalizedLabel===e&&a.setSetting("microphone",o.id),o.normalizedLabel===r&&a.setSetting("customMicrophone",o.id)):"audiooutput"===o.kind&&(o.normalizedLabel===n&&a.setSetting("headsetSpeaker",o.id),o.normalizedLabel===t&&a.setSetting("speaker",o.id),o.normalizedLabel===i&&a.setSetting("customSpeaker",o.id))})},this.mediaDevicesLength=0,this.mediaDevices=[],this.newDevice=null,this.devicesWatcher=function(){navigator.mediaDevices.enumerateDevices().then(function(e){(m.mediaDevicesLength!==e.length||m.checkForIdChange(e))&&(t.debug("[platformService] MediaDevices count changed ! from "+m.mediaDevicesLength+" to "+e.length),t.debug("[platformService] MediaDevices brut devices list "+JSON.stringify(e)),m.newDevice=1==e.length-m.mediaDevicesLength?m.getNewDevice(m.mediaDevices,e):null,m.mediaDevicesLength=e.length,m.mediaDevices=e,m.stopWatcher(),DetectRTC.load(m.detectRTCLoaded))})},m.checkAndUpdateHandFreeProfile=function(){t.info("[platformService] checkAndUpdateHandFreeProfile");var e=m.getActiveAudioProfile();1===e.key&&!0===e.available&&m.getCurrentSpeaker().then(function(e){e&&e.groupId===m.newDevice.groupId&&(t.info("[platformService] checkAndUpdateHandFreeProfile -- should update the Jack Mic"),n.$broadcast("ON_HANDFREE_JACK_MICROPHONE_EVENT",m.newDevice))})},m.checkForIdChange=function(e){var n=!1;return m.mediaDevices.length&&angular.forEach(m.mediaDevices,function(t){if("default"!==t.deviceId&&"communications"!==t.deviceId){for(var r=!1,i=0;i<e.length;i++)t.deviceId===e[i].deviceId&&(r=!0);r||(n=!0)}}),n&&t.info("[platformService] checkForIdChange "+n),n},m.getNewDevice=function(e,t){var n=null;return t.length&&angular.forEach(t,function(t){if("default"!==t.deviceId&&"communications"!==t.deviceId){for(var r=!1,i=0;i<e.length;i++)t.deviceId===e[i].deviceId&&(r=!0);r||"audioinput"!==t.kind||(n=t)}}),n},m.tryToGetUserMediaForEachDevice=function(){if(t.info("[platformService] tryToGetUserMediaForEachDevice"),DetectRTC.audioInputDevices&&DetectRTC.audioInputDevices.length){for(var e=o.when(),r=0;r<DetectRTC.audioInputDevices.length;r++)!function(t){var n=DetectRTC.audioInputDevices[t];e=e.then(function(){return m.getUserMediaForAudioDevice(n.id)})}(r);e=e.finally(function(){t.info("[platformService] tryToGetUserMediaForEachDevice finally -- has audio permission "+m.hasAudioPermission),m.hasAudioPermission?m.loadDetectRTC():(C=!1,g=!1,m.isAskingMedia=!1,n.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"information",popupBody:"devicePermission",okLabel:"ok"}),m.startWatcher())})}},m.getUserMediaForAudioDevice=function(e){return o(function(n){if(m.hasAudioPermission)return t.info("[platformService] getUserMediaForAudioDevice for id: "+e+" no longer needed !"),void n();if(!e)return t.info("[platformService] getUserMediaForAudioDevice missing id !"),void n();t.info("[platformService] getUserMediaForAudioDevice for id: "+e);var r={};r.audio={optional:[{sourceId:e}]},navigator.mediaDevices.getUserMedia(r).then(function(r){t.info("[platformService] getUserMediaForAudioDevice for id: "+e+" success"),angular.forEach(r.getAudioTracks(),function(e){e.stop()}),m.hasAudioPermission=!0,C=!0,m.hasVideoPermission=!0,g=!0,n()}).catch(function(r){t.info("[platformService] getUserMediaForAudioDevice for id: "+e+" failed with error "+r),n()})})},m.getUserMedia=function(e,n){t.info("[platformService] getUserMedia audio: "+e+" and video: "+n),navigator.mediaDevices.getUserMedia({audio:e,video:n}).then(function(r){t.info("[platformService] getUserMedia audio: "+e+" and video: "+n+" -- success!"),angular.forEach(r.getAudioTracks(),function(e){e.stop()}),angular.forEach(r.getVideoTracks(),function(e){e.stop()}),e&&(m.hasAudioPermission=!0,C=!0),n&&(m.hasVideoPermission=!0,g=!0),r=null,m.loadDetectRTC()}).catch(function(e){t.error("[platformService] getUserMedia -- error -- "+e),m.tryToGetUserMediaForEachDevice()})},m.loadDetectRTC=function(){DetectRTC.load(function(){m.fixDeviceLabels(),M().then(function(){m.isDesktop()&&m.updateNewDesktopDevicesIds(),h(),m.isAskingMedia=!1,m.audioDevices!==DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length&&(m.audioDevices=DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length,m.audioMediaDeviceUpdated()),m.videoDevices!==DetectRTC.videoInputDevices.length&&(m.videoDevices=DetectRTC.videoInputDevices.length,m.videoMediaDeviceUpdated()),angular.forEach(DetectRTC.MediaDevices,function(e){e&&t.info("[PlatformService] DetectRTC.MediaDevices device "+e.id+" with kind "+e.kind+" with label "+e.label)}),m.getCurrentSpeaker().then(function(e){e&&e.id&&p(e.id)}),m.startWatcher()})})},m.getWhatsNew=function(){return o(function(e){var n=config.restServerUrl+"/api/rainbow/enduser/v1.0/settings/changelogs";c({method:"GET",url:n,headers:l.getRequestHeader()}).then(function(n){t.info("[adminPlatformService] getWhatsNew -- success");var r=n.data.data.changeLog.split("%"),i={};r.forEach(function(e,t){i[m.languages[t]]=e}),Object.keys(i).forEach(function(e){0===i[e].length&&(i[e]=i.en)}),i.en||(i={en:"",fr:"",es:"",de:"",it:""}),e(i)},function(n){e({en:"",fr:"",es:"",de:"",it:""}),t.error("[adminPlatformService] "+d.getErrorFullMessage(n,"getWhatsNew"))})})},m.getAvailableLanguage=function(e){var t=e.split("-")[0],n=m.languages.find(function(e){return e===t});return n||"en"},this.isDesktop=function(){return 0<=navigator.userAgent.indexOf(" Rainbow/")},this.allowDevicesManagement=function(){return r.chrome||this.isDesktop()};var g=!1;this.isWebsiteHasWebcamPermissions=function(){return!!m.allowDevicesManagement()&&g};var C=!1;this.isWebsiteHasMicrophonePermissions=function(){return!!m.allowDevicesManagement()&&C};var S={HANDFREE:{key:1,value:"handfree",available:!1},HEADSET:{key:2,value:"headset",available:!1},SPEAKERPHONE:{key:3,value:"speakerphone",available:!1},CUSTOM:{key:4,value:"custom",available:!1}};this.audioProfileEnum=S,this.getAudioProfiles=function(){return S},this.currentAudioProfile=S.HANDFREE,this.getCurrentAudioProfile=function(){var e=a.getSetting("audioProfile"),t=null;return e===S.HEADSET.value?t=S.HEADSET:e===S.HANDFREE.value?t=S.HANDFREE:e===S.SPEAKERPHONE.value?t=S.SPEAKERPHONE:e===S.CUSTOM.value?t=S.CUSTOM:(t=S.HANDFREE,a.setSetting("audioProfile",t.value)),t},this.getActiveAudioProfile=function(){var e=this.getCurrentAudioProfile();return e.key===S.HANDFREE.key||e.available?e:S.HANDFREE},this.setCurrentAudioProfile=function(e){e&&(m.currentAudioProfile=e)},this.isHandfreeAvailable=function(){return m.isHandfreeMicrophoneAvailable()&&m.isHandfreeSpeakerAvailable()},this.isHeadsetAvailable=function(){return m.isHeadsetMicrophoneAvailable()&&m.isHeadsetSpeakerAvailable()},this.isSpeakerphoneAvailable=function(){return m.isSpeakerphoneMicrophoneAvailable()&&m.isSpeakerphoneSpeakerAvailable()},this.isCustomAvailable=function(){return m.isCustomMicrophoneAvailable()&&m.isCustomSpeakerAvailable()},this.getCurrentMicrophone=function(){if("sdk"===a.getSetting("apiMode")){var e=m.getMicrophoneForSDK();if(e)return e}switch(m.getActiveAudioProfile()){case S.SPEAKERPHONE:return m.getSpeakerphoneMicrophone();case S.CUSTOM:return m.getCustomMicrophone();case S.HEADSET:return m.getHeadsetMicrophone();default:return m.getHandfreeMicrophone()}},this.getMicrophoneForSDK=function(){var e=o.defer();return m.getMicrophones().then(function(t){e.resolve(m.getDeviceWithId(t,a.getSetting("microphone")))}),e.promise},this.getSecondRingerStatusFromSettings=function(){return a.getSetting("hasSecondRinger")},this.setSecondRingerStatusFromSettings=function(e){return a.setSetting("hasSecondRinger",e)},this.getHandfreeMicrophoneFromSettings=function(){return a.getSetting("microphone")},this.getHandfreeMicrophone=function(){var e=o.defer();return m.getMicrophones().then(function(t){e.resolve(m.getDeviceWithId(t,m.getHandfreeMicrophoneFromSettings()))}),e.promise},this.getHeadsetMicrophoneFromSettings=function(){return a.getSetting("headsetMicrophone")},this.getHeadsetMicrophone=function(){var e=o.defer();return m.getMicrophones().then(function(t){e.resolve(m.getDeviceWithId(t,m.getHeadsetMicrophoneFromSettings()))}),e.promise},this.getHeadsetDeviceName=function(){var e=o.defer();return e.resolve(a.getSetting("headsetDeviceName")),e.promise},this.getSpeakerphoneMicrophoneFromSettings=function(){return a.getSetting("speakerphoneMicrophone")},this.getSpeakerphoneMicrophone=function(){var e=o.defer();return m.getMicrophones().then(function(t){e.resolve(m.getDeviceWithId(t,m.getSpeakerphoneMicrophoneFromSettings()))}),e.promise},this.getSpeakerphoneDeviceName=function(){var e=o.defer();return e.resolve(a.getSetting("speakerphoneDeviceName")),e.promise},this.getCustomMicrophoneFromSettings=function(){return a.getSetting("customMicrophone")},this.getCustomMicrophone=function(){var e=o.defer();return m.getMicrophones().then(function(t){e.resolve(m.getDeviceWithId(t,m.getCustomMicrophoneFromSettings()))}),e.promise},this.getMicrophones=function(){var e=o.defer();return this.allowDevicesManagement()||e.resolve([]),m.getAudioInputDevices().then(function(t){e.resolve(t&&t.constructor===Array&&C?t:[])}).catch(function(n){return t.info("[PlatformService] === SERVICES FAILURE === : "+n.message),e.reject(n),e.promise}),e.promise},this.isHandfreeMicrophoneAvailable=function(){return m.isDeviceAvailable(m.mediaDevices,m.getHandfreeMicrophoneFromSettings(),"audioinput")},this.isHeadsetMicrophoneAvailable=function(){return m.isDeviceAvailable(m.mediaDevices,m.getHeadsetMicrophoneFromSettings(),"audioinput")},this.isSpeakerphoneMicrophoneAvailable=function(){return m.isDeviceAvailable(m.mediaDevices,m.getSpeakerphoneMicrophoneFromSettings(),"audioinput")},this.isCustomMicrophoneAvailable=function(){return m.isDeviceAvailable(m.mediaDevices,m.getCustomMicrophoneFromSettings(),"audioinput")},this.getCurrentSpeaker=function(){if("sdk"===a.getSetting("apiMode")){var e=m.getSpeakerForSDK();if(e)return e}switch(m.getActiveAudioProfile()){case S.SPEAKERPHONE:return m.getSpeakerphoneSpeaker();case S.CUSTOM:return m.getCustomSpeaker();case S.HEADSET:return m.getHeadsetSpeaker();default:return m.getHandfreeSpeaker()}},this.getSpeakerForSDK=function(){var e=o.defer();return m.getSpeakers().then(function(t){e.resolve(m.getDeviceWithId(t,a.getSetting("speaker")))}),e.promise},this.getHandfreeSpeakerFromSettings=function(){return a.getSetting("speaker")},this.getHandfreeSpeaker=function(){var e=o.defer();return m.getSpeakers().then(function(t){e.resolve(m.getDeviceWithId(t,m.getHandfreeSpeakerFromSettings(),!0))}),e.promise},this.getHeadsetSpeakerFromSettings=function(){return a.getSetting("headsetSpeaker")},this.getHeadsetSpeaker=function(){var e=o.defer();return m.getSpeakers().then(function(t){e.resolve(m.getDeviceWithId(t,m.getHeadsetSpeakerFromSettings()))}),e.promise},this.getSpeakerphoneSpeakerFromSettings=function(){return a.getSetting("speakerphoneSpeaker")},this.getSpeakerphoneSpeaker=function(){var e=o.defer();return m.getSpeakers().then(function(t){e.resolve(m.getDeviceWithId(t,m.getSpeakerphoneSpeakerFromSettings()))}),e.promise},this.getCustomSpeakerFromSettings=function(){return a.getSetting("customSpeaker")},this.getCustomSpeaker=function(){var e=o.defer();return m.getSpeakers().then(function(t){e.resolve(m.getDeviceWithId(t,m.getCustomSpeakerFromSettings()))}),e.promise},this.getRingingSpeakerFromSettings=function(){return a.getSetting("ringingSpeaker")},this.getRingingSpeaker=function(){var e=o.defer();return m.getSpeakers().then(function(t){e.resolve(m.getDeviceWithId(t,m.getRingingSpeakerFromSettings()))}),e.promise},this.setSpeakerForElement=function(e,n){var r=o.defer();if(!e||!e.setSinkId)return t.warn("[platformService] setSpeakerForElement -- missing element"),o.when();if(this.allowDevicesManagement()){if(n===e.sinkId)return o.when();e.id&&t.log("[platformService] setSpeakerForElement "+e.id+" with "+n),e.setSinkId(n).then(function(){t.log("[platformService] Success, audio output device attached: "+n),angular.element("#globalAudioTag")[0]&&t.log("[platformService] sinkId for globalAudioTag is "+angular.element("#globalAudioTag")[0].sinkId),r.resolve()}).catch(function(e){var n=e;"SecurityError"===e.name&&(n="[platformService] You need to use HTTPS for selecting audio output device: "+e),t.error("[platformService] "+n),r.resolve()})}else t.warn("[platformService] Browser does not support output device selection."),r.resolve();return r.promise},this.getSpeakers=function(){var e=o.defer();return m.allowDevicesManagement()||e.resolve([]),m.getAudioOutputDevices().then(function(t){e.resolve(t&&t.constructor===Array&&C?t:[])}).catch(function(n){return t.info("[PlatformService] === SERVICES FAILURE === : "+n.message),e.reject(n),e.promise}),e.promise},this.isHandfreeSpeakerAvailable=function(){return m.isDeviceAvailable(m.mediaDevices,m.getHandfreeSpeakerFromSettings(),"audiooutput")};var E=!1;this.isHeadsetSpeakerAvailable=function(){return m.isDeviceAvailable(m.mediaDevices,m.getHeadsetSpeakerFromSettings(),"audiooutput")};var b=null;this.isSpeakerphoneSpeakerAvailable=function(){return m.isDeviceAvailable(m.mediaDevices,m.getSpeakerphoneSpeakerFromSettings(),"audiooutput")};var y=!1;this.isCustomSpeakerAvailable=function(){return m.isDeviceAvailable(m.mediaDevices,m.getCustomSpeakerFromSettings(),"audiooutput")};var R=!1,T="",I=[],A=[],N=[],O=[],D=[],P=!0,w=["realtek","soundmax","high definition audio","nomachine"];m.arrayContains=function(e,t){return e.some(function(e){return-1<t.indexOf(e)})},m.getDeviceType=function(e){return e=e.toLowerCase(),m.arrayContains(w,e)?S.HANDFREE:S.HEADSET},this.normalizeAnyLabel=function(e){return e?("default"===e.id||"communications"===e.id||e.normalizedLabel||(m.isWin?e.normalizedLabel=e.label.substring(e.label.indexOf("(")+1,e.label.indexOf(")")):e.normalizedLabel=e.label),e):null};var _,M=function(){var e=o.defer();return m.getMicrophones().then(function(e){return I=e,m.getSpeakers()}).then(function(r){A=r;var i=[];angular.forEach(I,function(e){"default"!==e.id&&"communications"!==e.id&&(e=m.normalizeAnyLabel(e),i.some(function(t){return t.microphone.normalizedLabel===e.normalizedLabel})||angular.forEach(A,function(t){if(t=m.normalizeAnyLabel(t),e.normalizedLabel===t.normalizedLabel&&m.getDeviceType(e.normalizedLabel)===S.HEADSET){var n={label:e.normalizedLabel,microphone:e,speaker:t};i.push(n),P&&N.push(n)}}))});var o=a.getSetting("headsetDeviceName");(!o||"null"===o)&&i.length&&(o=i[0].label,a.setSetting("headsetDeviceName",i[0].label),a.setSetting("headsetMicrophone",i[0].microphone.id),a.setSetting("headsetSpeaker",i[0].speaker.id));var s=[];P||(angular.forEach(i,function(e){O.some(function(t){return t.label===e.label})||(s.push(e),N.push(e))}),0<s.length&&(t.info("[PlatformService] hotplugged headset(s): "+(1<s.length?s.reduce(function(e,t){return{label:e.Label+", "+t.Label}}).label:s[0].label)),n.$broadcast("ON_AUDIO_HOTPLUG_DEVICES_CHANGED_EVENT",{devices:s,action:"add"})));var c=[];!P&&O.length>i.length&&(angular.forEach(O,function(e){if(!i.some(function(t){return t.label===e.label})){c.push(e);var t=N.map(function(e){return e.label}).indexOf(e.label);N.splice(t,1)}}),0<c.length&&(t.info("[PlatformService] unplugged headset(s): "+(1<c.length?c.reduce(function(e,t){return{label:e.Label+", "+t.Label}}).label:c[0].label)),n.$broadcast("ON_AUDIO_HOTPLUG_DEVICES_CHANGED_EVENT",{devices:c,action:"remove"}))),P=!1,O=i,e.resolve(i)}),e.promise};this.getHeadsetDevices=function(){return O},this.getSpeakerphoneDevices=function(){return D},this.getAllDevices=function(){return N},this.getHandFreeDevice=function(){var e=o.defer();return m.getHandfreeMicrophone().then(function(t){var n=t;m.getHandfreeSpeaker().then(function(t){var r=t;(!m.handFreeDevice||m.handFreeDevice.microphone&&m.handFreeDevice.microphone.id!==n.id||m.handFreeDevice.speaker&&m.handFreeDevice.speaker.id!==r.id)&&(m.handFreeDevice={label:"",microphone:n,speaker:r,profile:S.HANDFREE}),e.resolve(m.handFreeDevice)})}),e.promise},this.getCustomDevice=function(){var e=o.defer();return m.getCustomMicrophone().then(function(t){var n=t;m.getCustomSpeaker().then(function(t){var r=t;(!m.customDevice||m.customDevice.microphone&&m.customDevice.microphone.id!==n.id||m.customDevice.speaker&&m.customDevice.speaker.id!==r.id)&&(m.customDevice={label:"",microphone:n,speaker:r,profile:S.CUSTOM}),e.resolve(m.customDevice)})}),e.promise},this.getAvailableDevices=function(){var e=o.defer(),t=[];return m.getHandFreeDevice().then(function(n){t.push(n),O.forEach(function(e){e.profile=S.HEADSET,t.push(e)}),D.forEach(function(e){e.profile=S.SPEAKERPHONE,t.push(e)}),m.getCustomDevice().then(function(n){t.push(n),e.resolve(t)})}),e.promise},this.getStoredDeviceList=function(){return a.getSetting("deviceList")},this.saveDeviceList=function(e){for(var t=[],n=0;n<e.length;n++)t[n]=e[n].label;a.setSetting("deviceList",angular.toJson(t))},this.getCurrentCamera=function(){var e=o.defer();return m.getCameras().then(function(t){e.resolve(m.getDeviceWithId(t,a.getSetting("camera")))}),e.promise},this.getCameraForSDK=function(){return{id:a.getSetting("camera")}},this.getCameras=function(){var e=o.defer();return this.allowDevicesManagement()||e.resolve([]),m.getVideoInputDevices().then(function(t){e.resolve(t&&t.constructor===Array&&g?t:[])}).catch(function(n){return t.info("[PlatformService] === SERVICES FAILURE === : "+n.message),e.reject(n),e.promise}),e.promise},this.isDeviceAvailable=function(e,t,n){var r=e.find(function(e){return e.kind===n&&e.deviceId===t});return angular.isDefined(r)},this.getDeviceWithId=function(e,t,n){if(e.constructor!==Array)return null;var r=null;if("default"===t||"communications"===t)if(n){(i=m.mediaDevices.find(function(e){return e.deviceId===t&&"audioinput"===e.kind}))&&(r=e.find(function(e){return"default"!==e.id&&"communications"!==e.id&&i.groupId===e.groupId}))}else{(i=e.find(function(e){return e.id===t}))&&(r=e.find(function(e){return"default"!==e.id&&"communications"!==e.id&&i.groupId===e.groupId}))}if(r)return r;if(!(r=e.find(function(e){return e.id===t}))){var i;if(n)(i=m.mediaDevices.find(function(e){return"default"===e.deviceId&&"audioinput"===e.kind}))&&(r=e.find(function(e){return"default"!==e.id&&"communications"!==e.id&&i.groupId===e.groupId}));r||(i=e.find(function(e){return"default"===e.id}))&&(r=e.find(function(e){return"default"!==e.id&&"communications"!==e.id&&i.groupId===e.groupId}))}return r||(0<e.length?e[0]:null)},this.startWatcher=function(){if(m.allowDevicesManagement()){if(angular.isDefined(_))return;_=i(m.devicesWatcher,1e3)}},this.stopWatcher=function(){angular.isDefined(_)&&(i.cancel(_),_=void 0)},this.capitalizeFirstLetter=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},this.fixDeviceLabels=function(){angular.forEach(DetectRTC.MediaDevices,function(e){e&&("default"!==e.id||e.label&&"Default"!==e.label?64>e.id.length&&"Please invoke getUserMedia once."===e.label&&(e.label=m.capitalizeFirstLetter(e.id)):e.label=m.findAndUpdateDefaultDeviceLabel(e.kind,e.groupId),t.info("[PlatformService] fixDeviceLabels || update device "+e.id+" with kind "+e.kind+" with label "+e.label))})},this.findAndUpdateDefaultDeviceLabel=function(e,t){for(var n="audioinput"===e?s("translate")("yourComputerMicrophoneDevice"):s("translate")("yourComputerSpeakerDevice"),r=0;r<DetectRTC.MediaDevices.length;r++)if("default"!==DetectRTC.MediaDevices[r].id&&DetectRTC.MediaDevices[r].kind===e&&DetectRTC.MediaDevices[r].groupId===t){n=n+" - "+DetectRTC.MediaDevices[r].label;break}return n},this.updatePermissions=function(){var e=!1;return angular.forEach(DetectRTC.MediaDevices,function(t){t&&64<=t.id.length&&("Please invoke getUserMedia once."===t.label?e=!0:("videoinput"===t.kind&&!g&&(g=!0),"audioinput"===t.kind&&!C&&(C=!0)))}),e},this.isGetUserMediaRequested=function(){return!(g&&C)&&m.updatePermissions(DetectRTC.MediaDevices)},this.audioMediaDeviceUpdated=function(){m.fixDeviceLabels(),n.$broadcast("ON_USER_AUDIO_MEDIA_CHANGED_EVENT")},this.videoMediaDeviceUpdated=function(){m.fixDeviceLabels(),n.$broadcast("ON_USER_VIDEO_MEDIA_CHANGED_EVENT")};var k=function(e){var t=[];return angular.forEach(e,function(e){t.some(function(t){return t.id===e.id})||t.push(e)}),t};this.getAudioInputDevices=function(){return o.when(k(DetectRTC.audioInputDevices))},this.getAudioOutputDevices=function(){var e=o.defer();return e.resolve(k(DetectRTC.audioOutputDevices)),e.promise},this.getVideoInputDevices=function(){var e=o.defer();return e.resolve(k(DetectRTC.videoInputDevices)),e.promise}}])},function(){angular.module("rainbow").service("gaService",[function(){"use strict";var e={category:"webrtc",action:"CallsSuccessRate",label:"error_failed"},t={category:"webrtc",action:"CallsSuccessRate",label:"success"},n={category:"webrtc",action:"CallsSuccessRate",label:"error_no_stun_candidate"},r={category:"webrtc",action:"ICEDistribution"},i={category:"webrtc",action:"ICETopology"},a={category:"webrtc",action:"ICENegotiation",label:"DurationMs"},o={category:"webrtc",action:"GetUserMediaRate",label:"success"},s={category:"webrtc",action:"GetUserMediaRate",label:"error_no_Track"},c={category:"webrtc",action:"GetUserMediaRate",label:"error"},l={category:"webrtc",action:"CodecsDistribution"},d={category:"webrtc",action:"CallsDistribution"},u={category:"webrtc",action:"CallsDurationRange"},h={category:"ux",action:"dragAndDrop"},f={category:"invitations",action:"inviteFromProvider"},p=null,m=null,v=!1,g=null,C=null,S=null;this.provideGA=function(e){S=e},this.hasGA=function(){return null!==S},this.trackICEUsed=function(e,t){if(S){var n="",i="";switch(e){case"local":n="host";break;case"peerreflexive":case"prflx":case"serverreflexive":n="stun";break;case"relayed":n="relay";break;default:n=e}switch(t){case"local":i="host";break;case"peerreflexive":case"prflx":case"serverreflexive":i="stun";break;case"relayed":i="relay";break;default:i=t}S.send("event",r.category,r.action,n+"|"+i)}},this.trackICEFailed=function(t){S&&t&&C!==t&&(S.send("event",e.category,e.action,e.label),C=t)},this.trackICESuccess=function(e){S&&e&&g!==e&&(S.send("event",t.category,t.action,t.label),g=e)},this.trackICENoSTUNCandidate=function(){S&&S.send("event",n.category,n.action,n.label)},this.trackICETopology=function(e){S&&S.send("event",i.category,i.action,e)},this.trackGetUserMediaSuccess=function(){S&&S.send("event",o.category,o.action,o.label)},this.trackGetUserMediaErrorNoTrack=function(){S&&S.send("event",s.category,s.action,s.label)},this.trackGetUserMediaError=function(){S&&S.send("event",c.category,c.action,c.label)},this.trackCodecsUsed=function(e,t){S&&S.send("event",l.category,l.action,e+"|"+t)},this.negotiationTime=function(){return m&&p?m<p?null:m-p:null},this.startNegotiationTime=function(e){p=e||(new Date).getTime(),v=!0},this.endNegotiationTime=function(e){v&&(m=e||(new Date).getTime(),v=!1)},this.trackNegotiationTime=function(){if(S){var e=this.negotiationTime();e&&S.send("event",a.category,a.action,a.label,e),m=null,p=null}},this.resetProvider=function(){S=null},this.trackCallSuccessNumber=function(e){e&&0<e.length&&S&&S.send("event",d.category,d.action,e)},this.trackCallDuration=function(e){if(S&&angular.isDefined(e)&&0<=e){var t,n=Math.round(e/1e3);t=15>n?"very_short_less_15s":30>n?"very_short_less_30s":60>n?"short_less_60s":120>n?"short_less_120s":300>n?"short_less_300s":600>n?"normal_less_600s":1200>n?"normal_less_1200s":1800>n?"normal_less_1800s":3600>n?"long_less_3600s":"long_more_3600s",S.send("event",u.category,u.action,t)}},this.trackDragAndDrop=function(e){S&&S.send("event",h.category,h.action,e)},this.inviteContactsFromProvider=function(e,t){S&&S.send("event",f.category,f.action,e,t)}}])},function(){angular.module("rainbow").service("countryService",["$http","$q","$log","$translate","authService",function(e,t,n,r,i){"use strict";var a=this;a.datacenters=[{name:"France","alpha-3":"FRA","alpha-2":"FR",region:"Europe"},{name:"Germany","alpha-3":"DEU","alpha-2":"DE",region:"Europe"},{name:"Canada","alpha-3":"CAN","alpha-2":"CA",region:"America"},{name:"Singapore","alpha-3":"SGP","alpha-2":"SG",region:"Asia-Pacific"}],a.countries=[{name:"Australia","alpha-3":"AUS","country-code":"036","alpha-2":"AU"},{name:"Austria","alpha-3":"AUT","country-code":"040","alpha-2":"AT"},{name:"Belgium","alpha-3":"BEL","country-code":"056","alpha-2":"BE"},{name:"Brazil","alpha-3":"BRA","country-code":"076","alpha-2":"BR"},{name:"Canada","alpha-3":"CAN","country-code":"124","alpha-2":"CA"},{name:"China","alpha-3":"CHN","country-code":"156","alpha-2":"CN"},{name:"Czech Republic","alpha-3":"CZE","country-code":"203","alpha-2":"CZ"},{name:"Denmark","alpha-3":"DNK","country-code":"208","alpha-2":"DK"},{name:"Finland","alpha-3":"FIN","country-code":"246","alpha-2":"FI"},{name:"France","alpha-3":"FRA","country-code":"250",default:!0,"alpha-2":"FR"},{name:"Germany","alpha-3":"DEU","country-code":"276","alpha-2":"DE"},{name:"Hong Kong","alpha-3":"HKG","country-code":"344","alpha-2":"HK"},{name:"Ireland","alpha-3":"IRL","country-code":"372","alpha-2":"IE"},{name:"Israel","alpha-3":"ISR","country-code":"376","alpha-2":"IL"},{name:"Italy","alpha-3":"ITA","country-code":"380","alpha-2":"IT"},{name:"Mexico","alpha-3":"MEX","country-code":"484","alpha-2":"MX"},{name:"Netherlands","alpha-3":"NLD","country-code":"528","alpha-2":"NL"},{name:"Norway","alpha-3":"NOR","country-code":"578","alpha-2":"NO"},{name:"Poland","alpha-3":"POL","country-code":"616","alpha-2":"PL"},{name:"Portugal","alpha-3":"PRT","country-code":"620","alpha-2":"PT"},{name:"Russia","alpha-3":"RUS","country-code":"643","alpha-2":"RU"},{name:"South Africa","alpha-3":"ZAF","country-code":"710","alpha-2":"ZA"},{name:"South Korea","alpha-3":"KOR","country-code":"410","alpha-2":"KR"},{name:"Spain","alpha-3":"ESP","country-code":"724","alpha-2":"ES"},{name:"Sweden","alpha-3":"SWE","country-code":"752","alpha-2":"SE"},{name:"Switzerland","alpha-3":"CHE","country-code":"756","alpha-2":"CH"},{name:"Taiwan","alpha-3":"TWN","country-code":"158","alpha-2":"TW"},{name:"Turkey","alpha-3":"TUR","country-code":"792","alpha-2":"TR"},{name:"United Kingdom","alpha-3":"GBR","country-code":"826","alpha-2":"GB"},{name:"United States of America","alpha-3":"USA","country-code":"840","alpha-2":"US"},{name:"Afghanistan","alpha-3":"AFG","country-code":"004","alpha-2":"AF"},{name:"Albania","alpha-3":"ALB","country-code":"008","alpha-2":"AL"},{name:"Algeria","alpha-3":"DZA","country-code":"012","alpha-2":"DZ"},{name:"Andorra","alpha-3":"AND","country-code":"020","alpha-2":"AD"},{name:"Angola","alpha-3":"AGO","country-code":"024","alpha-2":"AO"},{name:"Anguilla","alpha-3":"AIA","country-code":"660","alpha-2":"AI"},{name:"Antigua and Barbuda","alpha-3":"ATG","country-code":"028","alpha-2":"AG"},{name:"Argentina","alpha-3":"ARG","country-code":"032","alpha-2":"AR"},{name:"Armenia","alpha-3":"ARM","country-code":"051","alpha-2":"AM"},{name:"Aruba","alpha-3":"ABW","country-code":"533","alpha-2":"AW"},{name:"Azerbaijan","alpha-3":"AZE","country-code":"031","alpha-2":"AZ"},{name:"Bahamas","alpha-3":"BHS","country-code":"044","alpha-2":"BS"},{name:"Bahrain","alpha-3":"BHR","country-code":"048","alpha-2":"BH"},{name:"Bangladesh","alpha-3":"BGD","country-code":"050","alpha-2":"BD"},{name:"Barbados","alpha-3":"BRB","country-code":"052","alpha-2":"BB"},{name:"Belarus","alpha-3":"BLR","country-code":"112","alpha-2":"BY"},{name:"Belize","alpha-3":"BLZ","country-code":"084","alpha-2":"BZ"},{name:"Benin","alpha-3":"BEN","country-code":"204","alpha-2":"BJ"},{name:"Bermuda","alpha-3":"BMU","country-code":"060","alpha-2":"BM"},{name:"Bhutan","alpha-3":"BTN","country-code":"064","alpha-2":"BT"},{name:"Bolivia","alpha-3":"BOL","country-code":"068","alpha-2":"BO"},{name:"Bosnia and Herzegovina","alpha-3":"BIH","country-code":"070","alpha-2":"BA"},{name:"Botswana","alpha-3":"BWA","country-code":"072","alpha-2":"BW"},{name:"British Virgin Islands","alpha-3":"VGB","country-code":"092","alpha-2":"VG"},{name:"Brunei Darussalam","alpha-3":"BRN","country-code":"096","alpha-2":"BN"},{name:"Bulgaria","alpha-3":"BGR","country-code":"100","alpha-2":"BG"},{name:"Burkina Faso","alpha-3":"BFA","country-code":"854","alpha-2":"BF"},{name:"Burundi","alpha-3":"BDI","country-code":"108","alpha-2":"BI"},{name:"Cambodia","alpha-3":"KHM","country-code":"116","alpha-2":"KH"},{name:"Cameroon","alpha-3":"CMR","country-code":"120","alpha-2":"CM"},{name:"Cape Verde","alpha-3":"CPV","country-code":"132","alpha-2":"CV"},{name:"Cayman Islands","alpha-3":"CYM","country-code":"136","alpha-2":"KY"},{name:"Central African Republic","alpha-3":"CAF","country-code":"140","alpha-2":"CF"},{name:"Chad","alpha-3":"TCD","country-code":"148","alpha-2":"TD"},{name:"Chile","alpha-3":"CHL","country-code":"152","alpha-2":"CL"},{name:"Colombia","alpha-3":"COL","country-code":"170","alpha-2":"CO"},{name:"Comoros","alpha-3":"COM","country-code":"174","alpha-2":"KM"},{name:"Congo","alpha-3":"COG","country-code":"178","alpha-2":"CG"},{name:"Congo, Democratic Republic of","alpha-3":"COD","country-code":"180","alpha-2":"CD"},{name:"Costa Rica","alpha-3":"CRI","country-code":"188","alpha-2":"CR"},{name:"Ivory Coast","alpha-3":"CIV","country-code":"384","alpha-2":"CI"},{name:"Croatia","alpha-3":"HRV","country-code":"191","alpha-2":"HR"},{name:"Cyprus","alpha-3":"CYP","country-code":"196","alpha-2":"CY"},{name:"Djibouti","alpha-3":"DJI","country-code":"262","alpha-2":"DJ"},{name:"Dominica","alpha-3":"DMA","country-code":"212","alpha-2":"DM"},{name:"Dominican Republic","alpha-3":"DOM","country-code":"214","alpha-2":"DO"},{name:"Ecuador","alpha-3":"ECU","country-code":"218","alpha-2":"EC"},{name:"El Salvador","alpha-3":"SLV","country-code":"222","alpha-2":"SV"},{name:"Egypt","alpha-3":"EGY","country-code":"818","alpha-2":"EG"},{name:"Eritrea","alpha-3":"ERI","country-code":"232","alpha-2":"ER"},{name:"Estonia","alpha-3":"EST","country-code":"233","alpha-2":"EE"},{name:"Ethiopia","alpha-3":"ETH","country-code":"231","alpha-2":"ET"},{name:"Fiji","alpha-3":"FJI","country-code":"242","alpha-2":"FJ"},{name:"French Guiana","alpha-3":"GUF","country-code":"254","alpha-2":"GF"},{name:"French Polynesia","alpha-3":"PYF","country-code":"258","alpha-2":"PF"},{name:"Gabon","alpha-3":"GAB","country-code":"266","alpha-2":"GA"},{name:"Gambia","alpha-3":"GMB","country-code":"270","alpha-2":"GM"},{name:"Georgia","alpha-3":"GEO","country-code":"268","alpha-2":"GE"},{name:"Ghana","alpha-3":"GHA","country-code":"288","alpha-2":"GH"},{name:"Greece","alpha-3":"GRC","country-code":"300","alpha-2":"GR"},{name:"Grenada","alpha-3":"GRD","country-code":"308","alpha-2":"GD"},{name:"Guadeloupe","alpha-3":"GLP","country-code":"312","alpha-2":"GP"},{name:"Guatemala","alpha-3":"GTM","country-code":"320","alpha-2":"GT"},{name:"Guinea","alpha-3":"GIN","country-code":"324","alpha-2":"GN"},{name:"Guyana","alpha-3":"GUY","country-code":"328","alpha-2":"GY"},{name:"Haiti","alpha-3":"HTI","country-code":"332","alpha-2":"HT"},{name:"Honduras","alpha-3":"HND","country-code":"340","alpha-2":"HN"},{name:"Hungary","alpha-3":"HUN","country-code":"348","alpha-2":"HU"},{name:"Iceland","alpha-3":"ISL","country-code":"352","alpha-2":"IS"},{name:"India","alpha-3":"IND","country-code":"356","alpha-2":"IN"},{name:"Indonesia","alpha-3":"IDN","country-code":"360","alpha-2":"ID"},{name:"Iraq","alpha-3":"IRQ","country-code":"368","alpha-2":"IQ"},{name:"Jamaica","alpha-3":"JAM","country-code":"388","alpha-2":"JM"},{name:"Japan","alpha-3":"JPN","country-code":"392","alpha-2":"JP"},{name:"Jordan","alpha-3":"JOR","country-code":"400","alpha-2":"JO"},{name:"Kazakhstan","alpha-3":"KAZ","country-code":"398","alpha-2":"KZ"},{name:"Kenya","alpha-3":"KEN","country-code":"404","alpha-2":"KE"},{name:"Kuwait","alpha-3":"KWT","country-code":"414","alpha-2":"KW"},{name:"Kyrgyzstan","alpha-3":"KGZ","country-code":"417","alpha-2":"KG"},{name:"Latvia","alpha-3":"LVA","country-code":"428","alpha-2":"LV"},{name:"Lebanon","alpha-3":"LBN","country-code":"422","alpha-2":"LB"},{name:"Lesotho","alpha-3":"LSO","country-code":"426","alpha-2":"LS"},{name:"Liberia","alpha-3":"LBR","country-code":"430","alpha-2":"LR"},{name:"Libya","alpha-3":"LBY","country-code":"434","alpha-2":"LY"},{name:"Liechtenstein","alpha-3":"LIE","country-code":"438","alpha-2":"LI"},{name:"Lithuania","alpha-3":"LTU","country-code":"440","alpha-2":"LT"},{name:"Luxembourg","alpha-3":"LUX","country-code":"442","alpha-2":"LU"},{name:"Macao","alpha-3":"MAC","country-code":"446","alpha-2":"MO"},{name:"Macedonia","alpha-3":"MKD","country-code":"807","alpha-2":"MK"},{name:"Madagascar","alpha-3":"MDG","country-code":"450","alpha-2":"MG"},{name:"Malawi","alpha-3":"MWI","country-code":"454","alpha-2":"MW"},{name:"Malaysia","alpha-3":"MYS","country-code":"458","alpha-2":"MY"},{name:"Maldives","alpha-3":"MDV","country-code":"462","alpha-2":"MV"},{name:"Mali","alpha-3":"MLI","country-code":"466","alpha-2":"ML"},{name:"Malta","alpha-3":"MLT","country-code":"470","alpha-2":"MT"},{name:"Mauritius","alpha-3":"MUS","country-code":"480","alpha-2":"MU"},{name:"Mayotte","alpha-3":"MYT","country-code":"175","alpha-2":"YT"},{name:"Moldova","alpha-3":"MDA","country-code":"498","alpha-2":"MD"},{name:"Monaco","alpha-3":"MCO","country-code":"492","alpha-2":"MC"},{name:"Mongolia","alpha-3":"MNG","country-code":"496","alpha-2":"MN"},{name:"Montenegro","alpha-3":"MNE","country-code":"499","alpha-2":"ME"},{name:"Montserrat","alpha-3":"MSR","country-code":"500","alpha-2":"MS"},{name:"Morocco","alpha-3":"MAR","country-code":"504","alpha-2":"MA"},{name:"Mozambique","alpha-3":"MOZ","country-code":"508","alpha-2":"MZ"},{name:"Myanmar","alpha-3":"MMR","country-code":"104","alpha-2":"MM"},{name:"Namibia","alpha-3":"NAM","country-code":"516","alpha-2":"NA"},{name:"Nepal","alpha-3":"NPL","country-code":"524","alpha-2":"NP"},{name:"New Zealand","alpha-3":"NZL","country-code":"554","alpha-2":"NZ"},{name:"Nicaragua","alpha-3":"NIC","country-code":"558","alpha-2":"NI"},{name:"Niger","alpha-3":"NER","country-code":"562","alpha-2":"NE"},{name:"Nigeria","alpha-3":"NGA","country-code":"566","alpha-2":"NG"},{name:"Oman","alpha-3":"OMN","country-code":"512","alpha-2":"OM"},{name:"Pakistan","alpha-3":"PAK","country-code":"586","alpha-2":"PK"},{name:"Palestine","alpha-3":"PSE","country-code":"275","alpha-2":"PS"},{name:"Panama","alpha-3":"PAN","country-code":"591","alpha-2":"PA"},{name:"Paraguay","alpha-3":"PRY","country-code":"600","alpha-2":"PY"},{name:"Peru","alpha-3":"PER","country-code":"604","alpha-2":"PE"},{name:"Philippines","alpha-3":"PHL","country-code":"608","alpha-2":"PH"},{name:"Puerto Rico","alpha-3":"PRI","country-code":"630","alpha-2":"PR"},{name:"Qatar","alpha-3":"QAT","country-code":"634","alpha-2":"QA"},{name:"Romania","alpha-3":"ROU","country-code":"642","alpha-2":"RO"},{name:"Rwanda","alpha-3":"RWA","country-code":"646","alpha-2":"RW"},{name:"Saint Kitts and Nevis","alpha-3":"KNA","country-code":"659","alpha-2":"KN"},{name:"Saint Lucia","alpha-3":"LCA","country-code":"662","alpha-2":"LC"},{name:"Saint Vincent and the Grenadines","alpha-3":"VCT","country-code":"670","alpha-2":"VC"},{name:"Saudi Arabia","alpha-3":"SAU","country-code":"682","alpha-2":"SA"},{name:"Senegal","alpha-3":"SEN","country-code":"686","alpha-2":"SN"},{name:"Serbia","alpha-3":"SRB","country-code":"688","alpha-2":"RS"},{name:"Sierra Leone","alpha-3":"SLE","country-code":"694","alpha-2":"SL"},{name:"Singapore","alpha-3":"SGP","country-code":"702","alpha-2":"SG"},{name:"Slovakia","alpha-3":"SVK","country-code":"703","alpha-2":"SK"},{name:"Slovenia","alpha-3":"SVN","country-code":"705","alpha-2":"SI"},{name:"South Sudan","alpha-3":"SSD","country-code":"728","alpha-2":"SS"},{name:"Sri Lanka","alpha-3":"LKA","country-code":"144","alpha-2":"LK"},{name:"Sudan","alpha-3":"SDN","country-code":"729","alpha-2":"SD"},{name:"Swaziland","alpha-3":"SWZ","country-code":"748","alpha-2":"SZ"},{name:"Tajikistan","alpha-3":"TJK","country-code":"762","alpha-2":"TJ"},{name:"Tanzania","alpha-3":"TZA","country-code":"834","alpha-2":"TZ"},{name:"Thailand","alpha-3":"THA","country-code":"764","alpha-2":"TH"},{name:"Togo","alpha-3":"TGO","country-code":"768","alpha-2":"TG"},{name:"Trinidad and Tobago","alpha-3":"TTO","country-code":"780","alpha-2":"TT"},{name:"Tunisia","alpha-3":"TUN","country-code":"788","alpha-2":"TN"},{name:"Turkmenistan","alpha-3":"TKM","country-code":"795","alpha-2":"TM"},{name:"Turks and Caicos Islands","alpha-3":"TCA","country-code":"796","alpha-2":"TC"},{name:"Uganda","alpha-3":"UGA","country-code":"800","alpha-2":"UG"},{name:"Ukraine","alpha-3":"UKR","country-code":"804","alpha-2":"UA"},{name:"United Arab Emirates","alpha-3":"ARE","country-code":"784","alpha-2":"AE"},{name:"Virgin Islands, US","alpha-3":"VIR","country-code":"850","alpha-2":"VI"},{name:"Uruguay","alpha-3":"URY","country-code":"858","alpha-2":"UY"},{name:"Uzbekistan","alpha-3":"UZB","country-code":"860","alpha-2":"UZ"},{name:"Venezuela","alpha-3":"VEN","country-code":"862","alpha-2":"VE"},{name:"Vietnam","alpha-3":"VNM","country-code":"704","alpha-2":"VN"},{name:"Zambia","alpha-3":"ZMB","country-code":"894","alpha-2":"ZM"},{name:"Zimbabwe","alpha-3":"ZWE","country-code":"716","alpha-2":"ZW"}],a.statesOfCanada={AB:"Alberta",BC:"British Columbia",MB:"Manitoba",NB:"New Brunswick",NL:"Newfoundland and Labrador",NS:"Nova Scotia",NT:"Northwest Territories",NU:"Nunavut",ON:"Ontario",PE:"Prince Edward Island",QC:"Quebec",SK:"Saskatchewan",YT:"Yukon"},a.statesOfAmerica={AL:"Alabama",AK:"Alaska",AZ:"Arizona",AR:"Arkansas",AA:"Armed Forces America",AE:"Armed Forces",AP:"Armed Forces Pacific",CA:"California",CO:"Colorado",CT:"Connecticut",DE:"Delaware",FL:"Florida",GA:"Georgia",GU:"Guam",HI:"Hawaii",ID:"Idaho",IL:"Illinois",IN:"Indiana",IA:"Iowa",KS:"Kansas",KY:"Kentucky",LA:"Louisiana",ME:"Maine",MD:"Maryland",MA:"Massachusetts",MI:"Michigan",MN:"Minnesota",MS:"Mississippi",MO:"Missouri",MT:"Montana",NE:"Nebraska",NV:"Nevada",NH:"New Hampshire",NJ:"New Jersey",NM:"New Mexico",NY:"New York",NC:"North Carolina",ND:"North Dakota",OH:"Ohio",OK:"Oklahoma",OR:"Oregon",PA:"Pennsylvania",PR:"Puerto Rico",RI:"Rhode Island",SC:"South Carolina",SD:"South Dakota",TN:"Tennessee",TX:"Texas",UT:"Utah",VT:"Vermont",VI:"Virgin Islands",VA:"Virginia",WA:"Washington",DC:"Washington DC",WV:"West Virginia",WI:"Wisconsin",WY:"Wyoming"},a.init=function(){this.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/"},a.start=function(e){n.info(""),n.info("[countryService] === STARTING ===");var r=performance.now();return t(function(t){a.init(),a.getAvailableCountries().then(function(e){a.countries=e.map(function(e){var t={name:e.fullname,"alpha-3":e.isoAlpha3Code,"alpha-2":e.isoAlpha2Code};return"FRA"===e.isoAlpha3Code&&(t.default=!0),t})}).catch(function(e){n.info("[countryService] === warning === "+e.message)}).finally(function(){var i=Math.round(performance.now()-r);e.push({service:"countryService",startDuration:i}),n.info("[countryService] === STARTED ("+i+" ms) === "+a.countries.length+" countries"),n.info(""),t()})})},a.stop=function(){n.info("[countryService] STOPPED")},a.getAvailableCountries=function(){return t(function(t,r){e({method:"GET",url:a.portalURL+"countries",headers:i.getRequestHeader()}).then(function(e){t(e.data.data)}).catch(function(e){var t=e.data?e.data.errorDetails||e.data.errorMsg:e.message;n.error("[countryService] getAvailableCountries failure -- "+t+" - status "+e.status),r(new Error(t))})})},a.getCountries=function(){var e=a.countries.map(a.translateCountryName);return e.sort(a.sortByCountryName),e},a.sortByCountryName=function(e,t){return e.name.localeCompare(t.name,r.use())},a.translateCountryName=function(e){var t=a.getCountryLabel(e["alpha-2"]);if(t){var n=r.instant(t);n&&n!==t&&(e.name=n)}return e},a.getCountryStates=function(e){return e&&"USA"===e["alpha-3"]?a.statesOfAmerica:e&&"CAN"===e["alpha-3"]?a.statesOfCanada:{}},a.getCountry=function(e,t){if(!e)return t?a.getDefaultCountry():null;var n=a.countries.filter(function(t){return t["alpha-3"]===e});return 0<n.length?n[0]:null},a.getDefaultCountry=function(){var e=a.countries.filter(function(e){return!0===e.default});return 0<e.length?e[0]:a.countries[0]},a.getCountryName=function(e){return a.getCountry(e)?a.getCountry(e).name:null},a.getCountryCode=function(e){return e?e["alpha-3"]:null},a.getDefaultState=function(e){return e&&"USA"===e["alpha-3"]?"AL":e&&"CAN"===e["alpha-3"]?"AB":null},a.getAlpha2Code=function(e){if(!e)return null;var t=a.countries.filter(function(t){return t["alpha-3"]===e});return 0<t.length?t[0]["alpha-2"]:null},a.getCountryLabel=function(e){if(3===e.length)var t=a.getAlpha2Code(e);else t=e;return t?"country"+t:null},a.getDataCenterLabel=function(e,t){var n=a.getRegionLabel(e.name);if(e.country===t)n=a.getCountryLabel(e.country);else{var r=a.datacenters.find(function(t){return t["alpha-3"]===e.country});r&&(n=a.getRegionLabel(r.region))}return n},a.getRegionLabel=function(e){return e}}]),angular.module("rainbow").filter("countryFilter",["countryService",function(e){"use strict";return function(t){return e.getCountryName(t)}}])},function(){angular.module("rainbow").service("usersService",["$q","$log","$rootScope","contactService",function(e,t,n,r){"use strict";var i=this,a=[];this.started=!1,this.start=function(r){t.info("[usersService] === STARTING ==="),i.started=!0;var o=performance.now();t.info("[usersService] start"),i.contactsInRoster=i.getAllRosterContacts(),i.lastNameList=i.orderContactsByLastName(),i.firstNameList=i.orderContactByFirstName(),i.companyNameList=i.orderContactsByCompany(),a.push(n.$on("ON_CONTACT_ROSTER_UPDATE_EVENT",i.onContactUpdatedEvent));var s=Math.round(performance.now()-o);return r.push({service:"usersService",startDuration:s}),t.info("[usersService] === STARTED ("+s+" ms) ==="),e.when()},this.stop=function(){t.info("[usersService] === STOPPING ==="),i.started&&(i.started=!1);for(var n;n=a.pop();)n();return t.info("[usersService] === STOPPED ==="),e.when()},this.onContactUpdatedEvent=function(){t.info("[usersService] onContactUpdatedEvent");var e=i.getAllRosterContacts();0!=e.length-i.contactsInRoster.length&&(t.info("[usersService] onContactUpdatedEvent - update all user lists"),i.contactsInRoster=e,i.lastNameList=i.orderContactsByLastName(),i.firstNameList=i.orderContactByFirstName(),i.companyNameList=i.orderContactsByCompany(),n.$broadcast("ON_USER_SERVICE_ROSTER_UPDATE_EVENT"))},this.getLastNameList=function(){return i.lastNameList},this.getFirstNameList=function(){return i.firstNameList},this.getCompanyNameList=function(){return i.companyNameList},this.getAllRosterContacts=function(){return r.getContacts().filter(function(e){return e.displayName&&e.roster})},this.addSeparatorsForLastname=function(e){var t=[],n="";return e.forEach(function(e){if(n!==e.lastname.charAt(0).toUpperCase()){var r={value:n=e.lastname.charAt(0).toUpperCase(),type:"separator",id:n};t.push(r)}t.push(e)}),t},this.orderContactsByLastName=function(){var e=i.contactsInRoster;return e=i.getOrderedUsers(e,"lastname"),i.addSeparatorsForLastname(e)},this.addSeparatorsForFirstname=function(e){var t=[],n="";return e.forEach(function(e){if(n!==e.firstname.charAt(0).toUpperCase()){var r={value:n=e.firstname.charAt(0).toUpperCase(),type:"separator",id:n};t.push(r)}t.push(e)}),t},this.orderContactByFirstName=function(){var e=i.contactsInRoster;return e=i.getOrderedUsers(e,"firstname"),i.addSeparatorsForFirstname(e)},this.addSeparatorsForCompany=function(e){var t=[],n="";return e.forEach(function(e){if(n!==e.company.name){var r={value:n=e.company.name,type:"separator",id:n};t.push(r)}t.push(e)}),t},this.orderContactsByCompany=function(){var e=i.contactsInRoster;return e=i.getOrderedUsers(e,"company"),i.addSeparatorsForCompany(e)},this.getFilterAndOrderUsersGroupedByOrderLabel=function(e,t,n,r){r=!!(!0&r);var a=i.getFilterAndOrderUsers(e,t,n,r);return"firstname"===t?i.addSeparatorsForFirstname(a):"company"===t?i.addSeparatorsForCompany(a):i.addSeparatorsForLastname(a)},this.getFilterAndOrderUsersGroupedByOrderLabelAndUpdateActivity=function(e,t,n,r){r=!!(!0&r);var a=i.getFilterAndOrderUsers(e,t,n,r);return"firstname"===t?i.addSeparatorsForFirstname(a):"company"===t?i.addSeparatorsForCompany(a):i.addSeparatorsForLastname(a)},this.getFilterAndOrderUsers=function(e,t,n,r){var a=i.getFilteredUsers(e,n,r);return i.getOrderedUsers(a,t)},this.getFilteredUsers=function(e,t,n){var r;return r=(r=e.filter(function(e){if("separator"===e.type)return!0;var r=e.displayName&&e.roster||n,i="offline"!==e.status&&"wait"!==e.status&&"xa"!==e.status&&"unknown"!==e.status,a="wait"===e.status,o=e.isTerminated;return"online"===t?r&&i:"offline"===t?r&&!i&&!o:"pending"===t?r&&a:"all"===t?r&&!o:r})).filter(function(e,t){return!!("separator"!==e.type||r[t+1]&&"separator"!==r[t+1].type)})},this.getOrderedUsers=function(e,t){return e.sort(function(e,n){var r;if("lastname"===t)return 0===(r=e.lastname.localeCompare(n.lastname))?e.firstname.localeCompare(n.firstname):r;if("firstname"===t)return 0===(r=e.firstname.localeCompare(n.firstname))?e.lastname.localeCompare(n.lastname):r;if("company"===t){var i=e.company.name.localeCompare(n.company.name);return 0===i?e.lastname.localeCompare(n.lastname):i}return 0})}}])},function(){angular.module("rainbow").service("utilService",["$log",function(e){"use strict";var t=[{base:"A",letters:/[\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F]/g},{base:"AA",letters:/[\uA732]/g},{base:"AE",letters:/[\u00C6\u01FC\u01E2]/g},{base:"AO",letters:/[\uA734]/g},{base:"AU",letters:/[\uA736]/g},{base:"AV",letters:/[\uA738\uA73A]/g},{base:"AY",letters:/[\uA73C]/g},{base:"B",letters:/[\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181]/g},{base:"C",letters:/[\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E]/g},{base:"D",letters:/[\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779]/g},{base:"DZ",letters:/[\u01F1\u01C4]/g},{base:"Dz",letters:/[\u01F2\u01C5]/g},{base:"E",letters:/[\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E]/g},{base:"F",letters:/[\u0046\u24BB\uFF26\u1E1E\u0191\uA77B]/g},{base:"G",letters:/[\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E]/g},{base:"H",letters:/[\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D]/g},{base:"I",letters:/[\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197]/g},{base:"J",letters:/[\u004A\u24BF\uFF2A\u0134\u0248]/g},{base:"K",letters:/[\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2]/g},{base:"L",letters:/[\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780]/g},{base:"LJ",letters:/[\u01C7]/g},{base:"Lj",letters:/[\u01C8]/g},{base:"M",letters:/[\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C]/g},{base:"N",letters:/[\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4]/g},{base:"NJ",letters:/[\u01CA]/g},{base:"Nj",letters:/[\u01CB]/g},{base:"O",letters:/[\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C]/g},{base:"OI",letters:/[\u01A2]/g},{base:"OO",letters:/[\uA74E]/g},{base:"OU",letters:/[\u0222]/g},{base:"P",letters:/[\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754]/g},{base:"Q",letters:/[\u0051\u24C6\uFF31\uA756\uA758\u024A]/g},{base:"R",letters:/[\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782]/g},{base:"S",letters:/[\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784]/g},{base:"T",letters:/[\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786]/g},{base:"TZ",letters:/[\uA728]/g},{base:"U",letters:/[\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244]/g},{base:"V",letters:/[\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245]/g},{base:"VY",letters:/[\uA760]/g},{base:"W",letters:/[\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72]/g},{base:"X",letters:/[\u0058\u24CD\uFF38\u1E8A\u1E8C]/g},{base:"Y",letters:/[\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE]/g},{base:"Z",letters:/[\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762]/g},{base:"a",letters:/[\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250]/g},{base:"aa",letters:/[\uA733]/g},{base:"ae",letters:/[\u00E6\u01FD\u01E3]/g},{base:"ao",letters:/[\uA735]/g},{base:"au",letters:/[\uA737]/g},{base:"av",letters:/[\uA739\uA73B]/g},{base:"ay",letters:/[\uA73D]/g},{base:"b",letters:/[\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253]/g},{base:"c",letters:/[\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184]/g},{base:"d",letters:/[\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A]/g},{base:"dz",letters:/[\u01F3\u01C6]/g},{base:"e",letters:/[\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD]/g},{base:"f",letters:/[\u0066\u24D5\uFF46\u1E1F\u0192\uA77C]/g},{base:"g",letters:/[\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F]/g},{base:"h",letters:/[\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265]/g},{base:"hv",letters:/[\u0195]/g},{base:"i",letters:/[\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131]/g},{base:"j",letters:/[\u006A\u24D9\uFF4A\u0135\u01F0\u0249]/g},{base:"k",letters:/[\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3]/g},{base:"l",letters:/[\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747]/g},{base:"lj",letters:/[\u01C9]/g},{base:"m",letters:/[\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F]/g},{base:"n",letters:/[\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5]/g},{base:"nj",letters:/[\u01CC]/g},{base:"o",letters:/[\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275]/g},{base:"oi",letters:/[\u01A3]/g},{base:"ou",letters:/[\u0223]/g},{base:"oo",letters:/[\uA74F]/g},{base:"p",letters:/[\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755]/g},{base:"q",letters:/[\u0071\u24E0\uFF51\u024B\uA757\uA759]/g},{base:"r",letters:/[\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783]/g},{base:"s",letters:/[\u0073\u24E2\uFF53\u00DF\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B]/g},{base:"t",letters:/[\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787]/g},{base:"tz",letters:/[\uA729]/g},{base:"u",letters:/[\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289]/g},{base:"v",letters:/[\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C]/g},{base:"vy",letters:/[\uA761]/g},{base:"w",letters:/[\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73]/g},{base:"x",letters:/[\u0078\u24E7\uFF58\u1E8B\u1E8D]/g},{base:"y",letters:/[\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF]/g},{base:"z",letters:/[\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763]/g}];this.removeDiacritis=function(e){for(var n=0;n<t.length;n++)e=e.replace(t[n].letters,t[n].base);return e},this.escapeHtml=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},this.extractHtmlContent=function(t){var n=new DOMParser,r="{}";try{r=n.parseFromString(t,"text/html").documentElement.textContent}catch(n){e.error("[utilService] error in extractHtmlContent:",n),r="{}"}return r},this.sortAlphaNum=function(e,t){var n=/[^a-zA-Z]/g,r=/[^0-9]/g,i=e.replace(n,""),a=t.replace(n,"");if(i===a){var o=parseInt(e.replace(r,""),10),s=parseInt(t.replace(r,""),10);return o===s?0:o>s?1:-1}return i>a?1:-1},this.anonymizePhoneNumber=function(e){if(null==e)return null;if(config&&config.debug)return e;var t="";return 0===e.indexOf("+")&&(t="+"),t=4<e.length?t+"*".repeat(e.length-4-t.length)+e.slice(e.length-4):e}}])},function(){},function(e,t,n){"use strict";var r=Math.round,i=String.fromCharCode,a=Math.ceil;Object.defineProperty(t,"__esModule",{value:!0});const o=n(1),s=n(1);class c{release(){URL.revokeObjectURL(this.url)}constructor(e,t){t&&(this.url=URL.createObjectURL(t)),this.fd=e}}class l{constructor(e,t,n,r,i,a,o,s,c,l,d){this.$q=e,this.$http=t,this.$log=n,this.authService=r,this.fileStorageService=i,this.TransfertPromiseQueue=a,this.FileDescriptorEventHandler=o,this.xmppService=s,this.errorHelperService=c,this.$rootScope=l,this.$interval=d,this.ONE_KILOBYTE=1024,this.ONE_MEGABYTE=1048576,this.ONE_GIGABYTE=1073741824,this.started=!1,this.thumbnailPromises=[]}start(e){this.$log.info("[FileServerService] === STARTING ===");let t=performance.now();return this.started=!1,this.portalURL=config.restServerUrl+"/api/rainbow/fileserver/v1.0/files",this.getServercapabilities().then(()=>{this.attachHandlers(),this.transfertPromiseQueue=this.TransfertPromiseQueue.create();var n=r(performance.now()-t);e.push({service:"FileServerService",startDuration:n}),this.$log.info("[FileServerService] === STARTED ("+n+" ms) ===")}).catch(e=>{this.$log.error("[FileServerService] === STARTING FAILURE === "+e.message)}),this.$q.when()}stop(){return this.$log.info("[FileServerService] === STOPPING ==="),this.started&&(this.started=!1),this.$log.info("[FileServerService] === STOPPED ==="),this.$q.when()}attachHandlers(){this.removeHandlers(),this.fileDescriptorEventHandler=this.FileDescriptorEventHandler.create(this),this.fileMessageHandlerRef||(this.fileMessageHandlerRef=this.xmppService.addHandler(e=>(this.$interval(()=>{this.fileDescriptorEventHandler.onManagementMessageReceived(e)},250,1),!0),null,"message","management"))}removeHandlers(){this.fileDescriptorEventHandler=void 0,this.fileMessageHandlerRef=void 0}getLocalImage(e,t,n=!0){return this.$q(r=>{let i=this.fileStorageService.getFileDescriptorById(e);(i?this.$q.resolve(i):this.fileStorageService.retrieveAndStoreOneFileDescriptor(e)).then(e=>{let i=null;(i=t&&e.previewBlob&&!n?this.$q.resolve(e.previewBlob):t?this.getLargeBlobThumbnail(e):this.getBlobFromFileDescriptor(e,!1,null)).then(t=>{r(new c(e,t))})}).catch(()=>{new c(null,null).url="/resources/skins/rainbow/images/wizard/chrome.png",this.$log.error(`[fileServerService] getFileLocalURL -- no file descriptor found with ${e} + " id.`),r(null)})})}getLargeBlobThumbnail(e){let t=e.url+"?thumbnail500=true";return this.getBlobFromUrl(t,e.typeMIME,e.size,e.fileName)}getPartialDataFromServer(e,t,n,r){return this.$q((a,o)=>{this.$http({method:"GET",url:e,headers:this.authService.getRequestHeaderWithRange("bytes="+t+"-"+n),responseType:"arraybuffer"}).then(e=>{a({data:e.data,index:r})},e=>{let t=this.errorHelperService.handleError(e),n=JSON.parse(i.apply(null,new Uint8Array(e.data))),r=this.errorHelperService.getLocalizedError(n.errorDetailsCode);this.$log.error(r),o(t)})})}getFileStorageService(){return this.fileStorageService}getBlobThumbnailFromFileDescriptor(e,t=!1){if(e.thumbnail.isThumbnailAvailable()||e.isImage()&&e.size<20*this.ONE_KILOBYTE){var n=this.thumbnailPromises[e.id];if(n)return this.$log.info("[FileServerService] getBlobThumbnailFromFileDescriptor "+e.id+" already lauched"),n.promise;var r=this.$q.defer();this.thumbnailPromises[e.id]=r;let i=e.url;return e.thumbnail.isThumbnailAvailable()&&e.size>=20*this.ONE_KILOBYTE?i+=t?"?thumbnail500=true":"?thumbnail=true":e.uploadedDate&&(i+="?update="+o.MD5(s.enc.Latin1.parse(e.uploadedDate)).toString(s.enc.Hex)),this.getBlobFromUrl(i,e.typeMIME,e.size,e.fileName).then(t=>{e.previewBlob=t,this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"success",type:"download",fileDesc:e}),delete this.thumbnailPromises[e.id],r.resolve(t)}).catch(t=>{this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"download",message:t.message,fileDesc:e}),delete this.thumbnailPromises[e.id],r.reject(t)}),r.promise}return this.$q.reject()}getBlobFromFileDescriptor(e,t=!0,n){if(!e)return this.$log.warn("[FileServerService] getBlobFromFileDescriptor : missing file descriptor"),this.$q.reject();if(this.$log.info("[FileServerService] getBlobFromFileDescriptor: "+e.id),"uploaded"!==e.state)return this.$log.warn("[FileServerService] getBlobFromFileDescriptor : file is not in uploaded state="+e.state),this.$q.reject();let r=e.url;e.uploadedDate&&(r+="?update="+o.MD5(s.enc.Latin1.parse(e.uploadedDate)).toString(s.enc.Hex));let c=this.ONE_MEGABYTE;if(this.capabilities.maxChunkSizeDownload&&0!==e.size&&e.size>c){e.size>=100*c&&(c=e.size/100+this.ONE_KILOBYTE,this.$log.debug("[FileServerService] changing chunk size: "+c));var l=this.$q.defer();let o=[],s=[];e.state="downloading",e.chunkTotalNumber=a(e.size/c),e.chunkPerformed=0,e.chunkPerformedPercent=0,this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{type:"download",fileDesc:e,cancelable:t}),this.$log.info("[FileServerService] getBlobFromFileDescriptor: need to download "+e.chunkTotalNumber+" chunks");for(let i=0,l=0,d=c-1,u=a(e.size/c);0<u;i++,u--,l+=c,d+=c)d=d<e.size?d:e.size,s.push(()=>{var a=this.$q.defer();return this.getPartialDataFromServer(r,l,d,i).then(r=>(e.chunkPerformed++,e.chunkPerformedPercent=100*e.chunkPerformed/e.chunkTotalNumber,this.$log.info("[FileServerService] getBlobFromFileDescriptor : chunk downloaded="+e.chunkPerformed),o[r.index]=r.data,this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{type:"download",fileDesc:e,cancelable:t}),n?n(r,e.id).then(()=>a.resolve(r.data)):a.resolve(r))).catch(e=>{this.$log.info("[FileServerService] error on chunk download="+e),a.reject(e)}),a.promise});return this.transfertPromiseQueue.addPromiseArray(e.id,s,()=>{let t=new Blob(o,{type:e.typeMIME});this.$log.info("[FileServerService] getBlobFromFileDescriptor success"),e.state="uploaded",e.chunkPerformed=0,e.chunkTotalNumber=0,e.chunkPerformedPercent=0,this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{type:"download",fileDesc:e}),l.resolve(t)},t=>{let n=this.errorHelperService.handleError(t);e.state="uploaded",e.chunkPerformed=0,e.chunkTotalNumber=0,e.chunkPerformedPercent=0;let r=JSON.parse(i.apply(null,new Uint8Array(t.data))),a=this.errorHelperService.getLocalizedError(r.errorDetailsCode);this.$log.error(a),this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"download",message:a||n.message,fileDesc:e}),l.reject(n)}),l.promise}return e.state="downloading",e.chunkTotalNumber=1,e.chunkPerformed=0,e.chunkPerformedPercent=0,this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:e,cancelable:!1}),this.getBlobFromUrl(r,e.typeMIME,e.size,e.fileName).then(t=>(e.state="uploaded",this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:e}),this.$q.resolve(t))).catch(t=>(e.state="uploaded",this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:e}),this.$log.info("[FileServerService] arrayPromise : error "+t.message),this.$q.reject(t)))}getBlobFromUrl(e,t){return this.$log.debug("[FileServerService] >getBlobFromUrl: "+e),this.$q((n,r)=>{this.$http({method:"GET",url:e,headers:this.authService.getRequestHeader(),responseType:"arraybuffer"}).then(e=>{let r=new Blob([e.data],{type:t});this.$log.debug("[FileServerService] getBlobFromUrl success"),n(r)},e=>{let t=this.errorHelperService.handleError(e),n=JSON.parse(i.apply(null,new Uint8Array(e.data))),a=this.errorHelperService.getLocalizedError(n.errorDetailsCode);this.$log.error(a),r(t)})})}getBlobUrlAndOrientationByFileDescriptorId(e){return this.$q((t,n)=>{let r=this.fileStorageService.getFileDescriptorById(e);r?this.getBlobFromFileDescriptor(r,!1,null).then(n=>{let i={blobUrl:URL.createObjectURL(n),id:e};return r.orientation?(i.orientation=r.orientation,void t(i)):void this.setImageOrientationForFileDescriptor(r,n).then(e=>{i.orientation=e,t(i)}).catch(()=>{t(i)})}).catch(e=>{n(e)}):(this.$log.error("[FileServerService] getBlobUrlAndOrientationById no file descriptor found for ID "+e),n(new Error("[FileServerService] getBlobUrlAndOrientationById no file descriptor found")))})}setImageOrientationForFileDescriptor(e,t){return this.$q((n,r)=>{if(e&&e.isImage()){var i=new FileReader;i.onload=(t=>{e.orientation=1;var i=t.target.result,a=new DataView(i);if(65496===a.getUint16(0,!1)){for(var o=a.byteLength,s=2;s<o;){if(8>=a.getUint16(s+2,!1))return void r();var c=a.getUint16(s,!1);if(s+=2,65505===c){if(1165519206!==a.getUint32(s+=2,!1))return void r();var l=18761===a.getUint16(s+=6,!1);s+=a.getUint32(s+4,l);var d=a.getUint16(s,l);s+=2;for(var u=0;u<d;u++)if(274===a.getUint16(s+12*u,l)){var h=a.getUint16(s+12*u+8,l);return e.orientation=h,void n(h)}}else{if(65280!=(65280&c))break;s+=a.getUint16(s,!1)}}r()}else r()}),i.readAsArrayBuffer(t)}else r()})}uploadAFile(e,t){return this.$q((n,r)=>{let i=this.fileStorageService.getFileDescriptorById(e);i&&(i.state="uploading"),this.$http({method:"PUT",url:this.portalURL+"/"+e,headers:this.authService.getPostHeader("application/octet-stream"),data:t,uploadEventHandlers:{progress:e=>{this.$log.log(e)}}}).then(()=>{let t=this.fileStorageService.getFileDescriptorById(e);t&&(t.state="uploaded"),this.$log.info("[FileServerService] uploadAFile success"),this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"success",type:"upload",fileDesc:t}),this.fileStorageService.orderDocuments(),n(t)},e=>{let t=this.errorHelperService.handleError(e);this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"upload",fileDesc:i}),r(t),this.$log.error("[FileServerService] "+t.message)})})}sendPartialDataToServer(e,t,n,r,i,a){return this.$q((o,s)=>{this.$http({method:"PUT",url:this.portalURL+"/"+e+"/parts/"+a,headers:this.authService.getPostHeaderWithRange("bytes "+r+"-"+i+"/"+n,"application/octet-stream"),data:t,uploadEventHandlers:{progress:e=>{this.$log.log(e)}}}).then(e=>{let t=e.data.data;this.$log.info("[FileServerService] sendPartialDataToServer success"),o(t)},e=>{let t=this.errorHelperService.handleError(e);s(t),this.$log.error("[FileServerService] "+t.message)})})}calculateMd5(e,t){var n=new FileReader;n.readAsBinaryString(e),n.onloadend=(()=>{t(o.MD5(s.enc.Latin1.parse(n.result)).toString(s.enc.Hex))})}uploadAFileByChunk(e,t,n,i){this.$log.info("[FileServerService] >uploadAFileByChunk");let o=this.ONE_MEGABYTE;if(o<t.size){t.size>=100*o&&(o=r(t.size/100+this.ONE_KILOBYTE),this.$log.debug("[FileServerService] changing chunk size: "+o));var s=this.$q.defer();e.chunkTotalNumber=a(t.size/o),e.chunkPerformed=0,e.chunkPerformedPercent=0,e.state="uploading",this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:e,cancelable:!0});let c=[];for(let r=0,s=0,l=o-1,d=a(t.size/o);0<d;r++,d--,s+=o,l+=o){let a=l<t.size?l:t.size,o=t.slice(s,a+1);c.push(()=>{var c=this.$q.defer();return this.calculateMd5(o,l=>{this.$log.info("[FileServerService] sendPartialDataToServer calculated checksum="+l),this.sendPartialDataToServer(e.id,o,t.size,s,a,r).then(t=>{if(this.$log.info("[FileServerService] sendPartialDataToServer md5sum="+t.md5sum),!t.md5sum.localeCompare(l))return e.chunkPerformed++,e.chunkPerformedPercent=100*e.chunkPerformed/e.chunkTotalNumber,i&&i(n,e),this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:e,cancelable:!0}),c.resolve(t);this.$log.error("[FileServerService] Wrong Checksum for chunk detected: "+t.md5sum+"/"+l),c.reject({errorDetailsCode:500,message:"Wrong Checksum for chunk"})}).catch(e=>{this.$log.info("[FileServerService] error on chunk upload="+e),c.reject(e)})}),c.promise})}return this.transfertPromiseQueue.addPromiseArray(e.id,c,()=>{this.$http({method:"PUT",url:this.portalURL+"/"+e.id+"/parts/end",headers:this.authService.getPostHeader("application/octet-stream"),uploadEventHandlers:{progress:e=>{this.$log.log(e)}}}).then(()=>{this.$log.info("[FileServerService] uploadAFileByChunk success"),e.state="uploaded",e.chunkPerformed=0,e.chunkTotalNumber=0,e.chunkPerformedPercent=0,i&&i(n,e),this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"success",type:"upload",fileDesc:e}),this.fileStorageService.orderDocuments(),this.fileStorageService.retrieveUserConsumption(),s.resolve(e)},t=>{let n=this.errorHelperService.handleError(t);this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"upload",fileDesc:e}),s.reject(n)})},t=>{let n=this.errorHelperService.handleError(t);this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"upload",fileDesc:e}),s.reject(n)}),s.promise}return i&&i(n,e),this.uploadAFile(e.id,t,e.typeMIME).then(()=>(this.$log.info("[FileServerService] uploadAFile success"),i&&i(n,e),this.fileStorageService.retrieveUserConsumption(),this.$q.resolve(e)))}isTransferInProgress(){return this.transfertPromiseQueue.isTransferInProgress()}cancelAllTransfers(){this.transfertPromiseQueue.cancelAllTransfers()}cancelCurrentFiletransfer(e){this.transfertPromiseQueue.cancelCurrentFiletransfer(e)}getServercapabilities(){return this.$q((e,t)=>{this.$http({method:"GET",url:config.restServerUrl+"/api/rainbow/fileserver/v1.0/capabilities",headers:this.authService.getRequestHeader()}).then(t=>{this.$log.info("[FileServerService] getServercapabilities -- success"),this.capabilities=t.data.data,e(this.capabilities)},e=>{let n=this.errorHelperService.handleError(e);this.$log.error("[FileServerService] getServercapabilities "+n.message),t(n)})})}getBlobFromUrlWithOptimization(e,t,n=0,r="",c=""){return 0!==c.length&&(e+="?update="+o.MD5(s.enc.Latin1.parse(c)).toString(s.enc.Hex)),this.capabilities.maxChunkSizeDownload&&0!==n&&n>this.capabilities.maxChunkSizeDownload?this.$q((r,o)=>{let s=this.capabilities.maxChunkSizeDownload;s>this.ONE_MEGABYTE&&(s=this.ONE_MEGABYTE);let c=0,l=s-1,d=a(n/s),u=Array(d);this.$log.debug("[FileServerService] getBlobFromUrlWithOptimization : "+d+" chunks to be downloaded");let h=[];for(let t=0;0<d;t++,d--,c+=s,l+=s)h.push(this.getPartialDataFromServer(e,c,l,t).then(e=>(u[e.index]=e.data,e.data)));this.$q.all(h).then(()=>{let e=new Blob(u,{type:t});this.$log.debug("[FileServerService] getBlobFromUrlWithOptimization success"),r(e)},e=>{let t=this.errorHelperService.handleError(e),n=JSON.parse(i.apply(null,new Uint8Array(e.data))),r=this.errorHelperService.getLocalizedError(n.errorDetailsCode);this.$log.error(r),o(t)})}):this.getBlobFromUrl(e,t,n,r)}getBlobUrlFromUrl(e,t,n=0,r=""){return this.$q((i,a)=>{this.getBlobFromUrlWithOptimization(e,t,n,r).then(e=>{i(URL.createObjectURL(e))}).catch(e=>{a(e)})})}}l.$inject=["$q","$http","$log","authService","fileStorageService","TransfertPromiseQueue","FileDescriptorEventHandler","xmppService","errorHelperService","$rootScope","$interval"],angular.module("rainbow").service("fileServerService",l)},function(){class e{constructor(e,t,n,r,i,a,o,s,c,l,d,u,h){this.$injector=e,this.$q=t,this.$http=n,this.$log=r,this.$rootScope=i,this.authService=a,this.fileViewerFactory=o,this.errorHelperService=s,this.orderByFilter=c,this.contactService=l,this.helpersService=d,this.fileViewerElementFactory=u,this.fileDescriptorFactory=h,this.started=!1,this.listeners=[],this.rotationValues={1:"rotate(0deg)",3:"rotate(180deg)",6:"rotate(90deg)",8:"rotate(270deg)"}}start(e){this.$log.info("[FileStorageService] === STARTING ===");let t=performance.now();return this.started=!1,this.portalURL=config.restServerUrl+"/api/rainbow/filestorage/v1.0/files",this.fileDescriptors=[],this.fileDescriptorsByDate=[],this.fileDescriptorsByName=[],this.fileDescriptorsBySize=[],this.receivedFileDescriptors=[],this.receivedFileDescriptorsByName=[],this.receivedFileDescriptorsByDate=[],this.receivedFileDescriptorsBySize=[],this.consumptionData={},this.channelService=this.$injector.get("channelService"),this.retrieveFileDescriptorsListPerOwner().then(()=>this.retrieveReceivedFiles(this.contactService.userContact.dbId)).then(()=>(this.orderDocuments(),this.retrieveUserConsumption())).then(()=>{this.started=!0;var n=Math.round(performance.now()-t);e.push({service:"FileStorageService",startDuration:n}),this.$log.info("[FileStorageService] === STARTED ("+n+" ms) ===")}).catch(e=>{this.$log.error("[FileStorageService] === STARTING === failure -- "+e.message)}),this.listeners.push(this.$rootScope.$on("ROOM_UPDATE_EVENT",(e,t,n)=>{n&&"remove"===n&&(this.$log.info("[FileStorageService] ROOM_UPDATE_EVENT REMOVED for roomId="+t.dbId),this.removeRoomFileViewer(t))})),this.$q.when()}stop(){return this.$log.info("[FileStorageService] === STOPPING ==="),this.started&&(this.started=!1),this.listeners&&this.listeners.forEach(e=>{e()}),this.$log.info("[FileStorageService] === STOPPED ==="),this.$q.when()}reinit(e){return this.$q((t,n)=>e?(this.$log.info("[FileStorageService] === reinit blocking ==="),void this.reinitInternal().then(()=>{t()}).catch(()=>{n()})):(this.$log.info("[FileStorageService] === reinit not blocking ==="),t(),void this.reinitInternal()))}reinitInternal(){return this.$q((e,t)=>{this.retrieveFileDescriptorsListPerOwner().then(()=>this.retrieveReceivedFiles(this.contactService.userContact.dbId)).then(()=>{this.orderDocuments(),this.$log.info("[FileStorageService] reinitInternal done"),e()}).catch(e=>{this.$log.error("[FileStorageService] reinitInternal failure -- "+e.message),t()})})}removeRoomFileViewer(e){let t;this.$log.info("[FileStorageService] >removeRoomFileViewer: "+e.dbId);do{if(t=this.getFileDescriptorByViewerId(e.dbId)){var n=t.viewers.find(t=>t.viewerId===e.dbId);n&&(this.$log.info("[FileStorageService] >viewer found delete it"),t.viewers.splice(t.viewers.indexOf(n),1))}}while(t)}getFileDescriptorByViewerId(e){for(let t of this.fileDescriptors)for(let n of t.viewers)if(n.viewerId===e)return t;for(let t of this.receivedFileDescriptors)if(t.id===e)return t;return null}getFileDescriptorById(e){for(let t of this.fileDescriptors)if(t.id===e)return t;for(let t of this.receivedFileDescriptors)if(t.id===e)return t;return null}getCompleteFileDescriptorById(e){return this.$q((t,n)=>{let r;if(this.fileDescriptors.some(t=>t.id===e&&(r=t,!0))){let e=[];for(let t of r.viewers)"user"===t.type&&e.push(this.contactService.getContactByDBId(t.viewerId).then(e=>(t.contact=e,t)).catch(e=>{this.$log.error("[FileStorageService] "+e),n(e)}));this.$q.all(e).then(()=>{t(r)}).catch(e=>{this.$log.error("[FileStorageService] "+e),n(e)})}else n()})}getDocuments(){return this.fileDescriptors}getReceivedDocuments(){return this.receivedFileDescriptors}getDocumentsByName(e){return e?this.receivedFileDescriptorsByName:this.fileDescriptorsByName}getDocumentsByDate(e){return e?this.receivedFileDescriptorsByDate:this.fileDescriptorsByDate}getDocumentsBySize(e){return e?this.receivedFileDescriptorsBySize:this.fileDescriptorsBySize}getReceivedFilesFromContact(e){return this.receivedFileDescriptorsByDate.filter(t=>t.ownerId===e)}getSentFilesToContact(e){return this.fileDescriptorsByDate.filter(t=>{for(let n=0;n<t.viewers.length;n++)if(t.viewers[n].viewerId===e)return!0;return!1})}getReceivedFilesForRoom(e){return this.receivedFileDescriptorsByDate.filter(t=>{for(let n=0;n<t.viewers.length;n++)if(t.viewers[n].viewerId===e&&t.ownerId!==this.contactService.userContact.dbId)return!0;return!1})}getConsumptionData(){return this.consumptionData}createFileDescriptor(e,t,n,r){return this.$q((i,a)=>{this.$http({method:"POST",url:this.portalURL,headers:this.authService.getRequestHeader(),data:{fileName:e,extension:t,size:n,viewers:r}}).then(e=>{const t=this.createFileDescriptorFromData(e.data.data);this.$log.info("[FileStorageService] createFileDescriptor -- "+t.id+" -- success"),t&&this.fileDescriptors.push(t),this.orderDocuments(),i(t)}).catch(e=>{const t=this.errorHelperService.handleError(e,"createFileDescriptor");this.$log.error("[FileStorageService] "+t.message),a(t)})})}createFileDescriptorFromData(e){if(e){let n=[];if(e.viewers)for(let t of e.viewers)n.push(this.fileViewerElementFactory(t.viewerId,t.type,t.contact,this.contactService,this.channelService));let r=e.url;r||(r=config.restServerUrl+"/api/rainbow/fileserver/v1.0/files/"+e.id);var t;return t=e.isUploaded?"uploaded":"not_uploaded",this.fileDescriptorFactory(e.id,r,e.ownerId,e.fileName,e.extension,e.typeMIME,e.size,e.registrationDate,e.uploadedDate,e.dateToSort,n,t,e.thumbnail,e.orientation)}}deleteFileDescriptor(e){return this.$q((t,n)=>{this.$http({method:"DELETE",url:this.portalURL+"/"+e,headers:this.authService.getRequestHeader()}).then(()=>{this.$log.info("[FileStorageService] deleteFileDescriptor -- success"),this.deleteFileDescriptorFromCache(e,!1),this.$rootScope.$broadcast("ON_FILE_REMOVED_FROM_STORE_EVENT",{fileId:e}),this.retrieveUserConsumption(),t(void 0)}).catch(e=>{let t=this.errorHelperService.handleError(e,"deleteFileDescriptor");n(t),this.$log.error("[FileStorageService] "+t.message)})})}deleteAllFileDescriptor(){return this.$q((e,t)=>{this.$http({method:"DELETE",url:this.portalURL+"/all",headers:this.authService.getRequestHeader()}).then(()=>{this.$log.info("[FileStorageService] deleteAllFileDescriptor -- success"),this.deleteAllFilesDescriptorsFromCache(),this.retrieveUserConsumption(),e()}).catch(e=>{let n=this.errorHelperService.handleError(e,"deleteAllFileDescriptor");this.$log.error("[FileStorageService]"+n.message),t(n)})})}retrieveFileDescriptorsListPerOwner(){return this.fileDescriptors||(this.fileDescriptors=[]),this.$q((e,t)=>{this.$http({method:"GET",url:this.portalURL+"?format=full&limit=1000",headers:this.authService.getRequestHeader()}).then(t=>{this.fileDescriptors=[];let n=t.data.data;n||e();let r=t.data.limit,i=t.data.total,a=null;if(i<=r)a=this.$q.resolve([]);else{let e=r,t=[];for(let n=1;n<i/r;n++)t.push(this.retrieveFileDescriptorsListPerOwnerwithOffset(e,r)),e+=r;a=this.$q.all(t)}a.then(t=>{t.forEach(e=>{n=n.concat(e)});for(let e of n){let t=this.createFileDescriptorFromData(e);"not_uploaded"===t.state?(this.$log.info("[FileStorageService] file "+t.fileName+" not uploaded"),t.ownerId===this.contactService.userContact.dbId?(this.$log.info("[FileStorageService] file "+t.fileName+" is our property, we can delete it"),this.deleteFileDescriptor(t.id)):this.$log.info("[FileStorageService] file "+t.fileName+" is NOT our property, we CANNOT delete it")):this.fileDescriptors.push(t)}this.$log.info("[FileStorageService] retrieveFileDescriptorsListPerOwner -- success"),e(this.fileDescriptors)})}).catch(e=>{let n=this.errorHelperService.handleError(e,"retrieveFileDescriptorsListPerOwner");t(n),this.$log.error("[FileStorageService] "+n.message)})})}retrieveFileDescriptorsListPerOwnerwithOffset(e,t){return this.$q(n=>{this.$http({method:"GET",url:this.portalURL+"?format=full&limit="+t+"&offset="+e,headers:this.authService.getRequestHeader()}).then(e=>{n(e.data.data)})})}retrieveFilesReceivedFromPeer(e,t){return this.$q((n,r)=>{this.$http({method:"GET",url:this.portalURL+"/viewers/"+e+"?ownerId="+t+"&format=full",headers:this.authService.getRequestHeader()}).then(e=>{let t=[],r=e.data.data;if(r)for(let e of r){let n=this.createFileDescriptorFromData(e);t.push(n)}this.$log.info("[FileStorageService] retrieveFilesReceivedFromPeer success"),n(t)}).catch(e=>{let t=this.errorHelperService.handleError(e,"retrieveFilesReceivedFromPeer");this.$log.error("[FileStorageService] "+t.message),r(t)})})}retrieveSentFiles(e){return this.$log.info("[FileStorageService] >retrieveSentFiles"),this.$q((t,n)=>{this.$http({method:"GET",url:this.portalURL+"?format=full&viewerId="+e,headers:this.authService.getRequestHeader()}).then(e=>{let n=[],r=e.data.data;if(r)for(let e of r){let t=this.createFileDescriptorFromData(e);"not_uploaded"===t.state?this.$log.warn("[FileStorageService] file "+t.fileName+" not uploaded"):n.push(t)}this.$log.info("[FileStorageService] retrieveSentFiles success"),t(n)}).catch(e=>{let t=this.errorHelperService.handleError(e,"retrieveSentFiles");this.$log.error("[FileStorageService] "+t.message),n(t)})})}retrieveReceivedFilesForRoom(e){return this.$q((t,n)=>{this.$http({method:"GET",url:this.portalURL+"/viewers/"+e+"?format=full",headers:this.authService.getRequestHeader()}).then(e=>{let n=e.data.data,r=[];n?(n.forEach(e=>{if(e.ownerId!==this.contactService.userContact.dbId){e.viewers=[];let t=this.createFileDescriptorFromData(e);r.push(t),this.receivedFileDescriptors.find(t=>t.id===e.id)||this.receivedFileDescriptors.push(t)}}),t(r)):t(r)}).catch(e=>{let t=this.errorHelperService.handleError(e,"retrieveReceivedFilesForRoom");this.$log.error("[FileStorageService] "+t.message),n(t)})})}retrieveReceivedFiles(e){return this.receivedFileDescriptors||(this.receivedFileDescriptors=[]),this.$q((t,n)=>{this.$http({method:"GET",url:this.portalURL+"/viewers/"+e+"?format=full&limit=1000",headers:this.authService.getRequestHeader()}).then(n=>{this.receivedFileDescriptors=[];let r=n.data.data;if(!r)return void t();let i=n.data.limit,a=n.data.total,o=null;if(a<=i)o=this.$q.resolve([]);else{let t=i,n=[];for(let r=1;r<a/i;r++)n.push(this.retrieveReceivedFilesWithOffset(e,t,i)),t+=i;o=this.$q.all(n)}o.then(e=>{e.forEach(e=>{r=r.concat(e)});for(let e of r){let t=this.createFileDescriptorFromData(e);if(t.ownerId!==this.contactService.userContact.dbId){let e=this.getFileDescriptorById(t.id);e&&(t.previewBlob=e.previewBlob),this.receivedFileDescriptors.push(t)}}this.orderReceivedDocuments(),this.$log.info("[FileStorageService] retrieveReceivedFiles -- success"),t(this.receivedFileDescriptors)})}).catch(e=>{let t=this.errorHelperService.handleError(e,"retrieveReceivedFiles");this.$log.error("[FileStorageService] "+t.message),n(t)})})}retrieveReceivedFilesWithOffset(e,t,n){return this.$q(r=>{this.$http({method:"GET",url:this.portalURL+"/viewers/"+e+"?format=full&limit="+n+"&offset="+t,headers:this.authService.getRequestHeader()}).then(e=>{r(e.data.data)})})}retrieveUserConsumption(){return this.$q((e,t)=>{this.$http({method:"GET",url:config.restServerUrl+"/api/rainbow/filestorage/v1.0/users/consumption",headers:this.authService.getRequestHeader()}).then(t=>{this.consumptionData=t.data.data,this.$log.info("[FileStorageService] retrieveUserConsumption success"),this.$rootScope.$broadcast("ON_CONSUMPTION_DATA_UPDATED_EVENT"),e(this.consumptionData)}).catch(e=>{let n=this.errorHelperService.handleError(e,"retrieveUserConsumption");this.$log.error("[FileStorageService] "+n.message),t(n)})})}deleteFileViewer(e,t){return this.$q((n,r)=>{this.$http({method:"DELETE",url:this.portalURL+"/"+t+"/viewers/"+e,headers:this.authService.getRequestHeader()}).then(r=>{this.$log.info("[FileStorageService] deleteFileViewer "+r.statusText);let i=this.getFileDescriptorById(t);if(i){let t=-1;for(let n=0;n<i.viewers.length;n++)if(i.viewers[n].viewerId===e){t=n;break}-1!==t&&i.viewers.splice(t,1)}n()},e=>{let t=this.errorHelperService.handleError(e,"deleteFileViewer");r(t),this.$log.error("[FileStorageService] "+t.message)})})}addFileViewer(e,t,n){let r=this.getFileDescriptorById(e);return r&&r.isAlreadyFileViewer(t)?this.$q.resolve(r):this.$q((r,i)=>{this.$http({method:"POST",url:this.portalURL+"/"+e+"/viewers",headers:this.authService.getRequestHeader(),data:{viewerId:t,type:n}}).then(n=>{this.$log.info("[FileStorageService] addFileViewer success");let a=this.getFileDescriptorById(e);if(a){var o=this.fileViewerFactory([{viewerId:n.data.data.viewerId,type:n.data.data.type}])[0];"user"===o.type?this.contactService.getContactByDBId(t).then(e=>{o.contact=e,a.viewers.push(o),r(a)}).catch(e=>{this.$log.error("[FileStorageService] "+e),i(e)}):(a.viewers.push(o),r(a))}},e=>{const t=this.errorHelperService.handleError(e,"addFileViewer");i(t),this.$log.error("[FileStorageService] "+t.message)})})}copyFileToUserCloudStorage(e){return this.$q((t,n)=>{this.$http({method:"POST",url:this.portalURL+"/"+e+"/copy",headers:this.authService.getRequestHeader()}).then(r=>{this.$log.info("[FileStorageService] copyFileToUserCloudStorage | copyFile "+e+" -- success"),this.retrieveAndStoreOneFileDescriptor(r.data.data.id,!0).then(e=>{t(e)}).catch(e=>{n(e)})}).catch(e=>{let t=this.errorHelperService.handleError(e,"copyFileToUserCloudStorage");this.$log.error("[FileStorageService] copyFileToUserCloudStorage "+t.message),n(t)})})}retrieveOneFileDescriptor(e){return this.$q((t,n)=>{this.$http({method:"GET",url:this.portalURL+"/"+e+"?format=full",headers:this.authService.getRequestHeader()}).then(n=>{let r=this.createFileDescriptorFromData(n.data.data);this.$log.info("[FileStorageService] getOneFileDescriptor "+e+" -- success"),t(r)}).catch(e=>{let t=this.errorHelperService.handleError(e,"getOneFileDescriptor");this.$log.error("[FileStorageService] "+t.message),n(t)})})}retrieveAndStoreOneFileDescriptor(e,t){let n=this.getFileDescriptorById(e);return n&&!t?(this.$log.info("[FileStorageService] retrieveAndStoreOneFileDescriptor -- return existing fileDescriptor "+e),this.$q.resolve(n)):this.retrieveOneFileDescriptor(e).then(e=>{n&&n.isImage()&&(e.previewBlob=n.previewBlob);let t=this.helpersService.findIndex(this.fileDescriptors,t=>t.id===e.id);-1<t&&this.fileDescriptors.splice(t,1);let r=this.helpersService.findIndex(this.receivedFileDescriptors,t=>t.id===e.id);return-1<r&&this.receivedFileDescriptors.splice(r,1),e.ownerId===this.contactService.userContact.dbId?(this.fileDescriptors.push(e),this.$log.info("[FileStorageService] retrieveAndStoreOneFileDescriptor -- fileDescriptor "+e.id+" -- now stored in my files")):(this.receivedFileDescriptors.push(e),this.$log.info("[FileStorageService] retrieveAndStoreOneFileDescriptor -- fileDescriptor "+e.id+" -- now stored in received files"),this.$rootScope.$broadcast("ON_MESSAGE_WITH_FILE_RECEIVED_EVENT")),this.orderDocuments(),this.$rootScope.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:e.id}),this.$q.resolve(e)}).catch(e=>{this.$log.warn("[FileStorageService] Error on getting FileDescriptor: "+e.errorDetailsCode);let t=this.errorHelperService.handleError(e,"retrieveAndStoreOneFileDescriptor");return 400<=t.status&&500>t.status&&n&&(404===t.status&&this.deleteFileDescriptorFromCache(n.id,!0),this.orderDocuments(),this.$log.debug("[FileStorageService] Sending ON_FILE_REMOVED_FROM_STORE_EVENT"),this.$rootScope.$broadcast("ON_FILE_REMOVED_FROM_STORE_EVENT",{fileId:n.id})),this.$q.reject(e)})}deleteFileDescriptorFromCache(e,t){this.$log.info("[FileStorageService] deleteFileDescriptorFromCache "+e);for(let t=0;t<this.receivedFileDescriptors.length;t++)if(this.receivedFileDescriptors[t].id===e){this.receivedFileDescriptors.splice(t,1);break}for(let n=0;n<this.fileDescriptors.length;n++)if(this.fileDescriptors[n].id===e){t?this.fileDescriptors.splice(n,1):this.fileDescriptors[n].state="deleted";break}this.orderDocuments()}deleteAllFilesDescriptorsFromCache(){this.$log.info("[FileStorageService] deleteAllFilesDesceiptorsFromCache"),this.fileDescriptors.forEach(e=>{e.state="deleted",this.receivedFileDescriptors.forEach((t,n)=>{t.id===e.id&&this.receivedFileDescriptors.splice(n,1)})}),this.fileDescriptors=[],this.orderDocuments()}orderDocuments(){this.$log.debug("[FileStorageService] orderDocuments: "+this.fileDescriptors.length),this.replaceOrderedByFilter(this.fileDescriptorsByDate,this.fileDescriptors,this.getDate,!1,this.sortByDate),this.replaceOrderedByFilter(this.fileDescriptorsByName,this.fileDescriptors,this.getName,!1,this.sortByName),this.replaceOrderedByFilter(this.fileDescriptorsBySize,this.fileDescriptors,this.getSize,!1,this.sortBySize),this.orderReceivedDocuments()}orderReceivedDocuments(){this.$log.debug("[FileStorageService] orderReceivedDocuments: "+this.receivedFileDescriptors.length),this.replaceOrderedByFilter(this.receivedFileDescriptorsByName,this.receivedFileDescriptors,this.getName,!1,this.sortByName),this.replaceOrderedByFilter(this.receivedFileDescriptorsByDate,this.receivedFileDescriptors,this.getDate,!1,this.sortByDate),this.replaceOrderedByFilter(this.receivedFileDescriptorsBySize,this.receivedFileDescriptors,this.getSize,!1,this.sortBySize)}orderDocumentsForRoom(e){return this.orderByFilter(e,this.getDate,!1,this.sortByDate)}replaceOrderedByFilter(e,t,n,r,i){this.$log.debug("[FileStorageService] replaceOrderedByFilter"),e.length=0;let a=this.orderByFilter(t,n,r,i);for(let t of a)"deleted"!==t.state&&e.push(t)}getName(e){let t,n={name:"",date:""};return e.fileName&&(n.name=e.fileName),t=e.uploadedDate?new Date(e.uploadedDate):e.registrationDate?new Date(e.registrationDate):new Date(e.dateToSort),n.date=t.getTime(),n}getDate(e){let t;return(t=e.uploadedDate?new Date(e.uploadedDate):e.registrationDate?new Date(e.registrationDate):new Date(e.dateToSort)).getTime()}getSize(e){let t={name:"",size:""};return e.name&&(t.name=e.fileName),t.size=e.size,t}sortByName(e,t){let n=-1;return e.value.name&&t.value.name&&(0===(n=e.value.name.localeCompare(t.value.name))&&(n=t.value.date-e.value.date)),n}sortBySize(e,t){let n=-1;return e.value.size&&t.value.size&&(n=t.value.size-e.value.size),n}sortByDate(e,t){let n=1;return e&&t&&(n=t.value-e.value),n}extractFileIdFromUrl(e){let t=e.split("/");return t.pop()||t.pop()}}e.$inject=["$injector","$q","$http","$log","$rootScope","authService","fileViewerFactory","errorHelperService","orderByFilter","contactService","helpersService","fileViewerElementFactory","fileDescriptorFactory"],angular.module("rainbow").service("fileStorageService",e)},function(){angular.module("rainbow").factory("FileDescriptorEventHandler",["$log","$rootScope","contactService",function(e,t,n){"use strict";function r(r){var i=this;this.fileServerService=r,this.fileStorageService=r.getFileStorageService(),i.onManagementMessageReceived=function(t){try{var n=$(t);return 0<n.find("file").length?this.manageFileStanzaData(n.find("file")):0<n.find("thumbnail").length?this.manageThumbnailStanzaData(n.find("thumbnail")):e.info("[FileDescriptorEventHandler] onManagementMessageReceived  -- ignore the message"),!0}catch(t){return e.error("[FileDescriptorEventHandler] onManagementMessageReceived ERROR "+t),!0}},i.manageFileStanzaData=function(r){for(var a=$(r).attr("action"),o=$(r).find("fileid"),s=!1,c=0;c<o.length;c++){var l=$(o[c]).text(),d=this.fileStorageService.getFileDescriptorById(l);switch(e.info("[FileDescriptorEventHandler] manageFileStanzaData -- "+a+" fileDescriptor "+l),a){case"create":e.debug("[FileDescriptorEventHandler] fileDescriptor "+l+" created on server -- do nothing");break;case"delete":d&&(d.ownerId===n.userContact.dbId&&"deleted"!==d.state&&(s=!0),this.fileStorageService.deleteFileDescriptorFromCache(l),t.$broadcast("ON_FILE_REMOVED_FROM_STORE_EVENT",{fileId:l}));break;case"update":d||(s=!0),i.fileStorageService.retrieveAndStoreOneFileDescriptor(l,!0).then(function(t){e.info("[FileDescriptorEventHandler] fileDescriptor retrieved"),t.previewBlob||i.fileServerService.getBlobThumbnailFromFileDescriptor(t).then(function(e){t.previewBlob=e})})}}s&&this.fileStorageService.retrieveUserConsumption()},i.manageThumbnailStanzaData=function(n){var r=$(n).attr("action"),i=$(n).find("fileid").text(),a=$(n).find("url").text(),o=$(n).find("mime").text(),s=$(n).find("filename").text(),c=$(n).find("size").text(),l=$(n).find("md5sum").text();if(e.info("[FileDescriptorEventHandler] manageThumbnailStanzaData -- "+r+" fileDescriptor "+i),e.debug("[FileDescriptorEventHandler]   fileUrl="+a),e.debug("[FileDescriptorEventHandler]   fileMime="+o),e.debug("[FileDescriptorEventHandler]   fileName="+s),e.debug("[FileDescriptorEventHandler]   fileSize="+c),e.debug("[FileDescriptorEventHandler]   md5sum="+l),e.debug("[FileDescriptorEventHandler]   fileId="+i),"create"===r||"update"===r){var d=this.fileStorageService.getFileDescriptorById(i);d?(e.debug("[FileDescriptorEventHandler] updating Thumbnail of found FileDescriptor "+i),d.previewBlob&&!d.thumbnail.availableThumbnail||!d.previewBlob?(t.$broadcast("ON_FILE_DESCRIPTOR_THUMBNAIL_READY",d.id),d.thumbnail.availableThumbnail=!0,d.thumbnail.md5sum=l,d.thumbnail.size=c,e.info("[FileDescriptorEventHandler] preview not already downloaded for "+i+" -- download it"),this.fileServerService.getBlobThumbnailFromFileDescriptor(d).then(function(){t.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:d.id})})):(t.$broadcast("ON_FILE_DESCRIPTOR_THUMBNAIL_READY",d.id),e.info("[FileDescriptorEventHandler] preview already downloaded for "+i+" -- do nothing"))):e.error("[FileDescriptorEventHandler] FileDescriptor not found and we do nothing and its not OK")}}}return r.create=function(e){return new r(e)},r}])},function(){angular.module("rainbow").service("extensionSharingService",["$q","$log","$rootScope",function(e,t,n){"use strict";var r=this;this.extensionFound=!1,this.minVersion="1.5.1",this.port=null,this.currentStreamId="screen",this.start=function(){this.extensionId=this.extensionId||this.getExtensionId(config.webservices.server);var i=e.defer();return t.info("[extensionService] === STARTING ==="),window.chrome&&window.chrome.runtime?(t.info("[extensionService] Chrome extension - try to ping...",this.extensionId),chrome.runtime.sendMessage(this.extensionId,{type:"ping",data:null},null,function(e){e&&"pong"===e.type?(t.info("[extensionService] Chrome extension - pong received"),t.info("[extensionService] Chrome extension - extension installed and detected"),t.info("[extensionService] Chrome extension - try to connect..."),r.port=chrome.runtime.connect(r.extensionId),r.port?(t.info("[extensionService] Chrome extension - port created"),r.port.onDisconnect.addListener(function(){t.info("Extension DISCONNECTED"),r.extensionFound=!1,r.port=null}),r.port.onMessage.addListener(function(e){switch(t.info("[extensionService] Chrome extension - connected"),e.type){case"loginResponse":r.extensionFound=!0,t.info("[extensionService] Chrome extension - ready!"),t.info("[extensionService] === STARTED ==="),n.$broadcast("ON_EXTENSION_SHARING_READY"),i.resolve();break;case"getVersionResponse":0===e.code&&e.version?(n.$broadcast("ON_EXTENSION_VERSION_UPDATED",e.version),t.info("[extensionService] Chrome extension - Detected version "+e.version)):(n.$broadcast("ON_EXTENSION_VERSION_UPDATED",null),t.error("[extensionService] Chrome extension - No version received"));break;case"startsharingResponse":0===e.code&&e.streamID?(t.info("[extensionService] Chrome extension - stream ID received "+e.streamID),n.$broadcast("ON_EXTENSION_SHARING_STREAM_FOUND",e.streamID)):(t.info("[extensionService] Chrome extension - No stream ID received"),n.$broadcast("ON_EXTENSION_SHARING_STREAM_FOUND",null));break;case"endsharingResponse":t.info("[extensionService] Chrome extension - end sharing session received")}}),r.port.postMessage({type:"login",data:null})):(t.info("[extensionService] Chrome extension - can't create port to contact the extension!!!"),t.info("[extensionService] === STARTED ==="),i.resolve())):(t.info("[extensionService] Chrome extension - not found"),chrome.runtime.lastError&&t.info("[extensionService] Chrome extension - error "+chrome.runtime.lastError),i.resolve())})):(t.info("[extensionService] Not in chrome"),t.info("[extensionService] === STARTED ==="),i.resolve()),i.promise},this.stop=function(){return t.info("[extensionService] === STOPPING ==="),t.info("[extensionService] === STOPPED ==="),e.when()},this.getExtensionId=function(e){return t.info("Detected domain : "+e),-1!==e.indexOf("openrainbow.net")?"koefhabbjedbiecnldkolbijjfjinogj":-1===e.indexOf("openrainbow.org")?-1===e.indexOf("openrainbow.com")?(t.error("Unkown domain, extension may not be available"),"mgneongoclkopahpapenfhbbeckhdmnj"):"mgneongoclkopahpapenfhbbeckhdmnj":"ehamhlkmecdnidihfedapmplddlbidee"},this.setExtensionId=function(e){t.info("set extensionId to : "+e),this.extensionId=e},this.getStreamToShareFromExtension=function(t){var i=e.defer(),a=n.$on("ON_EXTENSION_SHARING_STREAM_FOUND",function(e,n){r.currentStreamId=n,a(),n?(t.video.mandatory.chromeMediaSourceId=n,i.resolve()):i.reject()});return this.port.postMessage({type:"startsharing",data:null}),i.promise},this.getStreamId=function(){return this.currentStreamId},this.isExtensionInstalled=function(){var t=e.defer();return this.extensionFound?t.resolve(!0):this.start().then(function(){t.resolve(r.extensionFound)}),t.promise},this.getExtensionVersion=function(){var t=e.defer(),r=n.$on("ON_EXTENSION_VERSION_UPDATED",function(e,n){r(),n?t.resolve(n):t.reject()});return this.port.postMessage({type:"getVersion",data:null}),t.promise},this.checkExtensionStatus=function(){var t=e.defer();return"chrome"===adapter.default.browserDetails.browser?this.isExtensionInstalled().then(function(e){e?r.checkVersion().then(function(e){e?t.resolve("good"):t.resolve("needUpdate")}):t.resolve("notInstalled")}):t.resolve("notNeeded"),t.promise},this.checkVersion=function(){var t=e.defer();return this.getExtensionVersion().then(function(e){t.resolve(0<=r.cmpVersions(e,r.minVersion))}),t.promise},this.cmpVersions=function(e,t){var n,r,i=/(\.0+)+$/,a=e.replace(i,"").split("."),o=t.replace(i,"").split("."),s=Math.min(a.length,o.length);for(n=0;n<s;n++)if(r=parseInt(a[n],10)-parseInt(o[n],10))return r;return a.length-o.length}}])},function(){class e{constructor(e,t,n,r,i,a,o,s,c,l,d,u,h,f){this.$q=e,this.$rootScope=t,this.$log=n,this.$http=r,this.authService=i,this.errorHelperService=a,this.ConferenceSession=o,this.profileService=s,this.xmppService=c,this.countryService=l,this.Conference=d,this.contactService=u,this.$translate=h,this.conferenceUserFactory=f,this.MEDIATYPE={PSTNAUDIO:"pstnAudio",WEBRTC:"webrtc",WEBRTCSHARINGONLY:"webrtcSharingOnly"},this.started=!1,this.conferenceProvisionRef=null,this.isPstnConferenceAvailable=!1,this.conferenceSessions={},this.pstnConferenceEndpoints={},this.pstnConferenceUser=null,this.pstnInstantConferenceEndpoint=null,this.pstnConferencePhoneNumbers=null}start(e){return this.$q(t=>{let n=performance.now();this.$log.info("[PstnConferenceService] === STARTING ==="),this.isPstnConferenceAvailable=!1,this.conferenceSessions={},this.pstnConferenceEndpoints={},this.pstnConferenceUser=null,this.pstnInstantConferenceEndpoint=null,this.pstnConferencePhoneNumbers=null,this.confProvPortalURL=config.restServerUrl+"/api/rainbow/confprovisioning/v1.0/",this.confPortalURL=config.restServerUrl+"/api/rainbow/conference/v1.0/conferences/",this.started=!0;let r=Math.round(performance.now()-n);e.push({service:"pstnConferenceService",startDuration:r}),this.$log.info("[PstnConferenceService] === STARTED ("+r+" ms) ==="),t()})}stop(){return this.$q(e=>{this.$log.info(""),this.$log.info("[PstnConferenceService] === STOPPING ==="),this.started=!1,this.$log.info("[PstnConferenceService] === STOPPED ==="),e()})}updateConference(e,t){return this.$log.info("[PstnConferenceService] updateConference"),this.$q((n,r)=>{e?this.$http({method:"PUT",url:this.confProvPortalURL+"conferences/"+e,headers:this.authService.getRequestHeader(),data:t}).then(e=>{let t=e.data.data,r=this.Conference.createFromData(t);t.hasOwnProperty("id")&&(this.pstnConferenceEndpoints[t.id]&&delete this.pstnConferenceEndpoints[t.id],this.pstnConferenceEndpoints[t.id]=r,!t.scheduled&&(delete this.pstnInstantConferenceEndpoint,this.pstnInstantConferenceEndpoint=r)),this.$log.info("[PstnConferenceService] updateConference successfully"),n(r)},e=>{let t="updateConference failure: "+(e.data?e.data.errorDetails:e.data);this.$log.error("[PstnConferenceService] "+t),r(new Error(t))}):(this.$log.error("[PstnConferenceService] updateConference failure : No confEndpoint"),r(new Error("updateConference failure: No confEndpoint")))})}retrieveConferenceUser(e){return this.$log.info("[PstnConferenceService] retrieveConferenceUser"),e?this.pstnConferenceUser?this.$q.resolve(this.pstnConferenceUser):this.$q((t,n)=>{this.$http({method:"GET",url:this.confProvPortalURL+"users?userId="+e,headers:this.authService.getRequestHeader()}).then(e=>{let r=e.data.data;r&&r.length?(this.pstnConferenceUser=this.conferenceUserFactory(r[0]),this.$log.info("[PstnConferenceService] retrieveConferenceUser successfully"),t(this.pstnConferenceUser)):(this.$log.warn("[PstnConferenceService] retrieveConferenceUser no ConferenceUser found"),n())},e=>{let t="retrieveConferenceUser failure: "+(e.data?e.data.errorDetails:e.data);this.$log.error("[PstnConferenceService] "+t),n(new Error(t))})}):(this.$log.warn("[PstnConferenceService] retrieveConferenceUser missing userId"),this.$q.reject())}retrievePstnConferences(e,t){return this.$log.info("[PstnConferenceService] retrievePstnConferences with scheduled="+e),this.$q((n,r)=>{if(!this.isPstnConferenceAvailable)return this.$log.warn("[PstnConferenceService] retrieveConference - user is not allowed"),void r(new Error("notAllowed"));let i="?format=full&userId="+this.contactService.userContact.dbId+"&mediaType="+this.MEDIATYPE.PSTNAUDIO;angular.isDefined(e)&&(i+="&scheduled="+e),t&&(i+="&provisioning=true"),this.$http({method:"GET",url:this.confProvPortalURL+"conferences"+i,headers:this.authService.getRequestHeader()}).then(e=>{let t=e.data.data;for(let e of t)this.updateOrCreatePstnConferenceEndpoint(e);this.$log.info("[PstnConferenceService] retrievePstnConferences successfully"),n(t)},e=>{let t="retrievePstnConferences failure: "+(e.data?e.data.errorDetails:e.data);this.$log.error("[PstnConferenceService] "+t),r(new Error(t))})})}updateOrCreateConferenceSession(e,t){if(this.$log.debug("[PstnConferenceService] updateOrCreateConferenceSession for "+e),!e||!t||!t.data)return this.$log.error("[PstnConferenceService] updateOrCreateConferenceSession - Not enough data"),null;let n=this.conferenceSessions[e];return n?t.data.active!==n.active&&(this.$log.debug("active"),n.updateActiveState(t.data.active),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",n)):(this.$log.debug("[PstnConferenceService] updateOrCreateConferenceSession - create new conferencesession with id "+e+"and data: \n"+JSON.stringify(t.data)),n=this.ConferenceSession.createFromData(e,[],t.data.active,this.MEDIATYPE.PSTNAUDIO),this.conferenceSessions[e]=n,this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",n)),t.data.participants&&(this.$log.debug("[PstnConferenceService] updateOrCreateConferenceSession - update participants for "+e+" with:\n"+JSON.stringify(t.data.participants)),n.updateParticipants(t.data.participants).then(()=>{this.$rootScope.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",n)})),n}updateOrCreatePstnConferenceEndpoint(e){if(this.$log.info("[PstnConferenceService] updateOrCreatePstnConferenceEndpoint for "+e.id),!e)return this.$log.error("[PstnConferenceService] updateOrCreatePstnConferenceEndpoint - no conference data !"),null;if(e.mediaType!==this.MEDIATYPE.PSTNAUDIO)return this.$log.error("[PstnConferenceService] updateOrCreatePstnConferenceEndpoint - wrong mediaType:"+e.mediaType),null;let t=this.Conference.createFromData(e);return this.pstnConferenceEndpoints[e.id]=t,t.scheduled||(this.pstnInstantConferenceEndpoint=t,!this.pstnInstantConferenceEndpoint.name&&this.updateConference(this.pstnInstantConferenceEndpoint.id,{name:this.$translate.instant("namePersonalConference",{name:this.contactService.userContact.displayName})})),this.pstnConferenceEndpoints[e.id]}formatPstnPhoneNumbers(e){this.$log.info("[PstnConferenceService] formatPstnPhoneNumbers");let t={};return e.forEach(e=>{if(e.locationcode){let n=this.countryService.getAlpha2Code(e.locationcode.substr(0,3));n&&!t[n]&&(t[n]={numbersList:[]}),t[n].numbersList.push({number:e.number,locationName:e.location,city:e.location.split(", ")[1],numberType:e.numberType,needLanguageSelection:e.needLanguageSelection})}}),t}retrievePstnPhoneNumbers(e){return this.$log.info("[ConferenceService] retrievePstnPhoneNumbers"),this.pstnConferencePhoneNumbers?e?this.$q.resolve(this.formatPstnPhoneNumbers(this.pstnConferencePhoneNumbers)):this.$q.resolve(this.pstnConferencePhoneNumbers):this.$q((t,n)=>{this.$http({method:"GET",url:this.confProvPortalURL+"conferences/audio/phonenumbers?shortList=false",headers:this.authService.getRequestHeader()}).then(n=>{this.$log.info("[PstnConferenceService] retrievePstnPhoneNumbers successfully"),this.pstnConferencePhoneNumbers=n.data.data.phoneNumberList,t(e?this.formatPstnPhoneNumbers(this.pstnConferencePhoneNumbers):this.pstnConferencePhoneNumbers)},e=>{let t="retrievePstnPhoneNumbers failure: "+(e.data?e.data.errorDetails:e.data);this.$log.error("[PstnConferenceService] "+t),n(new Error(t))})})}retrievePstnInstantConference(){return this.isPstnConferenceAvailable?this.retrievePstnConferences(!1).then(e=>(e.forEach(t=>{if(t.hasOwnProperty("id")){let n=this.Conference.createFromData(t);n.mediaType!==this.MEDIATYPE.PSTNAUDIO||n.userId!==this.contactService.userContact.dbId||n.scheduled||(this.pstnConferenceEndpoints[e.id]=n,this.pstnInstantConferenceEndpoint=n,!this.pstnInstantConferenceEndpoint.name&&this.updateConference(this.pstnInstantConferenceEndpoint.id,{name:this.$translate.instant("namePersonalConference",{name:this.contactService.userContact.displayName})}))}}),!this.pstnInstantConferenceEndpoint&&this.isPstnConferenceAvailable&&(this.$log.info("[PstnConferenceService] User has no instant conference : we create a new one"),this.retrieveConferenceUser(this.contactService.userContact.dbId).then(e=>{this.createInstantConference(e.id,"instantConference").then(e=>{this.pstnInstantConferenceEndpoint=e})})),this.$q.resolve()),()=>(this.$log.warn("[PstnConferenceService] retrievePstnInstantConference - issue retrieving instant conference"),this.$q.resolve())):(this.$log.info("[PstnConferenceService] retrievePstnInstantConference -- No conference rights"),this.$q.resolve())}createInstantConference(e,t=""){return this.$q((n,r)=>{this.$log.info("[PstnConferenceService] createInstantConference"),this.$http({method:"POST",url:this.confProvPortalURL+"conferences",headers:this.authService.getRequestHeader(),data:{confUserId:e,name:t}}).then(e=>{let t=e.data.data,r=this.Conference.createFromData(t);t.hasOwnProperty("id")&&(this.pstnConferenceEndpoints[t.id]=r),this.$log.info("[PstnConferenceService] createInstantConference successfully"),n(r)},e=>{let t="createInstantConference failure: "+(e.data?e.data.errorDetails:e.data);this.$log.error("[PstnConferenceService] "+t),r(new Error(t))})})}getConferenceSessionById(e){return this.conferenceSessions[e]}getConferenceSessionForRoom(e){let t=null;if(e&&e.length)for(let n=0;n<e.length;n++)e[n].mediaType===this.MEDIATYPE.PSTNAUDIO&&(t=this.conferenceSessions[e[n].confEndpointId]);return t}removeConferenceSession(e){e&&delete this.conferenceSessions[e]}initiatesCallParticipant(e,t,n,r){return this.$log.info("[PstnConferenceService] initiatesCallParticipant( confId="+e+", PhoneNumber="+t+", role="+n.role+" country = "+r+" )"),e&&t?this.$q((i,a)=>{this.$http({method:"POST",url:this.confPortalURL+e+"/join",headers:this.authService.getPostHeader(),data:{participantPhoneNumber:t,participant:n,country:r}}).then(t=>{let n=t.data.status;this.$log.info("[PstnConferenceService] initiatesCallParticipant( confId="+e+") success : "+n),i()},t=>{let n=t.data?t.data.errorDetails:t.data,r="initiatesCallParticipant( confId="+e+") failure: "+n;this.$log.error("[PstnConferenceService] "+r),a(new Error(r))})}):(this.$log.error("[PstnConferenceService] initiatesCallParticipant - missing parameter"),this.$q.reject())}initiatesAudio(e){return this.$log.info("[PstnConferenceService] initiatesAudio( confId="+e+")"),e?this.conferenceSessions[e]&&this.conferenceSessions[e].isActive()?(this.$log.info("[PstnConferenceService] initiatesAudio : conference already started"),this.$q.resolve()):this.$q((t,n)=>{this.$http({method:"PUT",url:this.confPortalURL+e+"/start",headers:this.authService.getRequestHeader()}).then(()=>{this.$log.info("[PstnConferenceService] initiatesAudio( confId="+e+") successfully"),t()},e=>{let t=this.errorHelperService.handleError(e);n(t)})}):(this.$log.error("[PstnConferenceService] initiatesAudio - missing parameter"),this.$q.reject())}initiatesAudioRecording(e,t,n,r){return this.$log.info("[PstnConferenceService] initiatesAudioRecording( confId="+e+"participantId="+t+"fileName="+n+"fileExtension="+r+")"),e&&t?this.$q((i,a)=>{this.$http({method:"POST",url:this.confPortalURL+e+"/participants/"+t+"/start-recording",headers:this.authService.getPostHeader(),data:{fileName:n,fileExtension:r}}).then(()=>{this.$log.info("[PstnConferenceService] initiatesAudioRecording( confId="+e+"participantId="+t+") successfully"),i()},n=>{let r=n.data?n.data.errorDetails:n.data,i="initiatesAudioRecording( confId="+e+"participantId="+t+") failure: "+r;this.$log.error("[PstnConferenceService] "+i),a(new Error(i))})}):(this.$log.error("[PstnConferenceService] initiatesAudioRecording - missing parameter"),this.$q.reject())}stopsAudioRecording(e,t){return this.$q((n,r)=>(this.$log.info("[PstnConferenceService] stopsAudioRecording( confId="+e+"participantId="+t+")"),e&&t?void this.$http({method:"POST",url:this.confPortalURL+e+"/participants/"+t+"/stop-recording",headers:this.authService.getPostHeader()}).then(()=>{this.$log.info("[PstnConferenceService] stopsAudioRecording( confId="+e+"participantId="+t+") successfully"),n()},n=>{let i=n.data?n.data.errorDetails:n.data,a="stopsAudioRecording( confId="+e+"participantId="+t+") failure: "+i;this.$log.error("[PstnConferenceService] "+a),r(new Error(a))}):(this.$log.error("[PstnConferenceService] initiatesAudioRecording - missing parameter"),this.$q.reject())))}pausesAudioRecording(e,t){return this.$q((n,r)=>(this.$log.info("[PstnConferenceService] pausesAudioRecording( confId="+e+"participantId="+t+")"),e&&t?void this.$http({method:"POST",url:this.confPortalURL+e+"/participants/"+t+"/pause-recording",headers:this.authService.getPostHeader()}).then(()=>{this.$log.info("[PstnConferenceService] pausesAudioRecording( confId="+e+"participantId="+t+") successfully"),n()},n=>{let i=n.data?n.data.errorDetails:n.data,a="pausesAudioRecording( confId="+e+"participantId="+t+") failure: "+i;this.$log.error("[PstnConferenceService] "+a),r(new Error(a))}):(this.$log.error("[PstnConferenceService] pausesAudioRecording - missing parameter"),this.$q.reject())))}resumesAudioRecording(e,t){return this.$q((n,r)=>(this.$log.info("[PstnConferenceService] resumesAudioRecording( confId="+e+"participantId="+t+")"),e&&t?void this.$http({method:"POST",url:this.confPortalURL+e+"/participants/"+t+"/resume-recording",headers:this.authService.getPostHeader()}).then(()=>{this.$log.info("[PstnConferenceService] resumesAudioRecording( confId="+e+"participantId="+t+") successfully"),n()},n=>{let i=n.data?n.data.errorDetails:n.data,a="resumesAudioRecording( confId="+e+"participantId="+t+") failure: "+i;this.$log.error("[PstnConferenceService] "+a),r(new Error(a))}):(this.$log.error("[PstnConferenceService] resumesAudioRecording - missing parameter"),this.$q.reject())))}makeSnapshotForConfId(e=null){if(!e){let e="[PstnConferenceService] makeSnapshotForConfId - No confId !!";return this.$log.error(e),this.$q.reject(e)}let t=this.conferenceSessions[e];return t&&t.active&&t.haveJoined?(this.$log.debug("[WebConferenceService] makeSnapshotForConfId skipped, already joined"),this.$q.resolve(t)):this.$q((t,n)=>{this.$http({method:"GET",url:this.confPortalURL+e+"/snapshot?mediaType=pstnAudio",headers:this.authService.getRequestHeader()}).then(n=>{this.$log.info("[PstnConferenceService] makeSnapshotForConfId success for confId "+e);let r=n.data;this.updateOrCreateConferenceSession(e,r),t(r.data)}).catch(t=>{this.$log.info("[PstnConferenceService] makeSnapshotForConfId failure for confID "+e),404===t.status?this.$log.error("[PstnConferenceService] makeSnapshotForConfId - confId "+e+" not found on server"):this.$log.error("[PstnConferenceService] makeSnapshotForConfId - inconsistent object on server"),this.conferenceSessions[e]&&this.removeConferenceSession(e),n()})})}refreshConferenceSessions(){return this.$log.info("[PstnConferenceService] refreshConferenceSessions"),this.$q((e,t)=>{let n=[];for(let e in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(e)){let t=this.conferenceSessions[e];n.push(this.makeSnapshotForConfId(t.id))}this.$q.all(n).then(()=>{this.$log.info("[PstnConferenceService] refreshConferenceSessions -- success"),e()}).catch(()=>{this.$log.error("[PstnConferenceService] refreshConferenceSessions -- error -- cleaning up all sessions"),this.removeAllConferenceSessions(),t()})})}getConferenceSessionWithConnId(e){for(let t in this.$log.info("[PstnConferenceService] getConferenceSessionWithConnId with connId : "+e),this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(t)){let n=this.conferenceSessions[t];if(n&&n.callId===e)return n}return null}removeAllConferenceSessions(){for(let e in this.$log.info("[PstnConferenceService] removeAllConferenceSessions"),this.conferenceSessions)this.conferenceSessions.hasOwnProperty(e)&&this.removeConferenceSession(e)}}e.$inject=["$q","$rootScope","$log","$http","authService","errorHelperService","ConferenceSession","profileService","xmppService","countryService","Conference","contactService","$translate","conferenceUserFactory"],angular.module("rainbow").service("pstnConferenceService",e)},function(){class e{constructor(e,t,n,r,i,a,o,s,c,l,d,u,h,f,p,m){this.$q=e,this.$rootScope=t,this.$log=n,this.$http=r,this.uuid4=i,this.$interval=a,this.authService=o,this.xmppService=s,this.videoService=c,this.roomService=l,this.errorHelperService=d,this.ConferenceSession=u,this.contactService=h,this.platformService=f,this.Conference=p,this.profileService=m,this.MEDIATYPE={WEBRTC:"webrtc",WEBRTCSHARINGONLY:"webrtcSharingOnly"},this.started=!1,this.webConferenceRoom=null,this.webrtcConferenceId=null,this.webrtcSharingOnlyRoom=null,this.webrtcSharingOnlyConferenceId=null,this.jingleJid=null,this.makingCall=!1,this.connected=!1,this.disconnecting=!1,this.reconnecting=!1,this.audioProfileChanging=!1,this.conferenceEndpoints={},this.attachLocalMediaStream=((e,t)=>{if(e){if(t.hasLocalVideo){let e=t.sessions[t.localVideoSessionId];if(e){let n=t.localStreams[e.localStreamId];this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#conferenceVideoPip"),n,e.sid),this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#conferenceVideoPipSmall"),n,e.sid)}}if(t.hasLocalSharing){let e=t.sessions[t.localSharingSessionId];if(e){let n=t.localStreams[e.localStreamId];this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#conferenceSharingPip"),n,e.sid)}}}else this.videoService.RTC.clearMediaStream(angular.element("#minivideo"),null)})}start(e){return this.$q(t=>{let n=performance.now();this.$log.info("[WebConferenceService] === STARTING ==="),this.confProvPortalURL=config.restServerUrl+"/api/rainbow/confprovisioning/v1.0/",this.confPortalURL=config.restServerUrl+"/api/rainbow/conference/v1.0/conferences/",this.conferenceEndpoints={},this.conferenceSessions={},this.listeners=[],this.statsIntervals=[],this.connected=!0,this.disconnecting=!1,this.webConferenceRoom=null,this.webrtcConferenceId=null,this.webrtcSharingOnlyRoom=null,this.webrtcSharingOnlyConferenceId=null,this.jingleJid=null,this.makingCall=!1,this.videoGalleryElements=[],this.attachHandlers(),this.videoGalleryElementsNumber=4,this.started=!0;let r=Math.round(performance.now()-n);e.push({service:"WebConferenceService",startDuration:r}),this.$log.info("[WebConferenceService] === STARTED ("+r+" ms) ==="),t()})}stop(){return this.$log.info("[WebConferenceService] === STOPPING ==="),this.started=!1,this.makingCall=!1,this.listeners&&this.listeners.forEach(e=>{e()}),this.$log.info("[WebConferenceService] === STOPPED ==="),this.$q.when()}attachHandlers(){this.listeners.push(this.$rootScope.$on("ON_INPUT_DEVICE_CHANGED_EVENT",()=>{this.onAudioProfileChangeEvent()})),this.listeners.push(this.$rootScope.$on("ON_CONNECTION_STATE_CHANGE_EVENT",(e,t)=>{this.$log.info("[WebConferenceService] onConnectionStateChangeEvent : "+t);try{if("disconnected"===t)this.$log.info("[WebConferenceService] onConnectionStateChangeEvent : disconnected"),this.connected=!1;else if("connected"===t)for(let e in this.$log.info("[WebConferenceService] onConnectionStateChangeEvent : connected"),this.connected=!0,this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(e)){let t=this.conferenceSessions[e];if("reconnecting"===t.status)for(let e in t.sessions)if(t.sessions.hasOwnProperty(e)){let n=t.sessions[e];"audio"===n.localType&&this.sendTransportReplaceForSession(n,1e4)}}}catch(e){this.$log.info("[WebConferenceService] onConnectionStateChangeEvent error : "+e)}}))}retrieveWebConferences(e=this.MEDIATYPE.WEBRTC){return this.$log.info("[WebConferenceService] retrieveWebConferences with mediaType="+e),this.$q((t,n)=>{if(!this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.WEBRTC_CONFERENCE_ALLOWED)&&e!==this.MEDIATYPE.WEBRTCSHARINGONLY)return this.$log.warn("[WebConferenceService] retrieveWebConferences - user is not allowed"),void n(new Error("notAllowed"));let r="?format=full&userId="+this.contactService.userContact.dbId;angular.isDefined(e)&&(r+="&mediaType="+e),this.$http({method:"GET",url:this.confProvPortalURL+"conferences"+r,headers:this.authService.getRequestHeader()}).then(e=>{let n=e.data.data;this.$log.info("[WebConferenceService] retrieveWebConferences successfully"),t(n)},e=>{let t="retrieveWebConferences failure: "+(e.data?e.data.errorDetails:e.data);this.$log.error("[WebConferenceService] "+t),n(new Error(t))})})}updateConference(e,t){return this.$log.info("[WebConferenceService] updateConference"),this.$q((n,r)=>{e?this.$http({method:"PUT",url:this.confProvPortalURL+"conferences/"+e,headers:this.authService.getRequestHeader(),data:t}).then(e=>{let t=e.data.data,r=this.Conference.createFromData(t);t.hasOwnProperty("id")&&(this.conferenceEndpoints[t.id]&&delete this.conferenceEndpoints[t.id],this.conferenceEndpoints[t.id]=r),this.$log.info("[WebConferenceService] updateConference successfully"),n(r)},e=>{let t="updateConference failure: "+(e.data?e.data.errorDetails:e.data);this.$log.error("[WebConferenceService] "+t),r(new Error(t))}):(this.$log.error("[WebConferenceService] updateConference failure : No confEndpoint"),r(new Error("updateConference failure: No confEndpoint")))})}createVideoGalleryElements(){this.videoGalleryElements=[];for(let e,t=1;t<=this.videoGalleryElementsNumber;t++)e={state:"free",sessionId:"",id:"videoGallery_"+t,publisherId:"",publisherJid:""},this.videoGalleryElements.push(e)}setVideoGalleryElementsNumber(e){this.videoGalleryElementsNumber=e}getConferenceSessions(){return this.conferenceSessions}getConferenceEndpoints(){return this.conferenceEndpoints}addConferenceEndpoint(e,t){return e?void(this.conferenceEndpoints[e]=t):void this.$log.warn("[WebConferenceService] addConferenceEndpoint - missing conferenceEndpointId")}getConferenceIdToUse(e,t=this.MEDIATYPE.WEBRTC){let n=this.getPontConfIdForRoom(e,t);if(n)return n;switch(t){case this.MEDIATYPE.WEBRTC:if(e.isUserModerator(this.contactService.userContact)&&this.webrtcConferenceId)return this.webrtcConferenceId;break;case this.MEDIATYPE.WEBRTCSHARINGONLY:if(e.owner&&this.webrtcSharingOnlyConferenceId)return this.webrtcSharingOnlyConferenceId}return""}isMyConference(e){return e&&(this.webrtcConferenceId&&e===this.webrtcConferenceId||this.webrtcSharingOnlyConferenceId&&e===this.webrtcSharingOnlyConferenceId)}startOrJoinWebConference(e){return this.$q((t,n)=>{if(!e){let e=new Error("[webConferenceService] startOrJoinWebConference error - missing parameters for room");return this.$log.error(e.message),void n(e)}let r=this.getConferenceIdToUse(e,this.MEDIATYPE.WEBRTC);if(!r){let e=new Error("[webConferenceService] startOrJoinWebConference error - no available pont conference");return this.$log.error(e.message),void n(e)}this.makeSnapshotForConfId(r,this.MEDIATYPE.WEBRTC).then(()=>{let i=this.conferenceSessions[r];if(!(this.isMyConference(r)||i&&i.active)){let e=new Error("[webConferenceService] startOrJoinWebConference error - no active conference to join");return this.$log.error(e.message),void n(e)}let a=this.isMyConference(r)?"moderator":"member";return i&&i.active?(this.$rootScope.$broadcast("ON_CONFERENCE_ENDED_INVITATION",e),void t(this.joinWebConference(r,a))):void t(this.startWebConference(e,r))},()=>{let e=new Error("[webConferenceService] startOrJoinWebConference error on snapshot");this.$log.error(e.message),n(e)})})}startOrJoinSharingOnlyConference(e){return this.$q((t,n)=>{if(!e){let e=new Error("[webConferenceService] startOrJoinSharingOnlyConference error - missing parameters for room");return this.$log.error(e.message),void n(e)}let r=this.getConferenceIdToUse(e,this.MEDIATYPE.WEBRTCSHARINGONLY);if(!r){let e=new Error("[webConferenceService] startOrJoinSharingOnlyConference error - no available pont conference");return this.$log.error(e.message),void n(e)}this.makeSnapshotForConfId(r,this.MEDIATYPE.WEBRTCSHARINGONLY).then(()=>{let i=this.conferenceSessions[r];if(!(this.isMyConference(r)||i&&i.active)){let e=new Error("[webConferenceService] startOrJoinSharingOnlyConference error - no active conference to join");return this.$log.error(e.message),void n(e)}let a=this.isMyConference(r)?"moderator":"member";return i&&i.active?(this.$rootScope.$broadcast("ON_CONFERENCE_ENDED_INVITATION",e),void t(this.joinSharingOnlyConference(r,a,!1))):void t(this.startSharingOnlyConference(e,r))},()=>{let e=new Error("[webConferenceService] startOrJoinSharingOnlyConference error on snapshot");this.$log.error(e.message),n(e)})})}startWebConference(e,t,n=!1){return this.makingCall?(this.$log.warn("[webConferenceService] already starting a conference"),this.$q.resolve()):t&&e?(this.makingCall=!0,this.$log.info("[webConferenceService] startWebConference wtih ID "+t),this.$q(e=>{n?(this.$log.debug("[webConferenceService] startWebConference - trigger snapshot for "+t),e(this.makeSnapshotForConfId(t,this.MEDIATYPE.WEBRTC))):e()}).then(()=>this.conferenceSessions[t].active?(this.$log.info("[webConferenceService] startWebConference - No need to start an already active conference"),this.joinWebConference(t,"moderator",!1)):(this.conferenceSessions[t].status="ringing",this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",this.conferenceSessions[t]),this.$http({method:"PUT",url:this.confPortalURL+t+"/start",headers:this.authService.getRequestHeader(),data:{mediaType:this.MEDIATYPE.WEBRTC,roomId:e.dbId}}).then(()=>(this.$log.info("[webConferenceService] startWebConference - success -- now joining the conference"),this.joinWebConference(t,"moderator",!1)),e=>{throw this.makingCall=!1,this.$log.error("[webConferenceService] startWebConference wtih ID "+t+" failure ... -- "+this.errorHelperService.getErrorFullMessage(e)),this.leaveWebConference(t),this.removeConferenceSession(t),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT"),this.errorHelperService.handleError(e)}))).catch(e=>(this.makingCall=!1,this.$log.error("[webConferenceService] startWebConference - error on server, can't start conference"),this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"startConference",popupBody:"startMeetingFailure",okLabel:"ok"}),this.$q.reject(e)))):(this.$log.error("[startWebConference] No webPontConferenceId or Room!"),this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"startConference",popupBody:"startMeetingFailure",okLabel:"ok"}),this.$q.reject())}startSharingOnlyConference(e,t,n=!0){return this.makingCall?(this.$log.warn("[webConferenceService] already starting a conference"),this.$q.resolve()):t&&e?(this.makingCall=!0,this.$log.info("[webConferenceService] startSharingOnlyConference wtih ID "+t),this.makeSnapshotForConfId(t,this.MEDIATYPE.WEBRTCSHARINGONLY).then(()=>{if(this.conferenceSessions[t].active)return this.$log.info("[webConferenceService] startSharingOnlyConference - No need to start an already active conference"),n?this.$q.resolve(this.joinSharingOnlyConference(t,"moderator",!1)):this.$q.resolve();this.conferenceSessions[t].status="ringing",this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",this.conferenceSessions[t]);let r=this.confPortalURL+t+"/start";return this.$q((i,a)=>{this.$http({method:"PUT",url:r,headers:this.authService.getRequestHeader(),data:{mediaType:this.MEDIATYPE.WEBRTCSHARINGONLY,roomId:e.dbId}}).then(()=>n?this.joinSharingOnlyConference(t,"moderator",!1).then(()=>{i()}):void i(),e=>{this.makingCall=!1,this.$log.error("[webConferenceService] startSharingOnlyConference wtih ID "+t+" failure ... -- "+this.errorHelperService.getErrorFullMessage(e)),this.leaveWebConference(t),this.removeConferenceSession(t),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT"),a(this.errorHelperService.handleError(e))})})}).catch(e=>(this.makingCall=!1,this.$log.error("[webConferenceService] startSharingOnlyConference - error on server, can't start conference"),this.$q.reject(e)))):(this.$log.error("[startSharingOnlyConference] No webPontConferenceId or Room!"),this.$q.reject())}joinWebConference(e,t,n=!1){return this.$log.info("[webConferenceService] joinWebConference with ID "+e+" and role "+t),e?this.$q(t=>{n?(this.$log.debug("[webConferenceService] joinWebConference - trigger snapshot for "+e),t(this.makeSnapshotForConfId(e,this.MEDIATYPE.WEBRTC))):t()}).then(()=>this.$q((n,r)=>{this.makingCall=!0,this.createVideoGalleryElements(),this.conferenceSessions[e].videoGallery=this.videoGalleryElements,"ringing"!==this.conferenceSessions[e].status&&(this.conferenceSessions[e].status="ringing",this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",this.conferenceSessions[e]));let i="web_"+this.uuid4.generate(),a=this.confPortalURL+e+"/join",o={participant:{role:t,type:"unmuted"},mediaType:this.MEDIATYPE.WEBRTC};this.getUserMediaForSession(e).then(()=>{this.$http({method:"POST",url:a,headers:this.authService.getRequestHeader(),data:o}).then(t=>{let r=t.data.data;this.jingleJid=r.jingleJid,this.initCall(this.jingleJid,e,i,this.MEDIATYPE.WEBRTC),this.conferenceSessions[e].haveJoined=!0,this.makingCall=!1,n()},t=>{if(t){let n=t.data?t.data.errorDetails:t.data;this.$log.error("[conferenceService] joinWebConference( confId="+e+") failure: "+n)}this.makingCall=!1;let n={popupTitle:"warning",popupBody:"joinMeetingFailure",okLabel:"ok"};t&&t.data&&403615===t.data.errorDetailsCode&&(n.popupBody="maximumNumberConferenceParticipantsReach"),this.leaveWebConference(e),delete this.conferenceSessions[e],this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT"),this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",n),r(this.errorHelperService.handleError(t))})}).catch(t=>{this.$log.error("[webConferenceService] joinWebConference - getUserMediaForSession reject -- "+t),this.makingCall=!1,"ignore"!==t&&this.leaveWebConference(e),r()})})).catch(()=>(this.makingCall=!1,this.$log.error("[webConferenceService] joinWebConference - error on server, can't join conference"),this.$q.reject())):(this.$log.error("[webConferenceService] joinWebConference - No webPontConferenceId !"),this.$q.reject())}joinSharingOnlyConference(e,t,n=!0){return this.$log.info("[webConferenceService] joinSharingOnlyConference with ID "+e+" and role "+t),e?this.$q(t=>{n?(this.$log.debug("[webConferenceService] joinSharingOnlyConference - trigger snapshot for "+e),t(this.makeSnapshotForConfId(e,this.MEDIATYPE.WEBRTCSHARINGONLY))):t()}).then(()=>this.$q((n,r)=>{this.makingCall=!0,this.createVideoGalleryElements(),this.conferenceSessions[e].videoGallery=this.videoGalleryElements,"ringing"!==this.conferenceSessions[e].status&&(this.conferenceSessions[e].status="ringing",this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",this.conferenceSessions[e]));this.uuid4.generate();let i=this.confPortalURL+e+"/join",a={participant:{role:t,type:"muted"},mediaType:this.MEDIATYPE.WEBRTCSHARINGONLY};this.$http({method:"POST",url:i,headers:this.authService.getRequestHeader(),data:a}).then(t=>{let r=t.data.data;this.jingleJid=r.jingleJid,this.$log.info("[webConferenceService] joinSharingOnlyConference with ID success - jingleJid: "+this.jingleJid),this.conferenceSessions[e].jingleJid=this.jingleJid,this.conferenceSessions[e].haveJoined=!0,this.makingCall=!1,n()},t=>{if(t){let n=t.data?t.data.errorDetails:t.data;this.$log.error("[conferenceService] joinSharingOnlyConference( confId="+e+") failure: "+n)}this.makingCall=!1,t&&t.data&&t.data.errorDetailsCode,this.leaveWebConference(e),delete this.conferenceSessions[e],this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT"),r(this.errorHelperService.handleError(t))})})).catch(()=>(this.makingCall=!1,this.$log.error("[webConferenceService] joinSharingOnlyConference - error on server, can't join conference"),this.$q.reject())):(this.$log.error("[webConferenceService] joinSharingOnlyConference - No webPontConferenceId !"),this.$q.reject())}stopWebConference(e){return this.$q((t,n)=>{if(e){let r=e.getSFUConfEndpointId()?e.getSFUConfEndpointId():e.getSFUSharingConfEndpointId(),i=this.confPortalURL+r+"/stop";this.$http({method:"PUT",url:i,headers:this.authService.getRequestHeader(),data:{mediaType:this.MEDIATYPE.WEBRTC,roomId:e.dbId}}).then(()=>{t()},e=>{n(this.errorHelperService.handleError(e))})}else n()})}getFreeVideoGalleryElement(e){this.$log.info("[webConferenceService] getFreeVideoGalleryElement "+e);let t=this.conferenceSessions[e],n=null;if(t){t.videoGallery||(this.createVideoGalleryElements(),t.videoGallery=this.videoGalleryElements);for(let e=0;e<t.videoGallery.length;e++)if("free"===t.videoGallery[e].state){n=t.videoGallery[e];break}}return n}askToAddSharingToConferenceSession(e,t){!this.videoService.askToAddSharing(e.id,"sharing")&&this.addMediaToConferenceSession(t,"sharing")}addMediaToConferenceSession(e,t){if(!e)return;let n=20;"video"!==t&&(n=3),"sharing"===t&&this.contactService.setBusyState("dnd","sharing"),this.$log.info("[webConferenceService] addMediaToConferenceSession to session "+e.id+" with media "+t),this.videoService.getBrowserMedia([t],640,480,n).then(n=>{let r=this.xmppService.connection.jingle.initiate(e.jingleJid,this.xmppService.connection.jid,t,[n],null,e.id);e.sessions[r.sid]=r,e.localStreams.push(n),r.localStreamId=e.localStreams.length-1,"video"===t?(e.hasLocalVideo=!0,e.localVideoSessionId=r.sid):(e.hasLocalSharing=!0,e.localSharingSessionId=r.sid),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",e),this.videoService.callsStats[r.sid]={},this.updateStatisticsForSession(e.id,r.sid),this.statsIntervals.push(r.getStats(5e3))})}removeMediaFromConferenceSession(e,t){if(e){"sharing"===t&&this.contactService.setBusyState("dnd","audio"),"webrtcSharingOnly"===e.type&&this.contactService.resetBusyState(),this.$log.info("[webConferenceService] removeMediaFromConferenceSession from session "+e.id);let n="video"===t?e.localVideoSessionId:e.localSharingSessionId;if(e.sessions[n]){let r=e.sessions[n];this.updateStatisticsForSession(e.id,n),this.videoService.disableAudioVideoMedia(r),this.xmppService.connection.jingle.terminate(r.sid),delete e.sessions[n],delete e.localStreams[r.localStreamId],delete this.videoService.callsStats[n],"video"===t?(e.hasLocalVideo=!1,e.localVideoSessionId=null):(e.hasLocalSharing=!1,e.localSharingSessionId=null)}this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",e)}}dropRemoteVideoSession(e,t){if(e){if(this.$log.info("[webConferenceService] dropRemoteVideoSession fom conference "+e.id+" and session "+t),e.sessions[t]){let n=e.sessions[t];this.updateStatisticsForSession(e.id,t),this.xmppService.connection.jingle.terminate(n.sid),delete e.sessions[t],delete this.videoService.callsStats[t]}this.removeSessionFromVideoGallery(e,t),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",e)}}getUserMediaForSession(e){return this.$q((t,n)=>{let r=this.conferenceSessions[e];r?(r.status="ringing",r.haveJoined=!0,this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",r),this.videoService.getBrowserMedia(["audio"]).then(r=>{this.$log.info("[webConferenceService] getUserMediaForSession -- sucess");let i=this.conferenceSessions[e];return i&&"ended"!==i.status?this.makingCall?(i.localStreams=[r],void t()):(this.$log.info("[webConferenceService] getUserMediaForSession -- already in the conference -- ignore"),this.disableMediaStream(r),void n("ignore")):(this.$log.info("[webConferenceService] getUserMediaForSession -- missing conference"),this.disableMediaStream(r),void n("conference does not exist anymore"))}).catch(()=>{this.$log.error("[webConferenceService] getUserMediaForSession error -- getUserMedia failed"),this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"warning",popupBody:"devicePermission",okLabel:"ok"}),n("failed to get user media")})):n()})}disableMediaStream(e){e&&(e.getTracks().forEach(e=>{e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),e=null)}initCall(e,t,n,r){let i=this.conferenceSessions[t];return this.$q(e=>{i||(this.$log.warn("[webConferenceService] initCall - no conferenceSession as though we are trying to init call"),e(this.makeSnapshotForConfId(t,r))),e()}).then(()=>{let r=this.xmppService.connection.jingle.initiate(e,this.xmppService.connection.jid,"audio",i.localStreams,n,t);i.jingleJid=e,i.sessions[r.sid]=r,i.status="ringing",this.createStatisticsForSession(t,r.sid),this.statsIntervals.push(r.getStats(5e3)),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",i)})}muteAudio(e,t){if(e.webConferenceSession){for(let n in e.webConferenceSession.sessions)if(e.webConferenceSession.sessions.hasOwnProperty(n)){e.webConferenceSession.sessions[n].muteAudio(t)}e.isMutedAudio=t,this.$rootScope.$broadcast("ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT",{conversation:e})}else this.$log.info("[webConferenceService] muteAudio trying to mute a non existing session ")}createStatisticsForSession(e,t){if(this.$log.info("[webConferenceService] createStatisticsForSession for conf "+e+" and session "+t),!e||!t)return void this.$log.warn("[webConferenceService] createStatisticsForSession -- missing parameters");this.videoService.callsStats[t]={};let n=[];n.push({connectionId:t,stats:this.videoService.callsStats[t]}),this.videoService.createStatisticsForSession(e,e,"pending",n).then(n=>{this.$log.info("[webConferenceService] createStatisticsForSession success "+n),this.videoService.callsStats[t].id=n,this.conferenceSessions[e].metricsId=n,this.conferenceSessions[e].metricsState="pending"}).catch(()=>{this.$log.error("[webConferenceService] createStatisticsForSession error for conf "+e)})}updateStatisticsForSession(e,t){if(this.$log.info("[webConferenceService] updateStatisticsForSession for conf "+e+" and session "+t),!e||!t)return void this.$log.warn("[webConferenceService] updateStatisticsForSession -- missing parameters");let n=this.conferenceSessions[e];if(!n||!n.metricsId)return void this.$log.warn("[webConferenceService] updateStatisticsForSession -- missing webConference or no metricsId");n.metricsState||(n.metricsState="pending");let r=[];return this.videoService.callsStats[t]?(r.push({connectionId:t,stats:this.videoService.callsStats[t]}),void this.videoService.updateStatisticsForCall(n.metricsId,e,e,n.metricsState,r)):void 0}leaveWebConference(e){if(this.$log.info(`[WebConferenceService] leaveWebConference - ${e}`),this.contactService.resetBusyState(),e){let e,t=this.conferenceSessions[e];if(!t)return void this.$log.warn("[WebConferenceService] leaveWebConference - webConference does not exist");for(let e in t.metricsState="ended",t.sessions)if(t.sessions.hasOwnProperty(e)){let n=t.sessions[e];this.updateStatisticsForSession(t.id,n.sid),this.videoService.disableAudioVideoMedia(n),this.xmppService.connection.jingle.terminate(n.sid),delete this.videoService.callsStats[n.sid]}for(t.cleanupSessionData(),this.createVideoGalleryElements(),t.videoGallery=this.videoGalleryElements,t.sessions={};this.statsIntervals.length;)(e=this.statsIntervals.pop())&&(window.clearInterval(e),e=null);this.makingCall=!1,this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",t)}}attachDistantMediaStream(e,t){if(e){let e=this.getRemoteVideoSessions(t.id);this.updateMainSessionIfNeeded(e),this.$log.info("[WebConferenceService] attachDistantMediaStream for session "+t.id);let n=this.getRemoteSharingSession(t.id);if(n&&n.remoteStreams.forEach(e=>{0<e.getVideoTracks().length&&this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),e,n.sid)}),e.length)for(let r in e)e.hasOwnProperty(r)&&e[r].remoteStreams&&e[r].remoteStreams.forEach(i=>{if(0<i.getVideoTracks().length){!n&&e[r].mainSession&&this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),i,e[r].sid);for(let n=0;n<t.videoGallery.length;n++)if(t.videoGallery[n].sessionId===e[r].sid){this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#"+t.videoGallery[n].id),i,t.videoGallery[n].sessionId);break}}});let r=this.getRemoteAudioSession(t.id);r&&r.remoteStreams&&r.remoteStreams.forEach(e=>{0<e.getAudioTracks().length&&this.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),e)})}}attachMainMediaStream(e){e&&(this.$log.info("[webConferenceService] attachMainMediaStream"),e.remoteStreams.forEach(t=>{0<t.getVideoTracks().length&&this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),t,e.sid)}))}updateMainSessionIfNeeded(e){if(this.$log.info("[webConferenceService] updateMainSessionIfNeeded"),e&&e.length){let t=null,n=!0;for(let r in e)e.hasOwnProperty(r)&&(t||(t=e[r]),e[r].mainSession&&(n=!1));n&&(t.mainSession=!0)}}getRelatedRoomToActiveConferenceSession(){return this.webConferenceRoom}getRelatedRoomToActiveSharingOnlyConferenceSession(){return this.webrtcSharingOnlyRoom}getConferenceBySessionId(e){let t=null;for(let n in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(n)&&this.conferenceSessions[n].sessions)for(let r in this.conferenceSessions[n].sessions)if(this.conferenceSessions[n].sessions.hasOwnProperty(r)&&this.conferenceSessions[n].sessions[r].sid===e)return t=this.conferenceSessions[n];return t}getPontConfIdForRoom(e,t=this.MEDIATYPE.WEBRTC){if(e.confEndpoints&&e.confEndpoints.length)for(let n=0;n<e.confEndpoints.length;n++)if(e.confEndpoints[n].mediaType===t)return e.confEndpoints[n].confEndpointId;return""}getConferenceSessionById(e){return this.conferenceSessions[e]}getSfuConferenceSessionForRoom(e){var t=null;return e&&(t=this.conferenceSessions[e.getSFUConfEndpointId()]),t}updateWebConferenceInfos(e){this.$log.info("[WebConferenceService] updateWebConferenceInfos"),Object.assign(this.conferenceEndpoints,e),this.webrtcConferenceId=this.getWebRtcConfEndpointId(),this.webrtcConferenceId&&this.roomService.getRoomByConferenceEndpointId(this.webrtcConferenceId).then(e=>{let t="nothing";e&&(t=e.name),this.webConferenceRoom=e,this.$log.info("[WebConferenceService] === updateWebConferenceInfos : webrtcConferenceId is currently attached to "+t)},()=>{this.$log.info("[WebConferenceService] === updateWebConferenceInfos FAILURE ===")})}updateWebSharingOnlyConferenceInfos(e){this.$log.info("[WebConferenceService] updateWebSharingOnlyConferenceInfos"),Object.assign(this.conferenceEndpoints,e),this.webrtcSharingOnlyConferenceId=this.getWebRtcSharingOnlyConfEndpointId(),this.webrtcSharingOnlyConferenceId&&this.roomService.getRoomByConferenceEndpointId(this.webrtcSharingOnlyConferenceId).then(e=>{let t=e&&e.name?e.name:"nothing";this.webrtcSharingOnlyRoom=e,this.$log.info("[WebConferenceService] === updateWebSharingOnlyConferenceInfos : webrtcSharingOnlyConferenceId is currently attached to "+t)},()=>{this.$log.info("[WebConferenceService] === updateWebSharingOnlyConferenceInfos FAILURE ===")})}updateWebConferenceRoom(){return this.webrtcConferenceId=this.getWebRtcConfEndpointId(),this.$q((e,t)=>{this.roomService.getRoomByConferenceEndpointId(this.webrtcConferenceId).then(t=>{let n="nothing";t&&(n=t.name),this.webConferenceRoom=t,this.$log.info("[WebConferenceService] === updateWebConferenceRoom : room is currently attached to "+n),e()},()=>{this.$log.info("[WebConferenceService] === updateWebConferenceRoom FAILURE==="),t()})})}getWebRtcConfEndpointId(){for(let e in this.conferenceEndpoints)if(this.conferenceEndpoints.hasOwnProperty(e)&&this.conferenceEndpoints[e].mediaType===this.MEDIATYPE.WEBRTC)return this.conferenceEndpoints[e].id;return null}getWebRtcSharingOnlyConfEndpointId(){for(let e in this.conferenceEndpoints)if(this.conferenceEndpoints.hasOwnProperty(e)&&this.conferenceEndpoints[e].mediaType===this.MEDIATYPE.WEBRTCSHARINGONLY)return this.conferenceEndpoints[e].id;return null}isJoinWebConferenceAllowed(){return!0}getWebConference(e){return e?this.conferenceSessions[e]:void 0}removeConferenceSession(e){if(e){this.removeAllJingleSessionsForConferenceSession(e),delete this.conferenceSessions[e];for(let e;this.statsIntervals.length;)(e=this.statsIntervals.pop())&&(this.$interval.cancel(e),e=null);this.makingCall=!1}}removeAllJingleSessionsForConferenceSession(e){if(e){let t=this.conferenceSessions[e];if(t){for(let e in t.metricsState="ended",t.sessions)if(t.sessions.hasOwnProperty(e)){let n=t.sessions[e];this.updateStatisticsForSession(t.id,n.sid),delete this.videoService.callsStats[n.sid],this.videoService.disableAudioVideoMedia(n),this.xmppService.connection.jingle.terminate(n.sid)}t.sessions=[]}}}hasActiveConferenceSession(){for(let e in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(e)&&this.conferenceSessions[e].type===this.MEDIATYPE.WEBRTC&&this.conferenceSessions[e].isActive()&&this.conferenceSessions[e].haveJoined)return!0;return!1}getActiveConferenceSession(){let e=null;for(let t in this.conferenceSessions)this.conferenceSessions.hasOwnProperty(t)&&this.conferenceSessions[t].type===this.MEDIATYPE.WEBRTC&&this.conferenceSessions[t].isActive()&&this.conferenceSessions[t].haveJoined&&(e=this.conferenceSessions[t]);return e}hasActiveSharingOnlyConferenceSession(){for(let e in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(e)&&this.conferenceSessions[e].type===this.MEDIATYPE.WEBRTCSHARINGONLY&&this.conferenceSessions[e].isActive())return!0;return!1}getActiveSharingOnlyConferenceSession(){let e=null;for(let t in this.conferenceSessions)this.conferenceSessions.hasOwnProperty(t)&&this.conferenceSessions[t].type===this.MEDIATYPE.WEBRTCSHARINGONLY&&this.conferenceSessions[t].isActive()&&(e=this.conferenceSessions[t]);return e}hasIncomingVideoStream(e){if(e){let t=this.conferenceSessions[e];if(t)for(let e in t.sessions)if(t.sessions.hasOwnProperty(e)){let n=t.sessions[e];if(!n.isInitiator&&("video"===n.remoteType||"sharing"===n.remoteType))return!0}return!1}}getRemoteSessionsWithVideoOrSharingStreams(e){let t=[];if(!e)return t;let n=this.conferenceSessions[e];if(n)for(let e in n.sessions)if(n.sessions.hasOwnProperty(e)){let r=n.sessions[e];r.isInitiator||"video"!==r.remoteType&&"sharing"!==r.remoteType||t.push(r)}return t}getRemoteSharingSession(e){let t=null;if(!e)return t;let n=this.conferenceSessions[e];if(n)for(let e in n.sessions)if(n.sessions.hasOwnProperty(e)){let r=n.sessions[e];if(!r.isInitiator&&"sharing"===r.remoteType){t=r;break}}return t}getRemoteVideoSessions(e){let t=[];if(!e)return t;let n=this.conferenceSessions[e];if(n)for(let e in n.sessions)if(n.sessions.hasOwnProperty(e)){let r=n.sessions[e];r.isInitiator||"video"!==r.remoteType||t.push(r)}return t}getRemoteAudioSession(e){let t;if(!e)return t;let n=this.conferenceSessions[e];if(n)for(let e in n.sessions)if(n.sessions.hasOwnProperty(e)){let r=n.sessions[e];if("audio"===r.localType){t=r;break}}return t}getRemoteMainVideoSession(e){let t;if(!e)return t;let n=this.conferenceSessions[e];if(n)for(let e in n.sessions)if(n.sessions.hasOwnProperty(e)){let r=n.sessions[e];if(!r.isInitiator&&"video"===r.remoteType&&r.mainSession){t=r;break}}return t}isAlreadySubscribedToPublisher(e,t){if(!e||!t)return!1;let n=!1,r=this.conferenceSessions[e];if(r&&r.videoGallery)for(let e=0;e<r.videoGallery.length;e++)if(r.videoGallery[e].publisherId===t){n=!0;break}return n}relatePublisherToElement(e,t,n){if(!e||!t||!n)return!1;this.$log.info("[WebConferenceService] relatePublisherToElement");let r=this.conferenceSessions[e];if(r)for(let e=0;e<r.videoGallery.length;e++)if(r.videoGallery[e].id===n){r.videoGallery[e].state="busy",r.videoGallery[e].publisherId=t.participantId,r.videoGallery[e].publisherJidIm=t.jid_im,r.videoGallery[e].displayName=t.participantId;let n=this.contactService.getContactByJid(t.jid_im);n&&(r.videoGallery[e].displayName=n.displayName);break}}getRelatedPublisherToElement(e,t){if(!e||!t)return null;this.$log.info("[WebConferenceService] getRelatedPublisherToElement");let n=null,r=this.conferenceSessions[e];if(r&&r.videoGallery)for(let e=0;e<r.videoGallery.length;e++)if(t===r.videoGallery[e].id&&r.videoGallery[e].publisherId){n=r.videoGallery[e];break}return n}relateSessionToPublisher(e,t,n){if(e&&t&&n){this.$log.info("[WebConferenceService] relateSessionToPublisher pubId "+t+" sessionId "+n);let r=this.conferenceSessions[e];if(r){for(let e=0;e<r.videoGallery.length;e++)if(t===r.videoGallery[e].publisherId&&!r.videoGallery[e].sessionId){r.videoGallery[e].sessionId=n;break}this.$log.info(r.videoGallery)}}}removeSessionFromVideoGallery(e,t){if(e&&t){e.videoGallery||(this.createVideoGalleryElements(),e.videoGallery=this.videoGalleryElements),this.$log.info("[WebConferenceService] removeSessionFromVideoGallery for conference "+e.id+" sessionId "+t);for(let n=0;n<e.videoGallery.length;n++)e.videoGallery[n].sessionId===t&&(e.videoGallery[n].sessionId="",e.videoGallery[n].state="free",e.videoGallery[n].publisherId="",e.videoGallery[n].publisherJidIm="",e.videoGallery[n].displayName="")}}reInitialiseVideoGalleryElementById(e,t){if(e&&t){e.videoGallery||(this.createVideoGalleryElements(),e.videoGallery=this.videoGalleryElements),this.$log.info("[WebConferenceService] reInitialiseVideoGalleryElementById for conference "+e.id+" elementId "+t);for(let n=0;n<e.videoGallery.length;n++)e.videoGallery[n].id===t&&(e.videoGallery[n].sessionId&&this.dropRemoteVideoSession(e,e.videoGallery[n].sessionId),e.videoGallery[n].sessionId="",e.videoGallery[n].state="free",e.videoGallery[n].publisherId="",e.videoGallery[n].publisherJidIm="",e.videoGallery[n].displayName="")}}updateMainScreenSession(e,t){if(!e||!t)return;this.$log.info("[WebConferenceService] updateMainScreenSession");let n=this.conferenceSessions[e],r=null;if(n)for(let e in n.sessions)if(n.sessions.hasOwnProperty(e)){let i=n.sessions[e];t===i.sid?(i.mainSession=!0,r=i):i.mainSession=!1}r&&this.attachMainMediaStream(r)}getListOfAvailableRemoteVideoPublishers(e){if(!e)return;this.$log.info("[WebConferenceService] getListOfAvailableRemoteVideoPublishers");let t=this.conferenceSessions[e],n=[];return t&&(!t.videoGallery&&(this.createVideoGalleryElements(),t.videoGallery=this.videoGalleryElements),n=(n=t.getListOfRemoteVideoPublishers()).filter(e=>{for(let n=0;n<t.videoGallery.length;n++)if(t.videoGallery[n].publisherId===e.participantId)return!1;let n=this.contactService.getContactByJid(e.jid_im);return e.displayName=n?n.displayName:e.participantId,!0})),n}sendTransportReplaceForSession(e,t){if(!e)return void this.$log.warn("[WebConferenceService] sendTransportReplaceForSession missing session !");if(this.reconnecting)return void this.$log.warn("[WebConferenceService] sendTransportReplaceForSession already reconnecting !");let n=this;this.reconnecting=!0,t||(t=5e3),this.$interval(e=>{n.reconnecting=!1,n.connected&&e&&e.peerconnection&&"stable"===e.peerconnection.signalingState&&"failed"===e.peerconnection.iceConnectionState&&(n.$log.info("[WebConferenceService] sendTransportReplaceForSession for session "+e.sid),e.connection=n.xmppService.connection,e.sendTransportReplace())},t,1,!0,e)}onAudioProfileChangeEvent(){if(this.$log.info("[WebConferenceService] onAudioProfileChangeEvent"),this.audioProfileChanging)this.$log.info("[WebConferenceService] onAudioProfileChangeEvent -- already changing");else for(let e in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(e)){let t=this.conferenceSessions[e];for(let e in t.sessions)if(t.sessions.hasOwnProperty(e)){let n=t.sessions[e];"audio"===n.localType&&(this.audioProfileChanging=!0,this.$interval(e=>{this.audioProfileChanging=!1,this.videoService.getBrowserMedia(["audio"]).then(t=>{e.removeStream(e.localStreams[0]),this.videoService.stopActiveAudioVideoStreams(e),e.localStreams.push(t),e.addStream(e.localStreams[0]),e.sendTransportReplace()})},500,1,!0,n))}}}onJingleError(e){this.$log.info("[WebConferenceService] onJingleError -- "+e);let t=this.getConferenceBySessionId(e);if(t&&t.sessions){"audio"===t.sessions[e].localType?this.leaveWebConference(t.id):(this.updateStatisticsForSession(t.id,e),t.localVideoSessionId===e?this.removeMediaFromConferenceSession(t,"video"):t.localSharingSessionId===e?this.removeMediaFromConferenceSession(t,"sharing"):(this.removeSessionFromVideoGallery(t,e),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",t)))}}onIceConnectionFailedForSession(e,t){if(this.$log.info("[WebConferenceService] onIceConnectionFailedForSession -- "+t),e&&e.sessions){let n=e.sessions[t];"audio"===n.localType?(e.status="reconnecting",this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",e),this.connected&&this.sendTransportReplaceForSession(n,5e3)):e.localVideoSessionId===t?this.removeMediaFromConferenceSession(e,"video"):e.localSharingSessionId===t?this.removeMediaFromConferenceSession(e,"sharing"):(this.updateStatisticsForSession(e.id,t),delete this.videoService.callsStats[t],this.removeSessionFromVideoGallery(e,t),delete e.sessions[t],this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",e))}}onIncomingCall(e){this.$log.info("[WebConferenceService] onIncomingCall -- "+e);let t=this.xmppService.connection.jingle.sessions[e],n=t.confId,r=this.conferenceSessions[n];return r?(r.sessions[e]=t,t.localType=t.remoteType,t.sendAnswer(),t.accept(),t.publisherId&&"sharing"!==t.remoteType&&this.relateSessionToPublisher(n,t.publisherId,t.sid),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",r),this.videoService.callsStats[t.sid]={},this.updateStatisticsForSession(r.id,t.sid),void this.statsIntervals.push(t.getStats(5e3))):void this.$log.error("[WebConferenceService] onIncomingCall no such conferenceSession "+n)}onTerminatedCall(e){this.$log.info("[WebConferenceService] onTerminatedCall -- "+e);let t=this.xmppService.connection.jingle.sessions[e];if(!t){let t=this.getActiveConferenceSession()?this.getActiveConferenceSession():this.getActiveSharingOnlyConferenceSession();if(t&&t.sessions){t.sessions[e]&&(t.metricsState="ended",this.updateStatisticsForSession(t.id,e)),t.localVideoSessionId===e?this.removeMediaFromConferenceSession(t,"video"):t.localSharingSessionId===e?this.removeMediaFromConferenceSession(t,"sharing"):(this.removeSessionFromVideoGallery(t,e),this.videoService.disableAudioVideoMedia(t.sessions[e]),delete t.sessions[e],delete this.videoService.callsStats[e],this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",t))}return}let n=t.confId,r=this.conferenceSessions[n];return r?(this.updateStatisticsForSession(r.id,e),void(r.localVideoSessionId===e?this.removeMediaFromConferenceSession(r,"video"):r.localSharingSessionId===e?this.removeMediaFromConferenceSession(r,"sharing"):(this.removeSessionFromVideoGallery(r,e),this.videoService.disableAudioVideoMedia(t),this.xmppService.connection.jingle.terminate(t.sid),delete r.sessions[t.sid],delete this.videoService.callsStats[e],this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",r)))):void this.$log.error("[WebConferenceService] onTerminatedCall no such conferenceSession "+n)}onConferenceCallSwitched(e){this.$log.info("[WebConferenceService] onConferenceCallSwitched -- "+e);let t=this.getActiveConferenceSession();t&&this.leaveWebConference(t.id)}onIceConnectionStateChange(e,t){this.$log.info("[WebConferenceService] onIceConnectionStateChange for session "+e);let n=this.getConferenceBySessionId(e);try{n&&t.peerconnection&&("stable"===t.peerconnection.signalingState&&"connected"===t.peerconnection.iceConnectionState&&(this.$log.info("[WebConferenceService] ICE Connection established successfully"),n.status="connected",t.remoteStreams&&t.remoteStreams.forEach(e=>{0<e.getAudioTracks().length&&(this.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),e),this.videoService.resetAudioOutputElement(!0))}),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",n),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",n)),"stable"===t.peerconnection.signalingState&&"completed"===t.peerconnection.iceConnectionState&&(this.$log.info("[WebConferenceService] ICE Connection completed successfully"),"connected"!==n.status&&(n.status="connected",t.remoteStreams&&t.remoteStreams.forEach(e=>{0<e.getAudioTracks().length&&(this.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),e),this.videoService.resetAudioOutputElement(!0))}),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",n),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",n))),"stable"===t.peerconnection.signalingState&&"disconnected"===t.peerconnection.iceConnectionState&&this.$log.info("[WebConferenceService] ICE Connection State disconnected"),"stable"===t.peerconnection.signalingState&&"failed"===t.peerconnection.iceConnectionState&&(this.$log.info("[WebConferenceService] ICE Connection State failed"),this.onIceConnectionFailedForSession(n,e)))}catch(e){this.$log.error("[WebConferenceService] onIceConnectionStateChange error "+e)}}updateOrCreateConferenceSession(e,t,n="webrtc"){if(this.$log.debug("[webConferenceService] updateOrCreateConferenceSession for "+e),!e||!t||!t.data)return this.$log.error("[webConferenceService] updateOrCreateConferenceSession - Not enough data"),null;let r=this.conferenceSessions[e];return r?t.data.active!==r.active&&(this.$log.debug("active"),r.updateActiveState(t.data.active),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",r)):(this.$log.debug("[webConferenceService] updateOrCreateConferenceSession - create new conferencesession with id "+e+"and data: \n"+JSON.stringify(t.data)),r=this.ConferenceSession.createFromData(e,[],t.data.active,n),this.conferenceSessions[e]=r,this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",r)),t.data.participants&&(this.$log.debug("[webConferenceService] updateOrCreateConferenceSession - update participants for "+e+" with:\n"+JSON.stringify(t.data.participants)),r.updateParticipants(t.data.participants).then(()=>{this.$rootScope.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",r)})),r}updateOrCreateWebConferenceEndpoint(e){if(this.$log.info("[WebConferenceService] updateOrCreateWebConferenceEndpoint for "+e.id),!e)return this.$log.error("[WebConferenceService] updateOrCreateWebConferenceEndpoint - no conference data !"),null;if(e.mediaType!==this.MEDIATYPE.WEBRTC&&e.mediaType!==this.MEDIATYPE.WEBRTCSHARINGONLY)return this.$log.error("[WebConferenceService] updateOrCreateWebConferenceEndpoint - wrong mediaType:"+e.mediaType),null;let t=this.Conference.createFromData(e);return this.conferenceEndpoints[e.id]=t,t.mediaType===this.MEDIATYPE.WEBRTC?this.updateWebConferenceInfos([t]):this.updateWebSharingOnlyConferenceInfos([t]),this.conferenceEndpoints[e.id]}makeSnapshotForConfId(e=null,t){if(!e){let e="[webConferenceService] makeSnapshotForConfId - No confId !!";return this.$log.error(e),this.$q.reject(e)}let n=this.conferenceSessions[e];return n&&n.active&&n.haveJoined?(this.$log.debug("[WebConferenceService] makeSnapshotForConfId skipped, already joined"),this.$q.resolve(n)):this.$q((n,r)=>{this.$http({method:"GET",url:this.confPortalURL+e+"/snapshot?mediaType=webrtc",headers:this.authService.getRequestHeader()}).then(r=>{this.$log.info("[webConferenceService] makeSnapshotForConfId success for confId "+e);let i=r.data;this.updateOrCreateConferenceSession(e,i,t),n(i.data)}).catch(t=>{this.$log.info("[webConferenceService] makeSnapshotForConfId failure for confID "+e),404===t.status?this.$log.error("[webConferenceService] makeSnapshotForConfId - confId "+e+" not found on server"):this.$log.error("[webConferenceService] makeSnapshotForConfId - inconsistent object on server"),this.conferenceSessions[e]&&this.removeConferenceSession(e),r()})})}refreshConferenceSessions(){return this.$log.info("[webConferenceService] refreshConferenceSessions"),this.$q((e,t)=>{let n=[];for(let e in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(e)){let t=this.conferenceSessions[e];n.push(this.makeSnapshotForConfId(t.id,t.type))}this.$q.all(n).then(()=>{this.$log.info("[webConferenceService] refreshConferenceSessions -- success"),e()}).catch(()=>{this.$log.error("[webConferenceService] refreshConferenceSessions -- error -- cleaning up all sessions"),this.removeAllConferenceSessions(),t()})})}removeAllConferenceSessions(){for(let e in this.$log.info("[webConferenceService] removeAllConferenceSessions"),this.conferenceSessions)this.conferenceSessions.hasOwnProperty(e)&&this.removeConferenceSession(e)}getConferenceSessionForRoom(e){let t=null;if(e&&e.length)for(let n=0;n<e.length;n++)(e[n].mediaType===this.MEDIATYPE.WEBRTC||e[n].mediaType===this.MEDIATYPE.WEBRTCSHARINGONLY)&&(t=this.conferenceSessions[e[n].confEndpointId]);return t}}e.$inject=["$q","$rootScope","$log","$http","uuid4","$interval","authService","xmppService","videoService","roomService","errorHelperService","ConferenceSession","contactService","platformService","Conference","profileService"],angular.module("rainbow").service("webConferenceService",e)},function(){class e{constructor(e,t,n,r,i,a,o,s,c,l,d,u,h,f,p){this.$q=e,this.$log=t,this.$rootScope=n,this.$interval=r,this.$translate=i,this.$http=a,this.xmppService=o,this.authService=s,this.Conference=c,this.profileService=l,this.contactService=d,this.webConferenceService=u,this.pstnConferenceService=h,this.roomService=f,this.errorHelperService=p,this.MEDIATYPE={PSTNAUDIO:"pstnAudio",WEBRTC:"webrtc",WEBRTCSHARINGONLY:"webrtcSharingOnly"},this.started=!1,this.isCleaningPersonalMeeting=!1,this.listeners=[],this.conferenceRef=null,this.conferenceMngtRef=null,this.pgiConferenceProvisionRef=null}start(e){return this.$q(t=>{let n=performance.now();return this.$log.info("[ConferenceService] === STARTING ==="),this.confProvPortalURL=config.restServerUrl+"/api/rainbow/confprovisioning/v1.0/",this.confPortalURL=config.restServerUrl+"/api/rainbow/conference/v1.0/conferences/",this.computePstnConferencePremission(),this.attachHandlers(),this.pstnConferenceService.retrievePstnPhoneNumbers(),this.retrieveConferences(null,!1).then(()=>this.pstnConferenceService.pstnInstantConferenceEndpoint?this.retrieveConferenceUser(this.contactService.userContact.dbId):this.$q.when()).then(()=>this.makeSnapshots()).then(()=>this.pstnConferenceService.isPstnConferenceAvailable?this.initializePersonalMeeting():this.$q.when()).then(()=>{this.started=!0;let r=Math.round(performance.now()-n);e.push({service:"conferenceService",startDuration:r}),this.$log.info("[ConferenceService] === STARTED ("+r+" ms) ==="),t()}).catch(e=>{this.$log.info("[ConferenceService] === STARTING FAILURE === "+e.message),t()})})}stop(){return this.$q(e=>{this.$log.info(""),this.$log.info("[ConferenceService] === STOPPING ==="),this.listeners&&this.listeners.forEach(e=>{e()}),this.isCleaningPersonalMeeting=!1,this.started=!1,this.$log.info("[ConferenceService] === STOPPED ==="),e()})}attachHandlers(){this.$log.info("[ConferenceService] attachHandlers"),this.conferenceRef&&(this.xmppService.connection.deleteHandler(this.conferenceRef),this.conferenceRef=null),this.conferenceRef=this.xmppService.connection.addHandler(e=>this.onConferenceUpdate(e),"jabber:iq:conference","message",null),this.conferenceMngtRef&&(this.xmppService.connection.deleteHandler(this.conferenceMngtRef),this.conferenceMngtRef=null),this.conferenceMngtRef=this.xmppService.connection.addHandler(e=>this.onConferenceManagement(e),null,"message","management"),this.listeners.push(this.$rootScope.$on("ON_PROFILE_FEATURES_UPDATED",()=>{this.onMyProfileFeaturesChanged()}))}reconnectService(){this.$log.info("[ConferenceService] reconnectService"),this.attachHandlers(),this.isCleaningPersonalMeeting=!1,this.refreshConferenceSessions()}onMyProfileFeaturesChanged(){let e=this.pstnConferenceService.isPstnConferenceAvailable;if(this.computePstnConferencePremission(),e)this.pstnConferenceService.isPstnConferenceAvailable||this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"information",popupBody:"pgiRightsRemovedWarning",okLabel:"ok"});else if(this.pstnConferenceService.isPstnConferenceAvailable)return this.retrieveConferences(null,!1).then(()=>this.pstnConferenceService.pstnInstantConferenceEndpoint?this.retrieveConferenceUser(this.contactService.userContact.dbId):this.$q.when()).then(()=>this.initializePersonalMeeting()).then(()=>this.makeSnapshots())}computePstnConferencePremission(){let e=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.CONFERENCE_ALLOWED),t=!0,n=this.profileService.getMyProfiles();n&&0<n.length&&n.forEach(e=>{-1!==e.profileName.toLowerCase().indexOf("conference")&&-1!==e.status.toLowerCase().indexOf("active")&&e.provisioningNeeded&&0<e.provisioningNeeded.length&&e.provisioningNeeded.forEach(e=>{-1!==e.providerType.toLowerCase().indexOf("pgi")&&((t=e.provisioningOngoing)&&(this.pgiConferenceProvisionRef&&(this.xmppService.connection.deleteHandler(this.pgiConferenceProvisionRef),this.pgiConferenceProvisionRef=null),this.pgiConferenceProvisionRef=this.xmppService.connection.addHandler(e=>this.onConferenceProvisionUpdate(e),null,"message","management")))})}),this.pstnConferenceService.isPstnConferenceAvailable=e&&!t,this.$rootScope.$broadcast("ON_CONFERENCE_FEATURES_UPDATED")}onConferenceProvisionUpdate(e){return 0<$(e).find("confuseractivated ").length&&(this.pgiConferenceProvisionRef&&(this.xmppService.connection.deleteHandler(this.pgiConferenceProvisionRef),this.pgiConferenceProvisionRef=null),this.pstnConferenceService.isPstnConferenceAvailable=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.CONFERENCE_ALLOWED),this.pstnConferenceService.isPstnConferenceAvailable&&this.retrieveConferences(null,!1).then(()=>this.pstnConferenceService.pstnInstantConferenceEndpoint?this.retrieveConferenceUser(this.contactService.userContact.dbId):this.$q.when()).then(()=>this.initializePersonalMeeting()).then(()=>this.makeSnapshots()),this.$rootScope.$broadcast("ON_CONFERENCE_FEATURES_UPDATED")),!0}getPstnInstantConferenceEndpoint(){return this.pstnConferenceService.pstnInstantConferenceEndpoint}getPstnInstantConferenceEndpointId(){return this.pstnConferenceService.pstnInstantConferenceEndpoint?this.pstnConferenceService.pstnInstantConferenceEndpoint.id:-1}getPstnConferenceUser(){return this.pstnConferenceService.pstnConferenceUser}getWebConferenceEndpoints(){return this.webConferenceService.conferenceEndpoints}createConference(e,t,n,r,i,a){return this.$q((o,s)=>{this.$log.info("[conferenceService] createConference"),this.$http({method:"POST",url:this.confProvPortalURL+"conferences",headers:this.authService.getRequestHeader(),data:{confUserId:e,name:t,startDate:n,endDate:r,timeZone:i,provisioning:!!a}}).then(e=>{let t=e.data.data,n=this.Conference.createFromData(t);t.hasOwnProperty("id")&&(t.mediaType===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.pstnConferenceEndpoints[t.id]=n:this.webConferenceService.conferenceEndpoints[t.id]=n),this.$log.info("[conferenceService] createConference successfully"),o(n)},e=>{let t="createConference failure: "+(e.data?e.data.errorDetails:e.data);this.$log.error("[conferenceService] "+t),s(new Error(t))})})}deleteConference(e){return this.$q((t,n)=>{this.$log.info("[conferenceService] deleteConference"),this.$http({method:"DELETE",url:this.confProvPortalURL+"conferences/"+e,headers:this.authService.getRequestHeader()}).then(()=>{this.pstnConferenceService.pstnConferenceEndpoints[e]&&this.pstnConferenceService.pstnInstantConferenceEndpoint&&this.pstnConferenceService.pstnInstantConferenceEndpoint.id!==e&&delete this.pstnConferenceService.pstnConferenceEndpoints[e],this.webConferenceService.conferenceEndpoints[e]&&delete this.webConferenceService.conferenceEndpoints[e],this.$log.info("[conferenceService] deleteConference successfully"),t()},e=>{let t="deleteConference failure: "+(e.data?e.data.errorDetails:e.data);this.$log.error("[conferenceService] "+t),n(new Error(t))})})}makeSnapshotsForList(e){return this.$q(t=>{if(this.$log.info("[ConferenceService] makeSnapshotsForList"),!e||!e.length)return void t();let n=[];for(let t=0;t<e.length;t++)n.push(this.makeSnapshotForConfId(e[t].confEndpointId,e[t].mediaType));this.$q.all(n).finally(()=>{t(this.getConferenceSessionForRoom(e))})})}getConferenceSessionForRoom(e){let t=null,n=null;if(e&&e.length)for(let r=0;r<e.length;r++)e[r].mediaType===this.MEDIATYPE.PSTNAUDIO?t=this.pstnConferenceService.conferenceSessions[e[r].confEndpointId]:n=this.webConferenceService.conferenceSessions[e[r].confEndpointId];return t||n}getMatchingConferenceSession(e,t){let n=null;if(e&&e.length)for(let r=0;r<e.length;r++)e[r].confEndpointId===t&&(n=e[r].mediaType===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.conferenceSessions[t]:this.webConferenceService.conferenceSessions[t]);return n}makeSnapshots(){return this.$log.info("[ConferenceService] makeSnapshots"),this.$q(e=>{let t=[];for(let e in this.pstnConferenceService.pstnInstantConferenceEndpoint&&t.push(this.makeSnapshotForConfId(this.pstnConferenceService.pstnInstantConferenceEndpoint.id,this.pstnConferenceService.pstnInstantConferenceEndpoint.mediaType)),this.webConferenceService.conferenceEndpoints)if(this.webConferenceService.conferenceEndpoints.hasOwnProperty(e)){let n=this.webConferenceService.conferenceEndpoints[e];t.push(this.makeSnapshotForConfId(n.id,n.mediaType))}this.$q.all(t).finally(()=>{this.$log.info("[ConferenceService] makeSnapshots done"),e()})})}retrieveConferenceUser(e){return this.pstnConferenceService.retrieveConferenceUser(e)}onConferenceUpdate(e){this.$log.info("[ConferenceService] onConferenceUpdate message: "+e.innerHTML);let t=$(e).find("conference-id").text(),n=$(e).find("media-type"),r=this.MEDIATYPE.PSTNAUDIO;if(n&&n.length&&n.text&&(r=$(n[0]).text()),t){let n=null;if(n=r===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.conferenceSessions[t]:this.webConferenceService.conferenceSessions[t])this.updateConferenceSession(e,n);else switch(this.$log.info("[ConferenceService] no such session for ID "+t),r){case"webrtc":break;case"webrtcsharing":let n=$(e).find("publisher"),i=n.find("jid-im").text(),a={participantId:n.find("publisher-id").text(),mediaType:r,jid_im:i};this.subscribeToPublisher(t,a)}}return!0}onConferenceManagement(e){try{let t=$(e).find("confendpoint");if(t.length&&"update"===t.attr("action")){this.$log.info("[ConferenceService] onConferenceManagement - update of conference");let t=$(e).find("confendpointid").text();return this.$rootScope.$broadcast("ON_CONFERENCE_DATA_UPDATED_EVENT",t),!0}return!0}catch(e){return!0}}makeSnapshotForConfId(e,t=this.MEDIATYPE.PSTNAUDIO){return this.$log.info("[ConferenceService] makeSnapshotForConfId "+e),this.$q((n,r)=>{if(!e){let e=new Error("[ConferenceService] makeSnapshotForConfId missing conf ID !");return this.$log.error(e.message),void r(e)}let i=null;if(t===this.MEDIATYPE.PSTNAUDIO?i=this.pstnConferenceService.conferenceSessions[e]:t===this.MEDIATYPE.WEBRTC||t===this.MEDIATYPE.WEBRTCSHARINGONLY?i=this.webConferenceService.conferenceSessions[e]:this.$log.info("[ConferenceService] makeSnapshotForConfId : unknown type "+t),i&&i.active&&i.haveJoined)return this.$log.debug("[ConferenceService] makeSnapshotForConfId skipped, already joined"),void n(i);let a=t===this.MEDIATYPE.WEBRTC||t===this.MEDIATYPE.WEBRTCSHARINGONLY?this.MEDIATYPE.WEBRTC:this.MEDIATYPE.PSTNAUDIO;this.$http({method:"GET",url:this.confPortalURL+e+"/snapshot?mediaType="+a,headers:this.authService.getRequestHeader()}).then(r=>{this.$log.info("[ConferenceService] makeSnapshotForConfId success for confId "+e);let i=r.data;a===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.updateOrCreateConferenceSession(e,i):this.webConferenceService.updateOrCreateConferenceSession(e,i,t),n(i.data)}).catch(t=>{this.$log.info("[ConferenceService] makeSnapshotForConfId failure for confID "+e),404===t.status?this.$log.error("[ConferenceService] makeSnapshotForConfId - confId "+e+" not found on server"):this.$log.error("[ConferenceService] makeSnapshotForConfId - inconsistent object on server"),a===this.MEDIATYPE.PSTNAUDIO?delete this.pstnConferenceService.conferenceSessions[e]:delete this.webConferenceService.conferenceSessions[e];let n=this.errorHelperService.handleError(t);r(n)})})}retrieveConferences(e,t,n){switch(this.$log.info("[ConferenceService] retrieveConferences with mediaType="+e+" and scheduled="+t),e){case this.MEDIATYPE.PSTNAUDIO:return this.pstnConferenceService.retrievePstnConferences(t,n);case this.MEDIATYPE.WEBRTC:case this.MEDIATYPE.WEBRTCSHARINGONLY:return this.webConferenceService.retrieveWebConferences(e)}return this.$q((e,n)=>{if(!this.pstnConferenceService.isPstnConferenceAvailable&&!this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.WEBRTC_CONFERENCE_ALLOWED))return this.$log.warn("[ConferenceService] retrieveConferences - user is not allowed"),void n(new Error("notAllowed"));let r="conferences?format=full&userId="+this.contactService.userContact.dbId;angular.isDefined(t)&&(r+="&scheduled="+t),this.$http({method:"GET",url:this.confProvPortalURL+r,headers:this.authService.getRequestHeader()}).then(t=>{let n=t.data.data;for(let e of n)switch(e.mediaType){case this.MEDIATYPE.PSTNAUDIO:this.pstnConferenceService.updateOrCreatePstnConferenceEndpoint(e);break;case this.MEDIATYPE.WEBRTC:case this.MEDIATYPE.WEBRTCSHARINGONLY:this.webConferenceService.updateOrCreateWebConferenceEndpoint(e)}this.$log.info("[ConferenceService] retrieveConferences successfully"),e(n)},e=>{let t="retrieveConferences failure: "+(e.data?e.data.errorDetails:e.data);this.$log.error("[ConferenceService] "+t),n(new Error(t))})})}retrieveConference(e){return this.$log.info("[ConferenceService] retrieveConference"),e?this.$q((t,n)=>this.pstnConferenceService.pstnConferenceEndpoints[e]?void t(this.pstnConferenceService.pstnConferenceEndpoints[e]):this.webConferenceService.conferenceEndpoints[e]?void t(this.webConferenceService.conferenceEndpoints[e]):void this.$http({method:"GET",url:this.confProvPortalURL+"conferences/"+e,headers:this.authService.getRequestHeader()}).then(e=>{let n=e.data.data;if(n&&n.hasOwnProperty("id")){let e=this.Conference.createFromData(n);n.mediaType===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.pstnConferenceEndpoints[n.id]=e:this.webConferenceService.conferenceEndpoints[n.id]=e}this.$log.info("[ConferenceService] retrieveConference successfully"),t(n)},e=>{let t="retrieveConference failure: "+(e.data?e.data.errorDetails:e.data);this.$log.error("[ConferenceService] "+t),n(new Error(t))})):(this.$log.warn("[ConferenceService] retrieveConference - missing confID"),this.$q.reject(new Error("retrieveConference - missing confID")))}updateConferenceSession(e,t){this.$log.info("[ConferenceService] updateConferenceSession");let n=$(e).find("conference-state");if(n.length){let e="true"===n.find("active").text(),r="true"===n.find("talker-active").text(),i="true"===n.find("recording-started").text();this.updateState(t,e,r,i)}let r=$(e).find("talkers");if(r.length){let e=[];r.find("participant-id").each((t,n)=>{let r=$(n).text();e.push(r)}),this.updateTalkers(t,e)}let i=$(e).find("participants");if(0===i.length&&(i=$(e).find("updated-participants")),i.length||(i=$(e).find("added-participants")),i.length){let e=[];i.find("participant").each((t,n)=>{let r=$(n),i=r.find("participant-id").text(),a=r.find("jid-im").text(),o=r.find("phone-number").text(),s=r.find("role").text(),c=r.find("mute").text(),l=r.find("hold").text(),d=r.find("cnx-state").text();e.push({participantId:i,jid_im:a,phoneNumber:o,participantRole:s,mute:"on"===c,held:"on"===l,participantState:d})}),0<e.length&&this.createOrUpdateParticipants(t,e)}let a=$(e).find("removed-participants");if(a.length){let e=[];a.find("participant-id").each((t,n)=>{let r=$(n).text();e.push(r)}),this.removeParticipants(t,e)}let o=$(e).find("added-publishers");o.length&&(o.find("publisher").each((e,n)=>{let r=$(n),i=r.find("publisher-id").text(),a=r.find("media-type").text(),o=r.find("jid-im").text();this.addPublisher(t,i,a,o)}),this.$rootScope.$broadcast("ON_CONFERENCE_PUBLISHER_UPDATED",t));let s=$(e).find("removed-publishers");s.length&&(s.find("publisher").each((e,n)=>{let r=$(n),i=r.find("participant-id").text(),a=r.find("media-type").text();for(let e,n=0;n<t.publishers.length;n++)if((e=t.publishers[n]).participantId===i&&e.mediaType===a){t.publishers.splice(n,1);break}}),this.$rootScope.$broadcast("ON_CONFERENCE_PUBLISHER_UPDATED",t));let c=$(e).find("publishers");return c.length&&(c.find("publisher").each((e,n)=>{let r=$(n),i=r.find("publisher-id").text(),a=r.find("media-type").text(),o=r.find("jid-im").text();this.addPublisher(t,i,a,o)}),this.$rootScope.$broadcast("ON_CONFERENCE_PUBLISHER_UPDATED",t)),!0}updateState(e,t,n,r){if(t||this.contactService.resetBusyState(),e.active&&!t){if(this.contactService.userContact.guestMode&&e.type!==this.MEDIATYPE.WEBRTCSHARINGONLY)this.$rootScope.$broadcast("ON_OPEN_POPUP","concludeInvitationEndMeeting");else{let t=this.roomService.findRoomsWithConfId(e.id);if(t&&t.length&&!t[0].owner)switch(e.type){case this.MEDIATYPE.WEBRTCSHARINGONLY:break;case this.MEDIATYPE.PSTNAUDIO:case this.MEDIATYPE.WEBRTC:default:if(e.isParticipantConnectedByJid(this.contactService.userContact.dbId)){let e=_escape(t[0].ownerContact.displayName),n=_escape(t[0].name),r=this.$translate.instant("meetingEndBy",{owner:e,meeting:n});this.$rootScope.$broadcast("GLOBAL_NOTIFY_MESSAGE_EVENT",r)}}else if(t&&t.length&&t[0].owner&&(e.id===this.getPstnInstantConferenceEndpointId()&&this.cleanPersonalMeeting(t[0]),e.type===this.MEDIATYPE.PSTNAUDIO)){let e=t[0].getSFUSharingConfEndpointId(),n=this.webConferenceService.getConferenceSessionById(e);n&&n.isActive()&&this.webConferenceService.stopWebConference(t[0])}}e.participants=[],e.status="ended"}e.updateStateFromData(t,n,r),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",e)}updateTalkers(e,t){e.updateTalkers(t),this.$rootScope.$broadcast("ON_CONFERENCE_TALKER_EVENT",e)}createOrUpdateParticipants(e,t){e.updateParticipants(t).then(t=>{e.participants.find(e=>e.jid_im===this.contactService.userContact.id&&"disconnected"!==e.state)&&e.type!==this.MEDIATYPE.WEBRTCSHARINGONLY&&this.contactService.setBusyState("dnd","audio"),this.$rootScope.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",e),"webrtc"===e.type&&t&&this.$rootScope.$broadcast("ON_WEB_CONFENRECE_PARTICIPANT_JOINED_EVENT",e)})}removeParticipants(e,t){if(e.removeParticipants(t),!e.participants.find(e=>e.jid_im===this.contactService.userContact.id))switch(this.contactService.resetBusyState(),e.type){case this.MEDIATYPE.WEBRTC:if(this.webConferenceService.removeAllJingleSessionsForConferenceSession(e.id),e.active){let t=this.roomService.findRoomsWithConfId(e.id);if(t.length){let e=_escape(t[0].name),n=this.$translate.instant("meetingDisconnect",{meeting:e});this.$rootScope.$broadcast("GLOBAL_NOTIFY_MESSAGE_EVENT",n)}}e.cleanupSessionData();break;case this.MEDIATYPE.WEBRTCSHARINGONLY:this.webConferenceService.removeAllJingleSessionsForConferenceSession(e.id),e.cleanupSessionData();break;case this.MEDIATYPE.PSTNAUDIO:}this.$rootScope.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",e)}addPublisher(e,t,n,r){let i=!0;for(let r,a=0;a<e.publishers.length;a++)if((r=e.publishers[a]).participantId===t&&r.mediaType===n){i=!1;break}let a={participantId:t,mediaType:n,jid_im:r};if(i&&e.publishers.push(a),i&&"video"===n){let n=this.webConferenceService.getFreeVideoGalleryElement(e.id);n&&!this.webConferenceService.isAlreadySubscribedToPublisher(e.id,a.participantId)&&(this.$log.info("[ConferenceService] subscribe to publisher "+e.id+" for id "+t+"and element id "+n.id),n.state="busy",n.publisherId=a.participantId,this.$interval((e,t,r)=>{this.$log.info("[ConferenceService] subscribe to publisher "+e.id+" for id "+t.participantId+"and element id "+n.id),this.subscribeToPublisher(e.id,t,r).catch(()=>{this.$log.error("[ConferenceService] subscribe to publisher failed, reset the video gallery element with id "+r),this.webConferenceService.reInitialiseVideoGalleryElementById(e,r)})},2500,1,!0,e,a,n.id))}}stopConference(e="",t=this.MEDIATYPE.PSTNAUDIO,n=""){if(this.$log.info("[ConferenceService] stopConference( confId="+e+", type="+t+")"),!e||!n&&t!==this.MEDIATYPE.PSTNAUDIO)return this.$log.warn("[ConferenceService] stopConference missing conf ID or roomID"),this.$q.reject();let r=this.pstnConferenceService.conferenceSessions[e]?this.pstnConferenceService.conferenceSessions[e]:this.webConferenceService.conferenceSessions[e];return r&&r.isActive()?this.$q((r,i)=>{this.$http({method:"PUT",url:this.confPortalURL+e+"/stop",headers:this.authService.getPostHeader(),data:{mediaType:t,roomId:n}}).then(()=>{this.contactService.resetBusyState();let n=null;(n=t===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.conferenceSessions[e]:this.webConferenceService.conferenceSessions[e])&&(this.updateState(n,!1,!1,!1),n.cleanupSessionData(),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",n)),this.$log.info("[ConferenceService] stopConference( confId="+e+") successfully"),r()},n=>{let r=n.data?n.data.errorDetails:n.data,a="stopConference( confId="+e+") failure: "+r;if(this.$log.error("[ConferenceService] "+a),404e3!==n.data.errorDetailsCode)this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"warning",popupBody:"stopMeetingFailure",okLabel:"ok"});else{let n=null;(n=t===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.conferenceSessions[e]:this.webConferenceService.conferenceSessions[e])&&(n.active=!1,n.participants=[],this.removeConferenceSession(n),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",n))}i(new Error(a))})}):(this.$log.warn("[ConferenceService] stopConference - no active conference session to stop"),this.$q.reject())}removeConferenceSession(e=null){e&&(e.type===this.MEDIATYPE.WEBRTC||e.type===this.MEDIATYPE.WEBRTCSHARINGONLY?this.webConferenceService.removeConferenceSession(e.id):delete this.pstnConferenceService.conferenceSessions[e.id])}disconnectsParticipant(e,t,n=this.MEDIATYPE.PSTNAUDIO){return e&&t?this.$q((r,i)=>{this.$log.info("[ConferenceService] disconnectsParticipant( confId="+e+"participantId="+t+")"),this.$http({method:"DELETE",url:this.confPortalURL+e+"/participants/"+t+"?mediaType="+n,headers:this.authService.getRequestHeader()}).then(()=>{this.$log.info("[ConferenceService] disconnectsParticipant( confId="+e+"participantId="+t+") successfully"),r()},n=>{let r=n.data?n.data.errorDetails:n.data,a="disconnectsParticipant( confId="+e+"participantId="+t+") failure: "+r;this.$log.error("[ConferenceService] "+a),i(new Error(a))})}):(this.$log.warn("[ConferenceService] disconnectsParticipant missing conf ID or participantId"),this.$q.reject())}updateConference(e,t,n=this.MEDIATYPE.PSTNAUDIO){return n===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.updateConference(e,t):void this.webConferenceService.updateConference(e,t)}updateConferenceState(e,t,n=this.MEDIATYPE.PSTNAUDIO){return this.$log.info("[ConferenceService] updateConferenceState( confId="+e+", option="+t+" mediaType="+n+")"),e&&t?this.$q((r,i)=>{let a=null;return(a=n===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.conferenceSessions[e]:this.webConferenceService.conferenceSessions[e])?void this.$http({method:"PUT",url:this.confPortalURL+e+"/update",headers:this.authService.getRequestHeader(),data:{option:t,mediaType:a.type}}).then(t=>{let n=t.data.data;this.$log.info("[ConferenceService] updateConferenceState( confId="+e+") successfully"),r(n)},t=>{let n=t.data?t.data.errorDetails:t.data,r="updatsConferenceState( confId="+e+") failure: "+n;this.$log.error("[ConferenceService] "+r),i(new Error(r))}):(this.$log.error("[ConferenceService] updateConferenceState - no corresponding conference session to update"),void i())}):(this.$log.error("[ConferenceService] updateConferenceState - missing a parameter"),this.$q.reject())}updateParticipantState(e,t,n,r=this.MEDIATYPE.PSTNAUDIO){return this.$log.info("[ConferenceService] updateParticipantState( confId="+e+"participantId="+t+" option="+n+" mediaType="+r+")"),e&&t&&n?this.$q((i,a)=>{let o=null;return(o=r===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.conferenceSessions[e]:this.webConferenceService.conferenceSessions[e])?void this.$http({method:"PUT",url:this.confPortalURL+e+"/participants/"+t,headers:this.authService.getRequestHeader(),data:{option:n,mediaType:o.type}}).then(n=>{let r=n.data.data;this.$log.info("[ConferenceService] updateParticipantState( confId="+e+"participantId="+t+") successfully"),i(r)},n=>{let r=n.data?n.data.errorDetails:n.data,i="updateParticipantState( confId="+e+"participantId="+t+") failure: "+r;this.$log.error("[ConferenceService] "+i),a(new Error(i))}):(this.$log.error("[ConferenceService] updateParticipantState - no corresponding conference session to update"),void a())}):(this.$log.error("[ConferenceService] updateParticipantState - missing a parameter"),this.$q.reject())}retrievePstnPhoneNumbers(e=!1){return this.pstnConferenceService.retrievePstnPhoneNumbers(e)}joinPstnConference(e,t,n,r,i){return this.$q((a,o)=>(this.$log.info("[ConferenceService] joinPstnConference with ( confId = "+e+" participantPhoneNumber = "+t+" country = "+r+" )"),e&&i?void this.makeSnapshotForConfId(e,this.MEDIATYPE.PSTNAUDIO).then(()=>{a(this.pstnConferenceService.initiatesCallParticipant(e,t,n,r))},()=>{o(new Error("[ConferenceService] joinPstnConference - error retrieving conference session details"))}):(this.$log.error("[ConferenceService] joinPstnConference - missing parameter"),void o(new Error("[ConferenceService] joinPstnConference - missing parameter")))))}cleanPersonalMeeting(e,t=!1){if(this.isCleaningPersonalMeeting)return this.$log.debug("[ConferenceService] cleanPersonalMeeting - Already cleaning"),this.$q.resolve();this.isCleaningPersonalMeeting=!0;let n=e.getSFUSharingConfEndpointId(),r=this.webConferenceService.getConferenceSessionById(n);return r&&r.isActive()&&this.webConferenceService.stopWebConference(e),this.$q(n=>{let r=e.name;return this.$log.debug("[ConferenceService] cleanPersonalMeeting - Detaching conference endpoint from room: ",r),this.roomService.deleteRoomConferenceEndPoint(e,this.getPstnInstantConferenceEndpointId()).then(t=>404===t?(this.$log.debug("[ConferenceService] cleanPersonalMeeting - Conference already detached from personal meeting"),this.isCleaningPersonalMeeting=!1,this.$q.reject()):(this.$log.debug("[ConferenceService] cleanPersonalMeeting - Updating name of old personal meeting"),e.name="["+moment().format("L").replace(new RegExp("[^.]?"+moment().format("YYYY")+".?"),"")+" - "+moment().format("HH:mm")+"] "+r,this.roomService.ownerUpdateRoomNameAndDescription(e))).then(()=>(this.$log.debug("[ConferenceService] cleanPersonalMeeting - Archive old personal meeting"),this.roomService.ownerArchiveRoom(e))).then(()=>(this.$log.debug("[ConferenceService] cleanPersonalMeeting - Create room to host new personal meeting"),this.roomService.createRoom(r,e.desc,"none",null,!0,"pstnAudio"))).then(e=>(this.$log.debug("[ConferenceService] cleanPersonalMeeting - Attach conference endpoint to meeting"),this.roomService.addRoomConferenceEndPoint(e,this.getPstnInstantConferenceEndpoint(),this.MEDIATYPE.PSTNAUDIO))).then(e=>(this.$log.debug("[ConferenceService] cleanPersonalMeeting - Binding open-invite to new personal meeting"),this.roomService.bindOpenInviteToRoom(e.dbId,this.contactService.userContact.getOpenInviteId()))).then(()=>{this.isCleaningPersonalMeeting=!1,t?(this.$log.debug("[ConferenceService] cleanPersonalMeeting - Reset open-invite"),this.contactService.resetOpenInviteId().then(()=>{this.$log.debug("[ConferenceService] cleanPersonalMeeting - Reset conference codes of new personal meeting"),this.updateConference(this.getPstnInstantConferenceEndpointId(),{resetPasswords:!0},"pstnAudio").then(()=>{n()})})):n()}).catch(()=>{this.isCleaningPersonalMeeting=!1,this.$log.error("[ConferenceService] Something went wrong when trying to regenerate new personal meeting"),n()})})}initializePersonalMeeting(){return this.$q(e=>this.roomService.retrieveOpenInviteRoom().then(t=>{t&&t.isMeetingRoom()&&!t.conference.scheduled&&t.getPstnConfEndpointId()?e(t):(this.$log.warn("[ConferenceService] Open-Invite room does not meet the requirements, regenerating it ..."),e(this.cleanPersonalMeeting(t)))}).catch(()=>{this.$log.warn("[ConferenceService] initializePersonalMeeting - something went wrong"),e()}))}retrievePersonalMeeting(){return this.$q((e,t)=>this.roomService.retrieveOpenInviteRoom().then(t=>{e(t)}).catch(()=>this.pstnConferenceService.isPstnConferenceAvailable?(this.$log.warn("[ConferenceService] retrievePersonalMeeting - Creating room and attaching open-invite-id"),this.roomService.createRoom(this.$translate.instant("namePersonalConference",{name:this.contactService.userContact.displayName}),"","none",null,!0,"pstnAudio").then(e=>this.roomService.addRoomConferenceEndPoint(e,this.getPstnInstantConferenceEndpoint(),this.MEDIATYPE.PSTNAUDIO)).then(e=>this.roomService.bindOpenInviteToRoom(e.dbId,this.contactService.userContact.getOpenInviteId())).then(t=>{e(t)}).catch(()=>{t(new Error("[ConferenceService] retrievePersonalMeeting - error regenerating personal meeting"))})):void t(new Error("[ConferenceService] retrievePersonalMeeting - not enough priviledges"))))}subscribeToPublisher(e="",t=null,n=""){return this.$q((r,i)=>e&&t?(this.$log.info("[ConferenceService] subscribeToPublisher for confId "+e+" and publisher "+t.participantId),n&&this.webConferenceService.relatePublisherToElement(e,t,n),void this.$http({method:"POST",url:this.confPortalURL+e+"/participants/"+t.participantId+"/subscribe",headers:this.authService.getRequestHeader()}).then(e=>{this.$log.info("[ConferenceService] subscribeToPublisher successfully"),r(e.data)},e=>{let t="subscribeToPublisher failure: "+(e.data?e.data.errorDetails:e.data);this.$log.error("[ConferenceService] "+t),i(new Error(t))})):(this.$log.warn("[ConferenceService] subscribeToPublisher missing parameters !! Ignore !"),void r()))}isUserContactInCall(){for(let e in this.webConferenceService.conferenceSessions)if(this.webConferenceService.conferenceSessions.hasOwnProperty(e)){if(this.webConferenceService.conferenceSessions[e].isParticipantConnectedByJid(this.contactService.userContact.jid))return!0}return!1}stopAllConferencesFromRoom(e){var t=[],n=e.getPstnConfEndpointId(),r=e.getSFUSharingConfEndpointId(),i=e.getSFUConfEndpointId();return n&&t.push(this.stopConference(n)),r&&t.push(this.stopConference(r,"webrtc")),i&&t.push(this.stopConference(i,"webrtc")),this.$q.all(t)}refreshConferenceSessions(){let e=[this.webConferenceService.refreshConferenceSessions(),this.pstnConferenceService.refreshConferenceSessions()];return this.$q.all(e)}}e.$inject=["$q","$log","$rootScope","$interval","$translate","$http","xmppService","authService","Conference","profileService","contactService","webConferenceService","pstnConferenceService","roomService","errorHelperService"],angular.module("rainbow").service("conferenceService",e)},function(){angular.module("rainbow").service("profileService",["$q","$rootScope","$log","$http","$interval","Offer","authService","contactService","xmppService",function(e,t,n,r,i,a,o,s,c){"use strict";var l=this;l.FeaturesEnum={COMPANY_ADMIN_COUNT:"COMPANY_ADMIN_COUNT",COMPANY_LOGO_MODIFICATION:"COMPANY_LOGO_MODIFICATION",COMPANY_DOMAIN_NAME_MODIFICATION:"COMPANY_DOMAIN_NAME_MODIFICATION",COMPANY_DETAILS_MODIFICATION:"COMPANY_DETAILS_MODIFICATION",COMPANY_SINGLE_SIGN_ON_SAML:"COMPANY_SINGLE_SIGN_ON_SAML",WEBRTC_FOR_MOBILE:"WEBRTC_FOR_MOBILE",BUBBLE_PARTICIPANT_COUNT:"BUBBLE_PARTICIPANT_COUNT",TELEPHONY_BASIC_CALL:"TELEPHONY_BASIC_CALL",TELEPHONY_SECOND_CALL:"TELEPHONY_SECOND_CALL",TELEPHONY_TRANSFER_CALL:"TELEPHONY_TRANSFER_CALL",TELEPHONY_CONFERENCE_CALL:"TELEPHONY_CONFERENCE_CALL",TELEPHONY_DEFLECT_CALL:"TELEPHONY_DEFLECT_CALL",TELEPHONY_PHONE_BOOK:"TELEPHONY_PHONE_BOOK",TELEPHONY_VOICE_MAIL:"TELEPHONY_VOICE_MAIL",TELEPHONY_CALL_FORWARD:"TELEPHONY_CALL_FORWARD",TELEPHONY_NOMADIC:"TELEPHONY_NOMADIC",CONFERENCE_PARTICIPANT_COUNT:"CONFERENCE_PARTICIPANT_COUNT",CONFERENCE_PARTICIPANT_ALLOWED:"CONFERENCE_PARTICIPANT_ALLOWED",WEBRTC_CONFERENCE_ALLOWED:"WEBRTC_CONFERENCE_ALLOWED",WEBRTC_CONFERENCE_PARTICIPANT_COUNT:"WEBRTC_CONFERENCE_PARTICIPANT_COUNT",WEBRTC_PARTICIPANT_ALLOWED:"WEBRTC_PARTICIPANT_ALLOWED",CONFERENCE_ALLOWED:"CONFERENCE_ALLOWED",CONFERENCE_DIAL_OUT:"CONFERENCE_DIAL_OUT",CONFERENCE_RECORDING:"CONFERENCE_RECORDING",MSO365_CALENDAR_PRESENCE:"MSO365_CALENDAR_PRESENCE",MSO365_DIRECTORY_SEARCH:"MSO365_DIRECTORY_SEARCH",MS_OUTLOOK_PLUGIN:"MS_OUTLOOK_PLUGIN",MS_SKYPE_PLUGIN:"MS_SKYPE_PLUGIN",FILE_SHARING_QUOTA_GB:"FILE_SHARING_QUOTA_GB",GOOGLE_CALENDAR_PRESENCE:"GOOGLE_CALENDAR_PRESENCE",WEBRTC_P2P_RECORDING:"WEBRTC_P2P_RECORDING",BUBBLE_PROMOTE_MEMBER:"BUBBLE_PROMOTE_MEMBER",BUBBLE_GUESTS_ALLOWED:"BUBBLE_GUESTS_ALLOWED",TELEPHONY_WEBRTC_GATEWAY:"TELEPHONY_WEBRTC_GATEWAY",TELEPHONY_WEBRTC_PSTN_CALLING:"TELEPHONY_WEBRTC_PSTN_CALLING",ANALYTICS_DASHBOARD_EC:"ANALYTICS_DASHBOARD_EC",ANALYTICS_DASHBOARD_BP:"ANALYTICS_DASHBOARD_BP",TELEPHONY_CALL_SUBJECT:"CALL_SUBJECT",CHANNEL_CREATE:"CHANNEL_CREATE",CHANNEL_CREATE_ADMIN_ROLE_BYPASS:"CHANNEL_CREATE_ADMIN_ROLE_BYPASS",CHANNEL_ACTIVATED:"CHANNEL_ACTIVATED",MANAGE_ANDROID_TV:"MANAGE_ANDROID_TV"},l.started=!1,l.start=function(r){n.info(""),n.info("[profileService] === STARTING ==="),l.features={},l.profiles=[],l.mainOffers=[];var i=performance.now();return l.attachHandlers(),e(function(e,a){l.getServerProfile().then(function(){l.started=!0;var a=Math.round(performance.now()-i);r.push({service:"profileService",startDuration:a}),n.info("[profileService] === STARTED ("+a+" ms) ==="),t.$broadcast("ON_PROFILE_FEATURES_UPDATED"),e()}).catch(function(e){n.info("[profileService] === STARTING FAILURE === "+e.message),a(e)})})},l.stop=function(){return n.info("[profileService] === STOPPING ==="),l.detachHandlers(),l.started=!1,n.info("[profileService] === STOPPED ==="),e.when()},l.attachHandlers=function(){l.detachHandlers(),n.info("[profileService] attachHandlers"),this.profileEventHandler=c.addHandler(l.onManagementMessageReceived,null,"message","management")},l.detachHandlers=function(){n.info("[profileService] detachHandlers"),this.profileEventHandler&&(c.deleteHandler(this.profileEventHandler),this.profileEventHandler=null)},l.restart=function(){n.info("[profileService] === RESTART ==="),l.attachHandlers(),l.onUserUpdateNeeded()},l.onManagementMessageReceived=function(e){try{var t=$(e).find("userprofile");if(n.info("[profileService] onManagementMessageReceived  -- on userprofile management message received"),t.length)switch(t.attr("action")){case"create":case"update":case"delete":l.onUserUpdateNeeded();break;default:n.info("[profileService] onManagementMessageReceived  -- unknown action")}return!0}catch(e){return n.error("[profileService] onManagementMessageReceived ERROR "+e),!0}},l.onUserUpdateNeeded=function(){l.timer||(l.timer=i(function(){l.getServerProfile().then(function(){t.$broadcast("ON_PROFILE_FEATURES_UPDATED"),l.timer=null}).catch(function(e){l.timer=null,n.info("[profileService] === onUserUpdateNeeded FAILURE === "+e.message)})},3e3,1))},l.getServerProfile=function(){return e.all([l.getServerProfiles(),l.getServerProfilesFeatures()])},l.getServerProfiles=function(){return e(function(e,t){r({method:"GET",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+s.userContact.dbId+"/profiles",headers:o.getRequestHeader()}).then(function(t){l.profiles=[],l.mainOffers=[],t.data.data.forEach(function(e){n.debug("[profileService] getServerProfiles === response ==="+e),l.profiles.push(e);var t=a.createFromProfileData(e);(t.isExclusive||t.isDefault)&&l.mainOffers.push(t)}),l.mainOffers.sort(a.offerComparator),e()},function(e){var r="getServerProfiles failure: no server response";e&&(r="getServerProfiles failure: "+JSON.stringify(e)),n.error("[profileService] "+r),t(new Error(r))})})},l.getServerProfilesFeatures=function(){return e(function(e,t){r({method:"GET",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+s.userContact.dbId+"/profiles/features",headers:o.getRequestHeader()}).then(function(t){l.features={},t.data.data.forEach(function(e){n.debug("[profileService] getServerProfilesFeatures === response ==="+JSON.stringify(e)),e.hasOwnProperty("featureUniqueRef")&&(l.features[e.featureUniqueRef]=e)}),e()},function(e){var r="getServerProfilesFeatures failure: no server response";e&&(r="getServerProfilesFeatures failure: "+JSON.stringify(e)),n.error("[profileService] "+r),t(new Error(r))})})},l.getUserData=function(){return o.getUserData()},l.setUserData=function(t){return e(function(e,i){var a=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+s.userContact.dbId;r({method:"PUT",url:a,headers:o.getRequestHeader(),data:t}).then(function(r){n.info("[profileService] setUserData "+JSON.stringify(t)+" -- success"),e(r.data)},function(e){var t="setUserData failure: no server response";e&&(t="setUserData failure: "+JSON.stringify(e)),n.error("[profileService] "+t),i(new Error(t))})})},l.isFeatureEnabled=function(e){if(l.started&&l.features.hasOwnProperty(e)&&l.features[e].hasOwnProperty("featureType")&&"boolean"===l.features[e].featureType&&l.features[e].hasOwnProperty("isEnabled")){var t=l.features[e].isEnabled;return n.debug("[profileService] isFeatureEnabled("+e+"): "+t),t}return n.info("[profileService] isFeatureEnabled("+e+"): service not started or feature not enabled"),!1},l.getFeatureLimitMax=function(e){if(l.started&&l.features.hasOwnProperty(e)&&l.features[e].hasOwnProperty("featureType")&&"number"===l.features[e].featureType&&l.features[e].hasOwnProperty("limitMax")){var t=l.features[e].limitMax;return n.debug("[profileService] getFeatureLimitMax("+e+"): "+t),t}return n.info("[profileService] getFeatureLimitMax("+e+"): service not started or feature not enabled"),0},l.getFeatureLimitMin=function(e){if(l.started&&l.features.hasOwnProperty(e)&&l.features[e].hasOwnProperty("featureType")&&"number"===l.features[e].featureType&&l.features[e].hasOwnProperty("limitMin")){var t=l.features[e].limitMin;return n.debug("[profileService] getFeatureLimitMin("+e+"): "+t),t}return n.info("[profileService] getFeatureLimitMin("+e+"): service not started or feature not enabled"),0},l.getMyProfileOffer=function(){return 0<l.mainOffers.length?l.mainOffers.slice(-1)[0]:null},l.getMyProfileName=function(){var e=this.getMyProfileOffer();return e?e.name:null},l.getMyProfiles=function(){var e=[];return l.started?e=l.profiles:n.warn("[profileService] getMyProfiles(): service not started"),e},l.getMyProfileFeatures=function(){var e={};return l.started?Object.keys(l.features).forEach(function(t){var n=l.features[t],r={};Object.keys(n).filter(function(e){return"featureUniqueRef"===e||"featureType"===e||"limitMin"===e||"limitMax"===e||"isEnabled"===e}).forEach(function(e){r[e]=n[e]}),e[t]=r}):n.warn("[profileService] getMyProfileFeatures(): service not started"),e}}])},function(){angular.module("rainbow").service("updatingService",["$http","$log","$rootScope","$interval","helpersService","centralizedService",function(e,t,n,r,i,a){"use strict";var o=this;o.url=window.location.origin+"/app/"+version+"/js/version.js",o.started=!1,o.start=function(){return t.info("[updatingService] === STARTING ==="),o.started=!0,t.info("[updatingService] === STARTED ==="),-1===o.url.indexOf("localhost")?(o.interval&&r.cancel(o.interval),o.interval=r(o.checkUpdate,6e5),void(a.isDesktopApp()&&(o.intervalDesktop&&r.cancel(o.intervalDesktop),o.intervalDesktop=r(o.checkUpdateForDesktop,6e4)))):void t.info("[updatingService] Do not start on localhost")},o.checkUpdate=function(){t.info("[updatingService] - Checking if a new version is online..."),e({method:"GET",url:o.url+"?rand="+i.randomString()}).then(function(){t.info("[updatingService] - The web client is up to date")},function(e){404===e.status?n.$broadcast("ON_AVAILABLE_UPDATE"):t.info("[updatingService] - An unknow error has been encountered.")})},o.checkUpdateForDesktop=function(){var e=a.containerVersion();if(t.info("[updatingService] - Checking if a new desktop version is available... "+e),!e){var r=navigator.userAgent.substring(navigator.userAgent.indexOf("Rainbow"));r&&(e=r.split("/")[1])}if(e){var i=e.split(".");if(35>parseInt(i[1],10)||35===parseInt(i[1],10)&&4>=parseInt(i[2],10)){t.info("[updatingService] - should update from version "+e);var o={popupTitle:"updatingDesktopTitle",popupBody:"updatingDesktopMessage",okLabel:"download",okLink:config.autorizationMicrosoftLink,blockingPopup:!0};o.okLink=0<=navigator.platform.toUpperCase().indexOf("MAC")?config.clientsURL.mac:config.clientsURL.windows,n.$broadcast("ON_OPEN_GLOBAL_POPUP",o)}}else t.error("[updatingService] - no desktop version found !! ")},o.stop=function(){t.info("[updatingService] === STOPPING ==="),o.started=!1,o.interval&&r.cancel(o.interval),o.intervalDesktop&&r.cancel(o.intervalDesktop),t.info("[updatingService] === STOPPED ===")}}])},function(){function e(e,t,n,r,i,a,o){try{var s=e[a](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,i)}function t(t){return function(){var n=this,r=arguments;return new Promise(function(i,a){function o(t){e(c,i,a,o,s,"next",t)}function s(t){e(c,i,a,o,s,"throw",t)}var c=t.apply(n,r);o(void 0)})}}angular.module("rainbow").service("calendarService",["$q","$rootScope","$log","$http","$interval","authService","contactService","xmppService","errorHelperService","profileService","conversationService","settingsService","$localStorage",function(e,n,r,i,a,o,s,c,l,d,u,h){"use strict";var f=this;this.intervalID=null,this.start=function(t){r.info(""),r.info("[calendarService] === STARTING ===");var i=performance.now();f.autorizationLink="",f.autorizationPopup=null,f.serviceActivated=!1,f.calendaRejectIfBusyActivated=!1,f.calendarPromise=null,r.info("[calendarService] listen 'out of office' status for roster contacts"),a(f.getAutoReplyForEachContact,5e3,1),f.intervalID=a(f.updateAutoReplyForEachContact,9e5),f.officeCalendarPresenceEnabled=d.isFeatureEnabled(d.FeaturesEnum.MSO365_CALENDAR_PRESENCE),f.googleCalendarPresenceEnabled=d.isFeatureEnabled(d.FeaturesEnum.GOOGLE_CALENDAR_PRESENCE),f.calendarPresenceEnabled=f.officeCalendarPresenceEnabled||f.googleCalendarPresenceEnabled,r.info("[calendarService] calendar presence status from profileService : "+f.calendarPresenceEnabled),f.disableCalendarPresencePrompt="true"===h.getSetting("disableCalendarPresence"),r.info("[calendarService] calendar presence prompt status from userSettings : "+!f.disableCalendarPresencePrompt);var o=Math.round(performance.now()-i);return t.push({service:"calendarService",startDuration:o}),r.info("[calendarService] === STARTED ("+o+" ms) ==="),f.calendarPresenceEnabled&&!s.userContact.guestMode&&(f.attachHandlers(),f.calendarPresenceChangeListener=n.$on("ON_ROSTER_PRESENCE_CHANGED_EVENT",f.onCalendarPresenceChange),f.connectionStateChangeListener=n.$on("ON_CONNECTION_STATE_CHANGE_EVENT",f.onConnectionStateChange),f.calendarInfosPromise()),e.when()},this.stop=function(){return r.info("[calendarService] === STOPPING ==="),f.serviceActivated=!1,f.calendarPresenceChangeListener&&f.calendarPresenceChangeListener(),f.connectionStateChangeListener&&f.connectionStateChangeListener(),this.messageHandlerRef&&(c.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),f.intervalID&&a.cancel(f.intervalID),r.info("[calendarService] === STOPPED ==="),e.when()},this.calendarInfosPromise=t(regeneratorRuntime.mark(function e(){var t,n,i,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=null,e.prev=1,e.next=4,f.getCalendarState();case 4:t=e.sent,e.next=13;break;case 7:throw e.prev=7,e.t0=e.catch(1),console.error(e.t0),f.serviceActivated=!1,r.error("[calendarService] === STARTING FAILURE ==="),new Error(e.t0);case 13:if("none"===t.status||"deleted"===t.status){e.next=22;break}return f.serviceActivated=!0,n=t.until?new Date(t.until):null,i=t.busy?"dnd":"online",a=t.busy?"busy":"",f.updateCalendarPresenceForUser(s.userContact.jid,i,n,a),e.abrupt("return",null);case 22:if("consent_required"!==t.status){e.next=27;break}return r.info("[calendarService] calendar status -- "+t.status+" -- showPopup"),e.abrupt("return",f.registerCalendars(!1));case 27:if(f.disableCalendarPresencePrompt){e.next=32;break}return r.info("[calendarService] calendar status -- "+t.status+" -- showPopup"),e.abrupt("return",f.registerCalendars(!1));case 32:return e.abrupt("return",null);case 33:case"end":return e.stop()}},e,null,[[1,7]])})),this.attachHandlers=function(){r.info("[calendarService] attachHandlers"),this.messageHandlerRef&&(c.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),this.messageHandlerRef=c.addHandler(function(e){return f.onUpdateMessageReceived(e),!0},"jabber:iq:configuration","message",null)},this.onConnectionStateChange=function(e,t){"connected"===t&&(r.info("[calendarService] onConnectionStateChange state:"+t),f.getCalendarState().then(function(e){if("none"!==e.status&&"deleted"!==e.status&&"consent_required"!==e.status){f.serviceActivated=!0;var t=new Date(e.until),n=e.busy?"dnd":"online",r=e.busy?"busy":"";f.updateCalendarPresenceForUser(s.userContact.jid,n,t,r)}}))},this.onUpdateMessageReceived=function(e){var t=$(e).find("calendar");if(t.length){var i=t.attr("status");r.info("[calendarService] onUpdateMessageReceived with status : "+i),f.serviceActivated="enabled"===i,n.$broadcast("ON_CALENDAR_STATUS_CHANGE",f.serviceActivated)}return!0},this.onCalendarPresenceChange=function(e,t){if(s.isTelJid(t.jid)&&"calendar"===s.getRessourceFromJid(t.jid)){var n=s.getImJid(t.jid);n&&(r.info("[calendarService] onCalendarPresenceChange -- status: "+t.status+" -- until: "+t.until+" -- message: "+t.message),f.updateCalendarPresenceForUser(n,t.status,t.until,t.message))}},this.updateAutoReplyForEachContact=function(){f.getAutoReplyInfoForContact(s.userContact),f.getAutoReplyForEachContact()},this.getAutoReplyForEachContact=function(){r.info("[calendarService] getAutoReplyForEachContact"),u.getConversations().forEach(function(e){null!==e.contact&&f.getAutoReplyInfoForContact(e.contact)})},this.getAutoReplyInfoForContact=function(t){return e(function(e,n){if(!t.calendarState.status)return r.info("[calendarService] getAutoReplyInfoForContact user has no calendar state"),void e();if(t.calendarState.lastUpdate){var a=moment.duration(t.calendarState.lastUpdate.diff(moment()));if(15>Math.abs(Math.floor(a.asMinutes())))return r.info("[calendarService] getAutoReplyInfoForContact state has been updated in the last 15min"),void e()}t.calendarState.lastUpdate=moment(),i({method:"GET",url:config.restServerUrl+"/api/rainbow/calendar/v1.0/automatic_reply?userid="+t.jid,headers:o.getRequestHeader()}).then(function(n){f.treatOutOfOfficeState(n.data,t),r.info("[calendarService] getAutoReplyInfoForContact success for contact "+t.jid),e()},function(e){var t=l.handleError(e);r.error("[calendarService] "+l.getErrorFullMessage(e,"getAutoReplyInfoForContact")),n(t)})})},this.getCalendarState=function(){return e(function(e,t){i({method:"GET",url:config.restServerUrl+"/api/rainbow/calendar/v1.0",headers:o.getRequestHeader()}).then(function(t){r.info("[calendarService] getCalendarState success -- status "+t.data.status),e(t.data)},function(){r.error("[calendarService] getCalendarState failure -- CalendarService portal not responding"),t()})})},this.registerCalendars=function(t){return e(function(n){if(f.serviceActivated)r.warn("[calendarService] registerCalendars -- already registered, ignore !"),n();else{r.info("[calendarService] registerCalendars");var i=[];f.officeCalendarPresenceEnabled&&i.push(f.getCalendarRegistrationInfo("office365")),f.googleCalendarPresenceEnabled&&i.push(f.getCalendarRegistrationInfo("googleCalendar")),e.all(i).finally(function(){f.autorizationGoogleLink||f.autorizationMicrosoftLink?(r.info("[calendarService] registerCalendars -- show registration popup or tooltip"),n({authentMicrosoftUrl:f.autorizationMicrosoftLink,authentGoogleUrl:f.autorizationGoogleLink,fromSettings:t})):(r.error("[calendarService] registerCalendars -- no calendar provider response"),n())})}})},this.getCalendarRegistrationInfo=function(t){var n="o365",a="office365";return"googleCalendar"===t&&(n="gcal",a="google"),e(function(e,s){var c=h.getAppliLanguage().code;i({method:"POST",url:config.restServerUrl+"/api/rainbow/calendar/v1.0/register",headers:o.getRequestHeader(),data:{type:a,callback:window.location.origin+"/redirectO365.html?provider="+n+"&lang="+c}}).then(function(n){r.info("[calendarService] getCalendarRegistrationInfo for "+t+" -- success"),f.autorizationLink=n.data.url,"googleCalendar"===t?f.autorizationGoogleLink=f.autorizationLink:f.autorizationMicrosoftLink=f.autorizationLink,e(f.autorizationLink)},function(e){r.error("[calendarService] getCalendarRegistrationInfo failure"),r.error(e),s()})})},this.deactivateCalendar=function(){return r.info("[calendarService] deactivateCalendar"),e(function(e,t){i({method:"DELETE",url:config.restServerUrl+"/api/rainbow/calendar/v1.0",headers:o.getRequestHeader()}).then(function(){r.info("[calendarService] deactivateCalendar success"),f.serviceActivated=!1,e()},function(e){r.error("[calendarService] deactivateCalendar failure"),r.error(e),t()})})},this.updateCalendarPresenceForUser=function(e,t,i,a){s.getOrCreateContact(e).then(function(o){o.calendarState.status=t,o.calendarState.message=a;var c=null;"online"===t||i||(i=new Date),i&&(c=moment(i)),o.calendarState.mdate=c,c?c.isSame(moment(),"d")?(o.calendarState.until=c.format("LT"),o.calendarState.untilDate=!1):(o.calendarState.until=c.format("ll"),o.calendarState.untilDate=!0):(!i&&(i=new Date),o.calendarState.until=i,o.calendarState.untilDate=!1),s.isUserContact(o)?(r.info("[calendarService] updateCalendarPresenceForUser for my user : "+t+" until "+i),!f.serviceActivated&&"offline"!==t&&(f.serviceActivated=!0,n.$broadcast("ON_CALENDAR_STATUS_CHANGE",f.serviceActivated)),f.getAutoReplyInfoForContact(s.userContact)):r.info("[calendarService] updateCalendarPresenceForUser for user : "+e+" with : "+t+" until "+i),n.$broadcast("ON_CONTACT_CALENDAR_STATUS_CHANGE",o)}).catch(function(t){r.error("[calendarService] updateCalendarPresenceForUser failure for user "+e+" with error : "+t)})},this.treatOutOfOfficeState=function(e,t){if(r.info("[calendarService] treatOutOfOfficeState for user : "+t.jid+" with data enabled "+e.enabled+" and text "+e.message_text+" and date end "+e.end),e.enabled){if(t.calendarState.autoReplyOn=!0,t.calendarState.autoReplyInfos={},e.message_text&&(t.calendarState.autoReplyInfos.message=e.message_text),e.end){var i=moment(e.end);t.calendarState.autoReplyInfos.mdate=i,i?i.isSame(moment(),"d")?(t.calendarState.autoReplyInfos.until=i.format("LT"),t.calendarState.autoReplyInfos.untilDate=!1):(t.calendarState.autoReplyInfos.until=i.format("ll"),t.calendarState.autoReplyInfos.untilDate=!0):(t.calendarState.autoReplyInfos.until=e.end,t.calendarState.autoReplyInfos.untilDate=!0)}n.$broadcast("ON_CALENDAR_STATUS_CHANGE",f.serviceActivated)}else t.calendarState.autoReplyOn=!1,t.calendarState.autoReplyInfos={};n.$broadcast("ON_CONTACT_CALENDAR_STATUS_CHANGE",t)},this.calendarCancelCallback=function(){f.serviceActivated=!1,h.setSetting("disableCalendarPresence",!0),s.setUserSettings({promptForCalendarPresence:!1}),n.$broadcast("ON_CALENDAR_STATUS_CHANGE",!1)},this.calendarLaterCallback=function(){f.serviceActivated=!1,n.$broadcast("ON_CALENDAR_STATUS_CHANGE",!1)},this.setCalendarRejectIfBusy=function(){f.calendaRejectIfBusyActivated=!1},this.getCalendarRejectIfBusy=function(){return f.calendaRejectIfBusyActivated}}])},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n{constructor(e,t,n,r,i,a,o,s,c){this.$q=e,this.$log=t,this.roomService=n,this.contactService=r,this.pstnConferenceService=i,this.conferenceService=a,this.orderByFilter=o,this.$rootScope=s,this.webConferenceService=c,this.started=!1,this.meetings=[],this.room=null,this.listeners=[]}start(e){return this.$q(t=>{let n=performance.now();this.$log.info("[MeetingService] === STARTING ==="),this.updateMeetingLists(),this.updateAvailableMeetingsState(),this.started=!0;var r=Math.round(performance.now()-n);e.push({service:"MeetingService",startDuration:r}),this.$log.info("[MeetingService] === STARTED ("+r+" ms) ==="),t()})}stop(){return this.$log.info("[MeetingService] === STOPPING ==="),this.meetings=[],this.started&&(this.started=!1),this.listeners&&this.listeners.forEach(e=>{e()}),this.$log.info("[MeetingService] === STOPPED ==="),this.$q.when()}stopActiveConferenceSession(e){return this.$q(t=>{let n=this.pstnConferenceService.getConferenceSessionById(e);n&&n.isActive()?this.conferenceService.stopConference(e,"pstnAudio").finally(()=>{t()}).catch(()=>{this.$log.error("[MeetingService] stopActiveConferenceSession -- Could not stop conference with id: "+e),t()}):t()})}notifyUsersCancelConference(e,t=!1){return this.$q(n=>{let r=e.getPstnConfEndpointId(),i=e.users.map(e=>e.contact),a=e.guestEmails;r&&(0<i.length||0<a.length)?this.roomService.notifyUsersCancelConference(e,i,a,t).finally(()=>{n()}).catch(()=>{this.$log.error("[MeetingService] notifyUsersCancelConference -- Could not notify conference participants of cnacellation of conference with id: "+r)}):n()})}getStartDate(e){return e.conference&&e.conference.scheduled?moment(e.conference.scheduledStartDate):moment(e.creationDate)}sortByDate(e,t){var n=1;return e&&t&&(n=t.value-e.value),n}updateMeetingLists(){this.meetings=[],this.meetings=this.orderByFilter(this.roomService.getRooms().filter(e=>e.isMeetingRoom()&&e.status!==this.roomService.RoomUserStatus.REJECTED&&e.status!==this.roomService.RoomUserStatus.DELETED),this.getStartDate,!0,this.sortByDate)}updateAvailableMeetingsState(){let e=this.getAvailableMeetings(),t=[];for(let n of e)n.owner&&n.confEndpoints.length&&(t=t.concat(n.confEndpoints));this.conferenceService.makeSnapshotsForList(t)}getMeetings(){return this.meetings}getAvailableMeetings(){let e=this.meetings.filter(e=>{let t=e.conference.scheduledEndDate&&moment().isAfter(e.conference.scheduledEndDate),n=!e.getPstnConfEndpointId();return"invited"!==e.status&&e.conference.scheduled&&!t&&!n});return this.meetings.forEach(t=>{t.conference.scheduled||"invited"===t.status||"unsubscribed"===t.status||"none"===t.status||t.owner||e.push(t)}),e}getPastMeetings(){let e=this.meetings.filter(e=>{let t=e.conference.scheduledEndDate&&moment().isAfter(e.conference.scheduledEndDate),n=!e.getPstnConfEndpointId();return e.conference.scheduled&&(t||n)});return this.meetings.forEach(t=>{t.conference.scheduled||"unsubscribed"!==t.status&&"none"!==t.status?!t.conference.scheduled&&!t.getPstnConfEndpointId()&&e.push(t):e.push(t)}),this.orderByFilter(e,this.getStartDate,!1,this.sortByDate)}getMeetingInvitations(){return this.meetings.filter(e=>"invited"===e.status)}getActiveInstantMeeting(){let e=null;return this.updateMeetingLists(),this.meetings.some(t=>{let n=t.getPstnConfEndpointId();if(t.conference&&!t.conference.scheduled&&n){let r=this.pstnConferenceService.getConferenceSessionById(n);if(r&&r.isActive())return e=t,!0}return!1}),e}getActiveMeetings(){let e=[];return this.updateMeetingLists(),e=this.meetings.filter(e=>{let t=e.getPstnConfEndpointId();if(e.conference&&t){let e=this.pstnConferenceService.getConferenceSessionById(t);return!(!e||!e.isActive())}})}retrieveMeetingInformation(e,t=!1){return this.$q(n=>{let r={name:e.name,topic:e.desc,creationDate:e.creationDate,users:e.users,guestEmails:e.guestEmails},i=e.getPstnConfEndpointId();i?this.conferenceService.retrieveConference(i).finally(()=>{let a=this.pstnConferenceService.pstnConferenceEndpoints[i]?this.pstnConferenceService.pstnConferenceEndpoints[i]:e.conference;a&&(r.id=i,r.scheduled=a.scheduled,r.scheduledStartDate=a.scheduledStartDate,r.scheduledEndDate=a.scheduledEndDate,r.scheduledDuration=a.scheduledDuration,r.scheduledTimezone=a.scheduledTimezone,r.lastUpdateDate=a.lastUpdateDate,r.passCodes=a.passCodes?a.passCodes:[]),this.conferenceService.retrievePstnPhoneNumbers(t).then(e=>{r.phoneNumbers=e,n(r)})}).catch(()=>{this.$log.error("[MeetingService] retrieveMeetingInformation -- Could not retrieve conference information of conference with id: "+i)}):n(r)})}findAndDetachConferenceFromRooms(e){return this.$q(t=>{let n=this.roomService.findRoomsWithConfId(e);0<n.length?this.stopActiveConferenceSession(e).then(()=>this.roomService.removeConfIdInAllRooms(n)).finally(()=>{t()}).catch(()=>{this.$log.error("[MeetingService] findAndDetachConferenceFromRooms -- An error occured when detaching conference  "+e)}):t()})}createScheduledMeeting(e,t,n,r,i,a,o,s=!1,c=null){return this.$q((l,d)=>{let u=this.conferenceService.getPstnConferenceUser(),h=null,f=null;return u?(this.$log.debug("[MeetingService] createScheduledMeeting - Creating room"),this.roomService.createRoom(e,t,!0,c).then(t=>(this.$log.debug("[MeetingService] createScheduledMeeting - Room created"),h=t,this.$log.debug("[MeetingService] createScheduledMeeting - Creating conference"),this.conferenceService.createConference(u.id,e,i,a,o))).then(e=>(this.$log.debug("[MeetingService] createScheduledMeeting - Conference created"),f=e,this.$log.debug("[MeetingService] createScheduledMeeting - Associating conference to room"),this.roomService.addRoomConferenceEndPoint(h,f))).then(e=>(h=e,this.$log.debug("[MeetingService] createScheduledMeeting - Conference associated to room"),h.conference={guestEmails:[],mediaType:"pstnAudio",scheduled:!0,scheduledEndDate:a,scheduledStartDate:i,scheduledTimezone:o},this.$log.debug("[MeetingService] createScheduledMeeting - Adding users to room"),this.roomService.addRoomUsers(h,n))).then(e=>{this.$log.debug("[MeetingService] Users added to room"),n.push(this.contactService.userContact),this.$log.debug("[MeetingService] createScheduledMeeting - Notifying confernece participants"),this.roomService.notifyRoomUsersJoinConference(h,n,r,s,!1).then(()=>{this.$log.debug("[MeetingService] createScheduledMeeting - Participants successfully notified")}).catch(()=>{this.$log.error("[MeetingService] createScheduledMeeting - error when sending conference invitation")}),l(e)}).catch(e=>{let t=e&&e.message?e.message:"Unknown error";e&&e.data&&403620===e.data.errorDetailsCode&&(t="meetingMaxLimitReached"),this.$log.error("[MeetingService] createScheduledMeeting - "+t),h&&this.roomService.deleteRoomUsers(h,n).finally(()=>{this.roomService.ownerDeleteRoom(h)}),f&&this.conferenceService.deleteConference(f.id),d(new Error(t))})):(this.$log.error("[MeetingService] createScheduledMeeting - No conference user associated to user"),void d())})}createScheduledMeetingWithConference(e,t,n,r,i,a,o,s,c=!1,l=null){return this.$q((d,u)=>{let h=null,f=null;return this.$log.debug("[MeetingService] createScheduledMeetingWithConference - Creating room"),this.roomService.createRoom(t,n,!0,l).then(n=>(this.$log.debug("[MeetingService] createScheduledMeetingWithConference - Room created"),h=n,this.$log.debug("[MeetingService] createScheduledMeetingWithConference - Updating conference"),this.conferenceService.updateConference(e.id,{name:t,startDate:a,endDate:o,timeZone:s}))).then(e=>(this.$log.debug("[MeetingService] createScheduledMeetingWithConference - Conference updated"),f=e,this.$log.debug("[MeetingService] createScheduledMeetingWithConference - Associating conference to room"),this.roomService.addRoomConferenceEndPoint(h,f))).then(e=>(h=e,this.$log.debug("[MeetingService] createScheduledMeetingWithConference - Conference associated to room"),h.conference={guestEmails:[],mediaType:"pstnAudio",scheduled:!0,scheduledEndDate:o,scheduledStartDate:a,scheduledTimezone:s},this.$log.debug("[MeetingService] createScheduledMeetingWithConference - Adding users to room"),this.roomService.addRoomUsers(h,r))).then(e=>{this.$log.debug("[MeetingService] Users added to room"),r.push(this.contactService.userContact),this.$log.debug("[MeetingService] createScheduledMeetingWithConference - Notifying confernece participants"),this.roomService.notifyRoomUsersJoinConference(h,r,i,c,!1).then(()=>{this.$log.debug("[MeetingService] createScheduledMeetingWithConference - Participants successfully notified")}).catch(()=>{this.$log.error("[MeetingService] createScheduledMeetingWithConference - error when sending conference invitation")}),d(e)}).catch(e=>{let t=e&&e.message?e.message:"Unknown error";e&&e.data&&403620===e.data.errorDetailsCode&&(t="meetingMaxLimitReached"),this.$log.error("[MeetingService] createScheduledMeetingWithConference - "+t),h&&this.roomService.deleteRoomUsers(h,r).finally(()=>{this.roomService.ownerDeleteRoom(h)}),u(new Error(t))})})}updateScheduledMeeting(e,t,n,r,i,a,o,s,c,l,d=!1,u=null){return this.$q((h,f)=>{if(null!=e){let p=[];this.$log.debug("[MeetingService] updateScheduledMeeting - Update conference object"),p.push(this.conferenceService.updateConference(e.getPstnConfEndpointId(),{name:t,startDate:s,endDate:c,timeZone:l}).finally(()=>(this.$log.debug("[MeetingService] updateScheduledMeeting - Update meeting name and description"),e.name=t,e.desc=n,this.roomService.ownerUpdateRoomNameAndDescription(e)))),a&&0<a.length&&(this.$log.debug("[MeetingService] updateScheduledMeeting - Deleting removed users from meeting"),p.push(this.roomService.deleteRoomUsers(e,a))),this.$log.debug("[MeetingService] updateScheduledMeeting - Adding new users to meeting"),r&&0<r.length&&p.push(this.roomService.addRoomUsers(e,r)),u&&(this.$log.debug("[MeetingService] updateScheduledMeeting - Setting avatar of meeting"),p.push(this.roomService.setAvatarRoom({id:e.dbId},u))),this.$q.all(p).finally(()=>{(a&&a.length||o&&o.length)&&(this.$log.debug("[MeetingService] updateScheduledMeeting - Notifying participants removed of cancellation"),this.roomService.notifyUsersCancelConference(e,a,o,d)),this.$log.debug("[MeetingService] updateScheduledMeeting - Notifying participants of update"),r.push(this.contactService.userContact),this.roomService.notifyRoomUsersJoinConference(e,r,i,d,!0),this.updateMeetingLists(),h(this.roomService.getRoomById(e.dbId))}).catch(e=>{let t=e&&e.message?e.message:"Unknown error";this.$log.error("[MeetingService] updateScheduledMeeting - "+t),f()})}else this.$log.error("[MeetingService] updateScheduledMeeting - no meeting to update"),f()})}reScheduleMeeting(e,t,n,r,i,a,o,s,c=!1,l){let d=this.conferenceService.getPstnConferenceUser(),u=null;return d?this.$q(t=>{let n=e.getPstnConfEndpointId();n?(this.$log.debug("[MeetingService] reScheduleMeeting - stopping active session "+n),this.stopActiveConferenceSession(n).then(()=>{this.$log.debug("[MeetingService] reScheduleMeeting - disassociating conference from room "+n),t(this.roomService.deleteRoomConferenceEndPoint(e,n))})):t()}).then(()=>(this.$log.debug("[MeetingService] reScheduleMeeting - Creating conference"),this.conferenceService.createConference(d.id,e.name,a,o,s))).then(t=>(this.$log.debug("[MeetingService] reScheduleMeeting - Conference created"),u=t,this.$log.debug("[MeetingService] reScheduleMeeting - Associating conference to room"),this.roomService.addRoomConferenceEndPoint(e,u))).then(()=>(this.$log.debug("[MeetingService] reScheduleMeeting - Conference associated to room"),this.$log.debug("[MeetingService] reScheduleMeeting - Removing contacts from room"),this.roomService.deleteRoomUsers(e,r))).finally(()=>(this.$log.debug("[MeetingService] reScheduleMeeting - Users deleted from room"),this.$log.debug("[MeetingService] reScheduleMeeting - Setting avatar"),this.roomService.setAvatarRoom({id:e.dbId},l))).finally(()=>(this.$log.debug("[MeetingService] reScheduleMeeting - Avatar set to room"),this.$log.debug("[MeetingService] reScheduleMeeting - Adding users to room"),this.roomService.addRoomUsers(e,t))).finally(()=>(this.$log.debug("[MeetingService] reScheduleMeeting - Users added to room"),this.$log.debug("[MeetingService] reScheduleMeeting - Notifying participants of conference"),t.push(this.contactService.userContact),this.roomService.notifyRoomUsersJoinConference(e,t,n,c,!1))).then(e=>this.roomService.getRoomById(e.dbId)).catch(e=>{let t=e&&e.message?e.message:"Unknown error";return this.$log.error("[MeetingService] reScheduleMeeting - "+t),u&&this.conferenceService.deleteConference(u.id),this.$q.reject()}):(this.$log.error("[MeetingService] reScheduleMeeting - No conference user associated to user"),this.$q.reject())}deleteMeeting(e,t=!1){return e.conference.scheduled?this.deleteScheduledMeeting(e,t):this.roomService.ownerDeleteRoom(e)}endMeeting(e,t=!1){if(e.conference.scheduled)return this.endScheduledMeeting(e,t);{let t=e.getSFUSharingConfEndpointId(),n=this.webConferenceService.getConferenceSessionById(t);return n&&n.isActive()&&this.webConferenceService.stopWebConference(e),this.conferenceService.stopConference(this.conferenceService.getPstnInstantConferenceEndpointId())}}endScheduledMeeting(e,t=!1){let n=e.getSFUSharingConfEndpointId(),r=this.webConferenceService.getConferenceSessionById(n);r&&r.isActive()&&this.webConferenceService.stopWebConference(e);let i=e.getPstnConfEndpointId();if(i){let n=moment(e.conference.scheduledStartDate);return moment().isBefore(n)&&this.notifyUsersCancelConference(e,t),this.stopActiveConferenceSession(i).then(()=>this.roomService.deleteRoomConferenceEndPoint(e,i))}{let e=new Error("[MeetingService] unable to end scheduled meeting: no confEndpoints found");return this.$q.reject(e)}}deleteScheduledMeeting(e,t=!1){return this.endScheduledMeeting(e,t).finally(()=>this.roomService.ownerArchiveRoom(e)).finally(()=>this.roomService.ownerDeleteRoom(e).then(()=>{this.updateMeetingLists(),this.$rootScope.$broadcast("MEETING_DELETE_EVENT",e)})).catch(e=>{let t=e&&e.message?e.message:"Unknown error";return this.$log.error("[MeetingService] deleteScheduledMeeting - "+t),this.$q.reject()})}attendeeExitsMeeting(e){if(e.owner)return this.$q.reject();let t=[],n=e.getPstnConfEndpointId();if(n){let e=this.pstnConferenceService.getConferenceSessionById(n);if(e){let r=e.getConnectedParticipantByJid(this.contactService.userContact.jid);r&&t.push(this.conferenceService.disconnectsParticipant(n,r.participantId,"pstnAudio"))}}return t.push(this.roomService.participantCloseRoom(e)),this.$q.all(t)}acceptMeetingInvitation(e){return this.roomService.acceptRoomInvitation(e).then(()=>(this.conferenceService.makeSnapshotForConfId(e.getPstnConfEndpointId(),"pstnAudio"),this.roomService.getServerRoom(e.dbId)))}declineMeetingInvitation(e){return this.roomService.declineRoomInvitation(e)}startMeeting(e){let t=e.getPstnConfEndpointId();if(t)return this.pstnConferenceService.initiatesAudio(t);{let e=new Error("[MeetingService] No confEndpoint associated to meeting");return this.$log.error(e.message),this.$q.reject()}}updateMeetingName(e,t){let n=e.getPstnConfEndpointId();return this.conferenceService.updateConference(n,{name:t}).finally(()=>(e.name=t,this.roomService.ownerUpdateRoomNameAndDescription(e)))}}n.$inject=["$q","$log","roomService","contactService","pstnConferenceService","conferenceService","orderByFilter","$rootScope","webConferenceService"],angular.module("rainbow").service("meetingService",n)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(129);class i{constructor(e,t,n,r,i,a,o,s){this.$q=e,this.$rootScope=t,this.$log=n,this.fileServerService=r,this.fileStorageService=i,this.xmppService=a,this.$interval=o,this.$window=s,this.started=!1,this.recording=!1,this.upload=!1,this.filename="",this.recordStopOrigin="LOCAL",this.metadataBuf=new ArrayBuffer(0),this.last_duration=0,this.clusterPtrs=[]}start(){return this.started=!1,this.recording=!1,this.recorder=null,this.chunk=null,this.data=new Blob([],{type:"video/webm"}),this.audioContext=null,this.recordFile=null,this.decoder=new r.Decoder,this.reader=new r.Reader,this.initConversationRecordContext(),this.$log.info("[RecordsService] start"),this.$q.when()}stop(){return this.$log.info("[RecordsService stop"),this.started&&(this.started=!1),this.$q.when()}onDataAvailable(e){this.$log.info("[RecordService] >onDataAvailable: size = "+e.data.size),0<e.data.size&&(this.chunk=e.data,this.data=new Blob([this.data,this.chunk],{type:this.chunk.type}))}onStop(){navigator.mediaDevices.getUserMedia&&this.$window.mozRTCPeerConnection?(this.onStopCreateFileFromBlob(this.data),this.updatedBlob=this.data):navigator.mediaDevices.getUserMedia&&this.$window.webkitRTCPeerConnection&&this.injectMetadata(this.chunk).then(e=>{this.updatedBlob=e,this.onStopCreateFileFromBlob(this.updatedBlob)})}onStopCreateFileFromBlob(e){console.log("[RECORD SERVICE] Size of updatedBlob : "+e.size),this.recordFile={name:this.filename,extension:"mp4",size:e.size},this.recording=!1,this.recorder=null,this.chunk=null,this.$rootScope.$broadcast("ON_OPEN_RECORDINGFILESTORAGE_POPUP",this.recordFile,this.recordStopOrigin),this.$rootScope.$broadcast("ON_WEBRTC_RECORD_SAVED",this.recordFile,e,this.recordStopOrigin),this.recordStopOrigin="LOCAL"}readAsArrayBuffer(e){return new Promise((t,n)=>{const r=new FileReader;r.readAsArrayBuffer(e),r.onloadend=(()=>{t(r.result)}),r.onerror=(()=>{n()})})}injectMetadata(e){var t=this.$q.defer();const n=new r.Decoder,i=new r.Reader;return i.logging=!1,i.drop_default_duration=!1,this.readAsArrayBuffer(e).then(a=>{n.decode(a).forEach(e=>{i.read(e)}),i.stop();var o=r.tools.makeMetadataSeekable(i.metadatas,i.duration,i.cues),s=a.slice(i.metadataSize);const c=new Blob([o,s],{type:e.type});t.resolve(c)}),t.promise}closeAudioContext(){this.audioContext&&(this.audioContext.destination&&this.audioContext.destination.disconnect(),"closed"!==this.audioContext.state&&(this.audioContext.close(),this.audioContext=null))}cleanRecord(){!1===this.recording?(this.updatedBlob=null,this.recordFile=null,this.data=null):this.$log.error("[RecordsService] Unexpected record cleaning while recording not stopped")}onError(e){this.$log.error("[RecordService] error : "+e.message||!1),this.recording=!1,this.stopConvTimer(),this.$rootScope.$broadcast("ON_WEBRTC_RECORD_ERROR")}createRecord(e,t="REMOTE",n=!1,i="",a=!1,o){let s=null,c=null,l=null,d=null,u=null,h=null,f=[];this.recorder=null,this.upload=n,this.filename=i;let p=!1,m=null,v=null,g=null,C=null;document.getElementById("largevideo");if(this.decoder=new r.Decoder,this.reader=new r.Reader,this.data=new Blob([],{type:"video/webm"}),this.last_duration=0,this.clusterPtrs=[],o&&MediaRecorder.isTypeSupported(o)?s={mimeType:o}:a?MediaRecorder.isTypeSupported("audio/webm")&&(s={mimeType:"audio/webm"}):MediaRecorder.isTypeSupported("video/webm;codecs=vp8")?s={mimeType:"video/webm; codecs=vp8"}:MediaRecorder.isTypeSupported("video/webm;codecs=vp9")?s={mimeType:"video/webm; codecs=vp9"}:MediaRecorder.isTypeSupported("video/webm;codecs=h264")?s={mimeType:"video/webm; codecs=h264"}:MediaRecorder.isTypeSupported("video/mpeg")&&(s={mimeType:"video/mpeg"}),null==s)return this.$log.error("[RecordsService] Codecs : "+o+" are not available for the navigator"),!1;this.$log.info("[RecordsService] createRecord -- mimeType used "+s.mimeType);var S=this.xmppService.connection.jingle.sessions[e];if(c=this.xmppService.connection.jingle.sessions[e].localStreams,l=S.remoteStreams,p=c&&c.length&&null!==c[0]||l&&l.length&&null!==l[0],null!==this.recorder||!p)return this.$log.error("[RecordsService] Cannot get Stream"),!1;{let e,n=null;for(e=0;e<l.length;e++)l[e]&&null!=l[e]&&"LOCAL"!==t&&(n=e,l[e].getAudioTracks().forEach(t=>{f.push(t),C=e,n=null}),null!=n&&(g=n));for(n=null,e=0;e<c.length;e++)c[e]&&null!=c[e]&&"LOCAL"===t&&(n=e,c[e].getAudioTracks().forEach(t=>{f.push(t),v=e,n=null}),null!==n&&(m=n));if(this.audioContext&&(this.$log.error("[RecordsService] anomaly audio Context not previously released"),this.closeAudioContext()),f.length){this.audioContext=new AudioContext;let e=f.map(e=>this.audioContext.createMediaStreamSource(new MediaStream([e]))),t=this.audioContext.createMediaStreamDestination();e.forEach(e=>e.connect(t)),h=t.stream}if(this.reader.addListener("metadata",({data:e})=>{this.$log.info("[RecordsService] Reader listener metadataBuf")}),this.reader.addListener("duration",({timecodeScale:e,duration:t})=>{this.last_duration=t}),this.reader.addListener("cluster_ptr",e=>{this.clusterPtrs.push(e)}),!a)if(u=new MediaStream,"LOCAL"===t&&null!==m){c[m].getVideoTracks().forEach(e=>{u.addTrack(e)})}else null===g?l[C].getVideoTracks().forEach(e=>{u.addTrack(e)}):l[g].getVideoTracks().forEach(e=>{u.addTrack(e)});d=h&&u?new MediaStream([...h.getTracks(),...u.getTracks()]):h&&!u?h:u,this.recorder=new MediaRecorder(d,s),this.recorder.ondataavailable=this.onDataAvailable.bind(this),this.recorder.onstop=this.onStop.bind(this),this.recorder.onerror=this.onError.bind(this)}return!0}uploadFile(){return this.$q((e,t)=>{let n=this.updatedBlob,r=this.recordFile,i="";!1!==this.recording&&(this.$log.error("[RecordsService] Unexpected uploading file when recording not stopped"),t(i="recording not stopped pb")),0===r.size&&(this.$log.error("[RecordsService] error uploading empty file"),t(i="empty file pb")),this.fileStorageService.createFileDescriptor(r.name,r.extension,r.size).then(r=>{this.fileServerService.uploadAFileByChunk(r,n,void 0,()=>{}).then(()=>{this.$log.info("[RecordsService] uploadFile success"),this.cleanRecord(),e()}).catch(e=>{this.$log.error("[RecordsService] Unexpected error while uploading file",e),t(i="server pb")})}).catch(e=>{this.$log.error("[RecordsService] Unexpected error while creating file descriptor!",e),t(i="file descriptor pb")})})}setRecordStopOrigin(e){e&&""!==e&&(this.recordStopOrigin=e)}localSaveFile(){let e=this.updatedBlob,t=this.recordFile;return!1===this.recording?(this.downloadFile(e,null,null,t.name,!0),void this.cleanRecord()):void this.$log.error("[RecordsService] Unexpected file local storage when recording not stopped")}downloadFile(){this.$log.info("[RecordsService] downloadFile -- default function")}startRecording(e){null!==this.recorder&&(e?this.recorder.start(e):this.recorder.start(),this.recording=!0,this.startConvTimer())}stopRecording(){null!==this.recorder&&(this.recorder.stop(),this.recording=!1,this.closeAudioContext()),this.stopConvTimer(),this.initConversationRecordContext()}pauseResumeRecording(){null!==this.recorder&&("recording"===this.recorder.state?(this.recorder.pause(),this.conversationRecordContext.pause=!0,this.stopConvTimer()):(this.recorder.resume(),this.conversationRecordContext.pause=!1,this.startConvTimer()))}setOnDataAvailableCallback(e){null!==this.recorder&&(this.recorder.ondataavailable=e)}setOnErrorCallback(e){null!==this.recorder&&(this.recorder.onerror=e)}setOnPauseCallback(e){null!==this.recorder&&(this.recorder.onpause=e)}setOnResumeCallback(e){null!==this.recorder&&(this.recorder.onresume=e)}setOnStartCallback(e){null!==this.recorder&&(this.recorder.onstart=e)}setOnStopCallback(e){null!==this.recorder&&(this.recorder.onstop=e)}initConversationRecordContext(){this.conversationRecordContext={conversationId:"",recorder:!1,pause:!1,actualRecordTime:0,updateTimer:null,recordStopSource:"LOCAL"}}getConversationRecordContext(e){return e===this.conversationRecordContext.conversationId?this.conversationRecordContext:null}setConversationRecordContext(e,t,n,r,i){e&&""!==e&&(this.conversationRecordContext.conversationId=e,this.conversationRecordContext.recorder=t&&this.recording,this.conversationRecordContext.pause=n,this.conversationRecordContext.actualRecordTime=r,this.conversationRecordContext.recordStopSource=i)}startConvTimer(){this.conversationRecordContext.updateTimer=this.$interval(()=>{this.conversationRecordContext.actualRecordTime++},1e3)}stopConvTimer(){null!==this.conversationRecordContext.updateTimer&&(this.$interval.cancel(this.conversationRecordContext.updateTimer),this.conversationRecordContext.updateTimer=null)}}i.$inject=["$q","$rootScope","$log","fileServerService","fileStorageService","xmppService","$interval","$window"],angular.module("rainbow").service("recordsService",i)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(130);t.Decoder=r.default;var i=n(16);t.Encoder=i.default;var a=n(139);t.Reader=a.default;var o=n(6);t.tools=o;var s=n(141).version;t.version=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,i=n(6),a=n(15),o=n(6),s=n(17).byEbmlID;!function(e){e[e.STATE_TAG=1]="STATE_TAG",e[e.STATE_SIZE=2]="STATE_SIZE",e[e.STATE_CONTENT=3]="STATE_CONTENT"}(r||(r={}));var c=function(){function e(){this._buffer=new i.Buffer(0),this._tag_stack=[],this._state=r.STATE_TAG,this._cursor=0,this._total=0,this._schema=s,this._result=[]}return e.prototype.decode=function(e){this.readChunk(e);var t=this._result;return this._result=[],t},e.prototype.readChunk=function(e){for(this._buffer=o.concat([this._buffer,new i.Buffer(e)]);this._cursor<this._buffer.length&&(this._state!==r.STATE_TAG||this.readTag())&&(this._state!==r.STATE_SIZE||this.readSize())&&(this._state!==r.STATE_CONTENT||this.readContent()););},e.prototype.getSchemaInfo=function(e){return this._schema[e]||{name:"unknown",level:-1,type:"unknown",description:"unknown"}},e.prototype.readTag=function(){if(this._cursor>=this._buffer.length)return!1;var e=i.readVint(this._buffer,this._cursor);if(null==e)return!1;var t=this._buffer.slice(this._cursor,this._cursor+e.length).reduce(function(e,t,n,r){return e+t*Math.pow(16,2*(r.length-1-n))},0),n=this.getSchemaInfo(t),a={EBML_ID:t.toString(16),schema:n,type:n.type,name:n.name,level:n.level,tagStart:this._total,tagEnd:this._total+e.length,sizeStart:this._total+e.length,sizeEnd:null,dataStart:null,dataEnd:null,dataSize:null,data:null};return this._tag_stack.push(a),this._cursor+=e.length,this._total+=e.length,this._state=r.STATE_SIZE,!0},e.prototype.readSize=function(){if(this._cursor>=this._buffer.length)return!1;var e=i.readVint(this._buffer,this._cursor);if(null==e)return!1;var t=this._tag_stack[this._tag_stack.length-1];return t.sizeEnd=t.sizeStart+e.length,t.dataStart=t.sizeEnd,t.dataSize=e.value,-1===e.value?(t.dataEnd=-1,"m"===t.type&&(t.unknownSize=!0)):t.dataEnd=t.sizeEnd+e.value,this._cursor+=e.length,this._total+=e.length,this._state=r.STATE_CONTENT,!0},e.prototype.readContent=function(){var e=this._tag_stack[this._tag_stack.length-1];if("m"===e.type){if(e.isEnd=!1,this._result.push(e),this._state=r.STATE_TAG,0===e.dataSize){var t=Object.assign({},e,{isEnd:!0});this._result.push(t),this._tag_stack.pop()}return!0}if(this._buffer.length<this._cursor+e.dataSize)return!1;var n=this._buffer.slice(this._cursor,this._cursor+e.dataSize);switch(this._buffer=this._buffer.slice(this._cursor+e.dataSize),e.data=n,e.type){case"u":e.value=n.readUIntBE(0,n.length);break;case"i":e.value=n.readIntBE(0,n.length);break;case"f":e.value=4===e.dataSize?n.readFloatBE(0):8===e.dataSize?n.readDoubleBE(0):(console.warn("cannot read "+e.dataSize+" octets float. failback to 0"),0);break;case"s":e.value=n.toString("ascii");break;case"8":e.value=n.toString("utf8");break;case"b":e.value=n;break;case"d":e.value=i.convertEBMLDateToJSDate(new a.Int64BE(n).toNumber())}if(null===e.value)throw new Error("unknown tag type:"+e.type);for(this._result.push(e),this._total+=e.dataSize,this._state=r.STATE_TAG,this._cursor=0,this._tag_stack.pop();0<this._tag_stack.length;){var o=this._tag_stack[this._tag_stack.length-1];if(0>o.dataEnd)return this._tag_stack.pop(),!0;if(this._total<o.dataEnd)break;if("m"!==o.type)throw new Error("parent element is not master element");t=Object.assign({},o,{isEnd:!0});this._result.push(t),this._tag_stack.pop()}return!0},e}();t.default=c},function(e){var t=function(){return this}();try{t=t||new Function("return this")()}catch(e){"object"==typeof window&&(t=window)}e.exports=t},function(e,t){"use strict";function n(e){var t=e.length;if(0<t%4)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function r(e){return a[63&e>>18]+a[63&e>>12]+a[63&e>>6]+a[63&e]}function i(e,t,n){for(var i,a=[],o=t;o<n;o+=3)i=(16711680&e[o]<<16)+(65280&e[o+1]<<8)+(255&e[o+2]),a.push(r(i));return a.join("")}t.byteLength=function(e){var t=n(e),r=t[0],i=t[1];return 3*(r+i)/4-i},t.toByteArray=function(e){for(var t,r=n(e),i=r[0],a=r[1],c=new s(function(e,t,n){return 3*(t+n)/4-n}(0,i,a)),l=0,d=0<a?i-4:i,u=0;u<d;u+=4)t=o[e.charCodeAt(u)]<<18|o[e.charCodeAt(u+1)]<<12|o[e.charCodeAt(u+2)]<<6|o[e.charCodeAt(u+3)],c[l++]=255&t>>16,c[l++]=255&t>>8,c[l++]=255&t;return 2===a&&(t=o[e.charCodeAt(u)]<<2|o[e.charCodeAt(u+1)]>>4,c[l++]=255&t),1===a&&(t=o[e.charCodeAt(u)]<<10|o[e.charCodeAt(u+1)]<<4|o[e.charCodeAt(u+2)]>>2,c[l++]=255&t>>8,c[l++]=255&t),c},t.fromByteArray=function(e){for(var t,n=e.length,r=n%3,o=[],s=16383,c=0,l=n-r;c<l;c+=s)o.push(i(e,c,c+s>l?l:c+s));return 1==r?(t=e[n-1],o.push(a[t>>2]+a[63&t<<4]+"==")):2==r&&(t=(e[n-2]<<8)+e[n-1],o.push(a[t>>10]+a[63&t>>4]+a[63&t<<2]+"=")),o.join("")};for(var a=[],o=[],s="undefined"==typeof Uint8Array?Array:Uint8Array,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",l=0,d=c.length;l<d;++l)a[l]=c[l],o[c.charCodeAt(l)]=l;o[45]=62,o[95]=63},function(e,t){var n=Math.pow;t.read=function(e,t,r,i,a){var o,s,c=8*a-i-1,l=(1<<c)-1,d=l>>1,u=-7,h=r?a-1:0,f=r?-1:1,p=e[t+h];for(h+=f,o=p&(1<<-u)-1,p>>=-u,u+=c;0<u;o=256*o+e[t+h],h+=f,u-=8);for(s=o&(1<<-u)-1,o>>=-u,u+=i;0<u;s=256*s+e[t+h],h+=f,u-=8);if(0===o)o=1-d;else{if(o===l)return s?NaN:1/0*(p?-1:1);s+=n(2,i),o-=d}return(p?-1:1)*s*n(2,o-i)},t.write=function(e,t,r,i,a,o){var s,c,l,d=8*o-a-1,u=(1<<d)-1,h=u>>1,f=23===a?5.960464477539062e-8:0,p=i?0:o-1,m=i?1:-1,v=0>t||0===t&&0>1/t?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(c=isNaN(t)?1:0,s=u):(s=Math.floor(Math.log(t)/Math.LN2),1>t*(l=n(2,-s))&&(s--,l*=2),2<=(t+=1<=s+h?f/l:f*n(2,1-h))*l&&(s++,l/=2),s+h>=u?(c=0,s=u):1<=s+h?(c=(t*l-1)*n(2,a),s+=h):(c=t*n(2,h-1)*n(2,a),s=0));8<=a;e[r+p]=255&c,p+=m,c/=256,a-=8);for(s=s<<a|c,d+=a;0<d;e[r+p]=255&s,p+=m,s/=256,d-=8);e[r+p-m]|=128*v}},function(e){var t={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==t.call(e)}},function(e,t,n){var r=Math.pow;(function(t){e.exports={readVint:function(e,t){t=t||0;for(var n=1;8>=n&&!(e[t]>=r(2,8-n));n++);if(8<n)throw new Error("Unrepresentable length: "+n+" "+e.toString("hex",t,t+n));if(t+n>e.length)return null;for(var i=e[t]&(1<<8-n)-1,a=1;a<n;a++){if(7===a&&35184372088832<=i&&0<e[t+7])return{length:n,value:-1};i*=256,i+=e[t+a]}return{length:n,value:i}},writeVint:function(e){if(0>e||9007199254740992<e)throw new Error("Unrepresentable value: "+e);for(var n=1;8>=n&&!(e<r(2,7*n)-1);n++);for(var i,a=new t(n),o=1;o<=n;o++)i=255&e,a[n-o]=i,e-=i,e/=256;return a[0]|=1<<8-n,a}}}).call(this,n(11).Buffer)},function(e,t,n){function r(e,t){if(!t)return[e.nextBuffer()];var n,r,i=[],c=e.nextUInt8()+1;if(t===s){if(0!=e.length%c)throw new Error("Fixed-Size Lacing Error");for(r=e.length/c,n=0;n<c;n++)i.push(e.nextBuffer(r));return i}var l=[];if(t===a)for(n=0;n<c-1;n++){var d;r=0;do{r+=d=e.nextUInt8()}while(255===d);l.push(r)}else if(t===o)for(r=e.nextUIntV(),l.push(r),n=1;n<c-1;n++)r+=e.nextIntV(),l.push(r);for(n=0;n<c-1;n++)i.push(e.nextBuffer(l[n]));return i.push(e.nextBuffer()),i}var i=n(137),a=1,o=3,s=2;e.exports=function(e){var t={},n=new i(e);t.trackNumber=n.nextUIntV(),t.timecode=n.nextInt16BE();var a=n.nextUInt8();return t.invisible=!!(8&a),t.keyframe=!!(128&a),t.discardable=!!(1&a),t.frames=r(n,(6&a)>>1),t}},function(e,t,n){function r(e){this.buffer=e,this.offset=0}var i=n(138);r.prototype.nextInt16BE=function(){var e=this.buffer.readInt16BE(this.offset);return this.offset+=2,e},r.prototype.nextUInt8=function(){var e=this.buffer.readUInt8(this.offset);return this.offset+=1,e},r.prototype.nextUIntV=function(){var e=i(this.buffer,this.offset);return this.offset+=e.length,e.value},r.prototype.nextIntV=function(){var e=i(this.buffer,this.offset,!0);return this.offset+=e.length,e.value},r.prototype.nextBuffer=function(e){var t=e?this.buffer.slice(this.offset,this.offset+e):this.buffer.slice(this.offset);return this.offset+=e||this.length,t},Object.defineProperty(r.prototype,"length",{get:function(){return this.buffer.length-this.offset}}),e.exports=r},function(e){var t=Math.pow;e.exports=function(e,n,r){n=n||0;for(var i=1;8>=i&&!(e[n]>=t(2,8-i));i++);if(8<i)throw new Error("Unrepresentable length: "+i+" "+e.toString("hex",n,n+i));if(n+i>e.length)return null;var a,o=e[n]&(1<<8-i)-1;for(a=1;a<i;a++){if(7===a&&35184372088832<=o&&0<e[n+7])return{length:i,value:-1};o*=256,o+=e[n+a]}return r&&(o-=t(2,7*i-1)-1),{length:i,value:o}}},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var i=n(140),a=n(6),o=function(e){function t(){var t=e.call(this)||this;return t.logGroup="",t.hasLoggingStarted=!1,t.metadataloaded=!1,t.chunks=[],t.stack=[],t.segmentOffset=0,t.last2SimpleBlockVideoTrackTimecode=[0,0],t.last2SimpleBlockAudioTrackTimecode=[0,0],t.lastClusterTimecode=0,t.lastClusterPosition=0,t.timecodeScale=1e6,t.metadataSize=0,t.metadatas=[],t.cues=[],t.firstVideoBlockRead=!1,t.firstAudioBlockRead=!1,t.currentTrack={TrackNumber:-1,TrackType:-1,DefaultDuration:null,CodecDelay:null},t.trackTypes=[],t.trackDefaultDuration=[],t.trackCodecDelay=[],t.trackInfo={type:"nothing"},t.ended=!1,t.logging=!1,t.use_duration_every_simpleblock=!1,t.use_webp=!1,t.use_segment_info=!0,t.drop_default_duration=!0,t}return r(t,e),t.prototype.stop=function(){for(this.ended=!0,this.emit_segment_info();this.stack.length;)this.stack.pop(),this.logging&&console.groupEnd();this.logging&&this.hasLoggingStarted&&this.logGroup&&console.groupEnd()},t.prototype.emit_segment_info=function(){var e=this.chunks;if(this.chunks=[],this.metadataloaded){if(!this.use_segment_info)return;var t=this.lastClusterTimecode,n=this.duration,r=this.timecodeScale;this.emit("cluster",{timecode:t,data:e}),this.emit("duration",{timecodeScale:r,duration:n})}else{this.metadataloaded=!0,this.metadatas=e;var i=this.trackTypes.indexOf(1),a=this.trackTypes.indexOf(2);if(this.trackInfo=0<=i&&0<=a?{type:"both",trackNumber:i}:0<=i?{type:"video",trackNumber:i}:0<=a?{type:"audio",trackNumber:a}:{type:"nothing"},!this.use_segment_info)return;this.emit("metadata",{data:e,metadataSize:this.metadataSize})}},t.prototype.read=function(e){var t=this,n=!1;if(!this.ended){if("m"===e.type)if(e.isEnd)this.stack.pop();else{var r=this.stack[this.stack.length-1];if(null!=r&&r.level>=e.level){this.stack.pop(),this.logging&&console.groupEnd(),r.dataEnd=e.dataEnd,r.dataSize=e.dataEnd-r.dataStart,r.unknownSize=!1;var i=Object.assign({},r,{name:r.name,type:r.type,isEnd:!0});this.chunks.push(i)}this.stack.push(e)}if("m"===e.type&&"Segment"==e.name)0!=this.segmentOffset&&console.warn("Multiple segments detected!"),this.segmentOffset=e.dataStart,this.emit("segment_offset",this.segmentOffset);else if("b"===e.type&&"SimpleBlock"===e.name){var o=a.ebmlBlock(e.data),s=o.timecode,c=o.trackNumber,l=o.frames;if(1===this.trackTypes[c]){if(!this.firstVideoBlockRead&&(this.firstVideoBlockRead=!0,"both"===this.trackInfo.type||"video"===this.trackInfo.type)){var d=this.lastClusterTimecode+s;this.cues.push({CueTrack:c,CueClusterPosition:this.lastClusterPosition,CueTime:d}),this.emit("cue_info",{CueTrack:c,CueClusterPosition:this.lastClusterPosition,CueTime:this.lastClusterTimecode}),this.emit("cue",{CueTrack:c,CueClusterPosition:this.lastClusterPosition,CueTime:d})}this.last2SimpleBlockVideoTrackTimecode=[this.last2SimpleBlockVideoTrackTimecode[1],s]}else if(2===this.trackTypes[c]){if(!this.firstAudioBlockRead&&(this.firstAudioBlockRead=!0,"audio"===this.trackInfo.type)){d=this.lastClusterTimecode+s;this.cues.push({CueTrack:c,CueClusterPosition:this.lastClusterPosition,CueTime:d}),this.emit("cue_info",{CueTrack:c,CueClusterPosition:this.lastClusterPosition,CueTime:this.lastClusterTimecode}),this.emit("cue",{CueTrack:c,CueClusterPosition:this.lastClusterPosition,CueTime:d})}this.last2SimpleBlockAudioTrackTimecode=[this.last2SimpleBlockAudioTrackTimecode[1],s]}this.use_duration_every_simpleblock&&this.emit("duration",{timecodeScale:this.timecodeScale,duration:this.duration}),this.use_webp&&l.forEach(function(e){if("9d012a"===e.slice(3,6).toString("hex")){var n=a.VP8BitStreamToRiffWebPBuffer(e),r=new Blob([n],{type:"image/webp"}),i=t.duration;t.emit("webp",{currentTime:i,webp:r})}})}else"m"===e.type&&"Cluster"===e.name&&!1===e.isEnd?(this.firstVideoBlockRead=!1,this.firstAudioBlockRead=!1,this.emit_segment_info(),this.emit("cluster_ptr",e.tagStart),this.lastClusterPosition=e.tagStart):"u"===e.type&&"Timecode"===e.name?this.lastClusterTimecode=e.value:"u"===e.type&&"TimecodeScale"===e.name?this.timecodeScale=e.value:"m"===e.type&&"TrackEntry"===e.name?e.isEnd?(this.trackTypes[this.currentTrack.TrackNumber]=this.currentTrack.TrackType,this.trackDefaultDuration[this.currentTrack.TrackNumber]=this.currentTrack.DefaultDuration,this.trackCodecDelay[this.currentTrack.TrackNumber]=this.currentTrack.CodecDelay):this.currentTrack={TrackNumber:-1,TrackType:-1,DefaultDuration:null,CodecDelay:null}:"u"===e.type&&"TrackType"===e.name?this.currentTrack.TrackType=e.value:"u"===e.type&&"TrackNumber"===e.name?this.currentTrack.TrackNumber=e.value:"u"===e.type&&"CodecDelay"===e.name?this.currentTrack.CodecDelay=e.value:"u"===e.type&&"DefaultDuration"===e.name?this.drop_default_duration?(console.warn("DefaultDuration detected!, remove it"),n=!0):this.currentTrack.DefaultDuration=e.value:"unknown"===e.name&&console.warn(e);!this.metadataloaded&&0<e.dataEnd&&(this.metadataSize=e.dataEnd),n||this.chunks.push(e),this.logging&&this.put(e)}},Object.defineProperty(t.prototype,"duration",{get:function(){if("nothing"===this.trackInfo.type)return console.warn("no video, no audio track"),0;var e=0,t=0,n=0,r=this.trackDefaultDuration[this.trackInfo.trackNumber];if("number"==typeof r)e=r;else if("both"===this.trackInfo.type){if(this.last2SimpleBlockAudioTrackTimecode[1]>this.last2SimpleBlockVideoTrackTimecode[1])e=(this.last2SimpleBlockAudioTrackTimecode[1]-this.last2SimpleBlockAudioTrackTimecode[0])*this.timecodeScale,"number"==typeof(i=this.trackCodecDelay[this.trackTypes.indexOf(2)])&&(t=i),n=this.last2SimpleBlockAudioTrackTimecode[1];else e=(this.last2SimpleBlockVideoTrackTimecode[1]-this.last2SimpleBlockVideoTrackTimecode[0])*this.timecodeScale,"number"==typeof(i=this.trackCodecDelay[this.trackTypes.indexOf(1)])&&(t=i),n=this.last2SimpleBlockVideoTrackTimecode[1]}else if("video"===this.trackInfo.type){e=(this.last2SimpleBlockVideoTrackTimecode[1]-this.last2SimpleBlockVideoTrackTimecode[0])*this.timecodeScale,"number"==typeof(i=this.trackCodecDelay[this.trackInfo.trackNumber])&&(t=i),n=this.last2SimpleBlockVideoTrackTimecode[1]}else if("audio"===this.trackInfo.type){var i;e=(this.last2SimpleBlockAudioTrackTimecode[1]-this.last2SimpleBlockAudioTrackTimecode[0])*this.timecodeScale,"number"==typeof(i=this.trackCodecDelay[this.trackInfo.trackNumber])&&(t=i),n=this.last2SimpleBlockAudioTrackTimecode[1]}var a=((this.lastClusterTimecode+n)*this.timecodeScale+e-t)/this.timecodeScale;return Math.floor(a)},enumerable:!0,configurable:!0}),t.prototype.addListener=function(t,n){return e.prototype.addListener.call(this,t,n)},t.prototype.put=function(e){this.hasLoggingStarted||(this.hasLoggingStarted=!0,this.logging&&this.logGroup&&console.groupCollapsed(this.logGroup)),"m"===e.type?e.isEnd?console.groupEnd():console.group(e.name+":"+e.tagStart):"b"===e.type?console.log(e.name,e.type):console.log(e.name,e.tagStart,e.type,e.value)},t}(i.EventEmitter);t.default=o},function(e){"use strict";function t(){t.init.call(this)}function n(e){return void 0===e._maxListeners?t.defaultMaxListeners:e._maxListeners}function r(e,t,r,i){var a,o,s;if("function"!=typeof r)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r);if(void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),o=e._events),s=o[t]),void 0===s)s=o[t]=r,++e._eventsCount;else if("function"==typeof s?s=o[t]=i?[r,s]:[s,r]:i?s.unshift(r):s.push(r),0<(a=n(e))&&s.length>a&&!s.warned){s.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=s.length,function(e){console&&console.warn&&console.warn(e)}(c)}return e}function i(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=function(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);this.fired||(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,d(this.listener,this.target,e))}.bind(r);return i.listener=n,r.wrapFn=i,i}function a(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):s(i,i.length)}function o(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function s(e,t){for(var n=Array(t),r=0;r<t;++r)n[r]=e[r];return n}var c,l="object"==typeof Reflect?Reflect:null,d=l&&"function"==typeof l.apply?l.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};c=l&&"function"==typeof l.ownKeys?l.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var u=Number.isNaN||function(e){return e!=e};e.exports=t,t.EventEmitter=t,t.prototype._events=void 0,t.prototype._eventsCount=0,t.prototype._maxListeners=void 0;var h=10;Object.defineProperty(t,"defaultMaxListeners",{enumerable:!0,get:function(){return h},set:function(e){if("number"!=typeof e||0>e||u(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");h=e}}),t.init=function(){(void 0===this._events||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},t.prototype.setMaxListeners=function(e){if("number"!=typeof e||0>e||u(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},t.prototype.getMaxListeners=function(){return n(this)},t.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r="error"===e,i=this._events;if(void 0!==i)r=r&&void 0===i.error;else if(!r)return!1;if(r){var a;if(0<t.length&&(a=t[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var c=i[e];if(void 0===c)return!1;if("function"==typeof c)d(c,this,t);else{var l=c.length,u=s(c,l);for(n=0;n<l;++n)d(u[n],this,t)}return!0},t.prototype.addListener=function(e,t){return r(this,e,t,!1)},t.prototype.on=t.prototype.addListener,t.prototype.prependListener=function(e,t){return r(this,e,t,!0)},t.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.on(e,i(this,e,t)),this},t.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.prependListener(e,i(this,e,t)),this},t.prototype.removeListener=function(e,t){var n,r,i,a,o;if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);if(void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,a=n.length-1;0<=a;a--)if(n[a]===t||n[a].listener===t){o=n[a].listener,i=a;break}if(0>i)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,o||t)}return this},t.prototype.off=t.prototype.removeListener,t.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,a=Object.keys(n);for(r=0;r<a.length;++r)"removeListener"===(i=a[r])||this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;0<=r;r--)this.removeListener(e,t[r]);return this},t.prototype.listeners=function(e){return a(this,e,!0)},t.prototype.rawListeners=function(e){return a(this,e,!1)},t.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):o.call(e,t)},t.prototype.listenerCount=o,t.prototype.eventNames=function(){return 0<this._eventsCount?c(this._events):[]}},function(e){e.exports={_args:[["ts-ebml@^2.0.2","/home/konrad/web/v154/dependencies_otliteclient"]],_from:"ts-ebml@>=2.0.2 <3.0.0",_id:"ts-ebml@2.0.2",_inCache:!0,_installable:!0,_location:"/ts-ebml",_nodeVersion:"6.11.0",_npmOperationalInternal:{host:"s3://npm-registry-packages",tmp:"tmp/ts-ebml-2.0.2.tgz_1503116615810_0.8402522935066372"},_npmUser:{email:"legokichi@gmail.com",name:"legokichi"},_npmVersion:"5.3.0",_phantomChildren:{},_requested:{name:"ts-ebml",raw:"ts-ebml@^2.0.2",rawSpec:"^2.0.2",scope:null,spec:">=2.0.2 <3.0.0",type:"range"},_requiredBy:["/"],_resolved:"https://registry.npmjs.org/ts-ebml/-/ts-ebml-2.0.2.tgz",_shasum:"5e2c65b35ee6f1c030f51668666f3c018f4d9578",_shrinkwrap:null,_spec:"ts-ebml@^2.0.2",_where:"/home/konrad/web/v154/dependencies_otliteclient",author:{name:"legokichi duckscallion"},bin:{"ts-ebml":"./lib/cli.js"},bugs:{url:"https://github.com/legokichi/ts-ebml/issues"},dependencies:{buffer:"^5.0.7",commander:"^2.11.0",ebml:"^2.2.1","ebml-block":"^1.1.0",events:"^1.1.1","int64-buffer":"^0.1.9",matroska:"^2.2.3"},description:"ebml decoder and encoder",devDependencies:{"@types/commander":"^2.9.1","@types/qunit":"^2.0.31",browserify:"^13.1.0",empower:"^1.2.3","espower-cli":"^1.1.0","power-assert":"^1.4.4","power-assert-formatter":"^1.4.1","qunit-tap":"^1.5.1",qunitjs:"^2.4.0",tslint:"^3.15.1",typedoc:"^0.5.3",typescript:"^2.4.2",watchify:"^3.7.0"},directories:{},dist:{integrity:"sha512-V/HdlCn3FITQrFHQlVE02XtfMiRLab2QB/YOCfkbJWqiFYG/j5v7gHKV+wem6g0PD6/uxXs5oxMQfDXILmts/Q==",shasum:"5e2c65b35ee6f1c030f51668666f3c018f4d9578",tarball:"https://registry.npmjs.org/ts-ebml/-/ts-ebml-2.0.2.tgz"},gitHead:"079f1cc2c766e1833f498b5cddd511fcee1bc9b1",homepage:"https://github.com/legokichi/ts-ebml#readme",keywords:["ebml","matrosika","mkv","webm","webp"],license:"MIT",main:"./lib/index.js",maintainers:[{name:"legokichi",email:"legokichi@gmail.com"}],name:"ts-ebml",optionalDependencies:{},readme:"ERROR: No README data found!",repository:{type:"git",url:"git+https://github.com/legokichi/ts-ebml.git"},scripts:{browserify:"browserify lib/index.js --standalone EBML -o dist/EBML.js",build:"npm run clean   && tsc    -p .; npm run browserify",check:"tsc -w --noEmit -p ./",clean:"rm -rf lib/* dist/* test/*.js; mkdir -p dist",doc:"typedoc --mode modules --out doc --disableOutputCheck",example:"tsc; browserify lib/example_seekable.js -o test/example_seekable.js",examples:"tsc; for file in `find lib -name 'example_*.js' -type f -printf '%f\\n'`; do browserify lib/$file -o test/$file; done",examples_bsd:"tsc; for file in `find lib -name 'example_*.js' -type f -print`; do browserify lib/$(basename $file) -o test/$(basename $file); done",init:"npm run update; npm run mkdir; npm run build",lint:"tslint -c ./tslint.json --project ./tsconfig.json --type-check",mkdir:"mkdir lib dist 2>/dev/null",reset:"rm -rf node_modules",setup:"npm install -g http-server;",start:"http-server . -s & tsc -w -p .& watchify lib/example_seekable.js -o test/example_seekable.js",stop:"killall -- node */tsc -w -p",test:"tsc; espower lib/test.js > lib/test.tmp; mv -f lib/test.tmp lib/test.js; browserify lib/test.js -o test/test.js",update:"npm run reset; npm update",watchify:"watchify lib/index.js --standalone EBML -o dist/EBMl.js -v"},typings:"./lib/index.d.ts",version:"2.0.2"}},function(){!function(){"use strict";angular.module("rainbow").service("phonebookService",["$q","$rootScope","$log","$http","contactService","authService","orderByFilter","profileService","conversationService",function(e,t,n,r,i,a,o,s){this.search=function(c){return n.info("[phonebookService] search PBXContact from phonebook with text "+c),e(function(e,l){if(!config.permitSearchFromPhoneBook&&!s.isFeatureEnabled(s.FeaturesEnum.TELEPHONY_PHONE_BOOK))return n.info("[phonebookService] search from phonebook not allowed for the user profile"),void e([]);var d=config.restServerUrl+"/api/rainbow/search/v1.0/phonebooks?limit=20&name="+encodeURIComponent(c);r({method:"GET",url:d,headers:a.getRequestHeader()}).then(function(t){var r=t.data.phoneBooks;n.info("[phonebookService] search find "+r.length+" phonebooks contact(s)");var a=[];r.forEach(function(e){var t=i.createBasicContact(null,e.number);t.updateName(e.firstName,e.lastName),t.getAvatar(),a.push(t)}),a=o(a,"_displayName",!1),e(a)},function(e){e.data&&(401===e.data.errorCode&&t.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT"),n.warn("[phonebookService] search failure "+e.data.errorMsg)),l(new Error("phonebook service failure"))})})}}])}()},function(){angular.module("rainbow").service("adminCompanyService",["$q","$log","$http","$rootScope","authService","errorHelperService","Company","contactService","settingsService","Site","CompanyInvitation","pushImageHelperService","CompanyRequest","companyService",function(e,t,n,r,i,a,o,s,c,l,d,u,h,f){"use strict";var p=this;p.start=function(){return t.info("[adminCompanyService] === STARTING ==="),p.portalURL=config.restServerUrl+"/api/rainbow/admin/v1.0/",t.info("[adminCompanyService] === STARTED ==="),e.when()},p.stop=function(){return t.info("[adminCompanyService] === STOPPING ==="),t.info("[adminCompanyService] === STOPPED ==="),e.when()},p.getCompanies=function(r,c,l,d,u,h,m,v,g,C,S,E){var b=e.defer(),y=s.userContact;if(!(y.isSuperadmin()||y.isBusinessAdmin()||y.isBPAdmin()||y.isOrganizationAdmin()))return p.getCompany(y.company.id).then(function(e){return{companies:[e]}});var R=p.portalURL+"companies?format="+(u||"full");return r&&(R+="&organisationId="+r),c&&l&&(R+="&offset="+l*(c-1)),l&&(R+="&limit="+l),d&&(R+="&name="+d),h&&(R+="&bpId="+h),m&&(Array.isArray(m)?m.forEach(function(e){R+="&status="+e}):R+="&status="+m),null!=v&&(R+="&isBP="+v),g&&(R+="&bpType="+g),C&&(R+="&offerCanBeSold="+C),S&&(R+="&externalReference="+S),n({method:"GET",url:R,headers:i.getRequestHeader()}).then(function(e){var n=e.data.data;t.info("[adminCompanyService] getCompanies success");var r=[];n.forEach(function(e){var t=o.createFromData(e);(angular.isUndefined(E)||!E)&&f.getCompanyLogo(t),r.push(t)}),b.resolve({companies:r,limit:e.data.limit,offset:e.data.offset,total:e.data.total})},function(e){var n=a.handleError(e);b.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getCompanies"))}),b.promise},p.getAllCompaniesSmall=function(e,t,n,r,i){return p.getAllCompanies(e,t,n,r,i,"small")},p.getAllCompanies=function(t,n,r,i,a,o){return e(function(s,c){var l;p.getCompanies(t,1,1e3,null,o,n,r,i,a).then(function(s){if(l=s,s.total>s.limit){var c=Math.ceil(s.total/1e3),d=Array.apply(null,Array(c-1));d=d.map(function(e,t){return t+2});for(var u=[];0<d.length;)u.push(d.splice(0,5));return u.reduce(function(c,l){return c.then(function(){var c=l.map(function(e){return p.getCompanies(t,e,1e3,null,o,n,r,i,a).then(function(e){s.companies=s.companies.concat(e.companies),s.limit+=e.limit})});return e.all(c)})},e.resolve())}}).then(function(){s(l)}).catch(function(e){c(e)})})},p.getCompany=function(r){return e(function(e,s){n({method:"GET",url:p.portalURL+"companies/"+r,headers:i.getRequestHeader()}).then(function(n){t.info("[adminCompanyService] getCompany success");var r=n.data.data,i=o.createFromData(r);f.getCompanyLogo(i),f.getCompanyBanner(i),e(i)},function(e){var n=a.handleError(e);s(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getCompany"))})})},p.getDefaultCompany=function(){return e(function(e,r){n({method:"GET",url:p.portalURL+"companies/default",headers:i.getRequestHeader()}).then(function(n){t.info("[adminCompanyService] getDefaultCompany success");var r=n.data.data,i=o.createFromData(r);e(i)},function(e){var n=a.handleError(e);r(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getDefaultCompany"))})})},p.searchCompanies=function(t){var n=e.defer(),r=t.toLowerCase();return p.getCompanies().then(function(e){var t=e.companies.filter(function(e){return-1<e.name.toLowerCase().indexOf(r)});n.resolve(t)}),n.promise},p.createCompany=function(c){var l=o.prune(c,s.userContact),d=e.defer();return n({method:"POST",url:p.portalURL+"companies",headers:i.getRequestHeader(),data:l}).then(function(e){t.info("[adminCompanyService] createCompany success");var n=o.createFromData(e.data.data);r.$broadcast("ADMIN_COMPANIES_CHANGE"),d.resolve(n)},function(e){var n=a.handleError(e);d.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"createCompany"))}),d.promise},p.createCompanyEndUser=function(r){var c=o.prune(r,s.userContact),l=e.defer();return n({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/companies",headers:i.getRequestHeader(),data:c}).then(function(e){t.info("[adminCompanyService] createCompany success");var n=e.data.data,r=o.createFromData(n);l.resolve(r)},function(e){var n=a.handleError(e);l.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"createCompanyEndUser"))}),l.promise},p.updateCompany=function(c){var l=o.prune(c,s.userContact),d=e.defer();return n({method:"PUT",url:p.portalURL+"companies/"+c.id,headers:i.getRequestHeader(),data:l}).then(function(e){t.info("[adminCompanyService] updateCompany success");var n=e.data.data,i=o.createFromData(n);d.resolve(i),r.$broadcast("ON_COMPANY_CHANGE_EVENT",c.id)},function(e){var n=a.handleError(e);d.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"updateCompany"))}),d.promise},p.addVisibility=function(r,o){var s=e.defer();return n({method:"POST",url:p.portalURL+"companies/"+r+"/visible-by/"+o,headers:i.getRequestHeader()}).then(function(){t.info("[adminCompanyService] addVisibility success"),s.resolve()},function(e){var n=a.handleError(e);s.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"addVisibility"))}),s.promise},p.removeVisibility=function(r,o){var s=e.defer();return n({method:"DELETE",url:p.portalURL+"companies/"+r+"/visible-by/"+o,headers:i.getRequestHeader()}).then(function(){t.info("[adminCompanyService] removeVisibility success"),s.resolve()},function(e){var n=a.handleError(e);s.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"removeVisibility"))}),s.promise},p.getAllSiteCompany=function(r){var o=e.defer();return n({method:"GET",url:p.portalURL+"companies/"+r+"/sites",headers:i.getRequestHeader()}).then(function(e){t.info("[adminCompanyService] getAllSiteCompany success");var n=e.data.data,r=[];n.forEach(function(e){var t=l.createFromData(e);r.push(t)}),o.resolve(r)},function(e){var n=a.handleError(e);o.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getAllSiteCompany"))}),o.promise},p.getCompanyAdministrators=function(r){return e(function(e,o){n({method:"GET",url:p.portalURL+"companies/"+r+"/administrators",headers:i.getRequestHeader()}).then(function(n){t.info("[adminCompanyService] getCompanyAdministrators success");var r=n.data.data,i=[];r.forEach(function(e){var t={id:e.id};i.push(t)}),e(i)},function(e){var n=a.handleError(e);o(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getCompanyAdministrators"))})})},p.deleteCompany=function(r){var o=e.defer();return n({method:"DELETE",url:p.portalURL+"companies/"+r,headers:i.getRequestHeader()}).then(function(){t.info("[adminCompanyService] deleteCompany success"),o.resolve()},function(e){var n=a.handleError(e);o.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"deleteCompany"))}),o.promise},p.pushLogo=function(n,i,a){return e(function(o,s){var c=p.portalURL+"companies/"+n+"/avatar";(angular.isDefined(i)&&null!==i?u.pushImage(c,i):e.resolve()).then(function(){return p.getCompany(n)}).then(function(e){return e.avatarShape=a,p.updateCompany(e)}).then(function(){r.$broadcast("ON_COMPANY_CHANGE_EVENT",n),t.info("[adminCompanyService] pushLogo success"),o()}).catch(function(e){s(e)})})},p.deleteLogo=function(o){return e(function(e,s){n({method:"DELETE",url:p.portalURL+"companies/"+o+"/avatar",headers:i.getRequestHeader()}).then(function(){r.$broadcast("ON_COMPANY_CHANGE_EVENT",o),p.getCompany(o).then(function(e){return e.avatarShape="circle",p.updateCompany(e)}).then(function(){t.info("[adminCompanyService] deleteLogo success"),e()}).catch(function(e){s(e)})},function(e){var n=a.handleError(e);s(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"deleteLogo"))})})},p.pushBanner=function(t,n,i){return e(function(e,a){var o=p.portalURL+"companies/"+t+"/banner";return u.pushImage(o,n,i).then(function(){r.$broadcast("ON_COMPANY_CHANGE_EVENT",t),e()}).catch(function(e){a(e)})})},p.deleteBanner=function(o){return e(function(e,s){n({method:"DELETE",url:p.portalURL+"companies/"+o+"/banner",headers:i.getRequestHeader()}).then(function(){r.$broadcast("ON_COMPANY_CHANGE_EVENT",o),t.info("[adminCompanyService] deleteBanner success"),e()},function(e){var n=a.handleError(e);s(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"deleteBanner"))})})},p.getCompanyInvitations=function(r,o,s){return e(function(e,c){var l=p.portalURL+"companies/"+r+"/join-companies/invitations?format=medium&status=pending declined&limit="+s;o&&(l+="&offset="+s*(o-1)),n({method:"GET",url:l,headers:i.getRequestHeader()}).then(function(n){var r=[];n.data.data.forEach(function(e){var t=d.createFromData(e);r.push(t)}),t.info("[adminCompanyService] getCompanyInvitations success (found "+r.length+" invitation(s))"),e({invitations:r,total:n.data.total})},function(e){var n=a.handleError(e);c(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getCompanyInvitations"))})})},p.joinCompanyInvitation=function(r,o,s,l,d,u){var h=e.defer(),f={lang:c.getAppliLanguageCodeForServer()};return l&&(f.customMessage=l),s?f.invitedUserId=s:o&&(f.email=o),d&&(f.invitedToBeCompanyAdmin=d),u&&(f.invitedToBeBpAdmin=u),n({method:"POST",url:p.portalURL+"companies/"+r+"/join-companies/invitations",headers:i.getRequestHeader(),data:f}).then(function(){t.info("[adminCompanyService] joinCompanyInvitation success"),h.resolve()},function(e){var n=a.handleError(e);h.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"joinCompanyInvitation"))}),h.promise},p.cancelJoinCompanyInvitation=function(r,o){var s=e.defer();return n({method:"POST",url:p.portalURL+"companies/"+r+"/join-companies/invitations/"+o+"/cancel",headers:i.getRequestHeader()}).then(function(e){var n=d.createFromData(e.data.data);t.info("[adminCompanyService] cancelJoinCompanyInvitation success"),s.resolve(n)},function(e){var n=a.handleError(e);s.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"cancelJoinCompanyInvitation"))}),s.promise},p.resendJoinCompanyInvitation=function(r,o){var s=e.defer();return n({method:"POST",url:p.portalURL+"companies/"+r+"/join-companies/invitations/"+o+"/re-send",headers:i.getRequestHeader()}).then(function(e){var n=d.createFromData(e.data.data);t.info("[adminCompanyService] resendJoinCompanyInvitation success"),s.resolve(n)},function(e){var n=a.handleError(e);s.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"resendJoinCompanyInvitation"))}),s.promise},p.getCompanyJoinRequests=function(r){return e(function(e,o){n({method:"GET",url:p.portalURL+"companies/"+r+"/join-companies/requests?format=medium&status=pending",headers:i.getRequestHeader()}).then(function(n){var r=[];n.data.data.forEach(function(e){var t=h.createFromData(e);r.push(t)}),t.info("[adminCompanyService] getCompanyJoinRequests success (found "+n.data.total+" invitation(s))"),e({companyRequests:r,total:n.data.total})},function(e){var n=a.handleError(e);o(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getCompanyJoinRequests"))})})},p.getJoinCompanyRequest=function(r,o){return e(function(e,s){n({method:"GET",url:p.portalURL+"companies/"+r+"/join-companies/requests/"+o+"?status=pending",headers:i.getRequestHeader()}).then(function(n){var r=h.createFromData(n.data.data);t.info("[adminCompanyService] getJoinCompanyRequest success"),e(r)},function(e){var n=a.handleError(e);s(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getJoinCompanyRequest"))})})},p.acceptCompanyJoinRequests=function(r,o){return e(function(e,s){n({method:"POST",url:p.portalURL+"companies/"+r+"/join-companies/requests/"+o+"/accept",headers:i.getRequestHeader()}).then(function(n){var r=h.createFromData(n.data.data);t.info("[adminCompanyService] acceptCompanyJoinRequests success"),e(r)},function(e){var n=a.handleError(e);t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"acceptCompanyJoinRequests")),s(n)})})},p.declineCompanyJoinRequests=function(r,o){return e(function(e,s){n({method:"POST",url:p.portalURL+"companies/"+r+"/join-companies/requests/"+o+"/decline",headers:i.getRequestHeader()}).then(function(n){var r=h.createFromData(n.data.data);t.info("[adminCompanyService] declineCompanyJoinRequests success"),e(r)},function(e){var n=a.handleError(e);t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"declineCompanyJoinRequests")),s(n)})})},p.getOAuthConsentUrl=function(){var r=c.getAppliLanguage().code;return e(function(e,o){n({method:"GET",url:config.restServerUrl+"/api/rainbow/office365/v1.0/consent?callback="+window.location.origin+"/redirectO365.html?provider=o365&lang="+r,headers:i.getRequestHeader()}).then(function(n){var r=n.data.url;t.info("[adminCompanyService] getOAuthConsentUrl success: "+r),e(r)},function(e){var n=a.handleError(e);t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getOAuthConsentUrl")),o(n)})})},p.getCompanyConferenceSettings=function(r){return e(function(e,o){n({method:"GET",url:p.portalURL+"companies/"+r+"/settings/conferences",headers:i.getRequestHeader()}).then(function(n){t.info("[adminCompanyService] getCompanyConferenceSettings success");var r=n.data.data;e(r)},function(e){var n=a.handleError(e);o(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getCompanyConferenceSettings"))})})},p.setCompanyConferenceSettings=function(r,o){return e(function(e,s){n({method:"PUT",url:p.portalURL+"companies/"+r+"/settings/conferences",headers:i.getRequestHeader(),data:{confDialOutDisabled:!o}}).then(function(n){t.info("[adminCompanyService] setCompanyConferenceSettings success");var r=n.data.data;e(r)},function(e){var n=a.handleError(e);s(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"setCompanyConferenceSettings"))})})},p.getCompanySAMLConfigurationFile=function(n){return e(function(e,r){i.getCompanySAMLConfiguration(n).then(function(t){var n=new Blob([t],{type:"application/xml"});e(n)}).catch(function(e){var n=a.handleError(e);r(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getCompanySAMLConfigurationFile"))})})},p.createCompanySingleSignOnServerConfig=function(r,o,s,c,l,d,u){return e(function(e,h){n({method:"POST",url:p.portalURL+"companies/"+r+"/settings/sso",headers:i.getRequestHeader(),data:{type:o,loginUrl:s,logoutUrl:c,certificates:l,uidAttribute:d,enabled:u}}).then(function(){t.info("[adminCompanyService] createCompanySingleSignOnServerConfig success"),e()},function(e){var n=a.handleError(e);h(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"createCompanySingleSignOnServerConfig"))})})},p.deleteCompanySingleSignOnServerConfig=function(r,o){return e(function(e,s){n({method:"DELETE",url:p.portalURL+"companies/"+r+"/settings/sso/"+o,headers:i.getRequestHeader()}).then(function(){t.info("[adminCompanyService] deleteCompanySingleSignOnServerConfig success"),e()},function(e){var n=a.handleError(e);s(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"deleteCompanySingleSignOnServerConfig"))})})},p.isCompanySingleSignOnAvailable=function(t){return e(function(e,n){t?p.getCompanySingleSignOnServerConfig(t).then(function(t){e(t&&0<t.length)}).catch(function(e){n(e)}):e(!1)})},p.getCompanySingleSignOnServerConfig=function(r){return e(function(e,o){n({method:"GET",url:p.portalURL+"companies/"+r+"/settings/sso",headers:i.getRequestHeader()}).then(function(n){t.info("[adminCompanyService] getCompanySingleSignOnServerConfig success");var r=n.data;e(r)},function(e){var n=a.handleError(e);o(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getCompanySingleSignOnServerConfig"))})})},p.updateCompanySingleSignOnServerConfig=function(r,o,s,c,l,d,u){return e(function(e,h){n({method:"PUT",url:p.portalURL+"companies/"+r+"/settings/sso/"+o,headers:i.getRequestHeader(),data:{loginUrl:s,logoutUrl:c,certificates:l,uidAttribute:d,enabled:u}}).then(function(n){t.info("[adminCompanyService] updateCompanySingleSignOnConfig success");var r=n.data;e(r)},function(e){var n=a.handleError(e);h(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"updateCompanySingleSignOnConfig"))})})}}])},function(){angular.module("rainbow").service("adminUserService",["$q","$log","$http","authService","errorHelperService","Company","User","Site","Organisation","userInfoService","contactService","PhoneNumber",function(e,t,n,r,i,a,o,s,c,l,d,u){"use strict";var h=this;h.start=function(){return t.info("[adminUserService] === STARTING ==="),h.portalURL=config.restServerUrl+"/api/rainbow/admin/v1.0/",t.info("[adminUserService] === STARTED ==="),e.when()},h.stop=function(){return t.info("[adminUserService] === STOPPING ==="),t.info("[adminUserService] === STOPPED ==="),e.when()},h.getUsersByEmail=function(l,d){return e(function(e,u){var f=h.portalURL+"users?format=full";l&&l instanceof c&&(f+="&organisationId="+l.id),l&&l instanceof a&&(f+="&companyId="+l.id),l&&l instanceof s&&(f+="&siteId="+l.id),d&&(f+="&email="+encodeURIComponent(d)),n({method:"GET",url:f,headers:r.getRequestHeader()}).then(function(n){var r=n.data.data;t.info("[adminUserService] getUsersByEmail success (find "+n.data.total+" user(s))");var i=[];r.forEach(function(e){var t=o.createFromData(e);i.push(t)}),e({users:i,total:n.data.total})},function(e){var n=i.handleError(e);u(n),t.error("[adminOfferSubscriptionService] "+i.getErrorFullMessage(e,"getUsersByEmail"))})})},h.getUsers=function(l,d,u,f,p,m,v){return e(function(e,g){var C=h.portalURL+"users?format=full&limit="+u;l&&l instanceof c&&(C+="&organisationId="+l.id),l&&l instanceof a&&(C+="&companyId="+l.id),l&&l instanceof s&&(C+="&siteId="+l.id),d&&(C+="&offset="+u*(d-1)),f&&(C+="&displayName="+encodeURIComponent(f)+"&useEmails=true"),null!=p&&(C+="&isTerminated="+p),m&&(C+="&roles=admin&roles=bp_admin&roles=bp_finance&roles=superadmin&roles=business_admin"),n({method:"GET",url:C+="&sortField=reverseDisplayName",headers:r.getRequestHeader()}).then(function(n){var r=n.data.data;t.info("[adminUserService] getUsers success (find "+n.data.total+" user(s))");var i=[];r.forEach(function(e){var t=o.createFromData(e,v);i.push(t)}),e({users:i,limit:n.data.limit,offset:n.data.offset,total:n.data.total})},function(e){var n=i.handleError(e);g(n),t.error("[adminOfferSubscriptionService] "+i.getErrorFullMessage(e,"getUsers"))})})},h.searchUsers=function(a,s,c,l){return e(function(e,d){var u=config.restServerUrl+"/api/rainbow/search/v1.0/users?limit="+c;a&&(u+="&companyId="+a.id),s&&(u+="&offset="+c*(s-1)),l&&(u+="&displayName="+encodeURIComponent(l)),n({method:"GET",url:u,headers:r.getRequestHeader()}).then(function(n){var r=n.data.data;t.info("[adminUserService] searchUsers success (find "+n.data.total+" user(s))");var i=[];r.forEach(function(e){var t=o.createFromData(e);i.push(t)}),e({users:i,total:n.data.total})},function(e){var n=i.handleError(e);d(n),t.error("[adminOfferSubscriptionService] "+i.getErrorFullMessage(e,"searchUsers"))})})},h.getUser=function(a){var s=e.defer();return n({method:"GET",url:h.portalURL+"users/"+a,headers:r.getRequestHeader()}).then(function(e){t.info("[adminUserService] getUser success");var n=e.data.data,r=o.createFromData(n);s.resolve(r)},function(e){var n=i.handleError(e);s.reject(n),t.error("[adminUserService] "+i.getErrorFullMessage(e,"getUser"))}),s.promise},h.createUser=function(a){var s=o.prune(a,d.userContact),c=e.defer();return n({method:"POST",url:h.portalURL+"users",headers:r.getRequestHeader(),data:s}).then(function(e){var n=o.createFromData(e.data.data);t.info("[adminUserService] createUser success"),c.resolve(n)},function(e){var n=i.handleError(e);c.reject(n),t.error("[adminUserService] "+i.getErrorFullMessage(e,"createUser"))}),c.promise},h.deleteUser=function(a){var o=e.defer();return n({method:"DELETE",url:h.portalURL+"users/"+a.id,headers:r.getRequestHeader()}).then(function(){t.info("[adminUserService] deleteUser success"),o.resolve()},function(e){var n=i.handleError(e);o.reject(n),t.error("[adminUserService] "+i.getErrorFullMessage(e,"deleteUser"))}),o.promise},h.updateUser=function(a){var s=o.prune(a,d.userContact),c=e.defer();return n({method:"PUT",url:h.portalURL+"users/"+a.id,headers:r.getRequestHeader(),data:s}).then(function(){t.info("[adminUserService] updateUser success"),c.resolve()},function(e){var n=i.handleError(e);c.reject(n),t.error("[adminUserService] "+i.getErrorFullMessage(e,"updateUser"))}),c.promise},h.getUserAvatar=function(e){var t=l.computeUserColor(e.firstName+" "+e.lastName).color;l.getAvatarImage(e.id,e.initials,t,50,e.lastAvatarUpdateDate).then(function(t){e.image=t})},h.expandTelephonyInfo=function(e){var t={};return e.phoneNumbers&&e.phoneNumbers.forEach(function(e){var n=e.number,r=e.numberE164,i=e.deviceType;switch(e.type){case"work":"landline"===i&&(t.phoneProNumber&&t.phoneProNumber.systemId||(t.phonePro=n,t.phoneProCan=r,t.phoneProExt=e.shortNumber,t.phoneProIsMonitored=e.isMonitored,t.phoneProNumber=u.createFromData(e))),"mobile"===i&&(t.mobilePro=n,t.mobileProCan=r);break;case"home":"landline"===i&&(t.phonePerso=n,t.phonePersoCan=r),"mobile"===i&&(t.mobilePerso=n,t.mobilePersoCan=r);break;case"rainbow":t.rainbowPhoneNumber=n}}),t},h.getAllUsers=function(t,n){return e(function(r,i){var a;h.getUsers(t,1,1e3,void 0,void 0,void 0,n).then(function(r){if(a=r,r.total>r.limit){var i=Math.ceil(r.total/1e3),o=Array.apply(null,Array(i-1));o=o.map(function(e,t){return t+2});for(var s=[];0<o.length;)s.push(o.splice(0,5));return s.reduce(function(r,i){return r.then(function(){var r=i.map(function(e){return h.getUsers(t,e,1e3,void 0,void 0,void 0,n).then(function(e){a.users=a.users.concat(e.users),a.limit+=e.limit})});return e.all(r)})},e.resolve())}}).then(function(){r(a)}).catch(function(e){i(e)})})}}])},function(){angular.module("rainbow").filter("emojione",["$sce","$sanitize",function(e,t){"use strict";return function(n){return angular.isString(n)?t(e.trustAsHtml(emojione.shortnameToImage(n))):n}}]),angular.module("rainbow").filter("emojiUnicodeToShort",function(){"use strict";return function(e){return angular.isString(e)?emojione.toShort(e):e}}),angular.module("rainbow").filter("emojiShortToUnicode",function(){"use strict";return function(e){return angular.isString(e)?emojione.shortnameToUnicode(e):e}})},function(){angular.module("rainbow").factory("PromiseQueue",["$log",function(e){"use strict";function t(){var t=this;this.queue=[],this.started=!1,this.add=function(e){this.queue.push(e),this.started||(this.started=!0,this.execute())},this.execute=function(){var n=this.queue.shift();if(n)try{t.timeoutPromise(2e4,n).then(function(){t.execute()}).catch(function(n){var r=n&&n.message?n.message:"Unknown error";e.error("[PromiseQueue] execute failure -- "+r),t.execute()})}catch(n){var r=n&&n.message?n.message:"Unknown error",i=n&&n.stack?n.stack:"Unknown stack";e.error("[PromiseQueue] execution exception  -- "+r+" : "+i),t.execute()}else this.started=!1},t.timeoutPromise=function(e,t){var n,r=new Promise(function(t,r){n=setTimeout(function(){r(new Error("Timed out in "+e+"ms."))},e)});return Promise.race([t(),r]).then(function(e){return clearTimeout(n),e})}}return t.create=function(){return new t},t}])},function(){angular.module("rainbow").factory("TransfertPromiseQueue",["$log","$q",function(e,t){"use strict";function n(){var n=this;n.fileQueue=[],n.clearContext=function(){n.currentId=null,n.currentQueue=[],n.promiseCompletion=void 0,n.promiseReject=void 0,n.initialQueueSize=0,n.promisesDone=0,n.chunkErrorCounter=0,n.currentPromise=void 0},n.clearContext(),n.addPromiseArray=function(r,i,a,o){e.debug("[TransfertPromiseQueue] adding promiseArray");var s={};return s.id=r,s.promiseArray=i,s.promiseCompletion=a,s.promiseReject=o,0!==n.fileQueue.length||n.currentPromise?(n.fileQueue.push(s),e.debug("[TransfertPromiseQueue] adding PromiseArray in FileQueue: "+n.fileQueue.length)):(e.debug("[TransfertPromiseQueue] configuring file to transfert: "+s.promiseArray.length),n.fileQueue.push(s),n.popFileQueue()),e.debug("[TransfertPromiseQueue] adding promise on FileQueue: "+n.fileQueue.length),t},n.popFileQueue=function(){if(0<n.fileQueue.length){e.debug("[TransfertPromiseQueue] go to next file");var t=n.fileQueue.shift();n.currentId=t.id,n.currentQueue=t.promiseArray,n.promiseCompletion=t.promiseCompletion,n.promiseReject=t.promiseReject,n.initialQueueSize=n.currentQueue.length,n.promisesDone=0,n.chunkErrorCounter=0,n.currentPromise=n.currentQueue.shift(),n.execute()}else e.debug("[TransfertPromiseQueue] no more file to transfert"),n.clearContext()},n.execute=function(){e.debug("[TransfertPromiseQueue] execute"),n.currentPromise?(e.debug("[TransfertPromiseQueue] performing promise: "+n.promisesDone),n.currentPromise().then(function(){e.debug("[TransfertPromiseQueue] promise success go to next one"),n.promisesDone++,n.chunkErrorCounter=0,n.promisesDone>=n.initialQueueSize?(n.promiseCompletion&&n.promiseCompletion(),n.popFileQueue()):(n.currentPromise=n.currentQueue.shift(),n.execute())}).catch(function(t){var r=t&&t.message?t.message:"Unknown error";e.error("[TransfertPromiseQueue] failure executing promise -- "+r),n.chunkErrorCounter++,t&&500<=t.errorDetailsCode&&3>=n.chunkErrorCounter?n.execute():(e.error("[TransfertPromiseQueue] 3 chunk failed - ABORT File Upload"),n.promiseReject(t),n.popFileQueue())})):(e.debug("[TransfertPromiseQueue] no promise to perform"),n.currentPromise=void 0)},n.isTransferInProgress=function(){return e.debug("[TransfertPromiseQueue] >isTransferInProgress: "+n.fileQueue.length+"/"+n.currentQueue.length),0<n.fileQueue.length||0<n.currentQueue.length||n.currentPromise},n.cancelAllTransfers=function(){e.debug("[TransfertPromiseQueue] cancelAllTransfers"),n.fileQueue=[],n.currentQueue=[]},n.cancelCurrentFiletransfer=function(t){if(e.debug("[TransfertPromiseQueue] cancelCurrentFiletransfer"),n.currentId===t)e.debug("[TransfertPromiseQueue] cancelling current promise"),n.popFileQueue();else{var r=n.fileQueue.find(function(e){return e.id===t});if(r){var i=n.fileQueue.indexOf(r);e.debug("[TransfertPromiseQueue] promise to remove at position="+i),n.fileQueue.splice(i,1)}}}}return n.create=function(){return e.debug("[TransfertPromiseQueue] >create"),new n},n}])},function(){window.sdk=angular.module("sdk",["pascalprecht.translate","ngSanitize","ngFileSaver","angular-jwt","uuid4","rainbow","rainbowAdmin"],function(){})},function(){sdk.constant("SDK",{OK:1,ERROR:-1,ERRORUNAUTHORIZED:-2,ERRORXMPP:-4,ERRORXMPPJID:-8,ERRORBADREQUEST:-16,ERRORUNSUPPORTED:-32,ERRORNOTFOUND:-64})},function(){sdk.remoteConsole={debug:!1,log:!1,info:!1,warn:!1,error:!1},sdk.hasVerboseLog=!1,sdk.useAngularEvents=!1,sdk.hasBeenLaunchedFromConfig=!1,sdk.key={appID:"",appSecret:"",host:"openrainbow.com"},sdk.config(["consoleLogsProvider","$provide","$httpProvider","$translateProvider",function(e,t,n,r){"use strict";var i=function(e){return e.toDateString()+" "+("0"+e.getHours()).slice(-2)+":"+("0"+e.getMinutes()).slice(-2)+":"+("0"+e.getSeconds()).slice(-2)};t.decorator("$log",["$delegate",function(t){var n=t.debug;t.debug=function(){var t=[].slice.call(arguments);sdk.remoteConsole.debug&&console.re.debug(t[0]),sdk.hasVerboseLog&&n.apply(null,t),e.setLogs(["["+i(new Date)+"]"]+"debug : "+t+"\n")};var r=t.log;t.log=function(){var t=[].slice.call(arguments);sdk.remoteConsole.log&&console.re.log(t[0]),sdk.hasVerboseLog&&r.apply(null,t),e.setLogs(["["+i(new Date)+"]"]+"log : "+t+"\n")};var a=t.info;t.info=function(){var t=[].slice.call(arguments);sdk.remoteConsole.info&&console.re.info(t[0]),sdk.hasVerboseLog&&a.apply(null,t),e.setLogs(["["+i(new Date)+"]"]+"info : "+t+"\n")};var o=t.warn;t.warn=function(){var t=[].slice.call(arguments);sdk.remoteConsole.warn&&console.re.warn(t[0]),o.apply(null,t),e.setLogs(["["+i(new Date)+"]"]+"warn : "+t+"\n")};var s=t.error;return t.error=function(){var t=[].slice.call(arguments);sdk.remoteConsole.error&&console.re.error(t[0]),s.apply(null,t),e.setLogs(["["+i(new Date)+"]"]+"error : "+t+"\n")},t.webrtc=function(){var t=[].slice.call(arguments),r="rtcweb : "+t[0];t[0]="%c "+i(new Date)+" | RTCWEB | "+t[0],t[t.length]="color:green",sdk.remoteConsole.log&&console.re.log(t[0]),n.apply(null,t),e.setLogs(["["+i(new Date)+"]"]+r+"\n")},t.sdk=function(){var t=[].slice.call(arguments),r="RBW-SDK : "+t[0];t[0]="%c "+i(new Date)+" | RBW-SDK | "+t[0],t[t.length]="color:green",sdk.remoteConsole.log&&console.re.log(t[0]),n.apply(null,t),e.setLogs(["["+i(new Date)+"]"]+r+"\n")},t}]),n.defaults.useXDomain=!0,r.useSanitizeValueStrategy(null)}]),sdk.run([function(){}]),sdk.provider("consoleLogs",[function(){"use strict";this.logsBuffer=[],this.logsMaxLength=2e6,this.$get=function(){var e=this.logsBuffer;return{getLogs:function(){return e}}},this.cleanBuffer=function(){this.logsBuffer.length>this.logsMaxLength&&(this.logsBuffer=this.logsBuffer.slice(-this.logsMaxLength))},this.setLogs=function(e){1e3===this.logsBuffer&&this.logsBuffer.shift(),this.logsBuffer.push(e)}}])},function(){window.config={xmpp:{protocol:"wss",server:"sandbox.openrainbow.com",port:"443",pingInterval:"60000"},webservices:{protocol:"https",server:"sandbox.openrainbow.com",port:"443"},cpaas:{protocol:"https",server:"",port:"8887"}}},function(){angular.module("sdk").service("connectionService",["$q","$log","$rootScope","authService","xmppService","companyService","contactService","botService","fileServerService","fileStorageService","roomService","groupService","videoService","webrtcServiceEventHandler","telephonyService","conferenceService","pstnConferenceService","webConferenceService","conversationService","callLogService","platformService","invitationService","adminCompanyService","adminUserService","profileService","channelService","cpaasService","webrtcGatewayService","recordsService","SDK",function(e,t,n,r,i,a,o,s,c,l,d,u,h,f,p,m,v,g,C,S,E,b,y,R,T,I,A,N,O,D){"use strict";var P=this,w="ConnectSrv | ",_="disconnected";this.RAINBOW_ONCONNECTIONSTATECHANGED="rainbowconnectionstatechanged",this.RAINBOW_ONSTARTED="started",this.RAINBOW_ONSIGNED="signed",this.RAINBOW_ONSTOPPED="stopped",this.RAINBOW_CONNECTIONINPROGRESS="inProgress",this.RAINBOW_ONUSERTOKENRENEW="userTokenRenew",this.RAINBOW_ONUSERTOKENRENEWFAILED="userTokenRenewFailed",this.RAINBOW_ONAPPTOKENRENEW="applicationTokenRenew",this.RAINBOW_ONAPPTOKENRENEWFAILED="applicationTokenRenewFailed",this.RAINBOW_CONNECTIONCONNECTED="connected",this.RAINBOW_CONNECTIONDISCONNECTED="disconnected",this.RAINBOW_OFFICIAL_HOST="openrainbow.com",this.RAINBOW_BETA_HOST="openrainbow.net",this.RAINBOW_DEV_HOST="openrainbow.org",this.RAINBOW_SANDBOX_HOST="sandbox.openrainbow.com";var M=this.RAINBOW_SANDBOX_HOST;this.RAINBOW_CPAASPREPROD_HOST="cpaaspreprod.openrainbow.net";M=this.RAINBOW_CPAASPREPROD_HOST;this.RAINBOW_CHINA_HOST="openrainbow.cn.com";M=this.RAINBOW_CHINA_HOST;this.RAINBOW_CHINASANDBOX_HOST="sandbox.openrainbow.cn.com";M=this.RAINBOW_CHINASANDBOX_HOST;this.signin=function(e,t){return M=this.RAINBOW_SANDBOX_HOST,k(e,t,null)},this.signinOnRainbowOfficial=function(e,t){return M=this.RAINBOW_OFFICIAL_HOST,k(e,t,null)},this.signinOnRainbowBeta=function(e,t){return M=this.RAINBOW_BETA_HOST,k(e,t,null)},this.signinOnRainbowCPaasPreProd=function(e,t){return M=this.RAINBOW_CPAASPREPROD_HOST,k(e,t,null)},this.signinOnRainbowDev=function(e,t){return M=this.RAINBOW_DEV_HOST,k(e,t,null)},this.signinOnRainbowSandboxChina=function(e,t){return M=this.RAINBOW_CHINASANDBOX_HOST,k(e,t,null)},this.signinOnRainbowHosted=function(e,t,n){return M=n,k(e,t,null)},this.signinSandBoxWithToken=function(e){return M=this.RAINBOW_SANDBOX_HOST,k(null,null,e)},this.signinOnRainbowOfficialWithToken=function(e){return M=this.RAINBOW_OFFICIAL_HOST,k(null,null,e)},this.signinOnRainbowBetaWithToken=function(e){return M=this.RAINBOW_BETA_HOST,k(null,null,e)},this.signinOnRainbowDevWithToken=function(e){return M=this.RAINBOW_DEV_HOST,k(null,null,e)},this.signinOnRainbowHostedWithToken=function(e,t){return M=t,k(null,null,e)},this.signout=function(){var r=e.defer(),E={code:D.OK,label:"OK"};return t.sdk(w+"[signout    ] :: Try to sign-out..."),h.stop().then(function(){return t.sdk(w+"[signout    ] :: Video service stopped"),f.stop()}).then(function(){return t.sdk(w+"[signout    ] :: WebRTCEventHandler service stopped"),o.stop()}).then(function(){return t.sdk(w+"[signout    ] :: Contact service stopped"),s.stop()}).then(function(){return t.sdk(w+"[signout    ] :: Bot service stopped"),T.stop()}).then(function(){return t.sdk(w+"[signout    ] :: Profile service stopped"),C.stop()}).then(function(){return t.sdk(w+"[signout    ] :: Conversation service stopped"),m.stop()}).then(function(){return t.sdk(w+"[signout    ] :: Conference service stopped"),g.stop()}).then(function(){return t.sdk(w+"[signout    ] :: Web Conference service stopped"),v.stop()}).then(function(){return t.sdk(w+"[signout    ] :: PTSN Conference service stopped"),S.stop()}).then(function(){return t.sdk(w+"[signout    ] :: ChannelService service stopped"),I.stop()}).then(function(){return t.sdk(w+"[signout    ] :: CallLog service stopped"),p.stop()}).then(function(){return t.sdk(w+"[signout    ] :: Telephony service stopped"),c.stop()}).then(function(){return t.sdk(w+"[signout    ] :: FileServer service stopped"),l.stop()}).then(function(){return t.sdk(w+"[signout    ] :: FileStorage service stopped"),b.stop()}).then(function(){return t.sdk(w+"[signout    ] :: Group service stopped"),u.stop()}).then(function(){return t.sdk(w+"[signout    ] :: Room service stopped"),d.stop()}).then(function(){return t.sdk(w+"[signout    ] :: Company service stopped"),a.stop()}).then(function(){return t.sdk(w+"[signout    ] :: Admin Company service stopped"),y.stop()}).then(function(){return t.sdk(w+"[signout    ] :: Admin User service stopped"),R.stop()}).then(function(){return t.sdk(w+"[signout    ] :: Invitation service stopped"),N.stop()}).then(function(){return t.sdk(w+"[signout    ] :: webrtcGateway service stopped"),i.stop()}).then(function(){return t.sdk(w+"[signout    ] :: Records service stopped"),O.stop()}).then(function(){t.sdk(w+"[signout    ] :: XMPP service stopped"),t.sdk(w+"[signout    ] :: Services Successfully unloaded!"),sdk.useAngularEvents?n.$broadcast(P.RAINBOW_ONSTOPPED):$(document).trigger(P.RAINBOW_ONSTOPPED,null),r.resolve(E)}).catch(function(e){return t.sdk(w+"[signout    ] :: Error during signout..."),r.reject(e),r.promise}),r.promise},this.updateUserPassword=function(e,t){return o.updateUserPassword(e,t,!1)},this.getState=function(){return _},this.getToken=function(){return r.token};var k=function(A,_,k){var L=e.defer(),F=!1;if(k)F=!0,A=null,_=null;else{if(!A)return L.reject({code:D.ERRORBADREQUEST,label:"Parameter 'login' is missing or empty"});if(!_)return L.reject({code:D.ERRORBADREQUEST,label:"Parameter 'password' is missing or empty"})}t.sdk(w+"[signin     ] :: Rainbow host used "+M),F?t.sdk(w+"[signin     ] :: Try to sign-in with given token"):t.sdk(w+"[signin     ] :: Try to sign-in with "+A+"...");var B={code:D.OK,label:"",account:null};return r.removeCredentials(),r.authenticateOnHost(A,_,M,{appID:sdk.key.appID,appSecret:sdk.key.appSecret},k).then(function(){B.account={},B.label="ok",B.account.userId=r.userId,B.account.companyId=r.companyId,B.account.loginEmail=r.login,B.account.roles=r.userData.roles,B.token=r.token,B.userData=r.userData;var _=[];t.sdk(w+"[signin     ] :: Successfully sign-in with "+A+" | "+r.jidIm),sdk.useAngularEvents?n.$broadcast(P.RAINBOW_ONSIGNED,B):$(document).trigger(P.RAINBOW_ONSIGNED,[B]),r.startTokenSurvey(),t.sdk(w+"[signin     ] :: Start services..."),i.disconnectionHandler=U,i.start(_).then(function(){return t.sdk(w+"[signin     ] :: XMPP service ready!"),a.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: Company service ready!"),y.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: Admin company service ready!"),R.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: Admin user service ready!"),o.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: Contact service ready!"),T.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: Profile service ready!"),b.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: Invitation service ready!"),c.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: FileServer service ready!"),l.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: FileStorage service ready!"),d.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: Room service ready!"),u.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: Group service ready!"),N.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: WebrtcGateway service ready!"),h.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: Video service ready!"),f.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: WebRTCEventHandler service ready!"),p.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: Telephony service ready!"),v.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: PSTN Conference service ready!"),g.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: Web Conference service ready!"),C.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: Conversation service ready!"),t.sdk(w+"[signin     ] :: Send initial presence"),o.sendPresenceFromConfiguration(),e.when()}).then(function(){return t.sdk(w+"[signin     ] :: Initial presence sent !"),S.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: CallLog service ready!"),E.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: Platform service ready!"),s.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: Bot service ready!"),m.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: Conference service ready!"),O.start(_)}).then(function(){return t.sdk(w+"[signin     ] :: Records service ready!"),I.start(_)}).then(function(){t.sdk(w+"[signin     ] :: Channel service ready!"),t.sdk(w+"[signin     ] :: Services Successfully loaded!"),n.$broadcast("ON_CONNECTION_STATE_CHANGE_EVENT","connected"),sdk.useAngularEvents?n.$broadcast(P.RAINBOW_ONSTARTED):$(document).trigger(P.RAINBOW_ONSTARTED,B),L.resolve(B)}).catch(function(e){t.sdk(w+"[signin     ] :: Error during signin"),console.log("[SIGNIN ERROR]",e),B.code=D.ERRORXMPP,B.label="errorXMPP",B.account=null,L.reject(B)})}).catch(function(){t.sdk(w+"[signin     ] :: Error during signin"),B.code=D.ERRORUNAUTHORIZED,B.label="errorUnauthorized",L.reject(B)}),L.promise},U=function(){t.sdk(w+"[discHandler] :: Disconnected from the XMPP Rainbow Cloud Services")},L=function(e,r){t.sdk(w+"[onChange   ] :: Connection state changed to "+r),_=r,sdk.useAngularEvents?n.$broadcast(P.RAINBOW_ONCONNECTIONSTATECHANGED,r):$(document).trigger(P.RAINBOW_ONCONNECTIONSTATECHANGED,[r])};n.$on("$destroy",n.$on("ON_CONNECTION_STATE_CHANGE_EVENT",L)),n.$on("$destroy",n.$on("ON_AUTH_TOKEN_RENEW",function(){sdk.useAngularEvents?n.$broadcast(P.RAINBOW_ONUSERTOKENRENEW):$(document).trigger(P.RAINBOW_ONUSERTOKENRENEW)})),n.$on("$destroy",n.$on("ON_AUTH_TOKEN_EXPIRE",function(){sdk.useAngularEvents?n.$broadcast(P.RAINBOW_ONUSERTOKENRENEWFAILED):$(document).trigger(P.RAINBOW_ONUSERTOKENRENEWFAILED,null),signout()})),n.$on("$destroy",n.$on("ON_AUTH_TOKEN_RENEW",function(){sdk.useAngularEvents?n.$broadcast(P.RAINBOW_ONAPPTOKENRENEW):$(document).trigger(P.RAINBOW_ONAPPTOKENRENEW,null)})),n.$on("$destroy",n.$on("ON_AUTH_TOKEN_EXPIRE",function(){sdk.useAngularEvents?n.$broadcast(P.RAINBOW_ONAPPTOKENRENEWFAILED):$(document).trigger(P.RAINBOW_ONAPPTOKENRENEWFAILED,null),signout()})),window.addEventListener("beforeunload",function(){n.$broadcast("ON_CONNECTION_STATE_CHANGE_EVENT","disconnected"),h.stop(),o.stop(),C.stop(),u.stop(),p.stop(),c.stop(),l.stop(),S.stop(),i.stop(),T.stop(),O.stop(),I.stop(),N.stop()})}])},function(){angular.module("sdk").service("presenceService",["$log","$rootScope","xmppService","contactService","SDK",function(e,t,n,r,i){"use strict";var a=this,o="PresenceSvr| ";this.RAINBOW_PRESENCE_ONLINE="online",this.RAINBOW_PRESENCE_AWAY="away",this.RAINBOW_PRESENCE_DONOTDISTURB="dnd",this.RAINBOW_PRESENCE_OFFLINE="xa",this.RAINBOW_PRESENCE_BUSY="busy",this.RAINBOW_PRESENCE_UNKNOW="unknow",this.RAINBOW_ONCONTACTPRESENCECHANGED="rainbowcontactpresencechanged",this.RAINBOW_ONPRESENCECHANGED="rainbowpresencechanged",this.RAINBOW_ONCONTACTRICHPRESENCECHANGED="rainbowcontactrichpresencechanged",this.RAINBOW_ONRICHPRESENCECHANGED="rainbowrichpresencechanged",this.setPresenceTo=function(t){return t!==this.RAINBOW_PRESENCE_DONOTDISTURB&&t!==this.RAINBOW_PRESENCE_AWAY&&t!==this.RAINBOW_PRESENCE_OFFLINE&&t!==this.RAINBOW_PRESENCE_ONLINE?{code:i.ERRORBADREQUEST,label:"Parameter 'strPresenceState' should be 'dnd', 'away', 'xa' (invisible) or 'online'"}:(e.sdk(o+"[setPresTo  ] :: Set presence to "+t),r.changeMyPresence(t),{code:i.OK,label:"OK"})},t.$on("$destroy",t.$on("ON_ROSTER_PRESENCE_CHANGED_EVENT",function(r,i){var s=i.message||"''";i.jid===n.fullJid?(e.sdk(o+"[onChange   ] :: Presence changed for me ("+i.jid+") to  "+i.status+" | "+s),sdk.useAngularEvents?t.$broadcast(a.RAINBOW_ONPRESENCECHANGED,i):$(document).trigger(a.RAINBOW_ONPRESENCECHANGED,[i])):(e.sdk(o+"[onChange   ] :: Presence changed for contact ("+i.jid+") to  "+i.status+" | "+s),sdk.useAngularEvents?t.$broadcast(a.RAINBOW_ONCONTACTPRESENCECHANGED,i):$(document).trigger(a.RAINBOW_ONCONTACTPRESENCECHANGED,[i]))})),t.$on("$destroy",t.$on("ON_UPDATE_CONTACT_RICH_STATUS_EVENT",function(r,i){var s=i.message||"''",c=i.telStatus||"''";n.fullJid.includes(i.jid)?(e.sdk(o+"[onChange   ] :: Rich Presence changed for myself to status "+i.status+", message "+s+" and telStatus "+c),sdk.useAngularEvents?t.$broadcast(a.RAINBOW_ONRICHPRESENCECHANGED,i):$(document).trigger(a.RAINBOW_ONRICHPRESENCECHANGED,[i])):(e.sdk(o+"[onChange   ] :: Rich Presence changed for contact ("+i.jid+") to status "+i.status+", message "+s+" and telStatus "+c),sdk.useAngularEvents?t.$broadcast(a.RAINBOW_ONCONTACTRICHPRESENCECHANGED,i):$(document).trigger(a.RAINBOW_ONCONTACTRICHPRESENCECHANGED,[i]))}))}])},function(){angular.module("sdk").service("userProfileService",["$q","$log","$rootScope","contactService","xmppService","profileService","adminUserService","SDK",function(e,t,n,r,i,a,o,s){"use strict";var c="UserProfile| ";this.getProfile=function(){var n=e.defer();return a.getUserData().then(function(e){t.sdk(c+"[getProfile] :: got");var r={name:e.lastName,firstName:e.firstName,phoneNumbers:e.phoneNumbers};n.resolve(r)}).catch(function(e){t.sdk(c+"[getProfile] :: Error when trying to get Profile - "+e),n.reject(e)}),n.promise},this.updateFirstName=function(n){var r=e.defer();return!n||"string"!=typeof n||1>n.length?r.reject({code:s.ERRORBADREQUEST,label:"Parameter 'strFirstname' is missing, empty or null"}):a.setUserData({firstName:n}).then(function(e){t.sdk(c+"[updateFirstName] :: First name updated");var n={lastName:e.data.lastName,firstName:e.data.firstName,phoneNumbers:e.data.phoneNumbers};r.resolve(n)}).catch(function(e){t.sdk(c+"[updateFirstName] :: Error when updating first name - "+e),r.reject(e)}),r.promise},this.updateLastName=function(n){var r=e.defer();return!n||"string"!=typeof n||1>n.length?r.reject({code:s.ERRORBADREQUEST,label:"Parameter 'strName' is missing, empty or null"}):a.setUserData({lastName:n}).then(function(e){t.sdk(c+"[updateName] :: Name updated");var n={lastName:e.data.lastName,firstName:e.data.firstName,phoneNumbers:e.data.phoneNumbers};r.resolve(n)}).catch(function(e){t.sdk(c+"[updateName] :: Error when updating name - "+e),r.reject(e)}),r.promise},this.updatePhoneNumber=function(n,r,i,o){var l=e.defer();if((!n||"string"!=typeof n||0>["home","work","other"].indexOf(n))&&l.reject({code:s.ERRORBADREQUEST,label:"Parameter 'type' is missing or not in 'home', 'work', 'other'"}),!r||"string"!=typeof r||0>["landline","mobile","fax","other"].indexOf(r))l.reject({code:s.ERRORBADREQUEST,label:"Parameter 'deviceType' is missing or not in 'landline', 'mobile', 'fax', 'other'"});else if(i&&"string"==typeof i){var d={phoneNumbers:[{type:n,deviceType:r,number:i}]};o&&"string"==typeof o&&(d.country=o),a.getUserData().then(function(e){if(e.phoneNumbers.length){return e.phoneNumbers.some(function(e){return e.type===n&&e.deviceType===r&&(e.number=i,!0)})||e.phoneNumbers.push({type:n,deviceType:r,number:i}),a.setUserData(e)}return a.setUserData(d)}).then(function(e){t.sdk(c+"[updatePhoneNumber] :: Phone number updated");var n={lastName:e.data.lastName,firstName:e.data.firstName,phoneNumbers:e.data.phoneNumbers};l.resolve(n)}).catch(function(e){t.sdk(c+"[updatePhoneNumber] :: Error when updating phone number - "+e),l.reject(e)})}else l.reject({code:s.ERRORBADREQUEST,label:"Parameter 'strPhoneNumber' is missing, empty or null"});return l.promise},this.updatePhotoFromUrl=function(n){var i=e.defer();return!n||"string"!=typeof n||1>n.length?i.reject({code:s.ERRORBADREQUEST,label:"Parameter 'imgUrl' is missing, empty or null"}):r.pushAvatarImage(n).then(function(){t.sdk(c+"[updatePhotoFromUrl] :: Photo updated"),i.resolve()}).catch(function(e){t.sdk(c+"[updatePhotoFromUrl] :: Error when updating Photo - "+e),i.reject(e)}),i.promise}}])},function(){angular.module("sdk").service("contactsService",["$log","$q","$rootScope","contactService","directoryService","invitationService","SDK",function(e,t,n,r,i,a,o){"use strict";var s=this,c="ContactsSrv| ";this.RAINBOW_ONCONTACTINFORMATIONCHANGED="rainbowcontactinformationchanged",this.RAINBOW_ONINFORMATIONCHANGED="rainbowinformationchanged",this.RAINBOW_ONCONTACTINVITATIONNUMBERCHANGED="rainbowsubscriptionnumberchanged",this.RAINBOW_ONCONTACTINVITATIONRECEIVED="rainbowinvitationreceived",this.getContactByJID=function(e){return e?r.getContactByJid(e):{code:o.ERRORBADREQUEST,label:"Parameter 'strJID' is missing or empty"}},this.getContactById=function(e){return e?r.getContactById(e):{code:o.ERRORBADREQUEST,label:"Parameter 'strId' is missing or empty"}},this.getNetworkContacts=function(){return r.getContacts().filter(function(e){return e.id!==r.userContact.id&&!e.isBot&&e.roster})},this.getAll=function(){return r.getContacts().filter(function(e){return e.id!==r.userContact.id&&!e.isBot})},this.getConnectedUser=function(){return r.userContact||null},this.getConnectedUserPhone=function(){return r.userContact?0===r.userContact.pbxId.length?null:{phoneNumber:r.userContact.phonePbx,pbxId:r.userContact.pbxId}:null},this.searchByName=function(e,n){var r=t.defer();return e?(!n&&(n=20),i.search(e,!0,Math.min(n,1e3)).then(function(e){r.resolve(e)}).catch(function(e){r.reject(e)})):r.reject({code:o.ERRORBADREQUEST,label:"Parameter 'strName' is missing or empty"}),r.promise},this.searchByLogin=function(e){var n=t.defer();return e?i.searchUserByLogin(e).then(function(e){n.resolve(e)}).catch(function(e){404===e.status||400===e.status?n.resolve(null):n.reject(e)}):n.reject({code:o.ERRORBADREQUEST,label:"Parameter 'strLogin' is missing or empty"}),n.promise},this.searchByJid=function(e){var n=t.defer();return e?i.searchUserByJid(e).then(function(e){n.resolve(e)}).catch(function(e){404===e.status||400===e.status?n.resolve(null):n.reject(e)}):n.reject({code:o.ERRORBADREQUEST,label:"Parameter 'strJid' is missing or empty"}),n.promise},this.searchById=function(e){var n=t.defer();return e?r.getContactByDBId(e,!0).then(function(e){n.resolve(e)}).catch(function(e){404===e.status||400===e.status?n.resolve(null):n.reject(e)}):n.reject({code:o.ERRORBADREQUEST,label:"Parameter 'strId' is missing or empty"}),n.promise},this.acceptInvitation=function(e){var n=t.defer();return e?a.acceptInvitation(e).then(function(){n.resolve({code:o.OK,label:"OK"})}).catch(function(e){n.reject(e)}):n.reject({code:o.ERRORBADREQUEST,label:"Parameter 'invitation' is missing or null"}),n.promise},this.declineInvitation=function(e){var n=t.defer();return e?(a.declineInvitation(e).then(function(){n.resolve({code:o.OK,label:"OK"})}).catch(function(e){n.reject(e)}),n.promise):n.reject({code:o.ERRORBADREQUEST,label:"Parameter 'invitation' is missing or null"})},this.addToNetwork=function(e){var n=t.defer();return e?(a.joinContactInvitation(e).then(function(){n.resolve(e)}).catch(function(e){n.reject(e)}),n.promise):{code:o.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}},this.sendInvitationByEmail=function(e,n){var r=t.defer();return e?a.sendInvitationByEmail(e,n).then(function(){r.resolve(contact)}).catch(function(e){r.reject(e)}):r.reject({code:o.ERRORBADREQUEST,label:"Parameter 'email' is missing or null"}),r.promise},this.removeFromNetwork=function(e){var n=t.defer();return e||n.reject({code:o.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}),r.removeContact(e).then(function(){n.resolve({code:o.OK,label:"OK"})}).catch(function(e){n.reject(e)}),n.promise},this.getInvitationById=function(e){return e?a.getInvitation(e):{code:o.ERRORBADREQUEST,label:"Parameter 'strInvitationId' is missing or null"}},this.getInvitationsReceived=function(){return a.getReceivedInvitations()},this.cancelInvitation=function(e){var n=t.defer();return e?a.cancelOneSendInvitation(e).then(function(){n.resolve({code:o.OK,label:"OK"})}).catch(function(e){n.reject(e)}):n.reject({code:o.ERRORBADREQUEST,label:"Parameter 'invitation' is missing or null"}),n.promise},this.getInvitationsSent=function(){return a.getSentInvitations()},n.$on("$destroy",n.$on("ON_CONTACT_UPDATED_EVENT",function(t,r){e.sdk(c+"[onChange   ] :: Information changed for contact "+r.displayNameForLog()),sdk.useAngularEvents?n.$broadcast(s.RAINBOW_ONCONTACTINFORMATIONCHANGED,r):$(document).trigger(s.RAINBOW_ONCONTACTINFORMATIONCHANGED,[r])})),n.$on("$destroy",n.$on("ON_USER_CONTACT_UPDATED_EVENT",function(t,r){e.sdk(c+"[onChange   ] :: Information changed for me ("+r.displayNameForLog()+")"),sdk.useAngularEvents?n.$broadcast(s.RAINBOW_ONINFORMATIONCHANGED,r):$(document).trigger(s.RAINBOW_ONINFORMATIONCHANGED,[r])})),n.$on("$destroy",n.$on("ON_INVITATIONS_NUMBER_UPDATED",function(){e.sdk(c+"[onChange   ] :: Invitation number changed"),sdk.useAngularEvents?n.$broadcast(s.RAINBOW_ONCONTACTINVITATIONNUMBERCHANGED):$(document).trigger(s.RAINBOW_ONCONTACTINVITATIONNUMBERCHANGED,[])})),n.$on("$destroy",n.$on("ON_INVITATION_CHANGED",function(t,r){e.sdk(c+"[onChange   ] :: Invitation received"),sdk.useAngularEvents?n.$broadcast(s.RAINBOW_ONCONTACTINVITATIONRECEIVED,r):$(document).trigger(s.RAINBOW_ONCONTACTINVITATIONRECEIVED,[r])}))}])},function(){angular.module("sdk").service("pbxService",["$q","$log","$rootScope","telephonyService","Call","SDK",function(e,t,n,r,i,a){"use strict";var o=this,s="TelphonySrv| ";this.RAINBOW_ONTELEPHONYCALLSTATECHANGED="rainbowontelephonycallstatechanged",this.RAINBOW_ONTELEPHONYSTARTED="rainbowontelephonystarted",this.RAINBOW_ONTELEPHONYSTOPPED="rainbowontelephonystopped",this.RAINBOW_ONTELEPHONYFORWARDSTATECHANGED="rainbowontelephonyforwardstatechanged",this.RAINBOW_TELEPHONYDIALING="dialing",this.RAINBOW_TELEPHONYRINGINGOUTGOING="ringingOutgoing",this.RAINBOW_TELEPHONYINCOMING="incomingCall",this.RAINBOW_TELEPHONYACTIVE="active",this.RAINBOW_TELEPHONYRELEASING="releasing",this.RAINBOW_TELEPHONYUNKNOW="Unknown",this.isTelephonyAvailable=function(){return r.started},this.getAgentVersion=function(){return r.agentStatus.agentVersion||"unknown"},this.getXMPPAgentStatus=function(){return r.agentStatus.xmppAgent||"unknown"},this.getPhoneAPIStatus=function(){return r.agentStatus.phoneApi||"unknown"},this.callByNumber=function(t){var n=e.defer();return t?r.makeCallByPhoneNumber(t).then(function(){n.resolve({code:a.OK,label:"OK"})}).catch(function(e){n.reject({code:a.ERROR,label:e})}):n.reject({code:a.ERRORBADREQUEST,label:"Parameter 'strPhoneNumber' is missing or empty"}),n.promise},this.callWithSubject=function(t,n,i){var o=e.defer();return t?n?i?r.makeCall(t,n,i).then(function(){o.resolfe({code:a.OK,label:"OK"}).catch(function(e){o.reject({code:a.ERROR,label:e})})}):o.reject({code:a.ERRORBADREQUEST,label:"Parameter 'callSubject' is missing or empty"}):o.reject({code:a.ERRORBADREQUEST,label:"Parameter 'phoneNumber' is missing or empty"}):o.reject({code:a.ERRORBADREQUEST,label:"Parameter 'contact' is missing or empty"}),o.promise},this.calls=function(){return r.calls},this.release=function(t){var n=e.defer();return t?r.releaseCall(t).then(function(){n.resolve({code:a.OK,label:"OK"})}).catch(function(e){n.reject({code:a.ERROR,label:e})}):n.reject({code:a.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}),n.promise},this.deflectToVM=function(t){var n=e.defer();return t?r.deflectCallToVM(t).then(function(){n.resolve({code:a.OK,label:"OK"})}).catch(function(e){n.reject({code:a.ERROR,label:e})}):n.reject({code:a.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}),n.promise},this.forwardToDevice=function(t){var n=e.defer();return t&&"string"==typeof t&&0!==t.length?r.forwardToDevice(t).then(function(){n.resolve({code:a.OK,label:"OK"})}).catch(function(e){n.reject({code:a.ERROR,label:e})}):n.reject({code:a.ERRORBADREQUEST,label:"Parameter 'strPhoneNumber' is missing or empty"}),n.promise},this.forwardToVoicemail=function(){var t=e.defer();return r.forwardToVoicemail().then(function(){t.resolve({code:a.OK,label:"OK"})}).catch(function(e){t.reject({code:a.ERROR,label:e})}),t.promise},this.cancelForward=function(){var t=e.defer();return r.cancelForward().then(function(){t.resolve({code:a.OK,label:"OK"})}).catch(function(e){t.reject({code:a.ERROR,label:e})}),t.promise},this.getForwardStatusFromServer=function(){var t=e.defer();return r.getForwardStatus().then(function(){t.resolve({code:a.OK,label:"OK"})}).catch(function(e){t.reject({code:a.ERROR,label:e})}),t.promise},this.getForwardStatus=function(){return r.getForwardObject()},this.answer=function(t){var n=e.defer();return t?r.answerCall(t).then(function(){n.resolve({code:a.OK,label:"OK"})}).catch(function(e){n.reject({code:a.ERROR,label:e})}):n.reject({code:a.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}),n.promise},this.hold=function(t){var n=e.defer();return t?r.holdCall(t).then(function(){n.resolve({code:a.OK,label:"OK"})}).catch(function(e){n.reject({code:a.ERROR,label:e})}):n.reject({code:a.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}),n.promise},this.retrieve=function(t){var n=e.defer();return t?r.retrieveCall(t).then(function(){n.resolve({code:a.OK,label:"OK"})}).catch(function(e){n.reject({code:a.ERROR,label:e})}):n.reject({code:a.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}),n.promise},this.transfertCall=function(t,n){var i=e.defer();return t?n?r.transfertCall(t,n).then(function(){i.resolve({code:a.OK,label:"OK"})}).catch(function(e){i.reject({code:a.ERROR,label:e})}):i.reject({code:a.ERRORBADREQUEST,label:"Parameter 'heldCall' is missing or null"}):i.reject({code:a.ERRORBADREQUEST,label:"Parameter 'activeCall' is missing or null"}),i.promise},this.conferenceCall=function(t,n){var i=e.defer();return t?n?r.conferenceCall(t,n).then(function(){i.resolve({code:a.OK,label:"OK"})}).catch(function(e){i.reject({code:a.ERROR,label:e})}):i.reject({code:a.ERRORBADREQUEST,label:"Parameter 'heldCall' is missing or null"}):i.reject({code:a.ERRORBADREQUEST,label:"Parameter 'activeCall' is missing or null"}),i.promise},n.$on("$destroy",n.$on("ON_CALL_FORWARDED_EVENT",function(e,r){t.sdk(s+"[onForwardChange] :: Forward state changed to "+r),sdk.useAngularEvents?n.$broadcast(o.RAINBOW_ONTELEPHONYFORWARDSTATECHANGED,r):$(document).trigger(o.RAINBOW_ONTELEPHONYFORWARDSTATECHANGED,[r])})),n.$on("$destroy",n.$on("ON_TELEPHONY_STATUS_CHANGED_EVENT",function(e,r){t.sdk(s+"[onChange   ] :: PBX state changed to "+r),"started"===r?sdk.useAngularEvents?n.$broadcast(o.RAINBOW_ONTELEPHONYSTARTED):$(document).trigger(o.RAINBOW_ONTELEPHONYSTARTED,null):sdk.useAngularEvents?n.$broadcast(o.RAINBOW_ONTELEPHONYSTOPPED):$(document).trigger(o.RAINBOW_ONTELEPHONYSTOPPED,null)})),n.$on("$destroy",n.$on("ON_CALL_UPDATED_EVENT",function(e,r){r.type.value===i.Type.PHONE.value&&(t.sdk(s+"[onTelChange] :: Telephony state changed to "+r),sdk.useAngularEvents?n.$broadcast(o.RAINBOW_ONTELEPHONYCALLSTATECHANGED,r):$(document).trigger(o.RAINBOW_ONTELEPHONYCALLSTATECHANGED,[r]))}))}])},function(){angular.module("sdk").service("conversationsService",["$q","$log","$rootScope","Conversation","conversationService","SDK",function(e,t,n,r,i,a){"use strict";var o=this,s="ConversSrv | ";this.RAINBOW_ONCONVERSATIONREMOVED="rainbowconversationremoved",this.RAINBOW_ONCONVERSATIONCHANGED="rainbowconversationchanged",this.RAINBOW_ONCONVERSATIONSCHANGED="rainbowconversationschanged",this.RAINBOW_ONCONVERSATIONSMISSEDCOUNTERCHANGED="rainbowconversationsmissedcounterchanged",this.getAllConversations=function(){var e=i.getConversations(),t=[];return e.forEach(function(e){t.push(e)}),t},this.getCallById=function(e){if(!e)return{code:a.ERRORBADREQUEST,label:"Parameter 'strCallId' is missing or empty"};var t=i.getConversations(),n=null;return t.forEach(function(t){t.videoCall&&t.videoCall.id===e?n=t.videoCall:t.audioCall&&t.audioCall.id===e&&(n=t.audioCall)}),n},this.getConversationById=function(e){return e?i.getConversationById(e):{code:a.ERRORBADREQUEST,label:"Parameter 'callId' is missing or empty"}},this.getConversationByBubbleId=function(e){return e?i.getConversationByRoomDbId(e):{code:a.ERRORBADREQUEST,label:"Parameter 'strBubbleId' is missing or empty"}},this.openConversationForContact=function(n){var r=e.defer();return n?(t.sdk(s+"[createConve] :: Try to create of get a conversation with "+n.lastname+" "+n.firstname),i.getOrCreateOneToOneConversation(n.jid).then(function(e){t.sdk(s+"[createConve] :: Conversation retrieved or created "+e.id),r.resolve(e)}).catch(function(e){t.sdk(s+"[createConve] :: Error"),r.reject(e)})):r.reject({code:a.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}),r.promise},this.openConversationForBubble=function(n){var r=e.defer();return n?(t.sdk(s+"[createConve] :: Try to create or get a conversation for a bubble "+n.name+"("+n.id+")"),i.getRoomConversation(n.jid).then(function(e){t.sdk(s+"[createConve] :: Conversation retrieved or created "+e.id),r.resolve(e)}).catch(function(e){t.sdk(s+"[createConve] :: Error"),r.reject(e)})):r.reject({code:a.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),r.promise},this.closeConversation=function(t){var n=e.defer();return t?i.closeConversation(t).then(function(){n.resolve(null)}).catch(function(e){n.reject(e)}):n.reject({code:a.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}),n.promise},n.$on("$destroy",n.$on("ON_CONVERSATIONS_UPDATED_EVENT",function(e,t){t&&(sdk.useAngularEvents?n.$broadcast(o.RAINBOW_ONCONVERSATIONSCHANGED,t):$(document).trigger(o.RAINBOW_ONCONVERSATIONSCHANGED,[t]))})),n.$on("$destroy",n.$on("ON_CONVERSATION_REMOVE_EVENT",function(e,t){sdk.useAngularEvents?n.$broadcast(o.RAINBOW_ONCONVERSATIONREMOVED,t):$(document).trigger(o.RAINBOW_ONCONVERSATIONREMOVED,[t])})),n.$on("$destroy",n.$on("ON_CONVERSATION_UPDATED_EVENT",function(e,t){sdk.useAngularEvents?n.$broadcast(o.RAINBOW_ONCONVERSATIONCHANGED,t):$(document).trigger(o.RAINBOW_ONCONVERSATIONCHANGED,[t])})),n.$on("$destroy",n.$on("ON_MISSED_COUNTER_CHANGED_EVENT",function(e,t){sdk.useAngularEvents?n.$broadcast(o.RAINBOW_ONCONVERSATIONSMISSEDCOUNTERCHANGED,t):$(document).trigger(o.RAINBOW_ONCONVERSATIONSMISSEDCOUNTERCHANGED,[t])}))}])},function(){angular.module("sdk").service("imService",["$q","$rootScope","$log","roomService","fileStorageService","conversationService","Conversation","Message","SDK",function(e,t,n,r,i,a,o,s,c){"use strict";var l=this;this.RAINBOW_ONNEWIMMESSAGERECEIVED="rainbownewimmessagereceived",this.RAINBOW_ONNEWIMRECEIPTRECEIVED="rainbownewimreceiptreceived",this.RAINBOW_ONNEWPARTICIPANTSTATUS="rainbownewparticipantstatus",this.getMessagesFromConversation=function(t,n){var r=e.defer();return t?(n=n?Math.min(n,100):30,a.getHistoryPage(t,n)):(r.reject({code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}),r.promise)},this.getMessageFromConversationById=function(e,t){if(!e)return{code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"};if(!t)return{code:c.ERRORBADREQUEST,label:"Parameter 'strMessageId' is missing or empty"};var n=e.getMessageById(t);return n&&n.fileId&&(n.shortFileDescriptor=i.getFileDescriptorById(n.fileId)),n},this.getMessageFromBubbleById=function(e,t){if(!e)return{code:c.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"};if(!t)return{code:c.ERRORBADREQUEST,label:"Parameter 'strMessageId' is missing or empty"};var n=a.getConversationByRoomDbId(e.dbId);if(!n)return{code:c.ERRORBADREQUEST,label:"Parameter 'bubble' don't have a conversation"};if(n.type!==o.Type.ROOM)return{code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is not a bubble conversation"};var r=n.getMessageById(t);return r&&r.fileId&&(r.shortFileDescriptor=i.getFileDescriptorById(r.fileId)),r},this.sendMessageToConversation=function(e,t){return n.sdk("IMSrv      | [sendMessage] :: Try to send a message..."),e?t?1024<t.length?{code:c.ERRORBADREQUEST,label:"Parameter 'strMessage' should be lower than 1024 characters"}:a.sendChatMessage(e,t):{code:c.ERRORBADREQUEST,label:"Parameter 'strMessage' is missing or empty"}:{code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}},this.sendCorrectedChatMessage=function(e,t,n){return e?t?1024<t.length?{code:c.ERRORBADREQUEST,label:"Parameter 'strMessage' should be lower than 1024 characters"}:n?(a.sendCorrectedChatMessage(e,t,n),e.getMessageById(n)):{code:c.ERRORBADREQUEST,label:"Parameter 'messageId' is missing or empty"}:{code:c.ERRORBADREQUEST,label:"Parameter 'strMessage' is missing or empty"}:{code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}},this.deleteMessage=function(e,t){return e?t?(a.sendCorrectedChatMessage(e,"",t),e.getMessageById(t)):{code:c.ERRORBADREQUEST,label:"Parameter 'messageId' is missing or empty"}:{code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}},this.sendIsTypingStateInConversation=function(t,n){var r=e.defer();return t?"boolean"==typeof n?(t=t.id?a.getConversationById(t.id):null)?(a.sendIsTypingState(t,n),r.resolve()):r.reject({code:c.ERRORBADREQUEST,label:"Parameter 'conversation': this conversation doesn't exist"}):r.reject({code:c.ERRORBADREQUEST,label:"Parameter 'status' is missing or null"}):r.reject({code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}),r.promise},this.sendMessageToBubble=function(t,n){var i=e.defer();return t?n?1024<n.length?i.reject({code:c.ERRORBADREQUEST,label:"Parameter 'strMessage' should be lower than 1024 characters"}):a.getRoomConversation(t.jid).then(function(e){if(e)if(t.isActive){var o=a.sendChatMessage(e,n);i.resolve(o)}else r.sendInitialRoomPresenceSync(t).then(function(){var t=a.sendChatMessage(e,n);i.resolve(t)}).catch(function(){console.log(err)});else i.reject({code:c.ERRORNOTFOUND,label:"No 'conversation' found"})}):i.reject({code:c.ERRORBADREQUEST,label:"Parameter 'strMessage' is missing or empty"}):i.reject({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),i.promise},this.sendIsTypingStateInBubble=function(t,n){var r=e.defer();return t?"boolean"==typeof n?t.jid?a.getRoomConversation(t.jid).then(function(e){e?(a.sendIsTypingState(e,n),r.resolve()):r.reject({code:c.ERRORNOTFOUND,label:"No 'conversation' found for this bubble"})}):r.reject({code:c.ERRORBADREQUEST,label:"Parameter 'bubble': this bubble isn't a valid one"}):r.reject({code:c.ERRORBADREQUEST,label:"Parameter 'status' is missing or null"}):r.reject({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),r.promise},this.removeAllMessagesFromConversation=function(t){var n=e.defer();return t?t.type===o.Type.ONE_TO_ONE?a.removeAllMessages(t).then(function(){n.resolve({code:c.OK,label:"OK"})}).catch(function(e){n.reject(e)}):n.reject({code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is not a one-to-one conversation"}):n.reject({code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}),n.promise},this.markMessageFromConversationAsRead=function(e,t){return t?e?t.receiptStatus===s.ReceiptStatus.READ?{code:c.ERRORBADREQUEST,label:"Parameter 'message' is aldready marked as read"}:(e.sendAckReadMessage(t),t.receiptStatus===s.ReceiptStatus.READ&&a.decreaseMissedIMCounterForConversation(e),{code:c.OK,label:"OK"}):{code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}:{code:c.ERRORBADREQUEST,label:"Parameter 'message' is missing or empty"}},t.$on("$destroy",t.$on("ON_CONVERSATION_MESSAGE_RECEIVED",function(e,n,r,i){sdk.useAngularEvents?t.$broadcast(l.RAINBOW_ONNEWIMMESSAGERECEIVED,n,r,i):$(document).trigger(l.RAINBOW_ONNEWIMMESSAGERECEIVED,[n,r,i])})),t.$on("$destroy",t.$on("ON_CONVERSATION_RECEIPT_RECEIVED",function(e,n,r,i){sdk.useAngularEvents?t.$broadcast(l.RAINBOW_ONNEWIMRECEIPTRECEIVED,n,r,i):$(document).trigger(l.RAINBOW_ONNEWIMRECEIPTRECEIVED,[n,r,i])})),t.$on("$destroy",t.$on("ON_CONVERSATIONS_STATUS_MESSAGE_EVENT",function(e,n,r,i){i&&i.value&&(sdk.useAngularEvents?t.$broadcast(l.RAINBOW_ONNEWPARTICIPANTSTATUS,r,n,i.value):$(document).trigger(l.RAINBOW_ONNEWPARTICIPANTSTATUS,[r,n,i.value]))}))}])},function(){angular.module("sdk").service("webRTCService",["$q","$log","$rootScope","videoService","platformService","settingsService","xmppService","extensionSharingService","Call","webrtcGatewayService","recordsService","conversationService","SDK",function(e,t,n,r,i,a,o,s,c,l,d,u,h){"use strict";var f=this,p="webRTCSrv  | ";this.isChromeExtensionInstalled=!1,this.RAINBOW_ONWEBRTCCALLSTATECHANGED="rainbowonwebrtccallstatechanged",this.RAINBOW_ONWEBRTCMEDIADEVICECHANGED="rainbowonwebrtcmediadevicechanged",this.RAINBOW_ONWEBRTCERRORHANDLED="rainbowonwebrtcerrorhandled",this.RAINBOW_ONWEBRTCSTREAMADDED="rainbowonwebrtcstreamadded",this.RAINBOW_ONWEBRTCTRACKCHANGED="rainbowonwebrtctrackchanged",this.RAINBOW_ONWEBRTCTMEDIAERROROCCURED="rainbowonwebrtcmediaerroroccured",this.RAINBOW_ONWEBRTCTRECORDSTARTED="rainbowonwebrtcrecordstarted",this.RAINBOW_ONWEBRTCTRECORDSTOPPED="rainbowonwebrtcrecordstopped",this.RAINBOW_ONWEBRTCTRECORDPAUSED="rainbowonwebrtcrecordpaused",this.RAINBOW_ONWEBRTCTRECORDREMOTESTARTED="rainbowonwebrtcrecordremotestarted",this.RAINBOW_ONWEBRTCTRECORDREMOTESTOPPED="rainbowonwebrtcrecordremotestopped",this.RAINBOW_ONWEBRTCTRECORDDONE="rainbowonwebrtcrecorddone",this.RAINBOW_ONWEBRTCTRECORDERROR="rainbowonwebrtcrecorderror",this.canMakeAudioVideoCall=function(){return"https:"===location.protocol&&DetectRTC.isWebRTCSupported&&DetectRTC.isGetUserMediaSupported},this.hasAMicrophone=function(){return DetectRTC.hasMicrophone},this.hasACamera=function(){return DetectRTC.hasWebcam},this.useMicrophone=function(e){return e?(a.setSetting("microphone",e),a.setSetting("headsetMicrophone",e),{code:h.OK,label:"OK"}):{code:h.ERRORBADREQUEST,label:"Parameter 'strMicrophoneId' is missing or empty"}},this.useSpeaker=function(e){return e?(a.setSetting("speaker",e),a.setSetting("headsetSpeaker",e),a.setSetting("ringingSpeaker",e),i.setSpeakerForElement(document.getElementById("largevideo"),e),{code:h.OK,label:"OK"}):{code:h.ERRORBADREQUEST,label:"Parameter 'strSpeakerId' is missing or empty"}},this.useCamera=function(e){return e?(a.setSetting("camera",e),{code:h.OK,label:"OK"}):{code:h.ERRORBADREQUEST,label:"Parameter 'strCameraId' is missing or empty"}},this.callInAudio=function(e,t){return e?this.canMakeAudioVideoCall()?(r.makeCall(e,"audio",t),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}},this.callInVideo=function(e,t){return e?this.canMakeAudioVideoCall()?(r.makeCall(e,"video",t),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}},this.callInSharing=function(t,n){var i=e.defer();return t?this.canMakeDesktopSharingCall().then(function(){r.makeDesktopSharingCall(t,"sharingOnly",n),i.resolve({code:h.OK,label:"OK"})}).catch(function(e){i.reject(e)}):i.reject({code:h.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}),i.promise},this.callinAudioWithSharing=function(t,n){var i=e.defer();return t?this.canMakeDesktopSharingCall().then(function(){r.makeDesktopSharingCall(t,n),i.resolve({code:h.OK,label:"OK"})}).catch(function(e){i.reject(e)}):i.reject({code:h.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}),i.promise},this.answerInAudio=function(e){return e?this.canMakeAudioVideoCall()?(r.answerCall(e,"audio"),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}},this.answerInVideo=function(e){return e?this.canMakeAudioVideoCall()?(r.answerCall(e,"video"),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}},this.getPeerConnectionForCall=function(e){return e?e.id?o.connection.jingle.sessions[e.id].peerconnection:{code:h.ERRORBADREQUEST,label:"Can not get the call ID"}:{code:h.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}},this.showLocalVideo=function(){return this.canMakeAudioVideoCall()?(r.attachLocalMediaStream(!0),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}},this.hideLocalVideo=function(){return this.canMakeAudioVideoCall()?(r.attachLocalMediaStream(!1),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}},this.showRemoteVideo=function(e){return e?this.canMakeAudioVideoCall()?(r.attachDistantMediaStream(!0,e),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}},this.hideRemoteVideo=function(e){return e?this.canMakeAudioVideoCall()?(r.attachDistantMediaStream(!1,e),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}},this.addVideoToCall=function(e){return this.canMakeAudioVideoCall()?(r.addVideoToCall(e,!1),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}},this.addSharingToCall=function(t){var n=e.defer();return this.canMakeDesktopSharingCall().then(function(){r.addSharingToCall(t),n.resolve({code:h.OK,label:"OK"})}).catch(function(e){n.reject(e)}),n.promise},this.removeVideoFromCall=function(e){return this.canMakeAudioVideoCall()?(r.removeVideoFromCall(e),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}},this.removeSharingFromCall=function(e){return this.canMakeAudioVideoCall()||this.isChromeExtensionInstalled?(r.removeSharingFromCall(e),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC or Sharing is not supported by your browser"}},this.release=function(e){return e?(this.canMakeAudioVideoCall()||t.warn("[webRTCService] release called but WebRTC is not supported by your browser"),r.rejectCall(e),{code:h.OK,label:"OK"}):{code:h.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}},this.muteAudioCall=function(e){return e?this.canMakeAudioVideoCall()?(r.muteAudio(e,!0),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}},this.muteVideoCall=function(e){return e?this.canMakeAudioVideoCall()?(r.muteVideo(e,!0),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}},this.unmuteAudioCall=function(e){return e?this.canMakeAudioVideoCall()?(r.muteAudio(e,!1),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}},this.unmuteVideoCall=function(e){return e?this.canMakeAudioVideoCall()?(r.muteVideo(e,!1),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}},this.getLocalStreamsFromCall=function(e){if(!(e&&"id"in e))return{code:h.ERRORBADREQUEST,label:"Parameter 'call' is missing or empty"};if(e.type!==c.Type.WEBRTC)return{code:h.ERRORNOTFOUND,label:"This call is not an audio or audio/video call"};var t=o.connection.jingle.sessions[e.id];return t?t.localStreams:[]},this.getRemoteStreamsFromCall=function(e){if(!(e&&"id"in e))return{code:h.ERRORBADREQUEST,label:"Parameter 'call' is missing or empty"};if(e.type!==c.Type.WEBRTC)return{code:h.ERRORNOTFOUND,label:"This call is not an audio or audio/video call"};var t=o.connection.jingle.sessions[e.id];return t?t.remoteStreams:[]},this.setChromeExtensionIdForSharing=function(e){return e?(s.setExtensionId(e),{code:h.OK,label:"OK"}):{code:h.ERRORBADREQUEST,label:"Parameter 'strExtensionId' is missing or empty"}},this.canMakeDesktopSharingCall=function(){var t=e.defer();return s.isExtensionInstalled().then(function(e){e?(f.isChromeExtensionInstalled=!0,t.resolve({code:h.OK,label:"OK"})):(f.isChromeExtensionInstalled=!1,t.reject({code:h.ERRORUNSUPPORTED,label:"Not Chrome Extension installed for desktop sharing"}))}).catch(function(e){t.reject(e)}),t.promise},this.startRecording=function(e,r,i,a,o,s){if(t.sdk(p+"[startRecording] :: Enter"),!e)return{code:h.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"};if(!r)return{code:h.ERRORBADREQUEST,label:"Parameter 'fileName' is missing or null"};if(i=null==i||i,a=null==a||a,o=null!=o&&o,s=null==s?"video/webm;codecs=vp9":s,t.sdk(p+"[startRecording] :: Prepare recording..."),d.createRecord(e.id,i?"REMOTE":"LOCAL",a,r,o,s)){d.setOnPauseCallback(function(){t.sdk(p+"[onRTCChange] :: WebRTC recording paused"),sdk.useAngularEvents?n.$broadcast(f.RAINBOW_ONWEBRTCTRECORDPAUSED):$(document).trigger(f.RAINBOW_ONWEBRTCTRECORDPAUSED,null)}),t.sdk(p+"[startRecording] :: Start recording..."),d.startRecording();var c=u.getConversationById(e.conversationId);return c?(t.sdk(p+"[startRecording] :: Notify remote peer",c),u.sendRecordingMessage(c,"start")):t.sdk(p+"[startRecording] :: No conversation found - can't notify remote peer"),t.sdk(p+"[startRecording] :: WebRTC recording started"),sdk.useAngularEvents?n.$broadcast(f.RAINBOW_ONWEBRTCTRECORDSTARTED):$(document).trigger(f.RAINBOW_ONWEBRTCTRECORDSTARTED,null),{code:h.OK,label:"OK"}}return t.sdk(p+"[startRecording] :: can't start a webRTC recording"),sdk.useAngularEvents?n.$broadcast(f.RAINBOW_ONWEBRTCTRECORDERROR):$(document).trigger(f.RAINBOW_ONWEBRTCTRECORDERROR,null),{code:h.ERRORBADREQUEST,label:"Can't record the conversation"}},this.stopRecording=function(e){t.sdk(p+"[stopRecording] :: Stop current WebRTC recording"),d.setOnPauseCallback(null),d.stopRecording();var r=u.getConversationById(e.conversationId);return r?(t.sdk(p+"[stopRecording] :: Notify remote peer",r),u.sendRecordingMessage(r,"stop")):t.sdk(p+"[stopRecording] :: No conversation found - can't notify remote peer"),sdk.useAngularEvents?n.$broadcast(f.RAINBOW_ONWEBRTCTRECORDSTOPPED):$(document).trigger(f.RAINBOW_ONWEBRTCTRECORDSTOPPED,null),{code:h.OK,label:"OK"}},this.callUsingMediaPillar=function(e){return e?this.canMakeAudioVideoCall()?(l.mediaPillarMakeCall(e,null),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'number' is missing or null"}},n.$on("$destroy",n.$on("ON_CALL_UPDATED_EVENT",function(e,r){r.type.value===c.Type.WEBRTC.value&&(t.sdk(p+"[onRTCChange] :: WebRTC state changed to "+r),sdk.useAngularEvents?n.$broadcast(f.RAINBOW_ONWEBRTCCALLSTATECHANGED,r):$(document).trigger(f.RAINBOW_ONWEBRTCCALLSTATECHANGED,[r]))})),n.$on("$destroy",n.$on("ON_WEBRTC_CALL_ERROR_EVENT",function(e,r){t.sdk(p+"[onRTCError ] :: WebRTC Error"),sdk.useAngularEvents?n.$broadcast(f.RAINBOW_ONWEBRTCERRORHANDLED,r):$(document).trigger(f.RAINBOW_ONWEBRTCERRORHANDLED,[r])})),n.$on("$destroy",n.$on("ON_WEBRTC_REMOTE_STREAM_ADDED",function(e,r){t.sdk(p+"[onRTCStream] :: WebRTC remote stream added"),sdk.useAngularEvents?n.$broadcast(f.RAINBOW_ONWEBRTCSTREAMADDED,r):$(document).trigger(f.RAINBOW_ONWEBRTCSTREAMADDED,[r])})),n.$on("$destroy",n.$on("ON_WEBRTC_CALL_ESCALATION_SUCCESS",function(e,r){t.sdk(p+"[onRTCEsc   ] :: WebRTC Escalade"),sdk.useAngularEvents?n.$broadcast(f.RAINBOW_ONWEBRTCTRACKCHANGED,r):$(document).trigger(f.RAINBOW_ONWEBRTCTRACKCHANGED,[r])})),n.$on("$destroy",n.$on("ON_WEBRTC_GETUSERMEDIA_ERROR",function(e,r){t.sdk(p+"[onRTCError ] :: WebRTC getUserMedia error"),sdk.useAngularEvents?n.$broadcast(f.RAINBOW_ONWEBRTCTMEDIAERROROCCURED,r):$(document).trigger(f.RAINBOW_ONWEBRTCMEDIAERROROCCURED,[r])})),n.$on("$destroy",n.$on("ON_WEBRTC_RECORD_SAVED",function(e,r,i,a){t.sdk(p+"[onRTCRec   ] :: WebRTC record received"),sdk.useAngularEvents?n.$broadcast(f.RAINBOW_ONWEBRTCTRECORDDONE,r,i,a):$(document).trigger(f.RAINBOW_ONWEBRTCTRECORDDONE,[r,i,a])})),n.$on("$destroy",n.$on("ON_WEBRTC_RECORD_ERROR",function(){t.sdk(p+"[onRTCRec   ] :: WebRTC record error"),sdk.useAngularEvents?n.$broadcast(f.RAINBOW_ONWEBRTCTRECORDERROR):$(document).trigger(f.RAINBOW_ONWEBRTCTRECORDERROR,null)})),n.$on("$destroy",n.$on("ON_RECORDING_START_MSG_RECEIVED",function(){t.sdk(p+"[onRTCRecRem] :: WebRTC record started by remote peer"),sdk.useAngularEvents?n.$broadcast(f.RAINBOW_ONWEBRTCTRECORDREMOTESTARTED):$(document).trigger(f.RAINBOW_ONWEBRTCTRECORDREMOTESTARTED,null)})),n.$on("$destroy",n.$on("ON_RECORDING_STOP_MSG_RECEIVED",function(){t.sdk(p+"[onRTCRecRem] :: WebRTC record stopped by remote peer"),sdk.useAngularEvents?n.$broadcast(f.RAINBOW_ONWEBRTCTRECORDREMOTESTOPPED):$(document).trigger(f.RAINBOW_ONWEBRTCTRECORDREMOTESTOPPED,null)}))}])},function(){angular.module("sdk").service("bubblesService",["$q","$rootScope","$log","roomService","Room","videoService","conversationService","contactService","conferenceService","profileService","webConferenceService","PromiseQueue","SDK",function(e,t,n,r,i,a,o,s,c,l,d,u,h){"use strict";var f=this,p="BubbleSrv  | ",m=null,v=null;this.RAINBOW_ONBUBBLEINVITATIONTOJOINRECEIVED="rainbowbubblerequesttojoin",this.RAINBOW_ONBUBBLEUPDATED="rainbowbubbleupdated",this.RAINBOW_ONWEBCONFERENCEUPDATED="rainbowwebconferenceupdated",this.RAINBOW_ONWEBRTCMEDIAERROROCCURED="rainbowwebrtcmediaerroroccured",this.RAINBOW_ONBUBBLEAVATARUPDATED="rainbowbubbleavatarupdated",this.RAINBOW_ONBUBBLECONFERENCESTARTEDINVITATIONRECEIVED="rainbowbubbleconferencestartinvitation",this.RAINBOW_ONBUBBLESHARINGCONFERENCESTARTEDINVITATIONRECEIVED="rainbowbubblesharingconferencestartinvitation",this.RAINBOW_ONBUBBLEDEACTIVATED="rainbowonbubbledeactivated",this.showLocalVideo=function(){return a.attachLocalMediaStream(!0),{code:h.OK,label:"OK"}},this.createBubble=function(t,i,a,s,c){var l=e.defer(),d=null,u=!1;return a&&(u=!0),s=!!s,t?r.createRoom(t,i||"",u,c,s).then(function(e){return d=e,o.getRoomConversation(d.jid)}).then(function(e){n.sdk(p+"[create     ] :: New bubble "+t+" created successfully"),r.sendInitialRoomPresence(e.room),l.resolve(d)}).catch(function(e){n.sdk(p+"[create     ] :: Error when creating a bubble"),l.reject(e)}):l.reject({code:h.ERRORBADREQUEST,label:"Parameter 'strName' is missing or empty"}),l.promise},this.deleteBubble=function(t){var n=e.defer();return(t=t&&t.dbId?r.getRoomById(t.dbId):null)?this.closeBubble(t).then(function(e){return r.ownerDeleteRoom(e)}).then(function(e){n.resolve(e)}).catch(function(e){n.reject(e)}):n.reject({code:h.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),n.promise},this.deleteAllBubbles=function(){var e=u.create();return r.getMyRooms().forEach(function(t){e.add(function(){return f.deleteBubble(t)})}),e.execute()},this.inviteContactToBubble=function(t,a,o,s){var c=e.defer();if(a=a&&a.dbId?r.getRoomById(a.dbId):null,t)if(a){var l=i.Privilege.USER;o&&(l=i.Privilege.MODERATOR);var d=!1;"boolean"==typeof s&&(d=!s);var u=!1,f=!1,m=!1,v=!1,g=!1;a.users.forEach(function(e){if(e.contact.id===t.id)switch(e.status){case"invited":m=!0;break;case"accepted":u=!0;break;case"unsubscribed":f=!0;break;case"rejected":v=!0;break;case"deleted":g=!0}}),u||m?c.reject({code:h.ERRORBADREQUEST,label:"Contact has been already invited or is already a member of the room"}):f||v?r.ownerReinviteRejectedUser(a,t,null,l,d).then(function(e){e.updateAvatarInfo(),c.resolve(e)}).catch(function(e){n.sdk(p+"[invite     ] :: Error when inviting a contact"),c.reject(e)}):g?r.ownerReinviteDeletedUser(a,t,null,l).then(function(e){e.updateAvatarInfo(),c.resolve(e)}).catch(function(e){n.sdk(p+"[invite     ] :: Error when inviting a contact"),c.reject(e)}):r.addRoomUser(a,t,null,l,d).then(function(e){e.updateAvatarInfo(),c.resolve(e)}).catch(function(e){n.sdk(p+"[invite     ] :: Error when inviting a contact"),c.reject(e)})}else c.reject({code:h.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"});else c.reject({code:h.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"});return c.promise},this.removeContactFromBubble=function(t,i){var a=e.defer();if(i=i&&i.dbId?r.getRoomById(i.dbId):null,t)if(i){var o="";switch(i.users.forEach(function(e){e.contact.id===t.id&&(o=e.status)}),o){case r.RoomUserStatus.INVITED:r.ownerDeletesUserFromRoom(i,t).then(function(e){e.updateAvatarInfo(),a.resolve(e)}).catch(function(e){n.sdk(p+"[invite     ] :: Error when removing a contact"),a.reject(e)});break;case r.RoomUserStatus.ACCEPTED:r.unsubscribeUserFromRoom(i,t).then(function(e){e.updateAvatarInfo(),a.resolve(e)}).catch(function(e){n.sdk(p+"[invite     ] :: Error when removing a contact"),a.reject(e)});break;default:a.resolve(i)}}else a.reject({code:h.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or is null"});else a.reject({code:h.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"});return a.promise},this.promoteContactToModerator=function(t,i){var a=e.defer();return i=i&&i.dbId?r.getRoomById(i.dbId):null,t?i?r.updateRoomUser(i,t,null,"moderator").then(function(e){e.updateAvatarInfo(),a.resolve(e)}).catch(function(e){n.sdk(p+"[promote    ] :: Error when promoving a contact"),a.reject(e)}):a.reject({code:h.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or is null"}):a.reject({code:h.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}),a.promise},this.demoteContactFromModerator=function(t,i){var a=e.defer();return i=i&&i.dbId?r.getRoomById(i.dbId):null,t?i?r.updateRoomUser(i,t,null,"user").then(function(e){e.updateAvatarInfo(),a.resolve(e)}).catch(function(e){n.sdk(p+"[demote     ] :: Error when demoting a contact"),a.reject(e)}):a.reject({code:h.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or is null"}):a.reject({code:h.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}),a.promise},this.changeOwner=function(t,i){var a=e.defer();return i=i&&i.dbId?r.getRoomById(i.dbId):null,t?i?r.changeRoomOwner(i,t).then(function(e){e.updateAvatarInfo(),a.resolve(e)}).catch(function(e){n.sdk(p+"[changeOwner] :: Error when changing bubble owner"),a.reject(e)}):a.reject({code:h.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or is null"}):a.reject({code:h.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}),a.promise},this.acceptInvitationToJoinBubble=function(t){var i=e.defer();return(t=t&&t.dbId?r.getRoomById(t.dbId):null)?r.acceptRoomInvitation(t).then(function(){i.resolve(t)}).catch(function(e){n.sdk(p+"[invite     ] :: Error when joining a bubble"),i.reject(e)}):i.reject({code:h.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),i.promise},this.declineInvitationToJoinBubble=function(t){var i=e.defer();return(t=t&&t.dbId?r.getRoomById(t.dbId):null)?r.declineRoomInvitation(t).then(function(e){i.resolve(e)}).catch(function(e){n.sdk(p+"[invite     ] :: Error when joining a bubble"),i.reject(e)}):i.reject({code:h.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),i.promise},this.leaveBubble=function(t){var i=e.defer();if(t=t&&t.dbId?r.getRoomById(t.dbId):null){var a=!1;if(t.users.forEach(function(e){s.isUserContact(e)||"moderator"!==e.privilege||"accepted"!==e.status||(a=!0)}),a)switch(t.status){case r.RoomUserStatus.UNSUBSCRIBED:r.participantCloseRoom(t).then(function(e){i.resolve(e)}).catch(function(e){n.sdk(p+"[invite     ] :: Error when leaving a bubble"),i.reject(e)});break;default:r.unsubscribeMeFromRoom(t).then(function(e){i.resolve(e)}).catch(function(e){n.sdk(p+"[invite     ] :: Error when leaving a bubble"),i.reject(e)})}else i.reject({code:h.ERRORBADREQUEST,label:"Can't leave the bubble. No other moderator"})}else i.reject({code:h.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"});return i.promise},this.closeBubble=function(t){var i=e.defer();return(t=t&&t.dbId?r.getRoomById(t.dbId):null)?this.isBubbleArchived(t)?i.resolve(t):r.ownerArchiveRoom(t).then(function(e){i.resolve(e)}).catch(function(e){n.sdk(p+"[invite     ] :: Error when closing a bubble"),i.reject(e)}):i.reject({code:h.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),i.promise},this.isBubbleArchived=function(e){var t=!0;return(e=e&&e.dbId?r.getRoomById(e.dbId):null)&&e.status===r.RoomUserStatus.UNSUBSCRIBED?e.users.forEach(function(e){e.status!==r.RoomUserStatus.UNSUBSCRIBED&&e.status!==r.RoomUserStatus.DELETED&&(t=!1)}):t=!1,t},this.getAllBubbles=function(){return r.getRooms()},this.getAllOwnedBubbles=function(){return r.getMyRooms()},this.getAllPendingBubbles=function(){return r.getRooms().filter(function(e){return"invited"===e.status})},this.getAllInactiveBubbles=function(){return r.getRooms().filter(function(e){return 0==e.isActive})},this.getBubbleById=function(e){return e?r.getRoomById(e):{code:h.ERRORBADREQUEST,label:"Parameter 'strBubbleId' is missing or empty"}},this.updateDescriptionForBubble=function(t,n){var i=e.defer();return n=n&&n.dbId?r.getRoomById(n.dbId):null,t?n?(n.desc=t,r.ownerUpdateRoom(n).then(function(e){i.resolve(e)}).catch(function(e){i.reject(e)})):i.reject({code:h.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}):i.reject({code:h.ERRORBADREQUEST,label:"Parameter 'strDescription' is missing or empty"}),i.promise},this.updateAvatarForBubble=function(t,n){var i=e.defer();return n=n&&n.dbId?r.getRoomById(n.dbId):null,t?n?(n.id=n.dbId,r.setAvatarRoom(n,t).then(function(e){i.resolve(e)}).catch(function(e){i.reject(e)})):i.reject({code:h.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}):i.reject({code:h.ERRORBADREQUEST,label:"Parameter 'urlAvatar' is missing or empty"}),i.promise},this.deleteAvatarFromBubble=function(t){var n=e.defer();return(t=t&&t.dbId?r.getRoomById(t.dbId):null)?r.deleteAvatarRoom(t.dbId).then(function(e){n.resolve(e)}).catch(function(e){n.reject(e)}):n.reject({code:h.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}),n.promise},this.updateCustomDataForBubble=function(t,n){var i=e.defer();return n=n&&n.dbId?r.getRoomById(n.dbId):null,t?n?(n.customData=t,r.ownerUpdateRoomCustomData(n).then(function(e){n.customData=e,i.resolve(n)}).catch(function(e){i.reject(e)})):i.reject({code:h.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}):i.reject({code:h.ERRORBADREQUEST,label:"Parameter 'customData' is missing or empty"}),i.promise},this.deleteCustomDataForBubble=function(t){var n=e.defer();return(t=t&&t.dbId?r.getRoomById(t.dbId):null)?(t.customData={},r.ownerUpdateRoomCustomData(t).then(function(e){t.customData=e,n.resolve(t)}).catch(function(e){n.reject(e)})):n.reject({code:h.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}),n.promise},this.isWebRtcConferenceAllowed=function(){return l.isFeatureEnabled(l.FeaturesEnum.WEBRTC_CONFERENCE_ALLOWED)},this.hasActiveConferenceSession=function(){return!!d.hasActiveConferenceSession()},this.getWebRtcConferenceBubble=function(){return d.getRelatedRoomToActiveConferenceSession()},this.startOrJoinWebRtcConference=function(t){var n=e.defer();return(t=t&&t.dbId?r.getRoomById(t.dbId):null)?this.hasActiveConferenceSession()?n.reject({code:h.ERROR,label:"Already in a conference"}):d.startOrJoinWebConference(t).then(function(){m=t,v="webrtc",n.resolve(r.getRoomById(t.dbId))}).catch(function(e){n.reject(e)}):n.reject({code:h.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}),n.promise},this.addMediaToConferenceSession=function(e){return e?d.addMediaToConferenceSession(e,"video"):{code:h.ERROR,label:"Parameter 'conferenceSession' is missing or empty"}},this.removeMediaFromConferenceSession=function(e){return e?(d.removeMediaFromConferenceSession(e,"video"),e):{code:h.ERROR,label:"Parameter 'conferenceSession' is missing or empty"}},this.addLocalVideoStreamToConference=function(e){return e?(d.attachLocalMediaStream(!0,e),e):{code:h.ERROR,label:"Parameter 'conferenceSession' is missing or empty"}},this.getConferenceSessionById=function(e){return e?d.getConferenceSessionById(e):{code:h.ERROR,label:"Parameter 'conferenceId' is missing or empty"}},this.addDistantVideoStreamToConference=function(e){return e?(d.attachDistantMediaStream(!0,e),e):{code:h.ERROR,label:"Parameter 'conferenceSession' is missing or empty"}},this.updateMainVideoSession=function(e,t){if(e){if(t)return d.updateMainScreenSession(e,t),d.getConferenceSessionById(e);defered.reject({code:h.ERRORBADREQUEST,label:"Parameter 'sessionId' is missing or empty"})}else defered.reject({code:h.ERRORBADREQUEST,label:"Parameter 'conferenceId' is missing or empty"})},this.startOrJoinSharingWebRtcConference=function(t){var n=e.defer();return(t=t&&t.dbId?r.getRoomById(t.dbId):null)?this.hasActiveConferenceSession()?n.reject({code:h.ERROR,label:"Already in a conference"}):d.startOrJoinSharingOnlyConference(t).then(function(){n.resolve(r.getRoomById(t.dbId)),m=t,v="sharing"}).catch(function(e){n.reject(e)}):n.reject({code:h.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}),n.promise},this.stopWebRtcConference=function(){var t=e.defer();if(m=m&&m.dbId?r.getRoomById(m.dbId):null,this.hasActiveConferenceSession()&&m){var n;n="webrtc"===v?m.getSFUConfEndpointId():m.getSFUSharingConfEndpointId();var i=d.getConferenceSessionById(n),a=i?i.getParticipantByJid(s.userContact.jid):null;"moderator"===a.role?c.stopConference(n,v,m.dbId).then(function(){m=null,v=null,t.resolve()}).catch(function(e){t.reject(e)}):c.disconnectsParticipant(n,a.participantId,v).then(function(){m=null,v=null,t.resolve()}).catch(function(e){t.reject(e)})}else t.reject({code:h.ERRORBADREQUEST,label:"No known conference in a Bubble"});return t.promise},t.$on("$destroy",t.$on("ON_CONFERENCE_UPDATED_EVENT",function(e,n){sdk.useAngularEvents?t.$broadcast(f.RAINBOW_ONWEBCONFERENCEUPDATED,n):$(document).trigger(f.RAINBOW_ONWEBCONFERENCEUPDATED,[n])})),t.$on("$destroy",t.$on("ON_WEBRTC_GETUSERMEDIA_ERROR",function(e,n){sdk.useAngularEvents?t.$broadcast(f.RAINBOW_ONWEBRTCMEDIAERROROCCURED,n):$(document).trigger(f.RAINBOW_ONWEBRTCMEDIAERROROCCURED,[n])})),t.$on("$destroy",t.$on("ON_CONFERENCE_TALKER_EVENT",function(e,n){sdk.useAngularEvents?t.$broadcast(f.RAINBOW_ONWEBCONFERENCEUPDATED,n):$(document).trigger(f.RAINBOW_ONWEBCONFERENCEUPDATED,[n])})),t.$on("$destroy",t.$on("ON_CONFERENCE_PARTICIPANT_EVENT",function(e,n){sdk.useAngularEvents?t.$broadcast(f.RAINBOW_ONWEBCONFERENCEUPDATED,n):$(document).trigger(f.RAINBOW_ONWEBCONFERENCEUPDATED,[n])})),t.$on("$destroy",t.$on(r.ROOM_UPDATE_EVENT,function(e,n){!1===n.isActive?sdk.useAngularEvents?t.$broadcast(f.RAINBOW_ONBUBBLEDEACTIVATED,n):$(document).trigger(f.RAINBOW_ONBUBBLEDEACTIVATED,[n]):sdk.useAngularEvents?t.$broadcast(f.RAINBOW_ONBUBBLEUPDATED,n):$(document).trigger(f.RAINBOW_ONBUBBLEUPDATED,[n])})),t.$on("$destroy",t.$on(r.ROOM_AVATAR_UPDATE_EVENT,function(e,n){sdk.useAngularEvents?t.$broadcast(f.RAINBOW_ONBUBBLEAVATARUPDATED,n):$(document).trigger(f.RAINBOW_ONBUBBLEAVATARUPDATED,[n])})),t.$on("$destroy",t.$on(r.ROOM_INVITATION,function(e,n){sdk.useAngularEvents?t.$broadcast(f.RAINBOW_ONBUBBLEINVITATIONTOJOINRECEIVED,n):$(document).trigger(f.RAINBOW_ONBUBBLEINVITATIONTOJOINRECEIVED,[n])})),t.$on("$destroy",t.$on("ON_CONFERENCE_STARTED_INVITATION",function(e,n){var r=n.confEndpoints;r&&r.forEach(function(e){"webrtc"===e.mediaType&&(sdk.useAngularEvents?t.$broadcast(f.RAINBOW_ONBUBBLECONFERENCESTARTEDINVITATIONRECEIVED,n):$(document).trigger(f.RAINBOW_ONBUBBLECONFERENCESTARTEDINVITATIONRECEIVED,[n])),"webrtcSharingOnly"===e.mediaType&&(sdk.useAngularEvents?t.$broadcast(f.RAINBOW_ONBUBBLESHARINGCONFERENCESTARTEDINVITATIONRECEIVED,n):$(document).trigger(f.RAINBOW_ONBUBBLESHARINGCONFERENCESTARTEDINVITATIONRECEIVED,[n]))})}))}])},function(){angular.module("sdk").service("groupsService",["$q","$rootScope","$log","groupService","Group","contactService","PromiseQueue","SDK",function(e,t,n,r,i,a,o,s){"use strict";var c=this,l="GroupSrv  | ";this.RAINBOW_ONGROUPCREATED="rainbowgroupcreated",this.RAINBOW_ONGROUPUPDATED="rainbowgroupupdated",this.RAINBOW_ONGROUPDELETED="rainbowgroupdeleted",this.RAINBOW_ONGROUPUSERADDED="rainbowgroupuseradded",this.RAINBOW_ONGROUPUSERREMOVED="rainbowgroupuserdeleted",this.createGroup=function(t,a,o){var c=e.defer(),d=null,u=!1;return"boolean"==typeof o&&(u=o),t?(d=new i(null,t,a||"",u),r.addGroup(d).then(function(e){n.sdk(l+"[create     ] :: New group "+t+" created successfully"),c.resolve(e)}).catch(function(e){n.sdk(l+"[create     ] :: Error when creating a group"),c.reject(e)})):c.reject({code:s.ERRORBADREQUEST,label:"Parameter 'strName' is missing or empty"}),c.promise},this.deleteGroup=function(t){var i=e.defer();return t?r.removeGroup(t.id).then(function(){n.sdk(l+"[delete     ] :: Group deleted successfully"),i.resolve({code:s.OK,label:"OK"})}).catch(function(e){n.sdk(l+"[delete     ] :: Error when deleting a group"),i.reject(e)}):i.reject({code:s.ERRORBADREQUEST,label:"Parameter 'group' is missing or empty"}),i.promise},this.deleteAllGroups=function(){var t=e.defer(),i=[],a=r.getGroupsAsArray();return a.forEach(function(e){i.push(function(e){return r.removeGroup(e.id)}(e))}),Promise.all(i).then(function(){n.sdk(l+"[deleteAll  ] :: All groups deleted successfully"),t.resolve({code:s.OK,label:"OK"})}).catch(function(e){n.sdk(l+"[deleteAll  ] :: Error when deleting all groups"),t.reject(e)}),t.promise},this.getAll=function(){return r.getGroupsAsArray()},this.getFavoritesGroups=function(){return r.getGroupsAsArray().filter(function(e){return e.isFavorite})},this.setGroupAsFavorite=function(t){var n=e.defer();return t.isFavorite=!0,r.updateGroup(t).then(function(){n.resolve(t)}).catch(function(e){n.reject(e)}),n.promise},this.unsetGroupAsFavorite=function(t){var n=e.defer();return t.isFavorite=!1,r.updateGroup(t).then(function(){n.resolve(t)}).catch(function(e){n.reject(e)}),n.promise},this.getGroupById=function(e){var t=null;return r.getGroupsAsArray().some(function(n){return e===n.id&&(t=n,!0)}),t},this.getDetailedGroupById=function(t){var n=e.defer();return t?r.getGroup(t).then(function(e){n.resolve(e)}).catch(function(e){n.reject(e)}):n.reject({code:s.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),n.promise},this.addContactInGroup=function(t,i){var a=e.defer();return t?i?r.addGroupUser(i,t).then(function(e){n.sdk(l+"[addContactInGroup] :: contact added successfully"),a.resolve(e)}).catch(function(e){n.sdk(l+"[addContactInGroup] :: Error when adding a contact in a group"),a.reject(e)}):a.reject({code:s.ERRORBADREQUEST,label:"Parameter 'group' is missing or null"}):a.reject({code:s.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}),a.promise},this.removeContactFromGroup=function(t,n){var i=e.defer();if(t){if(n)return r.removeGroupUser(n.id,t);i.reject({code:s.ERRORBADREQUEST,label:"Parameter 'group' is missing or null"})}else i.reject({code:s.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"});return i.promise},t.$on("$destroy",t.$on(r.ON_UPDATE_GROUP_EVENT,function(e,n){r.getGroup(n).then(function(e){sdk.useAngularEvents?t.$broadcast(c.RAINBOW_ONGROUPUPDATED,e):$(document).trigger(c.RAINBOW_ONGROUPUPDATED,[e])}).catch(function(){})})),t.$on("$destroy",t.$on(r.ON_CREATED_GROUP_EVENT,function(e,n){r.getGroup(n).then(function(e){sdk.useAngularEvents?t.$broadcast(c.RAINBOW_ONGROUPCREATED,e):$(document).trigger(c.RAINBOW_ONGROUPCREATED,[e])}).catch(function(){})})),t.$on("$destroy",t.$on(r.ON_REMOVED_GROUP_EVENT,function(e,n){sdk.useAngularEvents?t.$broadcast(c.RAINBOW_ONGROUPDELETED,n):$(document).trigger(c.RAINBOW_ONGROUPDELETED,[n])})),t.$on("$destroy",t.$on(r.ON_ADD_GROUP_USER_EVENT,function(e,n,i){r.getGroup(n).then(function(e){sdk.useAngularEvents?t.$broadcast(c.RAINBOW_ONGROUPUSERADDED,e,i):$(document).trigger(c.RAINBOW_ONGROUPUSERADDED,[e,i])}).catch(function(){})})),t.$on("$destroy",t.$on(r.ON_REMOVE_GROUP_USER_EVENT,function(e,n,i){r.getGroup(n).then(function(e){sdk.useAngularEvents?t.$broadcast(c.RAINBOW_ONGROUPUSERREMOVED,e,i):$(document).trigger(c.RAINBOW_ONGROUPUSERREMOVED,[e,i])}).catch(function(){})}))}])},function(){angular.module("sdk").service("callsLogService",["$q","$rootScope","$log","callLogService",function(e,t,n,r){"use strict";var i=this,a=!1;this.RAINBOW_ONCALLLOGUPDATED="rainbowcalllogupdated",this.RAINBOW_ONCALLLOGACKUPDATED="rainbowcalllogackupdated",this.getAll=function(){r.orderCallLogsFunction();for(var e=r.getSimplifiedCallLogs(),t=0;t<e.length;t++){var n=0,i=e[t].duration;if(i&&"string"==typeof i&&i.match(/^(?:(?:([01]?\d|2[0-3])h )?([0-5]?\d)m )?([0-5]?\ds)$/)){for(var a=(i=i.replace(/[hms]/g,"")).split(" ").reverse(),o=0;o<a.length;o++)n+=a[o]*Math.pow(60,o);e[t].duration=1e3*n}}return e},this.getMissedCallLogCounter=function(){return r.getMissedCallLogCounter()},this.deleteOneCallLog=function(e){return r.deleteOneCallLog(e)},this.deleteCallLogsForContact=function(e){return r.deleteCallLogsForContact(e)},this.deleteAllCallLogs=function(){return r.deleteAllCallLogs()},this.markCallLogAsRead=function(e){return r.markCallLogAsRead(e)},this.markAllCallsLogsAsRead=function(){return r.markAllCallsLogsAsRead()},this.isInitialized=function(){return a},t.$on("$destroy",t.$on("ON_CALL_LOG_UPDATED",function(e,n){a=!0,sdk.useAngularEvents?t.$broadcast(i.RAINBOW_ONCALLLOGUPDATED,n):$(document).trigger(i.RAINBOW_ONCALLLOGUPDATED,[n])})),t.$on("$destroy",t.$on("ON_CALL_LOG_ACK_UPDATED",function(e,n){a=!0,sdk.useAngularEvents?t.$broadcast(i.RAINBOW_ONCALLLOGACKUPDATED,n):$(document).trigger(i.RAINBOW_ONCALLLOGACKUPDATED,[n])}))}])},function(){angular.module("sdk").service("cpaasService",["$q","$log","$rootScope","$http","SDK",function(e,t,n,r){"use strict";var i=this,a="CPaaSSrv   | ",o="",s="",c="",l="https",d="443",u="openrainbow.com";this.isAuthenticated=!1,this.hasSession=!1,this.RAINBOW_ONCPAAS_SESSION_CREATED="rainbowoncpaassessioncreated",this.authenticate=function(n,c,h){var f=e.defer();if(t.sdk(a+"[authent    ] :: Try to authenticate application "+n),0<n.length){var p=btoa(n+":"+c);h&&(u=h),r({method:"GET",url:l+"://"+u+":"+d+"/api/rainbow/applications/v1.0/authentication/login",headers:{Accept:"application/json",Authorization:"Basic "+p}}).success(function(e){t.sdk(a+"[authent    ] :: Authentication is successfull for application "+e.loggedInApplication.id),o=e.token,s=e.loggedInApplication.id,i.isAuthenticated=!0,f.resolve(e.data)}).error(function(e){t.sdk(a+"[authent    ] :: Authentication fails: "+e.errorDetails),f.resolve()})}else f.resolve();return f.promise},this.createSession=function(n,o){var f=e.defer();return t.sdk(a+"[session    ] :: Try to create a new session for userID"+n+" on app "+s),this.isAuthenticated?r({method:"POST",url:l+"://"+u+":"+d+"/api/v1.0/sdk/applications/"+s+"/sessions",headers:h(),data:{event:"session_start",data:{localUserURI:n,localUserSessionURI:o}}}).success(function(e){t.sdk(a+"[session    ] :: Session successfully created "+e.data.session.id),c=e.data.session.id,i.hasSession=!0,f.resolve(e.data)}).error(function(e){f.reject(e)}):t.sdk(a+"[session    ] :: Warning, the application is not authenticated. No way to track sessions..."),f.promise},this.appToken=function(){return o},this.updateSession=function(n){var i=e.defer();return t.sdk(a+"[session    ] :: Try to update information on the session "+c),this.isAuthenticated&&this.hasSession?r({method:"PUT",url:l+"://"+u+":"+d+"/api/v1.0/sdk/applications/"+s+"/sessions/"+c+"/info",headers:h(),data:{event:"session_info",data:n}}).success(function(e){t.sdk(a+"[session    ] :: Information successfully updated for session "+c),i.resolve(e.data)}).error(function(e){i.reject(e)}):t.sdk(a+"[session    ] :: Warning, the application is not authenticated. No way to track sessions..."),i.promise};var h=function(){return{"x-access-sdk-token":o,Accept:"application/json"}};n.$on("$destroy",function(){})}])},function(){angular.module("sdk").service("filesStorageService",["$q","$rootScope","$log","Conversation","fileStorageService","fileServerService","conversationService","contactService","SDK",function(e,t,n,r,i,a,o,s,c){"use strict";var l=this,d="StorageSrv   | ";this.RAINBOW_ONFILEUPLOADED="rainbowfileuploaded",this.RAINBOW_ONFILEUPLOADED_ERROR="rainbowfileuploadederror",this.RAINBOW_ONFILEDOWNLOADED="rainbowonfiledownloaded",this.RAINBOW_ONFILEDOWNLOADED_ERROR="rainbowfiledownloadederror",this.RAINBOW_ONCHUNKLOADMESSAGE="rainbowonchunkloadmessage";var u={success:{download:l.RAINBOW_ONFILEDOWNLOADED,upload:l.RAINBOW_ONFILEUPLOADED},error:{download:l.RAINBOW_ONFILEDOWNLOADED_ERROR,upload:l.RAINBOW_ONFILEUPLOADED_ERROR}};this._addFileToConversation=function(t,n,r){return e(function(i,a){return e(function(e){if("string"==typeof n){var t=new XMLHttpRequest;t.open("GET",n,!0),t.onreadystatechange=function(){if(t.readyState===XMLHttpRequest.DONE){var r=t.response,i=new File([r],n.replace(/^.*[\\\/]/,""));e(i)}},t.responseType="blob",t.send()}else e(n)}).then(function(e){1e8<e.size?a({code:c.ERRORBADREQUEST,label:"The file is too large (limited to 100MB)"}):o.sendFSMessage(t,e,r).then(function(e){i(e)})})})},this.uploadFileToConversation=function(e,t,i){return new Promise(function(a,o){e?t?e.type===r.Type.ONE_TO_ONE?(n.sdk(d+"[addFileCnv ] ::  Add file to the conversation "+e.id),l._addFileToConversation(e,t,i).then(function(e){n.sdk(d+"[addFileCnv ] ::  file added"),a(e)}).catch(function(e){o(e)})):o({code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is not a one-to-one conversation"}):o({code:c.ERRORBADREQUEST,label:"Parameter 'file' is missing or null"}):o({code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"})})},this.uploadFileToBubble=function(e,t,i){return new Promise(function(a,s){if(e)if(t){var u=o.getConversationByRoomDbId(e.dbId);u?u.type===r.Type.ROOM?(n.sdk(d+"[addFileBub ] ::  Try to add a file "+t+" to the bubble "+e.dbId),l._addFileToConversation(u,t,i).then(function(e){n.sdk(d+"[addFileBub ] ::  file added"),a(e)}).catch(function(e){s(e)})):s({code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is not a bubble conversation"}):s({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' don't have a conversation"})}else s({code:c.ERRORBADREQUEST,label:"Parameter 'file' is missing or null"});else s({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"})})},this.downloadFile=function(e){return new Promise(function(t,r){e?(n.sdk(d+"[getFile    ] ::  Try to get a file "+e.fileName),e.url||(config.restServerUrl,e.id),e.mime||e.typeMIME,e.filesize||e.size,e.filename||e.fileName,a.getBlobFromFileDescriptor(e,!0).then(function(e){n.sdk(d+"[getFile    ] ::  file downloaded"),t(e)}).catch(function(e){r(e)})):r({code:c.ERRORBADREQUEST,label:"Parameter 'fileDescriptor' is missing or null"})})},this.removeFile=function(e){return new Promise(function(t,r){if(e||r({code:c.ERRORBADREQUEST,label:"Parameter 'fileDescriptor' is missing or null"}),e.id||e.url){n.sdk(d+"[removeFile ] ::  Try to remove a file "+e.filename);var a=e.id;if(!a){var o=e.url.split("/");a=o.pop()||o.pop()}i.deleteFileDescriptor(a).then(function(){n.sdk(d+"[getFile    ] ::  file removed"),t({code:c.OK,label:"OK"})}).catch(function(e){r(e)})}else r({code:c.ERRORBADREQUEST,label:"Parameter 'fileDescriptor' don't contain information to remove the file"})})},this.getFileDescriptorFromId=function(e){return n.sdk(d+"[getFileDescriptorFromId] ::  get file descriptor "+e),i.getFileDescriptorById(e)},this.getFilesReceivedInConversation=function(e){return new Promise(function(t,a){e?e.type===r.Type.ONE_TO_ONE?(n.sdk(d+"[getFilesRcv] ::  get files received in conversation "+e.id+"..."),i.retrieveFilesReceivedFromPeer(s.userContact.dbId,e.contact.dbId).then(function(e){n.sdk(d+"[getFilesRcv] ::  shared "+e.length),t(e)}).catch(function(e){a(e)})):a({code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is not a one-to-one conversation"}):a({code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"})})},this.getFilesReceivedInBubble=function(e){return new Promise(function(t,r){e?(n.sdk(d+"[getFilesRcv] ::  get files received in bubble "+e.dbId+"..."),i.retrieveReceivedFilesForRoom(e.dbId).then(function(e){n.sdk(d+"[getFilesRcv] ::  shared "+e.length),t(e)}).catch(function(e){r(e)})):r({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"})})},this.getFilesSentInConversation=function(e){return new Promise(function(t,a){e?e.type===r.Type.ONE_TO_ONE?(n.sdk(d+"[getFilesSnd] ::  get files sent in conversation "+e.id+"..."),i.retrieveSentFiles(e.contact.dbId).then(function(e){n.sdk(d+"[getFilesSnd] ::  shared "+e.length),t(e)}).catch(function(e){a(e)})):a({code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is not a one-to-one conversation"}):a({code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"})})},this.getFilesSentInBubble=function(e){return new Promise(function(t,r){e?(n.sdk(d+"[getFilesRcv] ::  get files received in bubble "+e.dbId+"..."),i.retrieveSentFiles(e.dbId).then(function(e){n.sdk(d+"[getFilesSnd] ::  shared "+e.length),t(e)}).catch(function(e){r(e)})):r({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"})})},this.getUserQuotaConsumption=function(){return new Promise(function(e){i.retrieveUserConsumption().then(function(t){e(t)})})},this.getAllFilesSent=function(){return i.getDocuments()},this.getAllFilesReceived=function(){return i.getReceivedDocuments()},this.cancelCurrentFileTransfer=function(e){return new Promise(function(t,n){if(e){var r=i.getFileDescriptorById(e);null==r?n({code:c.ERRORBADREQUEST,label:"Could not find a file with the id "+e}):"downloading"!==r.state&&"uploading"!==r.state?n({code:c.ERRORBADREQUEST,label:"File Status is not set to 'downloading' or 'uploading'"}):(a.cancelCurrentFiletransfer(e),"not_uploaded"!==r.state&&"uploading"!==r.state?(r.state="uploaded",t(r)):"not_uploaded"!==r.state&&"uploading"===r.state&&(r.state="not_uploaded",t(r)))}else n({code:c.ERRORBADREQUEST,label:"Parameter 'id' is missing or null"})})},t.$on("$destroy",t.$on("ON_FILE_TRANSFER_EVENT",function(e,r){r.result&&r.type?(n.sdk(d+"[OnFileTrans] ::  file transfered..."),sdk.useAngularEvents?t.$broadcast(u[r.result][r.type],r):$(document).trigger(u[r.result][r.type],[r])):("uploading"===(r=r.fileDesc).state||"downloading"===r.state)&&(sdk.useAngularEvents?t.$broadcast(l.RAINBOW_ONCHUNKLOADMESSAGE,r):$(document).trigger(l.RAINBOW_ONCHUNKLOADMESSAGE,[r]))}))}])},function(){angular.module("sdk").service("capabilitiesService",["profileService",function(e){"use strict";this.getAll=function(){return e.getMyProfileFeatures()},this.hasS4BExtensionEnabled=function(){return e.isFeatureEnabled("MS_SKYPE_PLUGIN")},this.hasOutlookExtensionEnabled=function(){return e.isFeatureEnabled("MS_OUTLOOK_PLUGIN")},this.hasCalendarPresenceEnabled=function(){return e.isFeatureEnabled("MSO365_CALENDAR_PRESENCE")},this.hasTelephonyBasicCallEnabled=function(){return e.isFeatureEnabled("TELEPHONY_BASIC_CALL")},this.hasTelephonySecondCallEnabled=function(){return e.isFeatureEnabled("TELEPHONY_SECOND_CALL")},this.hasTelephonyTransferCallEnabled=function(){return e.isFeatureEnabled("TELEPHONY_TRANSFER_CALL")},this.hasTelephonyConferenceCallEnabled=function(){return e.isFeatureEnabled("TELEPHONY_CONFERENCE_CALL")},this.hasTelephonyDeflectCallEnabled=function(){return e.isFeatureEnabled("TELEPHONY_DEFLECT_CALL")},this.hasTelephonyForwardCallEnabled=function(){return e.isFeatureEnabled("TELEPHONY_FORWARD_CALL")},this.hasTelephonyPhoneBookEnabled=function(){return e.isFeatureEnabled("TELEPHONY_PHONE_BOOK")},this.hasTelephonyVoiceMailEnabled=function(){return e.isFeatureEnabled("TELEPHONY_VOICE_MAIL")},this.hasWebRTCAudioMobileEnabled=function(){return e.isFeatureEnabled("WEBRTC_FOR_MOBILE")},this.hasWebRTCVideoMobileEnabled=function(){return e.isFeatureEnabled("WEBRTC_FOR_MOBILE_VIDEO")},this.hasBridgeConferenceEnabled=function(){return e.isFeatureEnabled("CONFERENCE_ALLOWED")},this.hasBridgeConferenceRecordEnabled=function(){return e.isFeatureEnabled("CONFERENCE_RECORDING")},this.hasBridgeConferenceDialOutEnabled=function(){return e.isFeatureEnabled("CONFERENCE_DIAL_OUT")},this.maxParticipantsPerBubbleAllowed=function(){return e.getFeatureLimitMax("BUBBLE_PARTICIPANT_COUNT")},this.maxParticipantsPerBridgeConferenceAllowed=function(){return e.getFeatureLimitMax("CONFERENCE_PARTICIPANT_COUNT")},this.maxFileStorageQuotaAllowed=function(){return e.getFeatureLimitMax("FILE_SHARING_QUOTA_GB")}}])},function(){angular.module("sdk").service("adminService",["$q","$rootScope","$log","Company","User","adminCompanyService","adminUserService","SDK",function(e,t,n,r,i,a,o){"use strict";this.createEssentialCompany=function(t,n){return e(function(e,i){var o=r.create(null,"");o.name=t,o.country=n,a.createCompanyEndUser(o).then(function(t){e(t)}).catch(function(e){i(e)})})},this.createCompany=function(t,n,i){return e(function(e,o){var s=r.create(null,"");s.name=t,s.country=n,i&&(s.state=i),s.economicActivityClassification="",a.createCompany(s).then(function(t){e(t)}).catch(function(e){o(e)})})},this.removeCompany=function(t){return e(function(e,n){a.deleteCompany(t.id).then(function(){e(t)}).catch(function(e){n(e)})})},this.createUserForCompany=function(t,n,r,a,s){return e(function(e,c){var l=i.create();l.loginEmail=t,l.firstName=n,l.lastName=r,l.password=a,l.language="en",l.companyId=s.id,l.adminType="undefined",l.isActive=!0,l.isInitialized=!0,o.createUser(l).then(function(t){e(t)}).catch(function(e){c(e)})})},this.removeUserFromCompany=function(t){return e(function(e,n){o.deleteUser(t).then(function(){e(t)}).catch(function(e){n(e)})})},this.setVisibilityForCompany=function(t,n){return e(function(e,r){a.addVisibility(t.id,n.id).then(function(){e(t)}).catch(function(e){r(e)})})},this.promoteCompanyToBP=function(t,n,r){return e(function(e,i){t.isBP=!0,t.bpType=n,t.bpBusinessModel="resell",t.bpApplicantNumber=r,t.bpCRDid=r,t.supportEmail="rford@sandbox.westworld.com",a.updateCompany(t).then(function(t){e(t)}).catch(function(e){i(e)})})}}])},function(){angular.module("sdk").service("channelsService",["$log","$q","$rootScope","channelService","contactService","SDK",function(e,t,n,r,i,a){"use strict";var o=this,s="ChannelsSrv| ";this.RAINBOW_ONCHANNELMESSAGERECEIVED="rainbowchannelmessagereceived",this.RAINBOW_ONCHANNELUPDATED="rainbowchannelupdate",this.RAINBOW_ONCHANNELDELETED="rainbowchanneldeleted",this.RAINBOW_ONCHANNELUSERSUPDATED="rainbowchannelusersupdate",this.RAINBOW_ONCHANNELRETRACTMESSAGERECEIVED="rainbowchannelretractmessage",this.RAINBOW_ONCHANNELAVATARUPDATED="rainbowchannelavatarupdate",this.RAINBOW_ONCHANNELUSERSUBSCRIBED="rainbowchannelusersubscribed",this.RAINBOW_ONCHANNELUSERUNSUBSCRIBED="rainbowchanneluserunsubscribed",this.getMyChannels=function(){return r.getMyChannels()},this.createChannel=function(n,i,o,c,l){var d=t.defer();if(e.sdk(s+"[createCha  ] :: Try to create a new channel..."),n){var u="company"===o?"company_public":"company_closed";c=c||100,i=i||"",l=l||"",r.createChannel(n,u,i,l,!1).then(function(t){e.sdk(s+"[createCha  ] :: created: "+t.id),d.resolve(t)}).catch(function(e){d.reject(e)})}else d.reject({code:a.ERRORBADREQUEST,label:"Parameter 'channelName' is missing or empty"});return d.promise},this.createPublicChannel=function(n,i,o,c){var l=t.defer();return e.sdk(s+"[createCha  ] :: Try to create a new public channel..."),n?(o=o||100,i=i||"",c=c||"",r.createChannel(n,"company_public",i,c,!1).then(function(t){e.sdk(s+"[createCha  ] :: created: "+t.id),l.resolve(t)}).catch(function(e){l.reject(e)})):l.reject({code:a.ERRORBADREQUEST,label:"Parameter 'channelName' is missing or empty"}),l.promise},this.createPrivateChannel=function(n,i,o,c){var l=t.defer();return e.sdk(s+"[createCha  ] :: Try to create a new private channel..."),n?(o=o||100,i=i||"",c=c||"",r.createChannel(n,"company_closed",i,c,!1).then(function(t){e.sdk(s+"[createCha  ] :: created: "+t.id),l.resolve(t)}).catch(function(e){l.reject(e)})):l.reject({code:a.ERRORBADREQUEST,label:"Parameter 'channelName' is missing or empty"}),l.promise},this.deleteChannel=function(n){var i=t.defer();return e.sdk(s+"[deleteCha  ] :: Try to delete a channel..."),n?(r.deleteChannel(n).then(function(){e.sdk(s+"[deleteCha  ] :: deleted: "+n),i.resolve({code:a.OK,label:"OK"})}).catch(function(e){i.reject(e)}),i.promise):i.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"})},this.findChannels=function(n){var i=t.defer();return e.sdk(s+"[findCha    ] :: Try to find channels..."),n?r.findChannels(n).then(function(t){e.sdk(s+"[findCha    ] :: found: "+t.length),i.resolve(t)}).catch(function(e){i.reject(e)}):i.reject({code:a.ERRORBADREQUEST,label:"Parameter 'filter' is missing or empty"}),i.promise},this.getChannel=function(n){var i=t.defer();return e.sdk(s+"[getChannel ] :: Try to get a channel..."),n?r.getChannel(n).then(function(t){e.sdk(s+"[getChannel ] :: got: "+t.id),i.resolve(t)}).catch(function(e){i.reject(e)}):i.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),i.promise},this.publishToChannel=function(n,i,o,c,l){var d=t.defer();return e.sdk(s+"[publishTo  ] :: Try to publish a channel..."),n?i?l&&-1===["basic, markdown, html, data"].indexOf(l)?d.reject({code:a.ERRORBADREQUEST,label:"Parameter 'type' could be 'basic', 'markdown', 'html' or 'data'"}):(o=o||"",c=c||"",l=l?"urn:xmpp:channels:"+l:"urn:xmpp:channels:basic",r.publishToChannel(n.id,null,l,i,o,c).then(function(){e.sdk(s+"[publishTo  ] :: published: "+n.id),d.resolve({code:a.OK,label:"OK"})}).catch(function(e){d.reject(e)})):d.reject({code:a.ERRORBADREQUEST,label:"Parameter 'message' is missing or empty"}):d.reject({code:a.ERRORBADREQUEST,label:"Parameter 'channel' is missing or empty"}),d.promise},this.subscribeToChannelById=function(n){var i=t.defer();e.sdk(s+"[subscribeTo] :: Try to subscribe to a channel..."),n||i.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or null"});var o=r.getChannelFromCache(n);return o?r.subscribeToChannel(o).then(function(){e.sdk(s+"[subscribeTo] :: subscribed: "+n),i.resolve({code:a.OK,label:"OK"})}).catch(function(e){i.reject(e)}):r.getChannel(n).then(function(t){return t?void r.subscribeToChannel(t).then(function(){e.sdk(s+"[subscribeTo] :: subscribed: "+n),i.resolve({code:a.OK,label:"OK"})}).catch(function(e){i.reject(e)}):i.reject({code:a.ERRORBADREQUEST,label:"No channel found with id "+n})}),i.promise},this.subscribeToChannel=function(n){var i=t.defer();return e.sdk(s+"[subscribeTo] :: Try to subscribe to a channel..."),n?r.subscribeToChannel(n).then(function(){e.sdk(s+"[subscribeTo] :: subscribed: "+n.id),i.resolve({code:a.OK,label:"OK"})}).catch(function(e){i.reject(e)}):i.reject({code:a.ERRORBADREQUEST,label:"Parameter 'channel' is missing or null"}),i.promise},this.unsubscribeFromChannelById=function(n){var i=t.defer();e.sdk(s+"[unsubscribe] :: Try to unsubscribe from a channel..."),n||i.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});var o=r.getChannelFromCache(n);return o?r.unsubscribeToChannel(o).then(function(){e.sdk(s+"[unsubscribe] :: unsubscribed: "+n),i.resolve({code:a.OK,label:"OK"})}).catch(function(e){i.reject(e)}):r.getChannel(n).then(function(t){return t?void r.unsubscribeToChannel(t).then(function(){e.sdk(s+"[unsubscribe] :: unsubscribed: "+n),i.resolve({code:a.OK,label:"OK"})}).catch(function(e){i.reject(e)}):i.reject({code:a.ERRORBADREQUEST,label:"No channel found with id "+n})}),i.promise},this.unsubscribeFromChannel=function(n){var i=t.defer();return e.sdk(s+"[unsubscribe] :: Try to unsubscribe from a channel..."),n?r.unsubscribeToChannel(n).then(function(){e.sdk(s+"[unsubscribe] :: unsubscribed: "+n.id),i.resolve({code:a.OK,label:"OK"})}).catch(function(e){i.reject(e)}):i.reject({code:a.ERRORBADREQUEST,label:"Parameter 'channel' is missing or null"}),i.promise},this.updateChannel=function(n,i,o,c,l,d,u){var h=t.defer();if(e.sdk(s+"[updateCha  ] :: Try to update a channel..."),!n)return h.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});var f={};return null!=i&&(f.topic=i),null!=o&&(f.mode="company"===o?"company_public":"company_closed"),null!=c&&(f.max_items=c),null!=l&&(f.max_payload_size=l),null!=d&&(f.name=d),null!=u&&(f.cateogry=u),r.updateChannel(n,f).then(function(t){t.visibility=f.visibility,e.sdk(s+"[updateCha  ] :: updated: "+n),h.resolve(t)}).catch(function(e){h.reject(e)}),h.promise},this.updateChannelVisibility=function(n,i){var o=t.defer();if(e.sdk(s+"[updateCha  ] :: Try to update visibility of a channel..."),n)if(i){var c={};null!=i&&(c.mode="company"===i?"company_public":"company_closed"),r.updateChannel(n,c).then(function(t){e.sdk(s+"[updateCha  ] :: updated: "+n),o.resolve(t)}).catch(function(e){o.reject(e)})}else o.reject({code:a.ERRORBADREQUEST,label:"Parameter 'visibility' is missing or empty"});else o.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});return o.promise},this.setChannelVisibilityToPublic=function(n){var i=t.defer();return e.sdk(s+"[setChannel ] :: Try to update visibility to visible for a channel..."),n?r.updateChannel(n,{mode:"company_public"}).then(function(t){e.sdk(s+"[setChannel ] :: updated: "+n),i.resolve(t)}).catch(function(e){i.reject(e)}):i.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),i.promise},this.setChannelVisibilityToPrivate=function(n){var i=t.defer();return e.sdk(s+"[setChannel ] :: Try to update visibility to private for a channel..."),n?r.updateChannel(n,{mode:"company_closed"}).then(function(t){e.sdk(s+"[setChannel ] :: updated: "+n),i.resolve(t)}).catch(function(e){i.reject(e)}):i.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),i.promise},this.updateChannelName=function(n,i){var o=t.defer();if(e.sdk(s+"[updateCha  ] :: Try to update the name of a channel..."),n){var c={};null!=i&&(c.name=i),r.updateChannel(n,c).then(function(t){e.sdk(s+"[updateCha  ] :: updated: "+n),o.resolve(t)}).catch(function(e){o.reject(e)})}else o.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});return o.promise},this.updateChannelTopic=function(n,i){var o=t.defer();if(e.sdk(s+"[updateCha  ] :: Try to update the topic of a channel..."),n){var c={};null!=i&&(c.topic=i),r.updateChannel(n,c).then(function(t){e.sdk(s+"[updateCha  ] :: updated: "+n),o.resolve(t)}).catch(function(e){o.reject(e)})}else o.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});return o.promise},this.updateChannelCategory=function(n,i){var o=t.defer();if(e.sdk(s+"[updateCha  ] :: Try to update the name of a channel..."),n){var c={};null!=i&&(c.category=i),r.updateChannel(n,c).then(function(t){e.sdk(s+"[updateCha  ] :: updated: "+n),o.resolve(t)}).catch(function(e){o.reject(e)})}else o.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});return o.promise},this.uploadChannelAvatar=function(n,i){var o=t.defer();return e.sdk(s+"[uploadCha  ] :: Try to update the avatar of a channel..."),n?i?r.uploadChannelAvatar(n,i,512).then(function(){e.sdk(s+"[uploadCha  ] :: updated: "+n),o.resolve({code:a.OK,label:"OK"})}).catch(function(e){o.reject(e)}):o.reject({code:a.ERRORBADREQUEST,label:"Parameter 'urlAvatar' is missing or empty"}):o.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),o.promise},this.deleteChannelAvatar=function(n){var i=t.defer();return e.sdk(s+"[deleteCha  ] :: Try to delete the avatar of a channel..."),n?r.deleteChannelAvatar(n).then(function(){e.sdk(s+"[deleteCha  ] :: updated: "+n),i.resolve({code:a.OK,label:"OK"})}).catch(function(e){i.reject(e)}):i.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),i.promise},this.getChannelUsers=function(n,i){var o=t.defer();return e.sdk(s+"[getUsers   ] :: Try to get users of a channel..."),n?r.getChannelUsers(n,i).then(function(t){e.sdk(s+"[getUsers   ] :: got: "+n),o.resolve(t.data)}).catch(function(e){o.reject(e)}):o.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),o.promise},this.removeAllUsersFromChannel=function(n){var i=t.defer();return e.sdk(s+"[removeAllUs] :: Try to get remove all users of a channel..."),n?r.removeAllUsersFromChannel(n).then(function(){return r.getChannel(n)}).then(function(t){e.sdk(s+"[removeAllUs] :: removed: "+n),i.resolve(t)}).catch(function(e){i.reject(e)}):i.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),i.promise},this.updateChannelUsers=function(n,i,o){var c=t.defer();return e.sdk(s+"[updateCha  ] :: Try to get updated users of a channel..."),n?(o=o||"member",r.updateChannelUsers(n,i,o).then(function(t){e.sdk(s+"[updateCha  ] :: updated: "+n),c.resolve(t)}).catch(function(e){c.reject(e)})):c.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),c.promise},this.addMembersToChannel=function(n,i){var o=t.defer();return e.sdk(s+"[updateCha  ] :: Try to add members to a channel..."),n?r.updateChannelUsers(n,i,"member").then(function(t){e.sdk(s+"[updateCha  ] :: updated: "+n),o.resolve(t)}).catch(function(e){o.reject(e)}):o.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),o.promise},this.addPublishersToChannel=function(n,i){var o=t.defer();return e.sdk(s+"[updateCha  ] :: Try to add publishers to a channel..."),n?r.updateChannelUsers(n,i,"publisher").then(function(t){e.sdk(s+"[updateCha  ] :: updated: "+n),o.resolve(t)}).catch(function(e){o.reject(e)}):o.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),o.promise},this.addOwnersToChannel=function(n,i){var o=t.defer();return e.sdk(s+"[updateCha  ] :: Try to add owners to a channel..."),n?r.updateChannelUsers(n,i,"owner").then(function(t){e.sdk(s+"[updateCha  ] :: updated: "+n),o.resolve(t)}).catch(function(e){o.reject(e)}):o.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),o.promise},this.removeUsersFromChannel=function(n,i){var o=t.defer();return e.sdk(s+"[updateCha  ] :: Try to remove users from a channel..."),n?r.updateChannelUsers(n,i,"none").then(function(t){e.sdk(s+"[updateCha  ] :: updated: "+n),o.resolve(t)}).catch(function(e){o.reject(e)}):o.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),o.promise},this.getChannelItems=function(n,i,o,c){var l=t.defer();return e.sdk(s+"[getItems   ] :: Try to get messages of a channel..."),n?r.getChannelItems(n,i,o,c).then(function(t){e.sdk(s+"[getItems   ] :: got: "+n),l.resolve(t)}).catch(function(e){l.reject(e)}):l.reject({code:a.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),l.promise},n.$on("$destroy",n.$on("CHANNEL_MESSAGE_RECEIVED",function(t,r,i){e.sdk(s+"[Channel    ] :: got a message"),o.getChannel(i.channelId).then(function(t){0===r?sdk.useAngularEvents?n.$broadcast(o.RAINBOW_ONCHANNELMESSAGERECEIVED,t,i):$(document).trigger(o.RAINBOW_ONCHANNELMESSAGERECEIVED,[t,i]):(e.sdk(s+"[Channel    ] :: got a retracted message"),sdk.useAngularEvents?n.$broadcast(o.RAINBOW_ONCHANNELRETRACTMESSAGERECEIVED,t,i):$(document).trigger(o.RAINBOW_ONCHANNELRETRACTMESSAGERECEIVED,[t,i]))})})),n.$on("$destroy",n.$on("CHANNEL_UPDATE_EVENT",function(t,r,i){e.sdk(s+"[Channel    ] :: channel updated ("+r+") id:"+i),3===r?sdk.useAngularEvents?n.$broadcast(o.RAINBOW_ONCHANNELDELETED,i):$(document).trigger(o.RAINBOW_ONCHANNELDELETED,[i]):o.getChannel(i).then(function(e){sdk.useAngularEvents?n.$broadcast(o.RAINBOW_ONCHANNELUPDATED,e,r):$(document).trigger(o.RAINBOW_ONCHANNELUPDATED,[e,r])})})),n.$on("$destroy",n.$on("CHANNEL_USERS_UPDATE_EVENT",function(t,r,i){e.sdk(s+"[Channel    ] :: channel users updated, id:"+r),o.getChannel(r).then(function(e){sdk.useAngularEvents?n.$broadcast(o.RAINBOW_ONCHANNELUSERSUPDATED,e,i):$(document).trigger(o.RAINBOW_ONCHANNELUSERSUPDATED,[e,i])})})),n.$on("$destroy",n.$on("ON_UPDATE_CHANNEL_AVATAR",function(){o.getChannel(channelId).then(function(t){e.sdk(s+"[Channel    ] :: avatar updated for channel id:"+t.id),sdk.useAngularEvents?n.$broadcast(o.RAINBOW_ONCHANNELAVATARUPDATED,t):$(document).trigger(o.RAINBOW_ONCHANNELAVATARUPDATED,[t])})})),n.$on("$destroy",n.$on("CHANNEL_USER_SUBSCRIPTION_EVENT",function(t,r,a,c){var l=null;o.getChannel(a).then(function(e){return l=e,i.getContactByDBId(c,!0)}).then(function(t){t=t||c,4===r?(e.sdk(s+"[Channel    ] :: user subscribed to a channel: "+a),sdk.useAngularEvents?n.$broadcast(o.RAINBOW_ONCHANNELUSERSUBSCRIBED,l,t):$(document).trigger(o.RAINBOW_ONCHANNELUSERSUBSCRIBED,[l,t])):(e.sdk(s+"[Channel    ] :: user unsubscribed from a channel: "+a),sdk.useAngularEvents?n.$broadcast(o.RAINBOW_ONCHANNELUSERUNSUBSCRIBED,l,t):$(document).trigger(o.RAINBOW_ONCHANNELUSERUNSUBSCRIBED,[l,t]))})}))}])},function(){angular.module("sdk").service("rainbowSDK",["$log","$q","$rootScope","connectionService","presenceService","contactsService","conversationsService","imService","pbxService","webRTCService","bubblesService","groupsService","callsLogService","userProfileService","settingsService","cpaasService","filesStorageService","capabilitiesService","channelsService","adminService","SDK",function(e,t,n,r,i,a,o,s,c,l,d,u,h,f,p,m,v,g,C,S){"use strict";var E=this,b=null;this.isReady=!1,this.RAINBOW_ONREADY="ready",this.RAINBOW_ONLOADED="loaded",this.connection=r,this.presence=i,this.contacts=a,this.conversations=o,this.im=s,this.telephony=c,this.webRTC=l,this.bubbles=d,this.groups=u,this.callsLog=h,this.userProfile=f,this.fileStorage=v,this.caps=g,this.channels=C,this.admin=S,this.version=function(){return window.sdkversion},this.mode=function(){return p.getSetting("apiMode")},this.setVerboseLog=function(e){return sdk.hasVerboseLog=e,sdk.hasVerboseLog},this.useAngularEvents=function(e){return sdk.useAngularEvents=e,sdk.useAngularEvents},this.setKeyFromConfig=function(t,n){return e.sdk("SDKSrv     | [initialize ] :: Linked to application ID "+t+" from configuration file"),sdk.key.appID=t,sdk.key.appSecret=n,!0},this.hasBeenLaunchedFromConfig=function(t){var n=t?"YES":"NO";return e.sdk("SDKSrv     | [initialize ] :: SDK lauched from a configuration file "+n),sdk.hasBeenLaunchedFromConfig=t,sdk.hasBeenLaunchedFromConfig},this.initialize=function(n,r){var i=t.defer();return n&&0<n.length?(sdk.key.appID=n,e.sdk("SDKSrv     | [initialize ] :: Initialize the SDK for the application"+sdk.key.appID+"...")):e.sdk("SDKSrv     | [initialize ] :: Initialize the SDK without an application key..."),r&&0<r.length&&(sdk.key.appSecret=r),y().then(function(){e.sdk("SDKSrv     | [initialize ] :: Initialize step 1/2 ok"),R().then(function(){e.sdk("SDKSrv     | [initialize ] :: Initialize step 2/2 ok"),e.sdk("SDKSrv     | [initialize ] :: SDK Initialized successfully!"),i.resolve()})}),i.promise};var y=function(){var e=t.defer();if(E.isReady)e.resolve();else var r=n.$on("RAINBOW_INTERNAL_READY",function(){r(),e.resolve()});return e.promise},R=function(){var e=t.defer();return DetectRTC.load(function(){T(),e.resolve()}),e.promise};this.load=function(){e.sdk("SDKSrv     | [initialize ] :: Rainbow SDK loaded!"),sdk.useAngularEvents?n.$broadcast(E.RAINBOW_ONLOADED):$(document).trigger(E.RAINBOW_ONLOADED,null)},this.ready=function(){e.sdk("SDKSrv     | [initialize ] :: Rainbow SDK ready!"),sdk.useAngularEvents?n.$broadcast(E.RAINBOW_ONREADY):$(document).trigger(E.RAINBOW_ONREADY,null)};var T=function(){e.sdk("SDKSrv     | [initialize ] :: Initializing the Rainbow SDK..."),e.sdk("SDKSrv     | [initialize ] :: -----------------------------"),e.sdk("SDKSrv     | [initialize ] :: Platform    | "+DetectRTC.osName+" "+DetectRTC.osVersion),e.sdk("SDKSrv     | [initialize ] :: Screen      | "+window.screen.width+"x"+window.screen.height),e.sdk("SDKSrv     | [initialize ] :: Cookie      | "+navigator.cookieEnabled),e.sdk("SDKSrv     | [initialize ] :: Java        | "+navigator.javaEnabled()),e.sdk("SDKSrv     | [initialize ] :: Server      | "+config.webservices.server),e.sdk("SDKSrv     | [initialize ] :: Version WEB | "+window.version),e.sdk("SDKSrv     | [initialize ] :: Version SDK | "+window.sdkversion),e.sdk("SDKSrv     | [initialize ] :: Browser     | "+DetectRTC.browser.name+" "+DetectRTC.browser.fullVersion),e.sdk("SDKSrv     | [initialize ] :: Microphone  | "+DetectRTC.hasMicrophone),e.sdk("SDKSrv     | [initialize ] :: Camera      | "+DetectRTC.hasWebcam),e.sdk("SDKSrv     | [initialize ] :: Speakers    | "+DetectRTC.hasSpeakers),e.sdk("SDKSrv     | [initialize ] :: WebRTC      | "+DetectRTC.isWebRTCSupported),e.sdk("SDKSrv     | [initialize ] :: Mode        | "+E.mode()),e.sdk("SDKSrv     | [initialize ] :: verboseLog  | "+sdk.hasVerboseLog),e.sdk("SDKSrv     | [initialize ] :: ng-events   | "+sdk.useAngularEvents),e.sdk("SDKSrv     | [initialize ] :: launcher    | "+sdk.hasBeenLaunchedFromConfig),e.sdk("SDKSrv     | [initialize ] :: appID       | "+sdk.key.appID),e.sdk("SDKSrv     | [initialize ] :: -----------------------------"),e.sdk("SDKSrv     | [initialize ] :: Initialized!"),E.ready()},I=function(){b();var e={browser:{name:DetectRTC.browser.name,fullVersion:DetectRTC.browser.fullVersion,version:DetectRTC.browser.version},screen:{displayResolution:DetectRTC.displayResolution},os:{name:DetectRTC.osName,version:DetectRTC.osVersion,isMobileDevice:!1},ua:navigator.userAgent};m.updateSession(e).then(function(){}).catch(function(){})};e.sdk("SDKSrv     | [           ] :: Welcome to the Rainbow SDK for Web!"),window.rainbowSDK=E,p.setSetting("apiMode","sdk"),config.webservices.currentServer=config.webservices.server,b=n.$on(m.RAINBOW_ONCPAAS_SESSION_CREATED,I),E.isReady=!0,n.$broadcast("RAINBOW_INTERNAL_READY"),n.$on("$destroy",function(){b&&b()})}])},function(e,t,n){"use strict";function r(e,t,n){const r=e.match(t);return r&&r.length>=n&&parseInt(r[n],10)}function i(e,t,n){if(!e.RTCPeerConnection)return;const r=e.RTCPeerConnection.prototype,i=r.addEventListener;r.addEventListener=function(e,r){if(e!==t)return i.apply(this,arguments);const a=e=>{const t=n(e);t&&r(t)};return this._eventMap=this._eventMap||{},this._eventMap[r]=a,i.apply(this,[e,a])};const a=r.removeEventListener;r.removeEventListener=function(e,n){if(e!==t||!this._eventMap||!this._eventMap[n])return a.apply(this,arguments);const r=this._eventMap[n];return delete this._eventMap[n],a.apply(this,[e,r])},Object.defineProperty(r,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function a(e){return"boolean"==typeof e?(Z=e,e?"adapter.js logging disabled":"adapter.js logging enabled"):new Error("Argument type: "+typeof e+". Please use a boolean.")}function o(e){return"boolean"==typeof e?(ee=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled")):new Error("Argument type: "+typeof e+". Please use a boolean.")}function s(){if("object"==typeof window){if(Z)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function c(e,t){ee&&console.warn(e+" is deprecated, please use "+t+" instead.")}function l(e){const{navigator:t}=e,n={browser:null,version:null};if(void 0===e||!e.navigator)return n.browser="Not a browser.",n;if(t.mozGetUserMedia)n.browser="firefox",n.version=r(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia)n.browser="chrome",n.version=r(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))n.browser="edge",n.version=r(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!t.userAgent.match(/AppleWebKit\/(\d+)\./))return n.browser="Not a supported browser.",n;n.browser="safari",n.version=r(t.userAgent,/AppleWebKit\/(\d+)\./,1)}return n}function d(e){return"object"==typeof e?Object.keys(e).reduce(function(t,n){const r="object"==typeof e[n],i=r?d(e[n]):e[n],a=r&&!Object.keys(i).length;return void 0===i||a?t:Object.assign(t,{[n]:i})},{}):e}function u(e){const t=e&&e.navigator;if(!t.mediaDevices)return;const n=l(e),r=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach(n=>{if("require"===n||"advanced"===n||"mediaSource"===n)return;const r="object"==typeof e[n]?e[n]:{ideal:e[n]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);const i=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==r.ideal){t.optional=t.optional||[];let e={};"number"==typeof r.ideal?(e[i("min",n)]=r.ideal,t.optional.push(e),(e={})[i("max",n)]=r.ideal,t.optional.push(e)):(e[i("",n)]=r.ideal,t.optional.push(e))}void 0!==r.exact&&"number"!=typeof r.exact?(t.mandatory=t.mandatory||{},t.mandatory[i("",n)]=r.exact):["min","max"].forEach(e=>{void 0!==r[e]&&(t.mandatory=t.mandatory||{},t.mandatory[i(e,n)]=r[e])})}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},i=function(e,i){if(61<=n.version)return i(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=r(e.audio)}if(e&&"object"==typeof e.video){let a=e.video.facingMode;a=a&&("object"==typeof a?a:{ideal:a});const o=66>n.version;if(a&&("user"===a.exact||"environment"===a.exact||"user"===a.ideal||"environment"===a.ideal)&&(!t.mediaDevices.getSupportedConstraints||!t.mediaDevices.getSupportedConstraints().facingMode||o)){let n;if(delete e.video.facingMode,"environment"===a.exact||"environment"===a.ideal?n=["back","rear"]:("user"===a.exact||"user"===a.ideal)&&(n=["front"]),n)return t.mediaDevices.enumerateDevices().then(t=>{let o=(t=t.filter(e=>"videoinput"===e.kind)).find(e=>n.some(t=>e.label.toLowerCase().includes(t)));return!o&&t.length&&n.includes("back")&&(o=t[t.length-1]),o&&(e.video.deviceId=a.exact?{exact:o.deviceId}:{ideal:o.deviceId}),e.video=r(e.video),te("chrome: "+JSON.stringify(e)),i(e)})}e.video=r(e.video)}return te("chrome: "+JSON.stringify(e)),i(e)},a=function(e){return 64<=n.version?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};t.getUserMedia=function(e,n,r){i(e,e=>{t.webkitGetUserMedia(e,n,e=>{r&&r(a(e))})})}.bind(t);const o=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return i(e,e=>o(e).then(t=>{if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(e=>{e.stop()}),new DOMException("","NotFoundError");return t},e=>Promise.reject(a(e))))}}function h(e,t){return e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices?void 0:e.navigator.mediaDevices?"function"==typeof t?void(e.navigator.mediaDevices.getDisplayMedia=function(n){return t(n).then(t=>{const r=n.video&&n.video.width,i=n.video&&n.video.height,a=n.video&&n.video.frameRate;return n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:a||3}},r&&(n.video.mandatory.maxWidth=r),i&&(n.video.mandatory.maxHeight=i),e.navigator.mediaDevices.getUserMedia(n)})}):void console.error("shimGetDisplayMedia: getSourceId argument is not a function"):void 0}function f(e,t,n){const r=n?"outbound-rtp":"inbound-rtp",i=new Map;if(null===t)return i;const a=[];return e.forEach(e=>{"track"===e.type&&e.trackIdentifier===t.id&&a.push(e)}),a.forEach(t=>{e.forEach(n=>{n.type===r&&n.trackId===t.id&&function e(t,n,r){!n||r.has(n.id)||(r.set(n.id,n),Object.keys(n).forEach(i=>{i.endsWith("Id")?e(t,t.get(n[i]),r):i.endsWith("Ids")&&n[i].forEach(n=>{e(t,t.get(n),r)})}))}(e,n,i)})}),i}function p(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function m(e){if("object"!=typeof e||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype)i(e,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e));else{Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=(t=>{t.stream.addEventListener("addtrack",n=>{let r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===n.track.id):{track:n.track};const i=new Event("track");i.track=n.track,i.receiver=r,i.transceiver={receiver:r},i.streams=[t.stream],this.dispatchEvent(i)}),t.stream.getTracks().forEach(n=>{let r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===n.id):{track:n};const i=new Event("track");i.track=n,i.receiver=r,i.transceiver={receiver:r},i.streams=[t.stream],this.dispatchEvent(i)})}),this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}}function v(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const n=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e){let r=n.apply(this,arguments);return r||(r=t(this,e),this._senders.push(r)),r};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){r.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach(e=>{this._senders.push(t(this,e))})};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],r.apply(this,[e]),e.getTracks().forEach(e=>{const t=this._senders.find(t=>t.track===e);t&&this._senders.splice(this._senders.indexOf(t),1)})}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function g(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>f(t,e.track,!0))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),i(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>f(t,e.track,!1))}}if(!("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(0<arguments.length&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,n,r;return this.getSenders().forEach(n=>{n.track===e&&(t?r=!0:t=n)}),this.getReceivers().forEach(t=>(t.track===e&&(n?r=!0:n=t),t.track===e)),r||t&&n?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():n?n.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function C(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(e=>this._shimmedLocalStreams[e][0])};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){if(!n)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const r=t.apply(this,arguments);return this._shimmedLocalStreams[n.id]?-1===this._shimmedLocalStreams[n.id].indexOf(r)&&this._shimmedLocalStreams[n.id].push(r):this._shimmedLocalStreams[n.id]=[n,r],r};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")});const t=this.getSenders();n.apply(this,arguments);const r=this.getSenders().filter(e=>-1===t.indexOf(e));this._shimmedLocalStreams[e.id]=[e].concat(r)};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],r.apply(this,arguments)};const i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach(t=>{const n=this._shimmedLocalStreams[t].indexOf(e);-1!==n&&this._shimmedLocalStreams[t].splice(n,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]}),i.apply(this,arguments)}}function S(e){function t(e,t){let n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const r=e._reverseStreams[t],i=e._streams[r.id];n=n.replace(new RegExp(i.id,"g"),r.id)}),new RTCSessionDescription({type:t.type,sdp:n})}if(!e.RTCPeerConnection)return;const n=l(e);if(e.RTCPeerConnection.prototype.addTrack&&65<=n.version)return C(e);const r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=r.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map(e=>this._reverseStreams[e.id])};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[t.id]){const n=new e.MediaStream(t.getTracks());this._streams[t.id]=n,this._reverseStreams[n.id]=t,t=n}i.apply(this,[t])};const a=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},a.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,n){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const r=[].slice.call(arguments,1);if(1!==r.length||!r[0].getTracks().find(e=>e===t))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(e=>e.track===t))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const i=this._streams[n.id];if(i)i.addTrack(t),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const r=new e.MediaStream([t]);this._streams[n.id]=r,this._reverseStreams[r.id]=n,this.addStream(r)}return this.getSenders().find(e=>e.track===t)},["createOffer","createAnswer"].forEach(function(n){const r=e.RTCPeerConnection.prototype[n];e.RTCPeerConnection.prototype[n]=function(){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?r.apply(this,[n=>{const r=t(this,n);e[0].apply(null,[r])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):r.apply(this,arguments).then(e=>t(this,e))}});const o=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){let n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const r=e._reverseStreams[t],i=e._streams[r.id];n=n.replace(new RegExp(r.id,"g"),i.id)}),new RTCSessionDescription({type:t.type,sdp:n})}(this,arguments[0]),o.apply(this,arguments)):o.apply(this,arguments)};const s=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=s.get.apply(this);return""===e.type?e:t(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach(n=>{this._streams[n].getTracks().find(t=>e.track===t)&&(t=this._streams[n])}),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function E(e){if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,n,r){const i=arguments;if(0<arguments.length&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof arguments[0]))return t.apply(this,[]);const a=function(e){const t={};return e.result().forEach(e=>{const n={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(t=>{n[t]=e.stat(t)}),t[n.id]=n}),t},o=function(e){return new Map(Object.keys(e).map(t=>[t,e[t]]))};return 2<=arguments.length?t.apply(this,[function(e){i[1](o(a(e)))},arguments[0]]):new Promise((e,n)=>{t.apply(this,[function(t){e(o(a(t)))},n])}).then(n,r)},["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){const n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}});const n=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}function b(e){i(e,"negotiationneeded",e=>{return"stable"===e.target.signalingState?e:void 0})}function y(e){const t=e&&e.navigator,n=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return n(e).catch(e=>Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString(){return this.name}}}(e)))}}function R(e){!("getDisplayMedia"in e.navigator)||!e.navigator.mediaDevices||e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator.mediaDevices))}function T(e){const t=l(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),15025>t.version)){const t=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set(e){t.set.call(this,e);const n=new Event("enabled");n.enabled=e,this.dispatchEvent(n)}})}e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)&&Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);const n=re()(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=function(e){let t=!1;return(e=JSON.parse(JSON.stringify(e))).filter(e=>{if(e&&(e.urls||e.url)){var n=e.urls||e.url;e.url&&!e.urls&&c("RTCIceServer.url","RTCIceServer.urls");const r="string"==typeof n;return r&&(n=[n]),n=n.filter(e=>{if(0===e.indexOf("stun:"))return!1;const n=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return n&&!t?(t=!0,!0):n&&!t}),delete e.url,e.urls=r?n[0]:n,!!n.length}})}(e.iceServers,t.version),s("ICE servers after filtering:",e.iceServers)),new n(e)},e.RTCPeerConnection.prototype=n.prototype}function I(e){e.RTCRtpSender&&!("replaceTrack"in e.RTCRtpSender.prototype)&&(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}function A(e){const t=l(e),n=e&&e.navigator,r=e&&e.MediaStreamTrack;if(n.getUserMedia=function(e,t,r){c("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(e).then(t,r)},!(55<t.version&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){const e=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])},t=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(n){return"object"==typeof n&&"object"==typeof n.audio&&(n=JSON.parse(JSON.stringify(n)),e(n.audio,"autoGainControl","mozAutoGainControl"),e(n.audio,"noiseSuppression","mozNoiseSuppression")),t(n)},r&&r.prototype.getSettings){const t=r.prototype.getSettings;r.prototype.getSettings=function(){const n=t.apply(this,arguments);return e(n,"mozAutoGainControl","autoGainControl"),e(n,"mozNoiseSuppression","noiseSuppression"),n}}if(r&&r.prototype.applyConstraints){const t=r.prototype.applyConstraints;r.prototype.applyConstraints=function(n){return"audio"===this.kind&&"object"==typeof n&&(n=JSON.parse(JSON.stringify(n)),e(n,"autoGainControl","mozAutoGainControl"),e(n,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[n])}}}}function N(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||!e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===n.video?n.video={mediaSource:t}:n.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(n)})}function O(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function D(e){const t=l(e);if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){const n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}});const n=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};const r={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,n,a){return i.apply(this,[e||null]).then(e=>{if(53>t.version&&!n)try{e.forEach(e=>{e.type=r[e.type]||e.type})}catch(t){if("TypeError"!==t.name)throw t;e.forEach((t,n)=>{e.set(n,Object.assign({},t,{type:r[t.type]||t.type}))})}return e}).then(n,a)}}function P(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function w(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),i(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function _(e){!e.RTCPeerConnection||"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){c("removeStream","removeTrack"),this.getSenders().forEach(t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)})})}function M(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function k(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getTracks().forEach(n=>t.call(this,n,e))},e.RTCPeerConnection.prototype.addTrack=function(e,n){return n&&(this._localStreams?!this._localStreams.includes(n)&&this._localStreams.push(n):this._localStreams=[n]),t.call(this,e,n)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const n=e.getTracks();this.getSenders().forEach(e=>{n.includes(e.track)&&this.removeTrack(e)})})}}function U(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=(e=>{e.streams.forEach(e=>{if(this._remoteStreams||(this._remoteStreams=[]),!this._remoteStreams.includes(e)){this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)}})}))}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach(t=>{if(e._remoteStreams||(e._remoteStreams=[]),!(0<=e._remoteStreams.indexOf(t))){e._remoteStreams.push(t);const n=new Event("addstream");n.stream=t,e.dispatchEvent(n)}})}),t.apply(e,arguments)}}}function L(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,n=t.createOffer,r=t.createAnswer,i=t.setLocalDescription,a=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(e,t){const r=2<=arguments.length?arguments[2]:arguments[0],i=n.apply(this,[r]);return t?(i.then(e,t),Promise.resolve()):i},t.createAnswer=function(e,t){const n=2<=arguments.length?arguments[2]:arguments[0],i=r.apply(this,[n]);return t?(i.then(e,t),Promise.resolve()):i};let s=function(e,t,n){const r=i.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r};t.setLocalDescription=s,s=function(e,t,n){const r=a.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r},t.setRemoteDescription=s,s=function(e,t,n){const r=o.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r},t.addIceCandidate=s}function F(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,n=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=(e=>n(B(e)))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,n,r){t.mediaDevices.getUserMedia(e).then(n,r)}.bind(t))}function B(e){return e&&void 0!==e.video?Object.assign({},e,{video:d(e.video)}):e}function $(e){const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,n){if(e&&e.iceServers){const t=[];for(let n,r=0;r<e.iceServers.length;r++)!(n=e.iceServers[r]).hasOwnProperty("urls")&&n.hasOwnProperty("url")?(c("RTCIceServer.url","RTCIceServer.urls"),(n=JSON.parse(JSON.stringify(n))).urls=n.url,delete n.url,t.push(n)):t.push(e.iceServers[r]);e.iceServers=t}return new t(e,n)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function x(e){"object"==typeof e&&e.RTCPeerConnection&&"receiver"in e.RTCTrackEvent.prototype&&!e.RTCTransceiver&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function H(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find(e=>e.sender.track&&"audio"===e.sender.track.kind);!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0===e.offerToReceiveAudio&&!t&&this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const n=this.getTransceivers().find(e=>e.sender.track&&"video"===e.sender.track.kind);!1===e.offerToReceiveVideo&&n?"sendrecv"===n.direction?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":"recvonly"===n.direction&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):!0===e.offerToReceiveVideo&&!n&&this.addTransceiver("video")}return t.apply(this,arguments)}}function j(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const n=new t(e),r=ae.a.parseCandidate(e.candidate),i=Object.assign(n,r);return i.toJSON=function(){return{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,usernameFragment:i.usernameFragment}},i}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,i(e,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t))}function V(e){if(e.RTCSctpTransport||!e.RTCPeerConnection)return;const t=l(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const n=function(e){let n=65536;return"firefox"===t.browser&&(n=57>t.version?-1===e?16384:2147483637:60>t.version?57===t.version?65535:65536:2147483637),n},r=function(e,n){let r=65536;"firefox"===t.browser&&57===t.version&&(r=65535);const i=ae.a.matchPrefix(e.sdp,"a=max-message-size:");return 0<i.length?r=parseInt(i[0].substr(19),10):"firefox"===t.browser&&-1!==n&&(r=2147483637),r},i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,function(e){const t=ae.a.splitSections(e.sdp);return t.shift(),t.some(e=>{const t=ae.a.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})}(arguments[0])){const e=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||2>t.length)return-1;const n=parseInt(t[1],10);return n==n?n:-1}(arguments[0]),t=n(e),i=r(arguments[0],e);let a=0===t&&0===i?Number.POSITIVE_INFINITY:0===t||0===i?Math.max(t,i):Math.min(t,i);const o={};Object.defineProperty(o,"maxMessageSize",{get:()=>a}),this._sctp=o}return i.apply(this,arguments)}}function G(e){function t(e,t){const n=e.send;e.send=function(){const r=arguments[0],i=r.length||r.size||r.byteLength;if("open"===e.readyState&&t.sctp&&i>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return n.apply(e,arguments)}}if(!(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype))return;const n=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=n.apply(this,arguments);return t(e,this),e},i(e,"datachannel",e=>(t(e.channel,e.target),e))}function W(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{const n=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=(e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const n=new Event("connectionstatechange",e);t.dispatchEvent(n)}return e}),this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),n.apply(this,arguments)}})}function q(e){if(!e.RTCPeerConnection)return;const t=l(e);if("chrome"===t.browser&&71<=t.version)return;const n=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(e){return e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")&&(e.sdp=e.sdp.split("\n").filter(e=>"a=extmap-allow-mixed"!==e.trim()).join("\n")),n.apply(this,arguments)}}n.r(t);var J={};n.r(J),n.d(J,"shimGetUserMedia",function(){return u}),n.d(J,"shimGetDisplayMedia",function(){return h}),n.d(J,"shimMediaStream",function(){return p}),n.d(J,"shimOnTrack",function(){return m}),n.d(J,"shimGetSendersWithDtmf",function(){return v}),n.d(J,"shimSenderReceiverGetStats",function(){return g}),n.d(J,"shimAddTrackRemoveTrackWithNative",function(){return C}),n.d(J,"shimAddTrackRemoveTrack",function(){return S}),n.d(J,"shimPeerConnection",function(){return E}),n.d(J,"fixNegotiationNeeded",function(){return b});var z={};n.r(z),n.d(z,"shimGetUserMedia",function(){return y}),n.d(z,"shimGetDisplayMedia",function(){return R}),n.d(z,"shimPeerConnection",function(){return T}),n.d(z,"shimReplaceTrack",function(){return I});var K={};n.r(K),n.d(K,"shimGetUserMedia",function(){return A}),n.d(K,"shimGetDisplayMedia",function(){return N}),n.d(K,"shimOnTrack",function(){return O}),n.d(K,"shimPeerConnection",function(){return D}),n.d(K,"shimSenderGetStats",function(){return P}),n.d(K,"shimReceiverGetStats",function(){return w}),n.d(K,"shimRemoveStream",function(){return _}),n.d(K,"shimRTCDataChannel",function(){return M});var Y={};n.r(Y),n.d(Y,"shimLocalStreamsAPI",function(){return k}),n.d(Y,"shimRemoteStreamsAPI",function(){return U}),n.d(Y,"shimCallbacksAPI",function(){return L}),n.d(Y,"shimGetUserMedia",function(){return F}),n.d(Y,"shimConstraints",function(){return B}),n.d(Y,"shimRTCIceServerUrls",function(){return $}),n.d(Y,"shimTrackEventTransceiver",function(){return x}),n.d(Y,"shimCreateOfferLegacy",function(){return H});var Q={};n.r(Q),n.d(Q,"shimRTCIceCandidate",function(){return j}),n.d(Q,"shimMaxMessageSize",function(){return V}),n.d(Q,"shimSendThrowTypeError",function(){return G}),n.d(Q,"shimConnectionState",function(){return W}),n.d(Q,"removeAllowExtmapMixed",function(){return q});var X={};n.r(X),n.d(X,"default",function(){return oe});let Z=!0,ee=!0;const te=s;var ne=n(18),re=n.n(ne),ie=n(7),ae=n.n(ie);var oe=function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const n=s,i=l(e),c={browserDetails:i,commonShim:Q,extractVersion:r,disableLog:a,disableWarnings:o};switch(i.browser){case"chrome":if(!E||!t.shimChrome)return n("Chrome shim is not included in this adapter release."),c;n("adapter.js shimming chrome."),c.browserShim=J,u(e),p(e),E(e),m(e),S(e),v(e),g(e),b(e),j(e),W(e),V(e),G(e),q(e);break;case"firefox":if(!D||!t.shimFirefox)return n("Firefox shim is not included in this adapter release."),c;n("adapter.js shimming firefox."),c.browserShim=K,A(e),D(e),O(e),_(e),P(e),w(e),M(e),j(e),W(e),V(e),G(e);break;case"edge":if(!T||!t.shimEdge)return n("MS edge shim is not included in this adapter release."),c;n("adapter.js shimming edge."),c.browserShim=z,y(e),R(e),T(e),I(e),V(e),G(e);break;case"safari":if(!t.shimSafari)return n("Safari shim is not included in this adapter release."),c;n("adapter.js shimming safari."),c.browserShim=Y,$(e),H(e),L(e),k(e),U(e),x(e),F(e),j(e),V(e),G(e),q(e);break;default:n("Unsupported browser!")}return c}({window:window});n(12),n(19),window.adapter=X,n(20),n(21),n(148),n(149),n(150),n(151),n(152),n(153),n(154),n(155),n(156),n(157),n(158),n(159),n(160),n(161),n(162),n(163),n(164),n(165),n(166),n(167),n(168)}]);